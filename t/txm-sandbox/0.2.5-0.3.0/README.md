# Comparing `tmp/TXM_Sandbox-0.2.5.tar.gz` & `tmp/txm_sandbox-0.3.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "TXM_Sandbox-0.2.5.tar", last modified: Sat Jul 22 18:48:18 2023, max compression
+gzip compressed data, was "txm_sandbox-0.3.0.tar", last modified: Thu Apr 18 11:33:27 2024, max compression
```

## Comparing `TXM_Sandbox-0.2.5.tar` & `txm_sandbox-0.3.0.tar`

### file list

```diff
@@ -1,63 +1,94 @@
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.801856 TXM_Sandbox-0.2.5/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     1070 2022-10-01 04:14:05.000000 TXM_Sandbox-0.2.5/LICENSE
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      147 2022-10-01 04:14:26.000000 TXM_Sandbox-0.2.5/MANIFEST.in
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      268 2023-07-22 18:48:18.801856 TXM_Sandbox-0.2.5/PKG-INFO
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     1601 2022-10-01 04:14:37.000000 TXM_Sandbox-0.2.5/README.md
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    13610 2023-07-21 23:35:51.000000 TXM_Sandbox-0.2.5/TXM_GUI2.ipynb
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.794856 TXM_Sandbox-0.2.5/TXM_Sandbox/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      181 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/__init__.py
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.796856 TXM_Sandbox-0.2.5/TXM_Sandbox/config/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     5092 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/config/XANES2D_GUI_config.json
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      107 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/config/__init__.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)       45 2023-07-22 02:50:00.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/config/analysis_tool_gui_cfg.json
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      497 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/config/io_tomo_h5_data_structure.json
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      500 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/config/io_xanes2D_h5_data_structure.json
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      616 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/config/io_xanes3D_h5_data_structure.json
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.796856 TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      107 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/__init__.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     3757 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/config_dict.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    41092 2022-10-31 02:49:15.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/customized_struct_dict.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      755 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/sklearn_opt_dict.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      583 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/xanes_analysis_dict.py
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.796856 TXM_Sandbox-0.2.5/TXM_Sandbox/external/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      107 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/external/__init__.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      253 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/external/user_io.py
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.799856 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      107 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/__init__.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    32500 2022-11-01 02:56:31.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/conv_data_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    74120 2022-10-28 02:49:38.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/gen_algn_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    79227 2022-10-31 03:03:44.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/gui_components.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    36752 2023-07-21 03:16:57.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/io_config_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    15639 2022-10-19 23:44:48.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/main_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      795 2022-10-23 19:45:27.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/misc_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)   167412 2023-07-21 23:46:06.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/tomo_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)   197422 2022-10-03 16:45:10.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes2D_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)   198632 2022-10-03 16:44:03.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes3D_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    96600 2022-10-31 12:12:38.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes_analysis_gui.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)   207086 2022-10-31 04:27:31.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes_fitting_gui.py
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.799856 TXM_Sandbox-0.2.5/TXM_Sandbox/tmp/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      107 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/tmp/__init__.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)       69 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/tmp/readme.txt
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.801856 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      107 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/__init__.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    16458 2023-07-21 23:43:49.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/io.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    14410 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/lineshapes.py
--rwxrwxr-x   0 xiao      (1001) xiao      (1001)     3114 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/misc.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     1439 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/plotlib.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    85268 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/reg_algs.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    41510 2023-07-21 23:45:17.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/tomo_recon_tools.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    36738 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_analysis.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     2342 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_image_utils.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    23436 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_math.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     6083 2022-10-09 19:32:18.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_post_analysis.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)    76955 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_regtools.py
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     3266 2022-10-01 03:53:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_spectra_filters.py
-drwxrwxr-x   0 xiao      (1001) xiao      (1001)        0 2023-07-22 18:48:18.795856 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      268 2023-07-22 18:48:18.000000 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/PKG-INFO
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     1694 2023-07-22 18:48:18.000000 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/SOURCES.txt
--rw-rw-r--   0 xiao      (1001) xiao      (1001)        1 2023-07-22 18:48:18.000000 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/dependency_links.txt
--rw-rw-r--   0 xiao      (1001) xiao      (1001)        1 2022-10-30 14:56:54.000000 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/not-zip-safe
--rw-rw-r--   0 xiao      (1001) xiao      (1001)      177 2023-07-22 18:48:18.000000 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/requires.txt
--rw-rw-r--   0 xiao      (1001) xiao      (1001)       12 2023-07-22 18:48:18.000000 TXM_Sandbox-0.2.5/TXM_Sandbox.egg-info/top_level.txt
--rw-rw-r--   0 xiao      (1001) xiao      (1001)       38 2023-07-22 18:48:18.802856 TXM_Sandbox-0.2.5/setup.cfg
--rw-rw-r--   0 xiao      (1001) xiao      (1001)     1157 2023-07-22 18:46:43.000000 TXM_Sandbox-0.2.5/setup.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.283419 txm_sandbox-0.3.0/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     1070 2024-04-18 03:35:27.000000 txm_sandbox-0.3.0/LICENSE
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      147 2024-04-18 03:34:56.000000 txm_sandbox-0.3.0/MANIFEST.in
+-rw-r--r--   0 xiao      (1000) xiao      (1000)      706 2024-04-18 11:33:27.279419 txm_sandbox-0.3.0/PKG-INFO
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     1639 2024-04-18 03:35:09.000000 txm_sandbox-0.3.0/README.md
+-rwxrwxr-x   0 xiao      (1000) xiao      (1000)     2565 2024-04-18 11:27:34.000000 txm_sandbox-0.3.0/TXM_GUI2.ipynb
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.263419 txm_sandbox-0.3.0/TXM_Sandbox/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      181 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/__init__.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.267419 txm_sandbox-0.3.0/TXM_Sandbox/config/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     5092 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/config/XANES2D_GUI_config.json
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/config/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)       45 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/config/analysis_tool_gui_cfg.json
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      497 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/config/io_tomo_h5_data_structure.json
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      500 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/config/io_xanes2D_h5_data_structure.json
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      616 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/config/io_xanes3D_h5_data_structure.json
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.267419 txm_sandbox-0.3.0/TXM_Sandbox/dicts/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/dicts/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     3848 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/dicts/config_dict.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    61110 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/dicts/customized_struct_dict.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      755 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/dicts/sklearn_opt_dict.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      583 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/dicts/xanes_analysis_dict.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.267419 txm_sandbox-0.3.0/TXM_Sandbox/external/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/external/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      253 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/external/user_io.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.271419 txm_sandbox-0.3.0/TXM_Sandbox/gui/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    32500 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/conv_data_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    74137 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/gen_algn_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    79463 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/gui_components.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    36752 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/io_config_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    15709 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/main_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      795 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/misc_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)   169879 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/tomo_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)   204783 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes2D_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)   202060 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes3D_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    91679 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes_analysis_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)   203257 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes_fitting_gui.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.271419 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      181 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/__init__.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.275419 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/configs/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      181 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/configs/__init__.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.275419 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/dicts/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      181 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/dicts/__init__.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)     5528 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/dicts/data_struct_dict.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.275419 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      181 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    15317 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/appl_mask_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     9617 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/convert_data_gui.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)    25660 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/tomo_gui.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)    23133 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/xanes_fit_gui.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)    47833 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/xanes_reg_gui.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    15647 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/guis/xanes_vis_gui.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)     1665 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/napari_gui.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.275419 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      605 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/tomo_batch_recon_cmd.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      599 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/tomo_recon_cmd.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    15529 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/xanes2D_fit_cmd.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     2428 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/xanes2d_image_autoreg_cmd.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    16707 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/xanes3D_fit_cmd.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     1201 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/xanes3d_tomo_autocent_cmd.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     2029 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/scripts/xnaes2d_image_autoreg_cmd.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)    73678 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/txm_napari_gui copy.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)    73693 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/txm_napari_gui.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.275419 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/utils/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      181 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/utils/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     1297 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/utils/io.py
+-rw-r--r--   0 xiao      (1000) xiao      (1000)    10609 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/napari_gui/utils/misc.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.279419 txm_sandbox-0.3.0/TXM_Sandbox/tmp/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/tmp/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)       69 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/tmp/readme.txt
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.279419 txm_sandbox-0.3.0/TXM_Sandbox/utils/
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      107 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/__init__.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    16672 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/io.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    14410 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/lineshapes.py
+-rwxrwxr-x   0 xiao      (1000) xiao      (1000)     4246 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/misc.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     1439 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/plotlib.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    61837 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/reg_algs.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    70498 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/tomo_recon_tools.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    36738 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_analysis.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     2342 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_image_utils.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    23436 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_math.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     6083 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_post_analysis.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)    84774 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_regtools.py
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     3266 2024-04-18 02:40:37.000000 txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_spectra_filters.py
+drwxrwxr-x   0 xiao      (1000) xiao      (1000)        0 2024-04-18 11:33:27.279419 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/
+-rw-r--r--   0 xiao      (1000) xiao      (1000)      706 2024-04-18 11:33:27.000000 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/PKG-INFO
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     2824 2024-04-18 11:33:27.000000 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/SOURCES.txt
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)        1 2024-04-18 11:33:27.000000 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/dependency_links.txt
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)        1 2024-04-18 11:33:27.000000 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/not-zip-safe
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)      170 2024-04-18 11:33:27.000000 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/requires.txt
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)       12 2024-04-18 11:33:27.000000 txm_sandbox-0.3.0/TXM_Sandbox.egg-info/top_level.txt
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)       38 2024-04-18 11:33:27.283419 txm_sandbox-0.3.0/setup.cfg
+-rw-rw-r--   0 xiao      (1000) xiao      (1000)     1140 2024-04-18 11:32:18.000000 txm_sandbox-0.3.0/setup.py
```

### Comparing `TXM_Sandbox-0.2.5/LICENSE` & `txm_sandbox-0.3.0/LICENSE`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/README.md` & `txm_sandbox-0.3.0/README.md`

 * *Files 10% similar despite different names*

```diff
@@ -1,15 +1,17 @@
 # TXM_Sandbox
 This is a GUI program based on Jupyter that integrates tomography reconstruction and 2D/3D XANES data analysis. It provides a mechanism that allows users to customize the input data file formats.
 
 
 Installation
   via conda-forge
 
-	conda create -n pytxm python=3.10 txm_sandbox -c conda-forge
+	conda deactivate
+	conda update conda
+	conda create -n pytxm python=3.11 txm_sandbox -c conda-forge
 	conda activate pytxm
 
 
 Usage
   You also need to install Fiji/ImageJ in your computer. After installing Fiji, you will need to update ImageJ then Fiji from its 'Help' menu. Restart Fiji after the updates.
 
   You will need to copy TXM_GUI2.ipynb into a working directory. Change to that working directory, then run
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/config/XANES2D_GUI_config.json` & `txm_sandbox-0.3.0/TXM_Sandbox/config/XANES2D_GUI_config.json`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/config/io_xanes3D_h5_data_structure.json` & `txm_sandbox-0.3.0/TXM_Sandbox/config/io_xanes3D_h5_data_structure.json`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/config_dict.py` & `txm_sandbox-0.3.0/TXM_Sandbox/dicts/config_dict.py`

 * *Files 16% similar despite different names*

```diff
@@ -2,15 +2,16 @@
 # -*- coding: utf-8 -*-
 """
 Created on Sun Aug 23 23:27:42 2020
 
 @author: xiao
 """
 
-IO_TOMO_CFG_DEFAULT = {'structured_h5_reader':{
+IO_TOMO_CFG_DEFAULT = {'use_h5_reader': True, 
+		       'structured_h5_reader':{
                        'io_data_structure':{'data_path':'/img_tomo',
                                             'flat_path':'/img_bkg',
                                             'dark_path':'/img_dark',
                                             'theta_path':'/angle'},
                        'io_data_info':{'item00_path':'/img_tomo',
                                        'item01_path':'/angle',
                                        'item02_path':'/Magnification',
@@ -23,15 +24,16 @@
                        'customized_reader':{
                           'user_tomo_reader':''   
                                               },
                        'tomo_raw_fn_template':'fly_scan_id_{}.h5'
                       }
 
 
-IO_XANES2D_CFG_DEFAULT = {'structured_h5_reader':{
+IO_XANES2D_CFG_DEFAULT = {'use_h5_reader': True, 
+			  'structured_h5_reader':{
                           'io_data_structure':{'data_path':'/img_xanes',
                                                'flat_path':'/img_bkg',
                                                'dark_path':'/img_dark',
                                                'eng_path':'/X_eng'},
                           'io_data_info':{'item00_path':'/img_xanes',
                                           'item01_path':'/Magnification',
                                           'item02_path':'/Pixel Size',
@@ -44,15 +46,16 @@
                           'customized_reader':{
                           'user_xanes2D_reader':''    
                                               },
                           'xanes2D_raw_fn_template':'xanes_scan2_id_{}.h5'
                          }
 
 
-IO_XANES3D_CFG_DEFAULT = {'structured_h5_reader':{
+IO_XANES3D_CFG_DEFAULT = {'use_h5_reader': True, 
+			  'structured_h5_reader':{
                           'io_data_structure':{'data_path':'/img_tomo',
                                                'flat_path':'/img_bkg',
                                                'dark_path':'/img_dark',
                                                'eng_path':'/X_eng'},
                           'io_data_info':{'item00_path':'/img_tomo',
                                           'item01_path':'/angle',
                                           'item02_path':'/Magnification',
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/sklearn_opt_dict.py` & `txm_sandbox-0.3.0/TXM_Sandbox/dicts/sklearn_opt_dict.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/dicts/xanes_analysis_dict.py` & `txm_sandbox-0.3.0/TXM_Sandbox/dicts/xanes_analysis_dict.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/conv_data_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/conv_data_gui.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/gen_algn_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/gen_algn_gui.py`

 * *Files 22% similar despite different names*

```diff
@@ -13,53 +13,72 @@
 import skimage.morphology as skm
 import matplotlib.pyplot as plt
 from scipy.ndimage import gaussian_filter
 from scipy.ndimage import fourier_shift
 import napari
 
 from ..utils import xanes_regtools as xr
-from ..utils.io import (data_reader, tif_reader, tif_seq_reader, h5_reader,
-                        data_writer, tif_writer, tif_seq_writer, h5_writer)
-from .gui_components import (SelectFilesButton, NumpyArrayEncoder, get_handles,
-                             enable_disable_boxes, fiji_viewer_state, restart,
-                             fiji_viewer_on, fiji_viewer_off,
-                             gen_external_py_script, update_json_content)
+from ..utils.io import (
+    data_reader,
+    tif_reader,
+    tif_seq_reader,
+    h5_reader,
+    data_writer,
+    tif_writer,
+    tif_seq_writer,
+    h5_writer,
+)
+from .gui_components import (
+    SelectFilesButton,
+    NumpyArrayEncoder,
+    get_handles,
+    enable_disable_boxes,
+    fiji_viewer_state,
+    restart,
+    fiji_viewer_on,
+    fiji_viewer_off,
+    gen_external_py_script,
+    update_json_content,
+)
 
 napari.gui_qt()
 
 
-class gen_algn_gui():
+class gen_algn_gui:
 
     def __init__(self, parent_h, form_sz=[650, 740]):
-        self.gui_name = 'misc'
+        self.gui_name = "misc"
         self.form_sz = form_sz
         self.global_h = parent_h
         self.hs = {}
 
         self.reader = None
-        self.misc_algn_ext_cmd_fn = os.path.join(
-            os.path.abspath(os.path.curdir), 'misc_align_external_command.py')
+        # self.misc_algn_ext_cmd_fn = os.path.join(
+        #     os.path.abspath(os.path.curdir), 'misc_align_external_command.py')
+        self.misc_algn_ext_cmd_fn = str(Path.cwd() / "misc_align_external_command.py")
 
-        self.misc_io_cfg_type = 'manual'
-        self.misc_io_in_ftype = '2Ds tif'  # in ['2D tif', '2Ds tif', '3D tif', '2D h5', '3D h5']
+        self.misc_io_cfg_type = "manual"
+        self.misc_io_in_ftype = (
+            "2Ds tif"  # in ['2D tif', '2Ds tif', '3D tif', '2D h5', '3D h5']
+        )
         self.misc_io_tgt_ftype = self.misc_io_in_ftype
         self.misc_io_tgt_fn = None
         self.misc_io_tgt_fn_is_temp = False
         self.misc_io_tgt_fn_id_s = None
         self.misc_io_tgt_fn_id_e = None
         self.misc_io_tgt_flat_fn = None
         self.misc_io_tgt_dark_fn = None
         self.misc_io_tgt_is_raw = False
         self.misc_io_tgt_3D_tif_flat_id = 0
         self.misc_io_tgt_3D_tif_dark_id = -1
         self.misc_io_tgt_3D_slcn_dim = 0
         self.misc_io_tgt_3D_fxd_sli = None
-        self.misc_io_tgt_h5_data_path = 'img'
-        self.misc_io_tgt_h5_flat_path = 'img_bkg'
-        self.misc_io_tgt_h5_dark_path = 'img_dark'
+        self.misc_io_tgt_h5_data_path = "img"
+        self.misc_io_tgt_h5_flat_path = "img_bkg"
+        self.misc_io_tgt_h5_dark_path = "img_dark"
 
         self.misc_io_src_ftype = self.misc_io_in_ftype
         self.misc_io_src_fn = None
         self.misc_io_src_fn_temp = None
         self.misc_io_src_fn_is_temp = True
         self.misc_io_src_is_raw = False
         self.misc_io_src_fn_id_s = None
@@ -68,22 +87,24 @@
         self.misc_io_src_sli_id_e = None
         self.misc_io_src_flat_fn = None
         self.misc_io_src_dark_fn = None
         self.misc_io_src_3D_tif_flat_id = 0
         self.misc_io_src_3D_tif_dark_id = -1
         self.misc_io_src_3D_slcn_dim = 0
         self.misc_io_src_3D_srch_half_wz = 10
-        self.misc_io_src_h5_data_path = 'img'
-        self.misc_io_src_h5_flat_path = 'img_bkg'
-        self.misc_io_src_h5_dark_path = 'img_dark'
+        self.misc_io_src_h5_data_path = "img"
+        self.misc_io_src_h5_flat_path = "img_bkg"
+        self.misc_io_src_h5_dark_path = "img_dark"
 
         self.misc_io_cfg = None
         self.misc_io_cfg_fn = None
-        self.misc_io_out_dtype = self.misc_io_in_ftype  # set according to self.misc_io__dtype
-        self.misc_io_algn_dtype = 'h5'
+        self.misc_io_out_dtype = (
+            self.misc_io_in_ftype
+        )  # set according to self.misc_io__dtype
+        self.misc_io_algn_dtype = "h5"
         self.misc_io_sav_algn_fn = None
         self.misc_io_reader_cfg = {}
         self.misc_io_writer_cfg = {}
         self.misc_io_man_src_fn_set = False
         self.misc_io_man_tgt_fn_set = False
         self.misc_io_man_sav_fn_set = False
         self.misc_io_cfg_fn_set = False
@@ -135,1539 +156,1666 @@
 
     def build_gui(self):
         base_wz_os = 92
         ex_ws_os = 6
 
         ## define main form
         layout = {
-            'border': '3px solid #FFCC00',
-            'width': f'{self.form_sz[1] - 86}px',
-            'height': f'{self.form_sz[0] - 136}px'
+            "border": "3px solid #FFCC00",
+            "width": f"{self.form_sz[1] - 86}px",
+            "height": f"{self.form_sz[0] - 136}px",
         }
-        self.hs['GenImgAlign form'] = widgets.VBox(layout=layout)
+        self.hs["GenImgAlign form"] = widgets.VBox(layout=layout)
 
         ## ## define accordion fields
-        self.hs['GenAlgnImg acc'] = widgets.Accordion(
-            titles=('Config Input/Output Files', ),
+        self.hs["GenAlgnImg acc"] = widgets.Accordion(
+            titles=("Config Input/Output Files",),
             layout={
-                'width': 'auto',
-                'border': '3px solid #8855AA',
-                'align-content': 'center',
-                'align-items': 'center',
-                'justify-content': 'center'
-            })
+                "width": "auto",
+                "border": "3px solid #8855AA",
+                "align-content": "center",
+                "align-items": "center",
+                "justify-content": "center",
+            },
+        )
 
         ## ## ## define widgets in self.hs['GenAlgnImg acc']
-        self.hs['AlgnCfgFns box'] = widgets.VBox(
+        self.hs["AlgnCfgFns box"] = widgets.VBox(
+            layout={"width": "auto", "height": f"{0.7*(self.form_sz[0] - 136)}px"}
+        )
+
+        self.hs["AlgnCfgFns acc"] = widgets.Accordion(
+            titles=("Config Input/Output Files",),
             layout={
-                'width': 'auto',
-                'height': f'{0.7*(self.form_sz[0] - 136)}px'
-            })
-
-        self.hs['AlgnCfgFns acc'] = widgets.Accordion(
-            titles=('Config Input/Output Files', ),
-            layout={
-                'width': 'auto',
-                'align-content': 'center',
-                'align-items': 'center',
-                'justify-content': 'center'
-            })
+                "width": "auto",
+                "align-content": "center",
+                "align-items": "center",
+                "justify-content": "center",
+            },
+        )
 
-        self.hs['AlgnCfgFns box'].children = [self.hs['AlgnCfgFns acc']]
+        self.hs["AlgnCfgFns box"].children = [self.hs["AlgnCfgFns acc"]]
 
         ## ## ## ## define widgets in self.hs['AlgnCfgFns acc']
-        self.hs['AlgnCfgManDatCfg box'] = widgets.GridBox(
+        self.hs["AlgnCfgManDatCfg box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.56*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto auto auto auto auto auto auto auto'
-            })
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.56*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto auto auto auto auto auto auto auto",
+            }
+        )
 
         ## ## ## ## ## input title box
-        self.hs['AlgnCfgInDatTtl box'] = widgets.GridBox(
+        self.hs["AlgnCfgInDatTtl box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto'
-            })
-        self.hs['AlgnCfgInDatTtl lbl'] = widgets.HTML(
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto",
+            }
+        )
+        self.hs["AlgnCfgInDatTtl lbl"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + 'Config Input' + '</span>')
-        self.hs['AlgnCfgInDatTtl lbl'].layout = {
-            'background-color': 'white',
-            'color': 'cyan',
-            'width': 'auto',
-            'height': 'auto'
+            + "Config Input"
+            + "</span>"
+        )
+        self.hs["AlgnCfgInDatTtl lbl"].layout = {
+            "background-color": "white",
+            "color": "cyan",
+            "width": "auto",
+            "height": "auto",
         }
-        self.hs['AlgnCfgInDatTtl box'].children = [
-            self.hs['AlgnCfgInDatTtl lbl']
-        ]
+        self.hs["AlgnCfgInDatTtl box"].children = [self.hs["AlgnCfgInDatTtl lbl"]]
 
         ## ## ## ## ## select input data type
-        self.hs['AlgnCfgInDatTyp box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto'
-            })
-
-        self.hs['AlgnCfgInDatTyp Btn'] = widgets.RadioButtons(
-            options=['2D tif', '2Ds tif', '3D tif', '2D h5', '3D h5'],
-            value='2Ds tif',
+        self.hs["AlgnCfgInDatTyp box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': 'auto'
-            },
-            orientation='horizontal',
-            description='Data Type')
-        self.hs['AlgnCfgInDatTyp Btn'].observe(self.AlgnCfgInDatTyp_radbtn_chg,
-                                               names='value')
-        self.hs['AlgnCfgInDatTyp box'].children = [
-            self.hs['AlgnCfgInDatTyp Btn']
-        ]
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto",
+            }
+        )
+
+        self.hs["AlgnCfgInDatTyp Btn"] = widgets.RadioButtons(
+            options=["2D tif", "2Ds tif", "3D tif", "2D h5", "3D h5"],
+            value="2Ds tif",
+            layout={"width": "auto", "height": "auto"},
+            orientation="horizontal",
+            description="Data Type",
+        )
+        self.hs["AlgnCfgInDatTyp Btn"].observe(
+            self.AlgnCfgInDatTyp_radbtn_chg, names="value"
+        )
+        self.hs["AlgnCfgInDatTyp box"].children = [self.hs["AlgnCfgInDatTyp Btn"]]
 
         ## ## ## ## ## select source image directory
-        self.hs['AlgnCfgInSrcImg box'] = widgets.GridBox(
+        self.hs["AlgnCfgInSrcImg box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-
-        self.hs['AlgnCfgInSrcPath txt'] = widgets.Text(
-            value='Choose Source Image Directory ...',
-            description='',
-            disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnCfgInSrcPath btn'] = SelectFilesButton(
-            option='askopenfilename',
-            text_h=self.hs['AlgnCfgInSrcPath txt'],
-            **{'open_filetypes': (('tif files', ['*.tif', '*.tiff']), )})
-        self.hs[
-            'AlgnCfgInSrcPath btn'].description = 'Choose Source Image Directory'
-        self.hs['AlgnCfgInSrcPath btn'].on_click(self.AlgnCfgInSrcPath_btn_clk)
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
 
-        self.hs['AlgnCfgInSrcImg box'].children = [
-            self.hs['AlgnCfgInSrcPath txt'], self.hs['AlgnCfgInSrcPath btn']
+        self.hs["AlgnCfgInSrcPath txt"] = widgets.Text(
+            value="Choose Source Image Directory ...",
+            description="",
+            disabled=True,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnCfgInSrcPath btn"] = SelectFilesButton(
+            option="askopenfilename",
+            text_h=self.hs["AlgnCfgInSrcPath txt"],
+            **{"open_filetypes": (("tif files", ["*.tif", "*.tiff"]),)},
+        )
+        self.hs["AlgnCfgInSrcPath btn"].description = "Choose Source Image Directory"
+        self.hs["AlgnCfgInSrcPath btn"].on_click(self.AlgnCfgInSrcPath_btn_clk)
+
+        self.hs["AlgnCfgInSrcImg box"].children = [
+            self.hs["AlgnCfgInSrcPath txt"],
+            self.hs["AlgnCfgInSrcPath btn"],
         ]
 
         ## ## ## ## ## select target image directory
-        self.hs['AlgnCfgInTgtImg box'] = widgets.GridBox(
+        self.hs["AlgnCfgInTgtImg box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-        self.hs['AlgnCfgInTgtPath txt'] = widgets.Text(
-            value='Choose Target Image Directory ...',
-            description='',
-            disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnCfgInTgtPath btn'] = SelectFilesButton(
-            option='askopenfilename',
-            text_h=self.hs['AlgnCfgInTgtPath txt'],
-            **{'open_filetypes': (('tif files', ['*.tif', '*.tiff']), )})
-        self.hs[
-            'AlgnCfgInTgtPath btn'].description = 'Choose Target File Directory'
-        self.hs['AlgnCfgInTgtPath btn'].on_click(self.AlgnCfgInTgtPath_btn_clk)
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+        self.hs["AlgnCfgInTgtPath txt"] = widgets.Text(
+            value="Choose Target Image Directory ...",
+            description="",
+            disabled=True,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnCfgInTgtPath btn"] = SelectFilesButton(
+            option="askopenfilename",
+            text_h=self.hs["AlgnCfgInTgtPath txt"],
+            **{"open_filetypes": (("tif files", ["*.tif", "*.tiff"]),)},
+        )
+        self.hs["AlgnCfgInTgtPath btn"].description = "Choose Target File Directory"
+        self.hs["AlgnCfgInTgtPath btn"].on_click(self.AlgnCfgInTgtPath_btn_clk)
 
-        self.hs['AlgnCfgInTgtImg box'].children = [
-            self.hs['AlgnCfgInTgtPath txt'], self.hs['AlgnCfgInTgtPath btn']
+        self.hs["AlgnCfgInTgtImg box"].children = [
+            self.hs["AlgnCfgInTgtPath txt"],
+            self.hs["AlgnCfgInTgtPath btn"],
         ]
 
         ## ## ## ## ## output title box
-        self.hs['AlgnCfgOutDatTtl box'] = widgets.GridBox(
+        self.hs["AlgnCfgOutDatTtl box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto'
-            })
-        self.hs['AlgnCfgOutDatTtl lbl'] = widgets.HTML(
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto",
+            }
+        )
+        self.hs["AlgnCfgOutDatTtl lbl"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + 'Config Output' + '</span>')
-        self.hs['AlgnCfgOutDatTtl lbl'].layout = {
-            'background-color': 'white',
-            'color': 'cyan',
-            'width': 'auto',
-            'height': 'auto'
+            + "Config Output"
+            + "</span>"
+        )
+        self.hs["AlgnCfgOutDatTtl lbl"].layout = {
+            "background-color": "white",
+            "color": "cyan",
+            "width": "auto",
+            "height": "auto",
         }
-        self.hs['AlgnCfgOutDatTtl box'].children = [
-            self.hs['AlgnCfgOutDatTtl lbl']
-        ]
+        self.hs["AlgnCfgOutDatTtl box"].children = [self.hs["AlgnCfgOutDatTtl lbl"]]
 
         ## ## ## ## ## output data type
-        self.hs['AlgnCfgOutDatTyp box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto'
-            })
-
-        self.hs['AlgnCfgOutDatTyp Btn'] = widgets.RadioButtons(
-            options=['2Ds tif', '3D tif', '3D h5'],
-            value='2Ds tif',
+        self.hs["AlgnCfgOutDatTyp box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': 'auto'
-            },
-            orientation='horizontal',
-            description='Data Type')
-        self.hs['AlgnCfgOutDatTyp Btn'].observe(
-            self.AlgnCfgOutDatTyp_radbtn_chg, names='value')
-        self.hs['AlgnCfgOutDatTyp box'].children = [
-            self.hs['AlgnCfgOutDatTyp Btn']
-        ]
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto",
+            }
+        )
+
+        self.hs["AlgnCfgOutDatTyp Btn"] = widgets.RadioButtons(
+            options=["2Ds tif", "3D tif", "3D h5"],
+            value="2Ds tif",
+            layout={"width": "auto", "height": "auto"},
+            orientation="horizontal",
+            description="Data Type",
+        )
+        self.hs["AlgnCfgOutDatTyp Btn"].observe(
+            self.AlgnCfgOutDatTyp_radbtn_chg, names="value"
+        )
+        self.hs["AlgnCfgOutDatTyp box"].children = [self.hs["AlgnCfgOutDatTyp Btn"]]
 
         ## ## ## ## ## select saved image directory
-        self.hs['AlgnCfgOutFn box'] = widgets.GridBox(
+        self.hs["AlgnCfgOutFn box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-        self.hs['AlgnCfgOutPath txt'] = widgets.Text(
-            value='Choose Saving Image Directory ...',
-            description='',
-            disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnCfgOutPath btn'] = SelectFilesButton(
-            option='asksaveasfilename',
-            text_h=self.hs['AlgnCfgOutPath txt'],
-            **{'filetypes': (('tif files', ['*.tif', '*.tiff']), )},
-            **{'open_filetypes': (('tif files', ['*.tif', '*.tiff']), )})
-        self.hs[
-            'AlgnCfgOutPath btn'].description = 'Choose Saving Image Directory'
-        self.hs['AlgnCfgOutPath btn'].on_click(self.AlgnCfgOutPath_btn_clk)
-
-        self.hs['AlgnCfgOutFn box'].children = [
-            self.hs['AlgnCfgOutPath txt'], self.hs['AlgnCfgOutPath btn']
-        ]
-
-        self.hs['AlgnCfgCfmManFile&Path box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-
-        self.hs['AlgnCfgCfmManFile&Path txt'] = widgets.Text(
-            value='Confirm after Files/Directories are Chosen ...',
-            description='',
-            disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnCfgCfmManFile&Path btn'] = widgets.Button(
-            description='Confirm',
-            tooltip='Confirm: Confirm after you finish file configuration')
-        self.hs['AlgnCfgCfmManFile&Path btn'].style.button_color = 'darkviolet'
-        self.hs['AlgnCfgCfmManFile&Path btn'].on_click(
-            self.AlgnCfgCfmManFilePath_btn_clk)
-
-        self.hs['AlgnCfgCfmManFile&Path box'].children = [
-            self.hs['AlgnCfgCfmManFile&Path txt'],
-            self.hs['AlgnCfgCfmManFile&Path btn']
-        ]
-
-        self.hs['AlgnCfgManDatCfg box'].children = [
-            self.hs['AlgnCfgInDatTtl box'], self.hs['AlgnCfgInDatTyp box'],
-            self.hs['AlgnCfgInTgtImg box'], self.hs['AlgnCfgInSrcImg box'],
-            self.hs['AlgnCfgOutDatTtl box'], self.hs['AlgnCfgOutDatTyp box'],
-            self.hs['AlgnCfgOutFn box'], self.hs['AlgnCfgCfmManFile&Path box']
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+        self.hs["AlgnCfgOutPath txt"] = widgets.Text(
+            value="Choose Saving Image Directory ...",
+            description="",
+            disabled=True,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnCfgOutPath btn"] = SelectFilesButton(
+            option="asksaveasfilename",
+            text_h=self.hs["AlgnCfgOutPath txt"],
+            **{"filetypes": (("tif files", ["*.tif", "*.tiff"]),)},
+            **{"open_filetypes": (("tif files", ["*.tif", "*.tiff"]),)},
+        )
+        self.hs["AlgnCfgOutPath btn"].description = "Choose Saving Image Directory"
+        self.hs["AlgnCfgOutPath btn"].on_click(self.AlgnCfgOutPath_btn_clk)
+
+        self.hs["AlgnCfgOutFn box"].children = [
+            self.hs["AlgnCfgOutPath txt"],
+            self.hs["AlgnCfgOutPath btn"],
+        ]
+
+        self.hs["AlgnCfgCfmManFile&Path box"] = widgets.GridBox(
+            layout={
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+
+        self.hs["AlgnCfgCfmManFile&Path txt"] = widgets.Text(
+            value="Confirm after Files/Directories are Chosen ...",
+            description="",
+            disabled=True,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnCfgCfmManFile&Path btn"] = widgets.Button(
+            description="Confirm",
+            tooltip="Confirm: Confirm after you finish file configuration",
+        )
+        self.hs["AlgnCfgCfmManFile&Path btn"].style.button_color = "darkviolet"
+        self.hs["AlgnCfgCfmManFile&Path btn"].on_click(
+            self.AlgnCfgCfmManFilePath_btn_clk
+        )
+
+        self.hs["AlgnCfgCfmManFile&Path box"].children = [
+            self.hs["AlgnCfgCfmManFile&Path txt"],
+            self.hs["AlgnCfgCfmManFile&Path btn"],
+        ]
+
+        self.hs["AlgnCfgManDatCfg box"].children = [
+            self.hs["AlgnCfgInDatTtl box"],
+            self.hs["AlgnCfgInDatTyp box"],
+            self.hs["AlgnCfgInTgtImg box"],
+            self.hs["AlgnCfgInSrcImg box"],
+            self.hs["AlgnCfgOutDatTtl box"],
+            self.hs["AlgnCfgOutDatTyp box"],
+            self.hs["AlgnCfgOutFn box"],
+            self.hs["AlgnCfgCfmManFile&Path box"],
         ]
 
         ## ## ## ## define widgets in self.hs['AlgnCfgRdDatCfg box']
-        self.hs['AlgnCfgRdDatCfg box'] = widgets.GridBox(
+        self.hs["AlgnCfgRdDatCfg box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.16*(self.form_sz[0]-136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto auto',
-                'grid_gap': '2px 2px'
-            })
-
-        self.hs['AlgnCfgCfgFn box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0] - 136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-        self.hs['AlgnCfgCfgFn txt'] = widgets.Text(
-            value='Specify Config File ...',
-            description='',
-            disabled=False,
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.16*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+
+        self.hs["AlgnCfgCfgFn box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnCfgCfgFn btn'] = SelectFilesButton(
-            option='askopenfilename',
-            text_h=self.hs['AlgnCfgCfgFn txt'],
-            **{'open_filetypes': (('json file', '*.json'), )})
-        self.hs['AlgnCfgCfgFn btn'].description = 'Specify Config File'
-        self.hs['AlgnCfgCfgFn btn'].on_click(self.AlgnCfgCfgFn_btn_clk)
-
-        self.hs['AlgnCfgCfgFn box'].children = [
-            self.hs['AlgnCfgCfgFn txt'], self.hs['AlgnCfgCfgFn btn']
-        ]
-
-        self.hs['AlgnCfgCfmCfgFn box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-
-        self.hs['AlgnCfgCfmCfgFn txt'] = widgets.Text(
-            value='Confirm to Proceed ...',
-            description='',
-            disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnCfgCfmCfgFn btn'] = widgets.Button(
-            description='Confirm', tooltip='Confirm: Confirm to Proceed')
-        self.hs['AlgnCfgCfmCfgFn btn'].style.button_color = 'darkviolet'
-        self.hs['AlgnCfgCfmCfgFn btn'].on_click(self.AlgnCfgCfmCfgFn_btn_clk)
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0] - 136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+        self.hs["AlgnCfgCfgFn txt"] = widgets.Text(
+            value="Specify Config File ...",
+            description="",
+            disabled=False,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnCfgCfgFn btn"] = SelectFilesButton(
+            option="askopenfilename",
+            text_h=self.hs["AlgnCfgCfgFn txt"],
+            **{"open_filetypes": (("json file", "*.json"),)},
+        )
+        self.hs["AlgnCfgCfgFn btn"].description = "Specify Config File"
+        self.hs["AlgnCfgCfgFn btn"].on_click(self.AlgnCfgCfgFn_btn_clk)
 
-        self.hs['AlgnCfgCfmCfgFn box'].children = [
-            self.hs['AlgnCfgCfmCfgFn txt'], self.hs['AlgnCfgCfmCfgFn btn']
-        ]
-        self.hs['AlgnCfgRdDatCfg box'].children = [
-            self.hs['AlgnCfgCfgFn box'], self.hs['AlgnCfgCfmCfgFn box']
+        self.hs["AlgnCfgCfgFn box"].children = [
+            self.hs["AlgnCfgCfgFn txt"],
+            self.hs["AlgnCfgCfgFn btn"],
+        ]
+
+        self.hs["AlgnCfgCfmCfgFn box"] = widgets.GridBox(
+            layout={
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+
+        self.hs["AlgnCfgCfmCfgFn txt"] = widgets.Text(
+            value="Confirm to Proceed ...",
+            description="",
+            disabled=True,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnCfgCfmCfgFn btn"] = widgets.Button(
+            description="Confirm", tooltip="Confirm: Confirm to Proceed"
+        )
+        self.hs["AlgnCfgCfmCfgFn btn"].style.button_color = "darkviolet"
+        self.hs["AlgnCfgCfmCfgFn btn"].on_click(self.AlgnCfgCfmCfgFn_btn_clk)
+
+        self.hs["AlgnCfgCfmCfgFn box"].children = [
+            self.hs["AlgnCfgCfmCfgFn txt"],
+            self.hs["AlgnCfgCfmCfgFn btn"],
+        ]
+        self.hs["AlgnCfgRdDatCfg box"].children = [
+            self.hs["AlgnCfgCfgFn box"],
+            self.hs["AlgnCfgCfmCfgFn box"],
         ]
 
         ## ## ## ## define widgets in self.hs['AlgnCfgFns acc']
-        self.hs['AlgnCfgFnHlp txt'] = widgets.Textarea(
-            value="'Manually Config Input/Output Files' option is" +
-            " useful to stitch two sets of images." +
-            " 'Read Config File' option is useful to stitch" +
-            " more than two image sets. You can use" +
-            " 'Manually Config Input/Output Files' option to" +
-            " generate a configuration file that can be used as a" +
-            " template for stitching more than two image sets.",
-            description='Info:',
-            disabled=True,
-            layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.35*(self.form_sz[0] - 136)}px'
-            })
-
-        self.hs['AlgnCfgFns acc'].children = [
-            self.hs['AlgnCfgManDatCfg box'], self.hs['AlgnCfgRdDatCfg box'],
-            self.hs['AlgnCfgFnHlp txt']
+        self.hs["AlgnCfgFnHlp txt"] = widgets.Textarea(
+            value="'Manually Config Input/Output Files' option is"
+            + " useful to stitch two sets of images."
+            + " 'Read Config File' option is useful to stitch"
+            + " more than two image sets. You can use"
+            + " 'Manually Config Input/Output Files' option to"
+            + " generate a configuration file that can be used as a"
+            + " template for stitching more than two image sets.",
+            description="Info:",
+            disabled=True,
+            layout={
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.35*(self.form_sz[0] - 136)}px",
+            },
+        )
+
+        self.hs["AlgnCfgFns acc"].children = [
+            self.hs["AlgnCfgManDatCfg box"],
+            self.hs["AlgnCfgRdDatCfg box"],
+            self.hs["AlgnCfgFnHlp txt"],
         ]
 
         # per https://github.com/jupyter-widgets/ipywidgets/issues/2790, accordion title can only be set
         # via set_title in jupyterlab 7.5. It should be set directly when accordion is created after jupyterlab 8.
-        self.hs['AlgnCfgFns acc'].set_title(
-            0, 'Manually Config Input/Output Files')
-        self.hs['AlgnCfgFns acc'].set_title(1, 'Read Config File')
-        self.hs['AlgnCfgFns acc'].set_title(2, 'Help Information')
-        self.hs['AlgnCfgFns acc'].selected_index = 2
+        self.hs["AlgnCfgFns acc"].set_title(0, "Manually Config Input/Output Files")
+        self.hs["AlgnCfgFns acc"].set_title(1, "Read Config File")
+        self.hs["AlgnCfgFns acc"].set_title(2, "Help Information")
+        self.hs["AlgnCfgFns acc"].selected_index = 2
 
         ## ## ## ## ## config image ROI
         ## ## ## ## ## ## Image ROI Box
-        self.hs['AlgnROI box'] = widgets.VBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.49 * (self.form_sz[0] - 136)}px'
-            })
+        self.hs["AlgnROI box"] = widgets.VBox(
+            layout={"width": "auto", "height": f"{0.49 * (self.form_sz[0] - 136)}px"}
+        )
 
         ## ## ## ## ## ## Define Predefined Offset between Source and Target Images
-        self.hs['AlgnROIPreOShftTtl lbl'] = widgets.HTML(
+        self.hs["AlgnROIPreOShftTtl lbl"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + 'Preset Offset' + '</span>',
+            + "Preset Offset"
+            + "</span>",
             layout={
-                'background-color': 'white',
-                'color': 'cyan',
-                'height': f'{0.07 * (self.form_sz[0] - 136)}px',
-                'width': 'auto',
-                'flex_shrink': 1,
-                'align-content': 'center',
-                'align-items': 'center',
-                'justify-content': 'center'
-            })
-        self.hs['AlgnROIPreShft box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07 * (self.form_sz[0] - 136)}px',
-                'grid_template_columns': '30% 30% 30%',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-        self.hs['AlgnROIPreAx0Shft txt'] = widgets.IntText(
+                "background-color": "white",
+                "color": "cyan",
+                "height": f"{0.07 * (self.form_sz[0] - 136)}px",
+                "width": "auto",
+                "flex_shrink": 1,
+                "align-content": "center",
+                "align-items": "center",
+                "justify-content": "center",
+            },
+        )
+        self.hs["AlgnROIPreShft box"] = widgets.GridBox(
+            layout={
+                "width": "auto",
+                "height": f"{0.07 * (self.form_sz[0] - 136)}px",
+                "grid_template_columns": "30% 30% 30%",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+        self.hs["AlgnROIPreAx0Shft txt"] = widgets.IntText(
             value=0,
             min=-10,
             max=10,
-            description='Axis 0 offset',
+            description="Axis 0 offset",
             disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnROIPreAx1Shft txt'] = widgets.IntText(
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnROIPreAx1Shft txt"] = widgets.IntText(
             value=0,
             min=-10,
             max=10,
-            description='Axis 1 offset',
+            description="Axis 1 offset",
             disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnROIPreAx2Shft txt'] = widgets.IntText(
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnROIPreAx2Shft txt"] = widgets.IntText(
             value=0,
             min=-10,
             max=10,
-            description='Axis 2 offset',
+            description="Axis 2 offset",
             disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnROIPreAx0Shft txt'].observe(
-            self.AlgnROIPreAx0Shft_txt_chg, names='value')
-        self.hs['AlgnROIPreAx1Shft txt'].observe(
-            self.AlgnROIPreAx1Shft_txt_chg, names='value')
-        self.hs['AlgnROIPreAx2Shft txt'].observe(
-            self.AlgnROIPreAx2Shft_txt_chg, names='value')
-        self.hs['AlgnROIPreShft box'].children = [
-            self.hs['AlgnROIPreAx0Shft txt'], self.hs['AlgnROIPreAx1Shft txt'],
-            self.hs['AlgnROIPreAx2Shft txt']
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnROIPreAx0Shft txt"].observe(
+            self.AlgnROIPreAx0Shft_txt_chg, names="value"
+        )
+        self.hs["AlgnROIPreAx1Shft txt"].observe(
+            self.AlgnROIPreAx1Shft_txt_chg, names="value"
+        )
+        self.hs["AlgnROIPreAx2Shft txt"].observe(
+            self.AlgnROIPreAx2Shft_txt_chg, names="value"
+        )
+        self.hs["AlgnROIPreShft box"].children = [
+            self.hs["AlgnROIPreAx0Shft txt"],
+            self.hs["AlgnROIPreAx1Shft txt"],
+            self.hs["AlgnROIPreAx2Shft txt"],
         ]
 
         ## ## ## ## ## ## Define ROI in Source Image
-        self.hs['AlgnROISrcROI box'] = widgets.GridBox(
+        self.hs["AlgnROISrcROI box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.28 * (self.form_sz[0] - 136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto auto auto',
-                'grid_gap': '2px 2px'
-            })
+                "width": "auto",
+                "height": f"{0.28 * (self.form_sz[0] - 136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto auto auto",
+                "grid_gap": "2px 2px",
+            }
+        )
 
-        self.hs['AlgnROISrcROI lbl'] = widgets.HTML(
+        self.hs["AlgnROISrcROI lbl"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + 'Define ROI in Source Image' + '</span>',
+            + "Define ROI in Source Image"
+            + "</span>",
             layout={
-                'background-color': 'white',
-                'color': 'cyan',
-                'height': f'{0.07 * (self.form_sz[0] - 136)}px',
-                'width': 'auto',
-                'flex_shrink': 1,
-                'align-content': 'center',
-                'align-items': 'center',
-                'justify-content': 'center'
-            })
+                "background-color": "white",
+                "color": "cyan",
+                "height": f"{0.07 * (self.form_sz[0] - 136)}px",
+                "width": "auto",
+                "flex_shrink": 1,
+                "align-content": "center",
+                "align-items": "center",
+                "justify-content": "center",
+            },
+        )
 
-        self.hs['AlgnROISrcROIAx0 sldr'] = widgets.IntRangeSlider(
+        self.hs["AlgnROISrcROIAx0 sldr"] = widgets.IntRangeSlider(
             value=[10, 40],
             min=1,
             max=50,
             step=1,
-            description='Axis 0 range:',
+            description="Axis 0 range:",
             disabled=True,
             continuous_update=False,
-            orientation='horizontal',
+            orientation="horizontal",
             readout=True,
-            readout_format='d',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnROISrcROIAx1 sldr'] = widgets.IntRangeSlider(
+            readout_format="d",
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnROISrcROIAx1 sldr"] = widgets.IntRangeSlider(
             value=[10, 40],
             min=1,
             max=50,
             step=1,
-            description='Axis 1 range:',
+            description="Axis 1 range:",
             disabled=True,
             continuous_update=False,
-            orientation='horizontal',
+            orientation="horizontal",
             readout=True,
-            readout_format='d',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnROISrcROIAx2 sldr'] = widgets.IntRangeSlider(
+            readout_format="d",
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnROISrcROIAx2 sldr"] = widgets.IntRangeSlider(
             value=[10, 40],
             min=1,
             max=50,
             step=1,
-            description='Axis 2 range:',
+            description="Axis 2 range:",
             disabled=True,
             continuous_update=False,
-            orientation='horizontal',
+            orientation="horizontal",
             readout=True,
-            readout_format='d',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-
-        self.hs['AlgnROISrcROIAx0 sldr'].observe(
-            self.AlgnROISrcROIAx0_sldr_chg, names='value')
-        self.hs['AlgnROISrcROIAx1 sldr'].observe(
-            self.AlgnROISrcROIAx1_sldr_chg, names='value')
-        self.hs['AlgnROISrcROIAx2 sldr'].observe(
-            self.AlgnROISrcROIAx2_sldr_chg, names='value')
-
-        self.hs['AlgnROISrcROI box'].children = [
-            self.hs['AlgnROISrcROI lbl'], self.hs['AlgnROISrcROIAx0 sldr'],
-            self.hs['AlgnROISrcROIAx1 sldr'], self.hs['AlgnROISrcROIAx2 sldr']
-        ]
-
-        self.hs['AlgnROICfm box'] = widgets.GridBox(
-            layout={
-                'height': f'{0.07 * (self.form_sz[0] - 136)}px',
-                'width': 'auto',
-                'grid_template_columns': '80% auto'
-            })
-
-        self.hs['AlgnROICfm txt'] = widgets.Text(value='Confirm ROI Config',
-                                                 description='',
-                                                 disabled=True,
-                                                 layout={
-                                                     'width': 'auto',
-                                                     'height': 'auto'
-                                                 })
-        self.hs['AlgnROICfm btn'] = widgets.Button(
-            description='Confirm',
-            disabled=True,
-            tooltip='Confirm: Confirm ROI Config')
-        self.hs['AlgnROICfm btn'].style.button_color = 'darkviolet'
-        self.hs['AlgnROICfm btn'].on_click(self.AlgnROICfm_btn_clk)
-
-        self.hs['AlgnROICfm box'].children = [
-            self.hs['AlgnROICfm txt'], self.hs['AlgnROICfm btn']
-        ]
-
-        self.hs['AlgnROI box'].children = [
-            self.hs['AlgnROIPreOShftTtl lbl'], self.hs['AlgnROIPreShft box'],
-            self.hs['AlgnROISrcROI box'], self.hs['AlgnROICfm box']
+            readout_format="d",
+            layout={"width": "auto", "height": "auto"},
+        )
+
+        self.hs["AlgnROISrcROIAx0 sldr"].observe(
+            self.AlgnROISrcROIAx0_sldr_chg, names="value"
+        )
+        self.hs["AlgnROISrcROIAx1 sldr"].observe(
+            self.AlgnROISrcROIAx1_sldr_chg, names="value"
+        )
+        self.hs["AlgnROISrcROIAx2 sldr"].observe(
+            self.AlgnROISrcROIAx2_sldr_chg, names="value"
+        )
+
+        self.hs["AlgnROISrcROI box"].children = [
+            self.hs["AlgnROISrcROI lbl"],
+            self.hs["AlgnROISrcROIAx0 sldr"],
+            self.hs["AlgnROISrcROIAx1 sldr"],
+            self.hs["AlgnROISrcROIAx2 sldr"],
+        ]
+
+        self.hs["AlgnROICfm box"] = widgets.GridBox(
+            layout={
+                "height": f"{0.07 * (self.form_sz[0] - 136)}px",
+                "width": "auto",
+                "grid_template_columns": "80% auto",
+            }
+        )
+
+        self.hs["AlgnROICfm txt"] = widgets.Text(
+            value="Confirm ROI Config",
+            description="",
+            disabled=True,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnROICfm btn"] = widgets.Button(
+            description="Confirm", disabled=True, tooltip="Confirm: Confirm ROI Config"
+        )
+        self.hs["AlgnROICfm btn"].style.button_color = "darkviolet"
+        self.hs["AlgnROICfm btn"].on_click(self.AlgnROICfm_btn_clk)
+
+        self.hs["AlgnROICfm box"].children = [
+            self.hs["AlgnROICfm txt"],
+            self.hs["AlgnROICfm btn"],
+        ]
+
+        self.hs["AlgnROI box"].children = [
+            self.hs["AlgnROIPreOShftTtl lbl"],
+            self.hs["AlgnROIPreShft box"],
+            self.hs["AlgnROISrcROI box"],
+            self.hs["AlgnROICfm box"],
         ]
 
         ## ## ## ## config registration algorithm -- start
-        layout = {'width': 'auto', 'height': f'{0.35*(self.form_sz[0]-136)}px'}
-        self.hs['AlgnRegPar box'] = widgets.VBox()
-        self.hs['AlgnRegPar box'].layout = layout
+        layout = {"width": "auto", "height": f"{0.35*(self.form_sz[0]-136)}px"}
+        self.hs["AlgnRegPar box"] = widgets.VBox()
+        self.hs["AlgnRegPar box"].layout = layout
 
         ## ## ## ## ## fiji&anchor box
-        self.hs['AlgnRegFiji&Anch box'] = widgets.GridBox(
+        self.hs["AlgnRegFiji&Anch box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': 'auto auto auto auto',
-                'grid_template_rows': 'auto'
-            })
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "auto auto auto auto",
+                "grid_template_rows": "auto",
+            }
+        )
 
-        self.hs['AlgnRegFijiMskVwr chbx'] = widgets.Checkbox(
+        self.hs["AlgnRegFijiMskVwr chbx"] = widgets.Checkbox(
             value=False,
             disabled=True,
-            description='preview',
+            description="preview",
             indent=False,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRegChnkSz chbx'] = widgets.Checkbox(
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegChnkSz chbx"] = widgets.Checkbox(
             value=True,
             disabled=True,
-            description='use chunk',
+            description="use chunk",
             indent=False,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRegChnkSz sldr'] = widgets.IntSlider(
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegChnkSz sldr"] = widgets.IntSlider(
             value=7,
             disabled=True,
-            description='chunk size',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRegSliSrch sldr'] = widgets.IntSlider(
+            description="chunk size",
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegSliSrch sldr"] = widgets.IntSlider(
             value=10,
             disabled=True,
-            description='z search half width',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-
-        self.hs['AlgnRegFijiMskVwr chbx'].observe(
-            self.AlgnRegFijiMaskViewer_chbx_chg, names='value')
-        self.hs['AlgnRegChnkSz chbx'].observe(self.AlgnRegChnkSz_chbx_chg,
-                                              names='value')
-        self.hs['AlgnRegChnkSz sldr'].observe(self.AlgnRegChnkSz_sldr_chg,
-                                              names='value')
-        self.hs['AlgnRegSliSrch sldr'].observe(self.AlgnRegSliSrch_sldr_chg,
-                                               names='value')
-        self.hs['AlgnRegFiji&Anch box'].children = [
-            self.hs['AlgnRegFijiMskVwr chbx'], self.hs['AlgnRegChnkSz chbx'],
-            self.hs['AlgnRegChnkSz sldr'], self.hs['AlgnRegSliSrch sldr']
+            description="z search half width",
+            layout={"width": "auto", "height": "auto"},
+        )
+
+        self.hs["AlgnRegFijiMskVwr chbx"].observe(
+            self.AlgnRegFijiMaskViewer_chbx_chg, names="value"
+        )
+        self.hs["AlgnRegChnkSz chbx"].observe(
+            self.AlgnRegChnkSz_chbx_chg, names="value"
+        )
+        self.hs["AlgnRegChnkSz sldr"].observe(
+            self.AlgnRegChnkSz_sldr_chg, names="value"
+        )
+        self.hs["AlgnRegSliSrch sldr"].observe(
+            self.AlgnRegSliSrch_sldr_chg, names="value"
+        )
+        self.hs["AlgnRegFiji&Anch box"].children = [
+            self.hs["AlgnRegFijiMskVwr chbx"],
+            self.hs["AlgnRegChnkSz chbx"],
+            self.hs["AlgnRegChnkSz sldr"],
+            self.hs["AlgnRegSliSrch sldr"],
         ]
 
         ## ## ## ## ## mask options box
-        self.hs['AlgnRegMskOptn box'] = widgets.GridBox(
+        self.hs["AlgnRegMskOptn box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '20% 40% 40%',
-                'grid_template_rows': 'auto'
-            })
-        self.hs['AlgnRegUsMsk chbx'] = widgets.Checkbox(value=False,
-                                                        disabled=True,
-                                                        description='use mask',
-                                                        display='flex',
-                                                        indent=False,
-                                                        layout={
-                                                            'width': 'auto',
-                                                            'height': 'auto'
-                                                        })
-        self.hs['AlgnRegMskThrs sldr'] = widgets.FloatSlider(
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "20% 40% 40%",
+                "grid_template_rows": "auto",
+            }
+        )
+        self.hs["AlgnRegUsMsk chbx"] = widgets.Checkbox(
+            value=False,
+            disabled=True,
+            description="use mask",
+            display="flex",
+            indent=False,
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegMskThrs sldr"] = widgets.FloatSlider(
             value=False,
             disabled=True,
-            description='mask thres',
-            readout_format='.5f',
-            min=-1.,
-            max=10.,
+            description="mask thres",
+            readout_format=".5f",
+            min=-1.0,
+            max=10.0,
             step=1e-5,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRegMskDltn sldr'] = widgets.IntSlider(
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegMskDltn sldr"] = widgets.IntSlider(
             value=False,
             disabled=True,
-            description='mask dilation',
+            description="mask dilation",
             min=0,
             max=30,
             step=1,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-
-        self.hs['AlgnRegUsMsk chbx'].observe(self.AlgnRegUsMsk_chbx_chg,
-                                             names='value')
-        self.hs['AlgnRegMskThrs sldr'].observe(self.AlgnRegMskThrs_sldr_chg,
-                                               names='value')
-        self.hs['AlgnRegMskDltn sldr'].observe(self.AlgnRegMskDltn_sldr_chg,
-                                               names='value')
-        self.hs['AlgnRegMskOptn box'].children = [
-            self.hs['AlgnRegUsMsk chbx'], self.hs['AlgnRegMskThrs sldr'],
-            self.hs['AlgnRegMskDltn sldr']
+            layout={"width": "auto", "height": "auto"},
+        )
+
+        self.hs["AlgnRegUsMsk chbx"].observe(self.AlgnRegUsMsk_chbx_chg, names="value")
+        self.hs["AlgnRegMskThrs sldr"].observe(
+            self.AlgnRegMskThrs_sldr_chg, names="value"
+        )
+        self.hs["AlgnRegMskDltn sldr"].observe(
+            self.AlgnRegMskDltn_sldr_chg, names="value"
+        )
+        self.hs["AlgnRegMskOptn box"].children = [
+            self.hs["AlgnRegUsMsk chbx"],
+            self.hs["AlgnRegMskThrs sldr"],
+            self.hs["AlgnRegMskDltn sldr"],
         ]
 
         ## ## ## ## ## sli_search & chunk_size box
-        self.hs['AlgnRegRegOptn box'] = widgets.GridBox(
+        self.hs["AlgnRegRegOptn box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': 'auto auto',
-                'grid_template_rows': 'auto'
-            })
-
-        self.hs['AlgnRegRegMthd drpdn'] = widgets.Dropdown(
-            value='MRTV',
-            description='reg method',
-            disabled=True,
-            options=['MRTV', 'MPC', 'PC', 'SR', 'LS_MRTV', 'MPC_MRTV'],
-            description_tooltip=
-            'reg method: MPC: Masked Phase Correlation; PC: Phase Correlation; SR: StackReg',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRegRefMod drpdn'] = widgets.Dropdown(
-            value='single',
-            options=['single', 'neighbor', 'average'],
-            description='ref mode',
-            disabled=True,
-            description_tooltip=
-            'ref mode: single: two images with fixed id gap in two consecutive chunks are used for the registration between two chunks; neighbor: two neighbor images in two consecutive chunks are used for the registration between two chunks; average: deprecated',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-
-        self.hs['AlgnRegRegMthd drpdn'].observe(self.AlgnRegRegMthd_drpdn_chg,
-                                                names='value')
-        self.hs['AlgnRegRefMod drpdn'].observe(self.AlgnRegRefMod_drpdn_chg,
-                                               names='value')
-        self.hs['AlgnRegRegOptn box'].children = [
-            self.hs['AlgnRegRegMthd drpdn'], self.hs['AlgnRegRefMod drpdn']
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "auto auto",
+                "grid_template_rows": "auto",
+            }
+        )
+
+        self.hs["AlgnRegRegMthd drpdn"] = widgets.Dropdown(
+            value="MRTV",
+            description="reg method",
+            disabled=True,
+            options=["MRTV", "MPC", "PC", "SR", "LS_MRTV", "MPC_MRTV"],
+            description_tooltip="reg method: MPC: Masked Phase Correlation; PC: Phase Correlation; SR: StackReg",
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegRefMod drpdn"] = widgets.Dropdown(
+            value="single",
+            options=["single", "neighbor", "average"],
+            description="ref mode",
+            disabled=True,
+            description_tooltip="ref mode: single: two images with fixed id gap in two consecutive chunks are used for the registration between two chunks; neighbor: two neighbor images in two consecutive chunks are used for the registration between two chunks; average: deprecated",
+            layout={"width": "auto", "height": "auto"},
+        )
+
+        self.hs["AlgnRegRegMthd drpdn"].observe(
+            self.AlgnRegRegMthd_drpdn_chg, names="value"
+        )
+        self.hs["AlgnRegRefMod drpdn"].observe(
+            self.AlgnRegRefMod_drpdn_chg, names="value"
+        )
+        self.hs["AlgnRegRegOptn box"].children = [
+            self.hs["AlgnRegRegMthd drpdn"],
+            self.hs["AlgnRegRefMod drpdn"],
         ]
 
         ## ## ## ## ##  reg_options box
-        self.hs['AlgnRegMRTVOptn box'] = widgets.GridBox(
+        self.hs["AlgnRegMRTVOptn box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': 'auto auto auto auto auto',
-                'grid_template_rows': 'auto'
-            })
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "auto auto auto auto auto",
+                "grid_template_rows": "auto",
+            }
+        )
 
-        self.hs['AlgnRegMRTVLv txt'] = widgets.BoundedIntText(
+        self.hs["AlgnRegMRTVLv txt"] = widgets.BoundedIntText(
             value=5,
             min=1,
             max=10,
             step=1,
-            description='level',
-            description_tooltip='level: multi-resolution level',
+            description="level",
+            description_tooltip="level: multi-resolution level",
             disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
+            layout={"width": "auto", "height": "auto"},
+        )
 
-        self.hs['AlgnRegMRTVWz txt'] = widgets.BoundedIntText(
+        self.hs["AlgnRegMRTVWz txt"] = widgets.BoundedIntText(
             value=10,
             min=1,
             max=20,
             step=1,
-            description='width',
-            description_tooltip=
-            'width: multi-resolution searching width at each level (number of searching steps)',
+            description="width",
+            description_tooltip="width: multi-resolution searching width at each level (number of searching steps)",
             disabled=True,
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
+            layout={"width": "auto", "height": "auto"},
+        )
 
-        self.hs['AlgnRegMRTVSubpxlSrch drpdn'] = widgets.Dropdown(
-            value='analytical',
+        self.hs["AlgnRegMRTVSubpxlSrch drpdn"] = widgets.Dropdown(
+            value="analytical",
             disabled=True,
-            options=['analytical', 'fitting'],
-            description='subpxl srch',
-            description_tooltip='subpxl srch: subpixel TV minization option',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
+            options=["analytical", "fitting"],
+            description="subpxl srch",
+            description_tooltip="subpxl srch: subpixel TV minization option",
+            layout={"width": "auto", "height": "auto"},
+        )
 
-        self.hs['AlgnRegMRTVSubpxlWz txt'] = widgets.BoundedIntText(
+        self.hs["AlgnRegMRTVSubpxlWz txt"] = widgets.BoundedIntText(
             value=3,
             min=2,
             max=20,
             step=0.1,
-            description='subpxl wz',
+            description="subpxl wz",
             disabled=True,
-            description_tooltip='subpxl wz: final sub-pixel fitting points',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
+            description_tooltip="subpxl wz: final sub-pixel fitting points",
+            layout={"width": "auto", "height": "auto"},
+        )
 
-        self.hs['AlgnRegMRTVSubpxlKrn txt'] = widgets.BoundedIntText(
+        self.hs["AlgnRegMRTVSubpxlKrn txt"] = widgets.BoundedIntText(
             value=3,
             min=2,
             max=20,
             step=1,
-            description='kernel wz',
+            description="kernel wz",
             disabled=True,
-            description_tooltip=
-            'kernel wz: Gaussian blurring width before TV minimization',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-
-        self.hs['AlgnRegMRTVLv txt'].observe(self.AlgnRegMRTVLv_text_chg,
-                                             names='value')
-        self.hs['AlgnRegMRTVWz txt'].observe(self.AlgnRegMRTVWz_txt_chg,
-                                             names='value')
-        self.hs['AlgnRegMRTVSubpxlWz txt'].observe(
-            self.AlgnRegMRTVSubpxlWz_txt_chg, names='value')
-        self.hs['AlgnRegMRTVSubpxlKrn txt'].observe(
-            self.AlgnRegMRTVSubpxlKrn_txt_chg, names='value')
-        self.hs['AlgnRegMRTVSubpxlSrch drpdn'].observe(
-            self.AlgnRegMRTVSubpxlSrch_drpdn_chg, names='value')
-        self.hs['AlgnRegMRTVOptn box'].children = [
-            self.hs['AlgnRegMRTVLv txt'], self.hs['AlgnRegMRTVWz txt'],
-            self.hs['AlgnRegMRTVSubpxlSrch drpdn'],
-            self.hs['AlgnRegMRTVSubpxlWz txt'],
-            self.hs['AlgnRegMRTVSubpxlKrn txt']
+            description_tooltip="kernel wz: Gaussian blurring width before TV minimization",
+            layout={"width": "auto", "height": "auto"},
+        )
+
+        self.hs["AlgnRegMRTVLv txt"].observe(self.AlgnRegMRTVLv_text_chg, names="value")
+        self.hs["AlgnRegMRTVWz txt"].observe(self.AlgnRegMRTVWz_txt_chg, names="value")
+        self.hs["AlgnRegMRTVSubpxlWz txt"].observe(
+            self.AlgnRegMRTVSubpxlWz_txt_chg, names="value"
+        )
+        self.hs["AlgnRegMRTVSubpxlKrn txt"].observe(
+            self.AlgnRegMRTVSubpxlKrn_txt_chg, names="value"
+        )
+        self.hs["AlgnRegMRTVSubpxlSrch drpdn"].observe(
+            self.AlgnRegMRTVSubpxlSrch_drpdn_chg, names="value"
+        )
+        self.hs["AlgnRegMRTVOptn box"].children = [
+            self.hs["AlgnRegMRTVLv txt"],
+            self.hs["AlgnRegMRTVWz txt"],
+            self.hs["AlgnRegMRTVSubpxlSrch drpdn"],
+            self.hs["AlgnRegMRTVSubpxlWz txt"],
+            self.hs["AlgnRegMRTVSubpxlKrn txt"],
         ]
 
         ## ## ## ## ## run registration box
-        self.hs['AlgnRegRunCfm box'] = widgets.GridBox(
+        self.hs["AlgnRegRunCfm box"] = widgets.GridBox(
             layout={
-                'border': '3px solid #FFCC00',
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto'
-            })
-
-        self.hs['AlgnRegRunCfm txt'] = widgets.Text(
-            description='',
-            disabled=True,
-            value='Start Registration ...',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRegRunCfm btn'] = widgets.Button(
-            description='Run',
-            disabled=True,
-            description_tooltip='Run Registration')
-        self.hs['AlgnRegRunCfm btn'].style.button_color = 'darkviolet'
-
-        self.hs['AlgnRegRunCfm btn'].on_click(self.AlgnRegRunCfm_btn_clk)
-        self.hs['AlgnRegRunCfm box'].children = [
-            self.hs['AlgnRegRunCfm txt'], self.hs['AlgnRegRunCfm btn']
-        ]
-
-        self.hs['AlgnRegPar box'].children = [
-            self.hs['AlgnRegFiji&Anch box'], self.hs['AlgnRegMskOptn box'],
-            self.hs['AlgnRegRegOptn box'], self.hs['AlgnRegMRTVOptn box'],
-            self.hs['AlgnRegRunCfm box']
+                "border": "3px solid #FFCC00",
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+            }
+        )
+
+        self.hs["AlgnRegRunCfm txt"] = widgets.Text(
+            description="",
+            disabled=True,
+            value="Start Registration ...",
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRegRunCfm btn"] = widgets.Button(
+            description="Run", disabled=True, description_tooltip="Run Registration"
+        )
+        self.hs["AlgnRegRunCfm btn"].style.button_color = "darkviolet"
+
+        self.hs["AlgnRegRunCfm btn"].on_click(self.AlgnRegRunCfm_btn_clk)
+        self.hs["AlgnRegRunCfm box"].children = [
+            self.hs["AlgnRegRunCfm txt"],
+            self.hs["AlgnRegRunCfm btn"],
+        ]
+
+        self.hs["AlgnRegPar box"].children = [
+            self.hs["AlgnRegFiji&Anch box"],
+            self.hs["AlgnRegMskOptn box"],
+            self.hs["AlgnRegRegOptn box"],
+            self.hs["AlgnRegMRTVOptn box"],
+            self.hs["AlgnRegRunCfm box"],
         ]
 
         ## ## ## ## review registration result box
-        self.hs['AlgnRevReg box'] = widgets.VBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.28*(self.form_sz[0]-136)}px'
-            })
+        self.hs["AlgnRevReg box"] = widgets.VBox(
+            layout={"width": "auto", "height": f"{0.28*(self.form_sz[0]-136)}px"}
+        )
 
         ## ## ## ## ## title the box
-        self.hs['AlgnRevRegTtl box'] = widgets.GridBox(
+        self.hs["AlgnRevRegTtl box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': 'auto',
-                'grid_template_rows': 'auto'
-            })
-        self.hs['AlgnRevRegTtl txt'] = widgets.HTML(
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "auto",
+                "grid_template_rows": "auto",
+            }
+        )
+        self.hs["AlgnRevRegTtl txt"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + 'Review Registration Results' + '</span>',
+            + "Review Registration Results"
+            + "</span>",
             layout={
-                'background-color': 'white',
-                'color': 'cyan',
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRevRegTtl box'].children = [self.hs['AlgnRevRegTtl txt']]
+                "background-color": "white",
+                "color": "cyan",
+                "width": "auto",
+                "height": "auto",
+            },
+        )
+        self.hs["AlgnRevRegTtl box"].children = [self.hs["AlgnRevRegTtl txt"]]
 
         ## ## ## ## ## reg pair box
-        self.hs['AlgnRevRegPair box'] = widgets.GridBox(
+        self.hs["AlgnRevRegPair box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '0px 2px'
-            })
-        self.hs['AlgnRevRegPair sldr'] = widgets.IntSlider(
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "0px 2px",
+            }
+        )
+        self.hs["AlgnRevRegPair sldr"] = widgets.IntSlider(
             value=False,
             disabled=True,
-            description='reg pair #',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-
-        self.hs['AlgnRevRegPairBad btn'] = widgets.Button(
-            description='Bad', description_tooltip='Bad reg', disabled=True)
-        self.hs['AlgnRevRegPairBad btn'].style.button_color = 'darkviolet'
-
-        self.hs['AlgnRevRegPair sldr'].observe(self.AlgnRevRegPair_sldr_chg,
-                                               names='value')
-        self.hs['AlgnRevRegPairBad btn'].on_click(
-            self.AlgnRevRegPairBad_btn_clk)
-        self.hs['AlgnRevRegPair box'].children = [
-            self.hs['AlgnRevRegPair sldr'], self.hs['AlgnRevRegPairBad btn']
+            description="reg pair #",
+            layout={"width": "auto", "height": "auto"},
+        )
+
+        self.hs["AlgnRevRegPairBad btn"] = widgets.Button(
+            description="Bad", description_tooltip="Bad reg", disabled=True
+        )
+        self.hs["AlgnRevRegPairBad btn"].style.button_color = "darkviolet"
+
+        self.hs["AlgnRevRegPair sldr"].observe(
+            self.AlgnRevRegPair_sldr_chg, names="value"
+        )
+        self.hs["AlgnRevRegPairBad btn"].on_click(self.AlgnRevRegPairBad_btn_clk)
+        self.hs["AlgnRevRegPair box"].children = [
+            self.hs["AlgnRevRegPair sldr"],
+            self.hs["AlgnRevRegPairBad btn"],
         ]
 
         ## ## ## ## ## manual shift box -- start
-        self.hs['AlgnRevCorrShft box'] = widgets.GridBox(
+        self.hs["AlgnRevCorrShft box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '30% 30% 30%',
-                'grid_template_rows': 'auto',
-                'grid_gap': '2px 2px'
-            })
-        self.hs['AlgnRevCorrXShft txt'] = widgets.FloatText(
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "30% 30% 30%",
+                "grid_template_rows": "auto",
+                "grid_gap": "2px 2px",
+            }
+        )
+        self.hs["AlgnRevCorrXShft txt"] = widgets.FloatText(
             value=0,
             disabled=True,
             min=-100,
             max=100,
             step=0.5,
-            description='x shift',
+            description="x shift",
             indent=False,
-            layout={'width': '100%'})
-        self.hs['AlgnRevCorrYShft txt'] = widgets.FloatText(
+            layout={"width": "100%"},
+        )
+        self.hs["AlgnRevCorrYShft txt"] = widgets.FloatText(
             value=0,
             disabled=True,
             min=-100,
             max=100,
             step=0.5,
-            description='y shift',
+            description="y shift",
             indent=False,
-            layout={'width': '100%'})
-        self.hs['AlgnRevCorrZShft txt'] = widgets.IntText(
+            layout={"width": "100%"},
+        )
+        self.hs["AlgnRevCorrZShft txt"] = widgets.IntText(
             value=0,
             disabled=True,
             min=1,
             max=100,
             step=1,
-            description='z shift',
+            description="z shift",
             indent=False,
-            layout={'width': '100%'})
+            layout={"width": "100%"},
+        )
 
-        self.hs['AlgnRevCorrXShft txt'].observe(self.AlgnRevCorrXShft_txt_chg,
-                                                names='value')
-        self.hs['AlgnRevCorrYShft txt'].observe(self.AlgnRevCorrYShft_txt_chg,
-                                                names='value')
-        self.hs['AlgnRevCorrZShft txt'].observe(self.AlgnRevCorrZShft_txt_chg,
-                                                names='value')
-        self.hs['AlgnRevCorrShft box'].children = [
-            self.hs['AlgnRevCorrXShft txt'], self.hs['AlgnRevCorrYShft txt'],
-            self.hs['AlgnRevCorrZShft txt']
-        ]
-
-        self.hs['AlgnRevCfmCorrShft box'] = widgets.GridBox(
-            layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '0px 2px'
-            })
-
-        self.hs['AlgnRevCorrShftRec btn'] = widgets.Button(
-            disabled=True,
-            description='Record',
-        )
-        self.hs['AlgnRevCorrShftRec btn'].style.button_color = 'darkviolet'
-        self.hs['AlgnRevCorrShftRec btn'].on_click(
-            self.AlgnRevCorrShftRec_btn_clk)
-        self.hs['AlgnRevCfmCorrShft box'].children = [
-            self.hs['AlgnRevCorrShft box'], self.hs['AlgnRevCorrShftRec btn']
+        self.hs["AlgnRevCorrXShft txt"].observe(
+            self.AlgnRevCorrXShft_txt_chg, names="value"
+        )
+        self.hs["AlgnRevCorrYShft txt"].observe(
+            self.AlgnRevCorrYShft_txt_chg, names="value"
+        )
+        self.hs["AlgnRevCorrZShft txt"].observe(
+            self.AlgnRevCorrZShft_txt_chg, names="value"
+        )
+        self.hs["AlgnRevCorrShft box"].children = [
+            self.hs["AlgnRevCorrXShft txt"],
+            self.hs["AlgnRevCorrYShft txt"],
+            self.hs["AlgnRevCorrZShft txt"],
+        ]
+
+        self.hs["AlgnRevCfmCorrShft box"] = widgets.GridBox(
+            layout={
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "0px 2px",
+            }
+        )
+
+        self.hs["AlgnRevCorrShftRec btn"] = widgets.Button(
+            disabled=True,
+            description="Record",
+        )
+        self.hs["AlgnRevCorrShftRec btn"].style.button_color = "darkviolet"
+        self.hs["AlgnRevCorrShftRec btn"].on_click(self.AlgnRevCorrShftRec_btn_clk)
+        self.hs["AlgnRevCfmCorrShft box"].children = [
+            self.hs["AlgnRevCorrShft box"],
+            self.hs["AlgnRevCorrShftRec btn"],
         ]
         ## ## ## ## ## manual shift box -- end
 
         ## ## ## ## ## confirm review results box
-        self.hs['AlgnRevRegCfm box'] = widgets.GridBox(
+        self.hs["AlgnRevRegCfm box"] = widgets.GridBox(
             layout={
-                'width': 'auto',
-                'height': f'{0.07*(self.form_sz[0]-136)}px',
-                'grid_template_columns': '80% auto',
-                'grid_template_rows': 'auto',
-                'grid_gap': '0px 2px'
-            })
-        self.hs['AlgnRevRegCfm txt'] = widgets.Text(
-            description='',
-            disabled=True,
-            value='Confirm after you finish reg review ...',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
-        self.hs['AlgnRevCfmRev&ProcAlgn btn'] = widgets.Button(
-            description='Confirm',
-            disabled=True,
-            description_tooltip='Confirm after you finish reg review ...')
-        self.hs['AlgnRevCfmRev&ProcAlgn btn'].style.button_color = 'darkviolet'
-
-        self.hs['AlgnRevCfmRev&ProcAlgn btn'].on_click(
-            self.AlgnRevCfmRevProcAlgn_btn_clk)
-        self.hs['AlgnRevRegCfm box'].children = [
-            self.hs['AlgnRevRegCfm txt'], self.hs['AlgnRevCfmRev&ProcAlgn btn']
-        ]
-
-        self.hs['AlgnRevReg box'].children = [
-            self.hs['AlgnRevRegTtl box'], self.hs['AlgnRevRegPair box'],
-            self.hs['AlgnRevCfmCorrShft box'], self.hs['AlgnRevRegCfm box']
+                "width": "auto",
+                "height": f"{0.07*(self.form_sz[0]-136)}px",
+                "grid_template_columns": "80% auto",
+                "grid_template_rows": "auto",
+                "grid_gap": "0px 2px",
+            }
+        )
+        self.hs["AlgnRevRegCfm txt"] = widgets.Text(
+            description="",
+            disabled=True,
+            value="Confirm after you finish reg review ...",
+            layout={"width": "auto", "height": "auto"},
+        )
+        self.hs["AlgnRevCfmRev&ProcAlgn btn"] = widgets.Button(
+            description="Confirm",
+            disabled=True,
+            description_tooltip="Confirm after you finish reg review ...",
+        )
+        self.hs["AlgnRevCfmRev&ProcAlgn btn"].style.button_color = "darkviolet"
+
+        self.hs["AlgnRevCfmRev&ProcAlgn btn"].on_click(
+            self.AlgnRevCfmRevProcAlgn_btn_clk
+        )
+        self.hs["AlgnRevRegCfm box"].children = [
+            self.hs["AlgnRevRegCfm txt"],
+            self.hs["AlgnRevCfmRev&ProcAlgn btn"],
+        ]
+
+        self.hs["AlgnRevReg box"].children = [
+            self.hs["AlgnRevRegTtl box"],
+            self.hs["AlgnRevRegPair box"],
+            self.hs["AlgnRevCfmCorrShft box"],
+            self.hs["AlgnRevRegCfm box"],
         ]
 
         ## ## Integrate widgets
-        self.hs['GenAlgnImg acc'].children = [
-            self.hs['AlgnCfgFns box'], self.hs['AlgnROI box'],
-            self.hs['AlgnRegPar box'], self.hs['AlgnRevReg box']
+        self.hs["GenAlgnImg acc"].children = [
+            self.hs["AlgnCfgFns box"],
+            self.hs["AlgnROI box"],
+            self.hs["AlgnRegPar box"],
+            self.hs["AlgnRevReg box"],
         ]
         # per https://github.com/jupyter-widgets/ipywidgets/issues/2790, accordion title can only be set
         # via set_title in jupyterlab 7.5. It should be set directly when accordion is created after jupyterlab 8.
-        self.hs['GenAlgnImg acc'].set_title(0, 'Config Input/Output Files')
-        self.hs['GenAlgnImg acc'].set_title(1, 'Config Image ROI')
-        self.hs['GenAlgnImg acc'].set_title(2,
-                                            'Config Registration Parameters')
-        self.hs['GenAlgnImg acc'].set_title(
-            3, 'Review Registration Result & Proceed Alignment')
-        self.hs['GenAlgnImg acc'].selected_index = None
-
-        self.hs['GenImgAlign form'].children = [self.hs['GenAlgnImg acc']]
-
-        self.hs['AlgnCfgInTgtPath btn'].initialdir = self.global_h.cwd
-        self.hs['AlgnCfgInSrcPath btn'].initialdir = self.global_h.cwd
-        self.hs['AlgnCfgOutPath btn'].initialdir = self.global_h.cwd
-        self.hs['AlgnCfgCfgFn btn'].initialdir = self.global_h.cwd
+        self.hs["GenAlgnImg acc"].set_title(0, "Config Input/Output Files")
+        self.hs["GenAlgnImg acc"].set_title(1, "Config Image ROI")
+        self.hs["GenAlgnImg acc"].set_title(2, "Config Registration Parameters")
+        self.hs["GenAlgnImg acc"].set_title(
+            3, "Review Registration Result & Proceed Alignment"
+        )
+        self.hs["GenAlgnImg acc"].selected_index = None
+
+        self.hs["GenImgAlign form"].children = [self.hs["GenAlgnImg acc"]]
+
+        self.hs["AlgnCfgInTgtPath btn"].initialdir = self.global_h.cwd
+        self.hs["AlgnCfgInSrcPath btn"].initialdir = self.global_h.cwd
+        self.hs["AlgnCfgOutPath btn"].initialdir = self.global_h.cwd
+        self.hs["AlgnCfgCfgFn btn"].initialdir = self.global_h.cwd
 
     def boxes_logic(self):
         if self.misc_io_cfg_fn_set:
             self.misc_io_man_tgt_fn_set = False
             self.misc_io_man_src_fn_set = False
             self.misc_io_man_sav_fn_set = False
         if not self.misc_io_man_tgt_fn_set:
-            self.hs['AlgnCfgInTgtPath btn'].style.button_color = 'orange'
-            self.hs['AlgnCfgInTgtPath btn'].description = 'Select File'
-            self.hs[
-                'SelInTgtPath text'].value = 'Choose Source Image Directory ...'
+            self.hs["AlgnCfgInTgtPath btn"].style.button_color = "orange"
+            self.hs["AlgnCfgInTgtPath btn"].description = "Select File"
+            self.hs["SelInTgtPath text"].value = "Choose Source Image Directory ..."
             self.misc_io_tgt_fn = None
         if not self.misc_io_man_src_fn_set:
-            self.hs['AlgnCfgInSrcPath btn'].style.button_color = 'orange'
-            self.hs['AlgnCfgInSrcPath btn'].description = 'Select File'
-            self.hs[
-                'SelInSrcPath text'].value = 'Choose Target Image Directory ...'
+            self.hs["AlgnCfgInSrcPath btn"].style.button_color = "orange"
+            self.hs["AlgnCfgInSrcPath btn"].description = "Select File"
+            self.hs["SelInSrcPath text"].value = "Choose Target Image Directory ..."
             self.misc_io_src_fn = None
         if not self.misc_io_man_sav_fn_set:
-            self.hs['AlgnCfgOutPath btn'].style.button_color = 'orange'
-            self.hs['AlgnCfgOutPath btn'].description = 'Select File'
-            self.hs[
-                'SelOutPath text'].value = 'Choose Saving Image Directory ...'
+            self.hs["AlgnCfgOutPath btn"].style.button_color = "orange"
+            self.hs["AlgnCfgOutPath btn"].description = "Select File"
+            self.hs["SelOutPath text"].value = "Choose Saving Image Directory ..."
             self.misc_io_sav_algn_fn = None
         # if self.misc_io_cfg_set:
         #     enable_disable_boxes(self.hs, ['ConfigImgROI acc'],
         #                          disabled=False,
         #                          level=-1)  # 'ImgROI box'
         # else:
         #     enable_disable_boxes(self.hs, ['ConfigImgROI acc'],
         #                          disabled=True,
         #                          level=-1)  # 'ImgROI box'
 
     def read_io_cfg(self, fn):
-        with open(fn, 'r') as f:
+        with open(fn, "r") as f:
             self.misc_io_cfg = json.load(f)
-        self.misc_io_cfg_type = 'cfg file'
-        self.misc_io_tgt_ftype = self.misc_io_cfg['in tgt data']['ftype']
-        self.misc_io_tgt_fn = self.misc_io_cfg['in tgt data']['data fn']
-        self.misc_io_tgt_fn_is_temp = self.misc_io_cfg['in tgt data'][
-            'is data fn temp']
-        self.misc_io_tgt_is_raw = self.misc_io_cfg['in tgt data']['is raw']
-        if self.misc_io_tgt_ftype == '2D tif':
-            self.misc_io_tgt_flat_fn = self.misc_io_cfg['in tgt data']['tif'][
-                '2D']['flat fn']
-            self.misc_io_tgt_dark_fn = self.misc_io_cfg['in tgt data']['tif'][
-                '2D']['dark fn']
-        elif self.misc_io_tgt_ftype == '2Ds tif':
-            self.misc_io_tgt_flat_fn = self.misc_io_cfg['in tgt data']['tif'][
-                '2Ds']['flat fn']
-            self.misc_io_tgt_dark_fn = self.misc_io_cfg['in tgt data']['tif'][
-                '2Ds']['dark fn']
-        elif self.misc_io_tgt_ftype == '3D tif':
-            self.misc_io_tgt_flat_fn = self.misc_io_cfg['in tgt data']['tif'][
-                '3D']['flat fn']
-            self.misc_io_tgt_dark_fn = self.misc_io_cfg['in tgt data']['tif'][
-                '3D']['dark fn']
-            self.misc_io_tgt_3D_tif_flat_id = self.misc_io_cfg['in tgt data'][
-                'tif']['3D']['flat sli idx']
-            self.misc_io_tgt_3D_tif_dark_id = self.misc_io_cfg['in tgt data'][
-                'tif']['3D']['dark sli idx']
-            self.misc_io_tgt_3D_slcn_dim = self.misc_io_cfg['in tgt data'][
-                'tif']['3D']['slicing dim']
-            self.misc_io_tgt_3D_fxd_sli = self.misc_io_cfg['in tgt data'][
-                'tif']['3D']['fixed sli']
-        elif self.misc_io_tgt_ftype == '2D h5':
-            self.misc_io_tgt_flat_fn = self.misc_io_cfg['in tgt data']['h5'][
-                '2D']['flat fn']
-            self.misc_io_tgt_dark_fn = self.misc_io_cfg['in tgt data']['h5'][
-                '2D']['dark fn']
-            self.misc_io_tgt_h5_data_path = self.misc_io_cfg['in tgt data'][
-                'h5']['2D']['data path']
-            self.misc_io_tgt_h5_flat_path = self.misc_io_cfg['in tgt data'][
-                'h5']['2D']['flat path']
-            self.misc_io_tgt_h5_dark_path = self.misc_io_cfg['in tgt data'][
-                'h5']['2D']['dark path']
-        elif self.misc_io_tgt_ftype == '3D h5':
-            self.misc_io_tgt_flat_fn = self.misc_io_cfg['in tgt data']['h5'][
-                '3D']['flat fn']
-            self.misc_io_tgt_dark_fn = self.misc_io_cfg['in tgt data']['h5'][
-                '3D']['dark fn']
-            self.misc_io_tgt_h5_data_path = self.misc_io_cfg['in tgt data'][
-                'h5']['3D']['data path']
-            self.misc_io_tgt_h5_flat_path = self.misc_io_cfg['in tgt data'][
-                'h5']['3D']['flat path']
-            self.misc_io_tgt_h5_dark_path = self.misc_io_cfg['in tgt data'][
-                'h5']['3D']['dark path']
-            self.misc_io_tgt_3D_slcn_dim = self.misc_io_cfg['in tgt data'][
-                'h5']['3D']['slicing dim']
-            self.misc_io_tgt_3D_fxd_sli = self.misc_io_cfg['in tgt data'][
-                'h5']['3D']['fixed sli']
-
-        self.misc_io_src_ftype = self.misc_io_cfg['in src data']['ftype']
-        self.misc_io_src_fn_temp = self.misc_io_cfg['in src data']['data fn']
-        self.misc_io_src_fn_is_temp = self.misc_io_cfg['in src data'][
-            'is data fn temp']
-        self.misc_io_src_is_raw = self.misc_io_cfg['in src data']['is raw']
-        self.misc_io_src_fn_id_s = self.misc_io_cfg['in src data'][
-            'data fn id start']
-        self.misc_io_src_fn_id_e = self.misc_io_cfg['in src data'][
-            'data fn id end']
-        if self.misc_io_src_ftype == '2D tif':
-            self.misc_io_src_flat_fn = self.misc_io_cfg['in src data']['tif'][
-                '2D']['flat fn']
-            self.misc_io_src_dark_fn = self.misc_io_cfg['in src data']['tif'][
-                '2D']['dark fn']
-        elif self.misc_io_src_ftype == '2Ds tif':
-            self.misc_io_src_flat_fn = self.misc_io_cfg['in src data']['tif'][
-                '2Ds']['flat fn']
-            self.misc_io_src_dark_fn = self.misc_io_cfg['in src data']['tif'][
-                '2Ds']['dark fn']
-            self.misc_io_src_sli_id_s = self.misc_io_cfg['in src data']['tif'][
-                '2Ds']['sli start']
-            self.misc_io_src_sli_id_e = self.misc_io_cfg['in src data']['tif'][
-                '2Ds']['sli end']
-            self.misc_io_src_3D_srch_half_wz = self.misc_io_cfg['in src data'][
-                'tif']['2Ds']['srch sli half width']
-        elif self.misc_io_src_ftype == '3D tif':
-            self.misc_io_src_flat_fn = self.misc_io_cfg['in src data']['tif'][
-                '3D']['flat fn']
-            self.misc_io_src_dark_fn = self.misc_io_cfg['in src data']['tif'][
-                '3D']['dark fn']
-            self.misc_io_src_3D_tif_flat_id = self.misc_io_cfg['in src data'][
-                'tif']['3D']['flat sli idx']
-            self.misc_io_src_3D_tif_dark_id = self.misc_io_cfg['in src data'][
-                'tif']['3D']['dark sli idx']
-            self.misc_io_src_3D_slcn_dim = self.misc_io_cfg['in src data'][
-                'tif']['3D']['slicing dim']
-            self.misc_io_src_3D_srch_half_wz = self.misc_io_cfg['in src data'][
-                'tif']['3D']['srch sli half width']
-        elif self.misc_io_src_ftype == '2D h5':
-            self.misc_io_src_flat_fn = self.misc_io_cfg['in src data']['h5'][
-                '2D']['flat fn']
-            self.misc_io_src_dark_fn = self.misc_io_cfg['in src data']['h5'][
-                '2D']['dark fn']
-            self.misc_io_src_h5_data_path = self.misc_io_cfg['in src data'][
-                'h5']['2D']['data path']
-            self.misc_io_src_h5_flat_path = self.misc_io_cfg['in src data'][
-                'h5']['2D']['flat path']
-            self.misc_io_src_h5_dark_path = self.misc_io_cfg['in src data'][
-                'h5']['2D']['dark path']
-        elif self.misc_io_src_ftype == '3D h5':
-            self.misc_io_src_flat_fn = self.misc_io_cfg['in src data']['h5'][
-                '3D']['flat fn']
-            self.misc_io_src_dark_fn = self.misc_io_cfg['in src data']['h5'][
-                '3D']['dark fn']
-            self.misc_io_src_h5_data_path = self.misc_io_cfg['in src data'][
-                'h5']['3D']['data path']
-            self.misc_io_src_h5_flat_path = self.misc_io_cfg['in src data'][
-                'h5']['3D']['flat path']
-            self.misc_io_src_h5_dark_path = self.misc_io_cfg['in src data'][
-                'h5']['3D']['dark path']
-            self.misc_io_src_3D_slcn_dim = self.misc_io_cfg['in src data'][
-                'h5']['3D']['slicing dim']
-            self.misc_io_src_3D_srch_half_wz = self.misc_io_cfg['in src data'][
-                'h5']['3D']['srch sli half width']
-
-        self.misc_io_algn_dtype = self.misc_io_cfg['out algn data']['ftype']
-        self.misc_io_sav_algn_fn = self.misc_io_cfg['out algn data']['out fn']
-        self.misc_io_cfg_fn = self.misc_io_cfg['cfg fn']['cfg fn']
+        self.misc_io_cfg_type = "cfg file"
+        self.misc_io_tgt_ftype = self.misc_io_cfg["in tgt data"]["ftype"]
+        self.misc_io_tgt_fn = self.misc_io_cfg["in tgt data"]["data fn"]
+        self.misc_io_tgt_fn_is_temp = self.misc_io_cfg["in tgt data"]["is data fn temp"]
+        self.misc_io_tgt_is_raw = self.misc_io_cfg["in tgt data"]["is raw"]
+        if self.misc_io_tgt_ftype == "2D tif":
+            self.misc_io_tgt_flat_fn = self.misc_io_cfg["in tgt data"]["tif"]["2D"][
+                "flat fn"
+            ]
+            self.misc_io_tgt_dark_fn = self.misc_io_cfg["in tgt data"]["tif"]["2D"][
+                "dark fn"
+            ]
+        elif self.misc_io_tgt_ftype == "2Ds tif":
+            self.misc_io_tgt_flat_fn = self.misc_io_cfg["in tgt data"]["tif"]["2Ds"][
+                "flat fn"
+            ]
+            self.misc_io_tgt_dark_fn = self.misc_io_cfg["in tgt data"]["tif"]["2Ds"][
+                "dark fn"
+            ]
+        elif self.misc_io_tgt_ftype == "3D tif":
+            self.misc_io_tgt_flat_fn = self.misc_io_cfg["in tgt data"]["tif"]["3D"][
+                "flat fn"
+            ]
+            self.misc_io_tgt_dark_fn = self.misc_io_cfg["in tgt data"]["tif"]["3D"][
+                "dark fn"
+            ]
+            self.misc_io_tgt_3D_tif_flat_id = self.misc_io_cfg["in tgt data"]["tif"][
+                "3D"
+            ]["flat sli idx"]
+            self.misc_io_tgt_3D_tif_dark_id = self.misc_io_cfg["in tgt data"]["tif"][
+                "3D"
+            ]["dark sli idx"]
+            self.misc_io_tgt_3D_slcn_dim = self.misc_io_cfg["in tgt data"]["tif"]["3D"][
+                "slicing dim"
+            ]
+            self.misc_io_tgt_3D_fxd_sli = self.misc_io_cfg["in tgt data"]["tif"]["3D"][
+                "fixed sli"
+            ]
+        elif self.misc_io_tgt_ftype == "2D h5":
+            self.misc_io_tgt_flat_fn = self.misc_io_cfg["in tgt data"]["h5"]["2D"][
+                "flat fn"
+            ]
+            self.misc_io_tgt_dark_fn = self.misc_io_cfg["in tgt data"]["h5"]["2D"][
+                "dark fn"
+            ]
+            self.misc_io_tgt_h5_data_path = self.misc_io_cfg["in tgt data"]["h5"]["2D"][
+                "data path"
+            ]
+            self.misc_io_tgt_h5_flat_path = self.misc_io_cfg["in tgt data"]["h5"]["2D"][
+                "flat path"
+            ]
+            self.misc_io_tgt_h5_dark_path = self.misc_io_cfg["in tgt data"]["h5"]["2D"][
+                "dark path"
+            ]
+        elif self.misc_io_tgt_ftype == "3D h5":
+            self.misc_io_tgt_flat_fn = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "flat fn"
+            ]
+            self.misc_io_tgt_dark_fn = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "dark fn"
+            ]
+            self.misc_io_tgt_h5_data_path = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "data path"
+            ]
+            self.misc_io_tgt_h5_flat_path = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "flat path"
+            ]
+            self.misc_io_tgt_h5_dark_path = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "dark path"
+            ]
+            self.misc_io_tgt_3D_slcn_dim = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "slicing dim"
+            ]
+            self.misc_io_tgt_3D_fxd_sli = self.misc_io_cfg["in tgt data"]["h5"]["3D"][
+                "fixed sli"
+            ]
+
+        self.misc_io_src_ftype = self.misc_io_cfg["in src data"]["ftype"]
+        self.misc_io_src_fn_temp = self.misc_io_cfg["in src data"]["data fn"]
+        self.misc_io_src_fn_is_temp = self.misc_io_cfg["in src data"]["is data fn temp"]
+        self.misc_io_src_is_raw = self.misc_io_cfg["in src data"]["is raw"]
+        self.misc_io_src_fn_id_s = self.misc_io_cfg["in src data"]["data fn id start"]
+        self.misc_io_src_fn_id_e = self.misc_io_cfg["in src data"]["data fn id end"]
+        if self.misc_io_src_ftype == "2D tif":
+            self.misc_io_src_flat_fn = self.misc_io_cfg["in src data"]["tif"]["2D"][
+                "flat fn"
+            ]
+            self.misc_io_src_dark_fn = self.misc_io_cfg["in src data"]["tif"]["2D"][
+                "dark fn"
+            ]
+        elif self.misc_io_src_ftype == "2Ds tif":
+            self.misc_io_src_flat_fn = self.misc_io_cfg["in src data"]["tif"]["2Ds"][
+                "flat fn"
+            ]
+            self.misc_io_src_dark_fn = self.misc_io_cfg["in src data"]["tif"]["2Ds"][
+                "dark fn"
+            ]
+            self.misc_io_src_sli_id_s = self.misc_io_cfg["in src data"]["tif"]["2Ds"][
+                "sli start"
+            ]
+            self.misc_io_src_sli_id_e = self.misc_io_cfg["in src data"]["tif"]["2Ds"][
+                "sli end"
+            ]
+            self.misc_io_src_3D_srch_half_wz = self.misc_io_cfg["in src data"]["tif"][
+                "2Ds"
+            ]["srch sli half width"]
+        elif self.misc_io_src_ftype == "3D tif":
+            self.misc_io_src_flat_fn = self.misc_io_cfg["in src data"]["tif"]["3D"][
+                "flat fn"
+            ]
+            self.misc_io_src_dark_fn = self.misc_io_cfg["in src data"]["tif"]["3D"][
+                "dark fn"
+            ]
+            self.misc_io_src_3D_tif_flat_id = self.misc_io_cfg["in src data"]["tif"][
+                "3D"
+            ]["flat sli idx"]
+            self.misc_io_src_3D_tif_dark_id = self.misc_io_cfg["in src data"]["tif"][
+                "3D"
+            ]["dark sli idx"]
+            self.misc_io_src_3D_slcn_dim = self.misc_io_cfg["in src data"]["tif"]["3D"][
+                "slicing dim"
+            ]
+            self.misc_io_src_3D_srch_half_wz = self.misc_io_cfg["in src data"]["tif"][
+                "3D"
+            ]["srch sli half width"]
+        elif self.misc_io_src_ftype == "2D h5":
+            self.misc_io_src_flat_fn = self.misc_io_cfg["in src data"]["h5"]["2D"][
+                "flat fn"
+            ]
+            self.misc_io_src_dark_fn = self.misc_io_cfg["in src data"]["h5"]["2D"][
+                "dark fn"
+            ]
+            self.misc_io_src_h5_data_path = self.misc_io_cfg["in src data"]["h5"]["2D"][
+                "data path"
+            ]
+            self.misc_io_src_h5_flat_path = self.misc_io_cfg["in src data"]["h5"]["2D"][
+                "flat path"
+            ]
+            self.misc_io_src_h5_dark_path = self.misc_io_cfg["in src data"]["h5"]["2D"][
+                "dark path"
+            ]
+        elif self.misc_io_src_ftype == "3D h5":
+            self.misc_io_src_flat_fn = self.misc_io_cfg["in src data"]["h5"]["3D"][
+                "flat fn"
+            ]
+            self.misc_io_src_dark_fn = self.misc_io_cfg["in src data"]["h5"]["3D"][
+                "dark fn"
+            ]
+            self.misc_io_src_h5_data_path = self.misc_io_cfg["in src data"]["h5"]["3D"][
+                "data path"
+            ]
+            self.misc_io_src_h5_flat_path = self.misc_io_cfg["in src data"]["h5"]["3D"][
+                "flat path"
+            ]
+            self.misc_io_src_h5_dark_path = self.misc_io_cfg["in src data"]["h5"]["3D"][
+                "dark path"
+            ]
+            self.misc_io_src_3D_slcn_dim = self.misc_io_cfg["in src data"]["h5"]["3D"][
+                "slicing dim"
+            ]
+            self.misc_io_src_3D_srch_half_wz = self.misc_io_cfg["in src data"]["h5"][
+                "3D"
+            ]["srch sli half width"]
+
+        self.misc_io_algn_dtype = self.misc_io_cfg["out algn data"]["ftype"]
+        self.misc_io_sav_algn_fn = self.misc_io_cfg["out algn data"]["out fn"]
+        self.misc_io_cfg_fn = self.misc_io_cfg["cfg fn"]["cfg fn"]
 
     def preset_roi_layout(self):
         self.misc_io_src_fn_temp = None
         self.misc_io_src_is_raw = False
         self.misc_io_src_fn_id_s = None
         self.misc_io_src_fn_id_e = None
         self.misc_io_src_flat_fn = None
         self.misc_io_src_dark_fn = None
         self.misc_io_src_3D_tif_flat_id = 0
         self.misc_io_src_3D_tif_dark_id = -1
         self.misc_io_src_3D_slcn_dim = 0
         self.misc_io_src_3D_srch_half_wz = 10
-        self.misc_io_src_h5_data_path = 'img'
-        self.misc_io_src_h5_flat_path = 'img_bkg'
-        self.misc_io_src_h5_dark_path = 'img_dark'
-        if self.misc_io_src_ftype == '2Ds tif':
+        self.misc_io_src_h5_data_path = "img"
+        self.misc_io_src_h5_flat_path = "img_bkg"
+        self.misc_io_src_h5_dark_path = "img_dark"
+        if self.misc_io_src_ftype == "2Ds tif":
             # fns = glob.glob(os.path.baseame(self.misc_io_src_fn_temp.replace('{0}', '*').replace('{1}', '*')),
             #                 root_dir=os.path.dirname(self.misc_io_src_fn_temp))
             # im_id = fns[int(len(fns)/2)].split('.')[0].split('_')[-1]
-            fn_id = int(
-                (self.misc_io_src_fn_id_s + self.misc_io_src_fn_id_e) / 2)
-            sli_id = int(
-                (self.misc_io_src_sli_id_s + self.misc_io_src_sli_id_e) / 2)
-            self.misc_io_src_fn = self.misc_io_src_fn_temp.format(
-                fn_id, sli_id)
+            fn_id = int((self.misc_io_src_fn_id_s + self.misc_io_src_fn_id_e) / 2)
+            sli_id = int((self.misc_io_src_sli_id_s + self.misc_io_src_sli_id_e) / 2)
+            self.misc_io_src_fn = self.misc_io_src_fn_temp.format(fn_id, sli_id)
             self.AlgnROIPreAx0Shft_txt_chg.disabled = False
             self.AlgnROISrcROIAx0_sldr_chg.disabled = False
         else:
-            fn_id = int(
-                (self.misc_io_src_fn_id_s + self.misc_io_src_fn_id_e) / 2)
+            fn_id = int((self.misc_io_src_fn_id_s + self.misc_io_src_fn_id_e) / 2)
             self.misc_io_src_fn = self.misc_io_src_fn_temp.format(fn_id)
-            if self.misc_io_src_ftype in ['3D tif', '3D h5']:
+            if self.misc_io_src_ftype in ["3D tif", "3D h5"]:
                 self.AlgnROIPreAx0Shft_txt_chg.disabled = False
                 self.AlgnROISrcROIAx0_sldr_chg.disabled = False
             else:
                 self.AlgnROIPreAx0Shft_txt_chg.disabled = True
                 self.AlgnROISrcROIAx0_sldr_chg.disabled = True
 
     def AlgnCfgInDatTyp_radbtn_chg(self, a):
-        self.misc_io_in_ftype = a['owner'].value
+        self.misc_io_in_ftype = a["owner"].value
         self.misc_io_tgt_ftype = self.misc_io_in_ftype
         self.misc_io_src_ftype = self.misc_io_in_ftype
-        if self.misc_io_in_ftype in ['2D tif', '2D h5']:
-            self.hs['AlgnCfgOutDatTyp Btn'].options = ['2D tif', '2D h5']
+        if self.misc_io_in_ftype in ["2D tif", "2D h5"]:
+            self.hs["AlgnCfgOutDatTyp Btn"].options = ["2D tif", "2D h5"]
         else:
-            self.hs['AlgnCfgOutDatTyp Btn'].options = [
-                '2Ds tif', '3D tif', '3D h5'
-            ]
-        self.hs['AlgnCfgOutDatTyp Btn'].value = self.misc_io_in_ftype
+            self.hs["AlgnCfgOutDatTyp Btn"].options = ["2Ds tif", "3D tif", "3D h5"]
+        self.hs["AlgnCfgOutDatTyp Btn"].value = self.misc_io_in_ftype
 
-        if 'tif' in self.misc_io_in_ftype:
-            self.hs['AlgnCfgInSrcPath btn'].open_filetypes = (('tif files', [
-                '*.tif', '*.tiff'
-            ]), )
-            self.hs['AlgnCfgInTgtPath btn'].open_filetypes = (('tif files', [
-                '*.tif', '*.tiff'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].filetypes = (['*.tif', '*.tiff'], )
-            self.hs['AlgnCfgOutPath btn'].open_filetypes = (('tif files', [
-                '*.tif', '*.tiff'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].initialfile = 'aligned_image.tif'
+        if "tif" in self.misc_io_in_ftype:
+            self.hs["AlgnCfgInSrcPath btn"].open_filetypes = (
+                ("tif files", ["*.tif", "*.tiff"]),
+            )
+            self.hs["AlgnCfgInTgtPath btn"].open_filetypes = (
+                ("tif files", ["*.tif", "*.tiff"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].filetypes = (["*.tif", "*.tiff"],)
+            self.hs["AlgnCfgOutPath btn"].open_filetypes = (
+                ("tif files", ["*.tif", "*.tiff"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].initialfile = "aligned_image.tif"
         else:
-            self.hs['AlgnCfgInSrcPath btn'].open_filetypes = (('h5 files', [
-                '*.h5', '*.hdf', '*.hdf5'
-            ]), )
-            self.hs['AlgnCfgInTgtPath btn'].open_filetypes = (('h5 files', [
-                '*.h5', '*.hdf', '*.hdf5'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].filetypes = ([
-                '*.h5', '*.hdf', '*.hdf5'
-            ], )
-            self.hs['AlgnCfgOutPath btn'].open_filetypes = (('h5 files', [
-                '*.h5', '*.hdf', '*.hdf5'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].initialfile = 'aligned_image.h5'
+            self.hs["AlgnCfgInSrcPath btn"].open_filetypes = (
+                ("h5 files", ["*.h5", "*.hdf", "*.hdf5"]),
+            )
+            self.hs["AlgnCfgInTgtPath btn"].open_filetypes = (
+                ("h5 files", ["*.h5", "*.hdf", "*.hdf5"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].filetypes = (["*.h5", "*.hdf", "*.hdf5"],)
+            self.hs["AlgnCfgOutPath btn"].open_filetypes = (
+                ("h5 files", ["*.h5", "*.hdf", "*.hdf5"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].initialfile = "aligned_image.h5"
 
-        if self.misc_io_in_ftype in ['2D tif', '3D tif']:
+        if self.misc_io_in_ftype in ["2D tif", "3D tif"]:
             self.io_img_reader = data_reader(tif_reader)
             self.misc_io_reader_cfg = {}
-        elif self.misc_io_in_ftype in ['2D h5', '3D h5']:
+        elif self.misc_io_in_ftype in ["2D h5", "3D h5"]:
             self.io_img_reader = data_reader(h5_reader)
-            self.misc_io_reader_cfg = {'ds_path': 'img'}
+            self.misc_io_reader_cfg = {"ds_path": "img"}
         else:
             self.io_img_reader = data_reader(tifs_reader)
-            self.misc_io_reader_cfg = {'scan_id': None}
+            self.misc_io_reader_cfg = {"scan_id": None}
         self.misc_io_man_tgt_fn_set = False
         self.misc_io_man_src_fn_set = False
         self.misc_io_cfg_fn_set = False
         self.misc_io_cfg_set = False
         self.boxes_logic()
 
     def AlgnCfgInTgtPath_btn_clk(self, a):
         if len(a.files[0]) != 0:
             self.misc_io_tgt_fn = a.files[0]
             self.misc_io_man_tgt_fn_set = True
             # self.hs['AlgnCfgInTgtPath btn'].initialdir = os.path.abspath(
             #     os.path.dirname(a.files[0]))
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.abspath(os.path.dirname(a.files[0]))},
+            # )
             update_json_content(
                 self.global_h.GUI_cfg_file,
-                {'cwd': os.path.abspath(os.path.dirname(a.files[0]))})
+                {"cwd": str(Path(a.files[0]).parent)},
+            )
         else:
             self.misc_io_tgt_fn = None
             self.misc_io_man_tgt_fn_set = False
         self.misc_io_cfg_fn_set = False
         self.misc_io_cfg_set = False
         self.boxes_logic()
 
     def AlgnCfgInSrcPath_btn_clk(self, a):
         if len(a.files[0]) != 0:
             self.misc_io_src_fn = a.files[0]
             self.misc_io_man_src_fn_set = True
             # self.hs['AlgnCfgInSrcPath btn'].initialdir = os.path.abspath(
             #     os.path.dirname(a.files[0]))
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.abspath(os.path.dirname(a.files[0]))},
+            # )
             update_json_content(
                 self.global_h.GUI_cfg_file,
-                {'cwd': os.path.abspath(os.path.dirname(a.files[0]))})
+                {"cwd": str(Path(a.files[0]).parent)},
+            )
         else:
             self.misc_io_src_fn = None
             self.misc_io_man_src_fn_set = False
         self.misc_io_cfg_fn_set = False
         self.misc_io_cfg_set = False
         self.boxes_logic()
 
     def AlgnCfgOutDatTyp_radbtn_chg(self, a):
-        self.misc_io_out_dtype = self.hs['AlgnCfgOutDatTyp Btn'].value
-        if 'tif' in self.misc_io_out_dtype:
-            self.hs['AlgnCfgOutPath btn'].filetypes = (('tif files',
-                                                        ['*.tif', '*.tiff']), )
-            self.hs['AlgnCfgOutPath btn'].open_filetypes = (('tif files', [
-                '*.tif', '*.tiff'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].initialfile = 'aligned_image.tif'
+        self.misc_io_out_dtype = self.hs["AlgnCfgOutDatTyp Btn"].value
+        if "tif" in self.misc_io_out_dtype:
+            self.hs["AlgnCfgOutPath btn"].filetypes = (
+                ("tif files", ["*.tif", "*.tiff"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].open_filetypes = (
+                ("tif files", ["*.tif", "*.tiff"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].initialfile = "aligned_image.tif"
         else:
-            self.hs['AlgnCfgOutPath btn'].filetypes = (('h5 files', [
-                '*.h5', '*.hdf', '*.hdf5'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].open_filetypes = (('h5 files', [
-                '*.h5', '*.hdf', '*.hdf5'
-            ]), )
-            self.hs['AlgnCfgOutPath btn'].initialfile = 'aligned_image.h5'
+            self.hs["AlgnCfgOutPath btn"].filetypes = (
+                ("h5 files", ["*.h5", "*.hdf", "*.hdf5"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].open_filetypes = (
+                ("h5 files", ["*.h5", "*.hdf", "*.hdf5"]),
+            )
+            self.hs["AlgnCfgOutPath btn"].initialfile = "aligned_image.h5"
 
-        if self.misc_io_out_dtype in ['2D tif', '3D tif']:
+        if self.misc_io_out_dtype in ["2D tif", "3D tif"]:
             self.io_sav_writer = data_writer(tif_writer)
             self.misc_io_writer_cfg = {}
-        elif self.misc_io_out_dtype in ['2D h5', '3D h5']:
+        elif self.misc_io_out_dtype in ["2D h5", "3D h5"]:
             self.io_sav_writer = data_writer(h5_writer)
-            self.misc_io_writer_cfg['ds_path'] = 'img'
+            self.misc_io_writer_cfg["ds_path"] = "img"
         else:
             self.io_sav_writer = data_writer(tif_seq_writer)
-            self.misc_io_writer_cfg['scan_id='] = None
-            self.misc_io_writer_cfg['idx_s'] = 0
-            self.misc_io_writer_cfg['idx_dim'] = 0
+            self.misc_io_writer_cfg["scan_id="] = None
+            self.misc_io_writer_cfg["idx_s"] = 0
+            self.misc_io_writer_cfg["idx_dim"] = 0
         self.misc_io_man_sav_fn_set = False
         self.misc_io_cfg_fn_set = False
         self.misc_io_cfg_set = False
         self.boxes_logic()
 
     def AlgnCfgOutPath_btn_clk(self, a):
         if len(a.files[0]) != 0:
             self.misc_io_sav_algn_fn = a.files[0]
             self.misc_io_man_sav_fn_set = True
             # self.hs['AlgnCfgOutPath btn'].initialdir = os.path.abspath(
             #     os.path.dirname(a.files[0]))
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.abspath(os.path.dirname(a.files[0]))},
+            # )
             update_json_content(
                 self.global_h.GUI_cfg_file,
-                {'cwd': os.path.abspath(os.path.dirname(a.files[0]))})
+                {"cwd": str(Path(a.files[0]).parent)},
+            )
         else:
             self.misc_io_sav_algn_fn = None
             self.misc_io_man_sav_fn_set = False
         self.misc_io_cfg_fn_set = False
         self.misc_io_cfg_set = False
         self.boxes_logic()
 
     def AlgnCfgCfmManFilePath_btn_clk(self, a):
         self.misc_io_cfg_type = "manual"
-        if self.misc_io_in_ftype in ['3D tif', '3D h5']:
+        if self.misc_io_in_ftype in ["3D tif", "3D h5"]:
             self.misc_io_tgt_3D_slcn_dim = 0
             self.misc_io_src_3D_slicing_dim = 0
         self.misc_io_tgt_is_raw = True
         self.misc_io_src_is_raw = True
         self.misc_dat_scla = 1
         self.misc_dat_use_smth_flat = False
         self.misc_dat_smth_flat_sig = 0
         self.misc_dat_use_alt_flat = False
 
         self.misc_io_alt_flat_fn = None
 
-        dirname = os.path.dirname(self.misc_io_src_fn)
-        if os.path.exists(os.path.join(dirname, 'aligned')):
-            shutil.rmtree(os.path.join(dirname, 'aligned'))
-        os.mkdir(os.path.join(dirname, 'aligned'))
-        ext = os.path.basename(self.misc_io_src_fn).split('.')[-1]
-        stem = ''.join(os.path.basename(self.misc_io_src_fn).split('.')[:-1])
-        if self.misc_io_in_ftype == '2Ds tif':
-            s = '_'.join(stem.split('_')[:-2]) + '_'
-            self.misc_io_src_fn_temp = os.path.join(dirname,
-                                                    (s + '{0}_{1}.' + ext))
-            self.misc_io_src_fn_id_s = stem.split('_')[-2]
-            self.misc_io_src_fn_id_e = stem.split('_')[-2]
-            self.misc_io_src_sli_id_s = stem.split('_')[-1]
-            self.misc_io_src_sli_id_e = stem.split('_')[-1]
+        # dirname = os.path.dirname(self.misc_io_src_fn)
+        # if os.path.exists(os.path.join(dirname, "aligned")):
+        #     shutil.rmtree(os.path.join(dirname, "aligned"))
+        # os.mkdir(os.path.join(dirname, "aligned"))
+        # ext = os.path.basename(self.misc_io_src_fn).split(".")[-1]
+        # stem = "".join(os.path.basename(self.misc_io_src_fn).split(".")[:-1])
+        # if self.misc_io_in_ftype == "2Ds tif":
+        #     s = "_".join(stem.split("_")[:-2]) + "_"
+        #     self.misc_io_src_fn_temp = os.path.join(dirname, (s + "{0}_{1}." + ext))
+        #     self.misc_io_src_fn_id_s = stem.split("_")[-2]
+        #     self.misc_io_src_fn_id_e = stem.split("_")[-2]
+        #     self.misc_io_src_sli_id_s = stem.split("_")[-1]
+        #     self.misc_io_src_sli_id_e = stem.split("_")[-1]
+        # else:
+        #     s = "_".join(stem.split("_")[:-1]) + "_"
+        #     self.misc_io_src_fn_temp = os.path.join(dirname, (s + "{0}." + ext))
+        #     self.misc_io_src_fn_id_s = stem.split("_")[-1]
+        #     self.misc_io_src_fn_id_e = stem.split("_")[-1]
+        # t = "-".join(time.asctime().replace(":", "-").split(" "))
+        # self.misc_sav_algn_fn = os.path.join(
+        #     dirname, "aligned", ("aligned_" + s + t + "{}.h5")
+        # )
+        # self.misc_io_cfg_fn = os.path.join(dirname, s + "io_config_" + t + ".json")
+        # self.misc_sav_trl_reg_cfg_fn = os.path.join(
+        #     dirname, "trial_reg_" + s + "config_" + t + ".json"
+        # )
+        # self.misc_rev_best_mtch_fn = os.path.join(
+        #     dirname, "trial_reg_" + s + "best_match_" + t + ".json"
+        # )
+        dirname = Path(self.misc_io_src_fn).parent
+        if (dirname / "aligned").exists():
+            shutil.rmtree(dirname / "aligned")
+        Path.mkdir((dirname / "aligned"))
+        ext = Path(self.misc_io_src_fn).suffix.strip(".")
+        stem = Path(self.misc_io_src_fn).stem
+        if self.misc_io_in_ftype == "2Ds tif":
+            s = "_".join(stem.split("_")[:-2]) + "_"
+            self.misc_io_src_fn_temp = dirname / (s + "{0}_{1}." + ext)
+            self.misc_io_src_fn_id_s = stem.split("_")[-2]
+            self.misc_io_src_fn_id_e = stem.split("_")[-2]
+            self.misc_io_src_sli_id_s = stem.split("_")[-1]
+            self.misc_io_src_sli_id_e = stem.split("_")[-1]
         else:
-            s = '_'.join(stem.split('_')[:-1]) + '_'
-            self.misc_io_src_fn_temp = os.path.join(dirname,
-                                                    (s + '{0}.' + ext))
-            self.misc_io_src_fn_id_s = stem.split('_')[-1]
-            self.misc_io_src_fn_id_e = stem.split('_')[-1]
-        t = '-'.join(time.asctime().replace(':', '-').split(' '))
-        self.misc_sav_algn_fn = os.path.join(dirname, 'aligned',
-                                             ('aligned_' + s + t + '{}.h5'))
-        self.misc_io_cfg_fn = os.path.join(dirname,
-                                           s + 'io_config_' + t + '.json')
-        self.misc_sav_trl_reg_cfg_fn = os.path.join(
-            dirname, 'trial_reg_' + s + 'config_' + t + '.json')
-        self.misc_rev_best_mtch_fn = os.path.join(
-            dirname, 'trial_reg_' + s + 'best_match_' + t + '.json')
-
-        self.misc_io_cfg = {'Note 1' : 'cfg type == manual is good for generating a config template that can be used '+\
-                                       'in a more complicated scenario',
-                            'Note 2' : 'With 2D/3D tif input file formats, it is suitable for registering two '+\
-                                       'individual images. If the file names are distinguished by an index on the '+\
-                                       'end, it is also possible to register a series of images to one reference '+\
-                                       'image. The option with 2D/3D h5 file formats is similar to 2D/3D tif option. '+\
-                                       'The difference between them is that you need to specify dataset path for h5. '+\
-                                       'In both cases, you can specify flat and dark images if the input data is raw. '+\
-                                       '2Ds tif input file format option is for registering two sets of 3D images '+\
-                                       'in 2D maner. You will need to specify one slice image from the reference image '+\
-                                       'then have the slice images in a range in the second image compare to the '+\
-                                       'reference slice image. It is supposed that there are two indices in the file '+\
-                                       'names, one is for distinguishing the two image series, and another is for '+\
-                                       'indexing slice images in each image series.',
-                            'cfg type' : self.misc_io_cfg_type,
-                            'in tgt data' : {
-                                'ftype' : self.misc_io_tgt_ftype,
-                                'data fn' : self.misc_io_tgt_fn,
-                                'is data fn temp': self.misc_io_tgt_fn_is_temp,
-                                'data fn id start' : self.misc_io_tgt_fn_id_s,
-                                'data fn id end' : self.misc_io_tgt_fn_id_e,
-                                'is raw' : False,
-                                'tif' : {
-                                    '2D' : {'flat fn': None,
-                                            'dark fn': None},
-                                    '3D' : {'flat fn': None,
-                                            'dark fn': None,
-                                            'flat sli idx': 0,
-                                            'dark sli idx': -1,
-                                            'slicing dim': 0,
-                                            'fixed sli': 0},
-                                    '2Ds' : {'flat fn': None,
-                                             'dark fn': None}
-                                         },
-                                'h5' : {
-                                    '2D' : {
-                                        'flat fn': self.misc_io_tgt_fn if self.misc_io_tgt_ftype == '2D h5' else None,
-                                        'dark fn': self.misc_io_tgt_fn if self.misc_io_tgt_ftype == '2D h5' else None,
-                                        'data path': '/img',
-                                        'flat path': '/img_bkg',
-                                        'dark path': '/img_dark'},
-                                    '3D' : {
-                                        'flat fn': self.misc_io_tgt_fn if self.misc_io_tgt_ftype == '3D h5' else None,
-                                        'dark fn': self.misc_io_tgt_fn if self.misc_io_tgt_ftype == '3D h5' else None,
-                                        'data path': '/img',
-                                        'flat path': '/img_bkg',
-                                        'dark path': '/img_dark',
-                                        'slicing dim': 0,
-                                        'fixed sli': 0}
-                                    }
-                                },
-                            'in src data' : {
-                                'ftype' : self.misc_io_src_ftype,
-                                'is raw' : False,
-                                'data fn' : self.misc_io_src_fn_temp,
-                                'is data fn temp': self.misc_io_src_fn_is_temp,
-                                'data fn id start' : self.misc_io_src_fn_id_s,
-                                'data fn id end' : self.misc_io_src_fn_id_e,
-                                'tif' : {
-                                    '2D' : {'flat fn': None,
-                                            'dark fn': None},
-                                    '3D' : {'flat fn': None,
-                                            'dark fn': None,
-                                            'flat sli idx': 0,
-                                            'dark sli idx': -1,
-                                            'slicing dim': 0,
-                                            'srch sli half width': 10},
-                                    '2Ds' : {'flat fn': None,
-                                             'dark fn': None,
-                                             'sli start': self.misc_io_src_sli_id_s,
-                                             'sli end': self.misc_io_src_sli_id_e,
-                                             'srch sli half width': 10}
-                                    },
-                                'h5' : {
-                                    '2D' : {
-                                        'flat fn': self.misc_io_src_fn if self.misc_io_tgt_ftype == '2D h5' else None,
-                                        'dark fn': self.misc_io_src_fn if self.misc_io_tgt_ftype == '2D h5' else None,
-                                        'data path': '/img',
-                                        'flat path': '/img_bkg',
-                                        'dark path': '/img_dark'},
-                                    '3D' : {
-                                        'flat fn': self.misc_io_src_fn if self.misc_io_tgt_ftype == '3D h5' else None,
-                                        'dark fn': self.misc_io_src_fn if self.misc_io_tgt_ftype == '3D h5' else None,
-                                        'data path': '/img',
-                                        'flat path': '/img_bkg',
-                                        'dark path': '/img_dark',
-                                        'slicing dim': 0,
-                                        'srch sli half width': 10}
-                                }
-                            },
-                            'out algn data' : {
-                                'ftype' : 'h5',
-                                'out fn' : self.misc_io_sav_algn_fn
-                                },
-                            'cfg fn' : {
-                                'cfg fn' : self.misc_io_cfg_fn
-                                }
-                            }
+            s = "_".join(stem.split("_")[:-1]) + "_"
+            self.misc_io_src_fn_temp = dirname / (s + "{0}." + ext)
+            self.misc_io_src_fn_id_s = stem.split("_")[-1]
+            self.misc_io_src_fn_id_e = stem.split("_")[-1]
+        t = "-".join(time.asctime().replace(":", "-").split(" "))
+        self.misc_sav_algn_fn = dirname / "aligned" / ("aligned_" + s + t + "{}.h5")
+        self.misc_io_cfg_fn = dirname / (s + "io_config_" + t + ".json")
+        self.misc_sav_trl_reg_cfg_fn = dirname / (
+            "trial_reg_" + s + "config_" + t + ".json"
+        )
+        self.misc_rev_best_mtch_fn = dirname / (
+            "trial_reg_" + s + "best_match_" + t + ".json"
+        )
+
+        self.misc_io_cfg = {
+            "Note 1": "cfg type == manual is good for generating a config template that can be used "
+            + "in a more complicated scenario",
+            "Note 2": "With 2D/3D tif input file formats, it is suitable for registering two "
+            + "individual images. If the file names are distinguished by an index on the "
+            + "end, it is also possible to register a series of images to one reference "
+            + "image. The option with 2D/3D h5 file formats is similar to 2D/3D tif option. "
+            + "The difference between them is that you need to specify dataset path for h5. "
+            + "In both cases, you can specify flat and dark images if the input data is raw. "
+            + "2Ds tif input file format option is for registering two sets of 3D images "
+            + "in 2D maner. You will need to specify one slice image from the reference image "
+            + "then have the slice images in a range in the second image compare to the "
+            + "reference slice image. It is supposed that there are two indices in the file "
+            + "names, one is for distinguishing the two image series, and another is for "
+            + "indexing slice images in each image series.",
+            "cfg type": self.misc_io_cfg_type,
+            "in tgt data": {
+                "ftype": self.misc_io_tgt_ftype,
+                "data fn": self.misc_io_tgt_fn,
+                "is data fn temp": self.misc_io_tgt_fn_is_temp,
+                "data fn id start": self.misc_io_tgt_fn_id_s,
+                "data fn id end": self.misc_io_tgt_fn_id_e,
+                "is raw": False,
+                "tif": {
+                    "2D": {"flat fn": None, "dark fn": None},
+                    "3D": {
+                        "flat fn": None,
+                        "dark fn": None,
+                        "flat sli idx": 0,
+                        "dark sli idx": -1,
+                        "slicing dim": 0,
+                        "fixed sli": 0,
+                    },
+                    "2Ds": {"flat fn": None, "dark fn": None},
+                },
+                "h5": {
+                    "2D": {
+                        "flat fn": (
+                            self.misc_io_tgt_fn
+                            if self.misc_io_tgt_ftype == "2D h5"
+                            else None
+                        ),
+                        "dark fn": (
+                            self.misc_io_tgt_fn
+                            if self.misc_io_tgt_ftype == "2D h5"
+                            else None
+                        ),
+                        "data path": "/img",
+                        "flat path": "/img_bkg",
+                        "dark path": "/img_dark",
+                    },
+                    "3D": {
+                        "flat fn": (
+                            self.misc_io_tgt_fn
+                            if self.misc_io_tgt_ftype == "3D h5"
+                            else None
+                        ),
+                        "dark fn": (
+                            self.misc_io_tgt_fn
+                            if self.misc_io_tgt_ftype == "3D h5"
+                            else None
+                        ),
+                        "data path": "/img",
+                        "flat path": "/img_bkg",
+                        "dark path": "/img_dark",
+                        "slicing dim": 0,
+                        "fixed sli": 0,
+                    },
+                },
+            },
+            "in src data": {
+                "ftype": self.misc_io_src_ftype,
+                "is raw": False,
+                "data fn": self.misc_io_src_fn_temp,
+                "is data fn temp": self.misc_io_src_fn_is_temp,
+                "data fn id start": self.misc_io_src_fn_id_s,
+                "data fn id end": self.misc_io_src_fn_id_e,
+                "tif": {
+                    "2D": {"flat fn": None, "dark fn": None},
+                    "3D": {
+                        "flat fn": None,
+                        "dark fn": None,
+                        "flat sli idx": 0,
+                        "dark sli idx": -1,
+                        "slicing dim": 0,
+                        "srch sli half width": 10,
+                    },
+                    "2Ds": {
+                        "flat fn": None,
+                        "dark fn": None,
+                        "sli start": self.misc_io_src_sli_id_s,
+                        "sli end": self.misc_io_src_sli_id_e,
+                        "srch sli half width": 10,
+                    },
+                },
+                "h5": {
+                    "2D": {
+                        "flat fn": (
+                            self.misc_io_src_fn
+                            if self.misc_io_tgt_ftype == "2D h5"
+                            else None
+                        ),
+                        "dark fn": (
+                            self.misc_io_src_fn
+                            if self.misc_io_tgt_ftype == "2D h5"
+                            else None
+                        ),
+                        "data path": "/img",
+                        "flat path": "/img_bkg",
+                        "dark path": "/img_dark",
+                    },
+                    "3D": {
+                        "flat fn": (
+                            self.misc_io_src_fn
+                            if self.misc_io_tgt_ftype == "3D h5"
+                            else None
+                        ),
+                        "dark fn": (
+                            self.misc_io_src_fn
+                            if self.misc_io_tgt_ftype == "3D h5"
+                            else None
+                        ),
+                        "data path": "/img",
+                        "flat path": "/img_bkg",
+                        "dark path": "/img_dark",
+                        "slicing dim": 0,
+                        "srch sli half width": 10,
+                    },
+                },
+            },
+            "out algn data": {"ftype": "h5", "out fn": self.misc_io_sav_algn_fn},
+            "cfg fn": {"cfg fn": self.misc_io_cfg_fn},
+        }
         try:
-            with open(self.misc_io_cfg_fn, 'w') as f:
-                json.dump(self.misc_io_cfg,
-                          f,
-                          indent=4,
-                          separators=(',', ': '))
+            with open(self.misc_io_cfg_fn, "w") as f:
+                json.dump(self.misc_io_cfg, f, indent=4, separators=(",", ": "))
             self.misc_io_cfg_set = True
         except:
             self.misc_io_cfg_set = False
-            print(
-                "Cannot save the configuration file to the specified location."
-            )
+            print("Cannot save the configuration file to the specified location.")
         self.misc_io_cfg_fn_set = False
         self.misc_dat_set = False
         self.boxes_logic()
 
     def AlgnCfgCfgFn_btn_clk(self, a):
         if len(a.files[0]) != 0:
             self.misc_io_cfg_fn = a.files[0]
             self.misc_io_cfg_fn_set = True
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.abspath(os.path.dirname(a.files[0]))},
+            # )
             update_json_content(
                 self.global_h.GUI_cfg_file,
-                {'cwd': os.path.abspath(os.path.dirname(a.files[0]))})
+                {"cwd": str(Path(a.files[0]).parent)},
+            )
         else:
             self.misc_io_cfg_fn = None
             self.misc_io_cfg_fn_set = False
         self.misc_io_cfg_set = False
         self.boxes_logic()
 
     def AlgnCfgCfmCfgFn_btn_clk(self, a):
         if self.misc_io_cfg_fn_set:
             try:
                 self.read_io_cfg(self.misc_io_cfg_fn)
-                self.misc_io_cfg['cfg type'] = 'cfg file'
-                self.hs[
-                    'SelCfgFn text'].value = "The Specified Config File is Read ..."
+                self.misc_io_cfg["cfg type"] = "cfg file"
+                self.hs["SelCfgFn text"].value = "The Specified Config File is Read ..."
                 self.misc_io_cfg_set = True
             except Exception as e:
                 print(e.__repr__())
-                self.hs[
-                    'SelCfgFn text'].value = "Cannot Read the Specified Config File. Please Specify a Valid Config File ..."
+                self.hs["SelCfgFn text"].value = (
+                    "Cannot Read the Specified Config File. Please Specify a Valid Config File ..."
+                )
                 self.misc_io_cfg_set = False
         else:
-            self.hs[
-                'SelCfgFn text'].value = 'No Config File is Specified. Please Specify a Config File ...'
+            self.hs["SelCfgFn text"].value = (
+                "No Config File is Specified. Please Specify a Config File ..."
+            )
             self.misc_io_cfg_set = False
         self.misc_dat_set = False
         self.boxes_logic()
 
     def AlgnROIPreAx0Shft_txt_chg(self, a):
         pass
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/gui_components.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/gui_components.py`

 * *Files 6% similar despite different names*

```diff
@@ -13,21 +13,23 @@
 from ipywidgets import widgets
 from fnmatch import fnmatch
 from json import JSONEncoder
 import tifffile, json
 from datetime import datetime
 import types
 
-from ..utils.tomo_recon_tools import TOMO_RECON_PARAM_DICT, rm_redundant
+from ..dicts.customized_struct_dict import TOMO_RECON_PARAM_DICT
+from ..utils.tomo_recon_tools import rm_redundant
 from ..dicts.config_dict import (
     IO_TOMO_CFG_DEFAULT,
     IO_XANES2D_CFG_DEFAULT,
     IO_XANES3D_CFG_DEFAULT,
 )
 from ..dicts import customized_struct_dict as dat_dict
+from ..utils.xanes_math import index_of
 
 
 class NumpyArrayEncoder(JSONEncoder):
 
     def default(self, obj):
         if isinstance(obj, np.integer):
             return int(obj)
@@ -82,24 +84,23 @@
         if "initialfile" in kwargs.keys():
             gui_h.initialfile = kwargs["initialfile"]
         else:
             gui_h.initialfile = "3D_trial_reg.h5"
         if "open_filetypes" in kwargs.keys():
             gui_h.open_filetypes = kwargs["open_filetypes"]
         else:
-            gui_h.open_filetypes = (("json files", "*.json"), ("text files",
-                                                               "*.txt"))
+            gui_h.open_filetypes = (("json files", "*.json"), ("text files", "*.txt"))
         if "save_filetypes" in kwargs.keys():
             gui_h.save_filetypes = kwargs["save_filetypes"]
         else:
             gui_h.save_filetypes = (("h5 files", ["*.h5", "*.hdf"]),)
         if "defaultextension" in kwargs.keys():
             gui_h.defaultextension = kwargs["defaultextension"]
         else:
-            gui_h.defaultextension = '.h5'
+            gui_h.defaultextension = ".h5"
         # Set on click behavior.
         gui_h.on_click(gui_h.select_files)
 
     @staticmethod
     def select_files(b):
         """Generate instance of tkinter.filedialog.
 
@@ -229,27 +230,24 @@
     global_h.cwd = new_cwd
     update_json_content(
         global_h.GUI_cfg_file,
         {"cwd": new_cwd},
     )
 
 
-def check_file_availability(raw_h5_dir,
-                            scan_id=None,
-                            signature="",
-                            return_idx=False):
+def check_file_availability(raw_h5_dir, scan_id=None, signature="", return_idx=False):
     if scan_id is None:
         # data_files = glob.glob(os.path.join(raw_h5_dir, signature.format("*")))
-        data_files = glob.glob(
-            str(Path(raw_h5_dir).joinpath(signature.format("*"))))
+        data_files = glob.glob(str(Path(raw_h5_dir).joinpath(signature.format("*"))))
     else:
         # data_files = glob.glob(
         #     os.path.join(raw_h5_dir, signature.format(scan_id)))
         data_files = glob.glob(
-            str(Path(raw_h5_dir).joinpath(Path(signature.format(scan_id)))))
+            str(Path(raw_h5_dir).joinpath(Path(signature.format(scan_id))))
+        )
 
     if len(data_files) == 0:
         return []
     else:
         if return_idx:
             ids = []
             for fn in sorted(data_files):
@@ -315,14 +313,29 @@
         hs.layout = layout
     elif wtype == "SelectMultiple":
         hs = widgets.SelectMultiple(**kwargs)
         hs.layout = layout
     return hs
 
 
+def def_dflt_eng_rgn(spec, eng_list):
+    wl_id = spec.argmax()
+    wl_eng = eng_list[wl_id]
+    wl_fit_s = eng_list[index_of(eng_list, wl_eng - 4)]
+    wl_fit_e = eng_list[index_of(eng_list, wl_eng + 4)]
+    edge_fit_s = eng_list[index_of(eng_list, wl_eng - 10)]
+    edge_fit_e = eng_list[index_of(eng_list, wl_eng - 2)]
+    edge_eng = eng_list[index_of(eng_list, wl_eng - 6)]
+    if wl_eng - eng_list[0] < 50:
+        fit_type = "wl"
+    else:
+        fit_type = "full"
+    return wl_eng, wl_fit_s, wl_fit_e, edge_fit_s, edge_fit_e, edge_eng, fit_type
+
+
 def determine_element(eng_list):
     eng_list = scale_eng_list(eng_list)
     if (eng_list.min() < 9.669e3) & (eng_list.max() > 9.669e3):
         return "Zn"
     elif (eng_list.min() < 8.995e3) & (eng_list.max() > 8.995e3):
         return "Cu"
     elif (eng_list.min() < 8.353e3) & (eng_list.max() > 8.353e3):
@@ -451,16 +464,15 @@
         return global_h.xanes_ana_fiji_windows
     elif "xanes_pp" in viewer_name:
         return global_h.xanes_ana_fiji_windows
 
 
 def fiji_viewer_off(global_h, gui_h=None, viewer_name="all"):
     try:
-        if (viewer_name == "all") and (global_h.WindowManager.getIDList()
-                                       is not None):
+        if (viewer_name == "all") and (global_h.WindowManager.getIDList() is not None):
             for ii in global_h.WindowManager.getIDList():
                 global_h.WindowManager.getImage(ii).close()
                 for jj in global_h.xanes2D_fiji_windows.keys():
                     global_h.xanes2D_fiji_windows[jj]["ip"] = None
                     global_h.xanes2D_fiji_windows[jj]["fiji_id"] = None
                 for jj in global_h.xanes3D_fiji_windows.keys():
                     global_h.xanes3D_fiji_windows[jj]["ip"] = None
@@ -470,536 +482,581 @@
                     global_h.tomo_fiji_windows[jj]["fiji_id"] = None
                 for jj in global_h.xanes_ana_fiji_windows.keys():
                     global_h.xanes_ana_fiji_windows[jj]["ip"] = None
                     global_h.xanes_ana_fiji_windows[jj]["fiji_id"] = None
         else:
             win = get_fiji_win_by_viewer_name(global_h, viewer_name)
             data_state, viewer_state = fiji_viewer_state(
-                global_h, gui_h, viewer_name=viewer_name)
+                global_h, gui_h, viewer_name=viewer_name
+            )
             if viewer_state:
                 win[viewer_name]["ip"].close()
                 win[viewer_name]["ip"] = None
                 win[viewer_name]["fiji_id"] = None
     except:
         print("something wrong during closing", viewer_name)
 
 
-def fiji_viewer_on(global_h,
-                   gui_h,
-                   viewer_name="xanes2D_raw_img_viewer",
-                   win_name=None,
-                   data=None,
-                   idx=0):
+def fiji_viewer_on(
+    global_h,
+    gui_h,
+    viewer_name="xanes2D_raw_img_viewer",
+    win_name=None,
+    data=None,
+    idx=0,
+):
     win = get_fiji_win_by_viewer_name(global_h, viewer_name)
-    data_state, viewer_state = fiji_viewer_state(global_h,
-                                                 gui_h,
-                                                 viewer_name=viewer_name)
+    data_state, viewer_state = fiji_viewer_state(
+        global_h, gui_h, viewer_name=viewer_name
+    )
     if viewer_name == "xanes3D_virtural_stack_preview_viewer":
         if not viewer_state:
             gui_h.fn0 = gui_h.xanes_recon_3D_tiff_temp.format(
-                gui_h.xanes_available_raw_ids[gui_h.xanes_fixed_scan_id -
-                                              gui_h.xanes_scan_id_s],
+                gui_h.xanes_available_raw_ids[
+                    gui_h.xanes_fixed_scan_id - gui_h.xanes_scan_id_s
+                ],
                 str(min(gui_h.xanes_available_sli_file_ids)).zfill(5),
             )
             args = {"directory": gui_h.fn0, "start": 1}
             global_h.ij.py.run_plugin(" Open VirtualStack", args)
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(
-                gui_h.xanes_fixed_sli_id -
-                gui_h.xanes_available_sli_file_ids[0])
+                gui_h.xanes_fixed_sli_id - gui_h.xanes_available_sli_file_ids[0]
+            )
     elif viewer_name == "xanes3D_mask_viewer":
         if not viewer_state:
             cnt = 0
             for ii in range(gui_h.xanes_roi[4], gui_h.xanes_roi[5] + 1):
                 fn = gui_h.xanes_recon_3D_tiff_temp.format(
-                    gui_h.xanes_available_raw_ids[gui_h.xanes_fixed_scan_id -
-                                                  gui_h.xanes_scan_id_s],
+                    gui_h.xanes_available_raw_ids[
+                        gui_h.xanes_fixed_scan_id - gui_h.xanes_scan_id_s
+                    ],
                     str(ii).zfill(5),
                 )
-                gui_h.xanes_img_roi[cnt, ...] = tifffile.imread(
-                    fn)[gui_h.xanes_roi[0]:gui_h.xanes_roi[1],
-                        gui_h.xanes_roi[2]:gui_h.xanes_roi[3], ]
+                gui_h.xanes_img_roi[cnt, ...] = tifffile.imread(fn)[
+                    gui_h.xanes_roi[0] : gui_h.xanes_roi[1],
+                    gui_h.xanes_roi[2] : gui_h.xanes_roi[3],
+                ]
                 cnt += 1
 
             global_h.ijui.show(global_h.ij.py.to_java(gui_h.xanes_img_roi))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(
-                gui_h.xanes_fixed_sli_id - gui_h.xanes_roi[4])
+                gui_h.xanes_fixed_sli_id - gui_h.xanes_roi[4]
+            )
         else:
             win["xanes3D_mask_viewer"]["ip"].setSlice(
-                gui_h.xanes_fixed_sli_id - gui_h.xanes_roi[4])
+                gui_h.xanes_fixed_sli_id - gui_h.xanes_roi[4]
+            )
     elif viewer_name == "xanes3D_review_viewer":
         if not viewer_state:
             global_h.ijui.show(
-                global_h.ij.py.to_java(gui_h.trial_reg -
-                                       gui_h.trial_reg_fixed))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                global_h.ij.py.to_java(gui_h.trial_reg - gui_h.trial_reg_fixed)
+            )
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes3D_review_manual_viewer":
         if not viewer_state:
             global_h.ijui.show(
-                global_h.ij.py.to_java(gui_h.xanes_review_aligned_img -
-                                       gui_h.trial_reg_fixed))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                global_h.ij.py.to_java(
+                    gui_h.xanes_review_aligned_img - gui_h.trial_reg_fixed
+                )
+            )
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes3D_analysis_viewer":
         if not data_state:
             with h5py.File(gui_h.xanes_save_trial_reg_filename, "r") as f:
                 if gui_h.hs["VisImgViewAlignOptn drpdn"].value == "x-y-E":
                     gui_h.xanes_aligned_data = 0
                     gui_h.xanes_aligned_data = f[
-                        "/registration_results/reg_results/registered_xanes3D"][:, gui_h.hs[
-                            "VisImgViewAlign4thDim sldr"].value, :, :]
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ][:, gui_h.hs["VisImgViewAlign4thDim sldr"].value, :, :]
                 elif gui_h.hs["VisImgViewAlignOptn drpdn"].value == "y-z-E":
                     gui_h.xanes_aligned_data = 0
                     gui_h.xanes_aligned_data = f[
-                        "/registration_results/reg_results/registered_xanes3D"][:, :, :, gui_h.hs[
-                            "VisImgViewAlign4thDim sldr"].value]
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ][:, :, :, gui_h.hs["VisImgViewAlign4thDim sldr"].value]
                 elif gui_h.hs["VisImgViewAlignOptn drpdn"].value == "z-x-E":
                     gui_h.xanes_aligned_data = 0
                     gui_h.xanes_aligned_data = f[
-                        "/registration_results/reg_results/registered_xanes3D"][:, :, gui_h.hs[
-                            "VisImgViewAlign4thDim sldr"].value, :]
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ][:, :, gui_h.hs["VisImgViewAlign4thDim sldr"].value, :]
                 elif gui_h.hs["VisImgViewAlignOptn drpdn"].value == "x-y-z":
                     gui_h.xanes_aligned_data = 0
                     gui_h.xanes_aligned_data = f[
-                        "/registration_results/reg_results/registered_xanes3D"][
-                            gui_h.hs["VisImgViewAlign4thDim sldr"].
-                            value, :, :, :]
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ][gui_h.hs["VisImgViewAlign4thDim sldr"].value, :, :, :]
         if not viewer_state:
-            global_h.ijui.show(global_h.ij.py.to_java(
-                gui_h.xanes_aligned_data))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ijui.show(global_h.ij.py.to_java(gui_h.xanes_aligned_data))
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(
-                gui_h.hs["VisImgViewAlignSli sldr"].value)
+                gui_h.hs["VisImgViewAlignSli sldr"].value
+            )
         else:
-            win[viewer_name]["ip"].setSlice(
-                gui_h.hs["VisImgViewAlignSli sldr"].value)
-            gui_h.hs[
-                "VisImgViewAlignEng text"].value = gui_h.xanes_fit_eng_list[
-                    gui_h.hs["VisImgViewAlignSli sldr"].value - 1]
+            win[viewer_name]["ip"].setSlice(gui_h.hs["VisImgViewAlignSli sldr"].value)
+            gui_h.hs["VisImgViewAlignEng text"].value = gui_h.xanes_fit_eng_list[
+                gui_h.hs["VisImgViewAlignSli sldr"].value - 1
+            ]
     elif viewer_name == "xanes3D_fit_jump_flt_viewer":
         if data_state:
             if not viewer_state:
-                global_h.ijui.show(global_h.ij.py.to_java(
-                    gui_h.edge_jump_mask))
+                global_h.ijui.show(global_h.ij.py.to_java(gui_h.edge_jump_mask))
                 global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
     elif viewer_name == "xanes3D_fit_thres_flt_viewer":
         if data_state:
             if not viewer_state:
-                global_h.ijui.show(
-                    global_h.ij.py.to_java(gui_h.fitted_edge_mask))
+                global_h.ijui.show(global_h.ij.py.to_java(gui_h.fitted_edge_mask))
                 global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
     elif viewer_name == "xanes3D_fit_maskit_viewer":
         if data_state:
             if not viewer_state:
                 global_h.ijui.show(
                     global_h.ij.py.to_java(
-                        gui_h.edge_jump_mask *
-                        gui_h.spec[int(gui_h.spec.shape[0] / 2)]))
+                        gui_h.edge_jump_mask * gui_h.spec[int(gui_h.spec.shape[0] / 2)]
+                    )
+                )
                 global_h.ij.py.run_macro(
-                    """run("Enhance Contrast", "saturated=0.35")""")
+                    """run("Enhance Contrast", "saturated=0.35")"""
+                )
     elif viewer_name == "xanes2D_raw_img_viewer":
         if not viewer_state:
             global_h.ijui.show(global_h.ij.py.to_java(gui_h.xanes_img))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes2D_mask_viewer":
         if not viewer_state:
             global_h.ijui.show(
-                global_h.ij.py.to_java(gui_h.xanes_img[
-                    gui_h.xanes_eng_id_s:gui_h.xanes_eng_id_e + 1,
-                    gui_h.xanes_reg_roi[0]:gui_h.xanes_reg_roi[1],
-                    gui_h.xanes_reg_roi[2]:gui_h.xanes_reg_roi[3], ]))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                global_h.ij.py.to_java(
+                    gui_h.xanes_img[
+                        gui_h.xanes_eng_id_s : gui_h.xanes_eng_id_e + 1,
+                        gui_h.xanes_reg_roi[0] : gui_h.xanes_reg_roi[1],
+                        gui_h.xanes_reg_roi[2] : gui_h.xanes_reg_roi[3],
+                    ]
+                )
+            )
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes2D_review_viewer":
         if not viewer_state:
             global_h.ijui.show(
-                global_h.ij.py.to_java(gui_h.xanes_review_aligned_img -
-                                       gui_h.xanes_review_fixed_img))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                global_h.ij.py.to_java(
+                    gui_h.xanes_review_aligned_img - gui_h.xanes_review_fixed_img
+                )
+            )
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes2D_analysis_viewer":
         if not viewer_state:
             global_h.ijui.show(global_h.ij.py.to_java(gui_h.xanes_img_roi))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes2D_fit_jump_flt_viewer":
         if data_state:
             if not viewer_state:
-                global_h.ijui.show(global_h.ij.py.to_java(
-                    gui_h.edge_jump_mask))
+                global_h.ijui.show(global_h.ij.py.to_java(gui_h.edge_jump_mask))
                 global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
     elif viewer_name == "xanes2D_fit_thres_flt_viewer":
         if data_state:
             if not viewer_state:
-                global_h.ijui.show(
-                    global_h.ij.py.to_java(gui_h.fitted_edge_mask))
+                global_h.ijui.show(global_h.ij.py.to_java(gui_h.fitted_edge_mask))
                 global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
     elif viewer_name == "xanes2D_fit_maskit_viewer":
         if data_state:
             if not viewer_state:
                 global_h.ijui.show(
                     global_h.ij.py.to_java(
-                        gui_h.edge_jump_mask *
-                        gui_h.spec[int(gui_h.spec.shape[0] / 2)]))
+                        gui_h.edge_jump_mask * gui_h.spec[int(gui_h.spec.shape[0] / 2)]
+                    )
+                )
                 global_h.ij.py.run_macro(
-                    """run("Enhance Contrast", "saturated=0.35")""")
+                    """run("Enhance Contrast", "saturated=0.35")"""
+                )
     elif viewer_name == "tomo_raw_img_viewer":
         if not viewer_state:
             global_h.ijui.show(global_h.ij.py.to_java(gui_h.raw_proj))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "tomo_0&180_viewer":
         if not viewer_state:
             global_h.ijui.show(global_h.ij.py.to_java(gui_h.raw_proj_0))
-            global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+            global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "tomo_cen_review_viewer":
         if not viewer_state:
             args = {"directory": gui_h.tomo_data_center_path, "start": 1}
             global_h.ij.py.run_plugin(" Open VirtualStack", args)
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "tomo_recon_viewer":
         if not viewer_state:
             # recon_dir = os.path.join(
             #     gui_h.tomo_recon_top_dir,
             #     "recon_fly_scan_id_{}".format(gui_h.tomo_scan_id[-1]),
             # )
             recon_dir = str(
                 Path(gui_h.tomo_recon_top_dir).joinpath(
-                    Path("recon_fly_scan_id_{}".format(
-                        gui_h.tomo_scan_id[-1]))))
+                    Path("recon_fly_scan_id_{}".format(gui_h.tomo_scan_id[-1]))
+                )
+            )
 
             args = {"directory": recon_dir, "start": 1}
             global_h.ij.py.run_plugin(" Open VirtualStack", args)
             global_h.WindowManager.getCurrentImage().setSlice(0)
     elif viewer_name == "xanes_pp_data_prev_viewer":
         if data_state:
             if not viewer_state:
                 global_h.ijui.show(
-                    global_h.ij.py.to_java(gui_h.ana_data[
-                        gui_h.hs["AnaSelVars sel"].value].compute()))
+                    global_h.ij.py.to_java(
+                        gui_h.ana_data[gui_h.hs["AnaSelVars sel"].value].compute()
+                    )
+                )
                 global_h.ij.py.run_macro(
-                    """run("Enhance Contrast", "saturated=0.35")""")
+                    """run("Enhance Contrast", "saturated=0.35")"""
+                )
     elif (viewer_name == "xanes_pp_mask_prev_viewer") and (data is not None):
         global_h.ijui.show(global_h.ij.py.to_java(data.compute()))
-        global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+        global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
     win[viewer_name]["ip"] = global_h.WindowManager.getCurrentImage()
     win[viewer_name]["fiji_id"] = global_h.WindowManager.getIDList()[-1]
     if win_name is not None:
         win[viewer_name]["ip"].setTitle(win_name)
     else:
         win[viewer_name]["ip"].setTitle(viewer_name)
 
 
-def fiji_viewer_state(global_h,
-                      gui_h,
-                      viewer_name="xanes3D_virtural_stack_preview_viewer"):
+def fiji_viewer_state(
+    global_h, gui_h, viewer_name="xanes3D_virtural_stack_preview_viewer"
+):
     if viewer_name == "xanes3D_virtural_stack_preview_viewer":
-        if ((not gui_h.xanes_recon_3D_tiff_temp)
-                | (not gui_h.xanes_fixed_scan_id)
-                | (not gui_h.xanes_available_sli_file_ids)):
+        if (
+            (not gui_h.xanes_recon_3D_tiff_temp)
+            | (not gui_h.xanes_fixed_scan_id)
+            | (not gui_h.xanes_available_sli_file_ids)
+        ):
             data_state = False
 
         else:
             data_state = True
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_mask_viewer":
         if gui_h.xanes_reg_mask is None:
             data_state = False
         elif gui_h.xanes_reg_mask.shape != (
-                gui_h.xanes_roi[1] - gui_h.xanes_roi[0],
-                gui_h.xanes_roi[3] - gui_h.xanes_roi[2],
+            gui_h.xanes_roi[1] - gui_h.xanes_roi[0],
+            gui_h.xanes_roi[3] - gui_h.xanes_roi[2],
         ):
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_review_viewer":
         if gui_h.xanes_img_roi is None:
             data_state = False
         elif gui_h.xanes_img_roi.shape != (
-                gui_h.xanes_roi[5] - gui_h.xanes_roi[4] + 1,
-                gui_h.xanes_roi[1] - gui_h.xanes_roi[0],
-                gui_h.xanes_roi[3] - gui_h.xanes_roi[2],
+            gui_h.xanes_roi[5] - gui_h.xanes_roi[4] + 1,
+            gui_h.xanes_roi[1] - gui_h.xanes_roi[0],
+            gui_h.xanes_roi[3] - gui_h.xanes_roi[2],
         ):
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_review_manual_viewer":
         if gui_h.xanes_review_aligned_img is None:
             data_state = False
         elif gui_h.xanes_review_aligned_img != (
-                gui_h.xanes_roi[1] - gui_h.xanes_roi[0],
-                gui_h.xanes_roi[3] - gui_h.xanes_roi[2],
+            gui_h.xanes_roi[1] - gui_h.xanes_roi[0],
+            gui_h.xanes_roi[3] - gui_h.xanes_roi[2],
         ):
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_analysis_viewer":
         if gui_h.xanes_aligned_data is None:
             data_state = False
         else:
             with h5py.File(gui_h.xanes_save_trial_reg_filename, "r") as f:
                 data_shape = f[
-                    "/registration_results/reg_results/registered_xanes3D"].shape
+                    "/registration_results/reg_results/registered_xanes3D"
+                ].shape
                 if gui_h.hs["VisImgViewAlignOptn drpdn"].value == "x-y-E":
                     if (
-                            data_shape[0],
-                            data_shape[2],
-                            data_shape[3],
+                        data_shape[0],
+                        data_shape[2],
+                        data_shape[3],
                     ) != gui_h.xanes_aligned_data.shape:
                         data_state = False
                     else:
                         data_state = True
                 elif gui_h.hs["VisImgViewAlignOptn drpdn"].value == "y-z-E":
                     if (
-                            data_shape[0],
-                            data_shape[1],
-                            data_shape[2],
+                        data_shape[0],
+                        data_shape[1],
+                        data_shape[2],
                     ) != gui_h.xanes_aligned_data.shape:
                         data_state = False
                     else:
                         data_state = True
                 elif gui_h.hs["VisImgViewAlignOptn drpdn"].value == "z-x-E":
                     if (
-                            data_shape[0],
-                            data_shape[1],
-                            data_shape[3],
+                        data_shape[0],
+                        data_shape[1],
+                        data_shape[3],
                     ) != gui_h.xanes_aligned_data.shape:
                         data_state = False
                     else:
                         data_state = True
                 elif gui_h.hs["VisImgViewAlignOptn drpdn"].value == "x-y-z":
                     if (
-                            data_shape[1],
-                            data_shape[2],
-                            data_shape[3],
+                        data_shape[1],
+                        data_shape[2],
+                        data_shape[3],
                     ) != gui_h.xanes_aligned_data.shape:
                         data_state = False
                     else:
                         data_state = True
                 else:
                     data_state = True
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_fit_jump_flt_viewer":
         if gui_h.edge_jump_mask is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_fit_thres_flt_viewer":
         if gui_h.fitted_edge_mask is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes3D_fit_maskit_viewer":
         if gui_h.fit_flt_prev_maskit:
             data_state = True
         else:
             data_state = False
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes3D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_raw_img_viewer":
         if gui_h.xanes_img is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_mask_viewer":
         if gui_h.xanes_img is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_review_viewer":
         if gui_h.xanes_review_aligned_img is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_analysis_viewer":
         if gui_h.xanes_img_roi is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_fit_jump_flt_viewer":
         if gui_h.edge_jump_mask is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_fit_thres_flt_viewer":
         if gui_h.fitted_edge_mask is None:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "xanes2D_fit_maskit_viewer":
         if gui_h.fit_flt_prev_maskit:
             data_state = True
         else:
             data_state = False
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes2D_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name in ["tomo_raw_img_viewer", "tomo_0&180_viewer"]:
         if gui_h.tomo_scan_id is None:
             data_state = False
         else:
             data_state = True
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.tomo_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.tomo_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     elif viewer_name == "tomo_cen_review_viewer":
         if gui_h.recon_finish & (gui_h.tomo_recon_type == "Trial Cent"):
             data_state = True
         else:
             data_state = False
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.tomo_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.tomo_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
-    elif (viewer_name
-          == "xanes_pp_data_prev_viewer") or (viewer_name
-                                              == "xanes_pp_mask_prev_viewer"):
+    elif (viewer_name == "xanes_pp_data_prev_viewer") or (
+        viewer_name == "xanes_pp_mask_prev_viewer"
+    ):
         if not gui_h.ana_data:
             data_state = False
         else:
             data_state = True
 
         if global_h.WindowManager.getIDList() is None:
             viewer_state = False
-        elif (not global_h.xanes_ana_fiji_windows[viewer_name]["fiji_id"]
-              in global_h.WindowManager.getIDList()):
+        elif (
+            not global_h.xanes_ana_fiji_windows[viewer_name]["fiji_id"]
+            in global_h.WindowManager.getIDList()
+        ):
             viewer_state = False
         else:
             viewer_state = True
     else:
         print("Unrecognized viewer name")
         data_state = False
         viewer_state = False
@@ -1069,71 +1126,79 @@
 
 
 def get_raw_img_info(fn, cfg, scan_type="tomo"):
     data_info = {}
     try:
         with h5py.File(fn, "r") as f:
             if scan_type == "tomo":
-                ang = f[cfg["structured_h5_reader"]["io_data_info"]
-                        ["item01_path"]][:]
+                ang = f[cfg["structured_h5_reader"]["io_data_info"]["item01_path"]][:]
                 idx = rm_redundant(ang)
                 data_info["theta_len"] = ang[idx].shape[0]
                 data_info["theta_min"] = np.min(ang[idx])
                 data_info["theta_max"] = np.max(ang[idx])
                 data_info["img_dim"] = list(
-                    f[cfg["structured_h5_reader"]["io_data_info"]
-                      ["item00_path"]].shape)
+                    f[cfg["structured_h5_reader"]["io_data_info"]["item00_path"]].shape
+                )
                 data_info["img_dim"][0] = data_info["theta_len"]
                 for ii in range(2, 7):
                     key = cfg["structured_h5_reader"]["io_data_info"][
-                        f"item{str(ii).zfill(2)}_path"]
+                        f"item{str(ii).zfill(2)}_path"
+                    ]
                     if key in f:
                         # data_info[os.path.basename(key)] = f[key][()]
                         data_info[Path(key).name] = f[key][()]
             elif scan_type == "xanes2D":
-                data_info["img_dim"] = f[cfg["structured_h5_reader"]
-                                         ["io_data_info"]["item00_path"]].shape
-                data_info["eng_len"] = f[cfg["structured_h5_reader"][
-                    "io_data_info"]["item01_path"]].shape[0]
+                data_info["img_dim"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item00_path"]
+                ].shape
+                data_info["eng_len"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item01_path"]
+                ].shape[0]
                 data_info["eng_min"] = np.min(
-                    f[cfg["structured_h5_reader"]["io_data_info"]
-                      ["item01_path"]])
+                    f[cfg["structured_h5_reader"]["io_data_info"]["item01_path"]]
+                )
                 data_info["eng_max"] = np.max(
-                    f[cfg["structured_h5_reader"]["io_data_info"]
-                      ["item01_path"]])
+                    f[cfg["structured_h5_reader"]["io_data_info"]["item01_path"]]
+                )
                 for ii in range(2, 6):
                     key = cfg["structured_h5_reader"]["io_data_info"][
-                        f"item{str(ii).zfill(2)}_path"]
+                        f"item{str(ii).zfill(2)}_path"
+                    ]
                     if key in f:
                         # data_info[os.path.basename(key)] = f[key][()]
                         data_info[Path(key).name] = f[key][()]
-                data_info["magnification"] = f[cfg["structured_h5_reader"][
-                    "io_data_info"]["item01_path"]][()]
-                data_info["pixel size"] = f[cfg["structured_h5_reader"]
-                                            ["io_data_info"]["item02_path"]][(
-                                            )]
-                data_info["note"] = f[cfg["structured_h5_reader"]
-                                      ["io_data_info"]["item04_path"]][()]
+                data_info["magnification"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item01_path"]
+                ][()]
+                data_info["pixel size"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item02_path"]
+                ][()]
+                data_info["note"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item04_path"]
+                ][()]
                 data_info["scan time"] = datetime.fromtimestamp(
-                    f[cfg["structured_h5_reader"]["io_data_info"]
-                      ["item05_path"]][()]).strftime("%m/%d/%Y, %H:%M:%S")
+                    f[cfg["structured_h5_reader"]["io_data_info"]["item05_path"]][()]
+                ).strftime("%m/%d/%Y, %H:%M:%S")
             elif scan_type == "xanes3D":
-                data_info["img_dim"] = f[cfg["structured_h5_reader"]
-                                         ["io_data_info"]["item00_path"]].shape
-                data_info["theta_len"] = f[cfg["structured_h5_reader"][
-                    "io_data_info"]["item01_path"]].shape[0]
+                data_info["img_dim"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item00_path"]
+                ].shape
+                data_info["theta_len"] = f[
+                    cfg["structured_h5_reader"]["io_data_info"]["item01_path"]
+                ].shape[0]
                 data_info["theta_min"] = np.min(
-                    f[cfg["structured_h5_reader"]["io_data_info"]
-                      ["item01_path"]])
+                    f[cfg["structured_h5_reader"]["io_data_info"]["item01_path"]]
+                )
                 data_info["theta_max"] = np.max(
-                    f[cfg["structured_h5_reader"]["io_data_info"]
-                      ["item01_path"]])
+                    f[cfg["structured_h5_reader"]["io_data_info"]["item01_path"]]
+                )
                 for ii in range(2, 7):
                     key = cfg["structured_h5_reader"]["io_data_info"][
-                        f"item{str(ii).zfill(2)}_path"]
+                        f"item{str(ii).zfill(2)}_path"
+                    ]
                     if key in f:
                         # data_info[os.path.basename(key)] = f[key][()]
                         data_info[Path(key).name] = f[key][()]
     except Exception as err:
         print(str(err))
         data_info = {}
     return data_info
@@ -1145,94 +1210,105 @@
         io_tomo_cfg = json.load(f)
         set_io_config(main_gui_h.io_config_gui, io_tomo_cfg, cfg_type="tomo")
     except:
         set_io_config(main_gui_h.io_config_gui, IO_TOMO_CFG_DEFAULT)
     try:
         f = open(main_gui_h.io_data_struc_xanes2D_cfg_file, "r")
         io_xanes2D_cfg = json.load(f)
-        set_io_config(main_gui_h.io_config_gui,
-                      io_xanes2D_cfg,
-                      cfg_type="xanes2D")
+        set_io_config(main_gui_h.io_config_gui, io_xanes2D_cfg, cfg_type="xanes2D")
     except:
-        set_io_config(main_gui_h.io_config_gui,
-                      IO_XANES2D_CFG_DEFAULT,
-                      cfg_type="xanes2D")
+        set_io_config(
+            main_gui_h.io_config_gui, IO_XANES2D_CFG_DEFAULT, cfg_type="xanes2D"
+        )
     try:
         f = open(main_gui_h.io_data_struc_xanes3D_cfg_file, "r")
         io_xanes3D_cfg = json.load(f)
-        set_io_config(main_gui_h.io_config_gui,
-                      io_xanes3D_cfg,
-                      cfg_type="xanes3D")
+        set_io_config(main_gui_h.io_config_gui, io_xanes3D_cfg, cfg_type="xanes3D")
     except:
-        set_io_config(main_gui_h.io_config_gui,
-                      IO_XANES3D_CFG_DEFAULT,
-                      cfg_type="xanes3D")
+        set_io_config(
+            main_gui_h.io_config_gui, IO_XANES3D_CFG_DEFAULT, cfg_type="xanes3D"
+        )
 
 
 def read_config_from_reg_file(gui_h, dtype="2D_XANES"):
     if dtype == "2D_XANES":
         pass
     elif dtype == "3D_XANES":
         with h5py.File(gui_h.xanes_save_trial_reg_filename, "r") as f:
             gui_h.xanes_recon_3D_tiff_temp = f[
-                "/trial_registration/data_directory_info/recon_path_template"][
-                    ()]
+                "/trial_registration/data_directory_info/recon_path_template"
+            ][()]
             gui_h.xanes_raw_3D_h5_top_dir = f[
-                "/trial_registration/data_directory_info/raw_h5_top_dir"][()]
+                "/trial_registration/data_directory_info/raw_h5_top_dir"
+            ][()]
             gui_h.xanes_recon_3D_top_dir = f[
-                "/trial_registration/data_directory_info/recon_top_dir"][()]
+                "/trial_registration/data_directory_info/recon_top_dir"
+            ][()]
             gui_h.xanes_fixed_scan_id = int(
-                f["/trial_registration/trial_reg_parameters/fixed_scan_id"][(
-                )])
+                f["/trial_registration/trial_reg_parameters/fixed_scan_id"][()]
+            )
             gui_h.xanes_fixed_sli_id = int(
-                f["/trial_registration/trial_reg_parameters/fixed_slice"][()])
-            gui_h.xanes_roi = f[
-                "/trial_registration/trial_reg_parameters/slice_roi"][:].tolist(
-                )
+                f["/trial_registration/trial_reg_parameters/fixed_slice"][()]
+            )
+            gui_h.xanes_roi = f["/trial_registration/trial_reg_parameters/slice_roi"][
+                :
+            ].tolist()
             gui_h.xanes_scan_id_s = int(
-                f["/trial_registration/trial_reg_parameters/scan_ids"][0])
+                f["/trial_registration/trial_reg_parameters/scan_ids"][0]
+            )
             gui_h.xanes_scan_id_e = int(
-                f["/trial_registration/trial_reg_parameters/scan_ids"][-1])
-            gui_h.xanes_reg_sli_search_half_width = int(f[
-                "/trial_registration/trial_reg_parameters/sli_search_half_range"]
-                                                        [()])
+                f["/trial_registration/trial_reg_parameters/scan_ids"][-1]
+            )
+            gui_h.xanes_reg_sli_search_half_width = int(
+                f["/trial_registration/trial_reg_parameters/sli_search_half_range"][()]
+            )
             gui_h.xanes_reg_method = f[
-                "/trial_registration/trial_reg_parameters/reg_method"][()]
+                "/trial_registration/trial_reg_parameters/reg_method"
+            ][()]
             gui_h.xanes_reg_ref_mode = f[
-                "/trial_registration/trial_reg_parameters/reg_ref_mode"][()]
+                "/trial_registration/trial_reg_parameters/reg_ref_mode"
+            ][()]
             gui_h.xanes_reg_use_smooth_img = bool(
-                f["/trial_registration/trial_reg_parameters/use_smooth_img"][(
-                )])
+                f["/trial_registration/trial_reg_parameters/use_smooth_img"][()]
+            )
             gui_h.xanes_reg_smooth_sigma = int(
-                f["/trial_registration/trial_reg_parameters/img_smooth_sigma"][
-                    ()])
+                f["/trial_registration/trial_reg_parameters/img_smooth_sigma"][()]
+            )
             gui_h.xanes_reg_use_chunk = bool(
-                f["/trial_registration/trial_reg_parameters/use_chunk"][()])
+                f["/trial_registration/trial_reg_parameters/use_chunk"][()]
+            )
             gui_h.xanes_reg_chunk_sz = int(
-                f["/trial_registration/trial_reg_parameters/chunk_sz"][()])
+                f["/trial_registration/trial_reg_parameters/chunk_sz"][()]
+            )
             gui_h.xanes_reg_use_mask = bool(
-                f["/trial_registration/trial_reg_parameters/use_mask"][()])
+                f["/trial_registration/trial_reg_parameters/use_mask"][()]
+            )
             gui_h.xanes_alignment_pairs = f[
-                "/trial_registration/trial_reg_parameters/alignment_pairs"][:]
+                "/trial_registration/trial_reg_parameters/alignment_pairs"
+            ][:]
             gui_h.trial_reg = f[
-                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".
-                format("000")][:]
+                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                    "000"
+                )
+            ][:]
             gui_h.trial_reg_fixed = f[
-                "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".
-                format("000")][:]
-            gui_h.xanes_review_aligned_img = np.ndarray(
-                gui_h.trial_reg[0].shape)
+                "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".format(
+                    "000"
+                )
+            ][:]
+            gui_h.xanes_review_aligned_img = np.ndarray(gui_h.trial_reg[0].shape)
 
 
 def restart(gui_h, dtype="2D_XANES"):
     if dtype == "2D_XANES":
         gui_h.hs["SelRawH5Path text"].value = "Choose raw h5 directory ..."
         gui_h.hs["SelSaveTrial text"].value = "Save trial registration as ..."
-        gui_h.hs[
-            "CfmFile&Path text"].value = "Save trial registration, or go directly review registration ..."
+        gui_h.hs["CfmFile&Path text"].value = (
+            "Save trial registration, or go directly review registration ..."
+        )
         gui_h.hs["SelRawH5Path btn"].description = "XANES2D File"
         gui_h.hs["SelSaveTrial btn"].description = "Save Reg File"
         gui_h.hs["SelRawH5Path btn"].style.button_color = "orange"
         gui_h.hs["SelSaveTrial btn"].style.button_color = "orange"
         gui_h.hs["FijiRawImgPrev chbx"].value = False
         gui_h.hs["FijiMaskViewer chbx"].value = False
         gui_h.hs["FijiEngId sldr"].value = 0
@@ -1325,55 +1401,32 @@
         gui_h.xanes_fit_gui_h.fit_flt_prev_configed = False
         gui_h.xanes_fit_gui_h.fit_flt_prev_maskit = False
         gui_h.xanes_fit_gui_h.hs["FitItemConfigEdgeJumpThres sldr"].value = 1
         gui_h.xanes_fit_gui_h.hs["FitItemConfigEdgeOfstThres sldr"].value = 1
         gui_h.xanes_fit_gui_h.hs["FitItemConfigFitPrvw chbx"].value = 0
 
         gui_h.global_h.xanes2D_fiji_windows = {
-            "xanes2D_raw_img_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_mask_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_review_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_analysis_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "analysis_viewer_z_plot_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_fit_jump_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_fit_thres_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_fit_maskit_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
+            "xanes2D_raw_img_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_mask_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_review_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_analysis_viewer": {"ip": None, "fiji_id": None},
+            "analysis_viewer_z_plot_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_fit_jump_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_fit_thres_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_fit_maskit_viewer": {"ip": None, "fiji_id": None},
         }
     elif dtype == "3D_XANES":
         gui_h.hs["FijiRawImgPrev chbx"].value = False
         gui_h.hs["FijiMaskViewer chbx"].value = False
         gui_h.hs["SelRawH5Path text"].value = "Choose raw h5 directory ..."
         gui_h.hs["SelReconPath text"].value = "Choose recon top directory ..."
         gui_h.hs["SelSavTrial box"].value = "Save trial registration as ..."
-        gui_h.hs[
-            "SelFile&PathCfm text"].value = "Save trial registration, or go directly review registration ..."
+        gui_h.hs["SelFile&PathCfm text"].value = (
+            "Save trial registration, or go directly review registration ..."
+        )
         gui_h.hs["SelRawH5Path btn"].description = "Raw h5 Dir"
         gui_h.hs["SelReconPath btn"].description = "Recon Top Dir"
         gui_h.hs["SelSavTrial btn"].description = "Save Reg File"
         gui_h.hs["SelRawH5Path btn"].style.button_color = "orange"
         gui_h.hs["SelReconPath btn"].style.button_color = "orange"
         gui_h.hs["SelSavTrial btn"].style.button_color = "orange"
         fiji_viewer_off(gui_h.global_h, gui_h, viewer_name="all")
@@ -1459,58 +1512,33 @@
         gui_h.xanes_fit_gui_h.fit_flt_prev_configed = False
         gui_h.xanes_fit_gui_h.fit_flt_prev_maskit = False
         gui_h.xanes_fit_gui_h.hs["FitItemConfigEdgeJumpThres sldr"].value = 1
         gui_h.xanes_fit_gui_h.hs["FitItemConfigEdgeOfstThres sldr"].value = 1
         gui_h.xanes_fit_gui_h.hs["FitItemConfigFitPrvw chbx"].value = 0
 
         gui_h.global_h.xanes3D_fiji_windows = {
-            "xanes3D_virtural_stack_preview_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_mask_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_review_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_review_manual_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_analysis_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "analysis_viewer_z_plot_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_fit_jump_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_fit_thres_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_fit_maskit_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
+            "xanes3D_virtural_stack_preview_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_mask_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_review_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_review_manual_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_analysis_viewer": {"ip": None, "fiji_id": None},
+            "analysis_viewer_z_plot_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_fit_jump_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_fit_thres_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_fit_maskit_viewer": {"ip": None, "fiji_id": None},
         }
     elif dtype == "TOMO":
         gui_h.hs["SelRawH5TopDir text"].value = "Choose raw h5 top dir ..."
-        gui_h.hs[
-            "SelSavReconDir text"].value = "Select top directory where recon subdirectories are saved..."
+        gui_h.hs["SelSavReconDir text"].value = (
+            "Select top directory where recon subdirectories are saved..."
+        )
         gui_h.hs["SelSavDebugDir text"].value = "Debug is disabled..."
-        gui_h.hs[
-            "SelFile&PathCfm text"].value = "After setting directories, confirm to proceed ..."
+        gui_h.hs["SelFile&PathCfm text"].value = (
+            "After setting directories, confirm to proceed ..."
+        )
         gui_h.hs["SelRawH5TopDir btn"].description = "Raw Top Dir"
         gui_h.hs["SelSavReconDir btn"].description = "Save Rec File"
         gui_h.hs["SelSavDebugDir btn"].description = "Save Debug Dir"
         gui_h.hs["SavDebug chbx"].value = False
         gui_h.hs["SelRawH5TopDir btn"].style.button_color = "orange"
         gui_h.hs["SelSavReconDir btn"].style.button_color = "orange"
         gui_h.hs["SelSavDebugDir btn"].style.button_color = "orange"
@@ -1616,131 +1644,173 @@
 
 def save_io_config(gui_h):
     io_data_structure_tomo = {}
     io_data_structure_tomo["use_h5_reader"] = gui_h.hs["IOOptnH5 chbx"].value
     io_data_structure_tomo["structured_h5_reader"] = {}
     io_data_structure_tomo["structured_h5_reader"]["io_data_structure"] = {}
     io_data_structure_tomo["structured_h5_reader"]["io_data_info"] = {}
+    io_data_structure_tomo["structured_h5_reader"]["io_data_structure"]["data_path"] = (
+        gui_h.hs["IOTomoConfigDataImg text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_structure"]["flat_path"] = (
+        gui_h.hs["IOTomoConfigDataFlat text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_structure"]["dark_path"] = (
+        gui_h.hs["IOTomoConfigDataDark text"].value
+    )
     io_data_structure_tomo["structured_h5_reader"]["io_data_structure"][
-        "data_path"] = gui_h.hs["IOTomoConfigDataImg text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_structure"][
-        "flat_path"] = gui_h.hs["IOTomoConfigDataFlat text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_structure"][
-        "dark_path"] = gui_h.hs["IOTomoConfigDataDark text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_structure"][
-        "theta_path"] = gui_h.hs["IOTomoConfigDataTheta text"].value
+        "theta_path"
+    ] = gui_h.hs["IOTomoConfigDataTheta text"].value
+
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item00_path"] = (
+        gui_h.hs["IOTomoConfigInfo0 text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item01_path"] = (
+        gui_h.hs["IOTomoConfigInfo1 text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item02_path"] = (
+        gui_h.hs["IOTomoConfigInfo2 text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item03_path"] = (
+        gui_h.hs["IOTomoConfigInfo3 text"].value
+    )
 
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item00_path"] = gui_h.hs["IOTomoConfigInfo0 text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item01_path"] = gui_h.hs["IOTomoConfigInfo1 text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item02_path"] = gui_h.hs["IOTomoConfigInfo2 text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item03_path"] = gui_h.hs["IOTomoConfigInfo3 text"].value
-
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item04_path"] = gui_h.hs["IOTomoConfigInfo4 text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item05_path"] = gui_h.hs["IOTomoConfigInfo5 text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item06_path"] = gui_h.hs["IOTomoConfigInfo6 text"].value
-    io_data_structure_tomo["structured_h5_reader"]["io_data_info"][
-        "item07_path"] = gui_h.hs["IOTomoConfigInfo7 text"].value
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item04_path"] = (
+        gui_h.hs["IOTomoConfigInfo4 text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item05_path"] = (
+        gui_h.hs["IOTomoConfigInfo5 text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item06_path"] = (
+        gui_h.hs["IOTomoConfigInfo6 text"].value
+    )
+    io_data_structure_tomo["structured_h5_reader"]["io_data_info"]["item07_path"] = (
+        gui_h.hs["IOTomoConfigInfo7 text"].value
+    )
 
     io_data_structure_tomo["tomo_raw_fn_template"] = gui_h.hs[
-        "FnTomoDefRawPatn text"].value
+        "FnTomoDefRawPatn text"
+    ].value
 
     io_data_structure_tomo["customized_reader"] = {}
     io_data_structure_tomo["customized_reader"]["user_tomo_reader"] = gui_h.hs[
-        "IOSpecTomoRdr text"].value
+        "IOSpecTomoRdr text"
+    ].value
 
     io_data_structure_xanes2D = {}
-    io_data_structure_xanes2D["use_h5_reader"] = gui_h.hs[
-        "IOOptnH5 chbx"].value
+    io_data_structure_xanes2D["use_h5_reader"] = gui_h.hs["IOOptnH5 chbx"].value
     io_data_structure_xanes2D["structured_h5_reader"] = {}
     io_data_structure_xanes2D["structured_h5_reader"]["io_data_structure"] = {}
     io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"] = {}
     io_data_structure_xanes2D["structured_h5_reader"]["io_data_structure"][
-        "data_path"] = gui_h.hs["IOXANES2DConfigDataImg text"].value
+        "data_path"
+    ] = gui_h.hs["IOXANES2DConfigDataImg text"].value
     io_data_structure_xanes2D["structured_h5_reader"]["io_data_structure"][
-        "flat_path"] = gui_h.hs["IOXANES2DConfigDataFlat text"].value
+        "flat_path"
+    ] = gui_h.hs["IOXANES2DConfigDataFlat text"].value
     io_data_structure_xanes2D["structured_h5_reader"]["io_data_structure"][
-        "dark_path"] = gui_h.hs["IOXANES2DConfigDataDark text"].value
+        "dark_path"
+    ] = gui_h.hs["IOXANES2DConfigDataDark text"].value
     io_data_structure_xanes2D["structured_h5_reader"]["io_data_structure"][
-        "eng_path"] = gui_h.hs["IOXANES2DConfigDataEng text"].value
+        "eng_path"
+    ] = gui_h.hs["IOXANES2DConfigDataEng text"].value
 
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item00_path"] = gui_h.hs["IOXANES2DConfigInfo0 text"].value
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item01_path"] = gui_h.hs["IOXANES2DConfigInfo1 text"].value
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item02_path"] = gui_h.hs["IOXANES2DConfigInfo2 text"].value
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item03_path"] = gui_h.hs["IOXANES2DConfigInfo3 text"].value
-
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item04_path"] = gui_h.hs["IOXANES2DConfigInfo4 text"].value
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item05_path"] = gui_h.hs["IOXANES2DConfigInfo5 text"].value
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item06_path"] = gui_h.hs["IOXANES2DConfigInfo6 text"].value
-    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"][
-        "item07_path"] = gui_h.hs["IOXANES2DConfigInfo7 text"].value
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item00_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo0 text"].value
+    )
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item01_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo1 text"].value
+    )
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item02_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo2 text"].value
+    )
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item03_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo3 text"].value
+    )
+
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item04_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo4 text"].value
+    )
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item05_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo5 text"].value
+    )
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item06_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo6 text"].value
+    )
+    io_data_structure_xanes2D["structured_h5_reader"]["io_data_info"]["item07_path"] = (
+        gui_h.hs["IOXANES2DConfigInfo7 text"].value
+    )
 
     io_data_structure_xanes2D["xanes2D_raw_fn_template"] = gui_h.hs[
-        "FnXANES2DDefRawPatn text"].value
+        "FnXANES2DDefRawPatn text"
+    ].value
 
     io_data_structure_xanes2D["customized_reader"] = {}
-    io_data_structure_xanes2D["customized_reader"][
-        "user_xanes2D_reader"] = gui_h.hs["IOSpecXANES2DRdr text"].value
+    io_data_structure_xanes2D["customized_reader"]["user_xanes2D_reader"] = gui_h.hs[
+        "IOSpecXANES2DRdr text"
+    ].value
 
     io_data_structure_xanes3D = {}
-    io_data_structure_xanes3D["use_h5_reader"] = gui_h.hs[
-        "IOOptnH5 chbx"].value
+    io_data_structure_xanes3D["use_h5_reader"] = gui_h.hs["IOOptnH5 chbx"].value
     io_data_structure_xanes3D["structured_h5_reader"] = {}
     io_data_structure_xanes3D["structured_h5_reader"]["io_data_structure"] = {}
     io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"] = {}
     io_data_structure_xanes3D["structured_h5_reader"]["io_data_structure"][
-        "data_path"] = gui_h.hs["IOXANES3DConfigDataImg text"].value
+        "data_path"
+    ] = gui_h.hs["IOXANES3DConfigDataImg text"].value
     io_data_structure_xanes3D["structured_h5_reader"]["io_data_structure"][
-        "flat_path"] = gui_h.hs["IOXANES3DConfigDataFlat text"].value
+        "flat_path"
+    ] = gui_h.hs["IOXANES3DConfigDataFlat text"].value
     io_data_structure_xanes3D["structured_h5_reader"]["io_data_structure"][
-        "dark_path"] = gui_h.hs["IOXANES3DConfigDataDark text"].value
+        "dark_path"
+    ] = gui_h.hs["IOXANES3DConfigDataDark text"].value
     io_data_structure_xanes3D["structured_h5_reader"]["io_data_structure"][
-        "eng_path"] = gui_h.hs["IOXANES3DConfigDataEng text"].value
+        "eng_path"
+    ] = gui_h.hs["IOXANES3DConfigDataEng text"].value
+
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item00_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo0 text"].value
+    )
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item01_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo1 text"].value
+    )
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item02_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo2 text"].value
+    )
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item03_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo3 text"].value
+    )
 
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item00_path"] = gui_h.hs["IOXANES3DConfigInfo0 text"].value
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item01_path"] = gui_h.hs["IOXANES3DConfigInfo1 text"].value
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item02_path"] = gui_h.hs["IOXANES3DConfigInfo2 text"].value
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item03_path"] = gui_h.hs["IOXANES3DConfigInfo3 text"].value
-
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item04_path"] = gui_h.hs["IOXANES3DConfigInfo4 text"].value
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item05_path"] = gui_h.hs["IOXANES3DConfigInfo5 text"].value
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item06_path"] = gui_h.hs["IOXANES3DConfigInfo6 text"].value
-    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"][
-        "item07_path"] = gui_h.hs["IOXANES3DConfigInfo7 text"].value
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item04_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo4 text"].value
+    )
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item05_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo5 text"].value
+    )
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item06_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo6 text"].value
+    )
+    io_data_structure_xanes3D["structured_h5_reader"]["io_data_info"]["item07_path"] = (
+        gui_h.hs["IOXANES3DConfigInfo7 text"].value
+    )
 
     io_data_structure_xanes3D["tomo_raw_fn_template"] = gui_h.hs[
-        "FnXANES3DDefRawPatn text"].value
+        "FnXANES3DDefRawPatn text"
+    ].value
     io_data_structure_xanes3D["xanes3D_recon_dir_template"] = gui_h.hs[
-        "FnXANES3DDefReconDirPatn text"].value
+        "FnXANES3DDefReconDirPatn text"
+    ].value
     io_data_structure_xanes3D["xanes3D_recon_fn_template"] = gui_h.hs[
-        "FnXANES3DDefReconFnPatn text"].value
+        "FnXANES3DDefReconFnPatn text"
+    ].value
 
     io_data_structure_xanes3D["customized_reader"] = {}
-    io_data_structure_xanes3D["customized_reader"][
-        "user_xanes3D_reader"] = gui_h.hs["IOSpecXANES3DRdr text"].value
+    io_data_structure_xanes3D["customized_reader"]["user_xanes3D_reader"] = gui_h.hs[
+        "IOSpecXANES3DRdr text"
+    ].value
 
     with open(gui_h.global_h.io_data_struc_tomo_cfg_file, "w") as f:
         json.dump(io_data_structure_tomo, f)
     with open(gui_h.global_h.io_data_struc_xanes2D_cfg_file, "w") as f:
         json.dump(io_data_structure_xanes2D, f)
     with open(gui_h.global_h.io_data_struc_xanes3D_cfg_file, "w") as f:
         json.dump(io_data_structure_xanes3D, f)
@@ -1751,115 +1821,153 @@
     if eng_list.max() < 100:
         eng_list *= 1000
     return eng_list
 
 
 def set_io_config(gui_h, cfg_dict, cfg_type="tomo"):
     if cfg_type == "tomo":
-        gui_h.hs["IOTomoConfigDataImg text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["data_path"]
-        gui_h.hs["IOTomoConfigDataFlat text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["flat_path"]
-        gui_h.hs["IOTomoConfigDataDark text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["dark_path"]
-        gui_h.hs["IOTomoConfigDataTheta text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["theta_path"]
-
-        gui_h.hs["IOTomoConfigInfo0 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item00_path"]
-        gui_h.hs["IOTomoConfigInfo1 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item01_path"]
-        gui_h.hs["IOTomoConfigInfo2 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item02_path"]
-        gui_h.hs["IOTomoConfigInfo3 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item03_path"]
-
-        gui_h.hs["IOTomoConfigInfo4 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item04_path"]
-        gui_h.hs["IOTomoConfigInfo5 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item05_path"]
-        gui_h.hs["IOTomoConfigInfo6 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item06_path"]
-        gui_h.hs["IOTomoConfigInfo7 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item07_path"]
+        gui_h.hs["IOTomoConfigDataImg text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_structure"
+        ]["data_path"]
+        gui_h.hs["IOTomoConfigDataFlat text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_structure"
+        ]["flat_path"]
+        gui_h.hs["IOTomoConfigDataDark text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_structure"
+        ]["dark_path"]
+        gui_h.hs["IOTomoConfigDataTheta text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_structure"
+        ]["theta_path"]
+
+        gui_h.hs["IOTomoConfigInfo0 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item00_path"]
+        gui_h.hs["IOTomoConfigInfo1 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item01_path"]
+        gui_h.hs["IOTomoConfigInfo2 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item02_path"]
+        gui_h.hs["IOTomoConfigInfo3 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item03_path"]
+
+        gui_h.hs["IOTomoConfigInfo4 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item04_path"]
+        gui_h.hs["IOTomoConfigInfo5 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item05_path"]
+        gui_h.hs["IOTomoConfigInfo6 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item06_path"]
+        gui_h.hs["IOTomoConfigInfo7 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item07_path"]
 
-        gui_h.hs["FnTomoDefRawPatn text"].value = cfg_dict[
-            "tomo_raw_fn_template"]
+        gui_h.hs["FnTomoDefRawPatn text"].value = cfg_dict["tomo_raw_fn_template"]
 
         gui_h.hs["IOSpecTomoRdr text"].value = cfg_dict["customized_reader"][
-            "user_tomo_reader"]
+            "user_tomo_reader"
+        ]
     elif cfg_type == "xanes2D":
         gui_h.hs["IOXANES2DConfigDataImg text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["data_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["data_path"]
         gui_h.hs["IOXANES2DConfigDataFlat text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["flat_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["flat_path"]
         gui_h.hs["IOXANES2DConfigDataDark text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["dark_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["dark_path"]
         gui_h.hs["IOXANES2DConfigDataEng text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["eng_path"]
-
-        gui_h.hs["IOXANES2DConfigInfo0 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item00_path"]
-        gui_h.hs["IOXANES2DConfigInfo1 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item01_path"]
-        gui_h.hs["IOXANES2DConfigInfo2 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item02_path"]
-        gui_h.hs["IOXANES2DConfigInfo3 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item03_path"]
-
-        gui_h.hs["IOXANES2DConfigInfo4 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item04_path"]
-        gui_h.hs["IOXANES2DConfigInfo5 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item05_path"]
-        gui_h.hs["IOXANES2DConfigInfo6 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item06_path"]
-        gui_h.hs["IOXANES2DConfigInfo7 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item07_path"]
-
-        gui_h.hs["FnXANES2DDefRawPatn text"].value = cfg_dict[
-            "xanes2D_raw_fn_template"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["eng_path"]
 
-        gui_h.hs["IOSpecXANES2DRdr text"].value = cfg_dict[
-            "customized_reader"]["user_xanes2D_reader"]
+        gui_h.hs["IOXANES2DConfigInfo0 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item00_path"]
+        gui_h.hs["IOXANES2DConfigInfo1 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item01_path"]
+        gui_h.hs["IOXANES2DConfigInfo2 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item02_path"]
+        gui_h.hs["IOXANES2DConfigInfo3 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item03_path"]
+
+        gui_h.hs["IOXANES2DConfigInfo4 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item04_path"]
+        gui_h.hs["IOXANES2DConfigInfo5 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item05_path"]
+        gui_h.hs["IOXANES2DConfigInfo6 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item06_path"]
+        gui_h.hs["IOXANES2DConfigInfo7 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item07_path"]
+
+        gui_h.hs["FnXANES2DDefRawPatn text"].value = cfg_dict["xanes2D_raw_fn_template"]
+
+        gui_h.hs["IOSpecXANES2DRdr text"].value = cfg_dict["customized_reader"][
+            "user_xanes2D_reader"
+        ]
     elif cfg_type == "xanes3D":
         gui_h.hs["IOXANES3DConfigDataImg text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["data_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["data_path"]
         gui_h.hs["IOXANES3DConfigDataFlat text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["flat_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["flat_path"]
         gui_h.hs["IOXANES3DConfigDataDark text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["dark_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["dark_path"]
         gui_h.hs["IOXANES3DConfigDataEng text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_structure"]["eng_path"]
+            "structured_h5_reader"
+        ]["io_data_structure"]["eng_path"]
 
-        gui_h.hs["IOXANES3DConfigInfo0 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item00_path"]
-        gui_h.hs["IOXANES3DConfigInfo1 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item01_path"]
-        gui_h.hs["IOXANES3DConfigInfo2 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item02_path"]
-        gui_h.hs["IOXANES3DConfigInfo3 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item03_path"]
-
-        gui_h.hs["IOXANES3DConfigInfo4 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item04_path"]
-        gui_h.hs["IOXANES3DConfigInfo5 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item05_path"]
-        gui_h.hs["IOXANES3DConfigInfo6 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item06_path"]
-        gui_h.hs["IOXANES3DConfigInfo7 text"].value = cfg_dict[
-            "structured_h5_reader"]["io_data_info"]["item07_path"]
+        gui_h.hs["IOXANES3DConfigInfo0 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item00_path"]
+        gui_h.hs["IOXANES3DConfigInfo1 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item01_path"]
+        gui_h.hs["IOXANES3DConfigInfo2 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item02_path"]
+        gui_h.hs["IOXANES3DConfigInfo3 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item03_path"]
+
+        gui_h.hs["IOXANES3DConfigInfo4 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item04_path"]
+        gui_h.hs["IOXANES3DConfigInfo5 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item05_path"]
+        gui_h.hs["IOXANES3DConfigInfo6 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item06_path"]
+        gui_h.hs["IOXANES3DConfigInfo7 text"].value = cfg_dict["structured_h5_reader"][
+            "io_data_info"
+        ]["item07_path"]
 
-        gui_h.hs["FnXANES3DDefRawPatn text"].value = cfg_dict[
-            "tomo_raw_fn_template"]
+        gui_h.hs["FnXANES3DDefRawPatn text"].value = cfg_dict["tomo_raw_fn_template"]
         gui_h.hs["FnXANES3DDefReconDirPatn text"].value = cfg_dict[
-            "xanes3D_recon_dir_template"]
+            "xanes3D_recon_dir_template"
+        ]
         gui_h.hs["FnXANES3DDefReconFnPatn text"].value = cfg_dict[
-            "xanes3D_recon_fn_template"]
-        gui_h.hs["IOSpecXANES3DRdr text"].value = cfg_dict[
-            "customized_reader"]["user_xanes3D_reader"]
+            "xanes3D_recon_fn_template"
+        ]
+        gui_h.hs["IOSpecXANES3DRdr text"].value = cfg_dict["customized_reader"][
+            "user_xanes3D_reader"
+        ]
 
 
 def update_json_content(fn, new_item):
     # if os.path.exists(fn):
     fn = Path(fn)
     if fn.exists():
         with open(fn, "r") as f:
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/io_config_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/io_config_gui.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/main_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/main_gui.py`

 * *Files 13% similar despite different names*

```diff
@@ -23,31 +23,41 @@
     IO_TOMO_CFG_DEFAULT,
     IO_XANES2D_CFG_DEFAULT,
     IO_XANES3D_CFG_DEFAULT,
 )
 
 napari.gui_qt()
 
+# try:
+#     pkg_dir = str(
+#         Path(os.path.dirname(os.path.abspath(inspect.getfile(trg)))).parent)
+#     with open(os.path.join(pkg_dir, "config",
+#                            "analysis_tool_gui_cfg.json")) as f:
+#         CFG = json.load(f)
+#         CWD = CFG["cwd"]
+# except:
+#     CWD = os.path.abspath(os.path.curdir)
+
 try:
-    pkg_dir = str(
-        Path(os.path.dirname(os.path.abspath(inspect.getfile(trg)))).parent)
-    with open(os.path.join(pkg_dir, "config",
-                           "analysis_tool_gui_cfg.json")) as f:
+    pkg_dir = Path(inspect.getfile(trg)).absolute().parents[1]
+    print(str(pkg_dir))
+    with open((pkg_dir / "config" / "analysis_tool_gui_cfg.json")) as f:
         CFG = json.load(f)
         CWD = CFG["cwd"]
 except:
-    CWD = os.path.abspath(os.path.curdir)
+    CWD = str(Path.cwd().absolute())
 
 
 class txm_gui:
 
-    def __init__(self,
-                 fiji_path=Path("/home/xiao/software/Fiji.app"),
-                 form_sz=[650, 740]):
-        self.script_dir = os.path.abspath(os.path.curdir)
+    def __init__(
+        self, fiji_path=Path("/home/xiao/software/Fiji.app"), form_sz=[650, 740]
+    ):
+        # self.script_dir = os.path.abspath(os.path.curdir)
+        self.script_dir = Path.cwd().absolute()
         try:
             self.ij = imagej.init(fiji_path, mode=imagej.Mode.INTERACTIVE)
             self.ijui = self.ij.ui()
             self.ijui.showUI()
             self.ij.py.run_macro("""run("Brightness/Contrast...");""")
             if hasattr(imagej, "__version__"):
                 # self.WindowManager = self.ij.py.window_manager()
@@ -62,132 +72,93 @@
                 self.ImagePlusClass = autoclass("ij.ImagePlus")
         except Exception as e:
             print(e)
         self.hs = {}
         self.form_sz = form_sz
         self.cwd = CWD
         # pkg_dir = str(Path(os.path.dirname(os.path.abspath(inspect.getfile(trg)))).parent)
-        self.tmp_dir = os.path.join(pkg_dir, "tmp")
-        if not os.path.exists(self.tmp_dir):
-            os.makedirs(self.tmp_dir, mode=0x777)
-        self.GUI_cfg_file = os.path.join(pkg_dir, "config",
-                                         "analysis_tool_gui_cfg.json")
-        self.io_data_struc_tomo_cfg_file = os.path.join(
-            pkg_dir, "config", "io_tomo_h5_data_structure.json")
-        self.io_data_struc_xanes2D_cfg_file = os.path.join(
-            pkg_dir, "config", "io_xanes2D_h5_data_structure.json")
-        self.io_data_struc_xanes3D_cfg_file = os.path.join(
-            pkg_dir, "config", "io_xanes3D_h5_data_structure.json")
-
-        self.xanes2D_external_command_name = os.path.join(
-            self.script_dir, "xanes2D_external_command.py")
-        self.xanes3D_external_command_name = os.path.join(
-            self.script_dir, "xanes3D_external_command.py")
-        self.tomo_recon_external_command_name = os.path.join(
-            self.script_dir, "tomo_recon_external_command.py")
+        # self.tmp_dir = os.path.join(pkg_dir, "tmp")
+        # if not os.path.exists(self.tmp_dir):
+        #     os.makedirs(self.tmp_dir, mode=0x777)
+        # self.GUI_cfg_file = os.path.join(
+        #     pkg_dir, "config", "analysis_tool_gui_cfg.json"
+        # )
+        # self.io_data_struc_tomo_cfg_file = os.path.join(
+        #     pkg_dir, "config", "io_tomo_h5_data_structure.json"
+        # )
+        # self.io_data_struc_xanes2D_cfg_file = os.path.join(
+        #     pkg_dir, "config", "io_xanes2D_h5_data_structure.json"
+        # )
+        # self.io_data_struc_xanes3D_cfg_file = os.path.join(
+        #     pkg_dir, "config", "io_xanes3D_h5_data_structure.json"
+        # )
+
+        # self.xanes2D_external_command_name = os.path.join(
+        #     self.script_dir, "xanes2D_external_command.py"
+        # )
+        # self.xanes3D_external_command_name = os.path.join(
+        #     self.script_dir, "xanes3D_external_command.py"
+        # )
+        # self.tomo_recon_external_command_name = os.path.join(
+        #     self.script_dir, "tomo_recon_external_command.py"
+        # )
+        self.tmp_dir = pkg_dir / "tmp"
+        if not self.tmp_dir.exists():
+            Path.mkdir(self.tmp_dir, mode=777)
+        self.GUI_cfg_file = pkg_dir / "config" / "analysis_tool_gui_cfg.json"
+        self.io_data_struc_tomo_cfg_file = (
+            pkg_dir / "config" / "io_tomo_h5_data_structure.json"
+        )
+        self.io_data_struc_xanes2D_cfg_file = (
+            pkg_dir / "config" / "io_xanes2D_h5_data_structure.json"
+        )
+        self.io_data_struc_xanes3D_cfg_file = (
+            pkg_dir / "config" / "io_xanes3D_h5_data_structure.json"
+        )
+
+        self.xanes2D_external_command_name = (
+            self.script_dir / "xanes2D_external_command.py"
+        )
+        self.xanes3D_external_command_name = (
+            self.script_dir / "xanes3D_external_command.py"
+        )
+        self.tomo_recon_external_command_name = (
+            self.script_dir / "tomo_recon_external_command.py"
+        )
 
         self.xanes3D_fiji_windows = {
-            "xanes3D_virtural_stack_preview_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_mask_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_review_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_review_manual_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_analysis_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "analysis_viewer_z_plot_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_fit_jump_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_fit_thres_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes3D_fit_maskit_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
+            "xanes3D_virtural_stack_preview_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_mask_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_review_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_review_manual_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_analysis_viewer": {"ip": None, "fiji_id": None},
+            "analysis_viewer_z_plot_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_fit_jump_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_fit_thres_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes3D_fit_maskit_viewer": {"ip": None, "fiji_id": None},
         }
         self.xanes2D_fiji_windows = {
-            "xanes2D_raw_img_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_mask_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_review_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_analysis_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "analysis_viewer_z_plot_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_fit_jump_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_fit_thres_flt_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes2D_fit_maskit_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
+            "xanes2D_raw_img_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_mask_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_review_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_analysis_viewer": {"ip": None, "fiji_id": None},
+            "analysis_viewer_z_plot_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_fit_jump_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_fit_thres_flt_viewer": {"ip": None, "fiji_id": None},
+            "xanes2D_fit_maskit_viewer": {"ip": None, "fiji_id": None},
         }
         self.tomo_fiji_windows = {
-            "tomo_raw_img_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "tomo_0&180_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "tomo_cen_review_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "tomo_recon_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
+            "tomo_raw_img_viewer": {"ip": None, "fiji_id": None},
+            "tomo_0&180_viewer": {"ip": None, "fiji_id": None},
+            "tomo_cen_review_viewer": {"ip": None, "fiji_id": None},
+            "tomo_recon_viewer": {"ip": None, "fiji_id": None},
         }
         self.xanes_ana_fiji_windows = {
-            "xanes_pp_data_prev_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
-            "xanes_pp_mask_prev_viewer": {
-                "ip": None,
-                "fiji_id": None
-            },
+            "xanes_pp_data_prev_viewer": {"ip": None, "fiji_id": None},
+            "xanes_pp_mask_prev_viewer": {"ip": None, "fiji_id": None},
         }
 
     def gui_layout(self):
         """
         hs: widget handler sets; hs is a multi-layer structured dictionary. Layers
         are labeled as '0', '1', '2' in order of their hiearchical relations. In
         each layer, the item '0' is always the parent widget that hosts all other
@@ -255,46 +226,38 @@
             self.io_config_gui.hs["IOOptn form"],
             self.io_config_gui.hs["IOConfig form"],
         ]
         self.hs["IOConfig tab"].set_title(0, "IO Option")
         self.hs["IOConfig tab"].set_title(1, "Struct h5 IO")
 
         try:
-            f = open(self.io_data_struc_tomo_cfg_file, "r")
-            self.io_tomo_cfg = json.load(f)
-            set_io_config(self.io_config_gui,
-                          self.io_tomo_cfg,
-                          cfg_type="tomo")
+            with open(self.io_data_struc_tomo_cfg_file, "r") as f:
+                self.io_tomo_cfg = json.load(f)
+            set_io_config(self.io_config_gui, self.io_tomo_cfg, cfg_type="tomo")
         except:
             self.io_tomo_cfg = IO_TOMO_CFG_DEFAULT
-            set_io_config(self.io_config_gui,
-                          IO_TOMO_CFG_DEFAULT,
-                          cfg_type="tomo")
+            set_io_config(self.io_config_gui, IO_TOMO_CFG_DEFAULT, cfg_type="tomo")
         try:
-            f = open(self.io_data_struc_xanes2D_cfg_file, "r")
-            self.io_xanes2D_cfg = json.load(f)
-            set_io_config(self.io_config_gui,
-                          self.io_xanes2D_cfg,
-                          cfg_type="xanes2D")
+            with open(self.io_data_struc_xanes2D_cfg_file, "r") as f:
+                self.io_xanes2D_cfg = json.load(f)
+            set_io_config(self.io_config_gui, self.io_xanes2D_cfg, cfg_type="xanes2D")
         except:
             self.io_xanes2D_cfg = IO_XANES2D_CFG_DEFAULT
-            set_io_config(self.io_config_gui,
-                          IO_XANES2D_CFG_DEFAULT,
-                          cfg_type="xanes2D")
+            set_io_config(
+                self.io_config_gui, IO_XANES2D_CFG_DEFAULT, cfg_type="xanes2D"
+            )
         try:
-            f = open(self.io_data_struc_xanes3D_cfg_file, "r")
-            self.io_xanes3D_cfg = json.load(f)
-            set_io_config(self.io_config_gui,
-                          self.io_xanes3D_cfg,
-                          cfg_type="xanes3D")
+            with open(self.io_data_struc_xanes3D_cfg_file, "r") as f:
+                self.io_xanes3D_cfg = json.load(f)
+            set_io_config(self.io_config_gui, self.io_xanes3D_cfg, cfg_type="xanes3D")
         except:
             self.io_xanes3D_cfg = IO_XANES3D_CFG_DEFAULT
-            set_io_config(self.io_config_gui,
-                          IO_XANES3D_CFG_DEFAULT,
-                          cfg_type="xanes3D")
+            set_io_config(
+                self.io_config_gui, IO_XANES3D_CFG_DEFAULT, cfg_type="xanes3D"
+            )
         self.io_config_gui.boxes_logics()
 
         #################################################################################################################
         #                                                                                                               #
         #                                                    TOMO RECON                                                 #
         #                                                                                                               #
         #################################################################################################################
@@ -344,21 +307,23 @@
             self.xanes3D_gui.hs["Analysis form"],
         ]
         self.hs["XANES3D tab"].set_title(0, "Data Config")
         self.hs["XANES3D tab"].set_title(1, "Reg Config")
         self.hs["XANES3D tab"].set_title(2, "Reg Review")
         self.hs["XANES3D tab"].set_title(3, "Fitting")
         self.hs["XANES3D tab"].set_title(4, "Analysis")
-        
+
         #################################################################################################################
         #                                                                                                               #
         #                                                       MISC                                                    #
         #                                                                                                               #
         #################################################################################################################
         self.misc_gui = misc.misc_gui(self, form_sz=self.form_sz)
         self.misc_gui.build_gui()
-        self.hs["MISC tab"].children = [self.misc_gui.hs['GenImgAlign form'], self.misc_gui.hs['ConvertData form']]
+        self.hs["MISC tab"].children = [
+            self.misc_gui.hs["GenImgAlign form"],
+            self.misc_gui.hs["ConvertData form"],
+        ]
         self.hs["MISC tab"].set_title(0, "General Img Align")
         self.hs["MISC tab"].set_title(1, "Convert Data")
-        
 
         display(self.hs["MainGUI form"])
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/misc_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/misc_gui.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/tomo_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/tomo_gui.py`

 * *Files 1% similar despite different names*

```diff
@@ -4,14 +4,15 @@
 Created on Thu May 21 19:33:11 2020
 
 @author: xiao
 """
 
 import os, h5py, json, time
 import numpy as np
+from pathlib import Path
 import matplotlib.pyplot as plt
 import napari
 from copy import deepcopy
 
 from ipywidgets import widgets, GridspecLayout
 from collections import OrderedDict
 
@@ -466,16 +467,19 @@
             self.info_reader = data_info(tomo_h5_info)
         else:
             from ..external.user_io import user_tomo_reader, user_tomo_info_reader
 
             self.reader = data_reader(user_tomo_reader)
             self.info_reader = data_info(user_tomo_info_reader)
 
-        self.tomo_recon_external_command_name = os.path.join(
-            os.path.abspath(os.path.curdir), "tomo_recon_external_command.py"
+        # self.tomo_recon_external_command_name = os.path.join(
+        #     os.path.abspath(os.path.curdir), "tomo_recon_external_command.py"
+        # )
+        self.tomo_recon_external_command_name = str(
+            Path.cwd().absolute() / "tomo_recon_external_command.py"
         )
         self.tomo_msg_on = False
 
         self.tomo_raw_data_top_dir_set = False
         self.tomo_recon_path_set = False
         self.tomo_data_center_path_set = False
         self.tomo_debug_path_set = False
@@ -608,17 +612,15 @@
         )
         layout = {"width": "66%", "display": "inline_flex"}
         self.hs["SelRawH5TopDir text"].layout = layout
         self.hs["SelRawH5TopDir btn"] = SelectFilesButton(
             option="askdirectory", text_h=self.hs["SelRawH5TopDir text"]
         )
         self.hs["SelRawH5TopDir btn"].description = "Raw Top Dir"
-        self.hs[
-            "SelRawH5TopDir btn"
-        ].description_tooltip = (
+        self.hs["SelRawH5TopDir btn"].description_tooltip = (
             "Select the top directory in which the raw h5 files are located."
         )
         layout = {"width": "15%"}
         self.hs["SelRawH5TopDir btn"].layout = layout
         self.hs["SelRawH5TopDir btn"].on_click(self.SelRawH5TopDir_btn_clk)
         self.hs["SelRaw box"].children = [
             self.hs["SelRawH5TopDir text"],
@@ -773,22 +775,30 @@
         self.hs["ScanId drpdn"].layout = layout
         self.hs["RotCen text"] = widgets.BoundedFloatText(
             value=1280.0, min=0, max=2500, description="Center", disabled=True
         )
         layout = {"width": "19%"}
         self.hs["RotCen text"].layout = layout
         self.hs["CenWinLeft text"] = widgets.BoundedIntText(
-            value=1240, min=0, max=2500, description="Cen Win L", disabled=True,
-            tooltip="Center search window starting position relative to the image left handside edge."
+            value=1240,
+            min=0,
+            max=2500,
+            description="Cen Win L",
+            disabled=True,
+            tooltip="Center search window starting position relative to the image left handside edge.",
         )
         layout = {"width": "19%"}
         self.hs["CenWinLeft text"].layout = layout
         self.hs["CenWinWz text"] = widgets.BoundedIntText(
-            value=80, min=1, max=200, description="Cen Win W", disabled=True,
-            tooltip="Center search window width"
+            value=80,
+            min=1,
+            max=200,
+            description="Cen Win W",
+            disabled=True,
+            tooltip="Center search window width",
         )
         layout = {"width": "19%"}
         self.hs["CenWinWz text"].layout = layout
 
         self.hs["ReadConfig_btn"] = SelectFilesButton(
             option="askopenfilename", **{"open_filetypes": (("json files", "*.json"),)}
         )
@@ -1527,32 +1537,32 @@
         FilterConfigGrid[:7, :100][0, 16:19] = widgets.Button(
             description="==>", disabled=True, layout={"width": "auto"}
         )
         self.hs["FilterConfigLeftAddTo btn"] = FilterConfigGrid[:7, :100][0, 16:19]
         FilterConfigGrid[:7, :100][0, 16:19].style.button_color = "#0000FF"
         for ii in range(3):
             for jj in range(2):
-                FilterConfigGrid[:7, :100][
-                    1 + ii, jj * 8 : (jj + 1) * 8
-                ] = widgets.Dropdown(
-                    value="",
-                    options=[""],
-                    description="p" + str(ii * 2 + jj).zfill(2),
-                    disabled=True,
-                    layout={"width": "90%"},
+                FilterConfigGrid[:7, :100][1 + ii, jj * 8 : (jj + 1) * 8] = (
+                    widgets.Dropdown(
+                        value="",
+                        options=[""],
+                        description="p" + str(ii * 2 + jj).zfill(2),
+                        disabled=True,
+                        layout={"width": "90%"},
+                    )
                 )
         for ii in range(3):
             for jj in range(2):
-                FilterConfigGrid[:7, :100][
-                    4 + ii, jj * 8 : (jj + 1) * 8
-                ] = widgets.FloatText(
-                    value=0,
-                    disabled=True,
-                    description="p" + str((ii + 3) * 2 + jj).zfill(2),
-                    layout={"width": "90%"},
+                FilterConfigGrid[:7, :100][4 + ii, jj * 8 : (jj + 1) * 8] = (
+                    widgets.FloatText(
+                        value=0,
+                        disabled=True,
+                        description="p" + str((ii + 3) * 2 + jj).zfill(2),
+                        layout={"width": "90%"},
+                    )
                 )
 
         self.hs["FilterConfigLeftPar00 text"] = FilterConfigGrid[:7, :100][1, 0:8]
         self.hs["FilterConfigLeftPar01 text"] = FilterConfigGrid[:7, :100][1, 8:16]
         self.hs["FilterConfigLeftPar02 text"] = FilterConfigGrid[:7, :100][2, 0:8]
         self.hs["FilterConfigLeftPar03 text"] = FilterConfigGrid[:7, :100][2, 8:16]
         self.hs["FilterConfigLeftPar04 text"] = FilterConfigGrid[:7, :100][3, 0:8]
@@ -1990,15 +2000,15 @@
             else:
                 self.hs["SelFile&PathCfm text"].value = "Cannot open the file..."
 
     def tomo_compound_logic(self):
         self.hs["RotCen text"].disabled = True
         if self.tomo_recon_type == "Trial Cent":
             if self.tomo_raw_data_top_dir_set & self.tomo_data_center_path_set:
-                self.hs["ScanId drpdn"].disabled = False               
+                self.hs["ScanId drpdn"].disabled = False
                 self.hs["CenWinLeft text"].disabled = False
                 self.hs["CenWinWz text"].disabled = False
                 self.hs["ReconChunkSz text"].disabled = True
                 self.hs["ReconMargSz text"].disabled = True
                 self.hs["RoiSliEnd text"].disabled = True
         elif self.tomo_recon_type == "Vol Recon":
             if self.tomo_raw_data_top_dir_set & self.tomo_recon_path_set:
@@ -2159,17 +2169,17 @@
         ] = self.tomo_alt_dark_file
         self.tomo_recon_param_dict["file_params"][
             "wedge_ang_auto_det_ref_fn"
         ] = self.tomo_wedge_ang_auto_det_ref_fn
         self.tomo_recon_param_dict["file_params"][
             "io_confg"
         ] = self.global_h.io_tomo_cfg
-        self.tomo_recon_param_dict["file_params"][
-            "use_struc_h5_reader"
-        ] = self.global_h.io_tomo_cfg["use_h5_reader"]
+        self.tomo_recon_param_dict["file_params"]["use_struc_h5_reader"] = (
+            self.global_h.io_tomo_cfg["use_h5_reader"]
+        )
         self.tomo_recon_param_dict["recon_config"]["recon_type"] = self.tomo_recon_type
         self.tomo_recon_param_dict["recon_config"]["use_debug"] = self.tomo_use_debug
         self.tomo_recon_param_dict["recon_config"][
             "use_alt_flat"
         ] = self.tomo_use_alt_flat
         self.tomo_recon_param_dict["recon_config"][
             "use_alt_dark"
@@ -2443,139 +2453,171 @@
         self.flt_param_dict = {}
         flt = FILTER_PARAM_DICT[self.tomo_left_box_selected_flt]
         for idx in flt.keys():
             self.flt_param_dict[flt[idx][0]] = self.flt_phs[idx].value
         self.flt_param_dict = dict(OrderedDict(self.flt_param_dict))
 
     def read_config(self):
-        if os.path.basename(self.tomo_cen_list_file).split(".")[-1] == "json":
+        # if os.path.basename(self.tomo_cen_list_file).split(".")[-1] == "json":
+        if Path(self.tomo_cen_list_file).suffix.strip(".") == "json":
             with open(self.tomo_cen_list_file, "r") as f:
                 tem = dict(OrderedDict(json.load(f)))
             return tem
         else:
             print("json is the only allowed configuration file type.")
             return None
 
     def SelRawH5TopDir_btn_clk(self, a):
         self.reset_config()
         if len(a.files[0]) != 0:
             self.tomo_raw_data_top_dir = a.files[0]
             self.tomo_recon_top_dir = a.files[0]
-            self.tomo_raw_data_file_template = os.path.join(
-                self.tomo_raw_data_top_dir,
-                self.global_h.io_tomo_cfg["tomo_raw_fn_template"],
+            # self.tomo_raw_data_file_template = os.path.join(
+            #     self.tomo_raw_data_top_dir,
+            #     self.global_h.io_tomo_cfg["tomo_raw_fn_template"],
+            # )
+            self.tomo_raw_data_file_template = str(
+                Path(self.tomo_raw_data_top_dir)
+                / self.global_h.io_tomo_cfg["tomo_raw_fn_template"],
             )
             b = ""
             t = time.strptime(time.asctime())
             for ii in range(6):
                 b += str(t[ii]).zfill(2) + "-"
-            self.tomo_trial_cen_dict_fn = os.path.join(
-                self.tomo_raw_data_top_dir, "trial_cen_dict_{}.json".format(b)
-            )
-            self.tomo_recon_dict_fn = os.path.join(
-                self.tomo_raw_data_top_dir, "recon_dict_{}.json".format(b)
+            # self.tomo_trial_cen_dict_fn = os.path.join(
+            #     self.tomo_raw_data_top_dir, "trial_cen_dict_{}.json".format(b)
+            # )
+            self.tomo_trial_cen_dict_fn = str(
+                Path(self.tomo_raw_data_top_dir), "trial_cen_dict_{}.json".format(b)
+            )
+            # self.tomo_recon_dict_fn = os.path.join(
+            #     self.tomo_raw_data_top_dir, "recon_dict_{}.json".format(b)
+            # )
+            self.tomo_recon_dict_fn = str(
+                Path(self.tomo_raw_data_top_dir), "recon_dict_{}.json".format(b)
             )
             self.tomo_raw_data_top_dir_set = True
             self.tomo_recon_path_set = True
-            self.hs["SelRawH5TopDir btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["SelSavReconDir btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["SelSavDebugDir btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["ReadConfig_btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["AltFlatFile btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["AltDarkFile btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["AutoRefFn btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["SelRawH5TopDir btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["SelSavReconDir btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["SelSavDebugDir btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["ReadConfig_btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["AltFlatFile btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["AltDarkFile btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["AutoRefFn btn"].initialdir = os.path.abspath(a.files[0])
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+            # )
+            # self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+            self.hs["SelRawH5TopDir btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["SelSavReconDir btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["SelSavDebugDir btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["ReadConfig_btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["AltFlatFile btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["AltDarkFile btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["AutoRefFn btn"].initialdir = str(Path(a.files[0]).absolute())
             update_json_content(
-                self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+                self.global_h.GUI_cfg_file, {"cwd": str(Path(a.files[0]).absolute())}
             )
-            self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+            self.global_h.cwd = str(Path(a.files[0]).absolute())
         else:
             self.tomo_raw_data_top_dir = None
             self.tomo_raw_data_top_dir_set = False
             self.tomo_recon_top_dir = None
             self.tomo_recon_path_set = False
             self.hs["SelRawH5TopDir text"].value = "Choose raw h5 top dir ..."
         self.tomo_filepath_configured = False
         self.recon_finish = -1
-        self.hs[
-            "SelFile&PathCfm text"
-        ].value = "After setting directories, confirm to proceed ..."
+        self.hs["SelFile&PathCfm text"].value = (
+            "After setting directories, confirm to proceed ..."
+        )
         self.boxes_logic()
 
     def SelSavReconDir_btn_clk(self, a):
         self.reset_config()
         if not self.tomo_raw_data_top_dir_set:
-            self.hs[
-                "SelFile&PathCfm text"
-            ].value = "Please specify raw h5 top directory first ..."
-            self.hs[
-                "SelSavReconDir text"
-            ].value = "Choose top directory where recon subdirectories are saved..."
+            self.hs["SelFile&PathCfm text"].value = (
+                "Please specify raw h5 top directory first ..."
+            )
+            self.hs["SelSavReconDir text"].value = (
+                "Choose top directory where recon subdirectories are saved..."
+            )
             self.tomo_recon_path_set = False
         else:
             if len(a.files[0]) != 0:
                 self.tomo_recon_top_dir = a.files[0]
                 self.tomo_recon_path_set = True
                 # self.hs["SelSavReconDir btn"].initialdir = os.path.abspath(a.files[0])
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+                # )
                 update_json_content(
-                    self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+                    self.global_h.GUI_cfg_file,
+                    {"cwd": str(Path(a.files[0]).absolute())},
                 )
-                self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+                # self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+                self.global_h.cwd = str(Path(a.files[0]).absolute())
             else:
                 self.tomo_recon_top_dir = None
                 self.tomo_recon_path_set = False
-                self.hs[
-                    "SelSavReconDir text"
-                ].value = "Select top directory where recon subdirectories are saved..."
-            self.hs[
-                "SelFile&PathCfm text"
-            ].value = "After setting directories, confirm to proceed ..."
+                self.hs["SelSavReconDir text"].value = (
+                    "Select top directory where recon subdirectories are saved..."
+                )
+            self.hs["SelFile&PathCfm text"].value = (
+                "After setting directories, confirm to proceed ..."
+            )
         self.tomo_filepath_configured = False
         self.recon_finish = -1
         self.boxes_logic()
 
     def SelSavDebugDir_btn_clk(self, a):
         self.reset_config()
         if not self.tomo_raw_data_top_dir_set:
-            self.hs[
-                "SelFile&PathCfm text"
-            ].value = "Please specify raw h5 top directory first ..."
-            self.hs[
-                "SelSavDebugDir text"
-            ].value = "Select top directory where debug dir will be created..."
+            self.hs["SelFile&PathCfm text"].value = (
+                "Please specify raw h5 top directory first ..."
+            )
+            self.hs["SelSavDebugDir text"].value = (
+                "Select top directory where debug dir will be created..."
+            )
             self.tomo_debug_path_set = False
         else:
             if len(a.files[0]) != 0:
                 self.tomo_debug_top_dir = a.files[0]
                 self.tomo_debug_path_set = True
                 # self.hs["SelSavDebugDir btn"].initialdir = os.path.abspath(a.files[0])
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+                # )
                 update_json_content(
-                    self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+                    self.global_h.GUI_cfg_file,
+                    {"cwd": str(Path(a.files[0]).absolute())},
                 )
-                self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+                # self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+                self.global_h.cwd = str(Path(a.files[0]).absolute())
             else:
                 self.tomo_debug_top_dir = None
                 self.tomo_debug_path_set = False
-                self.hs[
-                    "SelSavDebugDir text"
-                ].value = "Select top directory where debug dir will be created..."
-            self.hs[
-                "SelFile&PathCfm text"
-            ].value = "After setting directories, confirm to proceed ..."
+                self.hs["SelSavDebugDir text"].value = (
+                    "Select top directory where debug dir will be created..."
+                )
+            self.hs["SelFile&PathCfm text"].value = (
+                "After setting directories, confirm to proceed ..."
+            )
         self.tomo_filepath_configured = False
         self.recon_finish = -1
         self.boxes_logic()
 
     def SavDebug_chbx_chg(self, a):
         self.reset_config()
         if a["owner"].value:
             self.tomo_use_debug = True
             self.hs["SelSavDebugDir btn"].disabled = False
-            self.hs[
-                "SelSavDebugDir text"
-            ].value = "Select top directory where debug dir will be created..."
+            self.hs["SelSavDebugDir text"].value = (
+                "Select top directory where debug dir will be created..."
+            )
             self.hs["SelSavDebugDir btn"].style.button_color = "orange"
         else:
             self.tomo_use_debug = False
             self.hs["SelSavDebugDir btn"].disabled = True
             self.hs["SelSavDebugDir text"].value = "Debug is disabled..."
             self.hs["SelSavDebugDir btn"].style.button_color = "orange"
         self.tomo_filepath_configured = False
@@ -2596,28 +2638,24 @@
             self.hs["CenWinWz text"].layout = layout
 
             self.hs["SelSavReconDir btn"].disabled = True
             self.hs["SelSavReconDir btn"].style.button_color = "orange"
 
             self.hs["SelSavReconDir btn"].disabled = False
             self.hs["SelSavReconDir btn"].style.button_color = "orange"
-            self.hs[
-                "SelSavReconDir text"
-            ].value = (
+            self.hs["SelSavReconDir text"].value = (
                 "Select top directory where data_center directory will be created..."
             )
 
             self.hs["UseConfig chbx"].value = False
             self.tomo_use_read_config = False
         elif self.tomo_recon_type == "Vol Recon":
             self.hs["SelSavReconDir btn"].disabled = False
             self.hs["SelSavReconDir btn"].style.button_color = "orange"
-            self.hs[
-                "SelSavReconDir text"
-            ].value = (
+            self.hs["SelSavReconDir text"].value = (
                 "Select top directory where recon subdirectories will be created..."
             )
             layout = {"width": "15%", "height": "85%", "visibility": "visible"}
             self.hs["ReadConfig_btn"].layout = layout
             layout = {"width": "7%", "visibility": "visible"}
             self.hs["UseConfig chbx"].layout = layout
             layout = {"width": "19%", "visibility": "hidden"}
@@ -2645,36 +2683,42 @@
                 else:
                     self.hs["ScanId drpdn"].options = self.tomo_available_raw_idx
                     self.tomo_scan_id = self.tomo_available_raw_idx[0]
                     self.hs["ScanId drpdn"].value = self.tomo_scan_id
                     self.cal_set_srch_win()
                     if self.tomo_use_debug:
                         if self.tomo_debug_path_set:
-                            self.tomo_data_center_path = os.path.join(
-                                self.tomo_recon_top_dir, "data_center"
+                            # self.tomo_data_center_path = os.path.join(
+                            #     self.tomo_recon_top_dir, "data_center"
+                            # )
+                            self.tomo_data_center_path = str(
+                                Path(self.tomo_recon_top_dir) / "data_center"
                             )
                             self.tomo_filepath_configured = True
                             self.set_alg_param_widgets()
                             self.set_flt_param_widgets()
                         else:
-                            self.hs[
-                                "SelFile&PathCfm text"
-                            ].value = "You need to select the top directory to create debug dir..."
+                            self.hs["SelFile&PathCfm text"].value = (
+                                "You need to select the top directory to create debug dir..."
+                            )
                             self.tomo_filepath_configured = False
                     else:
-                        self.tomo_data_center_path = os.path.join(
-                            self.tomo_recon_top_dir, "data_center"
+                        # self.tomo_data_center_path = os.path.join(
+                        #     self.tomo_recon_top_dir, "data_center"
+                        # )
+                        self.tomo_data_center_path = str(
+                            Path(self.tomo_recon_top_dir) / "data_center"
                         )
                         self.tomo_filepath_configured = True
                         self.set_alg_param_widgets()
                         self.set_flt_param_widgets()
             else:
-                self.hs[
-                    "SelFile&PathCfm text"
-                ].value = "You need to select the top raw dir and top dir where debug dir can be created..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "You need to select the top raw dir and top dir where debug dir can be created..."
+                )
                 self.tomo_filepath_configured = False
         elif self.tomo_recon_type == "Vol Recon":
             if self.tomo_raw_data_top_dir_set & self.tomo_recon_path_set:
                 self.tomo_available_raw_idx = check_file_availability(
                     self.tomo_raw_data_top_dir,
                     scan_id=None,
                     signature=self.global_h.io_tomo_cfg["tomo_raw_fn_template"],
@@ -2689,17 +2733,17 @@
                 else:
                     self.hs["ScanId drpdn"].options = self.tomo_available_raw_idx
                     self.hs["ScanId drpdn"].value = self.tomo_available_raw_idx[0]
                     self.tomo_filepath_configured = True
                     self.set_alg_param_widgets()
                     self.set_flt_param_widgets()
             else:
-                self.hs[
-                    "SelFile&PathCfm text"
-                ].value = "You need to select the top raw dir and top dir where recon dir can be created..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "You need to select the top raw dir and top dir where recon dir can be created..."
+                )
                 self.tomo_filepath_configured = False
         self.recon_finish = -1
         self.boxes_logic()
         self.tomo_compound_logic()
 
     def ScanId_drpdn_chg(self, a):
         self.tomo_scan_id = a["owner"].value
@@ -3421,33 +3465,33 @@
         self.set_rec_params_from_widgets()
         self.set_rec_dict_from_rec_params()
 
         try:
             with open(self.tomo_trial_cen_dict_fn, "r") as f:
                 tem = json.load(f)
             with open(self.tomo_trial_cen_dict_fn, "w") as f:
-                tem[
-                    str(self.tomo_recon_param_dict["data_params"]["scan_id"])
-                ] = self.tomo_recon_param_dict
+                tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])] = (
+                    self.tomo_recon_param_dict
+                )
                 tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])][
                     "file_params"
                 ]["io_confg"]["customized_reader"]["user_tomo_reader"] = ""
                 tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])][
                     "file_params"
                 ]["reader"] = ""
                 tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])][
                     "file_params"
                 ]["info_reader"] = ""
                 self.tomo_recon_param_dict["recon_config"]["recon_type"] = "Vol Recon"
                 json.dump(tem, f, indent=4, separators=(",", ": "))
         except:
             tem = {}
-            tem[
-                str(self.tomo_recon_param_dict["data_params"]["scan_id"])
-            ] = self.tomo_recon_param_dict
+            tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])] = (
+                self.tomo_recon_param_dict
+            )
             tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])][
                 "file_params"
             ]["io_confg"]["customized_reader"]["user_tomo_reader"] = ""
             tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])][
                 "file_params"
             ]["reader"] = ""
             tem[str(self.tomo_recon_param_dict["data_params"]["scan_id"])][
@@ -3736,35 +3780,35 @@
             fiji_viewer_off(self.global_h, self, viewer_name="tomo_cen_review_viewer")
             code = {}
             ln = 0
             code[ln] = f"from collections import OrderedDict"
             ln += 1
             code[ln] = f"from TXM_Sandbox.utils.tomo_recon_tools import run_engine"
             ln += 1
-            code[
-                ln
-            ] = f"from TXM_Sandbox.utils.io import data_reader, tomo_h5_reader, data_info, tomo_h5_info"
+            code[ln] = (
+                f"from TXM_Sandbox.utils.io import data_reader, tomo_h5_reader, data_info, tomo_h5_info"
+            )
             ln += 1
             code[ln] = f"params = {self.tomo_recon_param_dict}"
             ln += 1
             code[ln] = f"if {self.global_h.io_tomo_cfg['use_h5_reader']}:"
             ln += 1
-            code[
-                ln
-            ] = f"    params['file_params']['reader'] = data_reader(tomo_h5_reader)"
+            code[ln] = (
+                f"    params['file_params']['reader'] = data_reader(tomo_h5_reader)"
+            )
             ln += 1
-            code[
-                ln
-            ] = f"    params['file_params']['info_reader'] = data_info(tomo_h5_info)"
+            code[ln] = (
+                f"    params['file_params']['info_reader'] = data_info(tomo_h5_info)"
+            )
             ln += 1
             code[ln] = f"else:"
             ln += 1
-            code[
-                ln
-            ] = f"    from TXM_Sandbox.external.user_io import user_tomo_reader, user_tomo_info_reader"
+            code[ln] = (
+                f"    from TXM_Sandbox.external.user_io import user_tomo_reader, user_tomo_info_reader"
+            )
             ln += 1
             code[ln] = f"    self.reader = data_reader(user_tomo_reader)"
             ln += 1
             code[ln] = f"    self.info_reader = data_info(user_tomo_info_reader)"
             ln += 1
             code[ln] = f"run_engine(**params)"
             ln += 1
@@ -3801,31 +3845,31 @@
                         self.set_rec_params_from_widgets()
                         self.set_rec_dict_from_rec_params()
 
                         code = {}
                         ln = 0
                         code[ln] = f"from collections import OrderedDict"
                         ln += 1
-                        code[
-                            ln
-                        ] = f"from TXM_Sandbox.utils.tomo_recon_tools import run_engine"
+                        code[ln] = (
+                            f"from TXM_Sandbox.utils.tomo_recon_tools import run_engine"
+                        )
                         ln += 1
-                        code[
-                            ln
-                        ] = f"from TXM_Sandbox.utils.io import data_reader, tomo_h5_reader, data_info, tomo_h5_info"
+                        code[ln] = (
+                            f"from TXM_Sandbox.utils.io import data_reader, tomo_h5_reader, data_info, tomo_h5_info"
+                        )
                         ln += 1
                         code[ln] = f"params = {self.tomo_recon_param_dict}"
                         ln += 1
-                        code[
-                            ln
-                        ] = f"params['file_params']['reader'] = data_reader(tomo_h5_reader)"
+                        code[ln] = (
+                            f"params['file_params']['reader'] = data_reader(tomo_h5_reader)"
+                        )
                         ln += 1
-                        code[
-                            ln
-                        ] = f"params['file_params']['info_reader'] = data_info(tomo_h5_info)"
+                        code[ln] = (
+                            f"params['file_params']['info_reader'] = data_info(tomo_h5_info)"
+                        )
                         ln += 1
                         code[ln] = f"run_engine(**params)"
                         ln += 1
                         gen_external_py_script(
                             self.tomo_recon_external_command_name, code
                         )
                         sig = os.system(
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes2D_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes2D_gui.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,16 +1,23 @@
 #!/usr/bin/env python3
 # -*- coding: utf-8 -*-
 """
 Created on Thu Jun 18 19:05:59 2020
 
 @author: xiao
 """
-import os, h5py, json, time, gc, numpy as np
+import os
+import h5py
+import json
+import time
+import datetime
+import gc
+import numpy as np
 
+from pathlib import Path
 from ipywidgets import widgets
 import skimage.morphology as skm
 import matplotlib.pyplot as plt
 from scipy.ndimage import gaussian_filter
 from scipy.ndimage import fourier_shift
 import napari
 
@@ -47,23 +54,31 @@
         if self.global_h.io_xanes2D_cfg["use_h5_reader"]:
             self.reader = data_reader(xanes2D_h5_reader)
         else:
             from ..external.user_io import user_xanes2D_reader
 
             self.reader = data_reader(user_xanes2D_reader)
 
-        self.xanes_raw_fn_temp = self.global_h.io_xanes2D_cfg[
-            "xanes2D_raw_fn_template"]
+        self.xanes_raw_fn_temp = self.global_h.io_xanes2D_cfg["xanes2D_raw_fn_template"]
 
-        self.xanes_fit_external_command_name = os.path.join(
-            self.global_h.script_dir, "xanes2D_fit_external_command.py")
-        self.xanes_reg_external_command_name = os.path.join(
-            self.global_h.script_dir, "xanes2D_reg_external_command.py")
-        self.xanes_align_external_command_name = os.path.join(
-            self.global_h.script_dir, "xanes2D_align_external_command.py")
+        # self.xanes_fit_external_command_name = os.path.join(
+        #     self.global_h.script_dir, "xanes2D_fit_external_command.py")
+        # self.xanes_reg_external_command_name = os.path.join(
+        #     self.global_h.script_dir, "xanes2D_reg_external_command.py")
+        # self.xanes_align_external_command_name = os.path.join(
+        #     self.global_h.script_dir, "xanes2D_align_external_command.py")
+        self.xanes_fit_external_command_name = str(
+            Path(self.global_h.script_dir) / "xanes2D_fit_external_command.py"
+        )
+        self.xanes_reg_external_command_name = str(
+            Path(self.global_h.script_dir) / "xanes2D_reg_external_command.py"
+        )
+        self.xanes_align_external_command_name = str(
+            Path(self.global_h.script_dir) / "xanes2D_align_external_command.py"
+        )
 
         self.xanes_file_configured = False
         self.xanes_data_configured = False
         self.xanes_roi_configured = False
         self.xanes_reg_params_configured = False
         self.xanes_reg_done = False
         self.xanes_reg_review_done = False
@@ -147,54 +162,41 @@
         self.xanes_fit_mask_img_id = None
         self.xanes_fit_mask = 1
         self.xanes_fit_edge_jump_thres = 1.0
         self.xanes_fit_edge_offset_thres = 1.0
 
         self.xanes_config = {
             "filepath config": {
-                "xanes2D_file_raw_h5_filename":
-                self.xanes_file_raw_h5_filename,
-                "xanes_save_trial_reg_filename":
-                self.xanes_save_trial_reg_filename,
-                "xanes2D_file_save_trial_reg_config_filename":
-                self.xanes_file_save_trial_reg_config_filename,
-                "xanes2D_review_reg_best_match_filename":
-                self.xanes_review_reg_best_match_filename,
-                "xanes2D_file_analysis_option":
-                self.xanes_file_analysis_option,
+                "xanes2D_file_raw_h5_filename": self.xanes_file_raw_h5_filename,
+                "xanes_save_trial_reg_filename": self.xanes_save_trial_reg_filename,
+                "xanes2D_file_save_trial_reg_config_filename": self.xanes_file_save_trial_reg_config_filename,
+                "xanes2D_review_reg_best_match_filename": self.xanes_review_reg_best_match_filename,
+                "xanes2D_file_analysis_option": self.xanes_file_analysis_option,
                 "xanes2D_file_configured": self.xanes_file_configured,
                 "xanes2D_file_raw_h5_set": self.xanes_file_raw_h5_set,
                 "xanes2D_file_save_trial_set": self.xanes_file_save_trial_set,
                 "xanes2D_file_reg_file_set": self.xanes_file_reg_file_set,
-                "xanes2D_file_config_file_set":
-                self.xanes_file_config_file_set,
-                "xanes2D_file_reg_file_readed":
-                self.xanes_file_reg_file_readed,
+                "xanes2D_file_config_file_set": self.xanes_file_config_file_set,
+                "xanes2D_file_reg_file_readed": self.xanes_file_reg_file_readed,
             },
             "data_config": {
                 "xanes2D_config_is_raw": self.xanes_config_is_raw,
                 "xanes2D_config_img_scalar": self.xanes_config_img_scalar,
-                "xanes2D_config_use_alternative_flat":
-                self.xanes_config_use_alternative_flat,
-                "xanes2D_config_use_smooth_flat":
-                self.xanes_config_use_smooth_flat,
-                "xanes2D_config_smooth_flat_sigma":
-                self.xanes_config_smooth_flat_sigma,
-                "xanes2D_config_alternative_flat_filename":
-                self.xanes_config_alternative_flat_filename,
-                "xanes2D_config_alternative_flat_set":
-                self.xanes_config_alternative_flat_set,
+                "xanes2D_config_use_alternative_flat": self.xanes_config_use_alternative_flat,
+                "xanes2D_config_use_smooth_flat": self.xanes_config_use_smooth_flat,
+                "xanes2D_config_smooth_flat_sigma": self.xanes_config_smooth_flat_sigma,
+                "xanes2D_config_alternative_flat_filename": self.xanes_config_alternative_flat_filename,
+                "xanes2D_config_alternative_flat_set": self.xanes_config_alternative_flat_set,
                 "xanes2D_config_eng_points_range_s": self.xanes_eng_id_s,
                 "xanes2D_config_eng_points_range_e": self.xanes_eng_id_e,
                 "xanes2D_config_eng_s": 0,
                 "xanes2D_config_eng_e": 0,
                 "xanes2D_config_fiji_view_on": False,
                 "xanes2D_config_img_num": 0,
-                "xanes2D_config_raw_img_readed":
-                self.xanes_config_raw_img_readed,
+                "xanes2D_config_raw_img_readed": self.xanes_config_raw_img_readed,
                 "xanes2D_config_norm_scale_text_min": 0,
                 "xanes2D_config_norm_scale_text_val": 1,
                 "xanes2D_config_norm_scale_text_max": 10,
                 "xanes2D_config_smooth_flat_sigma_text.min": 0,
                 "xanes2D_config_smooth_flat_sigma_text.val": 0,
                 "xanes2D_config_smooth_flat_sigma_text.max": 30,
                 "xanes2D_config_eng_points_range_slider_min": 0,
@@ -218,87 +220,51 @@
                 "2D_roi_y_slider_min": 0,
                 "2D_roi_y_slider_val": 0,
                 "2D_roi_y_slider_max": 0,
                 "2D_roi": list(self.xanes_reg_roi),
                 "xanes2D_roi_configured": self.xanes_roi_configured,
             },
             "registration_config": {
-                "xanes2D_regparams_fiji_viewer":
-                True,
-                "xanes2D_regparams_use_chunk":
-                True,
-                "xanes2D_regparams_anchor_id":
-                0,
-                "xanes2D_regparams_use_mask":
-                True,
-                "xanes2D_regparams_mask_thres":
-                0,
-                "xanes2D_regparams_mask_dilation":
-                0,
-                "xanes2D_regparams_use_smooth_img":
-                False,
-                "xanes2D_regparams_smooth_sigma":
-                5,
-                "xanes2D_regparams_chunk_sz":
-                7,
-                "xanes2D_regparams_reg_method":
-                "MPC",
-                "xanes2D_regparams_ref_mode":
-                "single",
-                "xanes2D_regparams_anchor_id_slider_min":
-                0,
-                "xanes2D_regparams_anchor_id_slider_val":
-                0,
-                "xanes2D_regparams_anchor_id_slider_max":
-                0,
-                "xanes2D_regparams_mask_thres_slider_min":
-                0,
-                "xanes2D_regparams_mask_thres_slider_val":
-                0,
-                "xanes2D_regparams_mask_thres_slider_max":
-                0,
-                "xanes2D_regparams_mask_dilation_slider.min":
-                0,
-                "xanes2D_regparams_mask_dilation_slider.val":
-                0,
-                "xanes2D_regparams_mask_dilation_slider.max":
-                0,
-                "xanes2D_regparams_smooth_sigma_text.min":
-                0,
-                "xanes2D_regparams_smooth_sigma_text.val":
-                0,
-                "xanes2D_regparams_smooth_sigma_text.max":
-                0,
-                "xanes2D_regparams_chunk_sz_slider.min":
-                0,
-                "xanes2D_regparams_chunk_sz_slider.val":
-                0,
-                "xanes2D_regparams_chunk_sz_slider.max":
-                0,
-                "xanes2D_regparams_reg_method_dropdown_options":
-                ("MPC", "PC", "SR"),
-                "xanes2D_regparams_ref_mode_dropdown_options":
-                ("single", "neighbour"),
-                "xanes2D_regparams_mrtv_level":
-                4,
-                "xanes2D_regparams_mrtv_width":
-                10,
-                "xanes2D_regparams_mrtv_subpixel_kernel":
-                3,
-                "xanes2D_regparams_mrtv_subpixel_width":
-                8,
-                "xanes2D_regparams_configured":
-                self.xanes_reg_params_configured,
-            },
-            "run registration": {
-                "xanes2D_reg_done": self.xanes_reg_done
+                "xanes2D_regparams_fiji_viewer": True,
+                "xanes2D_regparams_use_chunk": True,
+                "xanes2D_regparams_anchor_id": 0,
+                "xanes2D_regparams_use_mask": True,
+                "xanes2D_regparams_mask_thres": 0,
+                "xanes2D_regparams_mask_dilation": 0,
+                "xanes2D_regparams_use_smooth_img": False,
+                "xanes2D_regparams_smooth_sigma": 5,
+                "xanes2D_regparams_chunk_sz": 7,
+                "xanes2D_regparams_reg_method": "MPC",
+                "xanes2D_regparams_ref_mode": "single",
+                "xanes2D_regparams_anchor_id_slider_min": 0,
+                "xanes2D_regparams_anchor_id_slider_val": 0,
+                "xanes2D_regparams_anchor_id_slider_max": 0,
+                "xanes2D_regparams_mask_thres_slider_min": 0,
+                "xanes2D_regparams_mask_thres_slider_val": 0,
+                "xanes2D_regparams_mask_thres_slider_max": 0,
+                "xanes2D_regparams_mask_dilation_slider.min": 0,
+                "xanes2D_regparams_mask_dilation_slider.val": 0,
+                "xanes2D_regparams_mask_dilation_slider.max": 0,
+                "xanes2D_regparams_smooth_sigma_text.min": 0,
+                "xanes2D_regparams_smooth_sigma_text.val": 0,
+                "xanes2D_regparams_smooth_sigma_text.max": 0,
+                "xanes2D_regparams_chunk_sz_slider.min": 0,
+                "xanes2D_regparams_chunk_sz_slider.val": 0,
+                "xanes2D_regparams_chunk_sz_slider.max": 0,
+                "xanes2D_regparams_reg_method_dropdown_options": ("MPC", "PC", "SR"),
+                "xanes2D_regparams_ref_mode_dropdown_options": ("single", "neighbour"),
+                "xanes2D_regparams_mrtv_level": 4,
+                "xanes2D_regparams_mrtv_width": 10,
+                "xanes2D_regparams_mrtv_subpixel_kernel": 3,
+                "xanes2D_regparams_mrtv_subpixel_width": 8,
+                "xanes2D_regparams_configured": self.xanes_reg_params_configured,
             },
+            "run registration": {"xanes2D_reg_done": self.xanes_reg_done},
             "review registration": {
-                "xanes2D_review_use_existing_reg_reviewed":
-                self.xanes_review_read_alignment_option,
+                "xanes2D_review_use_existing_reg_reviewed": self.xanes_review_read_alignment_option,
                 "xanes2D_reviewed_reg_shift": self.xanes_review_shift_dict,
                 "reg_pair_slider_min": 0,
                 "reg_pair_slider_val": 0,
                 "reg_pair_slider_max": 0,
                 "xshift_text_val": 0,
                 "yshift_text_val": 0,
                 "xanes2D_reg_review_done": self.xanes_reg_review_done,
@@ -306,26 +272,22 @@
             "align 2D recon": {
                 "xanes2D_alignment_done": self.xanes_alignment_done,
                 "xanes2D_analysis_edge_eng": self.xanes_fit_edge_eng,
                 "xanes2D_analysis_wl_fit_eng_s": self.xanes_fit_wl_fit_eng_s,
                 "xanes2D_analysis_wl_fit_eng_e": self.xanes_fit_wl_fit_eng_e,
                 "xanes2D_analysis_pre_edge_e": self.xanes_fit_pre_edge_e,
                 "xanes2D_analysis_post_edge_s": self.xanes_fit_post_edge_s,
-                "xanes2D_analysis_edge_0p5_fit_s":
-                self.xanes_fit_edge_0p5_fit_s,
-                "xanes2D_analysis_edge_0p5_fit_e":
-                self.xanes_fit_edge_0p5_fit_e,
+                "xanes2D_analysis_edge_0p5_fit_s": self.xanes_fit_edge_0p5_fit_s,
+                "xanes2D_analysis_edge_0p5_fit_e": self.xanes_fit_edge_0p5_fit_e,
                 "xanes2D_analysis_type": self.xanes_fit_type,
             },
         }
-        self.xanes_fit_gui_h = xfg.xanes_fitting_gui(self,
-                                                     form_sz=self.form_sz)
+        self.xanes_fit_gui_h = xfg.xanes_fitting_gui(self, form_sz=self.form_sz)
         self.xanes_fit_gui_h.build_gui()
-        self.xanes_ana_gui_h = xag.xanes_analysis_gui(self,
-                                                      form_sz=self.form_sz)
+        self.xanes_ana_gui_h = xag.xanes_analysis_gui(self, form_sz=self.form_sz)
         self.xanes_ana_gui_h.build_gui()
 
     def lock_message_text_boxes(self):
         boxes = [
             "SelRawH5Path text",
             "SelSaveTrial text",
             "CfmFile&Path text",
@@ -344,507 +306,529 @@
 
     def update_xanes2D_config(self):
         tem = {}
         for key, item in self.xanes_review_shift_dict.items():
             tem[key] = list(item)
         self.xanes_config = {
             "filepath config": {
-                "xanes2D_file_raw_h5_filename":
-                self.xanes_file_raw_h5_filename,
-                "xanes_save_trial_reg_filename":
-                self.xanes_save_trial_reg_filename,
-                "xanes2D_file_save_trial_reg_config_filename":
-                self.xanes_file_save_trial_reg_config_filename,
-                "xanes2D_review_reg_best_match_filename":
-                self.xanes_review_reg_best_match_filename,
-                "xanes2D_file_analysis_option":
-                self.xanes_file_analysis_option,
+                "xanes2D_file_raw_h5_filename": self.xanes_file_raw_h5_filename,
+                "xanes_save_trial_reg_filename": self.xanes_save_trial_reg_filename,
+                "xanes2D_file_save_trial_reg_config_filename": self.xanes_file_save_trial_reg_config_filename,
+                "xanes2D_review_reg_best_match_filename": self.xanes_review_reg_best_match_filename,
+                "xanes2D_file_analysis_option": self.xanes_file_analysis_option,
                 "xanes2D_file_configured": self.xanes_file_configured,
                 "xanes2D_file_raw_h5_set": self.xanes_file_raw_h5_set,
                 "xanes2D_file_save_trial_set": self.xanes_file_save_trial_set,
                 "xanes2D_file_reg_file_set": self.xanes_file_reg_file_set,
-                "xanes2D_file_config_file_set":
-                self.xanes_file_config_file_set,
-                "xanes2D_file_reg_file_readed":
-                self.xanes_file_reg_file_readed,
+                "xanes2D_file_config_file_set": self.xanes_file_config_file_set,
+                "xanes2D_file_reg_file_readed": self.xanes_file_reg_file_readed,
             },
             "data_config": {
-                "xanes2D_config_is_raw":
-                self.xanes_config_is_raw,
-                "xanes2D_config_img_scalar":
-                self.xanes_config_img_scalar,
-                "xanes2D_config_use_alternative_flat":
-                self.xanes_config_use_alternative_flat,
-                "xanes2D_config_use_smooth_flat":
-                self.xanes_config_use_smooth_flat,
-                "xanes2D_config_smooth_flat_sigma":
-                self.xanes_config_smooth_flat_sigma,
-                "xanes2D_config_alternative_flat_filename":
-                self.xanes_config_alternative_flat_filename,
-                "xanes2D_config_alternative_flat_set":
-                self.xanes_config_alternative_flat_set,
-                "xanes2D_config_eng_points_range_s":
-                self.xanes_eng_id_s,
-                "xanes2D_config_eng_points_range_e":
-                self.xanes_eng_id_e,
-                "xanes2D_config_eng_s":
-                self.hs["EngStart text"].value,
-                "xanes2D_config_eng_e":
-                self.hs["EngEnd text"].value,
-                "xanes2D_config_fiji_view_on":
-                self.hs["FijiRawImgPrev chbx"].value,
-                "xanes2D_config_img_num":
-                self.hs["FijiEngId sldr"].value,
-                "xanes2D_config_norm_scale_text_min":
-                self.hs["NormScale text"].min,
-                "xanes2D_config_norm_scale_text_val":
-                self.hs["NormScale text"].value,
-                "xanes2D_config_norm_scale_text_max":
-                self.hs["NormScale text"].max,
-                "xanes2D_config_eng_points_range_slider_min":
-                self.hs["EngPointsRange sldr"].min,
-                "xanes2D_config_eng_points_range_slider_val":
-                self.hs["EngPointsRange sldr"].value,
-                "xanes2D_config_eng_points_range_slider_max":
-                self.hs["EngPointsRange sldr"].max,
-                "xanes2D_config_eng_s_text_min":
-                self.hs["EngStart text"].min,
-                "xanes2D_config_eng_s_text_val":
-                self.hs["EngStart text"].value,
-                "xanes2D_config_eng_s_text_max":
-                self.hs["EngStart text"].max,
-                "xanes2D_config_eng_e_text_min":
-                self.hs["EngEnd text"].min,
-                "xanes2D_config_eng_e_text_val":
-                self.hs["EngEnd text"].value,
-                "xanes2D_config_eng_e_text_max":
-                self.hs["EngEnd text"].max,
-                "xanes2D_config_fiji_eng_id_slider_min":
-                self.hs["FijiEngId sldr"].min,
-                "xanes2D_config_fiji_eng_id_slider_val":
-                self.hs["FijiEngId sldr"].value,
-                "xanes2D_config_fiji_eng_id_slider_max":
-                self.hs["FijiEngId sldr"].max,
-                "xanes2D_config_raw_img_readed":
-                self.xanes_config_raw_img_readed,
-                "xanes2D_data_configured":
-                self.xanes_data_configured,
+                "xanes2D_config_is_raw": self.xanes_config_is_raw,
+                "xanes2D_config_img_scalar": self.xanes_config_img_scalar,
+                "xanes2D_config_use_alternative_flat": self.xanes_config_use_alternative_flat,
+                "xanes2D_config_use_smooth_flat": self.xanes_config_use_smooth_flat,
+                "xanes2D_config_smooth_flat_sigma": self.xanes_config_smooth_flat_sigma,
+                "xanes2D_config_alternative_flat_filename": self.xanes_config_alternative_flat_filename,
+                "xanes2D_config_alternative_flat_set": self.xanes_config_alternative_flat_set,
+                "xanes2D_config_eng_points_range_s": self.xanes_eng_id_s,
+                "xanes2D_config_eng_points_range_e": self.xanes_eng_id_e,
+                "xanes2D_config_eng_s": self.hs["EngStart text"].value,
+                "xanes2D_config_eng_e": self.hs["EngEnd text"].value,
+                "xanes2D_config_fiji_view_on": self.hs["FijiRawImgPrev chbx"].value,
+                "xanes2D_config_img_num": self.hs["FijiEngId sldr"].value,
+                "xanes2D_config_norm_scale_text_min": self.hs["NormScale text"].min,
+                "xanes2D_config_norm_scale_text_val": self.hs["NormScale text"].value,
+                "xanes2D_config_norm_scale_text_max": self.hs["NormScale text"].max,
+                "xanes2D_config_eng_points_range_slider_min": self.hs[
+                    "EngPointsRange sldr"
+                ].min,
+                "xanes2D_config_eng_points_range_slider_val": self.hs[
+                    "EngPointsRange sldr"
+                ].value,
+                "xanes2D_config_eng_points_range_slider_max": self.hs[
+                    "EngPointsRange sldr"
+                ].max,
+                "xanes2D_config_eng_s_text_min": self.hs["EngStart text"].min,
+                "xanes2D_config_eng_s_text_val": self.hs["EngStart text"].value,
+                "xanes2D_config_eng_s_text_max": self.hs["EngStart text"].max,
+                "xanes2D_config_eng_e_text_min": self.hs["EngEnd text"].min,
+                "xanes2D_config_eng_e_text_val": self.hs["EngEnd text"].value,
+                "xanes2D_config_eng_e_text_max": self.hs["EngEnd text"].max,
+                "xanes2D_config_fiji_eng_id_slider_min": self.hs["FijiEngId sldr"].min,
+                "xanes2D_config_fiji_eng_id_slider_val": self.hs[
+                    "FijiEngId sldr"
+                ].value,
+                "xanes2D_config_fiji_eng_id_slider_max": self.hs["FijiEngId sldr"].max,
+                "xanes2D_config_raw_img_readed": self.xanes_config_raw_img_readed,
+                "xanes2D_data_configured": self.xanes_data_configured,
             },
             "roi_config": {
                 "2D_roi_x_slider_min": self.hs["2DRoiX sldr"].min,
                 "2D_roi_x_slider_val": self.hs["2DRoiX sldr"].value,
                 "2D_roi_x_slider_max": self.hs["2DRoiX sldr"].max,
                 "2D_roi_y_slider_min": self.hs["2DRoiY sldr"].min,
                 "2D_roi_y_slider_val": self.hs["2DRoiY sldr"].value,
                 "2D_roi_y_slider_max": self.hs["2DRoiY sldr"].max,
                 "2D_roi": list(self.xanes_reg_roi),
                 "xanes2D_roi_configured": self.xanes_roi_configured,
             },
             "registration_config": {
-                "xanes2D_regparams_fiji_viewer":
-                self.hs["FijiMaskViewer chbx"].value,
-                "xanes2D_regparams_use_chunk":
-                self.hs["UseChunk chbx"].value,
-                "xanes2D_regparams_anchor_id":
-                self.hs["AnchorId sldr"].value,
-                "xanes2D_regparams_use_mask":
-                self.hs["UseMask chbx"].value,
-                "xanes2D_regparams_mask_thres":
-                self.hs["MaskThres sldr"].value,
-                "xanes2D_regparams_mask_dilation":
-                self.hs["MaskDilation sldr"].value,
-                "xanes2D_regparams_use_smooth_img":
-                self.hs["UseSmooth chbx"].value,
-                "xanes2D_regparams_smooth_sigma":
-                self.hs["SmoothSigma text"].value,
-                "xanes2D_regparams_chunk_sz":
-                self.hs["ChunkSz sldr"].value,
-                "xanes2D_regparams_reg_method":
-                self.hs["RegMethod drpdn"].value,
-                "xanes2D_regparams_ref_mode":
-                self.hs["RefMode drpdn"].value,
-                "xanes2D_regparams_anchor_id_slider_min":
-                self.hs["AnchorId sldr"].min,
-                "xanes2D_regparams_anchor_id_slider_val":
-                self.hs["AnchorId sldr"].value,
-                "xanes2D_regparams_anchor_id_slider_max":
-                self.hs["AnchorId sldr"].max,
-                "xanes2D_regparams_mask_thres_slider_min":
-                self.hs["MaskThres sldr"].min,
-                "xanes2D_regparams_mask_thres_slider_val":
-                self.hs["MaskThres sldr"].value,
-                "xanes2D_regparams_mask_thres_slider_max":
-                self.hs["MaskThres sldr"].max,
-                "xanes2D_regparams_mask_dilation_slider.min":
-                self.hs["MaskDilation sldr"].min,
-                "xanes2D_regparams_mask_dilation_slider.val":
-                self.hs["MaskDilation sldr"].value,
-                "xanes2D_regparams_mask_dilation_slider.max":
-                self.hs["MaskDilation sldr"].max,
-                "xanes2D_regparams_smooth_sigma_text.min":
-                self.hs["SmoothSigma text"].min,
-                "xanes2D_regparams_smooth_sigma_text.val":
-                self.hs["SmoothSigma text"].value,
-                "xanes2D_regparams_smooth_sigma_text.max":
-                self.hs["SmoothSigma text"].max,
-                "xanes2D_regparams_chunk_sz_slider.min":
-                self.hs["ChunkSz sldr"].min,
-                "xanes2D_regparams_chunk_sz_slider.val":
-                self.hs["ChunkSz sldr"].value,
-                "xanes2D_regparams_chunk_sz_slider.max":
-                self.hs["ChunkSz sldr"].max,
+                "xanes2D_regparams_fiji_viewer": self.hs["FijiMaskViewer chbx"].value,
+                "xanes2D_regparams_use_chunk": self.hs["UseChunk chbx"].value,
+                "xanes2D_regparams_anchor_id": self.hs["AnchorId sldr"].value,
+                "xanes2D_regparams_use_mask": self.hs["UseMask chbx"].value,
+                "xanes2D_regparams_mask_thres": self.hs["MaskThres sldr"].value,
+                "xanes2D_regparams_mask_dilation": self.hs["MaskDilation sldr"].value,
+                "xanes2D_regparams_use_smooth_img": self.hs["UseSmooth chbx"].value,
+                "xanes2D_regparams_smooth_sigma": self.hs["SmoothSigma text"].value,
+                "xanes2D_regparams_chunk_sz": self.hs["ChunkSz sldr"].value,
+                "xanes2D_regparams_reg_method": self.hs["RegMethod drpdn"].value,
+                "xanes2D_regparams_ref_mode": self.hs["RefMode drpdn"].value,
+                "xanes2D_regparams_anchor_id_slider_min": self.hs["AnchorId sldr"].min,
+                "xanes2D_regparams_anchor_id_slider_val": self.hs[
+                    "AnchorId sldr"
+                ].value,
+                "xanes2D_regparams_anchor_id_slider_max": self.hs["AnchorId sldr"].max,
+                "xanes2D_regparams_mask_thres_slider_min": self.hs[
+                    "MaskThres sldr"
+                ].min,
+                "xanes2D_regparams_mask_thres_slider_val": self.hs[
+                    "MaskThres sldr"
+                ].value,
+                "xanes2D_regparams_mask_thres_slider_max": self.hs[
+                    "MaskThres sldr"
+                ].max,
+                "xanes2D_regparams_mask_dilation_slider.min": self.hs[
+                    "MaskDilation sldr"
+                ].min,
+                "xanes2D_regparams_mask_dilation_slider.val": self.hs[
+                    "MaskDilation sldr"
+                ].value,
+                "xanes2D_regparams_mask_dilation_slider.max": self.hs[
+                    "MaskDilation sldr"
+                ].max,
+                "xanes2D_regparams_smooth_sigma_text.min": self.hs[
+                    "SmoothSigma text"
+                ].min,
+                "xanes2D_regparams_smooth_sigma_text.val": self.hs[
+                    "SmoothSigma text"
+                ].value,
+                "xanes2D_regparams_smooth_sigma_text.max": self.hs[
+                    "SmoothSigma text"
+                ].max,
+                "xanes2D_regparams_chunk_sz_slider.min": self.hs["ChunkSz sldr"].min,
+                "xanes2D_regparams_chunk_sz_slider.val": self.hs["ChunkSz sldr"].value,
+                "xanes2D_regparams_chunk_sz_slider.max": self.hs["ChunkSz sldr"].max,
                 # "xanes2D_regparams_reg_method_dropdown_options":self.hs['RegMethod drpdn'].options,
-                "xanes2D_regparams_ref_mode_dropdown_options":
-                self.hs["RefMode drpdn"].options,
-                "xanes2D_regparams_mrtv_level":
-                self.hs["MrtvLevel text"].value,
-                "xanes2D_regparams_mrtv_width":
-                self.hs["MrtvWz text"].value,
-                "xanes2D_regparams_mrtv_subpixel_kernel":
-                self.hs["MrtvSubpixelKernel text"].value,
-                "xanes2D_regparams_mrtv_subpixel_width":
-                self.hs["MrtvSubpixelWz text"].value,
-                "xanes2D_regparams_configured":
-                self.xanes_reg_params_configured,
-            },
-            "run registration": {
-                "xanes2D_reg_done": self.xanes_reg_done
+                "xanes2D_regparams_ref_mode_dropdown_options": self.hs[
+                    "RefMode drpdn"
+                ].options,
+                "xanes2D_regparams_mrtv_level": self.hs["MrtvLevel text"].value,
+                "xanes2D_regparams_mrtv_width": self.hs["MrtvWz text"].value,
+                "xanes2D_regparams_mrtv_subpixel_kernel": self.hs[
+                    "MrtvSubpixelKernel text"
+                ].value,
+                "xanes2D_regparams_mrtv_subpixel_width": self.hs[
+                    "MrtvSubpixelWz text"
+                ].value,
+                "xanes2D_regparams_configured": self.xanes_reg_params_configured,
             },
+            "run registration": {"xanes2D_reg_done": self.xanes_reg_done},
             "review registration": {
-                "xanes2D_review_use_existing_reg_reviewed":
-                self.hs["ReadAlign chbx"].value,
-                "xanes2D_reviewed_reg_shift":
-                tem,
-                "reg_pair_slider_min":
-                self.hs["RegPair sldr"].min,
-                "reg_pair_slider_val":
-                self.hs["RegPair sldr"].value,
-                "reg_pair_slider_max":
-                self.hs["RegPair sldr"].max,
-                "xshift_text_val":
-                self.hs["XShift text"].value,
-                "yshift_text_val":
-                self.hs["YShift text"].value,
-                "xanes2D_reg_review_done":
-                self.xanes_reg_review_done,
+                "xanes2D_review_use_existing_reg_reviewed": self.hs[
+                    "ReadAlign chbx"
+                ].value,
+                "xanes2D_reviewed_reg_shift": tem,
+                "reg_pair_slider_min": self.hs["RegPair sldr"].min,
+                "reg_pair_slider_val": self.hs["RegPair sldr"].value,
+                "reg_pair_slider_max": self.hs["RegPair sldr"].max,
+                "xshift_text_val": self.hs["XShift text"].value,
+                "yshift_text_val": self.hs["YShift text"].value,
+                "xanes2D_reg_review_done": self.xanes_reg_review_done,
             },
             "align 2D recon": {
                 "xanes2D_alignment_done": self.xanes_alignment_done,
                 "xanes2D_analysis_edge_eng": self.xanes_fit_edge_eng,
                 "xanes2D_analysis_wl_fit_eng_s": self.xanes_fit_wl_fit_eng_s,
                 "xanes2D_analysis_wl_fit_eng_e": self.xanes_fit_wl_fit_eng_e,
                 "xanes2D_analysis_pre_edge_e": self.xanes_fit_pre_edge_e,
                 "xanes2D_analysis_post_edge_s": self.xanes_fit_post_edge_s,
-                "xanes2D_analysis_edge_0p5_fit_s":
-                self.xanes_fit_edge_0p5_fit_s,
-                "xanes2D_analysis_edge_0p5_fit_e":
-                self.xanes_fit_edge_0p5_fit_e,
+                "xanes2D_analysis_edge_0p5_fit_s": self.xanes_fit_edge_0p5_fit_s,
+                "xanes2D_analysis_edge_0p5_fit_e": self.xanes_fit_edge_0p5_fit_e,
                 "xanes2D_analysis_type": self.xanes_fit_type,
             },
         }
 
     def read_xanes2D_config(self):
-        with open(self.xanes_file_save_trial_reg_config_filename_original,
-                  "r") as f:
+        with open(self.xanes_file_save_trial_reg_config_filename_original, "r") as f:
             self.xanes_config = json.load(f)
 
     def set_xanes2D_variables(self):
         self.xanes_file_raw_h5_filename = self.xanes_config["filepath config"][
-            "xanes2D_file_raw_h5_filename"]
-        self.xanes_save_trial_reg_filename = self.xanes_config[
-            "filepath config"]["xanes_save_trial_reg_filename"]
+            "xanes2D_file_raw_h5_filename"
+        ]
+        self.xanes_save_trial_reg_filename = self.xanes_config["filepath config"][
+            "xanes_save_trial_reg_filename"
+        ]
         self.xanes_review_reg_best_match_filename = self.xanes_config[
-            "filepath config"]["xanes2D_review_reg_best_match_filename"]
+            "filepath config"
+        ]["xanes2D_review_reg_best_match_filename"]
         self.xanes_file_raw_h5_set = self.xanes_config["filepath config"][
-            "xanes2D_file_raw_h5_set"]
+            "xanes2D_file_raw_h5_set"
+        ]
         self.xanes_file_save_trial_set = self.xanes_config["filepath config"][
-            "xanes2D_file_save_trial_set"]
+            "xanes2D_file_save_trial_set"
+        ]
         self.xanes_file_reg_file_set = self.xanes_config["filepath config"][
-            "xanes2D_file_reg_file_set"]
+            "xanes2D_file_reg_file_set"
+        ]
         self.xanes_file_config_file_set = self.xanes_config["filepath config"][
-            "xanes2D_file_config_file_set"]
+            "xanes2D_file_config_file_set"
+        ]
         self.xanes_file_configured = self.xanes_config["filepath config"][
-            "xanes2D_file_configured"]
+            "xanes2D_file_configured"
+        ]
 
         self.xanes_config_is_raw = self.xanes_config["data_config"][
-            "xanes2D_config_is_raw"]
+            "xanes2D_config_is_raw"
+        ]
         self.xanes_config_img_scalar = self.xanes_config["data_config"][
-            "xanes2D_config_img_scalar"]
-        self.xanes_config_use_alternative_flat = self.xanes_config[
-            "data_config"]["xanes2D_config_use_alternative_flat"]
+            "xanes2D_config_img_scalar"
+        ]
+        self.xanes_config_use_alternative_flat = self.xanes_config["data_config"][
+            "xanes2D_config_use_alternative_flat"
+        ]
         self.xanes_config_use_smooth_flat = self.xanes_config["data_config"][
-            "xanes2D_config_use_smooth_flat"]
+            "xanes2D_config_use_smooth_flat"
+        ]
         self.xanes_config_smooth_flat_sigma = self.xanes_config["data_config"][
-            "xanes2D_config_smooth_flat_sigma"]
-        self.xanes_config_alternative_flat_filename = self.xanes_config[
-            "data_config"]["xanes2D_config_alternative_flat_filename"]
-        self.xanes_config_alternative_flat_set = self.xanes_config[
-            "data_config"]["xanes2D_config_alternative_flat_set"]
+            "xanes2D_config_smooth_flat_sigma"
+        ]
+        self.xanes_config_alternative_flat_filename = self.xanes_config["data_config"][
+            "xanes2D_config_alternative_flat_filename"
+        ]
+        self.xanes_config_alternative_flat_set = self.xanes_config["data_config"][
+            "xanes2D_config_alternative_flat_set"
+        ]
         self.xanes_eng_id_s = self.xanes_config["data_config"][
-            "xanes2D_config_eng_points_range_s"]
+            "xanes2D_config_eng_points_range_s"
+        ]
         self.xanes_eng_id_e = self.xanes_config["data_config"][
-            "xanes2D_config_eng_points_range_e"]
+            "xanes2D_config_eng_points_range_e"
+        ]
         self.xanes_config_raw_img_readed = self.xanes_config["data_config"][
-            "xanes2D_config_raw_img_readed"]
+            "xanes2D_config_raw_img_readed"
+        ]
         self.xanes_data_configured = self.xanes_config["data_config"][
-            "xanes2D_data_configured"]
+            "xanes2D_data_configured"
+        ]
 
         self.xanes_reg_roi = self.xanes_config["roi_config"]["2D_roi"]
         self.xanes_roi_configured = self.xanes_config["roi_config"][
-            "xanes2D_roi_configured"]
+            "xanes2D_roi_configured"
+        ]
         self.xanes_reg_use_chunk = self.xanes_config["registration_config"][
-            "xanes2D_regparams_use_chunk"]
+            "xanes2D_regparams_use_chunk"
+        ]
         self.xanes_reg_anchor_idx = self.xanes_config["registration_config"][
-            "xanes2D_regparams_anchor_id"]
+            "xanes2D_regparams_anchor_id"
+        ]
         self.xanes_reg_use_mask = self.xanes_config["registration_config"][
-            "xanes2D_regparams_use_mask"]
+            "xanes2D_regparams_use_mask"
+        ]
         self.xanes_reg_mask_thres = self.xanes_config["registration_config"][
-            "xanes2D_regparams_mask_thres"]
-        self.xanes_reg_mask_dilation_width = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mask_dilation"]
-        self.xanes_reg_use_smooth_img = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_use_smooth_img"]
-        self.xanes_reg_smooth_img_sigma = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_smooth_sigma"]
+            "xanes2D_regparams_mask_thres"
+        ]
+        self.xanes_reg_mask_dilation_width = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_dilation"
+        ]
+        self.xanes_reg_use_smooth_img = self.xanes_config["registration_config"][
+            "xanes2D_regparams_use_smooth_img"
+        ]
+        self.xanes_reg_smooth_img_sigma = self.xanes_config["registration_config"][
+            "xanes2D_regparams_smooth_sigma"
+        ]
         self.xanes_reg_chunk_sz = self.xanes_config["registration_config"][
-            "xanes2D_regparams_chunk_sz"]
+            "xanes2D_regparams_chunk_sz"
+        ]
         self.xanes_reg_method = self.xanes_config["registration_config"][
-            "xanes2D_regparams_reg_method"]
+            "xanes2D_regparams_reg_method"
+        ]
         self.xanes_reg_ref_mode = self.xanes_config["registration_config"][
-            "xanes2D_regparams_ref_mode"]
+            "xanes2D_regparams_ref_mode"
+        ]
 
         self.xanes_reg_mrtv_level = self.xanes_config["registration_config"][
-            "xanes2D_regparams_mrtv_level"]
+            "xanes2D_regparams_mrtv_level"
+        ]
         self.xanes_reg_mrtv_width = self.xanes_config["registration_config"][
-            "xanes2D_regparams_mrtv_width"]
-        self.xanes_reg_mrtv_subpixel_kernel = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mrtv_subpixel_kernel"]
-        self.xanes_reg_mrtv_subpixel_wz = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mrtv_subpixel_width"]
-        self.xanes_reg_params_configured = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_configured"]
+            "xanes2D_regparams_mrtv_width"
+        ]
+        self.xanes_reg_mrtv_subpixel_kernel = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mrtv_subpixel_kernel"
+        ]
+        self.xanes_reg_mrtv_subpixel_wz = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mrtv_subpixel_width"
+        ]
+        self.xanes_reg_params_configured = self.xanes_config["registration_config"][
+            "xanes2D_regparams_configured"
+        ]
 
-        self.xanes_reg_done = self.xanes_config["run registration"][
-            "xanes2D_reg_done"]
+        self.xanes_reg_done = self.xanes_config["run registration"]["xanes2D_reg_done"]
 
         self.xanes_review_read_alignment_option = self.xanes_config[
-            "review registration"]["xanes2D_review_use_existing_reg_reviewed"]
-        tem = self.xanes_config["review registration"][
-            "xanes2D_reviewed_reg_shift"]
+            "review registration"
+        ]["xanes2D_review_use_existing_reg_reviewed"]
+        tem = self.xanes_config["review registration"]["xanes2D_reviewed_reg_shift"]
         self.xanes_review_shift_dict = {}
         for key, item in tem.items():
             self.xanes_review_shift_dict[key] = np.array(item)
         self.xanes_reg_review_done = self.xanes_config["review registration"][
-            "xanes2D_reg_review_done"]
+            "xanes2D_reg_review_done"
+        ]
 
         self.xanes_alignment_done = self.xanes_config["align 2D recon"][
-            "xanes2D_alignment_done"]
+            "xanes2D_alignment_done"
+        ]
         self.xanes_fit_edge_eng = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_edge_eng"]
+            "xanes2D_analysis_edge_eng"
+        ]
         self.xanes_fit_wl_fit_eng_s = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_wl_fit_eng_s"]
+            "xanes2D_analysis_wl_fit_eng_s"
+        ]
         self.xanes_fit_wl_fit_eng_e = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_wl_fit_eng_e"]
+            "xanes2D_analysis_wl_fit_eng_e"
+        ]
         self.xanes_fit_pre_edge_e = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_pre_edge_e"]
+            "xanes2D_analysis_pre_edge_e"
+        ]
         self.xanes_fit_post_edge_s = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_post_edge_s"]
+            "xanes2D_analysis_post_edge_s"
+        ]
         self.xanes_fit_edge_0p5_fit_s = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_edge_0p5_fit_s"]
+            "xanes2D_analysis_edge_0p5_fit_s"
+        ]
         self.xanes_fit_edge_0p5_fit_e = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_edge_0p5_fit_e"]
+            "xanes2D_analysis_edge_0p5_fit_e"
+        ]
         self.xanes_fit_type = self.xanes_config["align 2D recon"][
-            "xanes2D_analysis_type"]
+            "xanes2D_analysis_type"
+        ]
 
     def set_xanes2D_handles(self):
         self.hs["IsRaw chbx"].value = self.xanes_config_is_raw
 
         self.hs["NormScale text"].value = self.xanes_config_img_scalar
         self.hs["EngPointsRange sldr"].max = self.xanes_config["data_config"][
-            "xanes2D_config_eng_points_range_slider_max"]
+            "xanes2D_config_eng_points_range_slider_max"
+        ]
         self.hs["EngPointsRange sldr"].min = self.xanes_config["data_config"][
-            "xanes2D_config_eng_points_range_slider_min"]
-        self.hs["EngPointsRange sldr"].value = self.xanes_config[
-            "data_config"]["xanes2D_config_eng_points_range_slider_val"]
+            "xanes2D_config_eng_points_range_slider_min"
+        ]
+        self.hs["EngPointsRange sldr"].value = self.xanes_config["data_config"][
+            "xanes2D_config_eng_points_range_slider_val"
+        ]
         self.hs["EngStart text"].max = self.xanes_config["data_config"][
-            "xanes2D_config_eng_s_text_max"]
+            "xanes2D_config_eng_s_text_max"
+        ]
         self.hs["EngStart text"].min = self.xanes_config["data_config"][
-            "xanes2D_config_eng_s_text_min"]
+            "xanes2D_config_eng_s_text_min"
+        ]
         self.hs["EngStart text"].value = self.xanes_config["data_config"][
-            "xanes2D_config_eng_s_text_val"]
+            "xanes2D_config_eng_s_text_val"
+        ]
         self.hs["EngEnd text"].max = self.xanes_config["data_config"][
-            "xanes2D_config_eng_e_text_max"]
+            "xanes2D_config_eng_e_text_max"
+        ]
         self.hs["EngEnd text"].min = self.xanes_config["data_config"][
-            "xanes2D_config_eng_e_text_min"]
+            "xanes2D_config_eng_e_text_min"
+        ]
         self.hs["EngEnd text"].value = self.xanes_config["data_config"][
-            "xanes2D_config_eng_e_text_val"]
+            "xanes2D_config_eng_e_text_val"
+        ]
         self.hs["FijiEngId sldr"].max = self.xanes_config["data_config"][
-            "xanes2D_config_fiji_eng_id_slider_max"]
+            "xanes2D_config_fiji_eng_id_slider_max"
+        ]
         self.hs["FijiEngId sldr"].min = self.xanes_config["data_config"][
-            "xanes2D_config_fiji_eng_id_slider_min"]
+            "xanes2D_config_fiji_eng_id_slider_min"
+        ]
         self.hs["FijiEngId sldr"].value = self.xanes_config["data_config"][
-            "xanes2D_config_fiji_eng_id_slider_val"]
+            "xanes2D_config_fiji_eng_id_slider_val"
+        ]
 
         self.hs["2DRoiX sldr"].max = self.xanes_config["roi_config"][
-            "2D_roi_x_slider_max"]
+            "2D_roi_x_slider_max"
+        ]
         self.hs["2DRoiX sldr"].min = self.xanes_config["roi_config"][
-            "2D_roi_x_slider_min"]
+            "2D_roi_x_slider_min"
+        ]
         self.hs["2DRoiX sldr"].value = self.xanes_config["roi_config"][
-            "2D_roi_x_slider_val"]
+            "2D_roi_x_slider_val"
+        ]
         self.hs["2DRoiY sldr"].max = self.xanes_config["roi_config"][
-            "2D_roi_y_slider_max"]
+            "2D_roi_y_slider_max"
+        ]
         self.hs["2DRoiY sldr"].min = self.xanes_config["roi_config"][
-            "2D_roi_y_slider_min"]
+            "2D_roi_y_slider_min"
+        ]
         self.hs["2DRoiY sldr"].value = self.xanes_config["roi_config"][
-            "2D_roi_y_slider_val"]
+            "2D_roi_y_slider_val"
+        ]
 
-        self.hs["AnchorId sldr"].max = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_anchor_id_slider_max"]
-        self.hs["AnchorId sldr"].min = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_anchor_id_slider_min"]
-        self.hs["AnchorId sldr"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_anchor_id_slider_val"]
-        self.hs["UseMask chbx"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_use_mask"]
-        self.hs["MaskThres sldr"].max = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mask_thres_slider_max"]
-        self.hs["MaskThres sldr"].min = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mask_thres_slider_min"]
-        self.hs["MaskThres sldr"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mask_thres_slider_val"]
-        self.hs["MaskDilation sldr"].max = self.xanes_config[
-            "registration_config"][
-                "xanes2D_regparams_mask_dilation_slider.max"]
-        self.hs["MaskDilation sldr"].min = self.xanes_config[
-            "registration_config"][
-                "xanes2D_regparams_mask_dilation_slider.min"]
-        self.hs["MaskDilation sldr"].value = self.xanes_config[
-            "registration_config"][
-                "xanes2D_regparams_mask_dilation_slider.val"]
-        self.hs["UseSmooth chbx"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_use_smooth_img"]
-        self.hs["SmoothSigma text"].max = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_smooth_sigma_text.max"]
-        self.hs["SmoothSigma text"].min = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_smooth_sigma_text.min"]
-        self.hs["SmoothSigma text"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_smooth_sigma_text.val"]
+        self.hs["AnchorId sldr"].max = self.xanes_config["registration_config"][
+            "xanes2D_regparams_anchor_id_slider_max"
+        ]
+        self.hs["AnchorId sldr"].min = self.xanes_config["registration_config"][
+            "xanes2D_regparams_anchor_id_slider_min"
+        ]
+        self.hs["AnchorId sldr"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_anchor_id_slider_val"
+        ]
+        self.hs["UseMask chbx"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_use_mask"
+        ]
+        self.hs["MaskThres sldr"].max = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_thres_slider_max"
+        ]
+        self.hs["MaskThres sldr"].min = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_thres_slider_min"
+        ]
+        self.hs["MaskThres sldr"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_thres_slider_val"
+        ]
+        self.hs["MaskDilation sldr"].max = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_dilation_slider.max"
+        ]
+        self.hs["MaskDilation sldr"].min = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_dilation_slider.min"
+        ]
+        self.hs["MaskDilation sldr"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mask_dilation_slider.val"
+        ]
+        self.hs["UseSmooth chbx"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_use_smooth_img"
+        ]
+        self.hs["SmoothSigma text"].max = self.xanes_config["registration_config"][
+            "xanes2D_regparams_smooth_sigma_text.max"
+        ]
+        self.hs["SmoothSigma text"].min = self.xanes_config["registration_config"][
+            "xanes2D_regparams_smooth_sigma_text.min"
+        ]
+        self.hs["SmoothSigma text"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_smooth_sigma_text.val"
+        ]
         self.hs["ChunkSz sldr"].max = self.xanes_config["registration_config"][
-            "xanes2D_regparams_chunk_sz_slider.max"]
+            "xanes2D_regparams_chunk_sz_slider.max"
+        ]
         self.hs["ChunkSz sldr"].min = self.xanes_config["registration_config"][
-            "xanes2D_regparams_chunk_sz_slider.min"]
-        self.hs["ChunkSz sldr"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_chunk_sz_slider.val"]
-        self.hs["RegMethod drpdn"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_reg_method"]
-        self.hs["RefMode drpdn"].options = self.xanes_config[
-            "registration_config"][
-                "xanes2D_regparams_ref_mode_dropdown_options"]
-        self.hs["RefMode drpdn"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_ref_mode"]
-        self.hs["MrtvLevel text"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mrtv_level"]
-        self.hs["MrtvWz text"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mrtv_width"]
-        self.hs["MrtvSubpixelWz text"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mrtv_subpixel_width"]
+            "xanes2D_regparams_chunk_sz_slider.min"
+        ]
+        self.hs["ChunkSz sldr"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_chunk_sz_slider.val"
+        ]
+        self.hs["RegMethod drpdn"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_reg_method"
+        ]
+        self.hs["RefMode drpdn"].options = self.xanes_config["registration_config"][
+            "xanes2D_regparams_ref_mode_dropdown_options"
+        ]
+        self.hs["RefMode drpdn"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_ref_mode"
+        ]
+        self.hs["MrtvLevel text"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mrtv_level"
+        ]
+        self.hs["MrtvWz text"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mrtv_width"
+        ]
+        self.hs["MrtvSubpixelWz text"].value = self.xanes_config["registration_config"][
+            "xanes2D_regparams_mrtv_subpixel_width"
+        ]
         self.hs["MrtvSubpixelKernel text"].value = self.xanes_config[
-            "registration_config"]["xanes2D_regparams_mrtv_subpixel_kernel"]
+            "registration_config"
+        ]["xanes2D_regparams_mrtv_subpixel_kernel"]
 
         self.hs["RegPair sldr"].max = self.xanes_config["review registration"][
-            "reg_pair_slider_max"]
+            "reg_pair_slider_max"
+        ]
         self.hs["RegPair sldr"].min = self.xanes_config["review registration"][
-            "reg_pair_slider_min"]
-        self.hs["RegPair sldr"].value = self.xanes_config[
-            "review registration"]["reg_pair_slider_val"]
-        self.hs["XShift text"].value = self.xanes_config[
-            "review registration"]["xshift_text_val"]
-        self.hs["YShift text"].value = self.xanes_config[
-            "review registration"]["yshift_text_val"]
-
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagOptn drpdn"].value = self.xanes_config["align 2D recon"][
-                "xanes2D_analysis_type"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagEdgeEng text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_edge_eng"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagPreEdgeEnd text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_pre_edge_e"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagPostEdgeStr text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_post_edge_s"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagWlFitStr text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_wl_fit_eng_s"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagWlFitEnd text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_wl_fit_eng_e"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagEdge0.5Str text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_edge_0p5_fit_s"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagEdge0.5End text"].value = self.xanes_config[
-                "align 2D recon"]["xanes2D_analysis_edge_0p5_fit_e"]
+            "reg_pair_slider_min"
+        ]
+        self.hs["RegPair sldr"].value = self.xanes_config["review registration"][
+            "reg_pair_slider_val"
+        ]
+        self.hs["XShift text"].value = self.xanes_config["review registration"][
+            "xshift_text_val"
+        ]
+        self.hs["YShift text"].value = self.xanes_config["review registration"][
+            "yshift_text_val"
+        ]
+
+        self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_type"]
+        self.xanes_fit_gui_h.hs["FitEngRagEdgeEng text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_edge_eng"]
+        self.xanes_fit_gui_h.hs["FitEngRagPreEdgeEnd text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_pre_edge_e"]
+        self.xanes_fit_gui_h.hs["FitEngRagPostEdgeStr text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_post_edge_s"]
+        self.xanes_fit_gui_h.hs["FitEngRagWlFitStr text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_wl_fit_eng_s"]
+        self.xanes_fit_gui_h.hs["FitEngRagWlFitEnd text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_wl_fit_eng_e"]
+        self.xanes_fit_gui_h.hs["FitEngRagEdge0.5Str text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_edge_0p5_fit_s"]
+        self.xanes_fit_gui_h.hs["FitEngRagEdge0.5End text"].value = self.xanes_config[
+            "align 2D recon"
+        ]["xanes2D_analysis_edge_0p5_fit_e"]
 
     def boxes_logic(self):
 
         def xanes2D_compound_logic():
             if self.xanes_file_analysis_option == "Reg By Shift":
                 if self.xanes_roi_configured:
                     boxes = ["RevRegRlt box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                     self.hs["ReadAlign chbx"].disabled = True
                     self.hs["ReadAlign btn"].disabled = False
                 else:
                     boxes = ["RevRegRlt box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 if self.xanes_reg_file_readed:
                     self.hs["CfmRevRlt btn"].disabled = False
             else:
-                if (self.xanes_reg_done and (not self.xanes_reg_file_readed)
-                        and self.hs["ReadAlign chbx"].value):
+                if (
+                    self.xanes_reg_done
+                    and (not self.xanes_reg_file_readed)
+                    and self.hs["ReadAlign chbx"].value
+                ):
                     boxes = ["RegPair box", "CorrSht box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                     self.hs["ReadAlign btn"].disabled = False
-                elif self.xanes_reg_done and (
-                        not self.hs["ReadAlign chbx"].value):
+                elif self.xanes_reg_done and (not self.hs["ReadAlign chbx"].value):
                     boxes = ["RegPair box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                     boxes = ["CorrSht box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                     self.hs["ReadAlign btn"].disabled = True
 
                 if not self.xanes_review_bad_shift:
                     boxes = ["CorrSht box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 else:
                     boxes = ["CorrSht box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
 
             if self.xanes_config_raw_img_readed:
                 boxes = ["EngRange box", "Fiji box", "ConfigDataCfm box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             else:
                 boxes = ["EngRange box", "Fiji box", "ConfigDataCfm box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
@@ -911,290 +895,266 @@
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
 
             if self.hs["MrtvSubpixelSrch drpdn"].value == "analytical":
                 self.hs["MrtvSubpixelWz text"].disabled = True
             else:
                 self.hs["MrtvSubpixelWz text"].disabled = False
 
-        if self.xanes_file_analysis_option in [
-                "Do New Reg", "Read Config File"
-        ]:
+        if self.xanes_file_analysis_option in ["Do New Reg", "Read Config File"]:
             if not self.xanes_file_configured:
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignImg box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif self.xanes_file_configured & (not self.xanes_data_configured):
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignImg box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = ["DataPrepOptions box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             elif (self.xanes_file_configured & self.xanes_data_configured) & (
-                    not self.xanes_roi_configured):
+                not self.xanes_roi_configured
+            ):
                 boxes = [
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignImg box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = ["ConfigData box", "2DRoi box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-            elif ((self.xanes_file_configured & self.xanes_data_configured)
-                  & self.xanes_roi_configured
-                  & (not self.xanes_reg_params_configured)):
-                boxes = [
-                    "RunReg box", "RevRegRlt box", "AlignImg box", "VisImg box"
-                ]
+            elif (
+                (self.xanes_file_configured & self.xanes_data_configured)
+                & self.xanes_roi_configured
+                & (not self.xanes_reg_params_configured)
+            ):
+                boxes = ["RunReg box", "RevRegRlt box", "AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = ["ConfigData box", "2DRoi box", "ConfigRegParams box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             elif (
                 (self.xanes_file_configured & self.xanes_data_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (not self.xanes_reg_done)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (not self.xanes_reg_done)
+            ):
                 boxes = ["RevRegRlt box", "AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             elif (
                 (self.xanes_file_configured & self.xanes_data_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done &
-                       (not self.xanes_reg_review_done))):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & (not self.xanes_reg_review_done))
+            ):
                 boxes = ["AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             elif (
                 (self.xanes_file_configured & self.xanes_data_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    & (not self.xanes_alignment_done)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (not self.xanes_alignment_done)
+            ):
                 boxes = [
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             elif (
                 (self.xanes_file_configured & self.xanes_data_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    & (self.xanes_alignment_done)
-                    & (not self.xanes_fit_eng_configured)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (self.xanes_alignment_done)
+                & (not self.xanes_fit_eng_configured)
+            ):
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignImg box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["FitEngRag box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
                 boxes = ["FitItem tab"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (
                 (self.xanes_file_configured & self.xanes_data_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    &
-                (self.xanes_alignment_done & self.xanes_fit_eng_configured)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (self.xanes_alignment_done & self.xanes_fit_eng_configured)
+            ):
                 boxes = [
                     "ConfigData box",
                     "2DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignImg box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["FitEngRag box", "FitItem tab"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
             xanes2D_compound_logic()
         elif self.xanes_file_analysis_option == "Reg By Shift":
             if not self.xanes_file_configured:
-                boxes = [
-                    "2DRoi box", "RevRegRlt box", "AlignImg box", "VisImg box"
-                ]
+                boxes = ["2DRoi box", "RevRegRlt box", "AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif self.xanes_file_configured & (not self.xanes_roi_configured):
                 boxes = ["2DRoi box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["RevRegRlt box", "AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (self.xanes_file_configured & self.xanes_roi_configured) & (
-                    not self.xanes_reg_review_done):
+                not self.xanes_reg_review_done
+            ):
                 boxes = ["2DRoi box", "ReadAlignFile box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["ReadAlign btn"].disabled = False
 
                 boxes = ["AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (self.xanes_file_configured & self.xanes_roi_configured) & (
-                    self.xanes_reg_review_done &
-                (not self.xanes_alignment_done)):
+                self.xanes_reg_review_done & (not self.xanes_alignment_done)
+            ):
                 boxes = ["2DRoi box", "ReadAlignFile box", "AlignImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["ReadAlign btn"].disabled = False
 
                 boxes = ["VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
-            elif ((self.xanes_file_configured & self.xanes_roi_configured)
-                  & (self.xanes_reg_review_done & self.xanes_alignment_done)
-                  & (not self.xanes_fit_eng_configured)):
-                boxes = [
-                    "2DRoi box", "ReadAlignFile box", "AlignImg box",
-                    "VisImg box"
-                ]
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
+            elif (
+                (self.xanes_file_configured & self.xanes_roi_configured)
+                & (self.xanes_reg_review_done & self.xanes_alignment_done)
+                & (not self.xanes_fit_eng_configured)
+            ):
+                boxes = ["2DRoi box", "ReadAlignFile box", "AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["ReadAlign btn"].disabled = False
                 boxes = ["FitEngRag box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
                 boxes = ["FitItem tab"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
-            elif ((self.xanes_file_configured & self.xanes_roi_configured)
-                  & (self.xanes_reg_review_done & self.xanes_alignment_done)
-                  & self.xanes_fit_eng_configured):
-                boxes = [
-                    "2DRoi box", "ReadAlignFile box", "AlignImg box",
-                    "VisImg box"
-                ]
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
+            elif (
+                (self.xanes_file_configured & self.xanes_roi_configured)
+                & (self.xanes_reg_review_done & self.xanes_alignment_done)
+                & self.xanes_fit_eng_configured
+            ):
+                boxes = ["2DRoi box", "ReadAlignFile box", "AlignImg box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["ReadAlign btn"].disabled = False
                 boxes = ["FitEngRag box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
                 boxes = ["FitItem tab"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             xanes2D_compound_logic()
             boxes = ["ConfigData box", "ConfigRegParams box", "RunReg box"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
         elif self.xanes_file_analysis_option == "Do Analysis":
             boxes = [
                 "ConfigData box",
                 "2DRoi box",
@@ -1203,29 +1163,26 @@
                 "RevRegRlt box",
                 "AlignImg box",
             ]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
             boxes = ["VisImg box"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             boxes = ["FitEngRag box"]
-            enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                 boxes,
-                                 disabled=False,
-                                 level=-1)
+            enable_disable_boxes(
+                self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+            )
             boxes = ["FitItem tab"]
             if self.xanes_fit_eng_configured:
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
             else:
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             xanes2D_compound_logic()
         self.lock_message_text_boxes()
 
     def build_gui(self):
         """
         hs: widget handler sets; hs is a multi-layer structured dictionary. Layers
         are labeled as '0', '1', '2' in order of their hiearchical relations. In
@@ -1240,19 +1197,15 @@
         """
         #################################################################################################################
         #                                                                                                               #
         #                                                     2D XANES                                                  #
         #                                                                                                               #
         #################################################################################################################
         ## ## ## define 2D_XANES_tabs layout -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "100%",
-            "height": "100%"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "100%", "height": "100%"}
         self.hs["Config&Input form"] = widgets.VBox()
         self.hs["RegSetting form"] = widgets.VBox()
         self.hs["Reg&Rev form"] = widgets.VBox()
         self.hs["Fitting form"] = widgets.VBox()
         self.hs["Analysis form"] = widgets.VBox()
         self.hs["Config&Input form"].layout = layout
         self.hs["RegSetting form"].layout = layout
@@ -1268,101 +1221,84 @@
             "width": "auto",
             "height": f"{0.28 * (self.form_sz[0] - 136)}px",
         }
         self.hs["SelFile&Path box"] = widgets.VBox()
         self.hs["SelFile&Path box"].layout = layout
 
         ## ## ## ## ## label configure file settings box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelFile&PathTitle box"] = widgets.HBox()
         self.hs["SelFile&PathTitle box"].layout = layout
         self.hs["SelFile&PathTitle label"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config Dirs & Files" + "</span>")
+            + "Config Dirs & Files"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "39%"}
         self.hs["SelFile&PathTitle label"].layout = layout
 
-        self.hs["SelFile&PathTitle box"].children = [
-            self.hs["SelFile&PathTitle label"]
-        ]
+        self.hs["SelFile&PathTitle box"].children = [self.hs["SelFile&PathTitle label"]]
 
         ## ## ## ## ## raw h5 top directory
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelRaw box"] = widgets.HBox()
         self.hs["SelRaw box"].layout = layout
         self.hs["SelRawH5Path text"] = widgets.Text(
-            value="Choose raw h5 directory ...", description="", disabled=True)
+            value="Choose raw h5 directory ...", description="", disabled=True
+        )
         layout = {"width": "66%", "display": "inline_flex"}
         self.hs["SelRawH5Path text"].layout = layout
         self.hs["SelRawH5Path btn"] = SelectFilesButton(
             option="askopenfilename",
             text_h=self.hs["SelRawH5Path text"],
-            **{"open_filetypes": (("h5 files", "*.h5"), )},
+            **{"open_filetypes": (("h5 files", "*.h5"),)},
         )
         layout = {"width": "15%"}
         self.hs["SelRawH5Path btn"].layout = layout
         self.hs["SelRawH5Path btn"].description = "XANES2D File"
 
         self.hs["SelRawH5Path btn"].on_click(self.SelRawH5Path_btn_clk)
         self.hs["SelRaw box"].children = [
             self.hs["SelRawH5Path text"],
             self.hs["SelRawH5Path btn"],
         ]
 
         ## ## ## ## ## trial save file
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelSaveTrial box"] = widgets.HBox()
         self.hs["SelSaveTrial box"].layout = layout
         self.hs["SelSaveTrial text"] = widgets.Text(
-            value="Save trial registration as ...",
-            description="",
-            disabled=True)
+            value="Save trial registration as ...", description="", disabled=True
+        )
         layout = {"width": "66%", "display": "inline_flex"}
         self.hs["SelSaveTrial text"].layout = layout
         self.hs["SelSaveTrial btn"] = SelectFilesButton(
             option="asksaveasfilename",
             text_h=self.hs["SelSaveTrial text"],
             **{
-                "open_filetypes": (("h5 files", "*.h5"), ),
+                "open_filetypes": (("h5 files", "*.h5"),),
                 "initialfile": "2D_trial_reg.h5",
             },
         )
         self.hs["SelSaveTrial btn"].description = "Save Reg File"
         layout = {"width": "15%"}
         self.hs["SelSaveTrial btn"].layout = layout
 
         self.hs["SelSaveTrial btn"].on_click(self.SelSaveTrial_btn_clk)
         self.hs["SelSaveTrial box"].children = [
             self.hs["SelSaveTrial text"],
             self.hs["SelSaveTrial btn"],
         ]
 
         ## ## ## ## ## confirm file configuration
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelFile&PathComfirm box"] = widgets.HBox()
         self.hs["SelFile&PathComfirm box"].layout = layout
         self.hs["CfmFile&Path text"] = widgets.Text(
-            value=
-            "Save trial registration, or go directly review registration ...",
+            value="Save trial registration, or go directly review registration ...",
             description="",
             disabled=True,
         )
         layout = {"width": "66%"}
         self.hs["CfmFile&Path text"].layout = layout
         self.hs["CfmFile&Path btn"] = widgets.Button(
             description="Confirm",
@@ -1371,27 +1307,25 @@
         self.hs["CfmFile&Path btn"].style.button_color = "darkviolet"
         self.hs["CfmFile&Path btn"].on_click(self.CfmFile_Path_btn_clk)
         layout = {"width": "15%"}
         self.hs["CfmFile&Path btn"].layout = layout
 
         self.hs["FilePathOptions drpdn"] = widgets.Dropdown(
             value="Do New Reg",
-            options=[
-                "Do New Reg", "Read Config File", "Reg By Shift", "Do Analysis"
-            ],
+            options=["Do New Reg", "Read Config File", "Reg By Shift", "Do Analysis"],
             description="",
-            description_tooltip=
-            '"Do New Reg": start registration and review results from beginning; "Read Reg File": if you have already done registraion and like to review the results; "Read Config File": if you like to resume analysis with an existing configuration.',
+            description_tooltip='"Do New Reg": start registration and review results from beginning; "Read Reg File": if you have already done registraion and like to review the results; "Read Config File": if you like to resume analysis with an existing configuration.',
             disabled=False,
         )
         layout = {"width": "15%"}
         self.hs["FilePathOptions drpdn"].layout = layout
 
         self.hs["FilePathOptions drpdn"].observe(
-            self.FilePathOptions_drpdn_chg, names="value")
+            self.FilePathOptions_drpdn_chg, names="value"
+        )
         self.hs["SelFile&PathComfirm box"].children = [
             self.hs["CfmFile&Path text"],
             self.hs["CfmFile&Path btn"],
             self.hs["FilePathOptions drpdn"],
         ]
 
         self.hs["SelFile&Path box"].children = [
@@ -1417,158 +1351,129 @@
             "border": "3px solid #8855AA",
             "width": "auto",
             "height": f"{0.43 * (self.form_sz[0] - 136)}px",
         }
         self.hs["ConfigData box"] = widgets.VBox()
         self.hs["ConfigData box"].layout = layout
 
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["DataPrepOptions box"] = widgets.HBox()
         self.hs["DataPrepOptions box"].layout = layout
 
         self.hs["IsRaw chbx"] = widgets.Checkbox(
             value=True,
             description="Is Raw",
             disabled=True,
             indent=False,
-            description_tooltip=
-            "check it if the XANES data in the file is not normalized",
+            description_tooltip="check it if the XANES data in the file is not normalized",
         )
         layout = {"width": "20%"}
         self.hs["IsRaw chbx"].layout = layout
         layout = {"width": "20%"}
         self.hs["NormScale text"] = widgets.BoundedFloatText(
             value=1,
             min=1e-10,
             max=100,
             step=0.1,
             description="Norm Scale",
             disabled=True,
-            description_tooltip=
-            "scale the XANES data with a factor if the normalized data is not in range [0, 1]",
+            description_tooltip="scale the XANES data with a factor if the normalized data is not in range [0, 1]",
         )
         self.hs["NormScale text"].layout = layout
         layout = {"left": "40.9%", "width": "15%"}
         self.hs["ConfigDataLoadImg btn"] = widgets.Button(
-            description="Load Images", disabled=True)
+            description="Load Images", disabled=True
+        )
         self.hs["ConfigDataLoadImg btn"].layout = layout
         self.hs["ConfigDataLoadImg btn"].style.button_color = "darkviolet"
 
         self.hs["IsRaw chbx"].observe(self.IsRaw_chbx_change, names="value")
-        self.hs["NormScale text"].observe(self.NormScale_text_chg,
-                                          names="value")
-        self.hs["ConfigDataLoadImg btn"].on_click(
-            self.ConfigDataLoadImg_btn_clk)
+        self.hs["NormScale text"].observe(self.NormScale_text_chg, names="value")
+        self.hs["ConfigDataLoadImg btn"].on_click(self.ConfigDataLoadImg_btn_clk)
         self.hs["DataPrepOptions box"].children = [
             self.hs["IsRaw chbx"],
             self.hs["NormScale text"],
             self.hs["ConfigDataLoadImg btn"],
         ]
         ## ## ## ## ## data_preprocessing_options -- end
 
         ## ## ## ## ## define eng points -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["EngRange box"] = widgets.HBox()
         self.hs["EngRange box"].layout = layout
         self.hs["EngPointsRange sldr"] = widgets.IntRangeSlider(
-            value=[0, 1],
-            step=1,
-            description="eng points range",
-            disabled=True)
+            value=[0, 1], step=1, description="eng points range", disabled=True
+        )
         layout = {"width": "55%"}
         self.hs["EngPointsRange sldr"].layout = layout
         self.hs["EngStart text"] = widgets.BoundedFloatText(
-            value=0,
-            min=1e3,
-            max=5e4,
-            step=0.1,
-            description="eng s (eV)",
-            disabled=True)
+            value=0, min=1e3, max=5e4, step=0.1, description="eng s (eV)", disabled=True
+        )
         layout = {"width": "20%"}
         self.hs["EngStart text"].layout = layout
         self.hs["EngEnd text"] = widgets.BoundedFloatText(
-            value=0,
-            min=1e3,
-            max=5e4,
-            step=0.1,
-            description="eng e (eV)",
-            disabled=True)
+            value=0, min=1e3, max=5e4, step=0.1, description="eng e (eV)", disabled=True
+        )
         layout = {"width": "20%"}
         self.hs["EngEnd text"].layout = layout
 
-        self.hs["EngPointsRange sldr"].observe(self.EngPointsRange_slider_chg,
-                                               names="value")
+        self.hs["EngPointsRange sldr"].observe(
+            self.EngPointsRange_slider_chg, names="value"
+        )
         self.hs["EngRange box"].children = [
             self.hs["EngPointsRange sldr"],
             self.hs["EngStart text"],
             self.hs["EngEnd text"],
         ]
         ## ## ## ## ## define eng points -- end
 
         ## ## ## ## ## fiji option -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["Fiji box"] = widgets.HBox()
         self.hs["Fiji box"].layout = layout
         self.hs["FijiRawImgPrev chbx"] = widgets.Checkbox(
-            value=False, description="fiji view", disabled=True, indent=False)
+            value=False, description="fiji view", disabled=True, indent=False
+        )
         layout = {"width": "20%"}
         self.hs["FijiRawImgPrev chbx"].layout = layout
-        self.hs["FijiEngId sldr"] = widgets.IntSlider(value=False,
-                                                      description="img #",
-                                                      disabled=True,
-                                                      min=0)
+        self.hs["FijiEngId sldr"] = widgets.IntSlider(
+            value=False, description="img #", disabled=True, min=0
+        )
         layout = {"width": "60.6%"}
         self.hs["FijiEngId sldr"].layout = layout
         self.hs["FijiClose btn"] = widgets.Button(
-            description="close all fiji viewers", disabled=True)
+            description="close all fiji viewers", disabled=True
+        )
         layout = {"width": "15%"}
         self.hs["FijiClose btn"].layout = layout
 
-        self.hs["FijiRawImgPrev chbx"].observe(self.FijiRawImgPrev_chbx_chg,
-                                               names="value")
-        self.hs["FijiEngId sldr"].observe(self.FijiEngId_sldr_chg,
-                                          names="value")
+        self.hs["FijiRawImgPrev chbx"].observe(
+            self.FijiRawImgPrev_chbx_chg, names="value"
+        )
+        self.hs["FijiEngId sldr"].observe(self.FijiEngId_sldr_chg, names="value")
         self.hs["FijiClose btn"].on_click(self.FijiClose_btn_clk)
         self.hs["Fiji box"].children = [
             self.hs["FijiRawImgPrev chbx"],
             self.hs["FijiEngId sldr"],
             self.hs["FijiClose btn"],
         ]
         ## ## ## ## ## fiji option -- end
 
         ## ## ## ## ## confirm data configuration -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ConfigDataCfm box"] = widgets.HBox()
         self.hs["ConfigDataCfm box"].layout = layout
         self.hs["CfmConfigData text"] = widgets.Text(
-            value="Cfm setting once you are done ...",
-            description="",
-            disabled=True)
+            value="Cfm setting once you are done ...", description="", disabled=True
+        )
         layout = {"width": "81.0%"}
         self.hs["CfmConfigData text"].layout = layout
         self.hs["CfmConfigData btn"] = widgets.Button(
             description="Confirm",
-            description_tooltip=
-            "Confirm: Confirm after you finish file configuration",
+            description_tooltip="Confirm: Confirm after you finish file configuration",
             disabled=True,
         )
         self.hs["CfmConfigData btn"].style.button_color = "darkviolet"
         layout = {"width": "15%"}
         self.hs["CfmConfigData btn"].layout = layout
 
         self.hs["CfmConfigData btn"].on_click(self.CfmConfigData_btn_clk)
@@ -1628,40 +1533,34 @@
             "height": f"{0.28 * (self.form_sz[0] - 136)}px",
         }
         self.hs["2DRoi box"] = widgets.VBox()
         self.hs["2DRoi box"].layout = layout
         base_wz_os = 92
         ex_ws_os = 6
         ## ## ## ## ## label 2D_roi_title box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["2DRoiTitle box"] = widgets.HBox()
         self.hs["2DRoiTitle box"].layout = layout
         self.hs["2DRoiTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config 2D ROI" + "</span>")
+            + "Config 2D ROI"
+            + "</span>"
+        )
         layout = {
             "justify-content": "center",
             "background-color": "white",
             "color": "cyan",
             "left": "43%",
         }
         self.hs["2DRoiTitle text"].layout = layout
         self.hs["2DRoiTitle box"].children = [self.hs["2DRoiTitle text"]]
         ## ## ## ## ## label 2D_roi_title box -- end
 
         ## ## ## ## ## define roi -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["2DRoiDefine box"] = widgets.VBox()
         self.hs["2DRoiDefine box"].layout = layout
         self.hs["2DRoiX sldr"] = widgets.IntRangeSlider(
             value=[10, 40],
             min=1,
             max=50,
             step=1,
@@ -1693,26 +1592,21 @@
         self.hs["2DRoiDefine box"].children = [
             self.hs["2DRoiX sldr"],
             self.hs["2DRoiY sldr"],
         ]
         ## ## ## ## ## define roi -- end
 
         ## ## ## ## ## confirm roi -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["2DRoiCfm box"] = widgets.HBox()
         self.hs["2DRoiCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["CfmRoi text"] = widgets.Text(
-            description="",
-            value="Please confirm after ROI is set ...",
-            disabled=True)
+            description="", value="Please confirm after ROI is set ...", disabled=True
+        )
         self.hs["CfmRoi text"].layout = layout
         layout = {"width": "15%"}
         self.hs["CfmRoi btn"] = widgets.Button(
             description="Confirm",
             description_tooltip="Confirm the roi once you define the ROI ...",
             disabled=True,
         )
@@ -1739,92 +1633,76 @@
             "width": "auto",
             "height": f"{0.42 * (self.form_sz[0] - 136)}px",
         }
         self.hs["ConfigRegParams box"] = widgets.VBox()
         self.hs["ConfigRegParams box"].layout = layout
 
         ## ## ## ## ## label config_reg_params box --start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ConfigRegParamsTitle box"] = widgets.HBox()
         self.hs["ConfigRegParamsTitle box"].layout = layout
         self.hs["ConfigRegParamsTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config Reg Params" + "</span>")
-        layout = {
-            "background-color": "white",
-            "color": "cyan",
-            "left": "40.5%"
-        }
+            + "Config Reg Params"
+            + "</span>"
+        )
+        layout = {"background-color": "white", "color": "cyan", "left": "40.5%"}
         self.hs["ConfigRegParamsTitle text"].layout = layout
 
         self.hs["ConfigRegParamsTitle box"].children = [
             self.hs["ConfigRegParamsTitle text"]
         ]
         ## ## ## ## ## label config_reg_params box --end
 
         ## ## ## ## ## fiji&anchor box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["Fiji&Anchor box"] = widgets.HBox()
         self.hs["Fiji&Anchor box"].layout = layout
         self.hs["FijiMaskViewer chbx"] = widgets.Checkbox(
-            value=False, disabled=True, description="preview", indent=False)
+            value=False, disabled=True, description="preview", indent=False
+        )
         layout = {"width": "19%"}
         self.hs["FijiMaskViewer chbx"].layout = layout
-        self.hs["UseChunk chbx"] = widgets.Checkbox(value=True,
-                                                    disabled=True,
-                                                    description="use anchor",
-                                                    indent=False)
+        self.hs["UseChunk chbx"] = widgets.Checkbox(
+            value=True, disabled=True, description="use anchor", indent=False
+        )
         layout = {"width": "19%"}
         self.hs["UseChunk chbx"].layout = layout
-        self.hs["AnchorId sldr"] = widgets.IntSlider(value=1,
-                                                     min=1,
-                                                     disabled=True,
-                                                     description="anchor id")
+        self.hs["AnchorId sldr"] = widgets.IntSlider(
+            value=1, min=1, disabled=True, description="anchor id"
+        )
         layout = {"width": "29%"}
         self.hs["AnchorId sldr"].layout = layout
-        self.hs["ChunkSz sldr"] = widgets.IntSlider(value=7,
-                                                    min=1,
-                                                    disabled=True,
-                                                    description="chunk size")
+        self.hs["ChunkSz sldr"] = widgets.IntSlider(
+            value=7, min=1, disabled=True, description="chunk size"
+        )
         layout = {"width": "29%"}
         self.hs["ChunkSz sldr"].layout = layout
 
-        self.hs["FijiMaskViewer chbx"].observe(self.FijiMaskViewer_chbx_chg,
-                                               names="value")
+        self.hs["FijiMaskViewer chbx"].observe(
+            self.FijiMaskViewer_chbx_chg, names="value"
+        )
         self.hs["UseChunk chbx"].observe(self.UseChunk_chbx_chg, names="value")
         self.hs["AnchorId sldr"].observe(self.AnchorId_sldr_chg, names="value")
         self.hs["ChunkSz sldr"].observe(self.ChunkSz_sldr_chg, names="value")
         self.hs["Fiji&Anchor box"].children = [
             self.hs["FijiMaskViewer chbx"],
             self.hs["UseChunk chbx"],
             self.hs["AnchorId sldr"],
             self.hs["ChunkSz sldr"],
         ]
         ## ## ## ## ## fiji&anchor box -- end
 
         ## ## ## ## ## mask options box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["MaskOptions box"] = widgets.HBox()
         self.hs["MaskOptions box"].layout = layout
-        self.hs["UseMask chbx"] = widgets.Checkbox(value=False,
-                                                   disabled=True,
-                                                   description="use mask",
-                                                   indent=False)
+        self.hs["UseMask chbx"] = widgets.Checkbox(
+            value=False, disabled=True, description="use mask", indent=False
+        )
         layout = {"width": "19%", "flex-direction": "row"}
         self.hs["UseMask chbx"].layout = layout
         self.hs["MaskThres sldr"] = widgets.FloatSlider(
             value=False,
             disabled=True,
             description="mask thres",
             readout_format=".5f",
@@ -1844,39 +1722,32 @@
             step=1,
             indent=False,
         )
         layout = {"width": "29%"}
         self.hs["MaskDilation sldr"].layout = layout
 
         self.hs["UseMask chbx"].observe(self.UseMask_chbx_chg, names="value")
-        self.hs["MaskThres sldr"].observe(self.MaskThres_sldr_chg,
-                                          names="value")
-        self.hs["MaskDilation sldr"].observe(self.MaskDilation_sldr_chg,
-                                             names="value")
+        self.hs["MaskThres sldr"].observe(self.MaskThres_sldr_chg, names="value")
+        self.hs["MaskDilation sldr"].observe(self.MaskDilation_sldr_chg, names="value")
         self.hs["MaskOptions box"].children = [
             self.hs["UseMask chbx"],
             self.hs["MaskThres sldr"],
             self.hs["MaskDilation sldr"],
         ]
         ## ## ## ## ## mask options box -- end
 
         ## ## ## ## ## smooth & chunk_size box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SliSrch&ChunkSz box"] = widgets.HBox()
         self.hs["SliSrch&ChunkSz box"].layout = layout
         self.hs["UseSmooth chbx"] = widgets.Checkbox(
             value=False,
             disabled=True,
             description="smooth img",
-            description_tooltip=
-            "enable option to smooth images before image registration",
+            description_tooltip="enable option to smooth images before image registration",
             indent=False,
         )
         layout = {"width": "19%"}
         self.hs["UseSmooth chbx"].layout = layout
         self.hs["SmoothSigma text"] = widgets.BoundedFloatText(
             value=5,
             min=0,
@@ -1888,52 +1759,43 @@
         )
         layout = {"width": "19%"}
         self.hs["SmoothSigma text"].layout = layout
         self.hs["RegMethod drpdn"] = widgets.Dropdown(
             value="MRTV",
             options=["MRTV", "MPC", "PC", "SR", "LS+MRTV", "MPC+MRTV"],
             description="reg method",
-            description_tooltip=
-            "reg method: MRTV: Multi-resolution Total Variantion, MPC: Masked Phase Correlation; PC: Phase Correlation; SR: StackReg; LS+MRTV: a hybrid TV minimization combining line search and multiresolution strategy; MPC+MRTV: a hybrid search algorihm with MPC as primary search followed by subpixel TV search",
+            description_tooltip="reg method: MRTV: Multi-resolution Total Variantion, MPC: Masked Phase Correlation; PC: Phase Correlation; SR: StackReg; LS+MRTV: a hybrid TV minimization combining line search and multiresolution strategy; MPC+MRTV: a hybrid search algorihm with MPC as primary search followed by subpixel TV search",
             disabled=True,
         )
         layout = {"width": "19%"}
         self.hs["RegMethod drpdn"].layout = layout
         self.hs["RefMode drpdn"] = widgets.Dropdown(
             value="single",
             options=["single", "neighbor", "average"],
             description="ref mode",
-            description_tooltip=
-            "ref mode: single: two images with fixed id gap in two consecutive chunks are used for the registration between two chunks; neighbor: two neighbor images in two consecutive chunks are used for the registration between two chunks; average: deprecated",
+            description_tooltip="ref mode: single: two images with fixed id gap in two consecutive chunks are used for the registration between two chunks; neighbor: two neighbor images in two consecutive chunks are used for the registration between two chunks; average: deprecated",
             disabled=True,
         )
         layout = {"width": "19%"}
         self.hs["RefMode drpdn"].layout = layout
 
-        self.hs["UseSmooth chbx"].observe(self.UseSmooth_chbx_chg,
-                                          names="value")
-        self.hs["SmoothSigma text"].observe(self.SmoothSigma_text_chg,
-                                            names="value")
-        self.hs["RegMethod drpdn"].observe(self.RegMethod_drpdn_chg,
-                                           names="value")
+        self.hs["UseSmooth chbx"].observe(self.UseSmooth_chbx_chg, names="value")
+        self.hs["SmoothSigma text"].observe(self.SmoothSigma_text_chg, names="value")
+        self.hs["RegMethod drpdn"].observe(self.RegMethod_drpdn_chg, names="value")
         self.hs["RefMode drpdn"].observe(self.RefMode_drpdn_chg, names="value")
         self.hs["SliSrch&ChunkSz box"].children = [
             self.hs["UseSmooth chbx"],
             self.hs["SmoothSigma text"],
             self.hs["RegMethod drpdn"],
             self.hs["RefMode drpdn"],
         ]
         ## ## ## ## ## smooth & chunk_size box -- end
 
         ## ## ## ## ##  reg_options box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["MrtvOptions box"] = widgets.HBox()
         self.hs["MrtvOptions box"].layout = layout
 
         self.hs["MrtvLevel text"] = widgets.BoundedIntText(
             value=5,
             min=1,
             max=10,
@@ -1947,16 +1809,15 @@
 
         self.hs["MrtvWz text"] = widgets.BoundedIntText(
             value=10,
             min=1,
             max=20,
             step=1,
             description="width",
-            description_tooltip=
-            "width: multi-resolution searching width at each level (number of searching steps)",
+            description_tooltip="width: multi-resolution searching width at each level (number of searching steps)",
             disabled=True,
         )
         layout = {"width": "19%"}
         self.hs["MrtvWz text"].layout = layout
 
         self.hs["MrtvSubpixelSrch drpdn"] = widgets.Dropdown(
             value="analytical",
@@ -1982,45 +1843,42 @@
 
         self.hs["MrtvSubpixelKernel text"] = widgets.BoundedIntText(
             value=3,
             min=2,
             max=20,
             step=1,
             description="kernel wz",
-            description_tooltip=
-            "us factor: upsampling factor for subpixel search",
+            description_tooltip="us factor: upsampling factor for subpixel search",
             disabled=True,
         )
         layout = {"width": "19%"}
         self.hs["MrtvSubpixelKernel text"].layout = layout
 
-        self.hs["MrtvLevel text"].observe(self.MrtvLevel_text_chg,
-                                          names="value")
+        self.hs["MrtvLevel text"].observe(self.MrtvLevel_text_chg, names="value")
         self.hs["MrtvWz text"].observe(self.MrtvWz_text_chg, names="value")
-        self.hs["MrtvSubpixelWz text"].observe(self.MrtvSubpixelWz_text_chg,
-                                               names="value")
+        self.hs["MrtvSubpixelWz text"].observe(
+            self.MrtvSubpixelWz_text_chg, names="value"
+        )
         self.hs["MrtvSubpixelKernel text"].observe(
-            self.MrtvSubpixelKernel_text_chg, names="value")
+            self.MrtvSubpixelKernel_text_chg, names="value"
+        )
         self.hs["MrtvSubpixelSrch drpdn"].observe(
-            self.MrtvSubpixelSrch_drpdn_chg, names="value")
+            self.MrtvSubpixelSrch_drpdn_chg, names="value"
+        )
         self.hs["MrtvOptions box"].children = [
             self.hs["MrtvLevel text"],
             self.hs["MrtvWz text"],
             self.hs["MrtvSubpixelWz text"],
             self.hs["MrtvSubpixelKernel text"],
             self.hs["MrtvSubpixelSrch drpdn"],
         ]
         ## ## ## ## ##  reg_options box -- end
 
         ## ## ## ## ## confirm reg settings -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ConfigRegParamsCfm box"] = widgets.HBox()
         self.hs["ConfigRegParamsCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["CfmRegParams text"] = widgets.Text(
             description="",
             value="Confirm the roi once you define the ROI ...",
             disabled=True,
@@ -2058,35 +1916,29 @@
             "width": "auto",
             "height": f"{0.21 * (self.form_sz[0] - 136)}px",
         }
         self.hs["RunReg box"] = widgets.VBox()
         self.hs["RunReg box"].layout = layout
 
         ## ## ## ## ## label run_reg box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RunRegTitle box"] = widgets.HBox()
         self.hs["RunRegTitle box"].layout = layout
         self.hs["RunRegTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Run Registration" + "</span>")
+            + "Run Registration"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "41%"}
         self.hs["RunRegTitle text"].layout = layout
         self.hs["RunRegTitle box"].children = [self.hs["RunRegTitle text"]]
         ## ## ## ## ## label run_reg box -- end
 
         ## ## ## ## ## run reg & status -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RunRegCfm box"] = widgets.HBox()
         self.hs["RunRegCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["RunReg text"] = widgets.Text(
             description="",
             value="run registration once you are ready ...",
             disabled=True,
@@ -2104,36 +1956,30 @@
         self.hs["RunReg btn"].on_click(self.RunReg_btn_clk)
         self.hs["RunRegCfm box"].children = [
             self.hs["RunReg text"],
             self.hs["RunReg btn"],
         ]
 
         ## ## ## ## ## run reg progress
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RunRegProgress box"] = widgets.HBox()
         self.hs["RunRegProgress box"].layout = layout
         layout = {"width": "100%"}
         self.hs["RunRegProgress bar"] = widgets.IntProgress(
             value=0,
             min=0,
             max=10,
             step=1,
             description="Completing:",
             bar_style="info",
             orientation="horizontal",
         )
         self.hs["RunRegProgress bar"].layout = layout
 
-        self.hs["RunRegProgress box"].children = [
-            self.hs["RunRegProgress bar"]
-        ]
+        self.hs["RunRegProgress box"].children = [self.hs["RunRegProgress bar"]]
         ## ## ## ## ## run reg & status -- start
 
         self.hs["RunReg box"].children = [
             self.hs["RunRegTitle box"],
             self.hs["RunRegCfm box"],
             self.hs["RunRegProgress box"],
         ]
@@ -2153,135 +1999,104 @@
             "width": "auto",
             "height": f"{0.35 * (self.form_sz[0] - 136)}px",
         }
         self.hs["RevRegRlt box"] = widgets.VBox()
         self.hs["RevRegRlt box"].layout = layout
 
         ## ## ## ## ## label review_reg_results box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RevRegRltTitle box"] = widgets.HBox()
         self.hs["RevRegRltTitle box"].layout = layout
         self.hs["RevRegRltTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Review/Correct Reg Results" + "</span>")
-        layout = {
-            "background-color": "white",
-            "color": "cyan",
-            "left": "35.7%"
-        }
+            + "Review/Correct Reg Results"
+            + "</span>"
+        )
+        layout = {"background-color": "white", "color": "cyan", "left": "35.7%"}
         self.hs["RevRegRltTitle text"].layout = layout
-        self.hs["RevRegRltTitle box"].children = [
-            self.hs["RevRegRltTitle text"]
-        ]
+        self.hs["RevRegRltTitle box"].children = [self.hs["RevRegRltTitle text"]]
         ## ## ## ## ## label review_reg_results box -- end
 
         ## ## ## ## ## read alignment file -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ReadAlignFile box"] = widgets.HBox()
         self.hs["ReadAlignFile box"].layout = layout
         layout = {"width": "70%"}
         self.hs["ReadAlign chbx"] = widgets.Checkbox(
-            description="read alignment", value=False, disabled=True)
+            description="read alignment", value=False, disabled=True
+        )
         self.hs["ReadAlign chbx"].layout = layout
         layout = {"width": "15%"}
         self.hs["ReadAlign btn"] = SelectFilesButton(option="askopenfilename")
         self.hs["ReadAlign btn"].disabled = True
         self.hs["ReadAlign btn"].layout = layout
 
-        self.hs["ReadAlign chbx"].observe(self.ReadAlign_chbx_chg,
-                                          names="value")
+        self.hs["ReadAlign chbx"].observe(self.ReadAlign_chbx_chg, names="value")
         self.hs["ReadAlign btn"].on_click(self.ReadAlign_btn_clk)
         self.hs["ReadAlignFile box"].children = [
             self.hs["ReadAlign chbx"],
             self.hs["ReadAlign btn"],
         ]
         ## ## ## ## ## read alignment file -- end
 
         ## ## ## ## ## reg pair box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RegPair box"] = widgets.HBox()
         self.hs["RegPair box"].layout = layout
         layout = {"width": "70%"}
-        self.hs["RegPair sldr"] = widgets.IntSlider(value=False,
-                                                    disabled=True,
-                                                    description="reg pair #")
+        self.hs["RegPair sldr"] = widgets.IntSlider(
+            value=False, disabled=True, description="reg pair #"
+        )
         self.hs["RegPair sldr"].layout = layout
         layout = {"width": "15%"}
-        self.hs["RegPairBad btn"] = widgets.Button(disabled=True,
-                                                   description="Bad")
+        self.hs["RegPairBad btn"] = widgets.Button(disabled=True, description="Bad")
         self.hs["RegPairBad btn"].layout = layout
         self.hs["RegPairBad btn"].style.button_color = "darkviolet"
 
         self.hs["RegPair sldr"].observe(self.RegPair_sldr_chg, names="value")
         self.hs["RegPairBad btn"].on_click(self.RegPairBad_btn_clk)
         self.hs["RegPair box"].children = [
             self.hs["RegPair sldr"],
             self.hs["RegPairBad btn"],
         ]
         ## ## ## ## ## reg pair box -- end
 
         ## ## ## ## ## zshift box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["CorrSht box"] = widgets.HBox()
         self.hs["CorrSht box"].layout = layout
         layout = {"width": "30%"}
-        self.hs["XShift text"] = widgets.FloatText(value=0,
-                                                   disabled=True,
-                                                   min=-100,
-                                                   max=100,
-                                                   step=0.5,
-                                                   description="x shift")
+        self.hs["XShift text"] = widgets.FloatText(
+            value=0, disabled=True, min=-100, max=100, step=0.5, description="x shift"
+        )
         self.hs["XShift text"].layout = layout
         layout = {"width": "30%"}
-        self.hs["YShift text"] = widgets.FloatText(value=0,
-                                                   disabled=True,
-                                                   min=-100,
-                                                   max=100,
-                                                   step=0.5,
-                                                   description="y shift")
+        self.hs["YShift text"] = widgets.FloatText(
+            value=0, disabled=True, min=-100, max=100, step=0.5, description="y shift"
+        )
         self.hs["YShift text"].layout = layout
         layout = {"left": "9.5%", "width": "15%"}
-        self.hs["Record btn"] = widgets.Button(description="Record",
-                                               description_tooltip="Record",
-                                               disabled=True)
+        self.hs["Record btn"] = widgets.Button(
+            description="Record", description_tooltip="Record", disabled=True
+        )
         self.hs["Record btn"].layout = layout
         self.hs["Record btn"].style.button_color = "darkviolet"
 
         self.hs["XShift text"].observe(self.XShift_text_chg, names="value")
         self.hs["YShift text"].observe(self.YShift_text_chg, names="value")
         self.hs["Record btn"].on_click(self.Record_btn_clk)
         self.hs["CorrSht box"].children = [
             self.hs["XShift text"],
             self.hs["YShift text"],
             self.hs["Record btn"],
         ]
         ## ## ## ## ## zshift box -- end
 
         ## ## ## ## ## confirm review results box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RevRegRltCfm box"] = widgets.HBox()
         self.hs["RevRegRltCfm box"].layout = layout
         layout = {"width": "70%", "display": "inline_flex"}
         self.hs["CfmRevRlt text"] = widgets.Text(
             description="",
             value="Confirm after you finish reg review ...",
             disabled=True,
@@ -2318,67 +2133,55 @@
             "width": "auto",
             "height": f"{0.21 * (self.form_sz[0] - 136)}px",
         }
         self.hs["AlignImg box"] = widgets.VBox()
         self.hs["AlignImg box"].layout = layout
 
         ## ## ## ## ## label align_recon box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignImgTitle box"] = widgets.HBox()
         self.hs["AlignImgTitle box"].layout = layout
         self.hs["AlignImgTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Align Images" + "</span>")
+            + "Align Images"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "41%"}
         self.hs["AlignImgTitle text"].layout = layout
 
         self.hs["AlignImgTitle box"].children = [self.hs["AlignImgTitle text"]]
         ## ## ## ## ## label align_recon box -- end
 
         ## ## ## ## ## define run reg & status -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignImgCfm box"] = widgets.HBox()
         self.hs["AlignImgCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["AlignImg text"] = widgets.Text(
-            description="",
-            value="Confirm to proceed alignment ...",
-            disabled=True)
+            description="", value="Confirm to proceed alignment ...", disabled=True
+        )
         self.hs["AlignImg text"].layout = layout
         layout = {"width": "15%"}
         self.hs["AlignImg btn"] = widgets.Button(
             description="Align",
-            description_tooltip=
-            "This will perform xanes2D alignment according to your configurations ...",
+            description_tooltip="This will perform xanes2D alignment according to your configurations ...",
             disabled=True,
         )
         self.hs["AlignImg btn"].style.button_color = "darkviolet"
         self.hs["AlignImg btn"].layout = layout
 
         self.hs["AlignImg btn"].on_click(self.AlignImg_btn_clk)
         self.hs["AlignImgCfm box"].children = [
             self.hs["AlignImg text"],
             self.hs["AlignImg btn"],
         ]
         ## ## ## ## ## define run reg & status -- end
 
         ## ## ## ## ## define run reg progress -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignPrgs box"] = widgets.HBox()
         self.hs["AlignPrgs box"].layout = layout
         layout = {"width": "100%"}
         self.hs["AlignPrgs bar"] = widgets.IntProgress(
             value=0,
             min=0,
             max=10,
@@ -2405,58 +2208,50 @@
             "width": "auto",
             "height": f"{0.14 * (self.form_sz[0] - 136)}px",
         }
         self.hs["VisImg box"] = widgets.VBox()
         self.hs["VisImg box"].layout = layout
 
         ## ## ## ## ## define visualization title -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["VisImgTitle box"] = widgets.HBox()
         self.hs["VisImgTitle box"].layout = layout
         self.hs["VisImgTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Visualize Images" + "</span>")
+            + "Visualize Images"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "42%"}
         self.hs["VisImgTitle text"].layout = layout
         self.hs["VisImgTitle box"].children = [self.hs["VisImgTitle text"]]
         ## ## ## ## ## define visualization title -- end
 
         ## ## ## ## ## define visualization&confirm -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["Vis&Cfm box"] = widgets.HBox()
         self.hs["Vis&Cfm box"].layout = layout
         layout = {"width": "60%"}
-        self.hs["Vis sldr"] = widgets.IntSlider(description="eng #",
-                                                min=1,
-                                                max=10,
-                                                disabled=True)
+        self.hs["Vis sldr"] = widgets.IntSlider(
+            description="eng #", min=1, max=10, disabled=True
+        )
         self.hs["Vis sldr"].layout = layout
         layout = {"width": "10%"}
-        self.hs["VisEng text"] = widgets.FloatText(description="",
-                                                   value=0,
-                                                   disabled=True)
+        self.hs["VisEng text"] = widgets.FloatText(
+            description="", value=0, disabled=True
+        )
         self.hs["VisEng text"].layout = layout
         layout = {"width": "15%"}
-        self.hs["VisR&C chbx"] = widgets.Checkbox(description="Auto R&C",
-                                                  value=True,
-                                                  disabled=True)
+        self.hs["VisR&C chbx"] = widgets.Checkbox(
+            description="Auto R&C", value=True, disabled=True
+        )
         self.hs["VisR&C chbx"].layout = layout
         layout = {"width": "15%"}
         self.hs["SpecInRoi btn"] = widgets.Button(
             description="spec in roi",
-            description_tooltip=
-            "This will perform xanes2D alignment according to your configurations ...",
+            description_tooltip="This will perform xanes2D alignment according to your configurations ...",
             disabled=True,
         )
         self.hs["SpecInRoi btn"].style.button_color = "darkviolet"
         self.hs["SpecInRoi btn"].layout = layout
 
         self.hs["Vis sldr"].observe(self.Vis_sldr_chg, names="value")
         self.hs["VisR&C chbx"].observe(self.VisRC_chbx_chg, names="value")
@@ -2478,291 +2273,402 @@
         self.hs["Reg&Rev form"].children = [
             self.hs["RevRegRlt box"],
             self.hs["AlignImg box"],
             self.hs["VisImg box"],
         ]
         ## ## ## define 2D_XANES_tabs layout - review/correct reg & align data -- end
 
-        self.hs["Fitting form"].children = [
-            self.xanes_fit_gui_h.hs["Fitting form"]
-        ]
+        self.hs["Fitting form"].children = [self.xanes_fit_gui_h.hs["Fitting form"]]
         ## ## ## define 2D_XANES_tabs layout - visualization&analysis reg & align data -- end
 
-        self.hs["Analysis form"].children = [
-            self.xanes_ana_gui_h.hs["Ana form"]
-        ]
+        self.hs["Analysis form"].children = [self.xanes_ana_gui_h.hs["Ana form"]]
         ## ## ## define 2D_XANES_tabs layout - analysis box -- end
 
         self.hs["SelRawH5Path btn"].initialdir = self.global_h.cwd
         self.hs["SelSaveTrial btn"].initialdir = self.global_h.cwd
         self.hs["ReadAlign btn"].initialdir = self.global_h.cwd
 
     def SelRawH5Path_btn_clk(self, a):
         if len(a.files[0]) != 0:
-            self.xanes_file_raw_h5_filename = os.path.abspath(a.files[0])
-            self.hs["SelRawH5Path btn"].initialdir = os.path.dirname(
-                os.path.abspath(a.files[0]))
-            self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
-                os.path.abspath(a.files[0]))
+            # self.xanes_file_raw_h5_filename = os.path.abspath(a.files[0])
+            # self.hs["SelRawH5Path btn"].initialdir = os.path.dirname(
+            #     os.path.abspath(a.files[0])
+            # )
+            # self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
+            #     os.path.abspath(a.files[0])
+            # )
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+            # )
+            # self.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
+            self.xanes_file_raw_h5_filename = str(Path(a.files[0]).absolute())
+            self.hs["SelRawH5Path btn"].initialdir = str(
+                Path(a.files[0]).absolute().parent
+            )
+            self.hs["SelSaveTrial btn"].initialdir = str(
+                Path(a.files[0]).absolute().parent
+            )
             update_json_content(
                 self.global_h.GUI_cfg_file,
-                {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                {"cwd": str(Path(a.files[0]).absolute().parent)},
             )
-            self.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
+            self.global_h.cwd = str(Path(a.files[0]).absolute().parent)
             self.xanes_file_raw_h5_set = True
         else:
             self.hs["SelRawH5Path text"].value = "Select raw h5 file ..."
             self.xanes_file_raw_h5_set = False
         self.xanes_file_configured = False
         self.hs["CfmFile&Path text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def SelSaveTrial_btn_clk(self, a):
         if self.xanes_file_analysis_option == "Do New Reg":
             if len(a.files[0]) != 0:
                 self.xanes_save_trial_reg_filename_template = a.files[0]
-                self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
+                # self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
+                # self.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
+                self.hs["SelSaveTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
-                self.global_h.cwd = os.path.dirname(os.path.abspath(
-                    a.files[0]))
+                self.global_h.cwd = str(Path(a.files[0]).absolute().parent)
                 self.xanes_file_save_trial_set = True
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = False
             else:
-                self.hs[
-                    "SelSaveTrial text"].value = "Save trial registration as ..."
+                self.hs["SelSaveTrial text"].value = "Save trial registration as ..."
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "CfmFile&Path text"].value = "Please comfirm your change ..."
+            self.hs["CfmFile&Path text"].value = "Please comfirm your change ..."
         elif self.xanes_file_analysis_option == "Read Config File":
             if len(a.files[0]) != 0:
-                self.xanes_file_save_trial_reg_config_filename_original = a.files[
-                    0]
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
+                self.xanes_file_save_trial_reg_config_filename_original = a.files[0]
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_file_save_trial_reg_config_filename = (
+                #     os.path.abspath(a.files[0]).split("config")[0]
+                #     + "config_"
+                #     + b.strip("-")
+                #     + ".json"
+                # )
+                # self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # self.hs["SelSaveTrial btn"].initialfile = os.path.basename(a.files[0])
+                # self.hs["SelSaveTrial text"].value = (
+                #     f"{self.xanes_file_save_trial_reg_config_filename} is Read ..."
+                # )
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
                 self.xanes_file_save_trial_reg_config_filename = (
-                    os.path.abspath(a.files[0]).split("config")[0] +
-                    "config_" + b.strip("-") + ".json")
-                self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSaveTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
+                    str(Path(a.files[0]).absolute()).split("config")[0]
+                    + "config_"
+                    + datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                    + ".json"
+                )
+                self.hs["SelSaveTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSaveTrial btn"].initialfile = Path(a.files[0]).name
                 self.hs["SelSaveTrial text"].value = (
                     f"{self.xanes_file_save_trial_reg_config_filename} is Read ..."
                 )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = True
             else:
-                self.hs[
-                    "SelSaveTrial text"].value = "Save Existing Configuration File ..."
+                self.hs["SelSaveTrial text"].value = (
+                    "Save Existing Configuration File ..."
+                )
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "CfmFile&Path text"].value = "Please comfirm your change ..."
+            self.hs["CfmFile&Path text"].value = "Please comfirm your change ..."
         elif self.xanes_file_analysis_option == "Reg By Shift":
             if len(a.files[0]) != 0:
-                self.xanes_file_save_trial_reg_config_filename_original = a.files[
-                    0]
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
+                self.xanes_file_save_trial_reg_config_filename_original = a.files[0]
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_file_save_trial_reg_config_filename = (
+                #     os.path.abspath(a.files[0]).split("config")[0]
+                #     + "config_"
+                #     + b.strip("-")
+                #     + ".json"
+                # )
+                # self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # self.hs["SelSaveTrial btn"].initialfile = os.path.basename(a.files[0])
+                # self.hs["SelSaveTrial text"].value = (
+                #     f"{self.xanes_file_save_trial_reg_config_filename} is Read ..."
+                # )
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
                 self.xanes_file_save_trial_reg_config_filename = (
-                    os.path.abspath(a.files[0]).split("config")[0] +
-                    "config_" + b.strip("-") + ".json")
-                self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSaveTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
+                    str(Path(a.files[0]).absolute()).split("config")[0]
+                    + "config_"
+                    + datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                    + ".json"
+                )
+                self.hs["SelSaveTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSaveTrial btn"].initialfile = Path(a.files[0]).name
                 self.hs["SelSaveTrial text"].value = (
                     f"{self.xanes_file_save_trial_reg_config_filename} is Read ..."
                 )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = True
             else:
-                self.hs[
-                    "SelSaveTrial text"].value = "Save Existing Configuration File ..."
+                self.hs["SelSaveTrial text"].value = (
+                    "Save Existing Configuration File ..."
+                )
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "CfmFile&Path text"].value = "Please comfirm your change ..."
+            self.hs["CfmFile&Path text"].value = "Please comfirm your change ..."
         elif self.xanes_file_analysis_option == "Do Analysis":
             self.hs["SelSaveTrial btn"].style.button_color = "lightgreen"
             if len(a.files[0]) != 0:
-                self.xanes_save_trial_reg_filename = os.path.abspath(
-                    a.files[0])
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_save_trial_reg_filename = os.path.abspath(a.files[0])
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # template = ""
+                # for ii in os.path.abspath(a.files[0]).split("_")[:-2]:
+                #     template += ii + "_"
+                # self.xanes_file_save_trial_reg_config_filename = (
+                #     template + "config_" + b.strip("-") + ".json"
+                # )
+                # self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # self.hs["SelSaveTrial btn"].initialfile = os.path.basename(a.files[0])
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
+                self.xanes_save_trial_reg_filename = Path(a.files[0]).absolute()
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
                 template = ""
-                for ii in os.path.abspath(a.files[0]).split("_")[:-2]:
+                for ii in str(Path(a.files[0]).absolute()).split("_")[:-2]:
                     template += ii + "_"
                 self.xanes_file_save_trial_reg_config_filename = (
-                    template + "config_" + b.strip("-") + ".json")
-                self.hs["SelSaveTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSaveTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
+                    template
+                    + "config_"
+                    + datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                    + ".json"
+                )
+                self.hs["SelSaveTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSaveTrial btn"].initialfile = Path(a.files[0]).name
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
                 self.hs["SelSaveTrial text"].value = (
                     f"{self.xanes_file_save_trial_reg_config_filename} is Read ..."
                 )
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = True
                 self.xanes_file_config_file_set = False
             else:
-                self.hs[
-                    "SelSaveTrial text"].value = "Read Existing Registration File ..."
+                self.hs["SelSaveTrial text"].value = (
+                    "Read Existing Registration File ..."
+                )
                 self.xanes_file_save_trial_set = False
                 self.xanes_file_reg_file_set = False
                 self.xanes_file_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "CfmFile&Path text"].value = "Please comfirm your change ..."
+            self.hs["CfmFile&Path text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def FilePathOptions_drpdn_chg(self, a):
         restart(self, dtype="2D_XANES")
         restart(self.xanes_fit_gui_h, dtype="XANES_FITTING")
         self.xanes_file_analysis_option = a["owner"].value
         self.xanes_file_configured = False
         if self.xanes_file_analysis_option == "Do New Reg":
             self.hs["SelRawH5Path btn"].disabled = False
             self.hs["SelSaveTrial btn"].option = "asksaveasfilename"
             self.hs["SelSaveTrial btn"].description = "Save Reg File"
-            self.hs[
-                "SelSaveTrial text"].value = "Save trial registration as ..."
+            self.hs["SelSaveTrial text"].value = "Save trial registration as ..."
             self.hs["ReadAlign chbx"].value = False
         elif self.xanes_file_analysis_option == "Read Config File":
             self.hs["SelRawH5Path btn"].disabled = True
             self.hs["SelSaveTrial btn"].option = "askopenfilename"
             self.hs["SelSaveTrial btn"].description = "Read Config"
             self.hs["SelSaveTrial btn"].open_filetypes = (
                 ("json files", "*.json"),
                 ("text files", "*.txt"),
             )
-            self.hs[
-                "SelSaveTrial text"].value = "Save Existing Configuration File ..."
+            self.hs["SelSaveTrial text"].value = "Save Existing Configuration File ..."
         elif self.xanes_file_analysis_option == "Reg By Shift":
             self.hs["SelRawH5Path btn"].disabled = True
             self.hs["SelSaveTrial btn"].option = "askopenfilename"
             self.hs["SelSaveTrial btn"].description = "Read Config"
             self.hs["SelSaveTrial btn"].open_filetypes = (
                 ("json files", "*.json"),
                 ("text files", "*.txt"),
             )
-            self.hs[
-                "SelSaveTrial text"].value = "Save Existing Configuration File ..."
+            self.hs["SelSaveTrial text"].value = "Save Existing Configuration File ..."
         elif self.xanes_file_analysis_option == "Do Analysis":
             self.hs["SelRawH5Path btn"].disabled = True
             self.hs["SelSaveTrial btn"].option = "askopenfilename"
             self.hs["SelSaveTrial btn"].description = "Read Reg File"
-            self.hs["SelSaveTrial btn"].open_filetypes = (("h5 files",
-                                                           "*.h5"), )
-            self.hs[
-                "SelSaveTrial text"].value = "Read Existing Registration File ..."
+            self.hs["SelSaveTrial btn"].open_filetypes = (("h5 files", "*.h5"),)
+            self.hs["SelSaveTrial text"].value = "Read Existing Registration File ..."
         self.hs["SelSaveTrial btn"].icon = "square-o"
         self.hs["SelSaveTrial btn"].style.button_color = "orange"
         self.hs["CfmRevRlt text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def CfmFile_Path_btn_clk(self, a):
         if self.xanes_file_analysis_option == "Do New Reg":
             if not self.xanes_file_raw_h5_set:
-                self.hs[
-                    "CfmFile&Path text"].value = "Please specifiy raw h5 file ..."
+                self.hs["CfmFile&Path text"].value = "Please specifiy raw h5 file ..."
                 self.xanes_file_configured = False
             elif not self.xanes_file_save_trial_set:
-                self.hs[
-                    "CfmFile&Path text"].value = "Please specifiy where to save trial reg result ..."
+                self.hs["CfmFile&Path text"].value = (
+                    "Please specifiy where to save trial reg result ..."
+                )
                 self.xanes_file_configured = False
             else:
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
-                self.xanes_save_trial_reg_filename = os.path.join(
-                    os.path.dirname(
-                        os.path.abspath(
-                            self.xanes_save_trial_reg_filename_template)),
-                    os.path.basename(
-                        os.path.abspath(
-                            self.xanes_save_trial_reg_filename_template)
-                    ).split(".")[0] + "_" + os.path.basename(
-                        self.xanes_file_raw_h5_filename).split(".")[0] + "_" +
-                    b.strip("-") + ".h5",
-                )
-                self.xanes_file_save_trial_reg_config_filename = os.path.join(
-                    os.path.dirname(
-                        os.path.abspath(
-                            self.xanes_save_trial_reg_filename_template)),
-                    os.path.basename(
-                        os.path.abspath(
-                            self.xanes_save_trial_reg_filename_template)
-                    ).split(".")[0] + "_" + os.path.basename(
-                        self.xanes_file_raw_h5_filename).split(".")[0] +
-                    "_config_" + b.strip("-") + ".json",
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_save_trial_reg_filename = os.path.join(
+                #     os.path.dirname(
+                #         os.path.abspath(self.xanes_save_trial_reg_filename_template)
+                #     ),
+                #     os.path.basename(
+                #         os.path.abspath(self.xanes_save_trial_reg_filename_template)
+                #     ).split(".")[0]
+                #     + "_"
+                #     + os.path.basename(self.xanes_file_raw_h5_filename).split(".")[0]
+                #     + "_"
+                #     + b.strip("-")
+                #     + ".h5",
+                # )
+                # self.xanes_file_save_trial_reg_config_filename = os.path.join(
+                #     os.path.dirname(
+                #         os.path.abspath(self.xanes_save_trial_reg_filename_template)
+                #     ),
+                #     os.path.basename(
+                #         os.path.abspath(self.xanes_save_trial_reg_filename_template)
+                #     ).split(".")[0]
+                #     + "_"
+                #     + os.path.basename(self.xanes_file_raw_h5_filename).split(".")[0]
+                #     + "_config_"
+                #     + b.strip("-")
+                #     + ".json",
+                # )
+                b = datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                self.xanes_save_trial_reg_filename = str(
+                    Path(self.xanes_save_trial_reg_filename_template).absolute().parent
+                    / (
+                        str(Path(self.xanes_save_trial_reg_filename_template).stem)
+                        + "_"
+                        + str(Path(self.xanes_file_raw_h5_filename).stem)
+                        + "_"
+                        + b
+                        + ".h5"
+                    )
+                )
+                self.xanes_file_save_trial_reg_config_filename = str(
+                    Path(self.xanes_save_trial_reg_filename_template).parent
+                    / (
+                        Path(self.xanes_save_trial_reg_filename_template).stem
+                        + "_"
+                        + Path(self.xanes_file_raw_h5_filename).stem
+                        + "_config_"
+                        + b
+                        + ".json"
+                    )
                 )
 
                 self.xanes_config_eng_list = self.reader(
                     self.xanes_file_raw_h5_filename,
                     dtype="eng",
                     sli=[None],
                     cfg=self.global_h.io_xanes2D_cfg,
                 )
                 if self.xanes_config_eng_list.max() < 70:
                     self.xanes_config_eng_list *= 1000
 
                 self.hs["EngPointsRange sldr"].value = [0, 1]
                 self.hs["EngPointsRange sldr"].min = 0
                 self.hs["EngPointsRange sldr"].max = (
-                    self.xanes_config_eng_list.shape[0] - 1)
+                    self.xanes_config_eng_list.shape[0] - 1
+                )
                 self.hs["EngStart text"].value = self.xanes_config_eng_list[0]
                 self.hs["EngEnd text"].value = self.xanes_config_eng_list[1]
 
                 self.xanes_eng_id_s = self.hs["EngPointsRange sldr"].value[0]
                 self.xanes_eng_id_e = self.hs["EngPointsRange sldr"].value[1]
-                self.hs[
-                    "CfmFile&Path text"].value = "XANES2D file config is done ..."
+                self.hs["CfmFile&Path text"].value = "XANES2D file config is done ..."
                 self.update_xanes2D_config()
-                self.xanes_review_reg_best_match_filename = (os.path.splitext(
-                    self.xanes_file_save_trial_reg_config_filename)[0].replace(
-                        "config", "reg_best_match") + ".json")
+                # self.xanes_review_reg_best_match_filename = (
+                #     os.path.splitext(self.xanes_file_save_trial_reg_config_filename)[
+                #         0
+                #     ].replace("config", "reg_best_match")
+                #     + ".json"
+                # )
+                self.xanes_review_reg_best_match_filename = str(
+                    Path(self.xanes_file_save_trial_reg_config_filename).parent
+                    / (
+                        Path(
+                            self.xanes_file_save_trial_reg_config_filename
+                        ).stem.replace("config", "reg_best_match")
+                        + ".json"
+                    )
+                )
                 self.xanes_file_configured = True
         elif self.xanes_file_analysis_option == "Read Config File":
             if not self.xanes_file_config_file_set:
-                self.hs[
-                    "CfmFile&Path text"].value = "Please specifiy the configuration file to be read ..."
+                self.hs["CfmFile&Path text"].value = (
+                    "Please specifiy the configuration file to be read ..."
+                )
                 self.xanes_file_configured = False
             else:
                 self.read_xanes2D_config()
                 self.set_xanes2D_variables()
 
                 self.xanes_config_eng_list = self.reader(
                     self.xanes_file_raw_h5_filename,
@@ -2772,173 +2678,219 @@
                 )
                 if self.xanes_config_eng_list.max() < 70:
                     self.xanes_config_eng_list *= 1000
 
                 if self.xanes_config_is_raw:
                     if self.xanes_config_use_alternative_flat:
                         if self.xanes_config_alternative_flat_set:
-                            self.xanes_img = -np.log((self.reader(
-                                self.xanes_file_raw_h5_filename,
-                                dtype="data",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            ) - self.reader(
-                                self.xanes_file_raw_h5_filename,
-                                dtype="dark",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            )) / (self.reader(
-                                self.xanes_config_alternative_flat_filename,
-                                dtype="flat",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            ) - self.reader(
-                                self.xanes_config_alternative_flat_filename,
-                                dtype="dark",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            )))
+                            self.xanes_img = -np.log(
+                                (
+                                    self.reader(
+                                        self.xanes_file_raw_h5_filename,
+                                        dtype="data",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                    - self.reader(
+                                        self.xanes_file_raw_h5_filename,
+                                        dtype="dark",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                )
+                                / (
+                                    self.reader(
+                                        self.xanes_config_alternative_flat_filename,
+                                        dtype="flat",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                    - self.reader(
+                                        self.xanes_config_alternative_flat_filename,
+                                        dtype="dark",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                )
+                            )
                             self.xanes_img[np.isinf(self.xanes_img)] = 0
                             self.xanes_img[np.isnan(self.xanes_img)] = 0
                             self.hs["EngPointsRange sldr"].value = [
                                 0,
                                 self.xanes_img.shape[0] - 1,
                             ]
                             self.xanes_config_raw_img_readed = True
                         else:
                             self.xanes_config_raw_img_readed = False
                     else:
-                        self.xanes_img = -np.log((self.reader(
-                            self.xanes_file_raw_h5_filename,
-                            dtype="data",
-                            sli=[None],
-                            cfg=self.global_h.io_xanes2D_cfg,
-                        ) - self.reader(
-                            self.xanes_file_raw_h5_filename,
-                            dtype="dark",
-                            sli=[None],
-                            cfg=self.global_h.io_xanes2D_cfg,
-                        )) / (self.reader(
-                            self.xanes_file_raw_h5_filename,
-                            dtype="flat",
-                            sli=[None],
-                            cfg=self.global_h.io_xanes2D_cfg,
-                        ) - self.reader(
-                            self.xanes_file_raw_h5_filename,
-                            dtype="dark",
-                            sli=[None],
-                            cfg=self.global_h.io_xanes2D_cfg,
-                        )))
+                        self.xanes_img = -np.log(
+                            (
+                                self.reader(
+                                    self.xanes_file_raw_h5_filename,
+                                    dtype="data",
+                                    sli=[None],
+                                    cfg=self.global_h.io_xanes2D_cfg,
+                                )
+                                - self.reader(
+                                    self.xanes_file_raw_h5_filename,
+                                    dtype="dark",
+                                    sli=[None],
+                                    cfg=self.global_h.io_xanes2D_cfg,
+                                )
+                            )
+                            / (
+                                self.reader(
+                                    self.xanes_file_raw_h5_filename,
+                                    dtype="flat",
+                                    sli=[None],
+                                    cfg=self.global_h.io_xanes2D_cfg,
+                                )
+                                - self.reader(
+                                    self.xanes_file_raw_h5_filename,
+                                    dtype="dark",
+                                    sli=[None],
+                                    cfg=self.global_h.io_xanes2D_cfg,
+                                )
+                            )
+                        )
                         self.xanes_img[np.isinf(self.xanes_img)] = 0
                         self.xanes_img[np.isnan(self.xanes_img)] = 0
                         self.xanes_config_raw_img_readed = True
                 else:
                     self.xanes_img = -np.log(
                         self.reader(
                             self.xanes_file_raw_h5_filename,
                             dtype="data",
                             sli=[None],
                             cfg=self.global_h.io_xanes2D_cfg,
-                        ))
+                        )
+                    )
                     self.xanes_img[np.isinf(self.xanes_img)] = 0
                     self.xanes_img[np.isnan(self.xanes_img)] = 0
                     self.hs["EngPointsRange sldr"].value = [
                         0,
                         self.xanes_img.shape[0] - 1,
                     ]
                     self.xanes_config_raw_img_readed = True
 
                 if self.xanes_data_configured:
                     self.xanes_fit_eng_list = self.reader(
                         self.xanes_file_raw_h5_filename,
                         dtype="eng",
                         sli=[None],
                         cfg=self.global_h.io_xanes2D_cfg,
-                    )[self.xanes_eng_id_s:self.xanes_eng_id_e + 1]
+                    )[self.xanes_eng_id_s : self.xanes_eng_id_e + 1]
                     if self.xanes_fit_eng_list.max() < 70:
                         self.xanes_fit_eng_list *= 1000
 
                 if self.xanes_roi_configured:
                     self.xanes_img_roi = self.xanes_img[
-                        self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ]
+                        self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                        self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                        self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                    ]
 
                 if self.xanes_reg_done:
-                    with h5py.File(self.xanes_save_trial_reg_filename,
-                                   "r") as f:
+                    with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                         self.xanes_review_aligned_img_original = f[
-                            "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                            .format(str(0).zfill(3))][:]
+                            "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                                str(0).zfill(3)
+                            )
+                        ][:]
                         self.xanes_review_aligned_img = f[
-                            "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                            .format(str(0).zfill(3))][:]
+                            "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                                str(0).zfill(3)
+                            )
+                        ][:]
                         self.xanes_review_fixed_img = f[
-                            "/trial_registration/trial_reg_results/{0}/trial_reg_fixed{0}"
-                            .format(str(0).zfill(3))][:]
+                            "/trial_registration/trial_reg_results/{0}/trial_reg_fixed{0}".format(
+                                str(0).zfill(3)
+                            )
+                        ][:]
                     self.xanes_review_shift_dict = {}
-                self.xanes_review_reg_best_match_filename = (os.path.splitext(
-                    self.xanes_file_save_trial_reg_config_filename)[0].replace(
-                        "config", "reg_best_match") + ".json")
+                # self.xanes_review_reg_best_match_filename = (
+                #     os.path.splitext(self.xanes_file_save_trial_reg_config_filename)[
+                #         0
+                #     ].replace("config", "reg_best_match")
+                #     + ".json"
+                # )
+                self.xanes_review_reg_best_match_filename = str(
+                    Path(self.xanes_file_save_trial_reg_config_filename).parent
+                    / (
+                        Path(
+                            self.xanes_file_save_trial_reg_config_filename
+                        ).stem.replace("config", "reg_best_match")
+                        + ".json"
+                    )
+                )
                 self.xanes_file_configured = True
 
                 self.hs["FijiMaskViewer chbx"].value = False
 
                 if self.xanes_alignment_done:
-                    with h5py.File(self.xanes_save_trial_reg_filename,
-                                   "r") as f:
+                    with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                         self.xanes_fit_data_shape = f[
-                            "/registration_results/reg_results/registered_xanes2D"].shape
+                            "/registration_results/reg_results/registered_xanes2D"
+                        ].shape
                         self.xanes_img_roi = f[
-                            "/registration_results/reg_results/registered_xanes2D"][:]
+                            "/registration_results/reg_results/registered_xanes2D"
+                        ][:]
                         self.xanes_fit_eng_list = f[
-                            "/registration_results/reg_results/eng_list"][:]
+                            "/registration_results/reg_results/eng_list"
+                        ][:]
 
                     self.hs["Vis sldr"].min = 1
                     self.hs["Vis sldr"].max = self.xanes_fit_eng_list.shape[0]
 
-                    self.xanes_review_reg_best_match_filename = (
-                        os.path.splitext(
-                            self.xanes_file_save_trial_reg_config_filename)
-                        [0].replace("config", "reg_best_match") + ".json")
-                    self.xanes_element = determine_element(
-                        self.xanes_fit_eng_list)
+                    # self.xanes_review_reg_best_match_filename = (
+                    #     os.path.splitext(
+                    #         self.xanes_file_save_trial_reg_config_filename
+                    #     )[0].replace("config", "reg_best_match")
+                    #     + ".json"
+                    # )
+                    self.xanes_review_reg_best_match_filename = str(
+                        Path(self.xanes_file_save_trial_reg_config_filename).parent
+                        / (
+                            Path(
+                                self.xanes_file_save_trial_reg_config_filename
+                            ).stem.replace("config", "reg_best_match")
+                            + ".json"
+                        )
+                    )
+                    self.xanes_element = determine_element(self.xanes_fit_eng_list)
                     tem = determine_fitting_energy_range(self.xanes_element)
                     self.xanes_fit_edge_eng = tem[0]
                     self.xanes_fit_wl_fit_eng_s = tem[1]
                     self.xanes_fit_wl_fit_eng_e = tem[2]
                     self.xanes_fit_pre_edge_e = tem[3]
                     self.xanes_fit_post_edge_s = tem[4]
                     self.xanes_fit_edge_0p5_fit_s = tem[5]
                     self.xanes_fit_edge_0p5_fit_e = tem[6]
                     self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "wl"
-                    self.xanes_fit_gui_h.hs[
-                        "FitEngRagOptn drpdn"].value = "full"
-                    if (self.xanes_fit_eng_list.min() >
-                        (self.xanes_fit_edge_eng - 50)) and (
-                            self.xanes_fit_eng_list.max() <
-                            (self.xanes_fit_edge_eng + 50)):
-                        self.xanes_fit_gui_h.hs[
-                            "FitEngRagOptn drpdn"].value = "wl"
-                        self.xanes_fit_gui_h.hs[
-                            "FitEngRagOptn drpdn"].disabled = True
+                    self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
+                    if (
+                        self.xanes_fit_eng_list.min() > (self.xanes_fit_edge_eng - 50)
+                    ) and (
+                        self.xanes_fit_eng_list.max() < (self.xanes_fit_edge_eng + 50)
+                    ):
+                        self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "wl"
+                        self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].disabled = True
                         self.xanes_fit_type = "wl"
                     else:
-                        self.xanes_fit_gui_h.hs[
-                            "FitEngRagOptn drpdn"].value = "full"
-                        self.xanes_fit_gui_h.hs[
-                            "FitEngRagOptn drpdn"].disabled = False
+                        self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
+                        self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].disabled = False
                         self.xanes_fit_type = "full"
                 self.set_xanes2D_handles()
                 self.set_xanes2D_variables()
                 fiji_viewer_off(self.global_h, self, viewer_name="all")
         elif self.xanes_file_analysis_option == "Reg By Shift":
             if not self.xanes_file_config_file_set:
-                self.hs[
-                    "CfmFile&Path text"].value = "Please specifiy the configuration file to be read ..."
+                self.hs["CfmFile&Path text"].value = (
+                    "Please specifiy the configuration file to be read ..."
+                )
                 self.xanes_file_configured = False
             else:
                 self.read_xanes2D_config()
                 self.set_xanes2D_variables()
                 if self.xanes_reg_review_done:
                     self.xanes_config_eng_list = self.reader(
                         self.xanes_file_raw_h5_filename,
@@ -2948,139 +2900,177 @@
                     )
                     if self.xanes_config_eng_list.max() < 70:
                         self.xanes_config_eng_list *= 1000
 
                     if self.xanes_config_is_raw:
                         if self.xanes_config_use_alternative_flat:
                             if self.xanes_config_alternative_flat_set:
-                                self.xanes_img = -np.log((self.reader(
-                                    self.xanes_file_raw_h5_filename,
-                                    dtype="data",
-                                    sli=[None],
-                                    cfg=self.global_h.io_xanes2D_cfg,
-                                ) - self.reader(
-                                    self.xanes_file_raw_h5_filename,
-                                    dtype="dark",
-                                    sli=[None],
-                                    cfg=self.global_h.io_xanes2D_cfg,
-                                )) / (self.reader(
-                                    self.xanes_config_alternative_flat_filename,
-                                    dtype="flat",
-                                    sli=[None],
-                                    cfg=self.global_h.io_xanes2D_cfg,
-                                ) - self.reader(
-                                    self.xanes_config_alternative_flat_filename,
-                                    dtype="dark",
-                                    sli=[None],
-                                    cfg=self.global_h.io_xanes2D_cfg,
-                                )))
+                                self.xanes_img = -np.log(
+                                    (
+                                        self.reader(
+                                            self.xanes_file_raw_h5_filename,
+                                            dtype="data",
+                                            sli=[None],
+                                            cfg=self.global_h.io_xanes2D_cfg,
+                                        )
+                                        - self.reader(
+                                            self.xanes_file_raw_h5_filename,
+                                            dtype="dark",
+                                            sli=[None],
+                                            cfg=self.global_h.io_xanes2D_cfg,
+                                        )
+                                    )
+                                    / (
+                                        self.reader(
+                                            self.xanes_config_alternative_flat_filename,
+                                            dtype="flat",
+                                            sli=[None],
+                                            cfg=self.global_h.io_xanes2D_cfg,
+                                        )
+                                        - self.reader(
+                                            self.xanes_config_alternative_flat_filename,
+                                            dtype="dark",
+                                            sli=[None],
+                                            cfg=self.global_h.io_xanes2D_cfg,
+                                        )
+                                    )
+                                )
                                 self.xanes_img[np.isinf(self.xanes_img)] = 0
                                 self.xanes_img[np.isnan(self.xanes_img)] = 0
                                 self.hs["EngPointsRange sldr"].value = [
                                     0,
                                     self.xanes_img.shape[0] - 1,
                                 ]
                                 self.xanes_config_raw_img_readed = True
                             else:
                                 self.xanes_config_raw_img_readed = False
                         else:
-                            self.xanes_img = -np.log((self.reader(
-                                self.xanes_file_raw_h5_filename,
-                                dtype="data",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            ) - self.reader(
-                                self.xanes_file_raw_h5_filename,
-                                dtype="dark",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            )) / (self.reader(
-                                self.xanes_file_raw_h5_filename,
-                                dtype="flat",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            ) - self.reader(
-                                self.xanes_file_raw_h5_filename,
-                                dtype="dark",
-                                sli=[None],
-                                cfg=self.global_h.io_xanes2D_cfg,
-                            )))
+                            self.xanes_img = -np.log(
+                                (
+                                    self.reader(
+                                        self.xanes_file_raw_h5_filename,
+                                        dtype="data",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                    - self.reader(
+                                        self.xanes_file_raw_h5_filename,
+                                        dtype="dark",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                )
+                                / (
+                                    self.reader(
+                                        self.xanes_file_raw_h5_filename,
+                                        dtype="flat",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                    - self.reader(
+                                        self.xanes_file_raw_h5_filename,
+                                        dtype="dark",
+                                        sli=[None],
+                                        cfg=self.global_h.io_xanes2D_cfg,
+                                    )
+                                )
+                            )
                             self.xanes_img[np.isinf(self.xanes_img)] = 0
                             self.xanes_img[np.isnan(self.xanes_img)] = 0
                             self.xanes_config_raw_img_readed = True
                     else:
                         self.xanes_img = -np.log(
                             self.reader(
                                 self.xanes_file_raw_h5_filename,
                                 dtype="data",
                                 sli=[None],
                                 cfg=self.global_h.io_xanes2D_cfg,
-                            ))
+                            )
+                        )
                         self.xanes_img[np.isinf(self.xanes_img)] = 0
                         self.xanes_img[np.isnan(self.xanes_img)] = 0
                         self.hs["EngPointsRange sldr"].value = [
                             0,
                             self.xanes_img.shape[0] - 1,
                         ]
                         self.xanes_config_raw_img_readed = True
 
                     if self.xanes_data_configured:
                         self.xanes_fit_eng_list = self.reader(
                             self.xanes_file_raw_h5_filename,
                             dtype="eng",
                             sli=[None],
                             cfg=self.global_h.io_xanes2D_cfg,
-                        )[self.xanes_eng_id_s:self.xanes_eng_id_e + 1]
+                        )[self.xanes_eng_id_s : self.xanes_eng_id_e + 1]
                         if self.xanes_fit_eng_list.max() < 70:
                             self.xanes_fit_eng_list *= 1000
 
                     if self.xanes_roi_configured:
                         self.xanes_img_roi = self.xanes_img[
-                            self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                            self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                            self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ]
+                            self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                            self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                            self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                        ]
 
                     if self.xanes_reg_done:
-                        with h5py.File(self.xanes_save_trial_reg_filename,
-                                       "r") as f:
+                        with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                             self.xanes_review_aligned_img_original = f[
-                                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                                .format(str(0).zfill(3))][:]
+                                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                                    str(0).zfill(3)
+                                )
+                            ][:]
                             self.xanes_review_aligned_img = f[
-                                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                                .format(str(0).zfill(3))][:]
+                                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                                    str(0).zfill(3)
+                                )
+                            ][:]
                             self.xanes_review_fixed_img = f[
-                                "/trial_registration/trial_reg_results/{0}/trial_reg_fixed{0}"
-                                .format(str(0).zfill(3))][:]
+                                "/trial_registration/trial_reg_results/{0}/trial_reg_fixed{0}".format(
+                                    str(0).zfill(3)
+                                )
+                            ][:]
                         self.xanes_review_shift_dict = {}
-                    self.xanes_review_reg_best_match_filename = (
-                        os.path.splitext(
-                            self.xanes_file_save_trial_reg_config_filename)
-                        [0].replace("config", "reg_best_match") + ".json")
+                    # self.xanes_review_reg_best_match_filename = (
+                    #     os.path.splitext(
+                    #         self.xanes_file_save_trial_reg_config_filename
+                    #     )[0].replace("config", "reg_best_match")
+                    #     + ".json"
+                    # )
+                    self.xanes_review_reg_best_match_filename = str(
+                        Path(self.xanes_file_save_trial_reg_config_filename).parent
+                        / (
+                            Path(
+                                self.xanes_file_save_trial_reg_config_filename
+                            ).stem.replace("config", "reg_best_match")
+                            + ".json"
+                        )
+                    )
                     self.xanes_file_configured = True
 
                     self.set_xanes2D_handles()
                     self.set_xanes2D_variables()
                     self.xanes_data_configured = False
                     self.xanes_roi_configured = False
                     self.xanes_reg_review_done = False
                     self.xanes_alignment_done = False
                     self.xanes_file_analysis_option = "Reg By Shift"
                     fiji_viewer_off(self.global_h, self, viewer_name="all")
-                    self.hs[
-                        "CfmFile&Path text"].value = "XANES2D file config is done ..."
+                    self.hs["CfmFile&Path text"].value = (
+                        "XANES2D file config is done ..."
+                    )
                 else:
                     self.xanes_file_configured = False
                     self.hs["CfmFile&Path text"].value = (
                         "To use this option, a config up to reg review is needed ..."
                     )
         elif self.xanes_file_analysis_option == "Do Analysis":
             if not self.xanes_file_reg_file_set:
-                self.hs[
-                    "CfmFile&Path text"].value = "Please specifiy the aligned data to be read..."
+                self.hs["CfmFile&Path text"].value = (
+                    "Please specifiy the aligned data to be read..."
+                )
                 self.xanes_file_configured = False
                 self.xanes_reg_review_done = False
                 self.xanes_data_configured = False
                 self.xanes_roi_configured = False
                 self.xanes_reg_params_configured = False
                 self.xanes_reg_done = False
                 self.xanes_alignment_done = False
@@ -3092,68 +3082,86 @@
                 self.xanes_roi_configured = False
                 self.xanes_reg_params_configured = False
                 self.xanes_reg_done = False
                 self.xanes_alignment_done = True
                 self.xanes_fit_eng_configured = False
                 with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                     self.xanes_fit_data_shape = f[
-                        "/registration_results/reg_results/registered_xanes2D"].shape
+                        "/registration_results/reg_results/registered_xanes2D"
+                    ].shape
                     self.xanes_img_roi = f[
-                        "/registration_results/reg_results/registered_xanes2D"][:]
+                        "/registration_results/reg_results/registered_xanes2D"
+                    ][:]
                     self.xanes_fit_eng_list = f[
-                        "/registration_results/reg_results/eng_list"][:]
+                        "/registration_results/reg_results/eng_list"
+                    ][:]
                     if self.xanes_fit_eng_list.max() < 70:
                         self.xanes_fit_eng_list *= 1000
 
                 data_state, viewer_state = fiji_viewer_state(
-                    self.global_h, self, viewer_name="xanes2D_analysis_viewer")
+                    self.global_h, self, viewer_name="xanes2D_analysis_viewer"
+                )
                 if not viewer_state:
-                    fiji_viewer_on(self.global_h,
-                                   self,
-                                   viewer_name="xanes2D_analysis_viewer")
+                    fiji_viewer_on(
+                        self.global_h, self, viewer_name="xanes2D_analysis_viewer"
+                    )
                 self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-                    "ip"].setImage(self.global_h.ij.convert().convert(
+                    "ip"
+                ].setImage(
+                    self.global_h.ij.convert().convert(
                         self.global_h.ij.dataset().create(
-                            self.global_h.ij.py.to_java(self.xanes_img_roi)),
+                            self.global_h.ij.py.to_java(self.xanes_img_roi)
+                        ),
                         self.global_h.ImagePlusClass,
-                    ))
+                    )
+                )
                 self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-                    "ip"].setSlice(0)
+                    "ip"
+                ].setSlice(0)
                 self.global_h.ij.py.run_macro(
-                    """run("Enhance Contrast", "saturated=0.35")""")
+                    """run("Enhance Contrast", "saturated=0.35")"""
+                )
 
                 self.hs["Vis sldr"].min = 1
                 self.hs["Vis sldr"].max = self.xanes_fit_eng_list.shape[0]
-                self.xanes_review_reg_best_match_filename = (os.path.splitext(
-                    self.xanes_file_save_trial_reg_config_filename)[0].replace(
-                        "config", "reg_best_match") + ".json")
+                # self.xanes_review_reg_best_match_filename = (
+                #     os.path.splitext(self.xanes_file_save_trial_reg_config_filename)[
+                #         0
+                #     ].replace("config", "reg_best_match")
+                #     + ".json"
+                # )
+                self.xanes_review_reg_best_match_filename = str(
+                    Path(self.xanes_file_save_trial_reg_config_filename).parent
+                    / (
+                        Path(
+                            self.xanes_file_save_trial_reg_config_filename
+                        ).stem.replace("config", "reg_best_match")
+                        + ".json"
+                    )
+                )
                 self.xanes_element = determine_element(self.xanes_fit_eng_list)
                 tem = determine_fitting_energy_range(self.xanes_element)
                 self.xanes_fit_edge_eng = tem[0]
                 self.xanes_fit_wl_fit_eng_s = tem[1]
                 self.xanes_fit_wl_fit_eng_e = tem[2]
                 self.xanes_fit_pre_edge_e = tem[3]
                 self.xanes_fit_post_edge_s = tem[4]
                 self.xanes_fit_edge_0p5_fit_s = tem[5]
                 self.xanes_fit_edge_0p5_fit_e = tem[6]
                 self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "wl"
                 self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
-                if (self.xanes_fit_eng_list.min() >
-                    (self.xanes_fit_edge_eng - 50)) and (
-                        self.xanes_fit_eng_list.max() <
-                        (self.xanes_fit_edge_eng + 50)):
+                if (
+                    self.xanes_fit_eng_list.min() > (self.xanes_fit_edge_eng - 50)
+                ) and (self.xanes_fit_eng_list.max() < (self.xanes_fit_edge_eng + 50)):
                     self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "wl"
-                    self.xanes_fit_gui_h.hs[
-                        "FitEngRagOptn drpdn"].disabled = True
+                    self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].disabled = True
                     self.xanes_fit_type = "wl"
                 else:
-                    self.xanes_fit_gui_h.hs[
-                        "FitEngRagOptn drpdn"].value = "full"
-                    self.xanes_fit_gui_h.hs[
-                        "FitEngRagOptn drpdn"].disabled = False
+                    self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
+                    self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].disabled = False
                     self.xanes_fit_type = "full"
         self.boxes_logic()
 
     def IsRaw_chbx_change(self, a):
         self.xanes_config_is_raw = a["owner"].value
         self.xanes_config_raw_img_readed = False
         self.boxes_logic()
@@ -3165,131 +3173,142 @@
 
     def ConfigDataLoadImg_btn_clk(self, a):
         self.xanes_config_is_raw = self.hs["IsRaw chbx"].value
         self.xanes_config_img_scalar = self.hs["NormScale text"].value
         if self.xanes_config_is_raw:
             if self.xanes_config_use_alternative_flat:
                 if self.xanes_config_alternative_flat_set:
-                    self.xanes_img = -np.log((self.reader(
-                        self.xanes_file_raw_h5_filename,
-                        dtype="data",
-                        sli=[None],
-                        cfg=self.global_h.io_xanes2D_cfg,
-                    ) - self.reader(
-                        self.xanes_file_raw_h5_filename,
-                        dtype="dark",
-                        sli=[None],
-                        cfg=self.global_h.io_xanes2D_cfg,
-                    )) / (self.reader(
-                        self.xanes_config_alternative_flat_filename,
-                        dtype="flat",
-                        sli=[None],
-                        cfg=self.global_h.io_xanes2D_cfg,
-                    ) - self.reader(
-                        self.xanes_config_alternative_flat_filename,
-                        dtype="dark",
-                        sli=[None],
-                        cfg=self.global_h.io_xanes2D_cfg,
-                    )))
+                    self.xanes_img = -np.log(
+                        (
+                            self.reader(
+                                self.xanes_file_raw_h5_filename,
+                                dtype="data",
+                                sli=[None],
+                                cfg=self.global_h.io_xanes2D_cfg,
+                            )
+                            - self.reader(
+                                self.xanes_file_raw_h5_filename,
+                                dtype="dark",
+                                sli=[None],
+                                cfg=self.global_h.io_xanes2D_cfg,
+                            )
+                        )
+                        / (
+                            self.reader(
+                                self.xanes_config_alternative_flat_filename,
+                                dtype="flat",
+                                sli=[None],
+                                cfg=self.global_h.io_xanes2D_cfg,
+                            )
+                            - self.reader(
+                                self.xanes_config_alternative_flat_filename,
+                                dtype="dark",
+                                sli=[None],
+                                cfg=self.global_h.io_xanes2D_cfg,
+                            )
+                        )
+                    )
                     self.xanes_img[np.isinf(self.xanes_img)] = 0
                     self.xanes_img[np.isnan(self.xanes_img)] = 0
                     self.hs["EngPointsRange sldr"].value = [
                         0,
                         self.xanes_img.shape[0] - 1,
                     ]
                     self.xanes_config_raw_img_readed = True
                 else:
                     self.xanes_config_raw_img_readed = False
             else:
-                self.xanes_img = -np.log((self.reader(
-                    self.xanes_file_raw_h5_filename,
-                    dtype="data",
-                    sli=[None],
-                    cfg=self.global_h.io_xanes2D_cfg,
-                ) - self.reader(
-                    self.xanes_file_raw_h5_filename,
-                    dtype="dark",
-                    sli=[None],
-                    cfg=self.global_h.io_xanes2D_cfg,
-                )) / (self.reader(
-                    self.xanes_file_raw_h5_filename,
-                    dtype="flat",
-                    sli=[None],
-                    cfg=self.global_h.io_xanes2D_cfg,
-                ) - self.reader(
-                    self.xanes_file_raw_h5_filename,
-                    dtype="dark",
-                    sli=[None],
-                    cfg=self.global_h.io_xanes2D_cfg,
-                )))
+                self.xanes_img = -np.log(
+                    (
+                        self.reader(
+                            self.xanes_file_raw_h5_filename,
+                            dtype="data",
+                            sli=[None],
+                            cfg=self.global_h.io_xanes2D_cfg,
+                        )
+                        - self.reader(
+                            self.xanes_file_raw_h5_filename,
+                            dtype="dark",
+                            sli=[None],
+                            cfg=self.global_h.io_xanes2D_cfg,
+                        )
+                    )
+                    / (
+                        self.reader(
+                            self.xanes_file_raw_h5_filename,
+                            dtype="flat",
+                            sli=[None],
+                            cfg=self.global_h.io_xanes2D_cfg,
+                        )
+                        - self.reader(
+                            self.xanes_file_raw_h5_filename,
+                            dtype="dark",
+                            sli=[None],
+                            cfg=self.global_h.io_xanes2D_cfg,
+                        )
+                    )
+                )
                 self.xanes_img[np.isinf(self.xanes_img)] = 0
                 self.xanes_img[np.isnan(self.xanes_img)] = 0
-                self.hs["EngPointsRange sldr"].value = [
-                    0, self.xanes_img.shape[0] - 1
-                ]
+                self.hs["EngPointsRange sldr"].value = [0, self.xanes_img.shape[0] - 1]
                 self.xanes_config_raw_img_readed = True
         else:
             self.xanes_img = -np.log(
                 self.reader(
                     self.xanes_file_raw_h5_filename,
                     dtype="data",
                     sli=[None],
                     cfg=self.global_h.io_xanes2D_cfg,
-                ))
+                )
+            )
             self.xanes_img[np.isinf(self.xanes_img)] = 0
             self.xanes_img[np.isnan(self.xanes_img)] = 0
-            self.hs["EngPointsRange sldr"].value = [
-                0, self.xanes_img.shape[0] - 1
-            ]
+            self.hs["EngPointsRange sldr"].value = [0, self.xanes_img.shape[0] - 1]
             self.xanes_config_raw_img_readed = True
         self.boxes_logic()
 
     def EngPointsRange_slider_chg(self, a):
         self.xanes_eng_id_s = a["owner"].value[0]
         self.xanes_eng_id_e = a["owner"].value[1]
-        self.hs["EngStart text"].value = self.xanes_config_eng_list[
-            self.xanes_eng_id_s]
-        self.hs["EngEnd text"].value = self.xanes_config_eng_list[
-            self.xanes_eng_id_e]
+        self.hs["EngStart text"].value = self.xanes_config_eng_list[self.xanes_eng_id_s]
+        self.hs["EngEnd text"].value = self.xanes_config_eng_list[self.xanes_eng_id_e]
         self.hs["FijiEngId sldr"].value = 0
         self.hs["FijiEngId sldr"].min = 0
-        self.hs[
-            "FijiEngId sldr"].max = a["owner"].value[1] - a["owner"].value[0]
+        self.hs["FijiEngId sldr"].max = a["owner"].value[1] - a["owner"].value[0]
         self.boxes_logic()
 
     def FijiRawImgPrev_chbx_chg(self, a):
         if a["owner"].value:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
+                self.global_h, self, viewer_name="xanes2D_raw_img_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name="xanes2D_raw_img_viewer")
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes2D_raw_img_viewer"
+                )
         else:
-            fiji_viewer_off(self.global_h,
-                            self,
-                            viewer_name="xanes2D_raw_img_viewer")
+            fiji_viewer_off(self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
         self.boxes_logic()
 
     def FijiEngId_sldr_chg(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
+            self.global_h, self, viewer_name="xanes2D_raw_img_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_raw_img_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
         self.hs["FijiRawImgPrev chbx"].value = True
         if not data_state:
-            self.hs[
-                "CfmConfigData text"].value = "xanes2D_img is not loaded yet."
+            self.hs["CfmConfigData text"].value = "xanes2D_img is not loaded yet."
         else:
-            self.global_h.xanes2D_fiji_windows["xanes2D_raw_img_viewer"][
-                "ip"].setSlice(a["owner"].value + self.xanes_eng_id_s)
+            self.global_h.xanes2D_fiji_windows["xanes2D_raw_img_viewer"]["ip"].setSlice(
+                a["owner"].value + self.xanes_eng_id_s
+            )
             self.hs["EngStart text"].value = self.xanes_config_eng_list[
-                a["owner"].value + self.xanes_eng_id_s]
+                a["owner"].value + self.xanes_eng_id_s
+            ]
 
     def FijiClose_btn_clk(self, a):
         fiji_viewer_off(self.global_h, self, viewer_name="all")
         self.boxes_logic()
 
     def CfmConfigData_btn_clk(self, a):
         self.xanes_config_is_raw = self.hs["IsRaw chbx"].value
@@ -3331,375 +3350,465 @@
         if a["owner"].value[1] > (self.xanes_img.shape[2] - 20):
             a["owner"].value[1] = self.xanes_img.shape[2] - 20
         self.xanes_reg_roi[2] = a["owner"].value[0]
         self.xanes_reg_roi[3] = a["owner"].value[1]
         self.hs["CfmRoi text"].value = "Please confirm after ROI is set"
 
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
+            self.global_h, self, viewer_name="xanes2D_raw_img_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_raw_img_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
             self.hs["FijiRawImgPrev chbx"].value = True
-        self.global_h.xanes2D_fiji_windows["xanes2D_raw_img_viewer"][
-            "ip"].setRoi(
-                self.hs["2DRoiX sldr"].value[0],
-                self.hs["2DRoiY sldr"].value[0],
-                self.hs["2DRoiX sldr"].value[1] -
-                self.hs["2DRoiX sldr"].value[0],
-                self.hs["2DRoiY sldr"].value[1] -
-                self.hs["2DRoiY sldr"].value[0],
-            )
+        self.global_h.xanes2D_fiji_windows["xanes2D_raw_img_viewer"]["ip"].setRoi(
+            self.hs["2DRoiX sldr"].value[0],
+            self.hs["2DRoiY sldr"].value[0],
+            self.hs["2DRoiX sldr"].value[1] - self.hs["2DRoiX sldr"].value[0],
+            self.hs["2DRoiY sldr"].value[1] - self.hs["2DRoiY sldr"].value[0],
+        )
 
     def Roi2DY_sldr_chg(self, a):
         self.xanes_roi_configured = False
         if a["owner"].value[0] < 20:
             a["owner"].value[0] = 20
         if a["owner"].value[1] > (self.xanes_img.shape[1] - 20):
             a["owner"].value[1] = self.xanes_img.shape[1] - 20
         self.xanes_reg_roi[0] = a["owner"].value[0]
         self.xanes_reg_roi[1] = a["owner"].value[1]
         self.hs["CfmRoi text"].value = "Please confirm after ROI is set"
 
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
+            self.global_h, self, viewer_name="xanes2D_raw_img_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_raw_img_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
             self.hs["FijiRawImgPrev chbx"].value = True
-        self.global_h.xanes2D_fiji_windows["xanes2D_raw_img_viewer"][
-            "ip"].setRoi(
-                self.hs["2DRoiX sldr"].value[0],
-                self.hs["2DRoiY sldr"].value[0],
-                self.hs["2DRoiX sldr"].value[1] -
-                self.hs["2DRoiX sldr"].value[0],
-                self.hs["2DRoiY sldr"].value[1] -
-                self.hs["2DRoiY sldr"].value[0],
-            )
+        self.global_h.xanes2D_fiji_windows["xanes2D_raw_img_viewer"]["ip"].setRoi(
+            self.hs["2DRoiX sldr"].value[0],
+            self.hs["2DRoiY sldr"].value[0],
+            self.hs["2DRoiX sldr"].value[1] - self.hs["2DRoiX sldr"].value[0],
+            self.hs["2DRoiY sldr"].value[1] - self.hs["2DRoiY sldr"].value[0],
+        )
 
     def CfmRoi_btn_clk(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
+            self.global_h, self, viewer_name="xanes2D_raw_img_viewer"
+        )
         if viewer_state:
-            fiji_viewer_off(self.global_h,
-                            self,
-                            viewer_name="xanes2D_raw_img_viewer")
+            fiji_viewer_off(self.global_h, self, viewer_name="xanes2D_raw_img_viewer")
         self.hs["FijiRawImgPrev chbx"].value = False
 
         if self.xanes_roi_configured:
             pass
         else:
             self.xanes_reg_roi[0] = self.hs["2DRoiY sldr"].value[0]
             self.xanes_reg_roi[1] = self.hs["2DRoiY sldr"].value[1]
             self.xanes_reg_roi[2] = self.hs["2DRoiX sldr"].value[0]
             self.xanes_reg_roi[3] = self.hs["2DRoiX sldr"].value[1]
-            self.hs[
-                "AnchorId sldr"].max = self.xanes_eng_id_e - self.xanes_eng_id_s
+            self.hs["AnchorId sldr"].max = self.xanes_eng_id_e - self.xanes_eng_id_s
             self.hs["AnchorId sldr"].value = max(
-                int((self.xanes_eng_id_e - self.xanes_eng_id_s) / 2), 1)
+                int((self.xanes_eng_id_e - self.xanes_eng_id_s) / 2), 1
+            )
             self.hs["AnchorId sldr"].min = 1
             self.xanes_reg_anchor_idx = self.xanes_eng_id_s
             self.hs["CfmRoi text"].value = "ROI is set"
             del self.xanes_img_roi
             gc.collect()
             self.xanes_img_roi = self.xanes_img[
-                self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ]
+                self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+            ]
             self.xanes_reg_mask = (
-                self.xanes_img[0, self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                               self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                0).astype(np.int8)
+                self.xanes_img[
+                    0,
+                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                ]
+                > 0
+            ).astype(np.int8)
             self.update_xanes2D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_file_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
             self.xanes_roi_configured = True
         self.boxes_logic()
 
     def FijiMaskViewer_chbx_chg(self, a):
         if a["owner"].value:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_mask_viewer")
+                self.global_h, self, viewer_name="xanes2D_mask_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name="xanes2D_mask_viewer")
+                fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_mask_viewer")
         else:
-            fiji_viewer_off(self.global_h,
-                            self,
-                            viewer_name="xanes2D_mask_viewer")
+            fiji_viewer_off(self.global_h, self, viewer_name="xanes2D_mask_viewer")
         self.boxes_logic()
 
     def UseChunk_chbx_chg(self, a):
         self.xanes_reg_use_chunk = a["owner"].value
         self.xanes_reg_params_configured = False
         self.boxes_logic()
 
     def AnchorId_sldr_chg(self, a):
         self.xanes_reg_anchor_idx = a["owner"].value + self.xanes_eng_id_s
         if not self.hs["FijiMaskViewer chbx"].value:
             self.hs["FijiMaskViewer chbx"].value = True
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_mask_viewer")
+                self.global_h, self, viewer_name="xanes2D_mask_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name="xanes2D_mask_viewer")
-        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-            "ip"].setSlice(self.xanes_reg_anchor_idx - self.xanes_eng_id_s)
+                fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_mask_viewer")
+        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setSlice(
+            self.xanes_reg_anchor_idx - self.xanes_eng_id_s
+        )
         self.xanes_reg_params_configured = False
         self.xanes_regparams_anchor_idx_set = True
 
     def UseMask_chbx_chg(self, a):
         self.xanes_reg_use_mask = a["owner"].value
         if self.xanes_reg_use_mask:
             self.xanes_reg_mask = (
-                self.xanes_img[self.xanes_reg_anchor_idx,
-                               self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                               self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                self.xanes_reg_use_mask).astype(np.int8)
+                self.xanes_img[
+                    self.xanes_reg_anchor_idx,
+                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                ]
+                > self.xanes_reg_use_mask
+            ).astype(np.int8)
         self.xanes_reg_params_configured = False
         self.boxes_logic()
 
     def MaskThres_sldr_chg(self, a):
         self.xanes_reg_mask_thres = a["owner"].value
         self.hs["AnchorId sldr"].disabled = True
         if self.xanes_reg_mask is None:
             self.xanes_reg_mask = (
-                self.xanes_img[self.xanes_reg_anchor_idx,
-                               self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                               self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                self.xanes_reg_use_mask).astype(np.int8)
+                self.xanes_img[
+                    self.xanes_reg_anchor_idx,
+                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                ]
+                > self.xanes_reg_use_mask
+            ).astype(np.int8)
         if not self.hs["FijiMaskViewer chbx"].value:
             self.hs["FijiMaskViewer chbx"].value = True
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_mask_viewer")
+                self.global_h, self, viewer_name="xanes2D_mask_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name="xanes2D_mask_viewer")
+                fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_mask_viewer")
         if self.xanes_reg_use_smooth_img:
             if self.xanes_reg_mask_dilation_width > 0:
                 self.xanes_reg_mask[:] = skm.binary_dilation(
-                    ((gaussian_filter(
-                        self.xanes_img[
-                            self.xanes_reg_anchor_idx,
-                            self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                            self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                        self.xanes_reg_smooth_img_sigma,
-                    ) > self.xanes_reg_mask_thres).astype(np.int8)),
-                    np.ones([
-                        self.xanes_reg_mask_dilation_width,
-                        self.xanes_reg_mask_dilation_width,
-                    ]),
+                    (
+                        (
+                            gaussian_filter(
+                                self.xanes_img[
+                                    self.xanes_reg_anchor_idx,
+                                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                ],
+                                self.xanes_reg_smooth_img_sigma,
+                            )
+                            > self.xanes_reg_mask_thres
+                        ).astype(np.int8)
+                    ),
+                    np.ones(
+                        [
+                            self.xanes_reg_mask_dilation_width,
+                            self.xanes_reg_mask_dilation_width,
+                        ]
+                    ),
                 )[:]
             else:
-                self.xanes_reg_mask[:] = ((gaussian_filter(
-                    self.xanes_img[
-                        self.xanes_reg_anchor_idx,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                    self.xanes_reg_smooth_img_sigma,
-                ) > self.xanes_reg_mask_thres).astype(np.int8))[:]
-            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-                "ip"].setImage(self.global_h.ij.convert().convert(
+                self.xanes_reg_mask[:] = (
+                    (
+                        gaussian_filter(
+                            self.xanes_img[
+                                self.xanes_reg_anchor_idx,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ],
+                            self.xanes_reg_smooth_img_sigma,
+                        )
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.int8)
+                )[:]
+            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
                             gaussian_filter(
-                                self.xanes_img[:, self.xanes_reg_roi[0]:self.
-                                               xanes_reg_roi[1],
-                                               self.xanes_reg_roi[2]:self.
-                                               xanes_reg_roi[3], ],
+                                self.xanes_img[
+                                    :,
+                                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                ],
                                 self.xanes_reg_smooth_img_sigma,
-                            ) * self.xanes_reg_mask)),
+                            )
+                            * self.xanes_reg_mask
+                        )
+                    ),
                     self.global_h.ImagePlusClass,
-                ))
+                )
+            )
         else:
             if self.xanes_reg_mask_dilation_width > 0:
                 self.xanes_reg_mask[:] = skm.binary_dilation(
-                    ((self.xanes_img[
-                        self.xanes_reg_anchor_idx,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                      self.xanes_reg_mask_thres).astype(np.int8)),
-                    np.ones([
-                        self.xanes_reg_mask_dilation_width,
-                        self.xanes_reg_mask_dilation_width,
-                    ]),
+                    (
+                        (
+                            self.xanes_img[
+                                self.xanes_reg_anchor_idx,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ]
+                            > self.xanes_reg_mask_thres
+                        ).astype(np.int8)
+                    ),
+                    np.ones(
+                        [
+                            self.xanes_reg_mask_dilation_width,
+                            self.xanes_reg_mask_dilation_width,
+                        ]
+                    ),
                 )[:]
             else:
-                self.xanes_reg_mask[:] = ((self.xanes_img[
-                    self.xanes_reg_anchor_idx,
-                    self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                    self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                                           self.xanes_reg_mask_thres).astype(
-                                               np.int8))[:]
-            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-                "ip"].setImage(self.global_h.ij.convert().convert(
+                self.xanes_reg_mask[:] = (
+                    (
+                        self.xanes_img[
+                            self.xanes_reg_anchor_idx,
+                            self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                            self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                        ]
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.int8)
+                )[:]
+            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.xanes_img[:, self.xanes_reg_roi[0]:self.
-                                           xanes_reg_roi[1],
-                                           self.xanes_reg_roi[2]:self.
-                                           xanes_reg_roi[3], ] *
-                            self.xanes_reg_mask)),
+                            self.xanes_img[
+                                :,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ]
+                            * self.xanes_reg_mask
+                        )
+                    ),
                     self.global_h.ImagePlusClass,
-                ))
-        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-            "ip"].setSlice(self.xanes_reg_anchor_idx)
+                )
+            )
+        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setSlice(
+            self.xanes_reg_anchor_idx
+        )
         self.xanes_reg_params_configured = False
 
     def MaskDilation_sldr_chg(self, a):
         self.xanes_reg_mask_dilation_width = a["owner"].value
         self.hs["AnchorId sldr"].disabled = True
         if not self.hs["FijiMaskViewer chbx"].value:
             self.hs["FijiMaskViewer chbx"].value = True
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_mask_viewer")
+                self.global_h, self, viewer_name="xanes2D_mask_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name="xanes2D_mask_viewer")
+                fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_mask_viewer")
         if self.xanes_reg_use_smooth_img:
             if self.xanes_reg_mask_dilation_width > 0:
                 self.xanes_reg_mask[:] = skm.binary_dilation(
-                    ((gaussian_filter(
-                        self.xanes_img[
-                            self.xanes_reg_anchor_idx,
-                            self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                            self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                        self.xanes_reg_smooth_img_sigma,
-                    ) > self.xanes_reg_mask_thres).astype(np.int8)),
-                    np.ones([
-                        self.xanes_reg_mask_dilation_width,
-                        self.xanes_reg_mask_dilation_width,
-                    ]),
+                    (
+                        (
+                            gaussian_filter(
+                                self.xanes_img[
+                                    self.xanes_reg_anchor_idx,
+                                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                ],
+                                self.xanes_reg_smooth_img_sigma,
+                            )
+                            > self.xanes_reg_mask_thres
+                        ).astype(np.int8)
+                    ),
+                    np.ones(
+                        [
+                            self.xanes_reg_mask_dilation_width,
+                            self.xanes_reg_mask_dilation_width,
+                        ]
+                    ),
                 )[:]
             else:
-                self.xanes_reg_mask[:] = ((gaussian_filter(
-                    self.xanes_img[
-                        self.xanes_reg_anchor_idx,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                    self.xanes_reg_smooth_img_sigma,
-                ) > self.xanes_reg_mask_thres).astype(np.int8))[:]
-            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-                "ip"].setImage(self.global_h.ij.convert().convert(
+                self.xanes_reg_mask[:] = (
+                    (
+                        gaussian_filter(
+                            self.xanes_img[
+                                self.xanes_reg_anchor_idx,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ],
+                            self.xanes_reg_smooth_img_sigma,
+                        )
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.int8)
+                )[:]
+            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
                             gaussian_filter(
-                                self.xanes_img[:, self.xanes_reg_roi[0]:self.
-                                               xanes_reg_roi[1],
-                                               self.xanes_reg_roi[2]:self.
-                                               xanes_reg_roi[3], ],
+                                self.xanes_img[
+                                    :,
+                                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                ],
                                 self.xanes_reg_smooth_img_sigma,
-                            ) * self.xanes_reg_mask)),
+                            )
+                            * self.xanes_reg_mask
+                        )
+                    ),
                     self.global_h.ImagePlusClass,
-                ))
+                )
+            )
         else:
             if self.xanes_reg_mask_dilation_width > 0:
                 self.xanes_reg_mask[:] = skm.binary_dilation(
-                    ((self.xanes_img[
-                        self.xanes_reg_anchor_idx,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                      self.xanes_reg_mask_thres).astype(np.int8)),
-                    np.ones([
-                        self.xanes_reg_mask_dilation_width,
-                        self.xanes_reg_mask_dilation_width,
-                    ]),
+                    (
+                        (
+                            self.xanes_img[
+                                self.xanes_reg_anchor_idx,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ]
+                            > self.xanes_reg_mask_thres
+                        ).astype(np.int8)
+                    ),
+                    np.ones(
+                        [
+                            self.xanes_reg_mask_dilation_width,
+                            self.xanes_reg_mask_dilation_width,
+                        ]
+                    ),
                 )[:]
             else:
-                self.xanes_reg_mask[:] = ((self.xanes_img[
-                    self.xanes_reg_anchor_idx,
-                    self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                    self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                                           self.xanes_reg_mask_thres).astype(
-                                               np.int8))[:]
-            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-                "ip"].setImage(self.global_h.ij.convert().convert(
+                self.xanes_reg_mask[:] = (
+                    (
+                        self.xanes_img[
+                            self.xanes_reg_anchor_idx,
+                            self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                            self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                        ]
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.int8)
+                )[:]
+            self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.xanes_img[:, self.xanes_reg_roi[0]:self.
-                                           xanes_reg_roi[1],
-                                           self.xanes_reg_roi[2]:self.
-                                           xanes_reg_roi[3], ] *
-                            self.xanes_reg_mask)),
+                            self.xanes_img[
+                                :,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ]
+                            * self.xanes_reg_mask
+                        )
+                    ),
                     self.global_h.ImagePlusClass,
-                ))
-        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-            "ip"].setSlice(self.xanes_reg_anchor_idx)
+                )
+            )
+        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setSlice(
+            self.xanes_reg_anchor_idx
+        )
         self.xanes_reg_params_configured = False
 
     def UseSmooth_chbx_chg(self, a):
         self.xanes_reg_use_smooth_img = a["owner"].value
         self.xanes_reg_params_configured = False
         self.boxes_logic()
 
     def SmoothSigma_text_chg(self, a):
         self.xanes_reg_smooth_img_sigma = a["owner"].value
         if self.xanes_reg_use_mask:
             self.xanes_reg_mask = (
-                self.xanes_img[self.xanes_reg_anchor_idx,
-                               self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                               self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                self.xanes_reg_use_mask).astype(np.int8)
+                self.xanes_img[
+                    self.xanes_reg_anchor_idx,
+                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                ]
+                > self.xanes_reg_use_mask
+            ).astype(np.int8)
         if not self.hs["FijiMaskViewer chbx"].value:
             self.hs["FijiMaskViewer chbx"].value = True
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_mask_viewer")
+                self.global_h, self, viewer_name="xanes2D_mask_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name="xanes2D_mask_viewer")
+                fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_mask_viewer")
         if self.xanes_reg_mask_dilation_width > 0:
             self.xanes_reg_mask[:] = skm.binary_dilation(
-                ((gaussian_filter(
-                    self.xanes_img[
-                        self.xanes_reg_anchor_idx,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                    self.xanes_reg_smooth_img_sigma,
-                ) > self.xanes_reg_mask_thres).astype(np.int8)),
-                np.ones([
-                    self.xanes_reg_mask_dilation_width,
-                    self.xanes_reg_mask_dilation_width,
-                ]),
+                (
+                    (
+                        gaussian_filter(
+                            self.xanes_img[
+                                self.xanes_reg_anchor_idx,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ],
+                            self.xanes_reg_smooth_img_sigma,
+                        )
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.int8)
+                ),
+                np.ones(
+                    [
+                        self.xanes_reg_mask_dilation_width,
+                        self.xanes_reg_mask_dilation_width,
+                    ]
+                ),
             )[:]
         else:
-            self.xanes_reg_mask[:] = ((gaussian_filter(
-                self.xanes_img[self.xanes_reg_anchor_idx,
-                               self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                               self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                self.xanes_reg_smooth_img_sigma,
-            ) > self.xanes_reg_mask_thres).astype(np.int8))[:]
-        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+            self.xanes_reg_mask[:] = (
+                (
+                    gaussian_filter(
+                        self.xanes_img[
+                            self.xanes_reg_anchor_idx,
+                            self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                            self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                        ],
+                        self.xanes_reg_smooth_img_sigma,
+                    )
+                    > self.xanes_reg_mask_thres
+                ).astype(np.int8)
+            )[:]
+        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
                     self.global_h.ij.py.to_java(
                         gaussian_filter(
-                            self.xanes_img[:, self.xanes_reg_roi[0]:self.
-                                           xanes_reg_roi[1],
-                                           self.xanes_reg_roi[2]:self.
-                                           xanes_reg_roi[3], ],
+                            self.xanes_img[
+                                :,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ],
                             self.xanes_reg_smooth_img_sigma,
-                        ) * self.xanes_reg_mask)),
+                        )
+                        * self.xanes_reg_mask
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"][
-            "ip"].setSlice(self.xanes_reg_anchor_idx)
+            )
+        )
+        self.global_h.xanes2D_fiji_windows["xanes2D_mask_viewer"]["ip"].setSlice(
+            self.xanes_reg_anchor_idx
+        )
         self.xanes_reg_params_configured = False
 
     def ChunkSz_sldr_chg(self, a):
         self.xanes_reg_chunk_sz = a["owner"].value
         self.xanes_reg_params_configured = False
 
     def RegMethod_drpdn_chg(self, a):
@@ -3739,282 +3848,347 @@
             self.hs["MrtvSubpixelWz text"].value = 5
         self.xanes_reg_params_configured = False
         self.boxes_logic()
 
     def CfmRegParams_btn_clk(self, a):
         if self.xanes_reg_params_configured:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_mask_viewer")
+                self.global_h, self, viewer_name="xanes2D_mask_viewer"
+            )
             if viewer_state:
-                fiji_viewer_off(self.global_h,
-                                self,
-                                viewer_name="xanes2D_mask_viewer")
+                fiji_viewer_off(self.global_h, self, viewer_name="xanes2D_mask_viewer")
         self.hs["FijiMaskViewer chbx"].value = False
 
         self.xanes_reg_use_chunk = self.hs["UseChunk chbx"].value
-        self.xanes_reg_anchor_idx = self.hs[
-            "AnchorId sldr"].value + self.xanes_eng_id_s
+        self.xanes_reg_anchor_idx = self.hs["AnchorId sldr"].value + self.xanes_eng_id_s
         self.xanes_reg_use_mask = self.hs["UseMask chbx"].value
         self.xanes_reg_mask_thres = self.hs["MaskThres sldr"].value
         self.xanes_reg_mask_dilation_width = self.hs["MaskDilation sldr"].value
         self.xanes_reg_use_smooth_img = self.hs["UseSmooth chbx"].value
         self.xanes_reg_smooth_img_sigma = self.hs["SmoothSigma text"].value
         self.xanes_reg_chunk_sz = self.hs["ChunkSz sldr"].value
         self.xanes_reg_method = self.hs["RegMethod drpdn"].value
         self.xanes_reg_ref_mode = self.hs["RefMode drpdn"].value
         self.xanes_reg_mrtv_level = self.hs["MrtvLevel text"].value
         self.xanes_reg_mrtv_width = self.hs["MrtvWz text"].value
-        self.xanes_reg_mrtv_subpixel_kernel = self.hs[
-            "MrtvSubpixelKernel text"].value
+        self.xanes_reg_mrtv_subpixel_kernel = self.hs["MrtvSubpixelKernel text"].value
         self.xanes_reg_mrtv_subpixel_wz = self.hs["MrtvSubpixelWz text"].value
         if self.hs["MrtvSubpixelSrch drpdn"].value == "analytical":
             self.xanes_reg_mrtv_subpixel_srch_option = "ana"
         else:
             self.xanes_reg_mrtv_subpixel_srch_option = "fit"
 
         if self.xanes_reg_use_mask:
             if self.xanes_reg_use_smooth_img:
                 self.xanes_img_roi[:] = gaussian_filter(
                     self.xanes_img[
-                        self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
+                        self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                        self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                        self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                    ],
                     self.xanes_reg_smooth_img_sigma,
                 )[:]
                 if self.xanes_reg_mask_dilation_width > 0:
                     self.xanes_reg_mask[:] = skm.binary_dilation(
-                        ((gaussian_filter(
-                            self.xanes_img[
-                                self.xanes_reg_anchor_idx,
-                                self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                                self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                            self.xanes_reg_smooth_img_sigma,
-                        ) > self.xanes_reg_mask_thres).astype(np.int8)),
-                        np.ones([
-                            self.xanes_reg_mask_dilation_width,
-                            self.xanes_reg_mask_dilation_width,
-                        ]),
+                        (
+                            (
+                                gaussian_filter(
+                                    self.xanes_img[
+                                        self.xanes_reg_anchor_idx,
+                                        self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                        self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                    ],
+                                    self.xanes_reg_smooth_img_sigma,
+                                )
+                                > self.xanes_reg_mask_thres
+                            ).astype(np.int8)
+                        ),
+                        np.ones(
+                            [
+                                self.xanes_reg_mask_dilation_width,
+                                self.xanes_reg_mask_dilation_width,
+                            ]
+                        ),
                     )[:]
                 else:
-                    self.xanes_reg_mask[:] = ((gaussian_filter(
-                        self.xanes_img[
-                            self.xanes_reg_anchor_idx,
-                            self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                            self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
-                        self.xanes_reg_smooth_img_sigma,
-                    ) > self.xanes_reg_mask_thres).astype(np.int8))[:]
+                    self.xanes_reg_mask[:] = (
+                        (
+                            gaussian_filter(
+                                self.xanes_img[
+                                    self.xanes_reg_anchor_idx,
+                                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                ],
+                                self.xanes_reg_smooth_img_sigma,
+                            )
+                            > self.xanes_reg_mask_thres
+                        ).astype(np.int8)
+                    )[:]
             else:
                 self.xanes_img_roi[:] = self.xanes_img[
-                    self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                    self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                    self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ]
+                    self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                ]
                 if self.xanes_reg_mask_dilation_width > 0:
                     self.xanes_reg_mask[:] = skm.binary_dilation(
-                        ((self.xanes_img[
-                            self.xanes_reg_anchor_idx,
-                            self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                            self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                          self.xanes_reg_mask_thres).astype(np.int8)),
-                        np.ones([
-                            self.xanes_reg_mask_dilation_width,
-                            self.xanes_reg_mask_dilation_width,
-                        ]),
+                        (
+                            (
+                                self.xanes_img[
+                                    self.xanes_reg_anchor_idx,
+                                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                                ]
+                                > self.xanes_reg_mask_thres
+                            ).astype(np.int8)
+                        ),
+                        np.ones(
+                            [
+                                self.xanes_reg_mask_dilation_width,
+                                self.xanes_reg_mask_dilation_width,
+                            ]
+                        ),
                     )[:]
                 else:
                     self.xanes_reg_mask[:] = (
-                        (self.xanes_img[
-                            self.xanes_reg_anchor_idx,
-                            self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                            self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ] >
-                         self.xanes_reg_mask_thres).astype(np.int8))[:]
+                        (
+                            self.xanes_img[
+                                self.xanes_reg_anchor_idx,
+                                self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                                self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                            ]
+                            > self.xanes_reg_mask_thres
+                        ).astype(np.int8)
+                    )[:]
         else:
             if self.xanes_reg_use_smooth_img:
                 self.xanes_img_roi[:] = gaussian_filter(
                     self.xanes_img[
-                        self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                        self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                        self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ],
+                        self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                        self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                        self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                    ],
                     self.xanes_reg_smooth_img_sigma,
                 )[:]
             else:
                 self.xanes_img_roi[:] = self.xanes_img[
-                    self.xanes_eng_id_s:self.xanes_eng_id_e + 1,
-                    self.xanes_reg_roi[0]:self.xanes_reg_roi[1],
-                    self.xanes_reg_roi[2]:self.xanes_reg_roi[3], ]
+                    self.xanes_eng_id_s : self.xanes_eng_id_e + 1,
+                    self.xanes_reg_roi[0] : self.xanes_reg_roi[1],
+                    self.xanes_reg_roi[2] : self.xanes_reg_roi[3],
+                ]
         self.update_xanes2D_config()
         json.dump(
             self.xanes_config,
             open(self.xanes_file_save_trial_reg_config_filename, "w"),
             cls=NumpyArrayEncoder,
         )
         self.xanes_reg_params_configured = True
         self.boxes_logic()
 
     def RunReg_btn_clk(self, a):
-        tmp_file = os.path.join(self.global_h.tmp_dir, "xanes2D_tmp.h5")
+        # tmp_file = os.path.join(self.global_h.tmp_dir, "xanes2D_tmp.h5")
+        tmp_file = str(Path(self.global_h.tmp_dir) / "xanes2D_tmp.h5")
         with h5py.File(tmp_file, "w") as f:
-            f.create_dataset("analysis_eng_list",
-                             data=self.xanes_fit_eng_list.astype(np.float32))
-            f.create_dataset("xanes2D_img",
-                             data=self.xanes_img.astype(np.float32))
+            f.create_dataset(
+                "analysis_eng_list", data=self.xanes_fit_eng_list.astype(np.float32)
+            )
+            f.create_dataset("xanes2D_img", data=self.xanes_img.astype(np.float32))
             if self.xanes_reg_mask is not None:
-                f.create_dataset("xanes2D_reg_mask",
-                                 data=self.xanes_reg_mask.astype(np.float32))
+                f.create_dataset(
+                    "xanes2D_reg_mask", data=self.xanes_reg_mask.astype(np.float32)
+                )
             else:
                 f.create_dataset("xanes2D_reg_mask", data=np.array([0]))
         code = {}
         ln = 0
 
-        code[ln] = f"import os"
+        # code[ln] = f"import os"
+        code[ln] = f"from pathlib import Path"
         ln += 1
         code[ln] = f"from TXM_Sandbox.utils import xanes_regtools as xr"
         ln += 1
         code[ln] = f"from multiprocessing import freeze_support"
         ln += 1
         code[ln] = f"if __name__ == '__main__':"
         ln += 1
         code[ln] = f"    freeze_support()"
         ln += 1
-        code[
-            ln] = f"    reg = xr.regtools(dtype='2D_XANES', method='{self.xanes_reg_method}', mode='TRANSLATION')"
+        code[ln] = (
+            f"    reg = xr.regtools(dtype='2D_XANES', method='{self.xanes_reg_method}', mode='TRANSLATION')"
+        )
         ln += 1
-        code[
-            ln] = f"    reg.set_xanes2D_raw_filename('{self.xanes_file_raw_h5_filename}')"
+        code[ln] = (
+            f"    reg.set_xanes2D_raw_filename('{self.xanes_file_raw_h5_filename}')"
+        )
         ln += 1
         kwargs = {
             "raw_h5_filename": self.xanes_file_raw_h5_filename,
             "config_filename": self.xanes_file_save_trial_reg_config_filename,
         }
         code[ln] = f"    reg.set_raw_data_info(**{kwargs})"
         ln += 1
         code[ln] = f"    reg.set_method('{self.xanes_reg_method}')"
         ln += 1
         code[ln] = f"    reg.set_ref_mode('{self.xanes_reg_ref_mode}')"
         ln += 1
         code[ln] = f"    reg.set_roi({self.xanes_reg_roi})"
         ln += 1
-        code[
-            ln] = f"    reg.set_indices({self.xanes_eng_id_s}, {self.xanes_eng_id_e + 1}, {self.xanes_reg_anchor_idx})"
+        code[ln] = (
+            f"    reg.set_indices({self.xanes_eng_id_s}, {self.xanes_eng_id_e + 1}, {self.xanes_reg_anchor_idx})"
+        )
         ln += 1
         code[ln] = f"    reg.set_xanes2D_tmp_filename('{tmp_file}')"
         ln += 1
         code[ln] = f"    reg.read_xanes2D_tmp_file(mode='reg')"
         ln += 1
-        code[
-            ln] = f"    reg.set_reg_options(use_mask={self.xanes_reg_use_mask}, mask_thres={self.xanes_reg_mask_thres},\
+        code[ln] = (
+            f"    reg.set_reg_options(use_mask={self.xanes_reg_use_mask}, mask_thres={self.xanes_reg_mask_thres},\
                      use_chunk={self.xanes_reg_use_chunk}, chunk_sz={self.xanes_reg_chunk_sz},\
                      use_smooth_img={self.xanes_reg_use_smooth_img}, smooth_sigma={self.xanes_reg_smooth_img_sigma},\
                      mrtv_level={self.xanes_reg_mrtv_level}, mrtv_width={self.xanes_reg_mrtv_width}, \
                      mrtv_sp_wz={self.xanes_reg_mrtv_subpixel_wz}, mrtv_sp_kernel={self.xanes_reg_mrtv_subpixel_kernel})"
+        )
 
         ln += 1
-        code[
-            ln] = f"    reg.set_saving(os.path.dirname('{self.xanes_save_trial_reg_filename}'), \
-                     fn=os.path.basename('{self.xanes_save_trial_reg_filename}'))"
+        # code[ln] = (
+        #     f"    reg.set_saving(os.path.dirname('{self.xanes_save_trial_reg_filename}'), \
+        #              fn=os.path.basename('{self.xanes_save_trial_reg_filename}'))"
+        # )
+        code[ln] = (
+            f"    reg.set_saving('{str(Path(self.xanes_save_trial_reg_filename).parent)}', \
+                     fn='{Path(self.xanes_save_trial_reg_filename).name}')"
+        )
 
         ln += 1
         code[ln] = f"    reg.compose_dicts()"
         ln += 1
         code[ln] = f"    reg.reg_xanes2D_chunk()"
         ln += 1
 
         gen_external_py_script(self.xanes_reg_external_command_name, code)
         sig = os.system(f"python {self.xanes_reg_external_command_name}")
 
         print(sig)
         if sig == 0:
             self.hs["RunReg text"].value = "XANES2D registration is done"
             self.xanes_review_aligned_img_original = np.ndarray(
-                self.xanes_img_roi[0].shape)
-            self.xanes_review_aligned_img = np.ndarray(
-                self.xanes_img_roi[0].shape)
-            self.xanes_review_fixed_img = np.ndarray(
-                self.xanes_img_roi[0].shape)
+                self.xanes_img_roi[0].shape
+            )
+            self.xanes_review_aligned_img = np.ndarray(self.xanes_img_roi[0].shape)
+            self.xanes_review_fixed_img = np.ndarray(self.xanes_img_roi[0].shape)
             self.xanes_review_shift_dict = {}
             with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                 self.xanes_alignment_pairs = f[
-                    "/trial_registration/trial_reg_parameters/alignment_pairs"][:]
+                    "/trial_registration/trial_reg_parameters/alignment_pairs"
+                ][:]
                 for ii in range(self.xanes_alignment_pairs.shape[0]):
                     self.xanes_review_shift_dict["{}".format(ii)] = f[
-                        "/trial_registration/trial_reg_results/{0}/shift{0}".
-                        format(str(ii).zfill(3))][:]
+                        "/trial_registration/trial_reg_results/{0}/shift{0}".format(
+                            str(ii).zfill(3)
+                        )
+                    ][:]
                     print(ii)
             self.hs["RegPair sldr"].min = 0
-            self.hs[
-                "RegPair sldr"].max = self.xanes_alignment_pairs.shape[0] - 1
+            self.hs["RegPair sldr"].max = self.xanes_alignment_pairs.shape[0] - 1
 
             self.xanes_reg_done = True
-            self.xanes_review_reg_best_match_filename = (os.path.splitext(
-                self.xanes_file_save_trial_reg_config_filename)[0].replace(
-                    "config", "reg_best_match") + ".json")
+            # self.xanes_review_reg_best_match_filename = (
+            #     os.path.splitext(self.xanes_file_save_trial_reg_config_filename)[
+            #         0
+            #     ].replace("config", "reg_best_match")
+            #     + ".json"
+            # )
+            self.xanes_review_reg_best_match_filename = str(
+                Path(self.xanes_file_save_trial_reg_config_filename).parent
+                / (
+                    Path(self.xanes_file_save_trial_reg_config_filename).stem.replace(
+                        "config", "reg_best_match"
+                    )
+                    + ".json"
+                )
+            )
             self.update_xanes2D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_file_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
             self.hs["RegPair sldr"].value = 0
         else:
-            self.hs[
-                "RunReg text"].value = "Something went wrong during XANES2D registration"
+            self.hs["RunReg text"].value = (
+                "Something went wrong during XANES2D registration"
+            )
             self.xanes_reg_done = False
         self.boxes_logic()
 
     def ReadAlign_chbx_chg(self, a):
         self.xanes_use_existing_reg_reviewed = a["owner"].value
         self.xanes_reg_review_done = False
         self.boxes_logic()
 
     def ReadAlign_btn_clk(self, a):
         if len(a.files[0]) != 0:
             try:
-                self.xanes_reg_review_file = os.path.abspath(a.files[0])
-                if os.path.splitext(self.xanes_reg_review_file)[1] == ".json":
+                # self.xanes_reg_review_file = os.path.abspath(a.files[0])
+                # if os.path.splitext(self.xanes_reg_review_file)[1] == ".json":
+                #     self.xanes_review_shift_dict = json.load(
+                #         open(self.xanes_reg_review_file, "r")
+                #     )
+                self.xanes_reg_review_file = str(Path(a.files[0]).absolute())
+                if Path(self.xanes_reg_review_file).suffix == ".json":
                     self.xanes_review_shift_dict = json.load(
-                        open(self.xanes_reg_review_file, "r"))
+                        open(self.xanes_reg_review_file, "r")
+                    )
                 else:
                     self.xanes_review_shift_dict = np.float32(
-                        np.genfromtxt(self.xanes_reg_review_file))
+                        np.genfromtxt(self.xanes_reg_review_file)
+                    )
                 for ii in self.xanes_review_shift_dict:
                     self.xanes_review_shift_dict[ii] = np.float32(
-                        np.array(self.xanes_review_shift_dict[ii]))
+                        np.array(self.xanes_review_shift_dict[ii])
+                    )
                 self.xanes_reg_file_readed = True
             except:
                 self.xanes_reg_file_readed = False
         else:
             self.xanes_reg_file_readed = False
         self.xanes_reg_review_done = False
         self.boxes_logic()
 
     def RegPair_sldr_chg(self, a):
         self.xanes_review_alignment_pair_id = a["owner"].value
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             self.xanes_review_aligned_img_original[:] = f[
-                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".
-                format(str(self.xanes_review_alignment_pair_id).zfill(3))][:]
+                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                    str(self.xanes_review_alignment_pair_id).zfill(3)
+                )
+            ][:]
             self.xanes_review_fixed_img[:] = f[
-                "/trial_registration/trial_reg_results/{0}/trial_reg_fixed{0}".
-                format(str(self.xanes_review_alignment_pair_id).zfill(3))][:]
+                "/trial_registration/trial_reg_results/{0}/trial_reg_fixed{0}".format(
+                    str(self.xanes_review_alignment_pair_id).zfill(3)
+                )
+            ][:]
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_review_viewer")
+            self.global_h, self, viewer_name="xanes2D_review_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_review_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_review_viewer")
 
-        self.global_h.xanes2D_fiji_windows["xanes2D_review_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+        self.global_h.xanes2D_fiji_windows["xanes2D_review_viewer"]["ip"].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
                     self.global_h.ij.py.to_java(
-                        self.xanes_review_aligned_img_original -
-                        self.xanes_review_fixed_img)),
+                        self.xanes_review_aligned_img_original
+                        - self.xanes_review_fixed_img
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
         self.xanes_review_bad_shift = False
 
     def RegPairBad_btn_clk(self, a):
         self.xanes_manual_xshift = 0
         self.xanes_manual_yshift = 0
         self.xanes_review_bad_shift = True
         self.boxes_logic()
@@ -4022,107 +4196,117 @@
     def XShift_text_chg(self, a):
         self.xanes_manual_xshift = a["owner"].value
         self.xanes_review_aligned_img[:] = np.real(
             np.fft.ifftn(
                 fourier_shift(
                     np.fft.fftn(self.xanes_review_aligned_img_original),
                     [self.xanes_manual_yshift, self.xanes_manual_xshift],
-                )))[:]
+                )
+            )
+        )[:]
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_review_viewer")
+            self.global_h, self, viewer_name="xanes2D_review_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_review_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_review_viewer")
 
-        self.global_h.xanes2D_fiji_windows["xanes2D_review_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+        self.global_h.xanes2D_fiji_windows["xanes2D_review_viewer"]["ip"].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(self.xanes_review_aligned_img -
-                                                self.xanes_review_fixed_img)),
+                    self.global_h.ij.py.to_java(
+                        self.xanes_review_aligned_img - self.xanes_review_fixed_img
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
     def YShift_text_chg(self, a):
         self.xanes_manual_yshift = a["owner"].value
         self.xanes_review_aligned_img[:] = np.real(
             np.fft.ifftn(
                 fourier_shift(
                     np.fft.fftn(self.xanes_review_aligned_img_original),
                     [self.xanes_manual_yshift, self.xanes_manual_xshift],
-                )))[:]
+                )
+            )
+        )[:]
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_review_viewer")
+            self.global_h, self, viewer_name="xanes2D_review_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_review_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_review_viewer")
 
-        self.global_h.xanes2D_fiji_windows["xanes2D_review_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+        self.global_h.xanes2D_fiji_windows["xanes2D_review_viewer"]["ip"].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(self.xanes_review_aligned_img -
-                                                self.xanes_review_fixed_img)),
+                    self.global_h.ij.py.to_java(
+                        self.xanes_review_aligned_img - self.xanes_review_fixed_img
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
     def Record_btn_clk(self, a):
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             shift = f[
                 "/trial_registration/trial_reg_results/{0}/shift{0}".format(
-                    str(self.xanes_review_alignment_pair_id).zfill(3))][:]
+                    str(self.xanes_review_alignment_pair_id).zfill(3)
+                )
+            ][:]
         if self.xanes_reg_method.upper() == "SR":
             shift[0, 2] += self.xanes_manual_yshift
             shift[1, 2] += self.xanes_manual_xshift
-            self.xanes_review_shift_dict["{}".format(
-                self.xanes_review_alignment_pair_id)] = np.array(shift)
+            self.xanes_review_shift_dict[
+                "{}".format(self.xanes_review_alignment_pair_id)
+            ] = np.array(shift)
         else:
-            self.xanes_review_shift_dict["{}".format(
-                self.xanes_review_alignment_pair_id)] = np.array([
+            self.xanes_review_shift_dict[
+                "{}".format(self.xanes_review_alignment_pair_id)
+            ] = np.array(
+                [
                     shift[0] + self.xanes_manual_yshift,
                     shift[1] + self.xanes_manual_xshift,
-                ])
+                ]
+            )
         self.hs["XShift text"].value = 0
         self.hs["YShift text"].value = 0
         json.dump(
             self.xanes_review_shift_dict,
             open(self.xanes_review_reg_best_match_filename, "w"),
             cls=NumpyArrayEncoder,
         )
         self.xanes_review_bad_shift = False
         self.boxes_logic()
 
     def CfmRevRlt_btn_clk(self, a):
-        if len(self.xanes_review_shift_dict) != (self.hs["RegPair sldr"].max +
-                                                 1):
-            self.hs[
-                "CfmRevRlt text"].value = "reg review is not completed yet ..."
+        if len(self.xanes_review_shift_dict) != (self.hs["RegPair sldr"].max + 1):
+            self.hs["CfmRevRlt text"].value = "reg review is not completed yet ..."
             idx = []
             offset = []
             for ii in sorted(self.xanes_review_shift_dict.keys()):
                 offset.append(self.xanes_review_shift_dict[ii][0])
                 idx.append(int(ii))
             plt.figure(1)
             plt.plot(idx, offset, "b+")
             plt.xticks(np.arange(0, len(idx) + 1, 5))
             plt.grid()
             self.xanes_reg_review_done = False
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes2D_review_viewer")
+                self.global_h, self, viewer_name="xanes2D_review_viewer"
+            )
             if viewer_state:
-                fiji_viewer_off(self.global_h,
-                                self,
-                                viewer_name="xanes2D_review_viewer")
-            self.hs[
-                "CfmRevRlt text"].value = "reg review is not completed yet ..."
+                fiji_viewer_off(
+                    self.global_h, self, viewer_name="xanes2D_review_viewer"
+                )
+            self.hs["CfmRevRlt text"].value = "reg review is not completed yet ..."
             self.xanes_reg_review_done = True
             self.update_xanes2D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_file_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
@@ -4130,76 +4314,81 @@
                 self.xanes_review_shift_dict,
                 open(self.xanes_review_reg_best_match_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
         self.boxes_logic()
 
     def AlignImg_btn_clk(self, a):
-        tmp_file = os.path.join(self.global_h.tmp_dir, "xanes2D_tmp.h5")
+        # tmp_file = os.path.join(self.global_h.tmp_dir, "xanes2D_tmp.h5")
+        tmp_file = str(Path(self.global_h.tmp_dir) / "xanes2D_tmp.h5")
         tmp_dict = {}
         for key in self.xanes_review_shift_dict.keys():
             tmp_dict[key] = tuple(self.xanes_review_shift_dict[key])
         code = {}
         ln = 0
         code[ln] = f"import TXM_Sandbox.utils.xanes_regtools as xr"
         ln += 1
-        code[
-            ln] = f"reg = xr.regtools(dtype='2D_XANES', method='{self.xanes_reg_method}', mode='TRANSLATION')"
+        code[ln] = (
+            f"reg = xr.regtools(dtype='2D_XANES', method='{self.xanes_reg_method}', mode='TRANSLATION')"
+        )
         ln += 1
         code[ln] = f"reg.set_roi({self.xanes_reg_roi})"
         ln += 1
-        code[
-            ln] = f"reg.set_indices({self.xanes_eng_id_s}, {self.xanes_eng_id_e + 1}, {self.xanes_reg_anchor_idx})"
+        code[ln] = (
+            f"reg.set_indices({self.xanes_eng_id_s}, {self.xanes_eng_id_e + 1}, {self.xanes_reg_anchor_idx})"
+        )
         ln += 1
         code[ln] = f"reg.set_xanes2D_tmp_filename('{tmp_file}')"
         ln += 1
         code[ln] = f"reg.read_xanes2D_tmp_file(mode='align')"
         ln += 1
-        code[ln] = f"reg.apply_xanes2D_chunk_shift({tmp_dict}, \
+        code[ln] = (
+            f"reg.apply_xanes2D_chunk_shift({tmp_dict}, \
                      trialfn='{self.xanes_save_trial_reg_filename}', \
                      savefn='{self.xanes_save_trial_reg_filename}')"
+        )
 
         ln += 1
 
         gen_external_py_script(self.xanes_align_external_command_name, code)
         sig = os.system(f"python '{self.xanes_align_external_command_name}'")
         if sig == 0:
             self.hs["AlignImg text"].value = "XANES2D alignment is done ..."
         else:
-            self.hs[
-                "AlignImg text"].value = "Something wrong during XANES2D alignment"
+            self.hs["AlignImg text"].value = "Something wrong during XANES2D alignment"
 
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_analysis_viewer")
+            self.global_h, self, viewer_name="xanes2D_analysis_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_analysis_viewer")
-        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_analysis_viewer")
+        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"]["ip"].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(self.xanes_img_roi)),
+                    self.global_h.ij.py.to_java(self.xanes_img_roi)
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].setSlice(0)
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"]["ip"].setSlice(0)
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             self.xanes_fit_data_shape = f[
-                "/registration_results/reg_results/registered_xanes2D"].shape
-            self.xanes_fit_eng_list = f[
-                "/registration_results/reg_results/eng_list"][:]
+                "/registration_results/reg_results/registered_xanes2D"
+            ].shape
+            self.xanes_fit_eng_list = f["/registration_results/reg_results/eng_list"][:]
             if self.xanes_img_roi is None:
                 self.xanes_img_roi = f[
-                    "/registration_results/reg_results/registered_xanes2D"][:]
+                    "/registration_results/reg_results/registered_xanes2D"
+                ][:]
             else:
                 self.xanes_img_roi = f[
-                    "/registration_results/reg_results/registered_xanes2D"][:]
+                    "/registration_results/reg_results/registered_xanes2D"
+                ][:]
 
         self.hs["Vis sldr"].min = 1
         self.hs["Vis sldr"].max = self.xanes_fit_eng_list.shape[0]
         self.hs["Vis sldr"].value = 2
 
         self.xanes_element = determine_element(self.xanes_fit_eng_list)
         tem = determine_fitting_energy_range(self.xanes_element)
@@ -4208,18 +4397,17 @@
         self.xanes_fit_wl_fit_eng_e = tem[2]
         self.xanes_fit_pre_edge_e = tem[3]
         self.xanes_fit_post_edge_s = tem[4]
         self.xanes_fit_edge_0p5_fit_s = tem[5]
         self.xanes_fit_edge_0p5_fit_e = tem[6]
         self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "wl"
         self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
-        if (self.xanes_fit_eng_list.min() >
-            (self.xanes_fit_edge_eng - 50)) and (
-                self.xanes_fit_eng_list.max() <
-                (self.xanes_fit_edge_eng + 50)):
+        if (self.xanes_fit_eng_list.min() > (self.xanes_fit_edge_eng - 50)) and (
+            self.xanes_fit_eng_list.max() < (self.xanes_fit_edge_eng + 50)
+        ):
             self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "wl"
             self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].disabled = True
             self.xanes_fit_type = "wl"
         else:
             self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
             self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].disabled = False
             self.xanes_fit_type = "full"
@@ -4230,51 +4418,57 @@
             self.xanes_config,
             open(self.xanes_file_save_trial_reg_config_filename, "w"),
             cls=NumpyArrayEncoder,
         )
         self.boxes_logic()
 
     def Vis_sldr_chg(self, a):
-        self.hs["VisEng text"].value = self.xanes_fit_eng_list[a["owner"].value
-                                                               - 1]
+        self.hs["VisEng text"].value = self.xanes_fit_eng_list[a["owner"].value - 1]
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_analysis_viewer")
+            self.global_h, self, viewer_name="xanes2D_analysis_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_analysis_viewer")
-        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_analysis_viewer")
+        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"]["ip"].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(self.xanes_img_roi)),
+                    self.global_h.ij.py.to_java(self.xanes_img_roi)
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].setSlice(a["owner"].value)
+            )
+        )
+        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"]["ip"].setSlice(
+            a["owner"].value
+        )
         if self.xanes_visualization_auto_bc:
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
 
     def VisRC_chbx_chg(self, a):
         self.xanes_visualization_auto_bc = a["owner"].value
         self.boxes_logic()
 
     def SpecInRoi_btn_clk(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes2D_analysis_viewer")
+            self.global_h, self, viewer_name="xanes2D_analysis_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes2D_analysis_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes2D_analysis_viewer")
         width = self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].getWidth()
+            "ip"
+        ].getWidth()
         height = self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].getHeight()
+            "ip"
+        ].getHeight()
         roi = [int((width - 10) / 2), int((height - 10) / 2), 10, 10]
-        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"][
-            "ip"].setRoi(roi[0], roi[1], roi[2], roi[3])
+        self.global_h.xanes2D_fiji_windows["xanes2D_analysis_viewer"]["ip"].setRoi(
+            roi[0], roi[1], roi[2], roi[3]
+        )
         self.global_h.ij.py.run_macro("""run("Plot Z-axis Profile")""")
         self.global_h.xanes2D_fiji_windows["analysis_viewer_z_plot_viewer"][
-            "ip"] = self.global_h.WindowManager.getCurrentImage()
+            "ip"
+        ] = self.global_h.WindowManager.getCurrentImage()
         self.global_h.xanes2D_fiji_windows["analysis_viewer_z_plot_viewer"][
-            "fiji_id"] = self.global_h.WindowManager.getIDList()[-1]
+            "fiji_id"
+        ] = self.global_h.WindowManager.getIDList()[-1]
         self.boxes_logic()
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes3D_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes3D_gui.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,15 +1,22 @@
 #!/usr/bin/env python3
 # -*- coding: utf-8 -*-
 """
 Created on Thu Jun 18 19:04:50 2020
 
 @author: xiao
 """
-import os, glob, h5py, json, time, numpy as np
+import os
+import glob
+import h5py
+import json
+import time
+import datetime
+import numpy as np
+from pathlib import Path
 
 import traitlets
 from ipywidgets import widgets
 import skimage.morphology as skm
 import matplotlib.pyplot as plt
 from scipy.ndimage import fourier_shift
 import napari
@@ -46,27 +53,40 @@
         if self.global_h.io_xanes3D_cfg["use_h5_reader"]:
             self.reader = data_reader(xanes3D_h5_reader)
         else:
             from ..external.user_io import user_xanes3D_reader
 
             self.reader = data_reader(user_xanes3D_reader)
 
-        self.xanes_raw_fn_temp = self.global_h.io_xanes3D_cfg[
-            "tomo_raw_fn_template"]
+        self.xanes_raw_fn_temp = self.global_h.io_xanes3D_cfg["tomo_raw_fn_template"]
         self.xanes_recon_dir_temp = self.global_h.io_xanes3D_cfg[
-            "xanes3D_recon_dir_template"]
+            "xanes3D_recon_dir_template"
+        ]
         self.xanes_recon_fn_temp = self.global_h.io_xanes3D_cfg[
-            "xanes3D_recon_fn_template"]
+            "xanes3D_recon_fn_template"
+        ]
 
-        self.xanes_fit_external_command_name = os.path.join(
-            self.global_h.script_dir, "xanes3D_fit_external_command.py")
-        self.xanes_reg_external_command_name = os.path.join(
-            self.global_h.script_dir, "xanes3D_reg_external_command.py")
-        self.xanes_align_external_command_name = os.path.join(
-            self.global_h.script_dir, "xanes3D_align_external_command.py")
+        # self.xanes_fit_external_command_name = os.path.join(
+        #     self.global_h.script_dir, "xanes3D_fit_external_command.py"
+        # )
+        # self.xanes_reg_external_command_name = os.path.join(
+        #     self.global_h.script_dir, "xanes3D_reg_external_command.py"
+        # )
+        # self.xanes_align_external_command_name = os.path.join(
+        #     self.global_h.script_dir, "xanes3D_align_external_command.py"
+        # )
+        self.xanes_fit_external_command_name = str(
+            Path(self.global_h.script_dir) / "xanes3D_fit_external_command.py"
+        )
+        self.xanes_reg_external_command_name = str(
+            Path(self.global_h.script_dir) / "xanes3D_reg_external_command.py"
+        )
+        self.xanes_align_external_command_name = str(
+            Path(self.global_h.script_dir) / "xanes3D_align_external_command.py"
+        )
 
         self.xanes_file_configured = False
         self.xanes_indices_configured = False
         self.xanes_roi_configured = False
         self.xanes_reg_params_configured = False
         self.xanes_reg_done = False
         self.xanes_reg_review_done = False
@@ -98,16 +118,15 @@
         self.xanes_reg_mrtv_subpixel_kernel = 0.2
         self.xanes_reg_mrtv_subpixel_srch_option = "ana"
         self.xanes_img_roi = None
         self.xanes_roi = [0, 10, 0, 10, 0, 10]
         self.xanes_reg_mask = None
         self.xanes_aligned_data = None
         self.xanes_fit_4th_dim_idx = 0
-        self.xanes_raw_fn_temp = self.global_h.io_xanes3D_cfg[
-            "tomo_raw_fn_template"]
+        self.xanes_raw_fn_temp = self.global_h.io_xanes3D_cfg["tomo_raw_fn_template"]
         self.xanes_raw_3D_h5_top_dir = None
         self.xanes_recon_3D_top_dir = None
         self.xanes_save_trial_reg_filename = None
         self.xanes_save_trial_reg_config_filename = None
         self.xanes_save_trial_reg_config_filename_original = None
         self.xanes_raw_3D_h5_temp = None
         self.xanes_available_raw_ids = None
@@ -147,25 +166,21 @@
         self.xanes_fit_edge_offset_thres = 1.0
         self.xanes_fit_use_flt_spec = False
 
         self.xanes_config = {
             "filepath config": {
                 "xanes3D_raw_3D_h5_top_dir": self.xanes_raw_3D_h5_top_dir,
                 "xanes3D_recon_3D_top_dir": self.xanes_recon_3D_top_dir,
-                "xanes_save_trial_reg_filename":
-                self.xanes_save_trial_reg_filename,
-                "xanes3D_save_trial_reg_config_filename":
-                self.xanes_save_trial_reg_config_filename,
-                "xanes3D_save_trial_reg_config_filename_original":
-                self.xanes_save_trial_reg_config_filename_original,
+                "xanes_save_trial_reg_filename": self.xanes_save_trial_reg_filename,
+                "xanes3D_save_trial_reg_config_filename": self.xanes_save_trial_reg_config_filename,
+                "xanes3D_save_trial_reg_config_filename_original": self.xanes_save_trial_reg_config_filename_original,
                 "xanes3D_raw_3D_h5_temp": self.xanes_raw_3D_h5_temp,
                 "xanes3D_recon_3D_tiff_temp": self.xanes_recon_3D_tiff_temp,
                 "xanes3D_recon_3D_dir_temp": self.xanes_recon_3D_dir_temp,
-                "xanes3D_reg_best_match_filename":
-                self.xanes_reg_best_match_filename,
+                "xanes3D_reg_best_match_filename": self.xanes_reg_best_match_filename,
                 "xanes3D_analysis_option": self.xanes_fit_option,
                 "xanes3D_filepath_configured": self.xanes_file_configured,
                 "xanes3D_raw_h5_path_set": self.xanes_raw_h5_path_set,
                 "xanes3D_recon_path_set": self.xanes_recon_path_set,
                 "xanes3D_save_trial_set": self.xanes_save_trial_set,
             },
             "indeices config": {
@@ -203,50 +218,42 @@
                 "3D_roi": list(self.xanes_roi),
                 "xanes3D_roi_configured": self.xanes_roi_configured,
             },
             "registration config": {
                 "xanes3D_reg_use_chunk": self.xanes_reg_use_chunk,
                 "xanes3D_reg_use_mask": self.xanes_reg_use_mask,
                 "xanes3D_reg_mask_thres": self.xanes_reg_mask_thres,
-                "xanes3D_reg_mask_dilation_width":
-                self.xanes_reg_mask_dilation_width,
+                "xanes3D_reg_mask_dilation_width": self.xanes_reg_mask_dilation_width,
                 "xanes3D_reg_use_smooth_img": self.xanes_reg_use_smooth_img,
                 "xanes3D_reg_smooth_sigma": self.xanes_reg_smooth_sigma,
-                "xanes3D_reg_sli_search_half_width":
-                self.xanes_reg_sli_search_half_width,
+                "xanes3D_reg_sli_search_half_width": self.xanes_reg_sli_search_half_width,
                 "xanes3D_reg_chunk_sz": self.xanes_reg_chunk_sz,
                 "xanes3D_reg_method": self.xanes_reg_method,
                 "xanes3D_reg_ref_mode": self.xanes_reg_ref_mode,
                 "xanes3D_reg_mrtv_level": self.xanes_reg_mrtv_level,
                 "xanes3D_reg_mrtv_width": self.xanes_reg_mrtv_width,
-                "xanes3D_reg_mrtv_subpixel_kernel":
-                self.xanes_reg_mrtv_subpixel_kernel,
-                "xanes3D_reg_mrtv_subpixel_width":
-                self.xanes_reg_mrtv_subpixel_wz,
+                "xanes3D_reg_mrtv_subpixel_kernel": self.xanes_reg_mrtv_subpixel_kernel,
+                "xanes3D_reg_mrtv_subpixel_width": self.xanes_reg_mrtv_subpixel_wz,
                 "mask_thres_slider_min": 0,
                 "mask_thres_slider_val": 0,
                 "mask_thres_slider_max": 0,
                 "mask_dilation_slider_min": 0,
                 "mask_dilation_slider_val": 0,
                 "mask_dilation_slider_max": 0,
                 "sli_search_slider_min": 0,
                 "sli_search_slider_val": 0,
                 "sli_search_slider_max": 0,
                 "chunk_sz_slider_min": 0,
                 "chunk_sz_slider_val": 0,
                 "chunk_sz_slider_max": 0,
-                "xanes3D_reg_params_configured":
-                self.xanes_reg_params_configured,
-            },
-            "run registration": {
-                "xanes3D_reg_done": self.xanes_reg_done
+                "xanes3D_reg_params_configured": self.xanes_reg_params_configured,
             },
+            "run registration": {"xanes3D_reg_done": self.xanes_reg_done},
             "review registration": {
-                "xanes3D_use_existing_reg_reviewed":
-                self.xanes_use_existing_reg_reviewed,
+                "xanes3D_use_existing_reg_reviewed": self.xanes_use_existing_reg_reviewed,
                 "xanes3D_reg_review_file": self.xanes_reg_review_file,
                 "xanes3D_reg_review_done": self.xanes_reg_review_done,
                 "read_alignment_checkbox": False,
                 "reg_pair_slider_min": 0,
                 "reg_pair_slider_val": 0,
                 "reg_pair_slider_max": 0,
                 "zshift_slider_min": 0,
@@ -258,26 +265,22 @@
             "align 3D recon": {
                 "xanes3D_alignment_done": self.xanes_alignment_done,
                 "xanes3D_analysis_edge_eng": self.xanes_fit_edge_eng,
                 "xanes3D_analysis_wl_fit_eng_s": self.xanes_fit_wl_fit_eng_s,
                 "xanes3D_analysis_wl_fit_eng_e": self.xanes_fit_wl_fit_eng_e,
                 "xanes3D_analysis_pre_edge_e": self.xanes_fit_pre_edge_e,
                 "xanes3D_analysis_post_edge_s": self.xanes_fit_post_edge_s,
-                "xanes3D_analysis_edge_0p5_fit_s":
-                self.xanes_fit_edge_0p5_fit_s,
-                "xanes3D_analysis_edge_0p5_fit_e":
-                self.xanes_fit_edge_0p5_fit_e,
+                "xanes3D_analysis_edge_0p5_fit_s": self.xanes_fit_edge_0p5_fit_s,
+                "xanes3D_analysis_edge_0p5_fit_e": self.xanes_fit_edge_0p5_fit_e,
                 "xanes3D_analysis_type": self.xanes_fit_type,
             },
         }
-        self.xanes_fit_gui_h = xfg.xanes_fitting_gui(self,
-                                                     form_sz=self.form_sz)
+        self.xanes_fit_gui_h = xfg.xanes_fitting_gui(self, form_sz=self.form_sz)
         self.xanes_fit_gui_h.build_gui()
-        self.xanes_ana_gui_h = xag.xanes_analysis_gui(self,
-                                                      form_sz=self.form_sz)
+        self.xanes_ana_gui_h = xag.xanes_analysis_gui(self, form_sz=self.form_sz)
         self.xanes_ana_gui_h.build_gui()
 
     def lock_message_text_boxes(self):
         boxes = [
             "SelRawH5Path text",
             "SelReconPath text",
             "SelSavTrial text",
@@ -293,43 +296,36 @@
             "VisSpecView text",
         ]
         enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
         self.xanes_fit_gui_h.hs["FitRun text"].disabled = True
 
     def update_xanes3D_config(self):
         self.xanes_config = {
-            "filepath config":
-            dict(
+            "filepath config": dict(
                 xanes3D_raw_3D_h5_top_dir=self.xanes_raw_3D_h5_top_dir,
                 xanes3D_recon_3D_top_dir=self.xanes_recon_3D_top_dir,
-                xanes_save_trial_reg_filename=self.
-                xanes_save_trial_reg_filename,
+                xanes_save_trial_reg_filename=self.xanes_save_trial_reg_filename,
                 xanes3D_raw_3D_h5_temp=self.xanes_raw_3D_h5_temp,
                 xanes3D_recon_3D_tiff_temp=self.xanes_recon_3D_tiff_temp,
                 xanes3D_recon_3D_dir_temp=self.xanes_recon_3D_dir_temp,
-                xanes3D_reg_best_match_filename=self.
-                xanes_reg_best_match_filename,
+                xanes3D_reg_best_match_filename=self.xanes_reg_best_match_filename,
                 xanes3D_analysis_option=self.xanes_fit_option,
                 xanes3D_filepath_configured=self.xanes_file_configured,
                 xanes3D_raw_h5_path_set=self.xanes_raw_h5_path_set,
                 xanes3D_recon_path_set=self.xanes_recon_path_set,
                 xanes3D_save_trial_set=self.xanes_save_trial_set,
             ),
-            "indeices config":
-            dict(
-                select_scan_id_start_text_options=self.
-                hs["SelScanIdStart drpdn"].options,
-                select_scan_id_start_text_val=self.hs["SelScanIdStart drpdn"].
-                value,
-                select_scan_id_end_text_options=self.hs["SelScanIdEnd drpdn"].
-                options,
-                select_scan_id_end_text_val=self.hs["SelScanIdEnd drpdn"].
-                value,
-                fixed_scan_id_slider_options=self.hs["FixedScanId drpdn"].
-                options,
+            "indeices config": dict(
+                select_scan_id_start_text_options=self.hs[
+                    "SelScanIdStart drpdn"
+                ].options,
+                select_scan_id_start_text_val=self.hs["SelScanIdStart drpdn"].value,
+                select_scan_id_end_text_options=self.hs["SelScanIdEnd drpdn"].options,
+                select_scan_id_end_text_val=self.hs["SelScanIdEnd drpdn"].value,
+                fixed_scan_id_slider_options=self.hs["FixedScanId drpdn"].options,
                 fixed_scan_id_slider_val=self.hs["FixedScanId drpdn"].value,
                 fixed_sli_id_slider_min=self.hs["FixedSliId sldr"].min,
                 fixed_sli_id_slider_val=self.hs["FixedSliId sldr"].value,
                 fixed_sli_id_slider_max=self.hs["FixedSliId sldr"].max,
                 xanes3D_fixed_scan_id=int(self.xanes_fixed_scan_id),
                 xanes3D_avail_ds_ids=self.xanes_available_raw_ids,
                 xanes3D_scan_id_s=int(self.xanes_scan_id_s),
@@ -349,425 +345,474 @@
                 "3D_roi_y_slider_max": self.hs["3DRoiY sldr"].max,
                 "3D_roi_z_slider_min": self.hs["3DRoiZ sldr"].min,
                 "3D_roi_z_slider_val": self.hs["3DRoiZ sldr"].value,
                 "3D_roi_z_slider_max": self.hs["3DRoiZ sldr"].max,
                 "3D_roi": list(self.xanes_roi),
                 "xanes3D_roi_configured": self.xanes_roi_configured,
             },
-            "registration config":
-            dict(
+            "registration config": dict(
                 xanes3D_reg_use_chunk=self.hs["ChunkSz chbx"].value,
                 xanes3D_reg_use_mask=self.hs["UseMask chbx"].value,
                 xanes3D_reg_mask_thres=self.hs["MaskThres sldr"].value,
-                xanes3D_reg_mask_dilation_width=self.hs["MaskDilation sldr"].
-                value,
+                xanes3D_reg_mask_dilation_width=self.hs["MaskDilation sldr"].value,
                 xanes3D_reg_use_smooth_img=self.hs["UseMask chbx"].value,
                 xanes3D_reg_smooth_sigma=self.xanes_reg_smooth_sigma,
-                xanes3D_reg_sli_search_half_width=self.
-                xanes_reg_sli_search_half_width,
+                xanes3D_reg_sli_search_half_width=self.xanes_reg_sli_search_half_width,
                 xanes3D_reg_chunk_sz=self.xanes_reg_chunk_sz,
                 xanes3D_reg_method=self.xanes_reg_method,
                 xanes3D_reg_ref_mode=self.xanes_reg_ref_mode,
                 xanes3D_reg_mrtv_level=self.xanes_reg_mrtv_level,
                 xanes3D_reg_mrtv_width=self.xanes_reg_mrtv_width,
-                xanes3D_reg_mrtv_subpixel_kernel=self.
-                xanes_reg_mrtv_subpixel_kernel,
-                xanes3D_reg_mrtv_subpixel_width=self.
-                xanes_reg_mrtv_subpixel_wz,
+                xanes3D_reg_mrtv_subpixel_kernel=self.xanes_reg_mrtv_subpixel_kernel,
+                xanes3D_reg_mrtv_subpixel_width=self.xanes_reg_mrtv_subpixel_wz,
                 mask_thres_slider_min=self.hs["MaskThres sldr"].min,
                 mask_thres_slider_val=self.hs["MaskThres sldr"].value,
                 mask_thres_slider_max=self.hs["MaskThres sldr"].max,
                 mask_dilation_slider_min=self.hs["MaskDilation sldr"].min,
                 mask_dilation_slider_val=self.hs["MaskDilation sldr"].value,
                 mask_dilation_slider_max=self.hs["MaskDilation sldr"].max,
                 sli_search_slider_min=self.hs["SliSrch sldr"].min,
                 sli_search_slider_val=self.hs["SliSrch sldr"].value,
                 sli_search_slider_max=self.hs["SliSrch sldr"].max,
                 chunk_sz_slider_min=self.hs["ChunkSz sldr"].min,
                 chunk_sz_slider_val=self.hs["ChunkSz sldr"].value,
                 chunk_sz_slider_max=self.hs["ChunkSz sldr"].max,
                 xanes3D_reg_params_configured=self.xanes_reg_params_configured,
             ),
-            "run registration":
-            dict(xanes3D_reg_done=self.xanes_reg_done),
-            "review registration":
-            dict(
-                xanes3D_use_existing_reg_reviewed=self.
-                xanes_use_existing_reg_reviewed,
+            "run registration": dict(xanes3D_reg_done=self.xanes_reg_done),
+            "review registration": dict(
+                xanes3D_use_existing_reg_reviewed=self.xanes_use_existing_reg_reviewed,
                 xanes3D_reg_review_file=self.xanes_reg_review_file,
                 xanes3D_reg_review_done=self.xanes_reg_review_done,
                 read_alignment_checkbox=self.hs["ReadAlign chbx"].value,
                 reg_pair_slider_min=self.hs["RegPair sldr"].min,
                 reg_pair_slider_val=self.hs["RegPair sldr"].value,
                 reg_pair_slider_max=self.hs["RegPair sldr"].max,
                 alignment_best_match=self.xanes_review_shift_dict,
             ),
-            "align 3D recon":
-            dict(
+            "align 3D recon": dict(
                 xanes3D_alignment_done=self.xanes_alignment_done,
                 xanes3D_analysis_edge_eng=self.xanes_fit_edge_eng,
                 xanes3D_analysis_wl_fit_eng_s=self.xanes_fit_wl_fit_eng_s,
                 xanes3D_analysis_wl_fit_eng_e=self.xanes_fit_wl_fit_eng_e,
                 xanes3D_analysis_pre_edge_e=self.xanes_fit_pre_edge_e,
                 xanes3D_analysis_post_edge_s=self.xanes_fit_post_edge_s,
                 xanes3D_analysis_edge_0p5_fit_s=self.xanes_fit_edge_0p5_fit_s,
                 xanes3D_analysis_edge_0p5_fit_e=self.xanes_fit_edge_0p5_fit_e,
                 xanes3D_analysis_type=self.xanes_fit_type,
             ),
         }
 
     def read_xanes3D_config(self):
-        with open(self.xanes_save_trial_reg_config_filename_original,
-                  "r") as f:
+        with open(self.xanes_save_trial_reg_config_filename_original, "r") as f:
             self.xanes_config = json.load(f)
 
     def set_xanes3D_variables(self):
         self.xanes_raw_3D_h5_top_dir = self.xanes_config["filepath config"][
-            "xanes3D_raw_3D_h5_top_dir"]
+            "xanes3D_raw_3D_h5_top_dir"
+        ]
         self.xanes_recon_3D_top_dir = self.xanes_config["filepath config"][
-            "xanes3D_recon_3D_top_dir"]
-        self.xanes_save_trial_reg_filename = self.xanes_config[
-            "filepath config"]["xanes_save_trial_reg_filename"]
+            "xanes3D_recon_3D_top_dir"
+        ]
+        self.xanes_save_trial_reg_filename = self.xanes_config["filepath config"][
+            "xanes_save_trial_reg_filename"
+        ]
         self.xanes_raw_3D_h5_temp = self.xanes_config["filepath config"][
-            "xanes3D_raw_3D_h5_temp"]
+            "xanes3D_raw_3D_h5_temp"
+        ]
         self.xanes_recon_3D_tiff_temp = self.xanes_config["filepath config"][
-            "xanes3D_recon_3D_tiff_temp"]
+            "xanes3D_recon_3D_tiff_temp"
+        ]
         self.xanes_recon_3D_dir_temp = self.xanes_config["filepath config"][
-            "xanes3D_recon_3D_dir_temp"]
-        self.xanes_reg_best_match_filename = self.xanes_config[
-            "filepath config"]["xanes3D_reg_best_match_filename"]
+            "xanes3D_recon_3D_dir_temp"
+        ]
+        self.xanes_reg_best_match_filename = self.xanes_config["filepath config"][
+            "xanes3D_reg_best_match_filename"
+        ]
         self.xanes_fit_option = self.xanes_config["filepath config"][
-            "xanes3D_analysis_option"]
+            "xanes3D_analysis_option"
+        ]
         self.xanes_file_configured = self.xanes_config["filepath config"][
-            "xanes3D_filepath_configured"]
+            "xanes3D_filepath_configured"
+        ]
         self.xanes_raw_h5_path_set = self.xanes_config["filepath config"][
-            "xanes3D_raw_h5_path_set"]
+            "xanes3D_raw_h5_path_set"
+        ]
         self.xanes_recon_path_set = self.xanes_config["filepath config"][
-            "xanes3D_recon_path_set"]
+            "xanes3D_recon_path_set"
+        ]
         self.xanes_save_trial_set = self.xanes_config["filepath config"][
-            "xanes3D_save_trial_set"]
+            "xanes3D_save_trial_set"
+        ]
 
         self.xanes_fixed_scan_id = self.xanes_config["indeices config"][
-            "xanes3D_fixed_scan_id"]
+            "xanes3D_fixed_scan_id"
+        ]
         self.xanes_available_raw_ids = self.xanes_config["indeices config"][
-            "xanes3D_avail_ds_ids"]
-        self.xanes_scan_id_s = self.xanes_config["indeices config"][
-            "xanes3D_scan_id_s"]
-        self.xanes_scan_id_e = self.xanes_config["indeices config"][
-            "xanes3D_scan_id_e"]
+            "xanes3D_avail_ds_ids"
+        ]
+        self.xanes_scan_id_s = self.xanes_config["indeices config"]["xanes3D_scan_id_s"]
+        self.xanes_scan_id_e = self.xanes_config["indeices config"]["xanes3D_scan_id_e"]
         self.xanes_fixed_sli_id = self.xanes_config["indeices config"][
-            "xanes3D_fixed_sli_id"]
+            "xanes3D_fixed_sli_id"
+        ]
         self.xanes_scan_id_set = self.xanes_config["indeices config"][
-            "xanes3D_scan_id_set"]
+            "xanes3D_scan_id_set"
+        ]
         self.xanes_fixed_scan_id_set = self.xanes_config["indeices config"][
-            "xanes3D_fixed_scan_id_set"]
+            "xanes3D_fixed_scan_id_set"
+        ]
         self.xanes_fixed_sli_id_set = self.xanes_config["indeices config"][
-            "xanes3D_fixed_sli_id_set"]
+            "xanes3D_fixed_sli_id_set"
+        ]
         self.xanes_indices_configured = self.xanes_config["indeices config"][
-            "xanes3D_indices_configured"]
+            "xanes3D_indices_configured"
+        ]
         b = glob.glob(
             self.xanes_recon_3D_tiff_temp.format(
-                self.xanes_available_raw_ids[self.xanes_fixed_scan_id], "*"))
-        self.xanes_available_sli_file_ids = sorted([
-            int(os.path.basename(ii).split(".")[0].split("_")[-1]) for ii in b
-        ])
+                self.xanes_available_raw_ids[self.xanes_fixed_scan_id], "*"
+            )
+        )
+        self.xanes_available_sli_file_ids = sorted(
+            [int(Path(ii).stem.split("_")[-1]) for ii in b]
+        )
 
         self.xanes_roi = self.xanes_config["roi config"]["3D_roi"]
         self.xanes_roi_configured = self.xanes_config["roi config"][
-            "xanes3D_roi_configured"]
+            "xanes3D_roi_configured"
+        ]
 
         self.xanes_reg_use_chunk = self.xanes_config["registration config"][
-            "xanes3D_reg_use_chunk"]
+            "xanes3D_reg_use_chunk"
+        ]
         self.xanes_reg_use_mask = self.xanes_config["registration config"][
-            "xanes3D_reg_use_mask"]
+            "xanes3D_reg_use_mask"
+        ]
         self.xanes_reg_mask_thres = self.xanes_config["registration config"][
-            "xanes3D_reg_mask_thres"]
-        self.xanes_reg_mask_dilation_width = self.xanes_config[
-            "registration config"]["xanes3D_reg_mask_dilation_width"]
-        self.xanes_reg_use_smooth_img = self.xanes_config[
-            "registration config"]["xanes3D_reg_use_smooth_img"]
+            "xanes3D_reg_mask_thres"
+        ]
+        self.xanes_reg_mask_dilation_width = self.xanes_config["registration config"][
+            "xanes3D_reg_mask_dilation_width"
+        ]
+        self.xanes_reg_use_smooth_img = self.xanes_config["registration config"][
+            "xanes3D_reg_use_smooth_img"
+        ]
         self.xanes_reg_smooth_sigma = self.xanes_config["registration config"][
-            "xanes3D_reg_smooth_sigma"]
-        self.xanes_reg_sli_search_half_width = self.xanes_config[
-            "registration config"]["xanes3D_reg_sli_search_half_width"]
+            "xanes3D_reg_smooth_sigma"
+        ]
+        self.xanes_reg_sli_search_half_width = self.xanes_config["registration config"][
+            "xanes3D_reg_sli_search_half_width"
+        ]
         self.xanes_reg_chunk_sz = self.xanes_config["registration config"][
-            "xanes3D_reg_chunk_sz"]
+            "xanes3D_reg_chunk_sz"
+        ]
 
         self.xanes_reg_method = self.xanes_config["registration config"][
-            "xanes3D_reg_method"]
+            "xanes3D_reg_method"
+        ]
         self.xanes_reg_ref_mode = self.xanes_config["registration config"][
-            "xanes3D_reg_ref_mode"]
+            "xanes3D_reg_ref_mode"
+        ]
         self.xanes_reg_mrtv_level = self.xanes_config["registration config"][
-            "xanes3D_reg_mrtv_level"]
+            "xanes3D_reg_mrtv_level"
+        ]
         self.xanes_reg_mrtv_width = self.xanes_config["registration config"][
-            "xanes3D_reg_mrtv_width"]
-        self.xanes_reg_mrtv_subpixel_kernel = self.xanes_config[
-            "registration config"]["xanes3D_reg_mrtv_subpixel_kernel"]
-        self.xanes_reg_mrtv_subpixel_wz = self.xanes_config[
-            "registration config"]["xanes3D_reg_mrtv_subpixel_width"]
+            "xanes3D_reg_mrtv_width"
+        ]
+        self.xanes_reg_mrtv_subpixel_kernel = self.xanes_config["registration config"][
+            "xanes3D_reg_mrtv_subpixel_kernel"
+        ]
+        self.xanes_reg_mrtv_subpixel_wz = self.xanes_config["registration config"][
+            "xanes3D_reg_mrtv_subpixel_width"
+        ]
 
-        self.xanes_reg_params_configured = self.xanes_config[
-            "registration config"]["xanes3D_reg_params_configured"]
+        self.xanes_reg_params_configured = self.xanes_config["registration config"][
+            "xanes3D_reg_params_configured"
+        ]
 
-        self.xanes_reg_done = self.xanes_config["run registration"][
-            "xanes3D_reg_done"]
+        self.xanes_reg_done = self.xanes_config["run registration"]["xanes3D_reg_done"]
 
-        self.xanes_use_existing_reg_reviewed = self.xanes_config[
-            "review registration"]["xanes3D_use_existing_reg_reviewed"]
+        self.xanes_use_existing_reg_reviewed = self.xanes_config["review registration"][
+            "xanes3D_use_existing_reg_reviewed"
+        ]
         self.xanes_reg_review_file = self.xanes_config["review registration"][
-            "xanes3D_reg_review_file"]
+            "xanes3D_reg_review_file"
+        ]
         self.xanes_reg_review_done = self.xanes_config["review registration"][
-            "xanes3D_reg_review_done"]
-        self.xanes_review_shift_dict = self.xanes_config[
-            "review registration"]["alignment_best_match"]
+            "xanes3D_reg_review_done"
+        ]
+        self.xanes_review_shift_dict = self.xanes_config["review registration"][
+            "alignment_best_match"
+        ]
 
         self.xanes_alignment_done = self.xanes_config["align 3D recon"][
-            "xanes3D_alignment_done"]
+            "xanes3D_alignment_done"
+        ]
         self.xanes_fit_edge_eng = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_edge_eng"]
+            "xanes3D_analysis_edge_eng"
+        ]
         self.xanes_fit_wl_fit_eng_s = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_wl_fit_eng_s"]
+            "xanes3D_analysis_wl_fit_eng_s"
+        ]
         self.xanes_fit_wl_fit_eng_e = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_wl_fit_eng_e"]
+            "xanes3D_analysis_wl_fit_eng_e"
+        ]
         self.xanes_fit_pre_edge_e = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_pre_edge_e"]
+            "xanes3D_analysis_pre_edge_e"
+        ]
         self.xanes_fit_post_edge_s = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_post_edge_s"]
+            "xanes3D_analysis_post_edge_s"
+        ]
         self.xanes_fit_edge_0p5_fit_s = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_edge_0p5_fit_s"]
+            "xanes3D_analysis_edge_0p5_fit_s"
+        ]
         self.xanes_fit_edge_0p5_fit_e = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_edge_0p5_fit_e"]
+            "xanes3D_analysis_edge_0p5_fit_e"
+        ]
         self.xanes_fit_type = self.xanes_config["align 3D recon"][
-            "xanes3D_analysis_type"]
+            "xanes3D_analysis_type"
+        ]
 
         self.boxes_logic()
 
     def set_xanes3D_handles(self):
-        self.hs["SelScanIdStart drpdn"].options = self.xanes_config[
-            "indeices config"]["select_scan_id_start_text_options"]
-        self.hs["SelScanIdEnd drpdn"].options = self.xanes_config[
-            "indeices config"]["select_scan_id_end_text_options"]
-        self.hs["SelScanIdStart drpdn"].value = self.xanes_config[
-            "indeices config"]["select_scan_id_start_text_val"]
-        self.hs["SelScanIdEnd drpdn"].value = self.xanes_config[
-            "indeices config"]["select_scan_id_end_text_val"]
-
-        self.hs["FixedScanId drpdn"].options = self.xanes_config[
-            "indeices config"]["fixed_scan_id_slider_options"]
-        self.hs["FixedScanId drpdn"].value = self.xanes_config[
-            "indeices config"]["fixed_scan_id_slider_val"]
+        self.hs["SelScanIdStart drpdn"].options = self.xanes_config["indeices config"][
+            "select_scan_id_start_text_options"
+        ]
+        self.hs["SelScanIdEnd drpdn"].options = self.xanes_config["indeices config"][
+            "select_scan_id_end_text_options"
+        ]
+        self.hs["SelScanIdStart drpdn"].value = self.xanes_config["indeices config"][
+            "select_scan_id_start_text_val"
+        ]
+        self.hs["SelScanIdEnd drpdn"].value = self.xanes_config["indeices config"][
+            "select_scan_id_end_text_val"
+        ]
+
+        self.hs["FixedScanId drpdn"].options = self.xanes_config["indeices config"][
+            "fixed_scan_id_slider_options"
+        ]
+        self.hs["FixedScanId drpdn"].value = self.xanes_config["indeices config"][
+            "fixed_scan_id_slider_val"
+        ]
         self.hs["FixedSliId sldr"].max = self.xanes_config["indeices config"][
-            "fixed_sli_id_slider_max"]
+            "fixed_sli_id_slider_max"
+        ]
         self.hs["FixedSliId sldr"].min = self.xanes_config["indeices config"][
-            "fixed_sli_id_slider_min"]
-        self.hs["FixedSliId sldr"].value = self.xanes_config[
-            "indeices config"]["fixed_sli_id_slider_val"]
+            "fixed_sli_id_slider_min"
+        ]
+        self.hs["FixedSliId sldr"].value = self.xanes_config["indeices config"][
+            "fixed_sli_id_slider_val"
+        ]
 
         self.hs["3DRoiX sldr"].max = self.xanes_config["roi config"][
-            "3D_roi_x_slider_max"]
+            "3D_roi_x_slider_max"
+        ]
         self.hs["3DRoiX sldr"].min = self.xanes_config["roi config"][
-            "3D_roi_x_slider_min"]
+            "3D_roi_x_slider_min"
+        ]
         self.hs["3DRoiX sldr"].value = self.xanes_config["roi config"][
-            "3D_roi_x_slider_val"]
+            "3D_roi_x_slider_val"
+        ]
         self.hs["3DRoiY sldr"].max = self.xanes_config["roi config"][
-            "3D_roi_y_slider_max"]
+            "3D_roi_y_slider_max"
+        ]
         self.hs["3DRoiY sldr"].min = self.xanes_config["roi config"][
-            "3D_roi_y_slider_min"]
+            "3D_roi_y_slider_min"
+        ]
         self.hs["3DRoiY sldr"].value = self.xanes_config["roi config"][
-            "3D_roi_y_slider_val"]
+            "3D_roi_y_slider_val"
+        ]
         self.hs["3DRoiZ sldr"].max = self.xanes_config["roi config"][
-            "3D_roi_z_slider_max"]
+            "3D_roi_z_slider_max"
+        ]
         self.hs["3DRoiZ sldr"].min = self.xanes_config["roi config"][
-            "3D_roi_z_slider_min"]
+            "3D_roi_z_slider_min"
+        ]
         self.hs["3DRoiZ sldr"].value = self.xanes_config["roi config"][
-            "3D_roi_z_slider_val"]
+            "3D_roi_z_slider_val"
+        ]
 
-        self.hs["MaskThres sldr"].max = self.xanes_config[
-            "registration config"]["mask_thres_slider_max"]
-        self.hs["MaskThres sldr"].min = self.xanes_config[
-            "registration config"]["mask_thres_slider_min"]
-        self.hs["MaskThres sldr"].value = self.xanes_config[
-            "registration config"]["mask_thres_slider_val"]
-        self.hs["MaskDilation sldr"].max = self.xanes_config[
-            "registration config"]["mask_dilation_slider_max"]
-        self.hs["MaskDilation sldr"].min = self.xanes_config[
-            "registration config"]["mask_dilation_slider_min"]
-        self.hs["MaskDilation sldr"].value = self.xanes_config[
-            "registration config"]["mask_dilation_slider_val"]
+        self.hs["MaskThres sldr"].max = self.xanes_config["registration config"][
+            "mask_thres_slider_max"
+        ]
+        self.hs["MaskThres sldr"].min = self.xanes_config["registration config"][
+            "mask_thres_slider_min"
+        ]
+        self.hs["MaskThres sldr"].value = self.xanes_config["registration config"][
+            "mask_thres_slider_val"
+        ]
+        self.hs["MaskDilation sldr"].max = self.xanes_config["registration config"][
+            "mask_dilation_slider_max"
+        ]
+        self.hs["MaskDilation sldr"].min = self.xanes_config["registration config"][
+            "mask_dilation_slider_min"
+        ]
+        self.hs["MaskDilation sldr"].value = self.xanes_config["registration config"][
+            "mask_dilation_slider_val"
+        ]
         self.hs["SliSrch sldr"].max = self.xanes_config["registration config"][
-            "sli_search_slider_max"]
+            "sli_search_slider_max"
+        ]
         self.hs["SliSrch sldr"].min = self.xanes_config["registration config"][
-            "sli_search_slider_min"]
-        self.hs["SliSrch sldr"].value = self.xanes_config[
-            "registration config"]["sli_search_slider_val"]
+            "sli_search_slider_min"
+        ]
+        self.hs["SliSrch sldr"].value = self.xanes_config["registration config"][
+            "sli_search_slider_val"
+        ]
         self.hs["ChunkSz sldr"].max = self.xanes_config["registration config"][
-            "chunk_sz_slider_max"]
+            "chunk_sz_slider_max"
+        ]
         self.hs["ChunkSz sldr"].min = self.xanes_config["registration config"][
-            "chunk_sz_slider_min"]
-        self.hs["ChunkSz sldr"].value = self.xanes_config[
-            "registration config"]["chunk_sz_slider_val"]
-
-        self.hs["RegMethod drpdn"].value = self.xanes_config[
-            "registration config"]["xanes3D_reg_method"]
-        self.hs["RefMode drpdn"].value = self.xanes_config[
-            "registration config"]["xanes3D_reg_ref_mode"]
-        self.hs["MRTVLevel text"].value = self.xanes_config[
-            "registration config"]["xanes3D_reg_mrtv_level"]
-        self.hs["MRTVWz text"].value = self.xanes_config[
-            "registration config"]["xanes3D_reg_mrtv_width"]
-        self.hs["MRTVSubpixelWz text"].value = self.xanes_config[
-            "registration config"]["xanes3D_reg_mrtv_subpixel_width"]
+            "chunk_sz_slider_min"
+        ]
+        self.hs["ChunkSz sldr"].value = self.xanes_config["registration config"][
+            "chunk_sz_slider_val"
+        ]
+
+        self.hs["RegMethod drpdn"].value = self.xanes_config["registration config"][
+            "xanes3D_reg_method"
+        ]
+        self.hs["RefMode drpdn"].value = self.xanes_config["registration config"][
+            "xanes3D_reg_ref_mode"
+        ]
+        self.hs["MRTVLevel text"].value = self.xanes_config["registration config"][
+            "xanes3D_reg_mrtv_level"
+        ]
+        self.hs["MRTVWz text"].value = self.xanes_config["registration config"][
+            "xanes3D_reg_mrtv_width"
+        ]
+        self.hs["MRTVSubpixelWz text"].value = self.xanes_config["registration config"][
+            "xanes3D_reg_mrtv_subpixel_width"
+        ]
         self.hs["MRTVSubpixelKernel text"].value = self.xanes_config[
-            "registration config"]["xanes3D_reg_mrtv_subpixel_kernel"]
+            "registration config"
+        ]["xanes3D_reg_mrtv_subpixel_kernel"]
 
-        self.hs["ReadAlign chbx"].value = self.xanes_config[
-            "review registration"]["read_alignment_checkbox"]
+        self.hs["ReadAlign chbx"].value = self.xanes_config["review registration"][
+            "read_alignment_checkbox"
+        ]
         self.hs["RegPair sldr"].max = self.xanes_config["review registration"][
-            "reg_pair_slider_max"]
+            "reg_pair_slider_max"
+        ]
         self.hs["RegPair sldr"].min = self.xanes_config["review registration"][
-            "reg_pair_slider_min"]
-        self.hs["RegPair sldr"].value = self.xanes_config[
-            "review registration"]["reg_pair_slider_val"]
-
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagOptn drpdn"].value = self.xanes_config["align 3D recon"][
-                "xanes3D_analysis_type"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagEdgeEng text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_edge_eng"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagPreEdgeEnd text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_pre_edge_e"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagPostEdgeStr text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_post_edge_s"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagWlFitStr text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_wl_fit_eng_s"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagWlFitEnd text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_wl_fit_eng_e"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagEdge0.5Str text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_edge_0p5_fit_s"]
-        self.xanes_fit_gui_h.hs[
-            "FitEngRagEdge0.5End text"].value = self.xanes_config[
-                "align 3D recon"]["xanes3D_analysis_edge_0p5_fit_e"]
+            "reg_pair_slider_min"
+        ]
+        self.hs["RegPair sldr"].value = self.xanes_config["review registration"][
+            "reg_pair_slider_val"
+        ]
+
+        self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_type"]
+        self.xanes_fit_gui_h.hs["FitEngRagEdgeEng text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_edge_eng"]
+        self.xanes_fit_gui_h.hs["FitEngRagPreEdgeEnd text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_pre_edge_e"]
+        self.xanes_fit_gui_h.hs["FitEngRagPostEdgeStr text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_post_edge_s"]
+        self.xanes_fit_gui_h.hs["FitEngRagWlFitStr text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_wl_fit_eng_s"]
+        self.xanes_fit_gui_h.hs["FitEngRagWlFitEnd text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_wl_fit_eng_e"]
+        self.xanes_fit_gui_h.hs["FitEngRagEdge0.5Str text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_edge_0p5_fit_s"]
+        self.xanes_fit_gui_h.hs["FitEngRagEdge0.5End text"].value = self.xanes_config[
+            "align 3D recon"
+        ]["xanes3D_analysis_edge_0p5_fit_e"]
 
         self.boxes_logic()
 
     def boxes_logic(self):
 
         def xanes3D_compound_logic():
             if self.xanes_fit_option == "Reg By Shift":
                 if self.xanes_roi_configured:
                     boxes = ["RevRegRlt box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                     self.hs["ReadAlign chbx"].value = True
                     self.hs["ReadAlign btn"].disabled = False
                 else:
                     boxes = ["RevRegRlt box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 if self.xanes_reg_file_readed:
                     self.hs["RevRegRltCfm btn"].disabled = False
             else:
                 if self.xanes_reg_done:
                     if self.hs["ReadAlign chbx"].value & (
-                            not self.xanes_reg_file_readed):
+                        not self.xanes_reg_file_readed
+                    ):
                         boxes = ["RegPair box", "CorrShft box"]
-                        enable_disable_boxes(self.hs,
-                                             boxes,
-                                             disabled=True,
-                                             level=-1)
+                        enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                         self.hs["ReadAlign btn"].disabled = False
                     else:
                         self.hs["ReadAlign btn"].disabled = True
                         if self.xanes_review_bad_shift:
                             boxes = ["CorrShft box"]
-                            enable_disable_boxes(self.hs,
-                                                 boxes,
-                                                 disabled=False,
-                                                 level=-1)
+                            enable_disable_boxes(
+                                self.hs, boxes, disabled=False, level=-1
+                            )
                             boxes = ["RegPair box"]
-                            enable_disable_boxes(self.hs,
-                                                 boxes,
-                                                 disabled=True,
-                                                 level=-1)
+                            enable_disable_boxes(
+                                self.hs, boxes, disabled=True, level=-1
+                            )
                         else:
                             boxes = ["RegPair box"]
-                            enable_disable_boxes(self.hs,
-                                                 boxes,
-                                                 disabled=False,
-                                                 level=-1)
+                            enable_disable_boxes(
+                                self.hs, boxes, disabled=False, level=-1
+                            )
                             boxes = ["CorrShft box"]
-                            enable_disable_boxes(self.hs,
-                                                 boxes,
-                                                 disabled=True,
-                                                 level=-1)
+                            enable_disable_boxes(
+                                self.hs, boxes, disabled=True, level=-1
+                            )
                 else:
                     boxes = ["RevRegRlt box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
 
             if self.xanes_fit_eng_configured:
                 self.xanes_fit_gui_h.hs["FitRun btn"].disabled = False
             else:
                 self.xanes_fit_gui_h.hs["FitRun btn"].disabled = True
 
             if self.xanes_reg_review_done:
                 if self.hs["AlignReconOptnSli chbx"].value:
                     boxes = [
                         "AlignReconOptnSliStart text",
                         "AlignReconOptnSliRange sldr",
                         "AlignReconOptnSliEnd text",
                     ]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 else:
                     boxes = [
                         "AlignReconOptnSliStart text",
                         "AlignReconOptnSliRange sldr",
                         "AlignReconOptnSliEnd text",
                     ]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
             else:
                 boxes = [
                     "AlignReconOptnSliStart text",
                     "AlignReconOptnSliRange sldr",
                     "AlignReconOptnSliEnd text",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
 
-            if self.xanes_alignment_done | (self.xanes_fit_option
-                                            == "Do Analysis"):
+            if self.xanes_alignment_done | (self.xanes_fit_option == "Do Analysis"):
                 if self.xanes_visualization_viewer_option == "fiji":
                     boxes = ["VisImgViewAlign box", "VisSpecView box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 elif self.xanes_visualization_viewer_option == "napari":
                     boxes = ["VisImgViewAlign box", "VisSpecView box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
 
             if self.hs["ChunkSz chbx"].value:
                 self.hs["ChunkSz sldr"].disabled = False
                 self.xanes_regparams_anchor_idx_set = False
             else:
                 self.hs["ChunkSz sldr"].disabled = True
                 self.xanes_regparams_anchor_idx_set = False
@@ -836,397 +881,358 @@
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
-            elif self.xanes_file_configured & (
-                    not self.xanes_indices_configured):
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
+            elif self.xanes_file_configured & (not self.xanes_indices_configured):
                 if not self.xanes_scan_id_set:
                     boxes = [
                         "ConfigData box",
                         "3DRoi box",
                         "ConfigRegParams box",
                         "RunReg box",
                         "RevRegRlt box",
                         "AlignRecon box",
                         "VisImg box",
                     ]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                     boxes = ["ScanIdRange box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                     boxes = ["Fitting form"]
-                    enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(
+                        self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                    )
                 else:
                     boxes = [
                         "3DRoi box",
                         "ConfigRegParams box",
                         "RunReg box",
                         "RevRegRlt box",
                         "AlignRecon box",
                         "VisImg box",
                     ]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                     boxes = ["ConfigData box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                     boxes = ["Fitting form"]
-                    enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
-            elif (self.xanes_file_configured & self.xanes_indices_configured
-                  ) & (not self.xanes_roi_configured):
+                    enable_disable_boxes(
+                        self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                    )
+            elif (self.xanes_file_configured & self.xanes_indices_configured) & (
+                not self.xanes_roi_configured
+            ):
                 boxes = ["ConfigData box", "3DRoi box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = [
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
-            elif (self.xanes_file_configured & self.xanes_indices_configured
-                  ) & (self.xanes_roi_configured &
-                       (not self.xanes_reg_params_configured)):
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
+            elif (self.xanes_file_configured & self.xanes_indices_configured) & (
+                self.xanes_roi_configured & (not self.xanes_reg_params_configured)
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "SliSrch sldr",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-                boxes = [
-                    "RunReg box", "RevRegRlt box", "AlignRecon box",
-                    "VisImg box"
-                ]
+                boxes = ["RunReg box", "RevRegRlt box", "AlignRecon box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 data_state, viewer_state = fiji_viewer_state(
-                    self.global_h, self, viewer_name="xanes3D_mask_viewer")
+                    self.global_h, self, viewer_name="xanes3D_mask_viewer"
+                )
                 if not viewer_state:
                     self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                        "fiji_id"] = None
+                        "fiji_id"
+                    ] = None
                     self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                        "ip"] = None
+                        "ip"
+                    ] = None
                     boxes = ["MaskOptn box"]
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             elif (
                 (self.xanes_file_configured & self.xanes_indices_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (not self.xanes_reg_done)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (not self.xanes_reg_done)
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["AlignRecon box", "RevRegRlt box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (
                 (self.xanes_file_configured & self.xanes_indices_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done &
-                       (not self.xanes_reg_review_done))):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & (not self.xanes_reg_review_done))
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["AlignRecon box", "VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (
                 (self.xanes_file_configured & self.xanes_indices_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    & (not self.xanes_alignment_done)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (not self.xanes_alignment_done)
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (
                 (self.xanes_file_configured & self.xanes_indices_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    & (self.xanes_alignment_done &
-                       (self.xanes_element is None))):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (self.xanes_alignment_done & (self.xanes_element is None))
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (
                 (self.xanes_file_configured & self.xanes_indices_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    & (self.xanes_alignment_done &
-                       (not self.xanes_fit_eng_configured))):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (self.xanes_alignment_done & (not self.xanes_fit_eng_configured))
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["FitEngRag box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
                 boxes = ["FitItemConfig box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 self.lock_message_text_boxes()
                 xanes3D_compound_logic()
             elif (
                 (self.xanes_file_configured & self.xanes_indices_configured)
-                    &
-                (self.xanes_roi_configured & self.xanes_reg_params_configured)
-                    & (self.xanes_reg_done & self.xanes_reg_review_done)
-                    &
-                (self.xanes_alignment_done & self.xanes_fit_eng_configured)):
+                & (self.xanes_roi_configured & self.xanes_reg_params_configured)
+                & (self.xanes_reg_done & self.xanes_reg_review_done)
+                & (self.xanes_alignment_done & self.xanes_fit_eng_configured)
+            ):
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["FitEngRag box", "FitItemConfig box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
         elif self.xanes_fit_option == "Reg By Shift":
             boxes = ["ConfigData box", "ConfigRegParams box", "RunReg box"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
             self.hs["ReadAlign chbx"].value = True
             self.hs["ReadAlign chbx"].disabled = True
             if not self.xanes_file_configured:
-                boxes = [
-                    "3DRoi box", "AlignRecon box", "VisImg box",
-                    "RevRegRlt box"
-                ]
+                boxes = ["3DRoi box", "AlignRecon box", "VisImg box", "RevRegRlt box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif self.xanes_file_configured & (not self.xanes_roi_configured):
                 boxes = ["3DRoi box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["VisImg box", "AlignRecon box", "RevRegRlt box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (self.xanes_file_configured & self.xanes_roi_configured) & (
-                    not self.xanes_reg_review_done):
+                not self.xanes_reg_review_done
+            ):
                 boxes = ["3DRoi box", "ReadAlignFile box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["RevRegRltCfm btn"].disabled = False
 
                 boxes = ["VisImg box", "AlignRecon box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             elif (self.xanes_file_configured & self.xanes_roi_configured) & (
-                    self.xanes_reg_review_done &
-                (not self.xanes_alignment_done)):
+                self.xanes_reg_review_done & (not self.xanes_alignment_done)
+            ):
                 boxes = ["3DRoi box", "AlignRecon box", "ReadAlignFile box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["RevRegRltCfm btn"].disabled = False
 
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = ["VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            elif ((self.xanes_file_configured & self.xanes_roi_configured)
-                  & (self.xanes_reg_review_done & self.xanes_alignment_done)
-                  & (not self.xanes_fit_eng_configured)):
+            elif (
+                (self.xanes_file_configured & self.xanes_roi_configured)
+                & (self.xanes_reg_review_done & self.xanes_alignment_done)
+                & (not self.xanes_fit_eng_configured)
+            ):
                 boxes = [
                     "3DRoi box",
                     "AlignRecon box",
                     "VisImg box",
                     "ReadAlignFile box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["RevRegRltCfm btn"].disabled = False
 
                 boxes = ["FitEngRag box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
                 boxes = ["FitItemConfig box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
-            elif ((self.xanes_file_configured & self.xanes_roi_configured)
-                  & (self.xanes_reg_review_done & self.xanes_alignment_done)
-                  & self.xanes_fit_eng_configured):
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
+            elif (
+                (self.xanes_file_configured & self.xanes_roi_configured)
+                & (self.xanes_reg_review_done & self.xanes_alignment_done)
+                & self.xanes_fit_eng_configured
+            ):
                 boxes = [
                     "3DRoi box",
                     "AlignRecon box",
                     "VisImg box",
                     "ReadAlignFile box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 self.hs["ReadAlign chbx"].value = True
                 self.hs["ReadAlign chbx"].disabled = True
                 self.hs["RevRegRltCfm btn"].disabled = False
 
                 boxes = ["Fitting form"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
         elif self.xanes_fit_option == "Do Analysis":
             if self.xanes_reg_file_set & self.xanes_file_configured:
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["VisImg box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 boxes = ["FitEngRag box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=False,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=False, level=-1
+                )
                 boxes = ["FitItemConfig box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
                 boxes = ["FitItemConfig box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
             else:
                 boxes = [
                     "ConfigData box",
                     "3DRoi box",
                     "ConfigRegParams box",
                     "RunReg box",
                     "RevRegRlt box",
                     "AlignRecon box",
                     "VisImg box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 boxes = ["FitEngRag box", "FitItemConfig box"]
-                enable_disable_boxes(self.xanes_fit_gui_h.hs,
-                                     boxes,
-                                     disabled=True,
-                                     level=-1)
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specify and confirm the aligned xanes3D file ..."
+                enable_disable_boxes(
+                    self.xanes_fit_gui_h.hs, boxes, disabled=True, level=-1
+                )
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specify and confirm the aligned xanes3D file ..."
+                )
         self.lock_message_text_boxes()
         xanes3D_compound_logic()
 
     def build_gui(self):
         """
         hs: widget handler sets; hs is a multi-layer structured dictionary. Layers
         are labeled as '0', '1', '2' in order of their hiearchical relations. In
@@ -1241,19 +1247,15 @@
         """
         #################################################################################################################
         #                                                                                                               #
         #                                                     3D XANES                                                  #
         #                                                                                                               #
         #################################################################################################################
         ## ## ## define functional tabs for each sub-tab -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "100%",
-            "height": "100%"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "100%", "height": "100%"}
         self.hs["Config&Input form"] = widgets.VBox()
         self.hs["RegSetting form"] = widgets.VBox()
         self.hs["Reg&Rev form"] = widgets.VBox()
         self.hs["Fitting form"] = widgets.VBox()
         self.hs["Analysis form"] = widgets.VBox()
         self.hs["Config&Input form"].layout = layout
         self.hs["RegSetting form"].layout = layout
@@ -1269,114 +1271,95 @@
             "width": "auto",
             "height": f"{0.35*(self.form_sz[0]-136)}px",
         }
         self.hs["SelFile&Path box"] = widgets.VBox()
         self.hs["SelFile&Path box"].layout = layout
 
         ## ## ## ## ## label configure file settings box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelFile&PathTitle box"] = widgets.HBox()
         self.hs["SelFile&PathTitle box"].layout = layout
         self.hs["SelFile&PathTitle label"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config Dirs & Files" + "</span>")
+            + "Config Dirs & Files"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "39%"}
         self.hs["SelFile&PathTitle label"].layout = layout
-        self.hs["SelFile&PathTitle box"].children = [
-            self.hs["SelFile&PathTitle label"]
-        ]
+        self.hs["SelFile&PathTitle box"].children = [self.hs["SelFile&PathTitle label"]]
 
         ## ## ## ## ## raw h5 top directory
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelRaw box"] = widgets.HBox()
         self.hs["SelRaw box"].layout = layout
         self.hs["SelRawH5Path text"] = widgets.Text(
-            value="Choose raw h5 directory ...", description="", disabled=True)
+            value="Choose raw h5 directory ...", description="", disabled=True
+        )
         layout = {"width": "66%", "display": "inline_flex"}
         self.hs["SelRawH5Path text"].layout = layout
         self.hs["SelRawH5Path btn"] = SelectFilesButton(
-            option="askdirectory", text_h=self.hs["SelRawH5Path text"])
+            option="askdirectory", text_h=self.hs["SelRawH5Path text"]
+        )
         layout = {"width": "15%"}
         self.hs["SelRawH5Path btn"].layout = layout
         self.hs["SelRawH5Path btn"].description = "Raw h5 Dir"
         self.hs["SelRawH5Path btn"].on_click(self.SelRawH5Path_btn_clk)
         self.hs["SelRaw box"].children = [
             self.hs["SelRawH5Path text"],
             self.hs["SelRawH5Path btn"],
         ]
 
         ## ## ## ## ## recon top directory
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelRecon box"] = widgets.HBox()
         self.hs["SelRecon box"].layout = layout
         self.hs["SelReconPath text"] = widgets.Text(
-            value="Choose recon top directory ...",
-            description="",
-            disabled=True)
+            value="Choose recon top directory ...", description="", disabled=True
+        )
         layout = {"width": "66%", "display": "inline_flex"}
         self.hs["SelReconPath text"].layout = layout
         self.hs["SelReconPath btn"] = SelectFilesButton(
-            option="askdirectory", text_h=self.hs["SelReconPath text"])
+            option="askdirectory", text_h=self.hs["SelReconPath text"]
+        )
         layout = {"width": "15%"}
         self.hs["SelReconPath btn"].layout = layout
         self.hs["SelReconPath btn"].description = "Recon Top Dir"
         self.hs["SelReconPath btn"].on_click(self.SelReconPath_btn_clk)
         self.hs["SelRecon box"].children = [
             self.hs["SelReconPath text"],
             self.hs["SelReconPath btn"],
         ]
 
         ## ## ## ## ## trial save file
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelSavTrial box"] = widgets.HBox()
         self.hs["SelSavTrial box"].layout = layout
         self.hs["SelSavTrial text"] = widgets.Text(
-            value="Save trial registration as ...",
-            description="",
-            disabled=True)
+            value="Save trial registration as ...", description="", disabled=True
+        )
         layout = {"width": "66%", "display": "inline_flex"}
         self.hs["SelSavTrial text"].layout = layout
         self.hs["SelSavTrial btn"] = SelectFilesButton(
-            option="asksaveasfilename", text_h=self.hs["SelSavTrial text"])
+            option="asksaveasfilename", text_h=self.hs["SelSavTrial text"]
+        )
         self.hs["SelSavTrial btn"].description = "Save Reg File"
         layout = {"width": "15%"}
         self.hs["SelSavTrial btn"].layout = layout
         self.hs["SelSavTrial btn"].on_click(self.SelSavTrial_btn_clk)
         self.hs["SelSavTrial box"].children = [
             self.hs["SelSavTrial text"],
             self.hs["SelSavTrial btn"],
         ]
 
         ## ## ## ## ## confirm file configuration
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["SelFile&PathCfm box"] = widgets.HBox()
         self.hs["SelFile&PathCfm box"].layout = layout
         self.hs["SelFile&PathCfm text"] = widgets.Text(
-            value=
-            "Save trial registration, or go directly review registration ...",
+            value="Save trial registration, or go directly review registration ...",
             description="",
             disabled=True,
         )
         layout = {"width": "66%"}
         self.hs["SelFile&PathCfm text"].layout = layout
         self.hs["SelFile&PathCfm btn"] = widgets.Button(
             description="Confirm",
@@ -1394,22 +1377,22 @@
                 # 'Read Reg File',
                 "Read Config File",
                 "Reg By Shift",
                 "Do Analysis",
             ],
             description="",
             disabled=False,
-            description_tooltip=
-            '"Do New Reg": start registration and review results from beginning; "Read Config File": if you like to resume analysis with an existing configuration.',
+            description_tooltip='"Do New Reg": start registration and review results from beginning; "Read Config File": if you like to resume analysis with an existing configuration.',
         )
         layout = {"width": "15%", "top": "0%"}
         self.hs["File&PathOptn drpdn"].layout = layout
 
-        self.hs["File&PathOptn drpdn"].observe(self.FilePathOptn_drpdn_chg,
-                                               names="value")
+        self.hs["File&PathOptn drpdn"].observe(
+            self.FilePathOptn_drpdn_chg, names="value"
+        )
         self.hs["SelFile&PathCfm box"].children = [
             self.hs["SelFile&PathCfm text"],
             self.hs["SelFile&PathCfm btn"],
             self.hs["File&PathOptn drpdn"],
         ]
 
         self.hs["SelFile&Path box"].children = [
@@ -1449,117 +1432,106 @@
             "width": "auto",
             "height": "auto",
         }
         self.hs["ConfigDataTitle box"] = widgets.HBox()
         self.hs["ConfigDataTitle box"].layout = layout
         self.hs["ConfigDataTitle label"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config Scan & Slice Indices" + "</span>")
+            + "Config Scan & Slice Indices"
+            + "</span>"
+        )
         layout = {"left": "35%", "background-color": "white", "color": "cyan"}
         self.hs["ConfigDataTitle label"].layout = layout
-        self.hs["ConfigDataTitle box"].children = [
-            self.hs["ConfigDataTitle label"]
-        ]
+        self.hs["ConfigDataTitle box"].children = [self.hs["ConfigDataTitle label"]]
 
         ## ## ## ## ## scan id range
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ScanIdRange box"] = widgets.HBox()
         self.hs["ScanIdRange box"].layout = layout
         self.hs["SelScanIdStart drpdn"] = widgets.Dropdown(
-            value=0, options=[0], description="scan_id start", disabled=True)
+            value=0, options=[0], description="scan_id start", disabled=True
+        )
         layout = {"width": "40%"}
         self.hs["SelScanIdStart drpdn"].layout = layout
         self.hs["SelScanIdEnd drpdn"] = widgets.Dropdown(
-            value=0, options=[0], description="scan_id end", disabled=True)
+            value=0, options=[0], description="scan_id end", disabled=True
+        )
         layout = {"width": "40%"}
         self.hs["SelScanIdEnd drpdn"].layout = layout
 
-        self.hs["SelScanIdStart drpdn"].observe(self.SelScanIdStart_drpdn_chg,
-                                                names="value")
-        self.hs["SelScanIdEnd drpdn"].observe(self.SelScanIdEnd_drpdn_chg,
-                                              names="value")
+        self.hs["SelScanIdStart drpdn"].observe(
+            self.SelScanIdStart_drpdn_chg, names="value"
+        )
+        self.hs["SelScanIdEnd drpdn"].observe(
+            self.SelScanIdEnd_drpdn_chg, names="value"
+        )
         self.hs["ScanIdRange box"].children = [
             self.hs["SelScanIdStart drpdn"],
             self.hs["SelScanIdEnd drpdn"],
         ]
 
         ## ## ## ## ## fixed scan and slice ids
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["FixedScanId box"] = widgets.HBox()
         self.hs["FixedScanId box"].layout = layout
         self.hs["FixedScanId drpdn"] = widgets.Dropdown(
-            value=0, options=[0], description="fixed scan id", disabled=True)
+            value=0, options=[0], description="fixed scan id", disabled=True
+        )
         layout = {"width": "40%"}
         self.hs["FixedScanId drpdn"].layout = layout
         self.hs["FixedSliId sldr"] = widgets.IntSlider(
-            value=0, description="fixed sli id", disabled=True)
+            value=0, description="fixed sli id", disabled=True
+        )
         layout = {"width": "40%"}
         self.hs["FixedSliId sldr"].layout = layout
 
-        self.hs["FixedScanId drpdn"].observe(self.FixedScanId_drpdn_chg,
-                                             names="value")
-        self.hs["FixedSliId sldr"].observe(self.FixedSliId_sldr_chg,
-                                           names="value")
+        self.hs["FixedScanId drpdn"].observe(self.FixedScanId_drpdn_chg, names="value")
+        self.hs["FixedSliId sldr"].observe(self.FixedSliId_sldr_chg, names="value")
         self.hs["FixedScanId box"].children = [
             self.hs["FixedScanId drpdn"],
             self.hs["FixedSliId sldr"],
         ]
 
         ## ## ## ## ## fiji option
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["Fiji box"] = widgets.HBox()
         self.hs["Fiji box"].layout = layout
         self.hs["FijiRawImgPrev chbx"] = widgets.Checkbox(
-            value=False, description="fiji view", disabled=True)
+            value=False, description="fiji view", disabled=True
+        )
         layout = {"width": "40%"}
         self.hs["FijiRawImgPrev chbx"].layout = layout
         self.hs["FijiClose btn"] = widgets.Button(
-            description="close all fiji viewers", disabled=True)
+            description="close all fiji viewers", disabled=True
+        )
         layout = {"width": "40%"}
         self.hs["FijiClose btn"].layout = layout
 
-        self.hs["FijiRawImgPrev chbx"].observe(self.FijiRawImgPrev_chbx_chg,
-                                               names="value")
+        self.hs["FijiRawImgPrev chbx"].observe(
+            self.FijiRawImgPrev_chbx_chg, names="value"
+        )
         self.hs["FijiClose btn"].on_click(self.FijiClose_btn_clk)
         self.hs["Fiji box"].children = [
             self.hs["FijiRawImgPrev chbx"],
             self.hs["FijiClose btn"],
         ]
 
         ## ## ## ## ## confirm indices configuration
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ConfigDataCfm box"] = widgets.HBox()
         self.hs["ConfigDataCfm box"].layout = layout
         self.hs["ConfigDataCfm text"] = widgets.Text(
-            value="Confirm setting once you are done ...",
-            description="",
-            disabled=True)
+            value="Confirm setting once you are done ...", description="", disabled=True
+        )
         layout = {"width": "66%"}
         self.hs["ConfigDataCfm text"].layout = layout
         self.hs["ConfigDataCfm btn"] = widgets.Button(
             description="Confirm",
             disabled=True,
-            description_tooltip=
-            "Confirm: Confirm after you finish file configuration",
+            description_tooltip="Confirm: Confirm after you finish file configuration",
         )
         self.hs["ConfigDataCfm btn"].style.button_color = "darkviolet"
         layout = {"width": "15%"}
         self.hs["ConfigDataCfm btn"].layout = layout
 
         self.hs["ConfigDataCfm btn"].on_click(self.ConfigDataCfm_btn_clk)
         self.hs["ConfigDataCfm box"].children = [
@@ -1619,24 +1591,22 @@
             "width": "auto",
             "height": f"{0.35*(self.form_sz[0]-136)}px",
         }
         self.hs["3DRoi box"] = widgets.VBox()
         self.hs["3DRoi box"].layout = layout
 
         ## ## ## ## ## label 3D_roi_title box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["3DRoiTitle box"] = widgets.HBox()
         self.hs["3DRoiTitle box"].layout = layout
         self.hs["3DRoiTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config 3D ROI" + "</span>")
+            + "Config 3D ROI"
+            + "</span>"
+        )
         layout = {
             "justify-content": "center",
             "background-color": "white",
             "color": "cyan",
             "left": "43%",
         }
         self.hs["3DRoiTitle text"].layout = layout
@@ -1687,44 +1657,39 @@
             continuous_update=False,
             orientation="horizontal",
             readout=True,
             readout_format="d",
         )
         self.hs["3DRoiZ sldr"].layout = layout
         self.hs["3DRoiZ sldr"].add_traits(
-            mylower=traitlets.traitlets.Any(self.hs["3DRoiZ sldr"].lower))
+            mylower=traitlets.traitlets.Any(self.hs["3DRoiZ sldr"].lower)
+        )
         self.hs["3DRoiZ sldr"].add_traits(
-            myupper=traitlets.traitlets.Any(self.hs["3DRoiZ sldr"].upper))
+            myupper=traitlets.traitlets.Any(self.hs["3DRoiZ sldr"].upper)
+        )
 
         self.hs["3DRoiX sldr"].observe(self.RoiX3D_sldr_chg, names="value")
         self.hs["3DRoiY sldr"].observe(self.RoiY3D_sldr_chg, names="value")
         self.hs["3DRoiZ sldr"].observe(self.RoiZ3D_val_sldr_chg, names="value")
-        self.hs["3DRoiZ sldr"].observe(self.RoiZ3D_lwr_sldr_chg,
-                                       names="mylower")
-        self.hs["3DRoiZ sldr"].observe(self.RoiZ3D_upr_sldr_chg,
-                                       names="myupper")
+        self.hs["3DRoiZ sldr"].observe(self.RoiZ3D_lwr_sldr_chg, names="mylower")
+        self.hs["3DRoiZ sldr"].observe(self.RoiZ3D_upr_sldr_chg, names="myupper")
         self.hs["3DRoiDefine box"].children = [
             self.hs["3DRoiX sldr"],
             self.hs["3DRoiY sldr"],
             self.hs["3DRoiZ sldr"],
         ]
 
         ## ## ## ## ## confirm roi
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["3DRoiCfm box"] = widgets.HBox()
         self.hs["3DRoiCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["3DRoiCfm text"] = widgets.Text(
-            description="",
-            value="Please confirm after ROI is set ...",
-            disabled=True)
+            description="", value="Please confirm after ROI is set ...", disabled=True
+        )
         self.hs["3DRoiCfm text"].layout = layout
         layout = {"width": "15%"}
         self.hs["3DRoiCfm btn"] = widgets.Button(
             description="Confirm",
             disabled=True,
             description_tooltip="Confirm the roi once you define the ROI ...",
         )
@@ -1750,79 +1715,68 @@
             "width": "auto",
             "height": f"{0.42*(self.form_sz[0]-136)}px",
         }
         self.hs["ConfigRegParams box"] = widgets.VBox()
         self.hs["ConfigRegParams box"].layout = layout
 
         ## ## ## ## ## label config_reg_params box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ConfigRegParamsTitle box"] = widgets.HBox()
         self.hs["ConfigRegParamsTitle box"].layout = layout
         self.hs["ConfigRegParamsTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Config Reg Params" + "</span>")
-        layout = {
-            "background-color": "white",
-            "color": "cyan",
-            "left": "40.5%"
-        }
+            + "Config Reg Params"
+            + "</span>"
+        )
+        layout = {"background-color": "white", "color": "cyan", "left": "40.5%"}
         self.hs["ConfigRegParamsTitle text"].layout = layout
         self.hs["ConfigRegParamsTitle box"].children = [
             self.hs["ConfigRegParamsTitle text"]
         ]
 
         ## ## ## ## ## fiji&anchor box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["Fiji&Anchor box"] = widgets.HBox()
         self.hs["Fiji&Anchor box"].layout = layout
         self.hs["FijiMaskViewer chbx"] = widgets.Checkbox(
-            value=False, disabled=True, description="preview", indent=False)
+            value=False, disabled=True, description="preview", indent=False
+        )
         layout = {"width": "19%"}
         self.hs["FijiMaskViewer chbx"].layout = layout
-        self.hs["ChunkSz chbx"] = widgets.Checkbox(value=True,
-                                                   disabled=True,
-                                                   description="use chunk")
+        self.hs["ChunkSz chbx"] = widgets.Checkbox(
+            value=True, disabled=True, description="use chunk"
+        )
         layout = {"width": "19%"}
         self.hs["ChunkSz chbx"].layout = layout
-        self.hs["ChunkSz sldr"] = widgets.IntSlider(value=7,
-                                                    disabled=True,
-                                                    description="chunk size")
+        self.hs["ChunkSz sldr"] = widgets.IntSlider(
+            value=7, disabled=True, description="chunk size"
+        )
         layout = {"width": "29%"}
         self.hs["ChunkSz sldr"].layout = layout
         self.hs["SliSrch sldr"] = widgets.IntSlider(
-            value=10, disabled=True, description="z search half width")
+            value=10, disabled=True, description="z search half width"
+        )
         layout = {"width": "29%"}
         self.hs["SliSrch sldr"].layout = layout
 
-        self.hs["FijiMaskViewer chbx"].observe(self.FijiMaskViewer_chbx_chg,
-                                               names="value")
+        self.hs["FijiMaskViewer chbx"].observe(
+            self.FijiMaskViewer_chbx_chg, names="value"
+        )
         self.hs["ChunkSz chbx"].observe(self.ChunkSz_chbx_chg, names="value")
         self.hs["ChunkSz sldr"].observe(self.ChunkSz_sldr_chg, names="value")
         self.hs["SliSrch sldr"].observe(self.SliSrch_sldr_chg, names="value")
         self.hs["Fiji&Anchor box"].children = [
             self.hs["FijiMaskViewer chbx"],
             self.hs["ChunkSz chbx"],
             self.hs["ChunkSz sldr"],
             self.hs["SliSrch sldr"],
         ]
 
         ## ## ## ## ## mask options box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["MaskOptn box"] = widgets.HBox()
         self.hs["MaskOptn box"].layout = layout
         self.hs["UseMask chbx"] = widgets.Checkbox(
             value=False,
             disabled=True,
             description="use mask",
             display="flex",
@@ -1849,67 +1803,54 @@
             max=30,
             step=1,
         )
         layout = {"width": "40%", "left": "2.5%"}
         self.hs["MaskDilation sldr"].layout = layout
 
         self.hs["UseMask chbx"].observe(self.UseMask_chbx_chg, names="value")
-        self.hs["MaskThres sldr"].observe(self.MaskThres_sldr_chg,
-                                          names="value")
-        self.hs["MaskDilation sldr"].observe(self.MaskDilation_sldr_chg,
-                                             names="value")
+        self.hs["MaskThres sldr"].observe(self.MaskThres_sldr_chg, names="value")
+        self.hs["MaskDilation sldr"].observe(self.MaskDilation_sldr_chg, names="value")
         self.hs["MaskOptn box"].children = [
             self.hs["UseMask chbx"],
             self.hs["MaskThres sldr"],
             self.hs["MaskDilation sldr"],
         ]
 
         ## ## ## ## ## sli_search & chunk_size box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RegOptn box"] = widgets.HBox()
         self.hs["RegOptn box"].layout = layout
         self.hs["RegMethod drpdn"] = widgets.Dropdown(
             value="MRTV",
             description="reg method",
             disabled=True,
             options=["MRTV", "MPC", "PC", "SR", "LS_MRTV", "MPC_MRTV"],
-            description_tooltip=
-            "reg method: MPC: Masked Phase Correlation; PC: Phase Correlation; SR: StackReg",
+            description_tooltip="reg method: MPC: Masked Phase Correlation; PC: Phase Correlation; SR: StackReg",
         )
         layout = {"width": "19%"}
         self.hs["RegMethod drpdn"].layout = layout
         self.hs["RefMode drpdn"] = widgets.Dropdown(
             value="single",
             options=["single", "neighbor", "average"],
             description="ref mode",
             disabled=True,
-            description_tooltip=
-            "ref mode: single: two images with fixed id gap in two consecutive chunks are used for the registration between two chunks; neighbor: two neighbor images in two consecutive chunks are used for the registration between two chunks; average: deprecated",
+            description_tooltip="ref mode: single: two images with fixed id gap in two consecutive chunks are used for the registration between two chunks; neighbor: two neighbor images in two consecutive chunks are used for the registration between two chunks; average: deprecated",
         )
         layout = {"width": "19%"}
         self.hs["RefMode drpdn"].layout = layout
 
-        self.hs["RegMethod drpdn"].observe(self.RegMethod_drpdn_chg,
-                                           names="value")
+        self.hs["RegMethod drpdn"].observe(self.RegMethod_drpdn_chg, names="value")
         self.hs["RefMode drpdn"].observe(self.RefMode_drpdn_chg, names="value")
         self.hs["RegOptn box"].children = [
             self.hs["RegMethod drpdn"],
             self.hs["RefMode drpdn"],
         ]
 
         ## ## ## ## ##  reg_options box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["MRTVOptn box"] = widgets.HBox()
         self.hs["MRTVOptn box"].layout = layout
 
         self.hs["MRTVLevel text"] = widgets.BoundedIntText(
             value=5,
             min=1,
             max=10,
@@ -1923,16 +1864,15 @@
 
         self.hs["MRTVWz text"] = widgets.BoundedIntText(
             value=10,
             min=1,
             max=20,
             step=1,
             description="width",
-            description_tooltip=
-            "width: multi-resolution searching width at each level (number of searching steps)",
+            description_tooltip="width: multi-resolution searching width at each level (number of searching steps)",
             disabled=True,
         )
         layout = {"width": "19%"}
         self.hs["MRTVWz text"].layout = layout
 
         self.hs["MRTVSubpixelSrch drpdn"] = widgets.Dropdown(
             value="analytical",
@@ -1959,43 +1899,40 @@
         self.hs["MRTVSubpixelKernel text"] = widgets.BoundedIntText(
             value=3,
             min=2,
             max=20,
             step=1,
             description="kernel wz",
             disabled=True,
-            description_tooltip=
-            "kernel wz: Gaussian blurring width before TV minimization",
+            description_tooltip="kernel wz: Gaussian blurring width before TV minimization",
         )
         layout = {"width": "19%"}
         self.hs["MRTVSubpixelKernel text"].layout = layout
 
-        self.hs["MRTVLevel text"].observe(self.MRTVLevel_text_chg,
-                                          names="value")
+        self.hs["MRTVLevel text"].observe(self.MRTVLevel_text_chg, names="value")
         self.hs["MRTVWz text"].observe(self.MRTVWz_text_chg, names="value")
-        self.hs["MRTVSubpixelWz text"].observe(self.MRTVSubpixelWz_text_chg,
-                                               names="value")
+        self.hs["MRTVSubpixelWz text"].observe(
+            self.MRTVSubpixelWz_text_chg, names="value"
+        )
         self.hs["MRTVSubpixelKernel text"].observe(
-            self.MRTVSubpixelKernel_text_chg, names="value")
+            self.MRTVSubpixelKernel_text_chg, names="value"
+        )
         self.hs["MRTVSubpixelSrch drpdn"].observe(
-            self.MRTVSubpixelSrch_drpdn_chg, names="value")
+            self.MRTVSubpixelSrch_drpdn_chg, names="value"
+        )
         self.hs["MRTVOptn box"].children = [
             self.hs["MRTVLevel text"],
             self.hs["MRTVWz text"],
             self.hs["MRTVSubpixelSrch drpdn"],
             self.hs["MRTVSubpixelWz text"],
             self.hs["MRTVSubpixelKernel text"],
         ]
 
         ## ## ## ## ## confirm reg settings -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ConfigRegParamsCfm box"] = widgets.HBox()
         self.hs["ConfigRegParamsCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["ConfigRegParamsCfm text"] = widgets.Text(
             description="",
             disabled=True,
             value="Confirm the roi once you define the ROI ...",
@@ -2006,16 +1943,15 @@
             description="Confirm",
             disabled=True,
             description_tooltip="Confirm the roi once you define the ROI ...",
         )
         self.hs["ConfigRegParamsCfm btn"].style.button_color = "darkviolet"
         self.hs["ConfigRegParamsCfm btn"].layout = layout
 
-        self.hs["ConfigRegParamsCfm btn"].on_click(
-            self.ConfigRegParamsCfm_btn_clk)
+        self.hs["ConfigRegParamsCfm btn"].on_click(self.ConfigRegParamsCfm_btn_clk)
         self.hs["ConfigRegParamsCfm box"].children = [
             self.hs["ConfigRegParamsCfm text"],
             self.hs["ConfigRegParamsCfm btn"],
         ]
         ## ## ## ## ## confirm reg settings -- end
         self.hs["ConfigRegParams box"].children = [
             self.hs["ConfigRegParamsTitle box"],
@@ -2033,34 +1969,28 @@
             "width": "auto",
             "height": f"{0.21*(self.form_sz[0]-136)}px",
         }
         self.hs["RunReg box"] = widgets.VBox()
         self.hs["RunReg box"].layout = layout
 
         ## ## ## ## ## label run_reg box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RunRegTitle box"] = widgets.HBox()
         self.hs["RunRegTitle box"].layout = layout
         self.hs["RunRegTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Run Registration" + "</span>")
+            + "Run Registration"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "41%"}
         self.hs["RunRegTitle text"].layout = layout
         self.hs["RunRegTitle box"].children = [self.hs["RunRegTitle text"]]
 
         ## ## ## ## ## run reg & status
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RunRegCfm box"] = widgets.HBox()
         self.hs["RunRegCfm box"].layout = layout
         layout = {"width": "70%"}
         self.hs["RunRegCfm text"] = widgets.Text(
             description="",
             disabled=True,
             value="run registration once you are ready ...",
@@ -2078,19 +2008,15 @@
         self.hs["RunRegCfm btn"].on_click(self.RunRegCfm_btn_clk)
         self.hs["RunRegCfm box"].children = [
             self.hs["RunRegCfm text"],
             self.hs["RunRegCfm btn"],
         ]
 
         ## ## ## ## ## run reg progress
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RunRegPrgr box"] = widgets.HBox()
         self.hs["RunRegPrgr box"].layout = layout
         layout = {"width": "100%"}
         self.hs["RunRegPrgr bar"] = widgets.IntProgress(
             value=0,
             min=0,
             max=10,
@@ -2122,145 +2048,111 @@
             "width": "auto",
             "height": f"{0.35*(self.form_sz[0]-136)}px",
         }
         self.hs["RevRegRlt box"] = widgets.VBox()
         self.hs["RevRegRlt box"].layout = layout
 
         ## ## ## ## ## label the box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RevRegRltTitle box"] = widgets.HBox()
         self.hs["RevRegRltTitle box"].layout = layout
         self.hs["RevRegRltTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Review Registration Results" + "</span>")
-        layout = {
-            "background-color": "white",
-            "color": "cyan",
-            "left": "35.7%"
-        }
+            + "Review Registration Results"
+            + "</span>"
+        )
+        layout = {"background-color": "white", "color": "cyan", "left": "35.7%"}
         self.hs["RevRegRltTitle text"].layout = layout
-        self.hs["RevRegRltTitle box"].children = [
-            self.hs["RevRegRltTitle text"]
-        ]
+        self.hs["RevRegRltTitle box"].children = [self.hs["RevRegRltTitle text"]]
 
         ## ## ## ## ## read alignment file
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["ReadAlignFile box"] = widgets.HBox()
         self.hs["ReadAlignFile box"].layout = layout
         layout = {"width": "85%"}
         self.hs["ReadAlign chbx"] = widgets.Checkbox(
-            description="read alignment", value=False, disabled=True)
+            description="read alignment", value=False, disabled=True
+        )
         self.hs["ReadAlign chbx"].layout = layout
         layout = {"width": "15%"}
         self.hs["ReadAlign btn"] = SelectFilesButton(option="askopenfilename")
         self.hs["ReadAlign btn"].layout = layout
         self.hs["ReadAlign btn"].disabled = True
 
-        self.hs["ReadAlign chbx"].observe(self.ReadAlign_chbx_chg,
-                                          names="value")
+        self.hs["ReadAlign chbx"].observe(self.ReadAlign_chbx_chg, names="value")
         self.hs["ReadAlign btn"].on_click(self.ReadAlign_btn_clk)
         self.hs["ReadAlignFile box"].children = [
             self.hs["ReadAlign chbx"],
             self.hs["ReadAlign btn"],
         ]
 
         ## ## ## ## ## reg pair box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RegPair box"] = widgets.HBox()
         self.hs["RegPair box"].layout = layout
         layout = {"width": "85%"}
-        self.hs["RegPair sldr"] = widgets.IntSlider(value=False,
-                                                    disabled=True,
-                                                    description="reg pair #")
+        self.hs["RegPair sldr"] = widgets.IntSlider(
+            value=False, disabled=True, description="reg pair #"
+        )
         self.hs["RegPair sldr"].layout = layout
 
         layout = {"width": "15%"}
         self.hs["RegPairBad btn"] = widgets.Button(
-            description="Bad", description_tooltip="Bad reg", disabled=True)
+            description="Bad", description_tooltip="Bad reg", disabled=True
+        )
         self.hs["RegPairBad btn"].layout = layout
         self.hs["RegPairBad btn"].style.button_color = "darkviolet"
 
         self.hs["RegPair sldr"].observe(self.RegPair_sldr_chg, names="value")
         self.hs["RegPairBad btn"].on_click(self.RegPairBad_btn_clk)
         self.hs["RegPair box"].children = [
             self.hs["RegPair sldr"],
             self.hs["RegPairBad btn"],
         ]
 
         ## ## ## ## ## manual shift box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["CorrShft box"] = widgets.HBox()
         self.hs["CorrShft box"].layout = layout
         layout = {"width": "28%"}
-        self.hs["CorrXShift text"] = widgets.FloatText(value=0,
-                                                       disabled=True,
-                                                       min=-100,
-                                                       max=100,
-                                                       step=0.5,
-                                                       description="x shift")
+        self.hs["CorrXShift text"] = widgets.FloatText(
+            value=0, disabled=True, min=-100, max=100, step=0.5, description="x shift"
+        )
         self.hs["CorrXShift text"].layout = layout
         layout = {"width": "28%"}
-        self.hs["CorrYShift text"] = widgets.FloatText(value=0,
-                                                       disabled=True,
-                                                       min=-100,
-                                                       max=100,
-                                                       step=0.5,
-                                                       description="y shift")
+        self.hs["CorrYShift text"] = widgets.FloatText(
+            value=0, disabled=True, min=-100, max=100, step=0.5, description="y shift"
+        )
         self.hs["CorrYShift text"].layout = layout
         layout = {"width": "27.5%"}
-        self.hs["CorrZShift text"] = widgets.IntText(value=0,
-                                                     disabled=True,
-                                                     min=1,
-                                                     max=100,
-                                                     step=1,
-                                                     description="z shift")
+        self.hs["CorrZShift text"] = widgets.IntText(
+            value=0, disabled=True, min=1, max=100, step=1, description="z shift"
+        )
         self.hs["CorrZShift text"].layout = layout
         layout = {"width": "15%"}
-        self.hs["CorrShftRecord btn"] = widgets.Button(disabled=True,
-                                                       description="Record")
+        self.hs["CorrShftRecord btn"] = widgets.Button(
+            disabled=True, description="Record"
+        )
         self.hs["CorrShftRecord btn"].layout = layout
         self.hs["CorrShftRecord btn"].style.button_color = "darkviolet"
 
-        self.hs["CorrXShift text"].observe(self.CorrXShift_text_chg,
-                                           names="value")
-        self.hs["CorrYShift text"].observe(self.CorrYShift_text_chg,
-                                           names="value")
-        self.hs["CorrZShift text"].observe(self.CorrZShift_text_chg,
-                                           names="value")
+        self.hs["CorrXShift text"].observe(self.CorrXShift_text_chg, names="value")
+        self.hs["CorrYShift text"].observe(self.CorrYShift_text_chg, names="value")
+        self.hs["CorrZShift text"].observe(self.CorrZShift_text_chg, names="value")
         self.hs["CorrShftRecord btn"].on_click(self.CorrShftRecord_btn_clk)
         self.hs["CorrShft box"].children = [
             self.hs["CorrXShift text"],
             self.hs["CorrYShift text"],
             self.hs["CorrZShift text"],
             self.hs["CorrShftRecord btn"],
         ]
         ## ## ## ## ## manual shift box -- end
 
         ## ## ## ## ## confirm review results box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["RevRegRltCfm box"] = widgets.HBox()
         self.hs["RevRegRltCfm box"].layout = layout
         layout = {"width": "85%", "display": "inline_flex"}
         self.hs["RevRegRltCfm text"] = widgets.Text(
             description="",
             disabled=True,
             value="Confirm after you finish reg review ...",
@@ -2296,149 +2188,129 @@
             "width": "auto",
             "height": f"{0.28*(self.form_sz[0]-136)}px",
         }
         self.hs["AlignRecon box"] = widgets.VBox()
         self.hs["AlignRecon box"].layout = layout
 
         ## ## ## ## ## label the box
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignReconTitle box"] = widgets.HBox()
         self.hs["AlignReconTitle box"].layout = layout
         self.hs["AlignReconTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Align 3D Recon" + "</span>")
+            + "Align 3D Recon"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "41%"}
         self.hs["AlignReconTitle text"].layout = layout
-        self.hs["AlignReconTitle box"].children = [
-            self.hs["AlignReconTitle text"]
-        ]
+        self.hs["AlignReconTitle box"].children = [self.hs["AlignReconTitle text"]]
 
         ## ## ## ## ## define slice region if it is necessary
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignReconOptnSliRegion box"] = widgets.HBox()
         self.hs["AlignReconOptnSliRegion box"].layout = layout
         layout = {"width": "20%"}
         self.hs["AlignReconOptnSli chbx"] = widgets.Checkbox(
             description="new z range",
             value=False,
             disabled=True,
-            description_tooltip=
-            "check this on if you like to adjust z slice range for alignment",
+            description_tooltip="check this on if you like to adjust z slice range for alignment",
         )
         self.hs["AlignReconOptnSli chbx"].layout = layout
         layout = {"width": "10%"}
         self.hs["AlignReconOptnSliStart text"] = widgets.BoundedIntText(
             description="",
             value=0,
             min=0,
             max=10,
             disabled=True,
-            description_tooltip=
-            "In the case of reading and reviewing a registration file, you need to define slice start and end.",
+            description_tooltip="In the case of reading and reviewing a registration file, you need to define slice start and end.",
         )
         self.hs["AlignReconOptnSliStart text"].layout = layout
         layout = {"width": "60%"}
         self.hs["AlignReconOptnSliRange sldr"] = widgets.IntRangeSlider(
             description="z range",
             value=[0, 1],
             min=0,
             max=10,
             disabled=True,
-            description_tooltip=
-            "In the case of reading and reviewing a registration file, you need to define slice start and end.",
+            description_tooltip="In the case of reading and reviewing a registration file, you need to define slice start and end.",
         )
         self.hs["AlignReconOptnSliRange sldr"].layout = layout
         layout = {"width": "10%"}
         self.hs["AlignReconOptnSliEnd text"] = widgets.BoundedIntText(
             description="",
             value=0,
             min=0,
             max=10,
             disabled=True,
-            description_tooltip=
-            "In the case of reading and reviewing a registration file, you need to define slice start and end.",
+            description_tooltip="In the case of reading and reviewing a registration file, you need to define slice start and end.",
         )
         self.hs["AlignReconOptnSliEnd text"].layout = layout
 
         self.hs["AlignReconOptnSli chbx"].observe(
-            self.AlignReconOptnSli_chbx_chg, names="value")
+            self.AlignReconOptnSli_chbx_chg, names="value"
+        )
         self.hs["AlignReconOptnSliStart text"].observe(
-            self.AlignReconOptnSliStart_text_chg, names="value")
+            self.AlignReconOptnSliStart_text_chg, names="value"
+        )
         self.hs["AlignReconOptnSliEnd text"].observe(
-            self.AlignReconOptnSliEnd_text_chg, names="value")
+            self.AlignReconOptnSliEnd_text_chg, names="value"
+        )
         self.hs["AlignReconOptnSliRange sldr"].observe(
-            self.AlignReconOptnSliRange_sldr_chg, names="value")
+            self.AlignReconOptnSliRange_sldr_chg, names="value"
+        )
         self.hs["AlignReconOptnSliRegion box"].children = [
             self.hs["AlignReconOptnSli chbx"],
             self.hs["AlignReconOptnSliStart text"],
             self.hs["AlignReconOptnSliRange sldr"],
             self.hs["AlignReconOptnSliEnd text"],
         ]
 
         ## ## ## ## ## run reg & status
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignReconCfm box"] = widgets.HBox()
         self.hs["AlignReconCfm box"].layout = layout
         layout = {"width": "85%"}
         self.hs["AlignReconCfm text"] = widgets.Text(
-            description="",
-            disabled=True,
-            value="Confirm to proceed alignment ...")
+            description="", disabled=True, value="Confirm to proceed alignment ..."
+        )
         self.hs["AlignReconCfm text"].layout = layout
         layout = {"width": "15%"}
         self.hs["AlignReconCfm btn"] = widgets.Button(
             description="Align",
             disabled=True,
-            description_tooltip=
-            "This will perform xanes3D alignment according to your configurations ...",
+            description_tooltip="This will perform xanes3D alignment according to your configurations ...",
         )
         self.hs["AlignReconCfm btn"].style.button_color = "darkviolet"
         self.hs["AlignReconCfm btn"].layout = layout
 
         self.hs["AlignReconCfm btn"].on_click(self.AlignReconCfm_btn_clk)
         self.hs["AlignReconCfm box"].children = [
             self.hs["AlignReconCfm text"],
             self.hs["AlignReconCfm btn"],
         ]
 
         ## ## ## ## ## run reg progress
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["AlignReconPrgr box"] = widgets.HBox()
         self.hs["AlignReconPrgr box"].layout = layout
         layout = {"width": "100%"}
         self.hs["AlignReconPrgr bar"] = widgets.IntProgress(
             value=0,
             min=0,
             max=10,
             step=1,
             description="Completing:",
             orientation="horizontal",
             bar_style="info",
         )  # 'success', 'info', 'warning', 'danger' or ''
         self.hs["AlignReconPrgr bar"].layout = layout
 
-        self.hs["AlignReconPrgr box"].children = [
-            self.hs["AlignReconPrgr bar"]
-        ]
+        self.hs["AlignReconPrgr box"].children = [self.hs["AlignReconPrgr bar"]]
 
         self.hs["AlignRecon box"].children = [
             self.hs["AlignReconTitle box"],
             self.hs["AlignReconOptnSliRegion box"],
             self.hs["AlignReconCfm box"],
             self.hs["AlignReconPrgr box"],
         ]
@@ -2450,138 +2322,130 @@
             "width": "auto",
             "height": f"{0.28*(self.form_sz[0]-136)}px",
         }
         self.hs["VisImg box"] = widgets.VBox()
         self.hs["VisImg box"].layout = layout
 
         ## ## ## ## ## label visualize box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["VisImgTitle box"] = widgets.HBox()
         self.hs["VisImgTitle box"].layout = layout
         self.hs["VisImgTitle text"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + "Visualize XANES3D" + "</span>")
+            + "Visualize XANES3D"
+            + "</span>"
+        )
         layout = {"background-color": "white", "color": "cyan", "left": "38%"}
         self.hs["VisImgTitle text"].layout = layout
 
         self.hs["VisImgTitle box"].children = [self.hs["VisImgTitle text"]]
         ## ## ## ## ## label visualize box -- end
 
         ## ## ## ## ## visualization option box -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["VisImgViewerOptn box"] = widgets.HBox()
         self.hs["VisImgViewerOptn box"].layout = layout
         layout = {"width": "80%"}
         self.hs["VisImgViewerOptn tgbtn"] = widgets.ToggleButtons(
             description="viewer options",
             disabled=True,
-            description_tooltip=
-            "napari: provides better image preview functions; fiji: provides quick spectrum inspection functions",
+            description_tooltip="napari: provides better image preview functions; fiji: provides quick spectrum inspection functions",
             options=["fiji", "napari"],
             value="fiji",
         )
         self.hs["VisImgViewerOptn tgbtn"].layout = layout
         layout = {"width": "20%"}
         self.hs["VisImgViewAlignOptn drpdn"] = widgets.Dropdown(
             description="view option",
-            description_tooltip=
-            "dimensions are defined as: E: energy dimension; x-y: slice lateral plane; z: dimension normal to slice plane",
+            description_tooltip="dimensions are defined as: E: energy dimension; x-y: slice lateral plane; z: dimension normal to slice plane",
             options=["x-y-E", "y-z-E", "z-x-E", "x-y-z"],
             value="x-y-E",
             disabled=True,
         )
         self.hs["VisImgViewAlignOptn drpdn"].layout = layout
 
         self.hs["VisImgViewerOptn tgbtn"].observe(
-            self.VisImgViewerOptn_tgbtn_clk, names="value")
+            self.VisImgViewerOptn_tgbtn_clk, names="value"
+        )
         self.hs["VisImgViewAlignOptn drpdn"].observe(
-            self.VisImgViewAlignOptn_drpdn_clk, names="value")
+            self.VisImgViewAlignOptn_drpdn_clk, names="value"
+        )
         self.hs["VisImgViewerOptn box"].children = [
             self.hs["VisImgViewerOptn tgbtn"],
             self.hs["VisImgViewAlignOptn drpdn"],
         ]
         ## ## ## ## ## visualization option box -- end
 
         ## ## ## ## ## define slice region and view slice cuts -- start
-        layout = {
-            "border": "3px solid #FFCC00",
-            "width": "auto",
-            "height": "auto"
-        }
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
         self.hs["VisImgViewAlign box"] = widgets.HBox()
         self.hs["VisImgViewAlign box"].layout = layout
 
         layout = {"width": "35%"}
         self.hs["VisImgViewAlign4thDim sldr"] = widgets.IntSlider(
             description="z",
             value=0,
             min=0,
             disabled=True,
             description_tooltip="Select one slice in the fourth dimension",
         )
         self.hs["VisImgViewAlign4thDim sldr"].layout = layout
         layout = {"width": "35%"}
-        self.hs["VisImgViewAlignSli sldr"] = widgets.IntSlider(description="E",
-                                                               disabled=True)
+        self.hs["VisImgViewAlignSli sldr"] = widgets.IntSlider(
+            description="E", disabled=True
+        )
         self.hs["VisImgViewAlignSli sldr"].layout = layout
         layout = {"width": "20%"}
-        self.hs["VisImgViewAlignEng text"] = widgets.FloatText(value=0,
-                                                               description="E",
-                                                               disabled=True)
+        self.hs["VisImgViewAlignEng text"] = widgets.FloatText(
+            value=0, description="E", disabled=True
+        )
         self.hs["VisImgViewAlignEng text"].layout = layout
 
         self.hs["VisImgViewAlign4thDim sldr"].observe(
-            self.VisImgViewAlign4thDim_sldr_chg, names="value")
+            self.VisImgViewAlign4thDim_sldr_chg, names="value"
+        )
         self.hs["VisImgViewAlignSli sldr"].observe(
-            self.VisImgViewAlignSli_sldr_chg, names="value")
+            self.VisImgViewAlignSli_sldr_chg, names="value"
+        )
         self.hs["VisImgViewAlign box"].children = [
             self.hs["VisImgViewAlign4thDim sldr"],
             self.hs["VisImgViewAlignSli sldr"],
             self.hs["VisImgViewAlignEng text"],
         ]
         ## ## ## ## ## define slice region and view slice cuts -- end
 
         ## ## ## ## ## basic spectroscopic visualization -- start
         layout = {"border": "3px solid #FFCC00", "layout": "center"}
         self.hs["VisSpecView box"] = widgets.HBox()
         self.hs["VisSpecView box"].layout = layout
         layout = {"width": "70%"}
         self.hs["VisSpecView text"] = widgets.Text(
-            description="",
-            disabled=True,
-            value="visualize spectrum in roi ...")
+            description="", disabled=True, value="visualize spectrum in roi ..."
+        )
         self.hs["VisSpecView text"].layout = layout
         layout = {"width": "15%", "left": "-8%"}
         self.hs["VisSpecViewMemMnt chbx"] = widgets.Checkbox(
             description="mem use",
             value=False,
             disabled=True,
             description_tooltip="Check on this to monitor memmory usage",
         )
         self.hs["VisSpecViewMemMnt chbx"].layout = layout
         layout = {"width": "15%"}
         self.hs["VisSpecViewInRoi btn"] = widgets.Button(
             description="spec in roi",
             disabled=True,
-            description_tooltip=
-            "adjust the roi size and drag roi over in the particles",
+            description_tooltip="adjust the roi size and drag roi over in the particles",
         )
         self.hs["VisSpecViewInRoi btn"].layout = layout
         self.hs["VisSpecViewInRoi btn"].style.button_color = "darkviolet"
 
         self.hs["VisSpecViewMemMnt chbx"].observe(
-            self.VisSpecViewMemMnt_chbx_chg, names="value")
+            self.VisSpecViewMemMnt_chbx_chg, names="value"
+        )
         self.hs["VisSpecViewInRoi btn"].on_click(self.VisSpecViewInRoi_btn_clk)
         self.hs["VisSpecView box"].children = [
             self.hs["VisSpecViewMemMnt chbx"],
             self.hs["VisSpecViewInRoi btn"],
         ]
         ## ## ## ## ## basic spectroscopic visualization -- end
 
@@ -2596,524 +2460,707 @@
         self.hs["Reg&Rev form"].children = [
             self.hs["RevRegRlt box"],
             self.hs["AlignRecon box"],
             self.hs["VisImg box"],
         ]
         ## ## ## bin sub-tabs in each tab - reg&review TAB in 3D_xanes TAB -- end
 
-        self.hs["Fitting form"].children = [
-            self.xanes_fit_gui_h.hs["Fitting form"]
-        ]
+        self.hs["Fitting form"].children = [self.xanes_fit_gui_h.hs["Fitting form"]]
         ## ## ## bin sub-tabs in each tab - analysis&display TAB in 3D_xanes TAB -- end
 
-        self.hs["Analysis form"].children = [
-            self.xanes_ana_gui_h.hs["Ana form"]
-        ]
+        self.hs["Analysis form"].children = [self.xanes_ana_gui_h.hs["Ana form"]]
         ## ## ## define 2D_XANES_tabs layout - analysis box -- end
 
         self.hs["SelRawH5Path btn"].initialdir = self.global_h.cwd
         self.hs["SelReconPath btn"].initialdir = self.global_h.cwd
         self.hs["SelSavTrial btn"].initialdir = self.global_h.cwd
         self.hs["ReadAlign btn"].initialdir = self.global_h.cwd
 
     def SelRawH5Path_btn_clk(self, a):
         if len(a.files[0]) != 0:
-            self.xanes_raw_3D_h5_top_dir = os.path.abspath(a.files[0])
-            self.hs["SelRawH5Path btn"].initialdir = os.path.abspath(
-                a.files[0])
-            self.hs["SelReconPath btn"].initialdir = os.path.abspath(
-                a.files[0])
-            self.hs["SelSavTrial btn"].initialdir = os.path.abspath(a.files[0])
-            self.hs["ReadAlign btn"].initialdir = os.path.abspath(a.files[0])
-            self.xanes_raw_3D_h5_temp = os.path.join(
-                self.xanes_raw_3D_h5_top_dir, self.xanes_raw_fn_temp)
+            # self.xanes_raw_3D_h5_top_dir = os.path.abspath(a.files[0])
+            # self.hs["SelRawH5Path btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["SelReconPath btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["SelSavTrial btn"].initialdir = os.path.abspath(a.files[0])
+            # self.hs["ReadAlign btn"].initialdir = os.path.abspath(a.files[0])
+            # self.xanes_raw_3D_h5_temp = os.path.join(
+            #     self.xanes_raw_3D_h5_top_dir, self.xanes_raw_fn_temp
+            # )
+            # update_json_content(
+            #     self.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+            # )
+            # self.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
+            self.xanes_raw_3D_h5_top_dir = str(Path(a.files[0]).absolute())
+            self.hs["SelRawH5Path btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["SelReconPath btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["SelSavTrial btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.hs["ReadAlign btn"].initialdir = str(Path(a.files[0]).absolute())
+            self.xanes_raw_3D_h5_temp = str(
+                Path(self.xanes_raw_3D_h5_top_dir) / self.xanes_raw_fn_temp
+            )
             update_json_content(
                 self.global_h.GUI_cfg_file,
-                {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                {"cwd": str(Path(a.files[0]).absolute().parent)},
             )
-            self.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
+            self.global_h.cwd = str(Path(a.files[0]).absolute().parent)
             self.xanes_raw_h5_path_set = True
         else:
             self.hs["SelRawH5Path text"].value = "Choose raw h5 directory ..."
             self.xanes_raw_h5_path_set = False
         self.xanes_file_configured = False
-        self.hs[
-            "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+        self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def SelReconPath_btn_clk(self, a):
         if not self.xanes_raw_h5_path_set:
-            self.hs[
-                "SelFile&PathCfm text"].value = "You need to specify raw h5 top directory first ..."
-            self.hs[
-                "SelReconPath text"].value = "Choose recon top directory ..."
+            self.hs["SelFile&PathCfm text"].value = (
+                "You need to specify raw h5 top directory first ..."
+            )
+            self.hs["SelReconPath text"].value = "Choose recon top directory ..."
             self.xanes_recon_path_set = False
             self.xanes_file_configured = False
         else:
             if len(a.files[0]) != 0:
-                self.xanes_recon_3D_top_dir = os.path.abspath(a.files[0])
-                self.xanes_recon_3D_dir_temp = os.path.join(
-                    self.xanes_recon_3D_top_dir, self.xanes_recon_dir_temp)
-                self.xanes_recon_3D_tiff_temp = os.path.join(
-                    self.xanes_recon_3D_top_dir,
-                    self.xanes_recon_dir_temp,
-                    self.xanes_recon_fn_temp,
+                # self.xanes_recon_3D_top_dir = os.path.abspath(a.files[0])
+                # self.xanes_recon_3D_dir_temp = os.path.join(
+                #     self.xanes_recon_3D_top_dir, self.xanes_recon_dir_temp
+                # )
+                # self.xanes_recon_3D_tiff_temp = os.path.join(
+                #     self.xanes_recon_3D_top_dir,
+                #     self.xanes_recon_dir_temp,
+                #     self.xanes_recon_fn_temp,
+                # )
+
+                # self.hs["SelReconPath btn"].initialdir = os.path.abspath(a.files[0])
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file, {"cwd": os.path.abspath(a.files[0])}
+                # )
+                # self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+                self.xanes_recon_3D_top_dir = str(Path(a.files[0]).absolute())
+                self.xanes_recon_3D_dir_temp = str(
+                    Path(self.xanes_recon_3D_top_dir) / self.xanes_recon_dir_temp
+                )
+                self.xanes_recon_3D_tiff_temp = str(
+                    Path(self.xanes_recon_3D_top_dir)
+                    / self.xanes_recon_dir_temp
+                    / self.xanes_recon_fn_temp
                 )
 
-                self.hs["SelReconPath btn"].initialdir = os.path.abspath(
-                    a.files[0])
-                update_json_content(self.global_h.GUI_cfg_file,
-                                    {"cwd": os.path.abspath(a.files[0])})
-                self.global_h.cwd = os.path.os.path.abspath(a.files[0])
+                self.hs["SelReconPath btn"].initialdir = str(
+                    Path(a.files[0]).absolute()
+                )
+                update_json_content(
+                    self.global_h.GUI_cfg_file,
+                    {"cwd": str(Path(a.files[0]).absolute())},
+                )
+                self.global_h.cwd = str(Path(a.files[0]).absolute())
                 self.xanes_recon_path_set = True
             else:
-                self.hs[
-                    "SelReconPath text"].value = "Choose recon top directory ..."
+                self.hs["SelReconPath text"].value = "Choose recon top directory ..."
                 self.xanes_recon_path_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+            self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def SelSavTrial_btn_clk(self, a):
         if self.xanes_fit_option == "Do New Reg":
             if len(a.files[0]) != 0:
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
-                self.xanes_save_trial_reg_filename_template = (
-                    os.path.basename(os.path.abspath(a.files[0])).split(".")[0]
-                    + f'_{self.xanes_raw_fn_temp.split("_")[1]}' +
-                    "_id_{0}-{1}_" + b.strip("-") + ".h5")
-                self.xanes_save_trial_reg_config_filename_template = (
-                    os.path.basename(os.path.abspath(a.files[0])).split(".")[0]
-                    + f'_{self.xanes_raw_fn_temp.split("_")[1]}' +
-                    "_id_{0}-{1}_config_" + b.strip("-") + ".json")
-                self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSavTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
-                self.hs["ReadAlign btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_save_trial_reg_filename_template = (
+                #     os.path.basename(os.path.abspath(a.files[0])).split(".")[0]
+                #     + f'_{self.xanes_raw_fn_temp.split("_")[1]}'
+                #     + "_id_{0}-{1}_"
+                #     + b.strip("-")
+                #     + ".h5"
+                # )
+                # self.xanes_save_trial_reg_config_filename_template = (
+                #     os.path.basename(os.path.abspath(a.files[0])).split(".")[0]
+                #     + f'_{self.xanes_raw_fn_temp.split("_")[1]}'
+                #     + "_id_{0}-{1}_config_"
+                #     + b.strip("-")
+                #     + ".json"
+                # )
+                # self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # self.hs["SelSavTrial btn"].initialfile = os.path.basename(a.files[0])
+                # self.hs["ReadAlign btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
+                # self.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
+                b = datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                self.xanes_save_trial_reg_filename_template = str(
+                    Path(a.files[0]).stem
+                    + f'_{self.xanes_raw_fn_temp.split("_")[1]}'
+                    + "_id_{0}-{1}_"
+                    + b
+                    + ".h5"
+                )
+                self.xanes_save_trial_reg_config_filename_template = str(
+                    Path(a.files[0]).stem
+                    + f'_{self.xanes_raw_fn_temp.split("_")[1]}'
+                    + "_id_{0}-{1}_config_"
+                    + b
+                    + ".json"
+                )
+                self.hs["SelSavTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSavTrial btn"].initialfile = Path(a.files[0]).name
+                self.hs["ReadAlign btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).parent)},
                 )
-                self.global_h.cwd = os.path.dirname(os.path.abspath(
-                    a.files[0]))
+                self.global_h.cwd = str(Path(a.files[0]).absolute().parent)
                 self.xanes_save_trial_set = True
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = False
             else:
-                self.hs[
-                    "SelSavTrial text"].value = "Save trial registration as ..."
+                self.hs["SelSavTrial text"].value = "Save trial registration as ..."
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+            self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         elif self.xanes_fit_option == "Read Config File":
             if len(a.files[0]) != 0:
-                self.xanes_save_trial_reg_config_filename_original = os.path.abspath(
-                    a.files[0])
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_save_trial_reg_config_filename_original = os.path.abspath(
+                #     a.files[0]
+                # )
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_save_trial_reg_config_filename = (
+                #     os.path.abspath(a.files[0]).split("config")[0]
+                #     + "config_"
+                #     + b.strip("-")
+                #     + ".json"
+                # )
+                # self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # self.hs["SelSavTrial btn"].initialfile = os.path.basename(a.files[0])
+                # self.hs["ReadAlign btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
+                b = datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                self.xanes_save_trial_reg_config_filename_original = str(
+                    Path(a.files[0]).absolute()
+                )
+
                 self.xanes_save_trial_reg_config_filename = (
-                    os.path.abspath(a.files[0]).split("config")[0] +
-                    "config_" + b.strip("-") + ".json")
-                self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSavTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
-                self.hs["ReadAlign btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
+                    str(Path(a.files[0]).absolute()).split("config")[0]
+                    + "config_"
+                    + b
+                    + ".json"
+                )
+                self.hs["SelSavTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSavTrial btn"].initialfile = Path(a.files[0]).name
+                self.hs["ReadAlign btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = True
             else:
-                self.hs[
-                    "SelSavTrial text"].value = "Save Existing Configuration File ..."
+                self.hs["SelSavTrial text"].value = (
+                    "Save Existing Configuration File ..."
+                )
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+            self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         elif self.xanes_fit_option == "Reg By Shift":
             if len(a.files[0]) != 0:
-                self.xanes_save_trial_reg_config_filename_original = os.path.abspath(
-                    a.files[0])
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
+                self.xanes_save_trial_reg_config_filename_original = str(
+                    Path(a.files[0]).absolute()
+                )
+                b = datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
                 self.xanes_save_trial_reg_config_filename = (
-                    os.path.abspath(a.files[0]).split("config")[0] +
-                    "config_" + b.strip("-") + ".json")
-                self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSavTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
-                self.hs["ReadAlign btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
+                    str(Path(a.files[0]).absolute()).split("config")[0]
+                    + "config_"
+                    + b
+                    + ".json"
+                )
+                self.hs["SelSavTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSavTrial btn"].initialfile = Path(a.files[0]).name
+                self.hs["ReadAlign btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = True
             else:
-                self.hs[
-                    "SelSavTrial text"].value = "Save Existing Configuration File ..."
+                self.hs["SelSavTrial text"].value = (
+                    "Save Existing Configuration File ..."
+                )
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+            self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         elif self.xanes_fit_option == "Do Analysis":
             if len(a.files[0]) != 0:
-                self.xanes_save_trial_reg_filename = os.path.abspath(
-                    a.files[0])
-                b = ""
-                t = time.strptime(time.asctime())
-                for ii in range(6):
-                    b += str(t[ii]).zfill(2) + "-"
-                self.xanes_save_trial_reg_config_filename = (os.path.basename(
-                    os.path.abspath(a.files[0])).split(".")[0] + "_config_" +
-                                                             b.strip("-") +
-                                                             ".json")
-                self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
-                    os.path.abspath(a.files[0]))
-                self.hs["SelSavTrial btn"].initialfile = os.path.basename(
-                    a.files[0])
-                self.hs[
-                    "SelSavTrial text"].value = "Existing Registration File is Read ..."
+                # self.xanes_save_trial_reg_filename = os.path.abspath(a.files[0])
+                # b = ""
+                # t = time.strptime(time.asctime())
+                # for ii in range(6):
+                #     b += str(t[ii]).zfill(2) + "-"
+                # self.xanes_save_trial_reg_config_filename = (
+                #     os.path.basename(os.path.abspath(a.files[0])).split(".")[0]
+                #     + "_config_"
+                #     + b.strip("-")
+                #     + ".json"
+                # )
+                # self.hs["SelSavTrial btn"].initialdir = os.path.dirname(
+                #     os.path.abspath(a.files[0])
+                # )
+                # self.hs["SelSavTrial btn"].initialfile = os.path.basename(a.files[0])
+                # self.hs["SelSavTrial text"].value = (
+                #     "Existing Registration File is Read ..."
+                # )
+                # update_json_content(
+                #     self.global_h.GUI_cfg_file,
+                #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                # )
+                self.xanes_save_trial_reg_filename = str(Path(a.files[0]).absolute())
+                b = datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
+                self.xanes_save_trial_reg_config_filename = (
+                    Path(a.files[0]).stem + "_config_" + b + ".json"
+                )
+                self.hs["SelSavTrial btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
+                self.hs["SelSavTrial btn"].initialfile = Path(a.files[0]).name
+                self.hs["SelSavTrial text"].value = (
+                    "Existing Registration File is Read ..."
+                )
                 update_json_content(
                     self.global_h.GUI_cfg_file,
-                    {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+                    {"cwd": str(Path(a.files[0]).absolute().parent)},
                 )
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = True
                 self.xanes_config_file_set = False
             else:
-                self.hs[
-                    "SelSavTrial text"].value = "Read Existing Registration File ..."
+                self.hs["SelSavTrial text"].value = (
+                    "Read Existing Registration File ..."
+                )
                 self.xanes_save_trial_set = False
                 self.xanes_reg_file_set = False
                 self.xanes_config_file_set = False
             self.xanes_file_configured = False
-            self.hs[
-                "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+            self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def FilePathOptn_drpdn_chg(self, a):
         restart(self, dtype="3D_XANES")
         self.xanes_fit_option = a["owner"].value
         self.xanes_file_configured = False
         if self.xanes_fit_option == "Do New Reg":
             self.hs["SelRawH5Path btn"].disabled = False
             self.hs["SelReconPath btn"].disabled = False
             self.hs["SelSavTrial btn"].option = "asksaveasfilename"
             self.hs["SelSavTrial btn"].description = "Save Reg File"
-            self.hs[
-                "SelSavTrial text"].value = "Save trial registration as ..."
+            self.hs["SelSavTrial text"].value = "Save trial registration as ..."
             self.xanes_save_trial_set = False
             self.xanes_reg_file_set = False
             self.xanes_config_file_set = False
             self.hs["ReadAlign chbx"].value = False
         elif self.xanes_fit_option == "Read Config File":
             self.hs["SelRawH5Path btn"].disabled = True
             self.hs["SelReconPath btn"].disabled = True
             self.hs["SelSavTrial btn"].option = "askopenfilename"
             self.hs["SelSavTrial btn"].description = "Read Config"
             self.hs["SelSavTrial btn"].open_filetypes = (
                 ("json files", "*.json"),
                 ("text files", "*.txt"),
             )
-            self.hs[
-                "SelSavTrial text"].value = "Save Existing Configuration File ..."
+            self.hs["SelSavTrial text"].value = "Save Existing Configuration File ..."
             self.xanes_save_trial_set = False
             self.xanes_reg_file_set = False
             self.xanes_config_file_set = False
         elif self.xanes_fit_option == "Reg By Shift":
             self.hs["SelRawH5Path btn"].disabled = True
             self.hs["SelReconPath btn"].disabled = True
             self.hs["SelSavTrial btn"].option = "askopenfilename"
             self.hs["SelSavTrial btn"].description = "Read Config"
             self.hs["SelSavTrial btn"].open_filetypes = (
                 ("json files", "*.json"),
                 ("text files", "*.txt"),
             )
-            self.hs[
-                "SelSavTrial text"].value = "Save Existing Configuration File ..."
+            self.hs["SelSavTrial text"].value = "Save Existing Configuration File ..."
             self.xanes_save_trial_set = False
             self.xanes_reg_file_set = False
             self.xanes_config_file_set = False
         elif self.xanes_fit_option == "Do Analysis":
             self.hs["SelRawH5Path btn"].disabled = True
             self.hs["SelReconPath btn"].disabled = True
             self.hs["SelSavTrial btn"].option = "askopenfilename"
             self.hs["SelSavTrial btn"].description = "Do Analysis"
-            self.hs["SelSavTrial btn"].open_filetypes = (("h5 files",
-                                                          "*.h5"), )
-            self.hs[
-                "SelSavTrial text"].value = "Read Existing Registration File ..."
+            self.hs["SelSavTrial btn"].open_filetypes = (("h5 files", "*.h5"),)
+            self.hs["SelSavTrial text"].value = "Read Existing Registration File ..."
         self.hs["SelSavTrial btn"].icon = "square-o"
         self.hs["SelSavTrial btn"].style.button_color = "orange"
-        self.hs[
-            "SelFile&PathCfm text"].value = "Please comfirm your change ..."
+        self.hs["SelFile&PathCfm text"].value = "Please comfirm your change ..."
         self.boxes_logic()
 
     def SelFilePathCfm_btn_clk(self, a):
         if self.xanes_fit_option == "Do New Reg":
             if not self.xanes_raw_h5_path_set:
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specifiy raw h5 file location ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specifiy raw h5 file location ..."
+                )
                 self.xanes_file_configured = False
             elif not self.xanes_recon_path_set:
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specifiy recon top directory location ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specifiy recon top directory location ..."
+                )
                 self.xanes_file_configured = False
             elif not self.xanes_save_trial_set:
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specifiy where to save trial reg result ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specifiy where to save trial reg result ..."
+                )
                 self.xanes_file_configured = False
             else:
+                # b = glob.glob(
+                #     os.path.join(
+                #         self.xanes_raw_3D_h5_top_dir,
+                #         self.xanes_raw_3D_h5_temp.split("{")[0] + "*.h5",
+                #     )
+                # )
+                # ran = set(
+                #     [int(os.path.basename(ii).split(".")[0].split("_")[-1]) for ii in b]
+                # )
+                # b = glob.glob(
+                #     os.path.join(
+                #         self.xanes_recon_3D_top_dir,
+                #         self.xanes_recon_3D_dir_temp.split("{")[0] + "*",
+                #     )
+                # )
+                # ren = set(
+                #     [int(os.path.basename(ii).split(".")[0].split("_")[-1]) for ii in b]
+                # )
                 b = glob.glob(
-                    os.path.join(
-                        self.xanes_raw_3D_h5_top_dir,
-                        self.xanes_raw_3D_h5_temp.split("{")[0] + "*.h5",
-                    ))
-                ran = set([
-                    int(os.path.basename(ii).split(".")[0].split("_")[-1])
-                    for ii in b
-                ])
+                    str(
+                        Path(self.xanes_raw_3D_h5_top_dir)
+                        / (self.xanes_raw_3D_h5_temp.split("{")[0] + "*.h5")
+                    )
+                )
+                ran = set([int(Path(ii).name.split(".")[0].split("_")[-1]) for ii in b])
                 b = glob.glob(
-                    os.path.join(
-                        self.xanes_recon_3D_top_dir,
-                        self.xanes_recon_3D_dir_temp.split("{")[0] + "*",
-                    ))
-                ren = set([
-                    int(os.path.basename(ii).split(".")[0].split("_")[-1])
-                    for ii in b
-                ])
+                    str(
+                        Path(self.xanes_recon_3D_top_dir)
+                        / (self.xanes_recon_3D_dir_temp.split("{")[0] + "*")
+                    )
+                )
+                ren = set([int(Path(ii).stem.split("_")[-1]) for ii in b])
                 n = sorted(list(ran & ren))
 
                 if n:
                     # self.xanes_available_recon_ids = self.xanes_available_raw_ids = n
                     self.xanes_available_raw_ids = n
-                    self.hs[
-                        "SelScanIdStart drpdn"].options = self.xanes_available_raw_ids
-                    self.hs[
-                        "SelScanIdStart drpdn"].value = self.xanes_available_raw_ids[
-                            0]
-                    self.hs[
-                        "SelScanIdEnd drpdn"].options = self.xanes_available_raw_ids
-                    self.hs[
-                        "SelScanIdEnd drpdn"].value = self.xanes_available_raw_ids[
-                            -1]
-                    self.hs[
-                        "FixedScanId drpdn"].options = self.xanes_available_raw_ids
-                    self.hs[
-                        "FixedScanId drpdn"].value = self.xanes_available_raw_ids[
-                            0]
+                    self.hs["SelScanIdStart drpdn"].options = (
+                        self.xanes_available_raw_ids
+                    )
+                    self.hs["SelScanIdStart drpdn"].value = (
+                        self.xanes_available_raw_ids[0]
+                    )
+                    self.hs["SelScanIdEnd drpdn"].options = self.xanes_available_raw_ids
+                    self.hs["SelScanIdEnd drpdn"].value = self.xanes_available_raw_ids[
+                        -1
+                    ]
+                    self.hs["FixedScanId drpdn"].options = self.xanes_available_raw_ids
+                    self.hs["FixedScanId drpdn"].value = self.xanes_available_raw_ids[0]
                     self.xanes_scan_id_s = 0
-                    self.xanes_scan_id_e = len(
-                        self.xanes_available_raw_ids) - 1
+                    self.xanes_scan_id_e = len(self.xanes_available_raw_ids) - 1
 
                     self.xanes_fixed_scan_id = self.xanes_available_raw_ids[0]
                     self.xanes_fixed_sli_id = self.hs["FixedSliId sldr"].value
-                    self.hs[
-                        "SelFile&PathCfm text"].value = "XANES3D file config is done ..."
+                    self.hs["SelFile&PathCfm text"].value = (
+                        "XANES3D file config is done ..."
+                    )
                     self.xanes_file_configured = True
                 else:
-                    self.hs[
-                        "SelFile&PathCfm text"].value = "No valid datasets (both raw and recon data) in the directory..."
+                    self.hs["SelFile&PathCfm text"].value = (
+                        "No valid datasets (both raw and recon data) in the directory..."
+                    )
                     self.xanes_file_configured = False
         elif self.xanes_fit_option == "Read Config File":
             if not self.xanes_config_file_set:
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specifiy where to read the configuration file ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specifiy where to read the configuration file ..."
+                )
                 self.xanes_file_configured = False
             else:
                 self.read_xanes3D_config()
                 self.set_xanes3D_variables()
                 if self.xanes_roi_configured:
-                    self.xanes_img_roi = np.ndarray([
-                        self.xanes_roi[5] - self.xanes_roi[4] + 1,
-                        self.xanes_roi[1] - self.xanes_roi[0],
-                        self.xanes_roi[3] - self.xanes_roi[2],
-                    ])
-                    self.xanes_reg_mask = np.ndarray([
-                        self.xanes_roi[1] - self.xanes_roi[0],
-                        self.xanes_roi[3] - self.xanes_roi[2],
-                    ])
+                    self.xanes_img_roi = np.ndarray(
+                        [
+                            self.xanes_roi[5] - self.xanes_roi[4] + 1,
+                            self.xanes_roi[1] - self.xanes_roi[0],
+                            self.xanes_roi[3] - self.xanes_roi[2],
+                        ]
+                    )
+                    self.xanes_reg_mask = np.ndarray(
+                        [
+                            self.xanes_roi[1] - self.xanes_roi[0],
+                            self.xanes_roi[3] - self.xanes_roi[2],
+                        ]
+                    )
 
                 if self.xanes_reg_done:
-                    with h5py.File(self.xanes_save_trial_reg_filename,
-                                   "r") as f:
+                    with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                         self.trial_reg = f[
-                            "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                            .format("000")][:]
+                            "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                                "000"
+                            )
+                        ][:]
                         self.trial_reg_fixed = f[
-                            "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}"
-                            .format("000")][:]
+                            "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".format(
+                                "000"
+                            )
+                        ][:]
                         self.xanes_review_aligned_img = np.ndarray(
-                            self.trial_reg[0].shape)
+                            self.trial_reg[0].shape
+                        )
                 self.xanes_recon_path_set = True
                 self.xanes_fit_option = "Read Config File"
 
-                self.xanes_reg_best_match_filename = (os.path.splitext(
-                    self.xanes_save_trial_reg_config_filename)[0].replace(
-                        "config", "reg_best_match") + ".json")
+                self.xanes_reg_best_match_filename = str(
+                    Path(self.xanes_save_trial_reg_config_filename).parent
+                    / (
+                        Path(self.xanes_save_trial_reg_config_filename).stem.replace(
+                            "config", "reg_best_match"
+                        )
+                        + ".json"
+                    )
+                )
                 self.xanes_file_configured = True
 
+                # self.xanes_eng_list = self.reader(
+                #     os.path.join(self.xanes_raw_3D_h5_top_dir, self.xanes_raw_fn_temp),
+                #     self.xanes_available_raw_ids[
+                #         self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+                #     ],
+                #     dtype="eng",
+                #     cfg=self.global_h.io_xanes3D_cfg,
+                # )
                 self.xanes_eng_list = self.reader(
-                    os.path.join(self.xanes_raw_3D_h5_top_dir,
-                                 self.xanes_raw_fn_temp),
-                    self.xanes_available_raw_ids[self.xanes_scan_id_s:self.
-                                                 xanes_scan_id_e + 1],
+                    str(Path(self.xanes_raw_3D_h5_top_dir) / self.xanes_raw_fn_temp),
+                    self.xanes_available_raw_ids[
+                        self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+                    ],
                     dtype="eng",
                     cfg=self.global_h.io_xanes3D_cfg,
                 )
                 if self.xanes_eng_list.max() < 70:
                     self.xanes_eng_list *= 1000
 
                 if self.xanes_alignment_done:
-                    with h5py.File(self.xanes_save_trial_reg_filename,
-                                   "r") as f:
+                    with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                         self.xanes_fit_data_shape = f[
-                            "/registration_results/reg_results/registered_xanes3D"].shape
+                            "/registration_results/reg_results/registered_xanes3D"
+                        ].shape
                         self.xanes_fit_eng_list = f[
-                            "/trial_registration/trial_reg_parameters/eng_list"][:]
+                            "/trial_registration/trial_reg_parameters/eng_list"
+                        ][:]
                         self.xanes_scan_id_s = f[
-                            "/trial_registration/trial_reg_parameters/scan_ids"][
-                                0]
+                            "/trial_registration/trial_reg_parameters/scan_ids"
+                        ][0]
                         self.xanes_scan_id_e = f[
-                            "/trial_registration/trial_reg_parameters/scan_ids"][
-                                -1]
+                            "/trial_registration/trial_reg_parameters/scan_ids"
+                        ][-1]
                         self.xanes_aligned_data = f[
-                            "/registration_results/reg_results/registered_xanes3D"][
-                                0, :, :, :]
-                    self.xanes_reg_best_match_filename = (os.path.splitext(
-                        self.xanes_save_trial_reg_config_filename)[0].replace(
-                            "config", "reg_best_match") + ".json")
-                    self.xanes_element = determine_element(
-                        self.xanes_fit_eng_list)
+                            "/registration_results/reg_results/registered_xanes3D"
+                        ][0, :, :, :]
+                    # self.xanes_reg_best_match_filename = (
+                    #     os.path.splitext(self.xanes_save_trial_reg_config_filename)[
+                    #         0
+                    #     ].replace("config", "reg_best_match")
+                    #     + ".json"
+                    # )
+                    self.xanes_reg_best_match_filename = str(
+                        Path(self.xanes_save_trial_reg_config_filename).parent
+                        / (
+                            Path(
+                                self.xanes_save_trial_reg_config_filename
+                            ).stem.replace("config", "reg_best_match")
+                            + ".json"
+                        )
+                    )
+                    self.xanes_element = determine_element(self.xanes_fit_eng_list)
                     tem = determine_fitting_energy_range(self.xanes_element)
                     self.xanes_fit_edge_eng = tem[0]
                     self.xanes_fit_wl_fit_eng_s = tem[1]
                     self.xanes_fit_wl_fit_eng_e = tem[2]
                     self.xanes_fit_pre_edge_e = tem[3]
                     self.xanes_fit_post_edge_s = tem[4]
                     self.xanes_fit_edge_0p5_fit_s = tem[5]
                     self.xanes_fit_edge_0p5_fit_e = tem[6]
 
                     self.hs["VisImgViewAlignSli sldr"].value = 1
                     self.hs["VisImgViewAlign4thDim sldr"].value = 0
                     self.hs["VisImgViewAlignOptn drpdn"].value = "x-y-E"
                     self.hs["VisImgViewAlignSli sldr"].description = "E"
-                    self.hs[
-                        "VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                            0]
+                    self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
+                        0
+                    ]
                     self.hs["VisImgViewAlignSli sldr"].min = 1
                     self.hs["VisImgViewAlign4thDim sldr"].description = "z"
                     self.hs["VisImgViewAlign4thDim sldr"].max = (
-                        self.xanes_fit_data_shape[1] - 1)
+                        self.xanes_fit_data_shape[1] - 1
+                    )
                     self.hs["VisImgViewAlign4thDim sldr"].min = 0
-                    self.hs[
-                        "SelFile&PathCfm text"].value = "XANES3D file config is done ..."
+                    self.hs["SelFile&PathCfm text"].value = (
+                        "XANES3D file config is done ..."
+                    )
                     self.xanes_fit_type = "full"
-                    self.xanes_fit_gui_h.hs[
-                        "FitEngRagOptn drpdn"].value = "full"
+                    self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
 
                 self.set_xanes3D_handles()
                 self.set_xanes3D_variables()
                 self.xanes_fit_option = "Read Config File"
                 fiji_viewer_off(self.global_h, self, viewer_name="all")
-                self.hs[
-                    "SelFile&PathCfm text"].value = "XANES3D file config is done ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "XANES3D file config is done ..."
+                )
         elif self.xanes_fit_option == "Reg By Shift":
             if not self.xanes_config_file_set:
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specifiy where to read the configuration file ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specifiy where to read the configuration file ..."
+                )
                 self.xanes_file_configured = False
             else:
                 self.read_xanes3D_config()
                 self.set_xanes3D_variables()
                 if self.xanes_reg_review_done:
                     if self.xanes_roi_configured:
-                        self.xanes_img_roi = np.ndarray([
-                            self.xanes_roi[5] - self.xanes_roi[4] + 1,
-                            self.xanes_roi[1] - self.xanes_roi[0],
-                            self.xanes_roi[3] - self.xanes_roi[2],
-                        ])
-                        self.xanes_reg_mask = np.ndarray([
-                            self.xanes_roi[1] - self.xanes_roi[0],
-                            self.xanes_roi[3] - self.xanes_roi[2],
-                        ])
+                        self.xanes_img_roi = np.ndarray(
+                            [
+                                self.xanes_roi[5] - self.xanes_roi[4] + 1,
+                                self.xanes_roi[1] - self.xanes_roi[0],
+                                self.xanes_roi[3] - self.xanes_roi[2],
+                            ]
+                        )
+                        self.xanes_reg_mask = np.ndarray(
+                            [
+                                self.xanes_roi[1] - self.xanes_roi[0],
+                                self.xanes_roi[3] - self.xanes_roi[2],
+                            ]
+                        )
 
                     if self.xanes_reg_done:
-                        with h5py.File(self.xanes_save_trial_reg_filename,
-                                       "r") as f:
+                        with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                             self.trial_reg = f[
-                                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                                .format("000")][:]
+                                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                                    "000"
+                                )
+                            ][:]
                             self.trial_reg_fixed = f[
-                                "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}"
-                                .format("000")][:]
+                                "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".format(
+                                    "000"
+                                )
+                            ][:]
                             self.xanes_review_aligned_img = np.ndarray(
-                                self.trial_reg[0].shape)
+                                self.trial_reg[0].shape
+                            )
                     self.xanes_recon_path_set = True
                     self.xanes_fit_option = "Read Config File"
 
-                    self.xanes_reg_best_match_filename = (os.path.splitext(
-                        self.xanes_save_trial_reg_config_filename)[0].replace(
-                            "config", "reg_best_match") + ".json")
+                    # self.xanes_reg_best_match_filename = (
+                    #     os.path.splitext(self.xanes_save_trial_reg_config_filename)[
+                    #         0
+                    #     ].replace("config", "reg_best_match")
+                    #     + ".json"
+                    # )
+                    self.xanes_reg_best_match_filename = str(
+                        Path(self.xanes_save_trial_reg_config_filename).parent
+                        / (
+                            Path(
+                                self.xanes_save_trial_reg_config_filename
+                            ).stem.replace("config", "reg_best_match")
+                            + ".json"
+                        )
+                    )
                     self.xanes_file_configured = True
 
+                    # self.xanes_eng_list = self.reader(
+                    #     os.path.join(
+                    #         self.xanes_raw_3D_h5_top_dir, self.xanes_raw_fn_temp
+                    #     ),
+                    #     self.xanes_available_raw_ids[
+                    #         self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+                    #     ],
+                    #     dtype="eng",
+                    #     cfg=self.global_h.io_xanes3D_cfg,
+                    # )
                     self.xanes_eng_list = self.reader(
-                        os.path.join(self.xanes_raw_3D_h5_top_dir,
-                                     self.xanes_raw_fn_temp),
-                        self.xanes_available_raw_ids[self.xanes_scan_id_s:self.
-                                                     xanes_scan_id_e + 1],
+                        str(
+                            Path(self.xanes_raw_3D_h5_top_dir) / self.xanes_raw_fn_temp
+                        ),
+                        self.xanes_available_raw_ids[
+                            self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+                        ],
                         dtype="eng",
                         cfg=self.global_h.io_xanes3D_cfg,
                     )
                     if self.xanes_eng_list.max() < 70:
                         self.xanes_eng_list *= 1000
 
                     self.set_xanes3D_handles()
                     self.set_xanes3D_variables()
                     self.xanes_fit_option = "Reg By Shift"
                     self.xanes_roi_configured = False
                     self.xanes_reg_review_done = False
                     self.xanes_alignment_done = False
                     self.xanes_fit_option = "Reg By Shift"
                     fiji_viewer_off(self.global_h, self, viewer_name="all")
-                    self.hs[
-                        "SelFile&PathCfm text"].value = "XANES3D file config is done ..."
+                    self.hs["SelFile&PathCfm text"].value = (
+                        "XANES3D file config is done ..."
+                    )
                 else:
                     self.hs["SelFile&PathCfm text"].value = (
                         "To use this option, a config up to reg review is needed ..."
                     )
         elif self.xanes_fit_option == "Do Analysis":
             if not self.xanes_reg_file_set:
-                self.hs[
-                    "SelFile&PathCfm text"].value = "Please specifiy where to read the aligned data ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "Please specifiy where to read the aligned data ..."
+                )
                 self.xanes_file_configured = False
                 self.xanes_indices_configured = False
                 self.xanes_roi_configured = False
                 self.xanes_reg_params_configured = False
                 self.xanes_reg_done = False
                 self.xanes_alignment_done = False
             else:
@@ -3122,367 +3169,412 @@
                 self.xanes_indices_configured = False
                 self.xanes_roi_configured = False
                 self.xanes_reg_params_configured = False
                 self.xanes_reg_done = False
                 self.xanes_alignment_done = True
                 with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                     self.xanes_fit_data_shape = f[
-                        "/registration_results/reg_results/registered_xanes3D"].shape
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ].shape
                     self.xanes_fit_eng_list = f[
-                        "/trial_registration/trial_reg_parameters/eng_list"][:]
+                        "/trial_registration/trial_reg_parameters/eng_list"
+                    ][:]
                     self.xanes_scan_id_s = f[
-                        "/trial_registration/trial_reg_parameters/scan_ids"][0]
+                        "/trial_registration/trial_reg_parameters/scan_ids"
+                    ][0]
                     self.xanes_scan_id_e = f[
-                        "/trial_registration/trial_reg_parameters/scan_ids"][
-                            -1]
+                        "/trial_registration/trial_reg_parameters/scan_ids"
+                    ][-1]
                     self.xanes_fixed_scan_id = f[
-                        "/trial_registration/trial_reg_parameters/fixed_scan_id"][
-                            ()]
+                        "/trial_registration/trial_reg_parameters/fixed_scan_id"
+                    ][()]
                     self.xanes_fixed_sli_id = f[
-                        "/trial_registration/trial_reg_parameters/fixed_slice"][
-                            ()]
+                        "/trial_registration/trial_reg_parameters/fixed_slice"
+                    ][()]
                     self.xanes_aligned_data = f[
-                        "/registration_results/reg_results/registered_xanes3D"][
-                            0, :, :, :]
-                self.xanes_reg_best_match_filename = (os.path.splitext(
-                    self.xanes_save_trial_reg_config_filename)[0].replace(
-                        "config", "reg_best_match") + ".json")
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ][0, :, :, :]
+                # self.xanes_reg_best_match_filename = (
+                #     os.path.splitext(self.xanes_save_trial_reg_config_filename)[
+                #         0
+                #     ].replace("config", "reg_best_match")
+                #     + ".json"
+                # )
+                self.xanes_reg_best_match_filename = str(
+                    Path(self.xanes_save_trial_reg_config_filename).parent
+                    / (
+                        Path(self.xanes_save_trial_reg_config_filename).stem.replace(
+                            "config", "reg_best_match"
+                        )
+                        + ".json"
+                    )
+                )
                 self.xanes_element = determine_element(self.xanes_fit_eng_list)
                 tem = determine_fitting_energy_range(self.xanes_element)
                 self.xanes_fit_edge_eng = tem[0]
                 self.xanes_fit_wl_fit_eng_s = tem[1]
                 self.xanes_fit_wl_fit_eng_e = tem[2]
                 self.xanes_fit_pre_edge_e = tem[3]
                 self.xanes_fit_post_edge_s = tem[4]
                 self.xanes_fit_edge_0p5_fit_s = tem[5]
                 self.xanes_fit_edge_0p5_fit_e = tem[6]
 
                 self.hs["VisImgViewAlignSli sldr"].value = 1
                 self.hs["VisImgViewAlign4thDim sldr"].value = 0
                 self.hs["VisImgViewAlignOptn drpdn"].value = "x-y-E"
                 self.hs["VisImgViewAlignSli sldr"].description = "E"
-                self.hs[
-                    "VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                        0]
+                self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[0]
                 self.hs["VisImgViewAlignSli sldr"].min = 1
                 self.hs["VisImgViewAlign4thDim sldr"].description = "z"
                 self.hs["VisImgViewAlign4thDim sldr"].max = (
-                    self.xanes_fit_data_shape[1] - 1)
+                    self.xanes_fit_data_shape[1] - 1
+                )
                 self.hs["VisImgViewAlign4thDim sldr"].min = 0
-                self.hs[
-                    "SelFile&PathCfm text"].value = "XANES3D file config is done ..."
+                self.hs["SelFile&PathCfm text"].value = (
+                    "XANES3D file config is done ..."
+                )
                 self.xanes_fit_type = "full"
                 self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
         self.boxes_logic()
 
     def SelScanIdStart_drpdn_chg(self, a):
-        self.xanes_scan_id_s = self.xanes_available_raw_ids.index(
-            a["owner"].value)
+        self.xanes_scan_id_s = self.xanes_available_raw_ids.index(a["owner"].value)
         self.hs["SelScanIdEnd drpdn"].options = self.xanes_available_raw_ids[
-            self.xanes_scan_id_s:]
-        self.hs["SelScanIdEnd drpdn"].value = self.hs[
-            "SelScanIdEnd drpdn"].options[-1]
-        self.hs["FixedScanId drpdn"].options = self.hs[
-            "SelScanIdEnd drpdn"].options
-        self.hs["FixedScanId drpdn"].value = self.hs[
-            "FixedScanId drpdn"].options[0]
+            self.xanes_scan_id_s :
+        ]
+        self.hs["SelScanIdEnd drpdn"].value = self.hs["SelScanIdEnd drpdn"].options[-1]
+        self.hs["FixedScanId drpdn"].options = self.hs["SelScanIdEnd drpdn"].options
+        self.hs["FixedScanId drpdn"].value = self.hs["FixedScanId drpdn"].options[0]
         self.xanes_scan_id_set = True
         self.hs["ConfigDataCfm text"].value = "scan_id_s are changed ..."
         self.xanes_indices_configured = False
         self.boxes_logic()
 
     def SelScanIdEnd_drpdn_chg(self, a):
-        self.xanes_scan_id_e = self.xanes_available_raw_ids.index(
-            a["owner"].value)
+        self.xanes_scan_id_e = self.xanes_available_raw_ids.index(a["owner"].value)
         self.hs["FixedScanId drpdn"].options = self.xanes_available_raw_ids[
-            self.xanes_scan_id_s:self.xanes_scan_id_e + 1]
-        self.hs["FixedScanId drpdn"].value = self.hs[
-            "FixedScanId drpdn"].options[0]
+            self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+        ]
+        self.hs["FixedScanId drpdn"].value = self.hs["FixedScanId drpdn"].options[0]
         self.xanes_indices_configured = False
         self.boxes_logic()
 
     def FixedScanId_drpdn_chg(self, a):
-        self.xanes_fixed_scan_id = self.xanes_available_raw_ids.index(
-            a["owner"].value)
+        self.xanes_fixed_scan_id = self.xanes_available_raw_ids.index(a["owner"].value)
+        # b = glob.glob(
+        #     os.path.join(
+        #         self.xanes_recon_3D_dir_temp.format(a["owner"].value),
+        #         self.xanes_recon_fn_temp.format(a["owner"].value, "*"),
+        #     )
+        # )
+        # self.xanes_available_sli_file_ids = sorted(
+        #     [int(os.path.basename(ii).split(".")[0].split("_")[-1]) for ii in b]
+        # )
         b = glob.glob(
-            os.path.join(
-                self.xanes_recon_3D_dir_temp.format(a["owner"].value),
-                self.xanes_recon_fn_temp.format(a["owner"].value, "*"),
-            ))
-        self.xanes_available_sli_file_ids = sorted([
-            int(os.path.basename(ii).split(".")[0].split("_")[-1]) for ii in b
-        ])
-
-        if self.hs["FixedSliId sldr"].value in (
-                self.xanes_available_sli_file_ids):
-            self.hs["FixedSliId sldr"].max = max(
-                self.xanes_available_sli_file_ids)
-            self.hs["FixedSliId sldr"].min = min(
-                self.xanes_available_sli_file_ids)
+            str(
+                Path(self.xanes_recon_3D_dir_temp.format(a["owner"].value))
+                / self.xanes_recon_fn_temp.format(a["owner"].value, "*")
+            )
+        )
+        self.xanes_available_sli_file_ids = sorted(
+            [int(Path(ii).stem.split("_")[-1]) for ii in b]
+        )
+
+        if self.hs["FixedSliId sldr"].value in (self.xanes_available_sli_file_ids):
+            self.hs["FixedSliId sldr"].max = max(self.xanes_available_sli_file_ids)
+            self.hs["FixedSliId sldr"].min = min(self.xanes_available_sli_file_ids)
         else:
-            self.hs["FixedSliId sldr"].max = max(
-                self.xanes_available_sli_file_ids)
-            self.hs["FixedSliId sldr"].value = min(
-                self.xanes_available_sli_file_ids)
-            self.hs["FixedSliId sldr"].min = min(
-                self.xanes_available_sli_file_ids)
+            self.hs["FixedSliId sldr"].max = max(self.xanes_available_sli_file_ids)
+            self.hs["FixedSliId sldr"].value = min(self.xanes_available_sli_file_ids)
+            self.hs["FixedSliId sldr"].min = min(self.xanes_available_sli_file_ids)
 
         if self.hs["FijiRawImgPrev chbx"].value:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
         self.xanes_indices_configured = False
         self.boxes_logic()
 
     def FixedSliId_sldr_chg(self, a):
         if self.hs["FijiRawImgPrev chbx"].value:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h,
-                self,
-                viewer_name="xanes3D_virtural_stack_preview_viewer")
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
             if viewer_state:
                 self.global_h.xanes3D_fiji_windows[
-                    "xanes3D_virtural_stack_preview_viewer"]["ip"].setSlice(
-                        a["owner"].value - a["owner"].min + 1)
+                    "xanes3D_virtural_stack_preview_viewer"
+                ]["ip"].setSlice(a["owner"].value - a["owner"].min + 1)
                 self.xanes_fixed_sli_id = a["owner"].value
-                self.hs[
-                    "ConfigDataCfm text"].value = "fixed slice id is changed ..."
+                self.hs["ConfigDataCfm text"].value = "fixed slice id is changed ..."
             else:
-                self.hs[
-                    "ConfigDataCfm text"].value = "Please turn on fiji previewer first ..."
+                self.hs["ConfigDataCfm text"].value = (
+                    "Please turn on fiji previewer first ..."
+                )
         self.xanes_indices_configured = False
 
     def FijiRawImgPrev_chbx_chg(self, a):
         if a["owner"].value:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h,
-                self,
-                viewer_name="xanes3D_virtural_stack_preview_viewer")
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
             if viewer_state:
                 self.global_h.xanes3D_fiji_windows[
-                    "xanes3D_virtural_stack_preview_viewer"]["ip"].close()
+                    "xanes3D_virtural_stack_preview_viewer"
+                ]["ip"].close()
                 self.global_h.xanes3D_fiji_windows[
-                    "xanes3D_virtural_stack_preview_viewer"]["ip"] = None
+                    "xanes3D_virtural_stack_preview_viewer"
+                ]["ip"] = None
                 self.global_h.xanes3D_fiji_windows[
-                    "xanes3D_virtural_stack_preview_viewer"]["fiji_id"] = None
+                    "xanes3D_virtural_stack_preview_viewer"
+                ]["fiji_id"] = None
             self.xanes_indices_configured = False
             self.boxes_logic()
 
     def FijiClose_btn_clk(self, a):
         if self.hs["FijiRawImgPrev chbx"].value:
             self.hs["FijiRawImgPrev chbx"].value = False
         if self.hs["FijiMaskViewer chbx"].value:
             self.hs["FijiMaskViewer chbx"].value = False
         try:
             for ii in self.global_h.WindowManager.getIDList():
                 self.global_h.WindowManager.getImage(ii).close()
         except:
             pass
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"] = None
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["fiji_id"] = None
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ] = None
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "fiji_id"
+        ] = None
         self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"] = None
-        self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-            "fiji_id"] = None
-        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"] = None
-        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "fiji_id"] = None
-        self.global_h.xanes3D_fiji_windows["analysis_viewer_z_plot_viewer"][
-            "ip"] = None
+        self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["fiji_id"] = None
+        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"]["ip"] = None
+        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"]["fiji_id"] = None
+        self.global_h.xanes3D_fiji_windows["analysis_viewer_z_plot_viewer"]["ip"] = None
         self.global_h.xanes3D_fiji_windows["analysis_viewer_z_plot_viewer"][
-            "fiji_id"] = None
+            "fiji_id"
+        ] = None
         self.xanes_indices_configured = False
         self.boxes_logic()
 
     def ConfigDataCfm_btn_clk(self, a):
         if self.xanes_fit_option == "Do New Reg":
-            self.xanes_save_trial_reg_filename = os.path.join(
-                self.xanes_raw_3D_h5_top_dir,
-                self.xanes_save_trial_reg_filename_template.format(
+            # self.xanes_save_trial_reg_filename = os.path.join(
+            #     self.xanes_raw_3D_h5_top_dir,
+            #     self.xanes_save_trial_reg_filename_template.format(
+            #         self.xanes_available_raw_ids[self.xanes_scan_id_s],
+            #         self.xanes_available_raw_ids[self.xanes_scan_id_e],
+            #     ),
+            # )
+            # self.xanes_save_trial_reg_config_filename = os.path.join(
+            #     self.xanes_raw_3D_h5_top_dir,
+            #     self.xanes_save_trial_reg_config_filename_template.format(
+            #         self.xanes_available_raw_ids[self.xanes_scan_id_s],
+            #         self.xanes_available_raw_ids[self.xanes_scan_id_e],
+            #     ),
+            # )
+            # self.xanes_reg_best_match_filename = (
+            #     os.path.splitext(self.xanes_save_trial_reg_config_filename)[0].replace(
+            #         "config", "reg_best_match"
+            #     )
+            #     + ".json"
+            # )
+            self.xanes_save_trial_reg_filename = str(
+                Path(self.xanes_raw_3D_h5_top_dir)
+                / self.xanes_save_trial_reg_filename_template.format(
                     self.xanes_available_raw_ids[self.xanes_scan_id_s],
                     self.xanes_available_raw_ids[self.xanes_scan_id_e],
-                ),
+                )
             )
-            self.xanes_save_trial_reg_config_filename = os.path.join(
-                self.xanes_raw_3D_h5_top_dir,
-                self.xanes_save_trial_reg_config_filename_template.format(
+            self.xanes_save_trial_reg_config_filename = str(
+                Path(self.xanes_raw_3D_h5_top_dir)
+                / self.xanes_save_trial_reg_config_filename_template.format(
                     self.xanes_available_raw_ids[self.xanes_scan_id_s],
                     self.xanes_available_raw_ids[self.xanes_scan_id_e],
                 ),
             )
-            self.xanes_reg_best_match_filename = (os.path.splitext(
-                self.xanes_save_trial_reg_config_filename)[0].replace(
-                    "config", "reg_best_match") + ".json")
+            self.xanes_reg_best_match_filename = str(
+                Path(self.xanes_save_trial_reg_config_filename).parent
+                / (
+                    Path(self.xanes_save_trial_reg_config_filename).stem.replace(
+                        "config", "reg_best_match"
+                    )
+                    + ".json"
+                )
+            )
         if not self.xanes_indices_configured:
             self.hs["3DRoiX sldr"].max = self.global_h.xanes3D_fiji_windows[
-                "xanes3D_virtural_stack_preview_viewer"]["ip"].getWidth()
+                "xanes3D_virtural_stack_preview_viewer"
+            ]["ip"].getWidth()
             self.hs["3DRoiX sldr"].min = 0
             self.hs["3DRoiY sldr"].max = self.global_h.xanes3D_fiji_windows[
-                "xanes3D_virtural_stack_preview_viewer"]["ip"].getHeight()
+                "xanes3D_virtural_stack_preview_viewer"
+            ]["ip"].getHeight()
             self.hs["3DRoiY sldr"].min = 0
             self.hs["3DRoiZ sldr"].max = self.hs["FixedSliId sldr"].max
             self.hs["3DRoiZ sldr"].min = self.hs["FixedSliId sldr"].min
 
             self.hs["3DRoiZ sldr"].upper = self.hs["FixedSliId sldr"].max
             self.hs["3DRoiZ sldr"].lower = self.hs["FixedSliId sldr"].min
 
             self.xanes_scan_id_s = self.xanes_available_raw_ids.index(
-                self.hs["SelScanIdStart drpdn"].value)
+                self.hs["SelScanIdStart drpdn"].value
+            )
             self.xanes_scan_id_e = self.xanes_available_raw_ids.index(
-                self.hs["SelScanIdEnd drpdn"].value)
+                self.hs["SelScanIdEnd drpdn"].value
+            )
             self.xanes_fixed_scan_id = self.xanes_available_raw_ids.index(
-                self.hs["FixedScanId drpdn"].value)
+                self.hs["FixedScanId drpdn"].value
+            )
             # self.xanes_fixed_scan_id = self.hs['FixedScanId drpdn'].value
             self.xanes_fixed_sli_id = self.hs["FixedSliId sldr"].value
-            self.hs[
-                "ConfigDataCfm text"].value = "Indices configuration is done ..."
+            self.hs["ConfigDataCfm text"].value = "Indices configuration is done ..."
             self.hs["3DRoiCfm text"].value = "Please confirm after ROI is set"
-            self.hs[
-                "RegPair sldr"].max = self.xanes_scan_id_e - self.xanes_scan_id_s
+            self.hs["RegPair sldr"].max = self.xanes_scan_id_e - self.xanes_scan_id_s
             self.xanes_indices_configured = True
             self.update_xanes3D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
+            # self.xanes_eng_list = self.reader(
+            #     os.path.join(self.xanes_raw_3D_h5_top_dir, self.xanes_raw_fn_temp),
+            #     self.xanes_available_raw_ids[
+            #         self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+            #     ],
+            #     dtype="eng",
+            #     cfg=self.global_h.io_xanes3D_cfg,
+            # )
             self.xanes_eng_list = self.reader(
-                os.path.join(self.xanes_raw_3D_h5_top_dir,
-                             self.xanes_raw_fn_temp),
-                self.xanes_available_raw_ids[self.xanes_scan_id_s:self.
-                                             xanes_scan_id_e + 1],
+                str(Path(self.xanes_raw_3D_h5_top_dir) / self.xanes_raw_fn_temp),
+                self.xanes_available_raw_ids[
+                    self.xanes_scan_id_s : self.xanes_scan_id_e + 1
+                ],
                 dtype="eng",
                 cfg=self.global_h.io_xanes3D_cfg,
             )
             if self.xanes_eng_list.max() < 70:
                 self.xanes_eng_list *= 1000
         self.boxes_logic()
 
     def RoiX3D_sldr_chg(self, a):
         self.xanes_roi_configured = False
         self.boxes_logic()
         self.hs["3DRoiCfm text"].value = "Please confirm after ROI is set"
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h,
-            self,
-            viewer_name="xanes3D_virtural_stack_preview_viewer")
+            self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"].setRoi(
-                self.hs["3DRoiX sldr"].value[0],
-                self.hs["3DRoiY sldr"].value[0],
-                self.hs["3DRoiX sldr"].value[1] -
-                self.hs["3DRoiX sldr"].value[0],
-                self.hs["3DRoiY sldr"].value[1] -
-                self.hs["3DRoiY sldr"].value[0],
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
             )
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ].setRoi(
+            self.hs["3DRoiX sldr"].value[0],
+            self.hs["3DRoiY sldr"].value[0],
+            self.hs["3DRoiX sldr"].value[1] - self.hs["3DRoiX sldr"].value[0],
+            self.hs["3DRoiY sldr"].value[1] - self.hs["3DRoiY sldr"].value[0],
+        )
 
     def RoiY3D_sldr_chg(self, a):
         self.xanes_roi_configured = False
         self.boxes_logic()
         self.hs["3DRoiCfm text"].value = "Please confirm after ROI is set"
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h,
-            self,
-            viewer_name="xanes3D_virtural_stack_preview_viewer")
+            self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"].setRoi(
-                self.hs["3DRoiX sldr"].value[0],
-                self.hs["3DRoiY sldr"].value[0],
-                self.hs["3DRoiX sldr"].value[1] -
-                self.hs["3DRoiX sldr"].value[0],
-                self.hs["3DRoiY sldr"].value[1] -
-                self.hs["3DRoiY sldr"].value[0],
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
             )
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ].setRoi(
+            self.hs["3DRoiX sldr"].value[0],
+            self.hs["3DRoiY sldr"].value[0],
+            self.hs["3DRoiX sldr"].value[1] - self.hs["3DRoiX sldr"].value[0],
+            self.hs["3DRoiY sldr"].value[1] - self.hs["3DRoiY sldr"].value[0],
+        )
 
     def RoiZ3D_val_sldr_chg(self, a):
         self.xanes_roi_configured = False
         if a["owner"].upper < self.xanes_fixed_sli_id:
             a["owner"].upper = self.xanes_fixed_sli_id
         if a["owner"].lower > self.xanes_fixed_sli_id:
             a["owner"].lower = self.xanes_fixed_sli_id
         a["owner"].mylower = a["owner"].lower
         a["owner"].myupper = a["owner"].upper
         self.hs["3DRoiCfm text"].value = "Please confirm after ROI is set"
 
     def RoiZ3D_lwr_sldr_chg(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h,
-            self,
-            viewer_name="xanes3D_virtural_stack_preview_viewer")
+            self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"].setSlice(
-                self.hs["3DRoiZ sldr"].value[0] - self.hs["3DRoiZ sldr"].min +
-                1)
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ].setSlice(self.hs["3DRoiZ sldr"].value[0] - self.hs["3DRoiZ sldr"].min + 1)
         self.boxes_logic()
 
     def RoiZ3D_upr_sldr_chg(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h,
-            self,
-            viewer_name="xanes3D_virtural_stack_preview_viewer")
+            self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"].setSlice(
-                self.hs["3DRoiZ sldr"].value[1] - self.hs["3DRoiZ sldr"].min +
-                1)
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ].setSlice(self.hs["3DRoiZ sldr"].value[1] - self.hs["3DRoiZ sldr"].min + 1)
         self.boxes_logic()
 
     def Roi3DCfm_btn_clk(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h,
-            self,
-            viewer_name="xanes3D_virtural_stack_preview_viewer")
+            self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+        )
         if viewer_state:
             fiji_viewer_off(
-                self.global_h,
-                self,
-                viewer_name="xanes3D_virtural_stack_preview_viewer")
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+            )
         self.hs["FijiRawImgPrev chbx"].value = False
         self.xanes_indices_configured = True
 
         if not self.xanes_roi_configured:
             self.xanes_roi = [
                 self.hs["3DRoiY sldr"].value[0],
                 self.hs["3DRoiY sldr"].value[1],
                 self.hs["3DRoiX sldr"].value[0],
                 self.hs["3DRoiX sldr"].value[1],
                 self.hs["3DRoiZ sldr"].value[0],
                 self.hs["3DRoiZ sldr"].value[1],
             ]
 
-            self.xanes_img_roi = np.ndarray([
-                self.xanes_roi[5] - self.xanes_roi[4] + 1,
-                self.xanes_roi[1] - self.xanes_roi[0],
-                self.xanes_roi[3] - self.xanes_roi[2],
-            ])
-            self.xanes_reg_mask = np.ndarray([
-                self.xanes_roi[1] - self.xanes_roi[0],
-                self.xanes_roi[3] - self.xanes_roi[2],
-            ])
+            self.xanes_img_roi = np.ndarray(
+                [
+                    self.xanes_roi[5] - self.xanes_roi[4] + 1,
+                    self.xanes_roi[1] - self.xanes_roi[0],
+                    self.xanes_roi[3] - self.xanes_roi[2],
+                ]
+            )
+            self.xanes_reg_mask = np.ndarray(
+                [
+                    self.xanes_roi[1] - self.xanes_roi[0],
+                    self.xanes_roi[3] - self.xanes_roi[2],
+                ]
+            )
 
             self.hs["3DRoiCfm text"].value = "ROI configuration is done ..."
             self.hs["SliSrch sldr"].max = min(
                 abs(self.hs["3DRoiZ sldr"].value[1] - self.xanes_fixed_sli_id),
                 abs(self.hs["3DRoiZ sldr"].value[0] - self.xanes_fixed_sli_id),
             )
             self.xanes_roi_configured = True
@@ -3492,27 +3584,22 @@
             open(self.xanes_save_trial_reg_config_filename, "w"),
             cls=NumpyArrayEncoder,
         )
         self.boxes_logic()
 
     def FijiMaskViewer_chbx_chg(self, a):
         if a["owner"].value:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_mask_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes3D_mask_viewer")
         else:
             try:
-                self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                    "ip"].close()
+                self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"].close()
             except:
                 pass
-            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                "ip"] = None
-            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                "fiji_id"] = None
+            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"] = None
+            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["fiji_id"] = None
         self.boxes_logic()
 
     def ChunkSz_chbx_chg(self, a):
         self.xanes_reg_params_configured = False
         if a["owner"].value:
             self.xanes_reg_use_chunk = True
         else:
@@ -3528,91 +3615,111 @@
         self.boxes_logic()
 
     def MaskThres_sldr_chg(self, a):
         if self.xanes_reg_use_mask:
             self.xanes_reg_params_configured = False
             self.xanes_reg_mask_thres = a["owner"].value
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes3D_mask_viewer")
+                self.global_h, self, viewer_name="xanes3D_mask_viewer"
+            )
             if (not data_state) | (not viewer_state):
                 self.hs["FijiMaskViewer chbx"].value = False
                 self.hs["FijiMaskViewer chbx"].value = True
 
             if self.xanes_reg_mask_dilation_width == 0:
                 self.xanes_reg_mask[:] = (
-                    self.xanes_img_roi[self.xanes_fixed_sli_id -
-                                       self.xanes_roi[4]] >
-                    self.xanes_reg_mask_thres).astype(np.uint8)[:]
+                    self.xanes_img_roi[self.xanes_fixed_sli_id - self.xanes_roi[4]]
+                    > self.xanes_reg_mask_thres
+                ).astype(np.uint8)[:]
             else:
                 self.xanes_reg_mask[:] = skm.binary_dilation(
-                    (self.xanes_img_roi[self.xanes_fixed_sli_id -
-                                        self.xanes_roi[4]] >
-                     self.xanes_reg_mask_thres).astype(np.uint8),
-                    np.ones([
-                        self.xanes_reg_mask_dilation_width,
-                        self.xanes_reg_mask_dilation_width,
-                    ]),
+                    (
+                        self.xanes_img_roi[self.xanes_fixed_sli_id - self.xanes_roi[4]]
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.uint8),
+                    np.ones(
+                        [
+                            self.xanes_reg_mask_dilation_width,
+                            self.xanes_reg_mask_dilation_width,
+                        ]
+                    ),
                 ).astype(np.uint8)[:]
-            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                "ip"].setImage(self.global_h.ij.convert().convert(
+            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
-                        self.global_h.ij.py.to_java(self.xanes_img_roi *
-                                                    self.xanes_reg_mask)),
+                        self.global_h.ij.py.to_java(
+                            self.xanes_img_roi * self.xanes_reg_mask
+                        )
+                    ),
                     self.global_h.ImagePlusClass,
-                ))
-            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                "ip"].setSlice(self.xanes_fixed_sli_id - self.xanes_roi[4])
+                )
+            )
+            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"].setSlice(
+                self.xanes_fixed_sli_id - self.xanes_roi[4]
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
 
     def MaskDilation_sldr_chg(self, a):
         if self.xanes_reg_use_mask:
             self.xanes_reg_params_configured = False
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name="xanes3D_mask_viewer")
+                self.global_h, self, viewer_name="xanes3D_mask_viewer"
+            )
             if (not data_state) | (not viewer_state):
                 self.hs["FijiMaskViewer chbx"].value = False
                 self.hs["FijiMaskViewer chbx"].value = True
             self.xanes_reg_mask_dilation_width = a["owner"].value
             if self.xanes_reg_mask_dilation_width == 0:
                 self.xanes_reg_mask[:] = (
-                    self.xanes_img_roi[self.xanes_fixed_sli_id -
-                                       self.xanes_roi[4]] >
-                    self.xanes_reg_mask_thres).astype(np.uint8)[:]
+                    self.xanes_img_roi[self.xanes_fixed_sli_id - self.xanes_roi[4]]
+                    > self.xanes_reg_mask_thres
+                ).astype(np.uint8)[:]
             else:
                 self.xanes_reg_mask[:] = skm.binary_dilation(
-                    (self.xanes_img_roi[self.xanes_fixed_sli_id -
-                                        self.xanes_roi[4]] >
-                     self.xanes_reg_mask_thres).astype(np.uint8),
-                    np.ones([
-                        self.xanes_reg_mask_dilation_width,
-                        self.xanes_reg_mask_dilation_width,
-                    ]),
+                    (
+                        self.xanes_img_roi[self.xanes_fixed_sli_id - self.xanes_roi[4]]
+                        > self.xanes_reg_mask_thres
+                    ).astype(np.uint8),
+                    np.ones(
+                        [
+                            self.xanes_reg_mask_dilation_width,
+                            self.xanes_reg_mask_dilation_width,
+                        ]
+                    ),
                 ).astype(np.uint8)[:]
-            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                "ip"].setImage(self.global_h.ij.convert().convert(
+            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
-                        self.global_h.ij.py.to_java(self.xanes_img_roi *
-                                                    self.xanes_reg_mask)),
+                        self.global_h.ij.py.to_java(
+                            self.xanes_img_roi * self.xanes_reg_mask
+                        )
+                    ),
                     self.global_h.ImagePlusClass,
-                ))
-            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-                "ip"].setSlice(self.xanes_fixed_sli_id - self.xanes_roi[4])
+                )
+            )
+            self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"].setSlice(
+                self.xanes_fixed_sli_id - self.xanes_roi[4]
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
 
     def SliSrch_sldr_chg(self, a):
         self.xanes_reg_params_configured = False
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes3D_mask_viewer")
+            self.global_h, self, viewer_name="xanes3D_mask_viewer"
+        )
         if (not data_state) | (not viewer_state):
             self.hs["FijiMaskViewer chbx"].value = False
             self.hs["FijiMaskViewer chbx"].value = True
-        self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"][
-            "ip"].setSlice(a["owner"].value)
+        self.global_h.xanes3D_fiji_windows["xanes3D_mask_viewer"]["ip"].setSlice(
+            a["owner"].value
+        )
 
     def ChunkSz_sldr_chg(self, a):
         self.xanes_reg_params_configured = False
         self.boxes_logic()
 
     def RegMethod_drpdn_chg(self, a):
         self.xanes_reg_params_configured = False
@@ -3654,52 +3761,54 @@
         self.xanes_reg_method = self.hs["RegMethod drpdn"].value
         self.xanes_reg_ref_mode = self.hs["RefMode drpdn"].value
         self.xanes_reg_mask_dilation_width = self.hs["MaskDilation sldr"].value
         self.xanes_reg_mask_thres = self.hs["MaskThres sldr"].value
         self.xanes_reg_mrtv_level = self.hs["MRTVLevel text"].value
         self.xanes_reg_mrtv_width = self.hs["MRTVWz text"].value
         self.xanes_reg_mrtv_subpixel_wz = self.hs["MRTVSubpixelWz text"].value
-        self.xanes_reg_mrtv_subpixel_kernel = self.hs[
-            "MRTVSubpixelKernel text"].value
+        self.xanes_reg_mrtv_subpixel_kernel = self.hs["MRTVSubpixelKernel text"].value
         if self.hs["MRTVSubpixelSrch drpdn"].value == "analytical":
             self.xanes_reg_mrtv_subpixel_srch_option = "ana"
         else:
             self.xanes_reg_mrtv_subpixel_srch_option = "fit"
 
         self.xanes_reg_params_configured = self.hs["ChunkSz chbx"].value
-        self.hs[
-            "ConfigRegParamsCfm text"].value = "registration parameters are set ..."
+        self.hs["ConfigRegParamsCfm text"].value = "registration parameters are set ..."
         self.xanes_reg_params_configured = True
         self.update_xanes3D_config()
         json.dump(
             self.xanes_config,
             open(self.xanes_save_trial_reg_config_filename, "w"),
             cls=NumpyArrayEncoder,
         )
         self.boxes_logic()
 
     def RunRegCfm_btn_clk(self, a):
-        tmp_file = os.path.join(self.global_h.tmp_dir, "xanes3D_tmp.h5")
+        # tmp_file = os.path.join(self.global_h.tmp_dir, "xanes3D_tmp.h5")
+        tmp_file = str(Path(self.global_h.tmp_dir) / "xanes3D_tmp.h5")
         with h5py.File(tmp_file, "w") as f:
-            f.create_dataset("analysis_eng_list",
-                             data=self.xanes_eng_list.astype(np.float32))
+            f.create_dataset(
+                "analysis_eng_list", data=self.xanes_eng_list.astype(np.float32)
+            )
             if self.xanes_reg_mask is not None:
-                f.create_dataset("xanes3D_reg_mask",
-                                 data=self.xanes_reg_mask.astype(np.float32))
+                f.create_dataset(
+                    "xanes3D_reg_mask", data=self.xanes_reg_mask.astype(np.float32)
+                )
             else:
                 f.create_dataset("xanes3D_reg_mask", data=np.array([0]))
         code = {}
         ln = 0
 
         code[ln] = f"import os"
         ln += 1
         code[ln] = f"from TXM_Sandbox.utils import xanes_regtools as xr"
         ln += 1
-        code[
-            ln] = f"reg = xr.regtools(dtype='3D_XANES', method='{self.xanes_reg_method}', mode='TRANSLATION')"
+        code[ln] = (
+            f"reg = xr.regtools(dtype='3D_XANES', method='{self.xanes_reg_method}', mode='TRANSLATION')"
+        )
         ln += 1
         code[ln] = f"from multiprocessing import freeze_support"
         ln += 1
         code[ln] = f"if __name__ == '__main__':"
         ln += 1
         code[ln] = f"    freeze_support()"
         ln += 1
@@ -3713,155 +3822,192 @@
         ln += 1
         code[ln] = f"    reg.set_ref_mode('{self.xanes_reg_ref_mode}')"
         ln += 1
         code[ln] = f"    reg.set_xanes3D_tmp_filename('{tmp_file}')"
         ln += 1
         code[ln] = f"    reg.read_xanes3D_tmp_file()"
         ln += 1
-        code[
-            ln] = f"    reg.set_xanes3D_raw_h5_top_dir('{self.xanes_raw_3D_h5_top_dir}')"
+        code[ln] = (
+            f"    reg.set_xanes3D_raw_h5_top_dir('{self.xanes_raw_3D_h5_top_dir}')"
+        )
         ln += 1
-        code[
-            ln] = f"    reg.set_indices(0, {self.xanes_scan_id_e-self.xanes_scan_id_s+1}, {self.xanes_fixed_scan_id-self.xanes_scan_id_s})"
+        code[ln] = (
+            f"    reg.set_indices(0, {self.xanes_scan_id_e-self.xanes_scan_id_s+1}, {self.xanes_fixed_scan_id-self.xanes_scan_id_s})"
+        )
         ln += 1
-        code[
-            ln] = f"    reg.set_xanes3D_scan_ids({self.xanes_available_raw_ids[self.xanes_scan_id_s:self.xanes_scan_id_e+1]})"
+        code[ln] = (
+            f"    reg.set_xanes3D_scan_ids({self.xanes_available_raw_ids[self.xanes_scan_id_s:self.xanes_scan_id_e+1]})"
+        )
         ln += 1
-        code[
-            ln] = f"    reg.set_reg_options(use_mask={self.xanes_reg_use_mask}, mask_thres={self.xanes_reg_mask_thres},\
+        code[ln] = (
+            f"    reg.set_reg_options(use_mask={self.xanes_reg_use_mask}, mask_thres={self.xanes_reg_mask_thres},\
                      use_chunk={self.xanes_reg_use_chunk}, chunk_sz={self.xanes_reg_chunk_sz},\
                      use_smooth_img={self.xanes_reg_use_smooth_img}, smooth_sigma={self.xanes_reg_smooth_sigma},\
                      mrtv_level={self.xanes_reg_mrtv_level}, mrtv_width={self.xanes_reg_mrtv_width}, \
                      mrtv_sp_wz={self.xanes_reg_mrtv_subpixel_wz}, mrtv_sp_kernel={self.xanes_reg_mrtv_subpixel_kernel})"
+        )
 
         ln += 1
         code[ln] = f"    reg.set_roi({self.xanes_roi})"
         ln += 1
-        code[
-            ln] = f"    reg.set_xanes3D_recon_path_template('{self.xanes_recon_3D_tiff_temp}')"
+        code[ln] = (
+            f"    reg.set_xanes3D_recon_path_template('{self.xanes_recon_3D_tiff_temp}')"
+        )
         ln += 1
-        code[
-            ln] = f"    reg.set_saving(os.path.dirname('{self.xanes_save_trial_reg_filename}'), \
-                     fn=os.path.basename('{self.xanes_save_trial_reg_filename}'))"
+        # code[ln] = (
+        #     f"    reg.set_saving(os.path.dirname('{self.xanes_save_trial_reg_filename}'), \
+        #              fn=os.path.basename('{self.xanes_save_trial_reg_filename}'))"
+        # )
+        code[ln] = (
+            f"    reg.set_saving('{str(Path(self.xanes_save_trial_reg_filename).parent)}', \
+                     fn='{Path(self.xanes_save_trial_reg_filename).name}')"
+        )
 
         ln += 1
-        code[
-            ln] = f"    reg.xanes3D_sli_search_half_range = {self.xanes_reg_sli_search_half_width}"
+        code[ln] = (
+            f"    reg.xanes3D_sli_search_half_range = {self.xanes_reg_sli_search_half_width}"
+        )
         ln += 1
-        code[
-            ln] = f"    reg.xanes3D_recon_fixed_sli = {self.xanes_fixed_sli_id}"
+        code[ln] = f"    reg.xanes3D_recon_fixed_sli = {self.xanes_fixed_sli_id}"
         ln += 1
         code[ln] = f"    reg.compose_dicts()"
         ln += 1
         code[ln] = f"    reg.reg_xanes3D_chunk()"
         ln += 1
 
         gen_external_py_script(self.xanes_reg_external_command_name, code)
         sig = os.system(f"python {self.xanes_reg_external_command_name}")
 
         print(sig)
         if sig == 0:
             with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
-                self.trial_reg = np.ndarray(f[
-                    "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}"
-                    .format(str(0).zfill(3))].shape)
-                self.trial_reg_fixed = np.ndarray(f[
-                    "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}"
-                    .format(str(0).zfill(3))].shape)
+                self.trial_reg = np.ndarray(
+                    f[
+                        "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                            str(0).zfill(3)
+                        )
+                    ].shape
+                )
+                self.trial_reg_fixed = np.ndarray(
+                    f[
+                        "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".format(
+                            str(0).zfill(3)
+                        )
+                    ].shape
+                )
                 self.xanes_alignment_pairs = f[
-                    "/trial_registration/trial_reg_parameters/alignment_pairs"][:]
-                self.hs["RegPair sldr"].max = self.xanes_alignment_pairs.shape[
-                    0] - 1
+                    "/trial_registration/trial_reg_parameters/alignment_pairs"
+                ][:]
+                self.hs["RegPair sldr"].max = self.xanes_alignment_pairs.shape[0] - 1
                 self.hs["RegPair sldr"].min = 0
-            self.hs[
-                "CorrZShift text"].max = self.xanes_reg_sli_search_half_width * 2
+            self.hs["CorrZShift text"].max = self.xanes_reg_sli_search_half_width * 2
 
             self.xanes_review_aligned_img = np.ndarray(self.trial_reg[0].shape)
             self.xanes_review_shift_dict = {}
             self.xanes_review_bad_shift = False
             self.xanes_reg_done = True
-            self.xanes_reg_best_match_filename = (os.path.splitext(
-                self.xanes_save_trial_reg_config_filename)[0].replace(
-                    "config", "reg_best_match") + ".json")
+            self.xanes_reg_best_match_filename = str(
+                Path(self.xanes_save_trial_reg_config_filename).parent
+                / (
+                    Path(self.xanes_save_trial_reg_config_filename).stem.replace(
+                        "config", "reg_best_match"
+                    )
+                    + ".json"
+                )
+            )
             self.update_xanes3D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
             self.hs["RunRegCfm text"].value = "XANES3D registration is done"
         else:
-            self.hs[
-                "RunRegCfm text"].value = "Something went wrong during XANES3D registration"
+            self.hs["RunRegCfm text"].value = (
+                "Something went wrong during XANES3D registration"
+            )
         self.boxes_logic()
 
     def ReadAlign_chbx_chg(self, a):
         self.xanes_use_existing_reg_reviewed = a["owner"].value
         self.xanes_reg_review_done = False
         self.boxes_logic()
 
     def ReadAlign_btn_clk(self, a):
         if len(a.files[0]) != 0:
             try:
-                self.xanes_reg_review_file = os.path.abspath(a.files[0])
-                if os.path.splitext(self.xanes_reg_review_file)[1] == ".json":
+                # self.xanes_reg_review_file = os.path.abspath(a.files[0])
+                # if os.path.splitext(self.xanes_reg_review_file)[1] == ".json":
+                #     self.xanes_review_shift_dict = json.load(
+                #         open(self.xanes_reg_review_file, "r")
+                #     )
+                self.xanes_reg_review_file = str(Path(a.files[0]).absolute())
+                if Path(self.xanes_reg_review_file).suffix == ".json":
                     self.xanes_review_shift_dict = json.load(
-                        open(self.xanes_reg_review_file, "r"))
+                        open(self.xanes_reg_review_file, "r")
+                    )
                 else:
                     self.xanes_review_shift_dict = np.float32(
-                        np.genfromtxt(self.xanes_reg_review_file))
+                        np.genfromtxt(self.xanes_reg_review_file)
+                    )
                 for ii in self.xanes_review_shift_dict:
                     self.xanes_review_shift_dict[ii] = np.float32(
-                        np.array(self.xanes_review_shift_dict[ii]))
+                        np.array(self.xanes_review_shift_dict[ii])
+                    )
                 self.xanes_reg_file_readed = True
             except:
                 self.xanes_reg_file_readed = False
         else:
             self.xanes_reg_file_readed = False
         self.boxes_logic()
 
     def RegPair_sldr_chg(self, a):
         self.xanes_alignment_pair_id = a["owner"].value
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             self.trial_reg[:] = f[
-                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".
-                format(str(self.xanes_alignment_pair_id).zfill(3))][:]
+                "/trial_registration/trial_reg_results/{0}/trial_reg_img{0}".format(
+                    str(self.xanes_alignment_pair_id).zfill(3)
+                )
+            ][:]
             self.trial_reg_fixed[:] = f[
-                "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".
-                format(str(self.xanes_alignment_pair_id).zfill(3))][:]
+                "/trial_registration/trial_reg_results/{0}/trial_fixed_img{0}".format(
+                    str(self.xanes_alignment_pair_id).zfill(3)
+                )
+            ][:]
             shift = f[
                 "/trial_registration/trial_reg_results/{0}/shift{0}".format(
-                    str(self.xanes_alignment_pair_id).zfill(3))][:]
+                    str(self.xanes_alignment_pair_id).zfill(3)
+                )
+            ][:]
             if self.xanes_reg_method == "MRTV":
                 best_match = f[
-                    "/trial_registration/trial_reg_results/{0}/mrtv_best_shift_id{0}"
-                    .format(str(self.xanes_alignment_pair_id).zfill(3))][()]
+                    "/trial_registration/trial_reg_results/{0}/mrtv_best_shift_id{0}".format(
+                        str(self.xanes_alignment_pair_id).zfill(3)
+                    )
+                ][()]
             else:
                 best_match = 0
 
-        self.xanes_review_shift_dict[str(
-            self.xanes_alignment_pair_id)] = np.array([
+        self.xanes_review_shift_dict[str(self.xanes_alignment_pair_id)] = np.array(
+            [
                 best_match - self.xanes_reg_sli_search_half_width,
                 shift[best_match][0],
                 shift[best_match][1],
-            ])
-        fiji_viewer_off(self.global_h,
-                        self,
-                        viewer_name="xanes3D_review_viewer")
+            ]
+        )
+        fiji_viewer_off(self.global_h, self, viewer_name="xanes3D_review_viewer")
         self.global_h.ij.py.run_macro("""call("java.lang.System.gc")""")
-        fiji_viewer_on(self.global_h,
-                       self,
-                       viewer_name="xanes3D_review_viewer")
-        self.global_h.xanes3D_fiji_windows["xanes3D_review_viewer"][
-            "ip"].setTitle("reg pair: " +
-                           str(self.xanes_alignment_pair_id).zfill(3))
-        self.global_h.xanes3D_fiji_windows["xanes3D_review_viewer"][
-            "ip"].setSlice(best_match + 1)
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+        fiji_viewer_on(self.global_h, self, viewer_name="xanes3D_review_viewer")
+        self.global_h.xanes3D_fiji_windows["xanes3D_review_viewer"]["ip"].setTitle(
+            "reg pair: " + str(self.xanes_alignment_pair_id).zfill(3)
+        )
+        self.global_h.xanes3D_fiji_windows["xanes3D_review_viewer"]["ip"].setSlice(
+            best_match + 1
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
         self.hs["RevRegRltCfm text"].value = str(self.xanes_review_shift_dict)
         json.dump(
             self.xanes_review_shift_dict,
             open(self.xanes_reg_best_match_filename, "w"),
             cls=NumpyArrayEncoder,
         )
@@ -3870,139 +4016,154 @@
         self.xanes_reg_review_done = False
 
     def RegPairBad_btn_clk(self, a):
         self.xanes_review_bad_shift = True
         self.xanes_manual_xshift = 0
         self.xanes_manual_yshift = 0
         self.xanes_manual_zshift = self.global_h.xanes3D_fiji_windows[
-            "xanes3D_review_viewer"]["ip"].getCurrentSlice()
-        fiji_viewer_on(self.global_h,
-                       self,
-                       viewer_name="xanes3D_review_manual_viewer")
+            "xanes3D_review_viewer"
+        ]["ip"].getCurrentSlice()
+        fiji_viewer_on(self.global_h, self, viewer_name="xanes3D_review_manual_viewer")
         self.hs["CorrZShift text"].value = self.xanes_manual_zshift
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
         self.xanes_reg_review_done = False
         self.boxes_logic()
 
     def CorrXShift_text_chg(self, a):
         self.xanes_manual_xshift = self.hs["CorrXShift text"].value
         self.xanes_manual_yshift = self.hs["CorrYShift text"].value
         self.xanes_manual_zshift = self.hs["CorrZShift text"].value
         xanes3D_review_aligned_img = np.real(
             np.fft.ifftn(
                 fourier_shift(
                     np.fft.fftn(self.trial_reg[self.xanes_manual_zshift - 1]),
                     [self.xanes_manual_yshift, self.xanes_manual_xshift],
-                )))
+                )
+            )
+        )
 
         self.global_h.xanes3D_fiji_windows["xanes3D_review_manual_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+            "ip"
+        ].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(xanes3D_review_aligned_img -
-                                                self.trial_reg_fixed)),
+                    self.global_h.ij.py.to_java(
+                        xanes3D_review_aligned_img - self.trial_reg_fixed
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
     def CorrYShift_text_chg(self, a):
         self.xanes_manual_xshift = self.hs["CorrXShift text"].value
         self.xanes_manual_yshift = self.hs["CorrYShift text"].value
         self.xanes_manual_zshift = self.hs["CorrZShift text"].value
         xanes3D_review_aligned_img = np.real(
             np.fft.ifftn(
                 fourier_shift(
                     np.fft.fftn(self.trial_reg[self.xanes_manual_zshift - 1]),
                     [self.xanes_manual_yshift, self.xanes_manual_xshift],
-                )))
+                )
+            )
+        )
 
         self.global_h.xanes3D_fiji_windows["xanes3D_review_manual_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+            "ip"
+        ].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(xanes3D_review_aligned_img -
-                                                self.trial_reg_fixed)),
+                    self.global_h.ij.py.to_java(
+                        xanes3D_review_aligned_img - self.trial_reg_fixed
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
     def CorrZShift_text_chg(self, a):
         self.xanes_manual_xshift = self.hs["CorrXShift text"].value
         self.xanes_manual_yshift = self.hs["CorrYShift text"].value
         self.xanes_manual_zshift = self.hs["CorrZShift text"].value
         xanes3D_review_aligned_img = np.real(
             np.fft.ifftn(
                 fourier_shift(
                     np.fft.fftn(self.trial_reg[self.xanes_manual_zshift - 1]),
                     [self.xanes_manual_yshift, self.xanes_manual_xshift],
-                )))
+                )
+            )
+        )
 
         self.global_h.xanes3D_fiji_windows["xanes3D_review_manual_viewer"][
-            "ip"].setImage(self.global_h.ij.convert().convert(
+            "ip"
+        ].setImage(
+            self.global_h.ij.convert().convert(
                 self.global_h.ij.dataset().create(
-                    self.global_h.ij.py.to_java(xanes3D_review_aligned_img -
-                                                self.trial_reg_fixed)),
+                    self.global_h.ij.py.to_java(
+                        xanes3D_review_aligned_img - self.trial_reg_fixed
+                    )
+                ),
                 self.global_h.ImagePlusClass,
-            ))
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+            )
+        )
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
     def CorrShftRecord_btn_clk(self, a):
         """
         temporarily this wont work with SR for now.
         """
         self.xanes_review_bad_shift = False
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             shift = f[
                 "/trial_registration/trial_reg_results/{0}/shift{0}".format(
-                    str(self.xanes_alignment_pair_id).zfill(3))][:]
+                    str(self.xanes_alignment_pair_id).zfill(3)
+                )
+            ][:]
         best_match = self.xanes_manual_zshift - 1
-        self.xanes_review_shift_dict["{}".format(
-            self.xanes_alignment_pair_id)] = np.array([
-                best_match - self.xanes_reg_sli_search_half_width,
-                self.xanes_manual_yshift + shift[best_match, 0],
-                self.xanes_manual_xshift + shift[best_match, 1],
-            ])
+        self.xanes_review_shift_dict["{}".format(self.xanes_alignment_pair_id)] = (
+            np.array(
+                [
+                    best_match - self.xanes_reg_sli_search_half_width,
+                    self.xanes_manual_yshift + shift[best_match, 0],
+                    self.xanes_manual_xshift + shift[best_match, 1],
+                ]
+            )
+        )
         self.hs["CorrXShift text"].value = 0
         self.hs["CorrYShift text"].value = 0
         self.hs["CorrZShift text"].value = 1
-        fiji_viewer_off(self.global_h,
-                        self,
-                        viewer_name="xanes3D_review_manual_viewer")
+        fiji_viewer_off(self.global_h, self, viewer_name="xanes3D_review_manual_viewer")
         json.dump(
             self.xanes_review_shift_dict,
             open(self.xanes_reg_best_match_filename, "w"),
             cls=NumpyArrayEncoder,
         )
         self.xanes_reg_review_done = False
         self.boxes_logic()
 
     def RevRegRltCfm_btn_clk(self, a):
-        if len(self.xanes_review_shift_dict) != (self.hs["RegPair sldr"].max +
-                                                 1):
-            self.hs[
-                "RevRegRltCfm text"].value = "reg review is not completed yet ..."
+        if len(self.xanes_review_shift_dict) != (self.hs["RegPair sldr"].max + 1):
+            self.hs["RevRegRltCfm text"].value = "reg review is not completed yet ..."
             idx = []
             offset = []
             for ii in sorted(self.xanes_review_shift_dict.keys()):
                 offset.append(self.xanes_review_shift_dict[ii][0])
                 idx.append(int(ii))
             plt.figure(1)
             plt.plot(idx, offset, "b+")
             plt.xticks(np.arange(0, len(idx) + 1, 5))
             plt.grid()
             self.xanes_reg_review_done = False
         else:
-            fiji_viewer_off(self.global_h,
-                            self,
-                            viewer_name="xanes3D_review_manual_viewer")
-            fiji_viewer_off(self.global_h,
-                            self,
-                            viewer_name="xanes3D_review_viewer")
+            fiji_viewer_off(
+                self.global_h, self, viewer_name="xanes3D_review_manual_viewer"
+            )
+            fiji_viewer_off(self.global_h, self, viewer_name="xanes3D_review_viewer")
             self.hs["RevRegRltCfm text"].value = "reg review is done ..."
             self.xanes_reg_review_done = True
             self.update_xanes3D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
@@ -4032,31 +4193,31 @@
         else:
             a["owner"].value = self.hs["AlignReconOptnSliRange sldr"].lower
 
     def AlignReconOptnSliRange_sldr_chg(self, a):
         self.hs["AlignReconOptnSliStart text"].value = a["owner"].lower
         self.hs["AlignReconOptnSliEnd text"].value = a["owner"].upper
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h,
-            self,
-            viewer_name="xanes3D_virtural_stack_preview_viewer")
+            self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
+        )
         if (not data_state) | (not viewer_state):
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_virtural_stack_preview_viewer")
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"].setSlice(
-                a["owner"].lower - a["owner"].min + 1)
-        self.global_h.xanes3D_fiji_windows[
-            "xanes3D_virtural_stack_preview_viewer"]["ip"].setRoi(
-                int(self.xanes_roi[2]),
-                int(self.xanes_roi[0]),
-                int(self.xanes_roi[3] - self.xanes_roi[2]),
-                int(self.xanes_roi[1] - self.xanes_roi[0]),
+            fiji_viewer_on(
+                self.global_h, self, viewer_name="xanes3D_virtural_stack_preview_viewer"
             )
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ].setSlice(a["owner"].lower - a["owner"].min + 1)
+        self.global_h.xanes3D_fiji_windows["xanes3D_virtural_stack_preview_viewer"][
+            "ip"
+        ].setRoi(
+            int(self.xanes_roi[2]),
+            int(self.xanes_roi[0]),
+            int(self.xanes_roi[3] - self.xanes_roi[2]),
+            int(self.xanes_roi[1] - self.xanes_roi[0]),
+        )
 
     def AlignReconCfm_btn_clk(self, a):
         if self.hs["AlignReconOptnSli chbx"].value:
             self.xanes_roi[4] = self.hs["AlignReconOptnSliRange sldr"].lower
             self.xanes_roi[5] = self.hs["AlignReconOptnSliRange sldr"].upper
         tmp_dict = {}
         for key in self.xanes_review_shift_dict.keys():
@@ -4064,46 +4225,51 @@
 
         code = {}
         ln = 0
         code[ln] = "import TXM_Sandbox.utils.xanes_regtools as xr"
         ln += 1
         code[ln] = "reg = xr.regtools(dtype='3D_XANES', mode='TRANSLATION')"
         ln += 1
-        code[
-            ln] = f"reg.set_xanes3D_recon_path_template('{self.xanes_recon_3D_tiff_temp}')"
+        code[ln] = (
+            f"reg.set_xanes3D_recon_path_template('{self.xanes_recon_3D_tiff_temp}')"
+        )
         ln += 1
         code[ln] = f"reg.set_roi({self.xanes_roi})"
         ln += 1
-        code[
-            ln] = f"reg.apply_xanes3D_chunk_shift({tmp_dict}, {self.xanes_roi[4]}, {self.xanes_roi[5]}, trialfn='{self.xanes_save_trial_reg_filename}', savefn='{self.xanes_save_trial_reg_filename}')"
+        code[ln] = (
+            f"reg.apply_xanes3D_chunk_shift({tmp_dict}, {self.xanes_roi[4]}, {self.xanes_roi[5]}, trialfn='{self.xanes_save_trial_reg_filename}', savefn='{self.xanes_save_trial_reg_filename}')"
+        )
         ln += 1
 
         gen_external_py_script(self.xanes_align_external_command_name, code)
         sig = os.system(f"python '{self.xanes_align_external_command_name}'")
         if sig == 0:
-            self.hs[
-                "AlignReconCfm text"].value = "XANES3D alignment is done ..."
+            self.hs["AlignReconCfm text"].value = "XANES3D alignment is done ..."
             self.update_xanes3D_config()
             json.dump(
                 self.xanes_config,
                 open(self.xanes_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
             )
             self.boxes_logic()
             self.xanes_alignment_done = True
 
             with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                 self.xanes_fit_data_shape = f[
-                    "/registration_results/reg_results/registered_xanes3D"].shape
+                    "/registration_results/reg_results/registered_xanes3D"
+                ].shape
                 self.xanes_fit_eng_list = f[
-                    "/trial_registration/trial_reg_parameters/eng_list"][:]
+                    "/trial_registration/trial_reg_parameters/eng_list"
+                ][:]
                 self.xanes_scan_id_s = f[
-                    "/trial_registration/trial_reg_parameters/scan_ids"][0]
+                    "/trial_registration/trial_reg_parameters/scan_ids"
+                ][0]
                 self.xanes_scan_id_e = f[
-                    "/trial_registration/trial_reg_parameters/scan_ids"][-1]
+                    "/trial_registration/trial_reg_parameters/scan_ids"
+                ][-1]
 
             self.xanes_element = determine_element(self.xanes_fit_eng_list)
             if self.xanes_element is None:
                 print(
                     "Cannot determine the element edge. Maybe there is not enough number of energy points. Skip XANES fitting"
                 )
             else:
@@ -4118,191 +4284,183 @@
                 self.xanes_fit_type = "full"
                 self.xanes_fit_gui_h.hs["FitEngRagOptn drpdn"].value = "full"
 
             self.hs["VisImgViewAlignSli sldr"].value = 1
             self.hs["VisImgViewAlign4thDim sldr"].value = 0
             self.hs["VisImgViewAlignOptn drpdn"].value = "x-y-E"
             self.hs["VisImgViewAlignSli sldr"].description = "E"
-            self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                0]
+            self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[0]
             self.hs["VisImgViewAlignSli sldr"].min = 1
             self.hs["VisImgViewAlign4thDim sldr"].description = "z"
-            self.hs[
-                "VisImgViewAlign4thDim sldr"].max = self.xanes_fit_data_shape[
-                    1] - 1
+            self.hs["VisImgViewAlign4thDim sldr"].max = self.xanes_fit_data_shape[1] - 1
             self.hs["VisImgViewAlign4thDim sldr"].min = 0
-            self.hs[
-                "SelFile&PathCfm text"].value = "XANES3D file config is done ..."
+            self.hs["SelFile&PathCfm text"].value = "XANES3D file config is done ..."
         else:
-            self.hs[
-                "AlignReconCfm text"].value = "something wrong in XANES3D alignment ..."
+            self.hs["AlignReconCfm text"].value = (
+                "something wrong in XANES3D alignment ..."
+            )
         self.boxes_logic()
 
     def VisImgViewerOptn_tgbtn_clk(self, a):
         self.xanes_visualization_viewer_option = a["owner"].value
         if self.xanes_visualization_viewer_option == "napari":
             with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:]
             self.viewer = napari.view_image(self.xanes_aligned_data)
         self.boxes_logic()
 
     def VisImgViewAlignOptn_drpdn_clk(self, a):
         """
         image data on the disk is save in format [E, z, y, x]
         """
         self.xanes_fit_view_option = a["owner"].value
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             if self.xanes_fit_view_option == "x-y-E":
                 self.hs["VisImgViewAlignSli sldr"].value = 1
                 self.hs["VisImgViewAlignSli sldr"].description = "E"
-                self.hs[
-                    "VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                        0]
+                self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[0]
                 self.hs["VisImgViewAlignSli sldr"].min = 1
                 self.hs["VisImgViewAlign4thDim sldr"].value = 0
                 self.hs["VisImgViewAlign4thDim sldr"].description = "z"
                 self.hs["VisImgViewAlign4thDim sldr"].max = (
-                    self.xanes_fit_data_shape[1] - 1)
+                    self.xanes_fit_data_shape[1] - 1
+                )
                 self.hs["VisImgViewAlign4thDim sldr"].min = 0
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:,
-                                                                            0, :, :]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:, 0, :, :]
             elif self.xanes_fit_view_option == "y-z-E":
                 self.hs["VisImgViewAlignSli sldr"].value = 1
                 self.hs["VisImgViewAlignSli sldr"].description = "E"
-                self.hs[
-                    "VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                        0]
+                self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[0]
                 self.hs["VisImgViewAlignSli sldr"].min = 1
                 self.hs["VisImgViewAlign4thDim sldr"].value = 0
                 self.hs["VisImgViewAlign4thDim sldr"].description = "x"
                 self.hs["VisImgViewAlign4thDim sldr"].max = (
-                    self.xanes_fit_data_shape[3] - 1)
+                    self.xanes_fit_data_shape[3] - 1
+                )
                 self.hs["VisImgViewAlign4thDim sldr"].min = 0
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:, :, :,
-                                                                            0]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:, :, :, 0]
             elif self.xanes_fit_view_option == "z-x-E":
                 self.hs["VisImgViewAlignSli sldr"].value = 1
                 self.hs["VisImgViewAlignSli sldr"].description = "E"
-                self.hs[
-                    "VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                        0]
+                self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[0]
                 self.hs["VisImgViewAlignSli sldr"].min = 1
                 self.hs["VisImgViewAlign4thDim sldr"].value = 0
                 self.hs["VisImgViewAlign4thDim sldr"].description = "y"
                 self.hs["VisImgViewAlign4thDim sldr"].max = (
-                    self.xanes_fit_data_shape[2] - 1)
+                    self.xanes_fit_data_shape[2] - 1
+                )
                 self.hs["VisImgViewAlign4thDim sldr"].min = 0
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:, :,
-                                                                            0, :]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:, :, 0, :]
             elif self.xanes_fit_view_option == "x-y-z":
                 self.hs["VisImgViewAlignSli sldr"].value = 1
                 self.hs["VisImgViewAlignSli sldr"].description = "z"
-                self.hs[
-                    "VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[
-                        1]
+                self.hs["VisImgViewAlignSli sldr"].max = self.xanes_fit_data_shape[1]
                 self.hs["VisImgViewAlignSli sldr"].min = 1
                 self.hs["VisImgViewAlign4thDim sldr"].value = 0
                 self.hs["VisImgViewAlign4thDim sldr"].description = "E"
                 self.hs["VisImgViewAlign4thDim sldr"].max = (
-                    self.xanes_fit_data_shape[0] - 1)
+                    self.xanes_fit_data_shape[0] - 1
+                )
                 self.hs["VisImgViewAlign4thDim sldr"].min = 0
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][
-                        0, :, :, :]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][0, :, :, :]
         self.xanes_fit_view_option_previous = self.xanes_fit_view_option
         self.boxes_logic()
 
     def VisImgViewAlignSli_sldr_chg(self, a):
-        fiji_viewer_on(self.global_h,
-                       self,
-                       viewer_name="xanes3D_analysis_viewer")
+        fiji_viewer_on(self.global_h, self, viewer_name="xanes3D_analysis_viewer")
         self.hs["VisImgViewAlignEng text"].value = round(
-            self.xanes_fit_eng_list[a["owner"].value - 1], 1)
+            self.xanes_fit_eng_list[a["owner"].value - 1], 1
+        )
 
     def VisImgViewAlign4thDim_sldr_chg(self, a):
         self.xanes_fit_4th_dim_idx = a["owner"].value
         with h5py.File(self.xanes_save_trial_reg_filename, "r") as f:
             if self.hs["VisImgViewAlignOptn drpdn"].value == "x-y-E":
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:,
-                                                                            self
-                                                                            .
-                                                                            xanes_fit_4th_dim_idx, :, :]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:, self.xanes_fit_4th_dim_idx, :, :]
             elif self.hs["VisImgViewAlignOptn drpdn"].value == "y-z-E":
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:, :, :,
-                                                                            self
-                                                                            .
-                                                                            xanes_fit_4th_dim_idx]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:, :, :, self.xanes_fit_4th_dim_idx]
             elif self.hs["VisImgViewAlignOptn drpdn"].value == "z-x-E":
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][:, :,
-                                                                            self
-                                                                            .
-                                                                            xanes_fit_4th_dim_idx, :]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][:, :, self.xanes_fit_4th_dim_idx, :]
             elif self.hs["VisImgViewAlignOptn drpdn"].value == "x-y-z":
                 self.xanes_aligned_data = 0
                 self.xanes_aligned_data = f[
-                    "/registration_results/reg_results/registered_xanes3D"][
-                        self.xanes_fit_4th_dim_idx, :, :, :]
+                    "/registration_results/reg_results/registered_xanes3D"
+                ][self.xanes_fit_4th_dim_idx, :, :, :]
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes3D_analysis_viewer")
+            self.global_h, self, viewer_name="xanes3D_analysis_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_analysis_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes3D_analysis_viewer")
         self.xanes_fiji_aligned_data = self.global_h.ij.convert().convert(
             self.global_h.ij.dataset().create(
-                self.global_h.ij.py.to_java(self.xanes_aligned_data)),
+                self.global_h.ij.py.to_java(self.xanes_aligned_data)
+            ),
             self.global_h.ImagePlusClass,
         )
-        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"].setImage(self.xanes_fiji_aligned_data)
-        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"].show()
-        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"].setTitle(
-                f"{a['owner'].description} slice: {a['owner'].value}")
+        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"]["ip"].setImage(
+            self.xanes_fiji_aligned_data
+        )
+        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"]["ip"].show()
+        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"]["ip"].setTitle(
+            f"{a['owner'].description} slice: {a['owner'].value}"
+        )
         self.global_h.ij.py.run_macro("""run("Collect Garbage")""")
-        self.global_h.ij.py.run_macro(
-            """run("Enhance Contrast", "saturated=0.35")""")
+        self.global_h.ij.py.run_macro("""run("Enhance Contrast", "saturated=0.35")""")
 
     def VisSpecViewMemMnt_chbx_chg(self, a):
         if a["owner"].value:
             self.global_h.ij.py.run_macro("""run("Monitor Memory...")""")
 
     def VisSpecViewInRoi_btn_clk(self, a):
         data_state, viewer_state = fiji_viewer_state(
-            self.global_h, self, viewer_name="xanes3D_analysis_viewer")
+            self.global_h, self, viewer_name="xanes3D_analysis_viewer"
+        )
         if not viewer_state:
-            fiji_viewer_on(self.global_h,
-                           self,
-                           viewer_name="xanes3D_analysis_viewer")
+            fiji_viewer_on(self.global_h, self, viewer_name="xanes3D_analysis_viewer")
         width = self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"].getWidth()
+            "ip"
+        ].getWidth()
         height = self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"].getHeight()
+            "ip"
+        ].getHeight()
         roi = [int((width - 10) / 2), int((height - 10) / 2), 10, 10]
-        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"][
-            "ip"].setRoi(roi[0], roi[1], roi[2], roi[3])
+        self.global_h.xanes3D_fiji_windows["xanes3D_analysis_viewer"]["ip"].setRoi(
+            roi[0], roi[1], roi[2], roi[3]
+        )
         self.global_h.ij.py.run_macro("""run("Plot Z-axis Profile")""")
         self.global_h.ij.py.run_macro(
-            """Plot.setStyle(0, "black,none,1.0,Connected Circles")""")
+            """Plot.setStyle(0, "black,none,1.0,Connected Circles")"""
+        )
         self.global_h.xanes3D_fiji_windows["analysis_viewer_z_plot_viewer"][
-            "ip"] = self.global_h.WindowManager.getCurrentImage()
+            "ip"
+        ] = self.global_h.WindowManager.getCurrentImage()
         self.global_h.xanes3D_fiji_windows["analysis_viewer_z_plot_viewer"][
-            "fiji_id"] = self.global_h.WindowManager.getIDList()[-1]
-        self.hs[
-            "VisSpecView text"].value = "drag the roi box to check the spectrum at different locations ..."
+            "fiji_id"
+        ] = self.global_h.WindowManager.getIDList()[-1]
+        self.hs["VisSpecView text"].value = (
+            "drag the roi box to check the spectrum at different locations ..."
+        )
         self.boxes_logic()
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes_analysis_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes_analysis_gui.py`

 * *Files 22% similar despite different names*

```diff
@@ -6,341 +6,295 @@
 @author: xiao
 """
 
 from ipywidgets import widgets
 from IPython.display import Javascript, display
 from copy import deepcopy
 import os, h5py, json
+from pathlib import Path
 from silx.io.dictdump import dicttoh5
 import numpy as np
 from dask import delayed
 import dask.array as da
 import napari
 
-from .gui_components import (SelectFilesButton, NumpyArrayEncoder, get_handles,
-                             enable_disable_boxes, gen_external_py_script,
-                             fiji_viewer_off, fiji_viewer_on,
-                             update_json_content)
+from .gui_components import (
+    SelectFilesButton,
+    NumpyArrayEncoder,
+    get_handles,
+    enable_disable_boxes,
+    gen_external_py_script,
+    fiji_viewer_off,
+    fiji_viewer_on,
+    update_json_content,
+)
 from ..dicts.xanes_analysis_dict import XANES_ANA_METHOD
 from ..utils.io import h5_lazy_reader
 from ..utils import xanes_post_analysis as xpa
 
 
-class xanes_analysis_gui():
+class xanes_analysis_gui:
     MASK_OP_PAR_DICT = {
-        'Threshold': {
-            'description':
-            'Apply a threshold on the selected image to convert it into a binary image',
-            'url': 'https://www.google.com',
-            'flt': xpa.threshold,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'lower',
-                    'val': 0,
-                    'tooltip': 'lower threshold'
+        "Threshold": {
+            "description": "Apply a threshold on the selected image to convert it into a binary image",
+            "url": "https://www.google.com",
+            "flt": xpa.threshold,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "lower",
+                    "val": 0,
+                    "tooltip": "lower threshold",
                 },
-                'AnaSnglMaskOpPar09 txt': {
-                    'var': 'upper',
-                    'val': 1e30,
-                    'tooltip': 'upper threshold'
-                }
-            }
+                "AnaSnglMaskOpPar09 txt": {
+                    "var": "upper",
+                    "val": 1e30,
+                    "tooltip": "upper threshold",
+                },
+            },
         },
-        'Gaussian': {
-            'description':
-            'Apply a Gaussian filter on the selected image to smooth the image',
-            'url':
-            'https://scikit-image.org/docs/0.19.x/api/skimage.filters.html#skimage.filters.gaussian',
-            'flt': xpa.gaussian,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'sigma',
-                    'val': 3,
-                    'tooltip': 'Gausssian blurring filter kernal size'
+        "Gaussian": {
+            "description": "Apply a Gaussian filter on the selected image to smooth the image",
+            "url": "https://scikit-image.org/docs/0.19.x/api/skimage.filters.html#skimage.filters.gaussian",
+            "flt": xpa.gaussian,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "sigma",
+                    "val": 3,
+                    "tooltip": "Gausssian blurring filter kernal size",
                 }
-            }
+            },
         },
-        'Median': {
-            'description':
-            'Apply a median filter on the selected image to smooth the image',
-            'url':
-            'https://scikit-image.org/docs/0.19.x/api/skimage.filters.html#skimage.filters.median',
-            'flt': xpa.median,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 3,
-                    'tooltip': 'median filter kernal size'
+        "Median": {
+            "description": "Apply a median filter on the selected image to smooth the image",
+            "url": "https://scikit-image.org/docs/0.19.x/api/skimage.filters.html#skimage.filters.median",
+            "flt": xpa.median,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 3,
+                    "tooltip": "median filter kernal size",
                 }
-            }
+            },
         },
-        'Dilation': {
-            'description':
-            'Return grayscale morphological dilation of the selected image',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.dilation',
-            'flt': xpa.dilation,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the dilation disk kernal'
+        "Dilation": {
+            "description": "Return grayscale morphological dilation of the selected image",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.dilation",
+            "flt": xpa.dilation,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the dilation disk kernal",
                 },
-                'AnaSnglMaskOpPar09 txt': {
-                    'var': 'iter',
-                    'val': 1,
-                    'tooltip': 'dilation iterations'
-                }
-            }
-        },
-        'Erosion': {
-            'description':
-            'Return grayscale morphological erosion of the selected image',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.erosion',
-            'flt': xpa.erosion,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the erosion disk kernal'
+                "AnaSnglMaskOpPar09 txt": {
+                    "var": "iter",
+                    "val": 1,
+                    "tooltip": "dilation iterations",
                 },
-                'AnaSnglMaskOpPar09 txt': {
-                    'var': 'iter',
-                    'val': 1,
-                    'tooltip': 'erosion iterations'
-                }
-            }
-        },
-        'Opening': {
-            'description':
-            'Return grayscale morphological opening of an image',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.opening',
-            'flt': xpa.opening,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the opening disk kernal'
-                }
-            }
-        },
-        'Closing': {
-            'description':
-            'Return grayscale morphological closing of an image',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.closing',
-            'flt': xpa.closing,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the closing disk kernal'
-                }
-            }
-        },
-        'Area Opening': {
-            'description':
-            'Perform an area opening of a grayscale image; removes all dark structures of an image with a surface smaller than area_threshold',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.area_opening',
-            'flt': xpa.area_opening,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'area_threshold',
-                    'val': 64,
-                    'tooltip': 'The size parameter (number of pixels)'
-                }
-            }
-        },
-        'Area Closing': {
-            'description':
-            'Perform an area closing of a grayscale image; removes all dark structures of an image with a surface smaller than area_threshold',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.area_closing',
-            'flt': xpa.area_closing,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'area_threshold',
-                    'val': 64,
-                    'tooltip': 'The size parameter (number of pixels)'
-                }
-            }
-        },
-        'Diameter Opening': {
-            'description':
-            'Removes all bright structures of an image with maximal extension smaller than diameter_threshold',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.diameter_opening',
-            'flt': xpa.diameter_opening,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var':
-                    'diameter_threshold',
-                    'val':
-                    8,
-                    'tooltip':
-                    'diameter_threshold: unsigned int; The maximal extension parameter (number of pixels)'
-                }
-            }
+            },
         },
-        'Diameter Closing': {
-            'description':
-            'Removes all dark structures of an image with maximal extension smaller than diameter_threshold',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.diameter_closing',
-            'flt': xpa.diameter_closing,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var':
-                    'diameter_threshold',
-                    'val':
-                    8,
-                    'tooltip':
-                    'diameter_threshold: unsigned int; The maximal extension parameter (number of pixels)'
-                }
-            }
+        "Erosion": {
+            "description": "Return grayscale morphological erosion of the selected image",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.erosion",
+            "flt": xpa.erosion,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the erosion disk kernal",
+                },
+                "AnaSnglMaskOpPar09 txt": {
+                    "var": "iter",
+                    "val": 1,
+                    "tooltip": "erosion iterations",
+                },
+            },
         },
-        'Bin Dilation': {
-            'description':
-            'Returns the same result as grayscale dilation but performs faster for binary images',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_dilation',
-            'flt': xpa.binary_dilation,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the dilation disk kernal'
+        "Opening": {
+            "description": "Return grayscale morphological opening of an image",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.opening",
+            "flt": xpa.opening,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the opening disk kernal",
+                }
+            },
+        },
+        "Closing": {
+            "description": "Return grayscale morphological closing of an image",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.closing",
+            "flt": xpa.closing,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the closing disk kernal",
+                }
+            },
+        },
+        "Area Opening": {
+            "description": "Perform an area opening of a grayscale image; removes all dark structures of an image with a surface smaller than area_threshold",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.area_opening",
+            "flt": xpa.area_opening,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "area_threshold",
+                    "val": 64,
+                    "tooltip": "The size parameter (number of pixels)",
+                }
+            },
+        },
+        "Area Closing": {
+            "description": "Perform an area closing of a grayscale image; removes all dark structures of an image with a surface smaller than area_threshold",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.area_closing",
+            "flt": xpa.area_closing,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "area_threshold",
+                    "val": 64,
+                    "tooltip": "The size parameter (number of pixels)",
+                }
+            },
+        },
+        "Diameter Opening": {
+            "description": "Removes all bright structures of an image with maximal extension smaller than diameter_threshold",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.diameter_opening",
+            "flt": xpa.diameter_opening,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "diameter_threshold",
+                    "val": 8,
+                    "tooltip": "diameter_threshold: unsigned int; The maximal extension parameter (number of pixels)",
+                }
+            },
+        },
+        "Diameter Closing": {
+            "description": "Removes all dark structures of an image with maximal extension smaller than diameter_threshold",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.diameter_closing",
+            "flt": xpa.diameter_closing,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "diameter_threshold",
+                    "val": 8,
+                    "tooltip": "diameter_threshold: unsigned int; The maximal extension parameter (number of pixels)",
+                }
+            },
+        },
+        "Bin Dilation": {
+            "description": "Returns the same result as grayscale dilation but performs faster for binary images",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_dilation",
+            "flt": xpa.binary_dilation,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the dilation disk kernal",
                 },
-                'AnaSnglMaskOpPar09 txt': {
-                    'var': 'iter',
-                    'val': 1,
-                    'tooltip': 'dilation iterations'
-                }
-            }
+                "AnaSnglMaskOpPar09 txt": {
+                    "var": "iter",
+                    "val": 1,
+                    "tooltip": "dilation iterations",
+                },
+            },
         },
-        'Bin Erosion': {
-            'description':
-            'Returns the same result as grayscale erosion but performs faster for binary images',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_erosion',
-            'flt': xpa.binary_erosion,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the erosion disk kernal'
+        "Bin Erosion": {
+            "description": "Returns the same result as grayscale erosion but performs faster for binary images",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_erosion",
+            "flt": xpa.binary_erosion,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the erosion disk kernal",
                 },
-                'AnaSnglMaskOpPar09 txt': {
-                    'var': 'iter',
-                    'val': 1,
-                    'tooltip': 'dilation iterations'
-                }
-            }
+                "AnaSnglMaskOpPar09 txt": {
+                    "var": "iter",
+                    "val": 1,
+                    "tooltip": "dilation iterations",
+                },
+            },
         },
-        'Bin Opening': {
-            'description':
-            'returns the same result as grayscale opening but performs faster for binary images',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_opening',
-            'flt': xpa.binary_opening,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the opening disk kernal'
+        "Bin Opening": {
+            "description": "returns the same result as grayscale opening but performs faster for binary images",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_opening",
+            "flt": xpa.binary_opening,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the opening disk kernal",
                 }
-            }
+            },
         },
-        'Bin Closing': {
-            'description':
-            'returns the same result as grayscale closing but performs faster for binary images',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_closing',
-            'flt': xpa.binary_closing,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var': 'footprint',
-                    'val': 2,
-                    'tooltip':
-                    'footprint: int, radius of the closing disk kernal'
+        "Bin Closing": {
+            "description": "returns the same result as grayscale closing but performs faster for binary images",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.binary_closing",
+            "flt": xpa.binary_closing,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "footprint",
+                    "val": 2,
+                    "tooltip": "footprint: int, radius of the closing disk kernal",
                 }
-            }
+            },
         },
-        'Bin Rm Small Holes': {
-            'description':
-            'Remove contiguous holes (smaller values) smaller than the specified size',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.remove_small_holes',
-            'flt': xpa.remove_small_holes,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var':
-                    'area_threshold',
-                    'val':
-                    64,
-                    'tooltip':
-                    'area_threshold: int, The maximum area, in pixels, of a contiguous hole that will be filled'
+        "Bin Rm Small Holes": {
+            "description": "Remove contiguous holes (smaller values) smaller than the specified size",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.remove_small_holes",
+            "flt": xpa.remove_small_holes,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "area_threshold",
+                    "val": 64,
+                    "tooltip": "area_threshold: int, The maximum area, in pixels, of a contiguous hole that will be filled",
                 }
-            }
+            },
         },
-        'Bin Rm Small Objs': {
-            'description':
-            'Remove contiguous objects (higher values) smaller than the specified size',
-            'url':
-            'https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.remove_small_objects',
-            'flt': xpa.remove_small_objects,
-            'default_pars': {
-                'AnaSnglMaskOpPar08 txt': {
-                    'var':
-                    'min_size',
-                    'val':
-                    64,
-                    'tooltip':
-                    'min_size: int, The maximum area, in pixels, of a contiguous hole that will be filled'
+        "Bin Rm Small Objs": {
+            "description": "Remove contiguous objects (higher values) smaller than the specified size",
+            "url": "https://scikit-image.org/docs/stable/api/skimage.morphology.html#skimage.morphology.remove_small_objects",
+            "flt": xpa.remove_small_objects,
+            "default_pars": {
+                "AnaSnglMaskOpPar08 txt": {
+                    "var": "min_size",
+                    "val": 64,
+                    "tooltip": "min_size: int, The maximum area, in pixels, of a contiguous hole that will be filled",
                 }
-            }
-        }
+            },
+        },
     }
 
     SET_OP_DICT = {
-        '': {
-            'description': 'identity operation',
-            'op_symb': '',
-            'flt': xpa.set_identity
+        "": {
+            "description": "identity operation",
+            "op_symb": "",
+            "flt": xpa.set_identity,
+        },
+        "Union (+)": {
+            "description": "Union operation between two masks",
+            "op_symb": " + ",
+            "flt": xpa.set_union,
+        },
+        "Intersection (x)": {
+            "description": "Intersection between two masks",
+            "op_symb": " x ",
+            "flt": xpa.set_intersection,
+        },
+        "Differnece (-)": {
+            "description": "Difference between two masks",
+            "op_symb": " - ",
+            "flt": xpa.set_difference,
+        },
+        "Complement (I-A)": {
+            "description": "Complement of a mask",
+            "op_symb": "1 - A",
+            "flt": xpa.set_complement,
         },
-        'Union (+)': {
-            'description': 'Union operation between two masks',
-            'op_symb': ' + ',
-            'flt': xpa.set_union
-        },
-        'Intersection (x)': {
-            'description': 'Intersection between two masks',
-            'op_symb': ' x ',
-            'flt': xpa.set_intersection
-        },
-        'Differnece (-)': {
-            'description': 'Difference between two masks',
-            'op_symb': ' - ',
-            'flt': xpa.set_difference
-        },
-        'Complement (I-A)': {
-            'description': 'Complement of a mask',
-            'op_symb': '1 - A',
-            'flt': xpa.set_complement
-        }
     }
 
     """ 
     operation sequence for making a single mask
     self.ana_mask_sngl_op = {
         key: int <operation order> {
             key: str <flt_name: filter's name>,
@@ -412,1151 +366,1014 @@
 
         self.ana_fn = ""
         self.ana_proc_spec_path_in_h5 = None
         self.ana_proc_data_list = [""]
 
         self.ana_data = {}
         self.ana_spec_list = []
-        self.viewer_type = 'napari'
+        self.viewer_type = "napari"
         self.viewer = None
 
         self.ana_data = {}
         self.ana_spec = {}
         self.ana_mask = {}
         self.ana_mask_sngl_op = {}
         self.ana_mask_sngl = {}
         self.ana_mask_comb_op = {}
         self.ana_mask_comb = {}
         self.ana_ana_spec = None
         self.ana_ana_mask = None
 
     def lock_message_text_boxes(self):
         boxes = [
-            'AnaDataFn txt', 'AnaDatasetInfo txt', 'AnaVarsEq sel',
-            'AnaVarName sel', 'AnaCombMaskVarInfo txt'
+            "AnaDataFn txt",
+            "AnaDatasetInfo txt",
+            "AnaVarsEq sel",
+            "AnaVarName sel",
+            "AnaCombMaskVarInfo txt",
         ]
         enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
 
     def build_gui(self):
-        self.hs['Ana form'] = widgets.Tab()
-        self.hs['AnaData tab'] = widgets.VBox()
-        self.hs['AnaMask tab'] = widgets.VBox()
-        self.hs['AnaConf tab'] = widgets.VBox()
-        self.hs['AnaDisp tab'] = widgets.VBox()
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': '100%',
-            'height': '100%'
-        }
-        self.hs['AnaData tab'].layout = layout
-        self.hs['AnaMask tab'].layout = layout
-        self.hs['AnaConf tab'].layout = layout
-        self.hs['AnaDisp tab'].layout = layout
-        self.hs['Ana form'].children = [
-            self.hs['AnaData tab'], self.hs['AnaMask tab'],
-            self.hs['AnaConf tab'], self.hs['AnaDisp tab']
+        self.hs["Ana form"] = widgets.Tab()
+        self.hs["AnaData tab"] = widgets.VBox()
+        self.hs["AnaMask tab"] = widgets.VBox()
+        self.hs["AnaConf tab"] = widgets.VBox()
+        self.hs["AnaDisp tab"] = widgets.VBox()
+        layout = {"border": "3px solid #FFCC00", "width": "100%", "height": "100%"}
+        self.hs["AnaData tab"].layout = layout
+        self.hs["AnaMask tab"].layout = layout
+        self.hs["AnaConf tab"].layout = layout
+        self.hs["AnaDisp tab"].layout = layout
+        self.hs["Ana form"].children = [
+            self.hs["AnaData tab"],
+            self.hs["AnaMask tab"],
+            self.hs["AnaConf tab"],
+            self.hs["AnaDisp tab"],
         ]
-        self.hs['Ana form'].set_title(0, 'Data Conf')
-        self.hs['Ana form'].set_title(1, 'Mask Make')
-        self.hs['Ana form'].set_title(2, 'Ana Conf')
-        self.hs['Ana form'].set_title(3, 'Ana Disp')
+        self.hs["Ana form"].set_title(0, "Data Conf")
+        self.hs["Ana form"].set_title(1, "Mask Make")
+        self.hs["Ana form"].set_title(2, "Ana Conf")
+        self.hs["Ana form"].set_title(3, "Ana Disp")
 
         ## ## ## ## ## data setup -- start
-        self.hs['AnaDataSetup box'] = widgets.VBox(layout={
-            'width': '100%',
-            'height': '100%'
-        })
+        self.hs["AnaDataSetup box"] = widgets.VBox(
+            layout={"width": "100%", "height": "100%"}
+        )
 
         ## ## ## ## ## ## config parameters -- start
-        data_setup_GridSpecLayout = widgets.GridspecLayout(17,
-                                                           100,
-                                                           layout={
-                                                               "width": '100%',
-                                                               "height": '100%'
-                                                           })
+        data_setup_GridSpecLayout = widgets.GridspecLayout(
+            17, 100, layout={"width": "100%", "height": "100%"}
+        )
 
         data_setup_GridSpecLayout[0, :80] = widgets.Text(
-            value='choose your data file ...',
-            layout={
-                'width': '100%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaDataFn txt'] = data_setup_GridSpecLayout[0, :80]
+            value="choose your data file ...",
+            layout={"width": "100%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaDataFn txt"] = data_setup_GridSpecLayout[0, :80]
 
         data_setup_GridSpecLayout[0, 82:98] = SelectFilesButton(
-            option='askopenfilename',
-            layout={
-                'width': '100%',
-                'height': '100%'
-            },
-            open_filetypes=(('hdf5 files', ['*.hdf', '*.h5']), ))
-        self.hs['AnaDataFn btn'] = data_setup_GridSpecLayout[0, 82:98]
-        if (self.parent_h.global_h.cwd is None) or (not os.path.exists(
-                os.path.dirname(self.parent_h.global_h.cwd))):
-            self.hs[
-                'AnaDataFn btn'].initialdir = self.parent_h.global_h.script_dir
+            option="askopenfilename",
+            layout={"width": "100%", "height": "100%"},
+            open_filetypes=(("hdf5 files", ["*.hdf", "*.h5"]),),
+        )
+        self.hs["AnaDataFn btn"] = data_setup_GridSpecLayout[0, 82:98]
+        # if (self.parent_h.global_h.cwd is None) or (not os.path.exists(
+        #         os.path.dirname(self.parent_h.global_h.cwd))):
+        if (self.parent_h.global_h.cwd is None) or (
+            not Path(self.parent_h.global_h.cwd).parent.exists()
+        ):
+            self.hs["AnaDataFn btn"].initialdir = self.parent_h.global_h.script_dir
         else:
-            self.hs['AnaDataFn btn'].initialdir = self.parent_h.global_h.cwd
+            self.hs["AnaDataFn btn"].initialdir = self.parent_h.global_h.cwd
 
         data_setup_GridSpecLayout[2:11, :29] = widgets.Select(
             options=[],
             value=None,
-            description='Avai Data:',
+            description="Avai Data:",
             disabled=False,
-            layout={
-                'width': '100%',
-                'height': '100%'
-            },
-            tooltip='Available datasets in the chosen file')
-        self.hs['AnaAvaiDatasets sel'] = data_setup_GridSpecLayout[2:11, :29]
+            layout={"width": "100%", "height": "100%"},
+            tooltip="Available datasets in the chosen file",
+        )
+        self.hs["AnaAvaiDatasets sel"] = data_setup_GridSpecLayout[2:11, :29]
 
         data_setup_GridSpecLayout[5, 30:37] = widgets.Button(
-            description='=>',
-            tooltip='Add Dataset',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaSelDatasetAdd btn'] = data_setup_GridSpecLayout[5, 30:37]
-        self.hs['AnaSelDatasetAdd btn'].style.button_color = 'darkviolet'
+            description="=>",
+            tooltip="Add Dataset",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaSelDatasetAdd btn"] = data_setup_GridSpecLayout[5, 30:37]
+        self.hs["AnaSelDatasetAdd btn"].style.button_color = "darkviolet"
 
         data_setup_GridSpecLayout[7, 30:37] = widgets.Button(
-            description='<=',
-            tooltip='Remove Dataset',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaSelDatasetRm btn'] = data_setup_GridSpecLayout[7, 30:37]
-        self.hs['AnaSelDatasetRm btn'].style.button_color = 'darkviolet'
+            description="<=",
+            tooltip="Remove Dataset",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaSelDatasetRm btn"] = data_setup_GridSpecLayout[7, 30:37]
+        self.hs["AnaSelDatasetRm btn"].style.button_color = "darkviolet"
 
         data_setup_GridSpecLayout[2:11, 37:66] = widgets.Select(
             options=[],
             value=None,
-            description='Sel Vars:',
+            description="Sel Vars:",
             disabled=True,
-            layout={
-                'width': '100%',
-                'height': '100%'
-            },
-            tooltip='Selected Varibles')
-        self.hs['AnaSelVars sel'] = data_setup_GridSpecLayout[2:11, 37:66]
+            layout={"width": "100%", "height": "100%"},
+            tooltip="Selected Varibles",
+        )
+        self.hs["AnaSelVars sel"] = data_setup_GridSpecLayout[2:11, 37:66]
 
-        data_setup_GridSpecLayout[2:11, 69:72] = widgets.Select(options=[],
-                                                                value=None,
-                                                                disabled=True,
-                                                                layout={
-                                                                    'width':
-                                                                    '100%',
-                                                                    'height':
-                                                                    '100%'
-                                                                })
-        self.hs['AnaVarsEq sel'] = data_setup_GridSpecLayout[2:11, 69:72]
+        data_setup_GridSpecLayout[2:11, 69:72] = widgets.Select(
+            options=[],
+            value=None,
+            disabled=True,
+            layout={"width": "100%", "height": "100%"},
+        )
+        self.hs["AnaVarsEq sel"] = data_setup_GridSpecLayout[2:11, 69:72]
 
         data_setup_GridSpecLayout[2:11, 73:99] = widgets.Select(
             options=[],
             value=None,
-            description='Sav Vars:',
+            description="Sav Vars:",
             disabled=True,
-            layout={
-                'width': '100%',
-                'height': '100%'
-            },
-            tooltip='Saved Varibles')
-        self.hs['AnaVarName sel'] = data_setup_GridSpecLayout[2:11, 73:99]
+            layout={"width": "100%", "height": "100%"},
+            tooltip="Saved Varibles",
+        )
+        self.hs["AnaVarName sel"] = data_setup_GridSpecLayout[2:11, 73:99]
 
         data_setup_GridSpecLayout[12:16, :37] = widgets.Textarea(
-            value='shape: \nmin: \nmax: \nmean: ',
-            description='Data Info',
+            value="shape: \nmin: \nmax: \nmean: ",
+            description="Data Info",
             disabled=True,
-            layout={
-                'width': '100%',
-                'height': '100%'
-            })
-        self.hs['AnaDatasetInfo txt'] = data_setup_GridSpecLayout[12:16, :37]
-
-        data_setup_GridSpecLayout[12:17,
-                                  38:80] = widgets.Output(layout={
-                                      'border': '1px solid #FFCC11',
-                                      'width': '100%',
-                                      'height': '90%'
-                                  })
-        self.hs['AnaDataHist plt'] = data_setup_GridSpecLayout[12:17, 38:80]
-
-        self.hs['AnaDataPrev box'] = widgets.VBox(layout={
-            'width': 'auto',
-            'height': 'auto'
-        },
-                                                  disabled=True)
+            layout={"width": "100%", "height": "100%"},
+        )
+        self.hs["AnaDatasetInfo txt"] = data_setup_GridSpecLayout[12:16, :37]
+
+        data_setup_GridSpecLayout[12:17, 38:80] = widgets.Output(
+            layout={"border": "1px solid #FFCC11", "width": "100%", "height": "90%"}
+        )
+        self.hs["AnaDataHist plt"] = data_setup_GridSpecLayout[12:17, 38:80]
+
+        self.hs["AnaDataPrev box"] = widgets.VBox(
+            layout={"width": "auto", "height": "auto"}, disabled=True
+        )
 
         data_setup_GridSpecLayout[13:15, 82:98] = widgets.RadioButtons(
-            options=['Fiji', 'napari'],
-            value='Fiji',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            },
-            disabled=True)
-        self.hs['AnaSelDatasetPrevOpt rad'] = data_setup_GridSpecLayout[13:15,
-                                                                        82:98]
+            options=["Fiji", "napari"],
+            value="Fiji",
+            layout={"width": "auto", "height": "auto"},
+            disabled=True,
+        )
+        self.hs["AnaSelDatasetPrevOpt rad"] = data_setup_GridSpecLayout[13:15, 82:98]
 
         data_setup_GridSpecLayout[15, 82:98] = widgets.Button(
-            description='Preview',
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            },
-            disabled=True)
-        self.hs['AnaSelDatasetPrev btn'] = data_setup_GridSpecLayout[15, 82:98]
-        self.hs['AnaSelDatasetPrev btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaDataPrev box'].children = [
-            self.hs['AnaSelDatasetPrev btn'],
-            self.hs['AnaSelDatasetPrevOpt rad']
+            description="Preview",
+            layout={"width": "auto", "height": "auto"},
+            disabled=True,
+        )
+        self.hs["AnaSelDatasetPrev btn"] = data_setup_GridSpecLayout[15, 82:98]
+        self.hs["AnaSelDatasetPrev btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaDataPrev box"].children = [
+            self.hs["AnaSelDatasetPrev btn"],
+            self.hs["AnaSelDatasetPrevOpt rad"],
         ]
 
-        self.hs['AnaDataFn btn'].on_click(self.AnaDataFn_btn_clk)
-        self.hs['AnaAvaiDatasets sel'].observe(self.AnaAvaiDatasets_sel_chg,
-                                               names='value')
-        self.hs['AnaSelDatasetAdd btn'].on_click(self.AnaSelDatasetAdd_btn_clk)
-        self.hs['AnaSelDatasetRm btn'].on_click(self.AnaSelDatasetRm_btn_clk)
-        self.hs['AnaSelVars sel'].observe(self.AnaSelVars_sel_chg,
-                                          names='value')
-        self.hs['AnaSelDatasetPrev btn'].on_click(
-            self.AnaSelDatasetPrev_btn_clk)
-        self.hs['AnaSelDatasetPrevOpt rad'].observe(
-            self.AnaSelDatasetPrevOpt_rad_chg, names='value')
-        self.hs['AnaDataSetup box'].children = [data_setup_GridSpecLayout]
+        self.hs["AnaDataFn btn"].on_click(self.AnaDataFn_btn_clk)
+        self.hs["AnaAvaiDatasets sel"].observe(
+            self.AnaAvaiDatasets_sel_chg, names="value"
+        )
+        self.hs["AnaSelDatasetAdd btn"].on_click(self.AnaSelDatasetAdd_btn_clk)
+        self.hs["AnaSelDatasetRm btn"].on_click(self.AnaSelDatasetRm_btn_clk)
+        self.hs["AnaSelVars sel"].observe(self.AnaSelVars_sel_chg, names="value")
+        self.hs["AnaSelDatasetPrev btn"].on_click(self.AnaSelDatasetPrev_btn_clk)
+        self.hs["AnaSelDatasetPrevOpt rad"].observe(
+            self.AnaSelDatasetPrevOpt_rad_chg, names="value"
+        )
+        self.hs["AnaDataSetup box"].children = [data_setup_GridSpecLayout]
 
-        self.hs['AnaData tab'].children = [self.hs['AnaDataSetup box']]
+        self.hs["AnaData tab"].children = [self.hs["AnaDataSetup box"]]
         ## ## ## ## ## data setup -- end
 
         ## ## ## ## ## preparing masks -- start
-        self.hs['AnaMask acc'] = widgets.Accordion(
-            titles=('Make A Single Mask', 'Combine Masks'),
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
+        self.hs["AnaMask acc"] = widgets.Accordion(
+            titles=("Make A Single Mask", "Combine Masks"),
+            layout={"width": "auto", "height": "auto"},
+        )
 
         ## ## ## ## ## ## define single mask -- start
         AnaSnglMask_GridspecLayout = widgets.GridspecLayout(
             17,
             100,
-            layout={
-                'width': '100%',
-                'height': f'{0.68 * (self.form_sz[0] - 136)}px'
-            })
-
-        AnaSnglMask_GridspecLayout[:, :20] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                          disabled=True)
-        self.hs['AnaSnglMaskVarName box'] = AnaSnglMask_GridspecLayout[:, :20]
-        self.hs['AnaSnglMaskVarName lbl'] = widgets.Label('Sel Var')
-        self.hs['AnaSnglMaskVarName drpn'] = widgets.Dropdown(
-            tooltip='Select a Varible to Make a Mask Based on It.',
-            options=self.hs['AnaVarName sel'].options,
-            layout={
-                'width': '90%',
-                'height': 'auto',
-                'left': '5%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskSpecName lbl'] = widgets.Label('Sel Spec')
-        self.hs['AnaSnglMaskSpecName drpn'] = widgets.Dropdown(
-            tooltip='Select a Spec on Which the Mask Will Be Applied.',
+            layout={"width": "100%", "height": f"{0.68 * (self.form_sz[0] - 136)}px"},
+        )
+
+        AnaSnglMask_GridspecLayout[:, :20] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskVarName box"] = AnaSnglMask_GridspecLayout[:, :20]
+        self.hs["AnaSnglMaskVarName lbl"] = widgets.Label("Sel Var")
+        self.hs["AnaSnglMaskVarName drpn"] = widgets.Dropdown(
+            tooltip="Select a Varible to Make a Mask Based on It.",
+            options=self.hs["AnaVarName sel"].options,
+            layout={"width": "90%", "height": "auto", "left": "5%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskSpecName lbl"] = widgets.Label("Sel Spec")
+        self.hs["AnaSnglMaskSpecName drpn"] = widgets.Dropdown(
+            tooltip="Select a Spec on Which the Mask Will Be Applied.",
             options=self.ana_spec_list,
-            layout={
-                'width': '90%',
-                'height': 'auto',
-                'left': '5%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskVarName box'].children = [
-            self.hs['AnaSnglMaskVarName lbl'],
-            self.hs['AnaSnglMaskVarName drpn'],
-            self.hs['AnaSnglMaskSpecName lbl'],
-            self.hs['AnaSnglMaskSpecName drpn']
+            layout={"width": "90%", "height": "auto", "left": "5%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskVarName box"].children = [
+            self.hs["AnaSnglMaskVarName lbl"],
+            self.hs["AnaSnglMaskVarName drpn"],
+            self.hs["AnaSnglMaskSpecName lbl"],
+            self.hs["AnaSnglMaskSpecName drpn"],
         ]
 
-        AnaSnglMask_GridspecLayout[:, 21:41] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                            disabled=True)
-        self.hs['AnaSnglMaskOp box'] = AnaSnglMask_GridspecLayout[:, 21:41]
-        self.hs['AnaSnglMaskOp lbl'] = widgets.Label('Sel Op')
-        self.hs['AnaSnglMaskOp drpn'] = widgets.Dropdown(
-            tooltip=xanes_analysis_gui.MASK_OP_PAR_DICT['Threshold']
-            ['description'],
+        AnaSnglMask_GridspecLayout[:, 21:41] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOp box"] = AnaSnglMask_GridspecLayout[:, 21:41]
+        self.hs["AnaSnglMaskOp lbl"] = widgets.Label("Sel Op")
+        self.hs["AnaSnglMaskOp drpn"] = widgets.Dropdown(
+            tooltip=xanes_analysis_gui.MASK_OP_PAR_DICT["Threshold"]["description"],
             options=(
-                'Threshold',
-                'Gaussian',
-                'Median',
-                'Dilation',
-                'Erosion',
-                'Opening',
-                'Closing',
-                'Area Opening',
-                'Area Closing',
-                'Diameter_Opening',
-                'Diameter_Closing',
-                'Bin Rm Small Holes',
-                'Bin Rm Small Objs',
-                'Bin Dilation',
-                'Bin Erosion',
-                'Bin Opening',
-                'Bin Closing',
+                "Threshold",
+                "Gaussian",
+                "Median",
+                "Dilation",
+                "Erosion",
+                "Opening",
+                "Closing",
+                "Area Opening",
+                "Area Closing",
+                "Diameter_Opening",
+                "Diameter_Closing",
+                "Bin Rm Small Holes",
+                "Bin Rm Small Objs",
+                "Bin Dilation",
+                "Bin Erosion",
+                "Bin Opening",
+                "Bin Closing",
             ),
-            layout={
-                'width': '90%',
-                'height': 'auto',
-                'left': '5%'
-            },
-            disabled=True)
+            layout={"width": "90%", "height": "auto", "left": "5%"},
+            disabled=True,
+        )
 
         for ii in range(4):
-            self.hs[f'AnaSnglMaskOpPar{str(ii).zfill(2)} box'] = widgets.HBox(
+            self.hs[f"AnaSnglMaskOpPar{str(ii).zfill(2)} box"] = widgets.HBox(
                 layout={
-                    'width': '100%',
-                    'height': f'{0.06 * (self.form_sz[0] - 136)}px'
-                })
+                    "width": "100%",
+                    "height": f"{0.06 * (self.form_sz[0] - 136)}px",
+                }
+            )
             children = []
             for jj in range(2):
-                self.hs[
-                    f'AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} drpn'] = widgets.Dropdown(
-                        layout={
-                            'width': '44%',
-                            'height': 'auto',
-                            'left': '5%'
-                        },
-                        tooltip=f'p{str(ii*2+jj).zfill(2)}',
-                        disabled=True)
+                self.hs[f"AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} drpn"] = (
+                    widgets.Dropdown(
+                        layout={"width": "44%", "height": "auto", "left": "5%"},
+                        tooltip=f"p{str(ii*2+jj).zfill(2)}",
+                        disabled=True,
+                    )
+                )
                 children.append(
-                    self.hs[f'AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} drpn'])
-            self.hs[
-                f'AnaSnglMaskOpPar{str(ii).zfill(2)} box'].children = children
+                    self.hs[f"AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} drpn"]
+                )
+            self.hs[f"AnaSnglMaskOpPar{str(ii).zfill(2)} box"].children = children
         for ii in range(4, 8):
-            self.hs[f'AnaSnglMaskOpPar{str(ii).zfill(2)} box'] = widgets.HBox(
+            self.hs[f"AnaSnglMaskOpPar{str(ii).zfill(2)} box"] = widgets.HBox(
                 layout={
-                    'width': '100%',
-                    'height': f'{0.06 * (self.form_sz[0] - 136)}px'
-                })
+                    "width": "100%",
+                    "height": f"{0.06 * (self.form_sz[0] - 136)}px",
+                }
+            )
             children = []
             for jj in range(2):
-                self.hs[
-                    f'AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} txt'] = widgets.FloatText(
-                        layout={
-                            'width': '44%',
-                            'height': '80%',
-                            'left': '5%'
-                        },
-                        tooltip=f'p{str(ii*2+jj).zfill(2)}',
-                        disabled=True)
-                children.append(
-                    self.hs[f'AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} txt'])
-            self.hs[
-                f'AnaSnglMaskOpPar{str(ii).zfill(2)} box'].children = children
-
-        self.hs[
-            f'AnaSnglMaskOpPar08 txt'].value = xanes_analysis_gui.MASK_OP_PAR_DICT[
-                'Threshold']['default_pars']['AnaSnglMaskOpPar08 txt']['val']
-        self.hs[
-            f'AnaSnglMaskOpPar08 txt'].tooltip = xanes_analysis_gui.MASK_OP_PAR_DICT[
-                'Threshold']['default_pars']['AnaSnglMaskOpPar08 txt'][
-                    'tooltip']
-        self.hs[
-            f'AnaSnglMaskOpPar09 txt'].value = xanes_analysis_gui.MASK_OP_PAR_DICT[
-                'Threshold']['default_pars']['AnaSnglMaskOpPar09 txt']['val']
-        self.hs[
-            f'AnaSnglMaskOpPar09 txt'].tooltip = xanes_analysis_gui.MASK_OP_PAR_DICT[
-                'Threshold']['default_pars']['AnaSnglMaskOpPar09 txt'][
-                    'tooltip']
-
-        self.hs['AnaSnglMaskOpHelp out'] = widgets.Output(layout={
-            'width': 'auto',
-            'height': '0.1%'
-        })
-        self.hs['AnaSnglMaskOpHelp btn'] = widgets.Button(
-            description='Help',
-            tooltip='https://www.google.com',
-            layout={
-                'width': '60%',
-                'height': 'auto',
-                'top': '2%',
-                'left': '20%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskOpHelp btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaSnglMaskOp box'].children = [
-            self.hs['AnaSnglMaskOp lbl'], self.hs['AnaSnglMaskOp drpn'], *[
-                self.hs[f'AnaSnglMaskOpPar{str(ii).zfill(2)} box']
-                for ii in range(8)
-            ], self.hs['AnaSnglMaskOpHelp out'],
-            self.hs['AnaSnglMaskOpHelp btn']
+                self.hs[f"AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} txt"] = (
+                    widgets.FloatText(
+                        layout={"width": "44%", "height": "80%", "left": "5%"},
+                        tooltip=f"p{str(ii*2+jj).zfill(2)}",
+                        disabled=True,
+                    )
+                )
+                children.append(self.hs[f"AnaSnglMaskOpPar{str(ii*2+jj).zfill(2)} txt"])
+            self.hs[f"AnaSnglMaskOpPar{str(ii).zfill(2)} box"].children = children
+
+        self.hs[f"AnaSnglMaskOpPar08 txt"].value = xanes_analysis_gui.MASK_OP_PAR_DICT[
+            "Threshold"
+        ]["default_pars"]["AnaSnglMaskOpPar08 txt"]["val"]
+        self.hs[f"AnaSnglMaskOpPar08 txt"].tooltip = (
+            xanes_analysis_gui.MASK_OP_PAR_DICT["Threshold"]["default_pars"][
+                "AnaSnglMaskOpPar08 txt"
+            ]["tooltip"]
+        )
+        self.hs[f"AnaSnglMaskOpPar09 txt"].value = xanes_analysis_gui.MASK_OP_PAR_DICT[
+            "Threshold"
+        ]["default_pars"]["AnaSnglMaskOpPar09 txt"]["val"]
+        self.hs[f"AnaSnglMaskOpPar09 txt"].tooltip = (
+            xanes_analysis_gui.MASK_OP_PAR_DICT["Threshold"]["default_pars"][
+                "AnaSnglMaskOpPar09 txt"
+            ]["tooltip"]
+        )
+
+        self.hs["AnaSnglMaskOpHelp out"] = widgets.Output(
+            layout={"width": "auto", "height": "0.1%"}
+        )
+        self.hs["AnaSnglMaskOpHelp btn"] = widgets.Button(
+            description="Help",
+            tooltip="https://www.google.com",
+            layout={"width": "60%", "height": "auto", "top": "2%", "left": "20%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOpHelp btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaSnglMaskOp box"].children = [
+            self.hs["AnaSnglMaskOp lbl"],
+            self.hs["AnaSnglMaskOp drpn"],
+            *[self.hs[f"AnaSnglMaskOpPar{str(ii).zfill(2)} box"] for ii in range(8)],
+            self.hs["AnaSnglMaskOpHelp out"],
+            self.hs["AnaSnglMaskOpHelp btn"],
         ]
 
         AnaSnglMask_GridspecLayout[7, 42:49] = widgets.Button(
-            description='=>',
-            tooltip='Add an Operation',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskOpAdd btn'] = AnaSnglMask_GridspecLayout[7, 42:49]
-        self.hs['AnaSnglMaskOpAdd btn'].style.button_color = 'darkviolet'
+            description="=>",
+            tooltip="Add an Operation",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOpAdd btn"] = AnaSnglMask_GridspecLayout[7, 42:49]
+        self.hs["AnaSnglMaskOpAdd btn"].style.button_color = "darkviolet"
 
         AnaSnglMask_GridspecLayout[9, 42:49] = widgets.Button(
-            description='<=',
-            tooltip='Remove an Operation',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskOpRm btn'] = AnaSnglMask_GridspecLayout[9, 42:49]
-        self.hs['AnaSnglMaskOpRm btn'].style.button_color = 'darkviolet'
-
-        AnaSnglMask_GridspecLayout[:, 50:70] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                            disabled=True)
-        self.hs['AnaSnglMaskOpSeq box'] = AnaSnglMask_GridspecLayout[:, 50:70]
-        self.hs['AnaSnglMaskOpSeq lbl'] = widgets.Label('Op Seq')
-        self.hs['AnaSnglMaskOpSeq sel'] = widgets.Select(layout={
-            'width': '90%',
-            'height': '70%',
-            'left': '5%'
-        },
-                                                         disabled=True)
-        self.hs['AnaSnglMaskOpSeqZSli txt'] = widgets.BoundedIntText(
-            tooltip='Z Slice #',
+            description="<=",
+            tooltip="Remove an Operation",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOpRm btn"] = AnaSnglMask_GridspecLayout[9, 42:49]
+        self.hs["AnaSnglMaskOpRm btn"].style.button_color = "darkviolet"
+
+        AnaSnglMask_GridspecLayout[:, 50:70] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOpSeq box"] = AnaSnglMask_GridspecLayout[:, 50:70]
+        self.hs["AnaSnglMaskOpSeq lbl"] = widgets.Label("Op Seq")
+        self.hs["AnaSnglMaskOpSeq sel"] = widgets.Select(
+            layout={"width": "90%", "height": "70%", "left": "5%"}, disabled=True
+        )
+        self.hs["AnaSnglMaskOpSeqZSli txt"] = widgets.BoundedIntText(
+            tooltip="Z Slice #",
             min=0,
             max=1,
             step=1,
-            layout={
-                'width': '60%',
-                'height': 'auto',
-                'left': '20%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskOpSeqPrev btn'] = widgets.Button(
-            description='Preview',
-            layout={
-                'width': '60%',
-                'height': 'auto',
-                'left': '20%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskOpSeqPrev btn'].style.button_color = 'darkviolet'
-        self.hs['AnaSnglMaskOpSeq box'].children = [
-            self.hs['AnaSnglMaskOpSeq lbl'], self.hs['AnaSnglMaskOpSeq sel'],
-            self.hs['AnaSnglMaskOpSeqZSli txt'],
-            self.hs['AnaSnglMaskOpSeqPrev btn']
+            layout={"width": "60%", "height": "auto", "left": "20%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOpSeqPrev btn"] = widgets.Button(
+            description="Preview",
+            layout={"width": "60%", "height": "auto", "left": "20%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskOpSeqPrev btn"].style.button_color = "darkviolet"
+        self.hs["AnaSnglMaskOpSeq box"].children = [
+            self.hs["AnaSnglMaskOpSeq lbl"],
+            self.hs["AnaSnglMaskOpSeq sel"],
+            self.hs["AnaSnglMaskOpSeqZSli txt"],
+            self.hs["AnaSnglMaskOpSeqPrev btn"],
         ]
 
         AnaSnglMask_GridspecLayout[7, 71:78] = widgets.Button(
-            description='=>',
-            tooltip='Make New Mask',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskAddName btn'] = AnaSnglMask_GridspecLayout[7,
-                                                                       71:78]
-        self.hs['AnaSnglMaskAddName btn'].style.button_color = 'darkviolet'
+            description="=>",
+            tooltip="Make New Mask",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskAddName btn"] = AnaSnglMask_GridspecLayout[7, 71:78]
+        self.hs["AnaSnglMaskAddName btn"].style.button_color = "darkviolet"
 
         AnaSnglMask_GridspecLayout[9, 71:78] = widgets.Button(
-            description='<=',
-            tooltip='Remove a Mask',
-            layout={
-                'width': '90%',
-                'height': '100%'
+            description="<=",
+            tooltip="Remove a Mask",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskRmName btn"] = AnaSnglMask_GridspecLayout[9, 71:78]
+        self.hs["AnaSnglMaskRmName btn"].style.button_color = "darkviolet"
+
+        AnaSnglMask_GridspecLayout[:, 79:99] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskName box"] = AnaSnglMask_GridspecLayout[:, 79:99]
+        self.hs["AnaSnglMaskName lbl"] = widgets.Label("Mask Names")
+        self.hs["AnaSnglMaskName sel"] = widgets.Select(
+            layout={"width": "90%", "height": "70%", "left": "5%"}, disabled=True
+        )
+        self.hs["AnaSnglMaskNamePH txt"] = widgets.Text(
+            layout={
+                "width": "60%",
+                "height": "auto",
+                "left": "20%",
+                "visibility": "hidden",
             },
-            disabled=True)
-        self.hs['AnaSnglMaskRmName btn'] = AnaSnglMask_GridspecLayout[9, 71:78]
-        self.hs['AnaSnglMaskRmName btn'].style.button_color = 'darkviolet'
-
-        AnaSnglMask_GridspecLayout[:, 79:99] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                            disabled=True)
-        self.hs['AnaSnglMaskName box'] = AnaSnglMask_GridspecLayout[:, 79:99]
-        self.hs['AnaSnglMaskName lbl'] = widgets.Label('Mask Names')
-        self.hs['AnaSnglMaskName sel'] = widgets.Select(layout={
-            'width': '90%',
-            'height': '70%',
-            'left': '5%'
-        },
-                                                        disabled=True)
-        self.hs['AnaSnglMaskNamePH txt'] = widgets.Text(layout={
-            'width': '60%',
-            'height': 'auto',
-            'left': '20%',
-            'visibility': 'hidden'
-        },
-                                                        disabled=True)
-        self.hs['AnaSnglMaskNameCfm btn'] = widgets.Button(
-            description='Confirm',
-            layout={
-                'width': '60%',
-                'height': 'auto',
-                'left': '20%'
-            },
-            disabled=True)
-        self.hs['AnaSnglMaskNameCfm btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaSnglMaskName box'].children = [
-            self.hs['AnaSnglMaskName lbl'], self.hs['AnaSnglMaskName sel'],
-            self.hs['AnaSnglMaskNamePH txt'], self.hs['AnaSnglMaskNameCfm btn']
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskNameCfm btn"] = widgets.Button(
+            description="Confirm",
+            layout={"width": "60%", "height": "auto", "left": "20%"},
+            disabled=True,
+        )
+        self.hs["AnaSnglMaskNameCfm btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaSnglMaskName box"].children = [
+            self.hs["AnaSnglMaskName lbl"],
+            self.hs["AnaSnglMaskName sel"],
+            self.hs["AnaSnglMaskNamePH txt"],
+            self.hs["AnaSnglMaskNameCfm btn"],
         ]
 
-        self.hs['AnaSnglMaskVarName drpn'].observe(
-            self.AnaSnglMaskVarName_drpn_chg, names='value')
-        self.hs['AnaSnglMaskOp drpn'].observe(self.AnaSnglMaskOp_drpn_chg,
-                                              names='value')
-        self.hs['AnaSnglMaskSpecName drpn'].observe(
-            self.AnaSnglMaskSpecName_drpn_chg, names='value')
-        self.hs['AnaSnglMaskOpHelp btn'].on_click(
-            self.AnaSnglMaskOpHelp_btn_clk)
-        self.hs['AnaSnglMaskOpRm btn'].on_click(self.AnaSnglMaskOpRm_btn_clk)
-        self.hs['AnaSnglMaskOpAdd btn'].on_click(self.AnaSnglMaskOpAdd_btn_clk)
-        self.hs['AnaSnglMaskOpSeqZSli txt'].observe(
-            self.AnaSnglMaskOpSeqZSli_txt_chg, names='value')
-        self.hs['AnaSnglMaskOpSeqPrev btn'].on_click(
-            self.AnaSnglMaskOpSeqPrev_btn_clk)
-        self.hs['AnaSnglMaskAddName btn'].on_click(
-            self.AnaSnglMaskAddName_btn_clk)
-        self.hs['AnaSnglMaskRmName btn'].on_click(
-            self.AnaSnglMaskRmName_btn_clk)
-        self.hs['AnaSnglMaskNameCfm btn'].on_click(
-            self.AnaSnglMaskNameCfm_btn_clk)
+        self.hs["AnaSnglMaskVarName drpn"].observe(
+            self.AnaSnglMaskVarName_drpn_chg, names="value"
+        )
+        self.hs["AnaSnglMaskOp drpn"].observe(
+            self.AnaSnglMaskOp_drpn_chg, names="value"
+        )
+        self.hs["AnaSnglMaskSpecName drpn"].observe(
+            self.AnaSnglMaskSpecName_drpn_chg, names="value"
+        )
+        self.hs["AnaSnglMaskOpHelp btn"].on_click(self.AnaSnglMaskOpHelp_btn_clk)
+        self.hs["AnaSnglMaskOpRm btn"].on_click(self.AnaSnglMaskOpRm_btn_clk)
+        self.hs["AnaSnglMaskOpAdd btn"].on_click(self.AnaSnglMaskOpAdd_btn_clk)
+        self.hs["AnaSnglMaskOpSeqZSli txt"].observe(
+            self.AnaSnglMaskOpSeqZSli_txt_chg, names="value"
+        )
+        self.hs["AnaSnglMaskOpSeqPrev btn"].on_click(self.AnaSnglMaskOpSeqPrev_btn_clk)
+        self.hs["AnaSnglMaskAddName btn"].on_click(self.AnaSnglMaskAddName_btn_clk)
+        self.hs["AnaSnglMaskRmName btn"].on_click(self.AnaSnglMaskRmName_btn_clk)
+        self.hs["AnaSnglMaskNameCfm btn"].on_click(self.AnaSnglMaskNameCfm_btn_clk)
         ## ## ## ## ## ## define single mask -- end
 
         ## ## ## ## ## ## combine multiple masks -- start
         AnaCombMask_GridspecLayout = widgets.GridspecLayout(
             17,
             100,
-            layout={
-                'width': '100%',
-                'height': f'{0.68 * (self.form_sz[0] - 136)}px'
-            })
-
-        AnaCombMask_GridspecLayout[:, :20] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                          disabled=True)
-        self.hs['AnaCombMaskVar box'] = AnaCombMask_GridspecLayout[:, :20]
-        self.hs['AnaCombMaskVar lbl'] = widgets.Label('Sel Mask')
-        self.hs['AnaCombMaskVar drpn'] = widgets.Dropdown(
-            tooltip='Select a Mask to Make a Combined Mask.',
-            options=self.hs['AnaSnglMaskName sel'].options,
-            layout={
-                'width': '90%',
-                'height': 'auto',
-                'left': '5%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskVarInfo txt'] = widgets.Textarea(layout={
-            'width': '90%',
-            'height': '60%',
-            'left': '5%'
-        },
-                                                             disabled=True)
-        self.hs['AnaCombMaskZSli txt'] = widgets.BoundedIntText(
-            tooltip='Z Slice #',
+            layout={"width": "100%", "height": f"{0.68 * (self.form_sz[0] - 136)}px"},
+        )
+
+        AnaCombMask_GridspecLayout[:, :20] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskVar box"] = AnaCombMask_GridspecLayout[:, :20]
+        self.hs["AnaCombMaskVar lbl"] = widgets.Label("Sel Mask")
+        self.hs["AnaCombMaskVar drpn"] = widgets.Dropdown(
+            tooltip="Select a Mask to Make a Combined Mask.",
+            options=self.hs["AnaSnglMaskName sel"].options,
+            layout={"width": "90%", "height": "auto", "left": "5%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskVarInfo txt"] = widgets.Textarea(
+            layout={"width": "90%", "height": "60%", "left": "5%"}, disabled=True
+        )
+        self.hs["AnaCombMaskZSli txt"] = widgets.BoundedIntText(
+            tooltip="Z Slice #",
             min=0,
             max=1,
             step=1,
-            layout={
-                'width': '60%',
-                'height': '6%',
-                'left': '20%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskPrev btn'] = widgets.Button(description='Preview',
-                                                        layout={
-                                                            'width': '60%',
-                                                            'height': '6%',
-                                                            'left': '20%',
-                                                            'top': '2%'
-                                                        },
-                                                        disabled=True)
-        self.hs['AnaCombMaskPrev btn'].style.button_color = 'darkviolet'
-        self.hs['AnaCombMaskVar box'].children = [
-            self.hs['AnaCombMaskVar lbl'], self.hs['AnaCombMaskVar drpn'],
-            self.hs['AnaCombMaskVarInfo txt'], self.hs['AnaCombMaskZSli txt'],
-            self.hs['AnaCombMaskPrev btn']
+            layout={"width": "60%", "height": "6%", "left": "20%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskPrev btn"] = widgets.Button(
+            description="Preview",
+            layout={"width": "60%", "height": "6%", "left": "20%", "top": "2%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskPrev btn"].style.button_color = "darkviolet"
+        self.hs["AnaCombMaskVar box"].children = [
+            self.hs["AnaCombMaskVar lbl"],
+            self.hs["AnaCombMaskVar drpn"],
+            self.hs["AnaCombMaskVarInfo txt"],
+            self.hs["AnaCombMaskZSli txt"],
+            self.hs["AnaCombMaskPrev btn"],
         ]
 
         AnaCombMask_GridspecLayout[7, 21:28] = widgets.Button(
-            description='=>',
-            tooltip='Add a Mask',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskVarAdd btn'] = AnaCombMask_GridspecLayout[7, 21:28]
-        self.hs['AnaCombMaskVarAdd btn'].style.button_color = 'darkviolet'
+            description="=>",
+            tooltip="Add a Mask",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskVarAdd btn"] = AnaCombMask_GridspecLayout[7, 21:28]
+        self.hs["AnaCombMaskVarAdd btn"].style.button_color = "darkviolet"
 
         AnaCombMask_GridspecLayout[9, 21:28] = widgets.Button(
-            description='<=',
-            tooltip='Remove a Mask',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskVarRm btn'] = AnaCombMask_GridspecLayout[9, 21:28]
-        self.hs['AnaCombMaskVarRm btn'].style.button_color = 'darkviolet'
-
-        AnaCombMask_GridspecLayout[:, 29:49] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                            disabled=True)
-        self.hs['AnaCombMaskList box'] = AnaCombMask_GridspecLayout[:, 29:49]
-        self.hs['AnaCombMasks lbl'] = widgets.Label('Mask List')
-        self.hs['AnaCombMaskOp drpn'] = widgets.Dropdown(
-            tooltip=
-            'Select an Operation on the Selected Single Mask to Make a Combined Mask.',
-            options=['', 'Complement (I-A)'],
-            value='',
-            layout={
-                'width': '90%',
-                'height': 'auto',
-                'left': '5%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskOpStps sel'] = widgets.Select(layout={
-            'width': '90%',
-            'height': '60%',
-            'left': '5%'
-        },
-                                                          disabled=True)
-        self.hs['AnaCombMasksPH txt'] = widgets.BoundedIntText(
-            tooltip='',
+            description="<=",
+            tooltip="Remove a Mask",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskVarRm btn"] = AnaCombMask_GridspecLayout[9, 21:28]
+        self.hs["AnaCombMaskVarRm btn"].style.button_color = "darkviolet"
+
+        AnaCombMask_GridspecLayout[:, 29:49] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskList box"] = AnaCombMask_GridspecLayout[:, 29:49]
+        self.hs["AnaCombMasks lbl"] = widgets.Label("Mask List")
+        self.hs["AnaCombMaskOp drpn"] = widgets.Dropdown(
+            tooltip="Select an Operation on the Selected Single Mask to Make a Combined Mask.",
+            options=["", "Complement (I-A)"],
+            value="",
+            layout={"width": "90%", "height": "auto", "left": "5%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskOpStps sel"] = widgets.Select(
+            layout={"width": "90%", "height": "60%", "left": "5%"}, disabled=True
+        )
+        self.hs["AnaCombMasksPH txt"] = widgets.BoundedIntText(
+            tooltip="",
             min=0,
             max=1,
             step=1,
             layout={
-                'width': '60%',
-                'height': '6%',
-                'left': '20%',
-                'visibility': 'hidden'
-            },
-            disabled=True)
-        self.hs['AnaCombMasksPrev btn'] = widgets.Button(description='Preview',
-                                                         layout={
-                                                             'width': '60%',
-                                                             'height': '6%',
-                                                             'left': '20%',
-                                                             'top': '2%'
-                                                         },
-                                                         disabled=True)
-        self.hs['AnaCombMasksPrev btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaCombMaskVar drpn'].observe(self.AnaCombMaskVar_drpn_chg,
-                                               names='value')
-        self.hs['AnaCombMaskZSli txt'].observe(self.AnaCombMaskZSli_txt_chg,
-                                               names='value')
-        self.hs['AnaCombMaskPrev btn'].on_click(self.AnaCombMaskPrev_btn_clk)
-        self.hs['AnaCombMaskVarAdd btn'].on_click(
-            self.AnaCombMaskVarAdd_btn_clk)
-        self.hs['AnaCombMaskVarRm btn'].on_click(self.AnaCombMaskVarRm_btn_clk)
-        self.hs['AnaCombMaskOp drpn'].observe(self.AnaCombMaskOp_drpn_chg,
-                                              names='value')
-        self.hs['AnaCombMasksPrev btn'].on_click(self.AnaCombMasksPrev_btn_clk)
-
-        self.hs['AnaCombMaskList box'].children = [
-            self.hs['AnaCombMasks lbl'], self.hs['AnaCombMaskOp drpn'],
-            self.hs['AnaCombMaskOpStps sel'], self.hs['AnaCombMasksPH txt'],
-            self.hs['AnaCombMasksPrev btn']
+                "width": "60%",
+                "height": "6%",
+                "left": "20%",
+                "visibility": "hidden",
+            },
+            disabled=True,
+        )
+        self.hs["AnaCombMasksPrev btn"] = widgets.Button(
+            description="Preview",
+            layout={"width": "60%", "height": "6%", "left": "20%", "top": "2%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMasksPrev btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaCombMaskVar drpn"].observe(
+            self.AnaCombMaskVar_drpn_chg, names="value"
+        )
+        self.hs["AnaCombMaskZSli txt"].observe(
+            self.AnaCombMaskZSli_txt_chg, names="value"
+        )
+        self.hs["AnaCombMaskPrev btn"].on_click(self.AnaCombMaskPrev_btn_clk)
+        self.hs["AnaCombMaskVarAdd btn"].on_click(self.AnaCombMaskVarAdd_btn_clk)
+        self.hs["AnaCombMaskVarRm btn"].on_click(self.AnaCombMaskVarRm_btn_clk)
+        self.hs["AnaCombMaskOp drpn"].observe(
+            self.AnaCombMaskOp_drpn_chg, names="value"
+        )
+        self.hs["AnaCombMasksPrev btn"].on_click(self.AnaCombMasksPrev_btn_clk)
+
+        self.hs["AnaCombMaskList box"].children = [
+            self.hs["AnaCombMasks lbl"],
+            self.hs["AnaCombMaskOp drpn"],
+            self.hs["AnaCombMaskOpStps sel"],
+            self.hs["AnaCombMasksPH txt"],
+            self.hs["AnaCombMasksPrev btn"],
         ]
 
         AnaCombMask_GridspecLayout[7, 50:57] = widgets.Button(
-            description='=>',
-            tooltip='Make New Mask',
-            layout={
-                'width': '90%',
-                'height': '100%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskAddName btn'] = AnaCombMask_GridspecLayout[7,
-                                                                       50:57]
-        self.hs['AnaCombMaskAddName btn'].style.button_color = 'darkviolet'
+            description="=>",
+            tooltip="Make New Mask",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskAddName btn"] = AnaCombMask_GridspecLayout[7, 50:57]
+        self.hs["AnaCombMaskAddName btn"].style.button_color = "darkviolet"
 
         AnaCombMask_GridspecLayout[9, 50:57] = widgets.Button(
-            description='<=',
-            tooltip='Remove a Mask',
-            layout={
-                'width': '90%',
-                'height': '100%'
+            description="<=",
+            tooltip="Remove a Mask",
+            layout={"width": "90%", "height": "100%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskRmName btn"] = AnaCombMask_GridspecLayout[9, 50:57]
+        self.hs["AnaCombMaskRmName btn"].style.button_color = "darkviolet"
+
+        AnaCombMask_GridspecLayout[:, 58:78] = widgets.VBox(
+            layout={"width": "100%", "height": "100%", "border": "1px solid #FFCC11"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskName box"] = AnaCombMask_GridspecLayout[:, 58:78]
+        self.hs["AnaCombMaskName lbl"] = widgets.Label("Mask Names")
+        self.hs["AnaCombMaskNamePH drpn"] = widgets.Dropdown(
+            layout={
+                "width": "90%",
+                "height": "auto",
+                "left": "5%",
+                "visibility": "hidden",
             },
-            disabled=True)
-        self.hs['AnaCombMaskRmName btn'] = AnaCombMask_GridspecLayout[9, 50:57]
-        self.hs['AnaCombMaskRmName btn'].style.button_color = 'darkviolet'
-
-        AnaCombMask_GridspecLayout[:, 58:78] = widgets.VBox(layout={
-            'width':
-            '100%',
-            'height':
-            '100%',
-            'border':
-            '1px solid #FFCC11'
-        },
-                                                            disabled=True)
-        self.hs['AnaCombMaskName box'] = AnaCombMask_GridspecLayout[:, 58:78]
-        self.hs['AnaCombMaskName lbl'] = widgets.Label('Mask Names')
-        self.hs['AnaCombMaskNamePH drpn'] = widgets.Dropdown(layout={
-            'width':
-            '90%',
-            'height':
-            'auto',
-            'left':
-            '5%',
-            'visibility':
-            'hidden'
-        },
-                                                             disabled=True)
-        self.hs['AnaCombMaskName sel'] = widgets.Select(layout={
-            'width': '90%',
-            'height': '60%',
-            'left': '5%'
-        },
-                                                        disabled=True)
-        self.hs['AnaCombMaskNamePH txt'] = widgets.Text(layout={
-            'width': '60%',
-            'height': 'auto',
-            'left': '20%',
-            'visibility': 'hidden'
-        },
-                                                        disabled=True)
-        self.hs['AnaCombMaskNameCfm btn'] = widgets.Button(
-            description='Confirm',
-            layout={
-                'width': '60%',
-                'height': '6%',
-                'left': '20%',
-                'top': '2%'
-            },
-            disabled=True)
-        self.hs['AnaCombMaskNameCfm btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaCombMaskName box'].children = [
-            self.hs['AnaCombMaskName lbl'], self.hs['AnaCombMaskNamePH drpn'],
-            self.hs['AnaCombMaskName sel'], self.hs['AnaCombMaskNamePH txt'],
-            self.hs['AnaCombMaskNameCfm btn']
+            disabled=True,
+        )
+        self.hs["AnaCombMaskName sel"] = widgets.Select(
+            layout={"width": "90%", "height": "60%", "left": "5%"}, disabled=True
+        )
+        self.hs["AnaCombMaskNamePH txt"] = widgets.Text(
+            layout={
+                "width": "60%",
+                "height": "auto",
+                "left": "20%",
+                "visibility": "hidden",
+            },
+            disabled=True,
+        )
+        self.hs["AnaCombMaskNameCfm btn"] = widgets.Button(
+            description="Confirm",
+            layout={"width": "60%", "height": "6%", "left": "20%", "top": "2%"},
+            disabled=True,
+        )
+        self.hs["AnaCombMaskNameCfm btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaCombMaskName box"].children = [
+            self.hs["AnaCombMaskName lbl"],
+            self.hs["AnaCombMaskNamePH drpn"],
+            self.hs["AnaCombMaskName sel"],
+            self.hs["AnaCombMaskNamePH txt"],
+            self.hs["AnaCombMaskNameCfm btn"],
         ]
 
-        self.hs['AnaCombMaskAddName btn'].on_click(
-            self.AnaCombMaskAddName_btn_clk)
-        self.hs['AnaCombMaskRmName btn'].on_click(
-            self.AnaCombMaskRmName_btn_clk)
-        self.hs['AnaCombMaskName sel'].observe(self.AnaCombMaskName_sel_chg,
-                                               names='value')
-        self.hs['AnaCombMaskNameCfm btn'].on_click(
-            self.AnaCombMaskNameCfm_btn_clk)
+        self.hs["AnaCombMaskAddName btn"].on_click(self.AnaCombMaskAddName_btn_clk)
+        self.hs["AnaCombMaskRmName btn"].on_click(self.AnaCombMaskRmName_btn_clk)
+        self.hs["AnaCombMaskName sel"].observe(
+            self.AnaCombMaskName_sel_chg, names="value"
+        )
+        self.hs["AnaCombMaskNameCfm btn"].on_click(self.AnaCombMaskNameCfm_btn_clk)
 
         AnaCombMask_GridspecLayout[8, 83:95] = widgets.Button(
-            description='Save Masks',
-            layout={
-                'width': '100%',
-                'height': '100%'
-            },
-            tooltip=
-            'Caution: this will OVERWRITE the generated masks with same names as ones in the current mask list that already exist in the selected h5 file.',
-            disabled=True)
-        self.hs['AnaMaskSav btn'] = AnaCombMask_GridspecLayout[8, 83:95]
-        self.hs['AnaMaskSav btn'].style.button_color = 'darkviolet'
+            description="Save Masks",
+            layout={"width": "100%", "height": "100%"},
+            tooltip="Caution: this will OVERWRITE the generated masks with same names as ones in the current mask list that already exist in the selected h5 file.",
+            disabled=True,
+        )
+        self.hs["AnaMaskSav btn"] = AnaCombMask_GridspecLayout[8, 83:95]
+        self.hs["AnaMaskSav btn"].style.button_color = "darkviolet"
 
-        self.hs['AnaMaskSav btn'].on_click(self.AnaMaskSav_btn_clk)
+        self.hs["AnaMaskSav btn"].on_click(self.AnaMaskSav_btn_clk)
         ## ## ## ## ## ## combine multiple masks -- end
 
-        self.hs['AnaMask acc'].children = [
-            AnaSnglMask_GridspecLayout, AnaCombMask_GridspecLayout
+        self.hs["AnaMask acc"].children = [
+            AnaSnglMask_GridspecLayout,
+            AnaCombMask_GridspecLayout,
         ]
 
-        self.hs['AnaMask acc'].set_title(0, 'Make A Single Mask')
-        self.hs['AnaMask acc'].set_title(1, 'Combine Masks')
-        self.hs['AnaMask acc'].selected_index = None
+        self.hs["AnaMask acc"].set_title(0, "Make A Single Mask")
+        self.hs["AnaMask acc"].set_title(1, "Combine Masks")
+        self.hs["AnaMask acc"].selected_index = None
 
-        self.hs['AnaMask tab'].children = [self.hs['AnaMask acc']]
+        self.hs["AnaMask tab"].children = [self.hs["AnaMask acc"]]
         ## ## ## ## ## preparing masks --end
 
         ## ## ## ## ##  config analysis -- start
         # self.hs['AnaConfig box'] = widgets.HBox()
-        self.hs['AnaAna acc'] = widgets.Accordion(
-            titles=['Config Data for Analysis', 'Config Analysis'],
-            layout={
-                'width': 'auto',
-                'height': 'auto'
-            })
+        self.hs["AnaAna acc"] = widgets.Accordion(
+            titles=["Config Data for Analysis", "Config Analysis"],
+            layout={"width": "auto", "height": "auto"},
+        )
 
         ## ## ## ## ## ## config data for analysis -- start
         self.AnaConfAnaData_GridSpecLayout = widgets.GridspecLayout(
             17,
             100,
-            layout={
-                'width': "100%",
-                "height": f'{0.68 * (self.form_sz[0] - 136)}px'
-            })
+            layout={"width": "100%", "height": f"{0.68 * (self.form_sz[0] - 136)}px"},
+        )
 
         self.AnaConfAnaData_GridSpecLayout[0, 20:45] = widgets.Dropdown(
-            description='ana spec',
-            tooltip='choose the spectrum data for further analysis',
+            description="ana spec",
+            tooltip="choose the spectrum data for further analysis",
             options=[],
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['AnaAnaSpec drpdn'] = self.AnaConfAnaData_GridSpecLayout[0,
-                                                                         20:45]
+            layout={"width": "95%"},
+        )
+        self.hs["AnaAnaSpec drpdn"] = self.AnaConfAnaData_GridSpecLayout[0, 20:45]
         self.AnaConfAnaData_GridSpecLayout[1:5, 20:45] = widgets.Textarea(
-            disabled=True, layout={
-                'width': '100%',
-                'height': '100%'
-            })
-        self.hs['AnaAnaSpecInfo txt'] = self.AnaConfAnaData_GridSpecLayout[
-            1:5, 20:45]
+            disabled=True, layout={"width": "100%", "height": "100%"}
+        )
+        self.hs["AnaAnaSpecInfo txt"] = self.AnaConfAnaData_GridSpecLayout[1:5, 20:45]
         self.AnaConfAnaData_GridSpecLayout[0, 55:80] = widgets.Dropdown(
-            description='ana mask',
-            tooltip=
-            'choose a mask for defining a region of interest for further analysis',
-            options=['None'],
-            disabled=True,
-            layout={'width': '95%'})
-        self.hs['AnaAnaMask drpdn'] = self.AnaConfAnaData_GridSpecLayout[0,
-                                                                         55:80]
+            description="ana mask",
+            tooltip="choose a mask for defining a region of interest for further analysis",
+            options=["None"],
+            disabled=True,
+            layout={"width": "95%"},
+        )
+        self.hs["AnaAnaMask drpdn"] = self.AnaConfAnaData_GridSpecLayout[0, 55:80]
         self.AnaConfAnaData_GridSpecLayout[1:5, 55:80] = widgets.Textarea(
-            disabled=True, layout={
-                'width': '100%',
-                'height': '100%'
-            })
-        self.hs['AnaAnaMaskInfo txt'] = self.AnaConfAnaData_GridSpecLayout[
-            1:5, 55:80]
+            disabled=True, layout={"width": "100%", "height": "100%"}
+        )
+        self.hs["AnaAnaMaskInfo txt"] = self.AnaConfAnaData_GridSpecLayout[1:5, 55:80]
         self.AnaConfAnaData_GridSpecLayout[6, 44:56] = widgets.Button(
-            description='Confirm',
+            description="Confirm",
             disabled=True,
-            layout={
-                'width': '100%',
-                'height': '100%'
-            })
-        self.hs['AnaAnaDataCfm btn'] = self.AnaConfAnaData_GridSpecLayout[
-            6, 44:56]
-        self.hs['AnaAnaDataCfm btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaAnaSpec drpdn'].observe(self.AnaAnaSpec_drpdn_chg,
-                                            names='value')
-        self.hs['AnaAnaMask drpdn'].observe(self.AnaAnaMask_drpdn_chg,
-                                            names='value')
-        self.hs['AnaAnaDataCfm btn'].on_click(self.AnaAnaDataCfm_btn_clk)
+            layout={"width": "100%", "height": "100%"},
+        )
+        self.hs["AnaAnaDataCfm btn"] = self.AnaConfAnaData_GridSpecLayout[6, 44:56]
+        self.hs["AnaAnaDataCfm btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaAnaSpec drpdn"].observe(self.AnaAnaSpec_drpdn_chg, names="value")
+        self.hs["AnaAnaMask drpdn"].observe(self.AnaAnaMask_drpdn_chg, names="value")
+        self.hs["AnaAnaDataCfm btn"].on_click(self.AnaAnaDataCfm_btn_clk)
         ## ## ## ## ## ## config data for analysis -- end
 
         ## ## ## ## ## ## config analysis -- start
         self.AnaConfAna_GridSpecLayout = widgets.GridspecLayout(
             17,
             100,
-            layout={
-                'width': '100%',
-                'height': f'{0.68 * (self.form_sz[0] - 136)}px'
-            })
+            layout={"width": "100%", "height": f"{0.68 * (self.form_sz[0] - 136)}px"},
+        )
         self.AnaConfAna_GridSpecLayout[0, 0:25] = widgets.Dropdown(
-            description='ana type',
-            tooltip='choose analysis to apply to the selected data',
-            options=[
-                'Preproc', 'Decomp', 'Classif', 'Regres', 'Cluster', 'Neighbor'
-            ],
-            value='Neighbor',
+            description="ana type",
+            tooltip="choose analysis to apply to the selected data",
+            options=["Preproc", "Decomp", "Classif", "Regres", "Cluster", "Neighbor"],
+            value="Neighbor",
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['AnaType drpdn'] = self.AnaConfAna_GridSpecLayout[0, 0:25]
+            layout={"width": "95%"},
+        )
+        self.hs["AnaType drpdn"] = self.AnaConfAna_GridSpecLayout[0, 0:25]
         self.AnaConfAna_GridSpecLayout[0, 25:50] = widgets.Dropdown(
-            description='ana method',
-            tooltip='choose analysis to apply to the selected data',
-            options=['KDE', 'PCA', 'KNN'],
-            value='KDE',
+            description="ana method",
+            tooltip="choose analysis to apply to the selected data",
+            options=["KDE", "PCA", "KNN"],
+            value="KDE",
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['AnaMethod drpdn'] = self.AnaConfAna_GridSpecLayout[0, 25:50]
+            layout={"width": "95%"},
+        )
+        self.hs["AnaMethod drpdn"] = self.AnaConfAna_GridSpecLayout[0, 25:50]
 
         for ii in range(2):
             for jj in range(4):
-                self.AnaConfAna_GridSpecLayout[ii+1, jj*25:(jj+1)*25] = \
-                    widgets.Dropdown(description = f'p{str(ii*4+jj).zfill(2)}',
-                                     value = 'linear',
-                                     options = ['linear'],
-                                     tooltip = f"analysis function variable {str(ii*4+jj).zfill(2)}",
-                                     layout = {'width': "95%"},
-                                     disabled=True)
-                self.hs[f'AnaConfigPars{ii*4+jj}'] = \
-                    self.AnaConfAna_GridSpecLayout[ii+1, jj*25:(jj+1)*25]
+                self.AnaConfAna_GridSpecLayout[ii + 1, jj * 25 : (jj + 1) * 25] = (
+                    widgets.Dropdown(
+                        description=f"p{str(ii*4+jj).zfill(2)}",
+                        value="linear",
+                        options=["linear"],
+                        tooltip=f"analysis function variable {str(ii*4+jj).zfill(2)}",
+                        layout={"width": "95%"},
+                        disabled=True,
+                    )
+                )
+                self.hs[f"AnaConfigPars{ii*4+jj}"] = self.AnaConfAna_GridSpecLayout[
+                    ii + 1, jj * 25 : (jj + 1) * 25
+                ]
 
         for ii in range(2, 4):
             for jj in range(4):
-                self.AnaConfAna_GridSpecLayout[ii+1, jj*25:(jj+1)*25] = \
-                    widgets.BoundedFloatText(description = f'p{str(ii*4+jj).zfill(2)}',
-                                             value = 0,
-                                             min = -1e5,
-                                             max = 1e5,
-                                             tooltip = f"analysis function variable {str(ii*4+jj).zfill(2)}",
-                                             layout = {'width': "95%"},
-                                             disabled=True)
-                self.hs[f'AnaConfigPars{ii*4+jj}'] = \
-                    self.AnaConfAna_GridSpecLayout[ii+1, jj*25:(jj+1)*25]
-
-        self.AnaConfAna_GridSpecLayout[6, 5:95] = \
-            widgets.IntProgress(value=0,
-                                min=0,
-                                max=100,
-                                step=1,
-                                description='Completing:',
-                                bar_style='info', # 'success', 'info', 'warning', 'danger' or ''
-                                orientation='horizontal',
-                                indent=False,
-                                layout={'width':'95%', 'height':'95%'})
-        self.hs['AnaConfigPrgr bar'] = \
-            self.AnaConfAna_GridSpecLayout[6, 5:95]
-
-        self.AnaConfAna_GridSpecLayout[7, 45:55] = \
-            widgets.Button(description='Compute',
-                           description_tip='Perform the analysis',
-                           disabled=True)
-        self.hs['AnaConfigCmpt btn'] = \
-            self.AnaConfAna_GridSpecLayout[7, 45:55]
-        self.hs['AnaConfigCmpt btn'].style.button_color = 'darkviolet'
-
-        self.hs['AnaType drpdn'].observe(self.AnaType_drpdn_chg, names='value')
-        self.hs['AnaMethod drpdn'].observe(self.AnaMeth_drpdn_chg,
-                                           names='value')
-        self.hs['AnaConfigPars0'].observe(self.AnaCnfgP0_chg, names='value')
-        self.hs['AnaConfigPars1'].observe(self.AnaCnfgP1_chg, names='value')
-        self.hs['AnaConfigPars2'].observe(self.AnaCnfgP2_chg, names='value')
-        self.hs['AnaConfigPars3'].observe(self.AnaCnfgP3_chg, names='value')
-        self.hs['AnaConfigPars4'].observe(self.AnaCnfgP4_chg, names='value')
-        self.hs['AnaConfigPars5'].observe(self.AnaCnfgP5_chg, names='value')
-        self.hs['AnaConfigPars6'].observe(self.AnaCnfgP6_chg, names='value')
-        self.hs['AnaConfigPars7'].observe(self.AnaCnfgP7_chg, names='value')
-        self.hs['AnaConfigCmpt btn'].on_click(self.AnaCnfgCmpt_btn_clk)
-        self.hs['AnaAna acc'].children = [
-            self.AnaConfAnaData_GridSpecLayout, self.AnaConfAna_GridSpecLayout
+                self.AnaConfAna_GridSpecLayout[ii + 1, jj * 25 : (jj + 1) * 25] = (
+                    widgets.BoundedFloatText(
+                        description=f"p{str(ii*4+jj).zfill(2)}",
+                        value=0,
+                        min=-1e5,
+                        max=1e5,
+                        tooltip=f"analysis function variable {str(ii*4+jj).zfill(2)}",
+                        layout={"width": "95%"},
+                        disabled=True,
+                    )
+                )
+                self.hs[f"AnaConfigPars{ii*4+jj}"] = self.AnaConfAna_GridSpecLayout[
+                    ii + 1, jj * 25 : (jj + 1) * 25
+                ]
+
+        self.AnaConfAna_GridSpecLayout[6, 5:95] = widgets.IntProgress(
+            value=0,
+            min=0,
+            max=100,
+            step=1,
+            description="Completing:",
+            bar_style="info",  # 'success', 'info', 'warning', 'danger' or ''
+            orientation="horizontal",
+            indent=False,
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["AnaConfigPrgr bar"] = self.AnaConfAna_GridSpecLayout[6, 5:95]
+
+        self.AnaConfAna_GridSpecLayout[7, 45:55] = widgets.Button(
+            description="Compute", description_tip="Perform the analysis", disabled=True
+        )
+        self.hs["AnaConfigCmpt btn"] = self.AnaConfAna_GridSpecLayout[7, 45:55]
+        self.hs["AnaConfigCmpt btn"].style.button_color = "darkviolet"
+
+        self.hs["AnaType drpdn"].observe(self.AnaType_drpdn_chg, names="value")
+        self.hs["AnaMethod drpdn"].observe(self.AnaMeth_drpdn_chg, names="value")
+        self.hs["AnaConfigPars0"].observe(self.AnaCnfgP0_chg, names="value")
+        self.hs["AnaConfigPars1"].observe(self.AnaCnfgP1_chg, names="value")
+        self.hs["AnaConfigPars2"].observe(self.AnaCnfgP2_chg, names="value")
+        self.hs["AnaConfigPars3"].observe(self.AnaCnfgP3_chg, names="value")
+        self.hs["AnaConfigPars4"].observe(self.AnaCnfgP4_chg, names="value")
+        self.hs["AnaConfigPars5"].observe(self.AnaCnfgP5_chg, names="value")
+        self.hs["AnaConfigPars6"].observe(self.AnaCnfgP6_chg, names="value")
+        self.hs["AnaConfigPars7"].observe(self.AnaCnfgP7_chg, names="value")
+        self.hs["AnaConfigCmpt btn"].on_click(self.AnaCnfgCmpt_btn_clk)
+        self.hs["AnaAna acc"].children = [
+            self.AnaConfAnaData_GridSpecLayout,
+            self.AnaConfAna_GridSpecLayout,
         ]
-        self.hs['AnaAna acc'].set_title(0, 'Config Data for Analysis')
-        self.hs['AnaAna acc'].set_title(1, 'Config Analysis')
-        self.hs['AnaAna acc'].selected_index = None
+        self.hs["AnaAna acc"].set_title(0, "Config Data for Analysis")
+        self.hs["AnaAna acc"].set_title(1, "Config Analysis")
+        self.hs["AnaAna acc"].selected_index = None
         ## ## ## ## ## ## config analysis -- end
 
         # self.hs['AnaConf tab'].children = [self.hs['AnaConfig box']]
-        self.hs['AnaConf tab'].children = [self.hs['AnaAna acc']]
+        self.hs["AnaConf tab"].children = [self.hs["AnaAna acc"]]
         ## ## ## ## ## config analysis -- end
 
         ## ## ## ## ##  result display -- start
-        self.hs['AnaDataDisp box'] = widgets.HBox()
+        self.hs["AnaDataDisp box"] = widgets.HBox()
         ## ## ## ## ##  result display -- end
 
     def boxes_logic(self):
 
         def component_logic():
-            if (self.ana_data_cnfged & (not self.ana_mask_sngl_op_seled)):
+            if self.ana_data_cnfged & (not self.ana_mask_sngl_op_seled):
                 boxes = [
-                    'AnaSnglMaskOpSeq box', 'AnaSnglMaskAddName btn',
-                    'AnaSnglMaskRmName btn', 'AnaSnglMaskName box'
+                    "AnaSnglMaskOpSeq box",
+                    "AnaSnglMaskAddName btn",
+                    "AnaSnglMaskRmName btn",
+                    "AnaSnglMaskName box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            elif (self.ana_data_cnfged & self.ana_mask_sngl_op_seled):
+            elif self.ana_data_cnfged & self.ana_mask_sngl_op_seled:
                 boxes = [
-                    'AnaSnglMaskOpSeq box', 'AnaSnglMaskAddName btn',
-                    'AnaSnglMaskRmName btn', 'AnaSnglMaskName box'
+                    "AnaSnglMaskOpSeq box",
+                    "AnaSnglMaskAddName btn",
+                    "AnaSnglMaskRmName btn",
+                    "AnaSnglMaskName box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-            if ((self.ana_data_cnfged & self.ana_mask_sngl_op_seled) &
-                (len(self.hs['AnaSnglMaskName sel'].options) == 0)):
-                boxes = ['AnaSnglMaskNameCfm btn']
+            if (self.ana_data_cnfged & self.ana_mask_sngl_op_seled) & (
+                len(self.hs["AnaSnglMaskName sel"].options) == 0
+            ):
+                boxes = ["AnaSnglMaskNameCfm btn"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            elif ((self.ana_data_cnfged & self.ana_mask_sngl_op_seled) &
-                  (len(self.hs['AnaSnglMaskName sel'].options) > 0)):
-                boxes = ['AnaSnglMaskNameCfm btn']
+            elif (self.ana_data_cnfged & self.ana_mask_sngl_op_seled) & (
+                len(self.hs["AnaSnglMaskName sel"].options) > 0
+            ):
+                boxes = ["AnaSnglMaskNameCfm btn"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-            if (self.ana_mask_sngl_cnfged &
-                (len(self.hs["AnaCombMaskOpStps sel"].options) == 0)):
+            if self.ana_mask_sngl_cnfged & (
+                len(self.hs["AnaCombMaskOpStps sel"].options) == 0
+            ):
                 boxes = [
-                    'AnaCombMasksPrev btn', 'AnaCombMaskAddName btn',
-                    'AnaCombMaskRmName btn', 'AnaCombMaskName box'
+                    "AnaCombMasksPrev btn",
+                    "AnaCombMaskAddName btn",
+                    "AnaCombMaskRmName btn",
+                    "AnaCombMaskName box",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-                boxes = ['AnaMaskSav btn']
+                boxes = ["AnaMaskSav btn"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-            elif (self.ana_mask_sngl_cnfged &
-                  (len(self.hs["AnaCombMaskOpStps sel"].options) > 0)):
+            elif self.ana_mask_sngl_cnfged & (
+                len(self.hs["AnaCombMaskOpStps sel"].options) > 0
+            ):
                 boxes = [
-                    'AnaCombMasksPrev btn', 'AnaCombMaskAddName btn',
-                    'AnaCombMaskRmName btn'
+                    "AnaCombMasksPrev btn",
+                    "AnaCombMaskAddName btn",
+                    "AnaCombMaskRmName btn",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-                if len(self.hs['AnaCombMaskName sel'].options) == 0:
-                    boxes = ['AnaCombMaskName box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                if len(self.hs["AnaCombMaskName sel"].options) == 0:
+                    boxes = ["AnaCombMaskName box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 else:
-                    boxes = ['AnaCombMaskName box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    boxes = ["AnaCombMaskName box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             if self.ana_ana_data_cnfged:
                 for ii in self.AnaConfAna_GridSpecLayout.children:
                     ii.disabled = False
             else:
                 for ii in self.AnaConfAna_GridSpecLayout.children:
                     ii.disabled = True
 
-        if ((not self.ana_fn_seled) or (not self.ana_data_existed)):
-            boxes = [
-                'AnaData tab', 'AnaMask tab', 'AnaConf tab', 'AnaDisp tab'
-            ]
+        if (not self.ana_fn_seled) or (not self.ana_data_existed):
+            boxes = ["AnaData tab", "AnaMask tab", "AnaConf tab", "AnaDisp tab"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            boxes = ['AnaDataFn btn']
+            boxes = ["AnaDataFn btn"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-        elif ((self.ana_fn_seled & self.ana_data_existed) &
-              (not self.ana_data_cnfged)):
-            boxes = ['AnaMask tab', 'AnaDisp tab']
+        elif (self.ana_fn_seled & self.ana_data_existed) & (not self.ana_data_cnfged):
+            boxes = ["AnaMask tab", "AnaDisp tab"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            boxes = ['AnaData tab', 'AnaConf tab']
+            boxes = ["AnaData tab", "AnaConf tab"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-        elif ((self.ana_fn_seled & self.ana_data_existed) &
-              (self.ana_data_cnfged & (not self.ana_mask_sngl_cnfged))):
-            boxes = ['AnaMask tab', 'AnaDisp tab']
+        elif (self.ana_fn_seled & self.ana_data_existed) & (
+            self.ana_data_cnfged & (not self.ana_mask_sngl_cnfged)
+        ):
+            boxes = ["AnaMask tab", "AnaDisp tab"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
             boxes = [
-                'AnaData tab', 'AnaSnglMaskVarName box', 'AnaSnglMaskOp box',
-                'AnaSnglMaskOpAdd btn', 'AnaSnglMaskOpRm btn', 'AnaConf tab'
+                "AnaData tab",
+                "AnaSnglMaskVarName box",
+                "AnaSnglMaskOp box",
+                "AnaSnglMaskOpAdd btn",
+                "AnaSnglMaskOpRm btn",
+                "AnaConf tab",
             ]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             self.set_single_mask_op(reset=False)
-        elif ((self.ana_fn_seled & self.ana_data_existed) &
-              (self.ana_data_cnfged & self.ana_mask_sngl_cnfged) &
-              (not self.ana_mask_cnfged)):
-            boxes = ['AnaDisp tab']
+        elif (
+            (self.ana_fn_seled & self.ana_data_existed)
+            & (self.ana_data_cnfged & self.ana_mask_sngl_cnfged)
+            & (not self.ana_mask_cnfged)
+        ):
+            boxes = ["AnaDisp tab"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            boxes = ['AnaData tab', 'AnaMask tab', 'AnaConf tab']
+            boxes = ["AnaData tab", "AnaMask tab", "AnaConf tab"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             self.set_single_mask_op(reset=False)
-        elif ((self.ana_fn_seled & self.ana_data_existed) &
-              (self.ana_data_cnfged & self.ana_mask_cnfged) &
-              (not self.ana_proc_done)):
-            boxes = ['AnaDisp tab']
+        elif (
+            (self.ana_fn_seled & self.ana_data_existed)
+            & (self.ana_data_cnfged & self.ana_mask_cnfged)
+            & (not self.ana_proc_done)
+        ):
+            boxes = ["AnaDisp tab"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-            boxes = ['AnaData tab', 'AnaMask tab', 'AnaConf tab']
+            boxes = ["AnaData tab", "AnaMask tab", "AnaConf tab"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-        elif ((self.ana_fn_seled & self.ana_data_existed) &
-              (self.ana_data_cnfged & self.ana_mask_cnfged) &
-              (self.ana_proc_done)):
-            boxes = [
-                'AnaData tab', 'AnaMask tab', 'AnaConf tab', 'AnaDisp tab'
-            ]
+        elif (
+            (self.ana_fn_seled & self.ana_data_existed)
+            & (self.ana_data_cnfged & self.ana_mask_cnfged)
+            & (self.ana_proc_done)
+        ):
+            boxes = ["AnaData tab", "AnaMask tab", "AnaConf tab", "AnaDisp tab"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
         component_logic()
         self.lock_message_text_boxes()
 
     def set_single_mask_op(self, reset=False):
-        boxes = [f'AnaSnglMaskOpPar{str(ii).zfill(2)} box' for ii in range(8)]
+        boxes = [f"AnaSnglMaskOpPar{str(ii).zfill(2)} box" for ii in range(8)]
         enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-        op = self.hs['AnaSnglMaskOp drpn'].value
-        self.hs[
-            'AnaSnglMaskOp drpn'].tooltip = xanes_analysis_gui.MASK_OP_PAR_DICT[
-                op]['description']
-        for key in xanes_analysis_gui.MASK_OP_PAR_DICT[op][
-                'default_pars'].keys():
+        op = self.hs["AnaSnglMaskOp drpn"].value
+        self.hs["AnaSnglMaskOp drpn"].tooltip = xanes_analysis_gui.MASK_OP_PAR_DICT[op][
+            "description"
+        ]
+        for key in xanes_analysis_gui.MASK_OP_PAR_DICT[op]["default_pars"].keys():
             if reset:
                 self.hs[key].value = xanes_analysis_gui.MASK_OP_PAR_DICT[op][
-                    'default_pars'][key]['val']
+                    "default_pars"
+                ][key]["val"]
                 self.hs[key].tooltip = xanes_analysis_gui.MASK_OP_PAR_DICT[op][
-                    'default_pars'][key]['tooltip']
+                    "default_pars"
+                ][key]["tooltip"]
             self.hs[key].disabled = False
 
     def prep_sngl_mask(self, mk_name, idx=0, confirmed=True):
-        """ 
-        According to the selected fitting data and a sequence of operations to make a mask. Including all such masks in 
+        """
+        According to the selected fitting data and a sequence of operations to make a mask. Including all such masks in
         singled mask collection dictionary structure:
         self.ana_mask_sngl = {key: <mask name>
                                   {key: str <var_name: variable name in string>,
                                    key: dictionary <op: operation sequence>,
                                         {key: int <operation order>
                                               {key: str <flt_name: filter's name>,
                                                key: dictionary <pars: filter function parameters>}}}}
         """
         if confirmed:
-            mask = self.ana_data[self.ana_mask_sngl[mk_name]['var_name']]
-            op = self.ana_mask_sngl[mk_name]['op']
-            spec = self.ana_spec[self.hs['AnaSnglMaskSpecName drpn'].value]
-            info = ''
+            mask = self.ana_data[self.ana_mask_sngl[mk_name]["var_name"]]
+            op = self.ana_mask_sngl[mk_name]["op"]
+            spec = self.ana_spec[self.hs["AnaSnglMaskSpecName drpn"].value]
+            info = ""
             for k0 in op.keys():
-                info = info + op[k0]['flt_name'] + ':' + str(
-                    [f'{k1}: {i1},'
-                     for k1, i1 in op[k0]['pars'].items()]) + '\n'
-            if ((len(mask.shape) == 3) & (idx != -1)):
-                idx = self.hs['AnaSnglMaskOpSeqZSli txt'].value
+                info = (
+                    info
+                    + op[k0]["flt_name"]
+                    + ":"
+                    + str([f"{k1}: {i1}," for k1, i1 in op[k0]["pars"].items()])
+                    + "\n"
+                )
+            if (len(mask.shape) == 3) & (idx != -1):
+                idx = self.hs["AnaSnglMaskOpSeqZSli txt"].value
                 mask = mask[idx]
                 spec = spec[idx]
             for key in sorted(op.keys()):
-                flt = xanes_analysis_gui.MASK_OP_PAR_DICT[op[key]
-                                                          ['flt_name']]['flt']
-                mask = flt(mask, **op[key]['pars'])
+                flt = xanes_analysis_gui.MASK_OP_PAR_DICT[op[key]["flt_name"]]["flt"]
+                mask = flt(mask, **op[key]["pars"])
         else:
-            shp = self.ana_data[self.hs['AnaSnglMaskVarName drpn'].value].shape
-            mask = self.ana_data[self.hs['AnaSnglMaskVarName drpn'].value]
-            spec = self.ana_data[self.hs['AnaSnglMaskSpecName drpn'].value]
-            if ((len(shp) == 3) & (idx != -1)):
-                idx = self.hs['AnaSnglMaskOpSeqZSli txt'].value
+            shp = self.ana_data[self.hs["AnaSnglMaskVarName drpn"].value].shape
+            mask = self.ana_data[self.hs["AnaSnglMaskVarName drpn"].value]
+            spec = self.ana_data[self.hs["AnaSnglMaskSpecName drpn"].value]
+            if (len(shp) == 3) & (idx != -1):
+                idx = self.hs["AnaSnglMaskOpSeqZSli txt"].value
                 mask = mask[idx]
                 spec = spec[idx]
             for key in sorted(self.ana_mask_sngl_op.keys()):
                 flt = xanes_analysis_gui.MASK_OP_PAR_DICT[
-                    self.ana_mask_sngl_op[key]['flt_name']]['flt']
-                mask = flt(mask, **self.ana_mask_sngl_op[key]['pars'])
+                    self.ana_mask_sngl_op[key]["flt_name"]
+                ]["flt"]
+                mask = flt(mask, **self.ana_mask_sngl_op[key]["pars"])
         return mask, spec
 
     def prep_comb_mask(self, mk_name, idx=0, confirmed=True):
-        """ 
+        """
         combined mask collection dictionary structure:
         self.ana_mask_sngl = {
             key: <mask name> {
                 key: str <var_name: variable name in string>,
                 key: dictionary <op: operation sequence> {
                     key: int <operation order> {
                         key: str <flt_name: filter's name>,
@@ -1606,452 +1423,528 @@
             }
         }
         """
         if confirmed:
             op = self.ana_mask_comb[mk_name]["op"]
             for key in sorted(op.keys()):
                 B_name = op[key]["B name"]
-                if key == '0':
-                    mask = self.ana_mask[B_name]['mask']
+                if key == "0":
+                    mask = self.ana_mask[B_name]["mask"]
                 elif op[key]["op"] == "Complement (I-A)":
                     flt = xanes_analysis_gui.SET_OP_DICT[op[key]["op"]]["flt"]
                     mask = flt(mask)
                     # mask = xpa.set_complement(mask)
                 else:
                     flt = xanes_analysis_gui.SET_OP_DICT[op[key]["op"]]["flt"]
-                    mask = flt(mask, self.ana_mask[B_name]['mask'])
+                    mask = flt(mask, self.ana_mask[B_name]["mask"])
             return mask.astype(np.int8)
         else:
             for key in sorted(self.ana_mask_comb_op.keys()):
                 B_name = self.ana_mask_comb_op[key]["B name"]
-                if key == '0':
-                    mask = self.ana_mask[B_name]['mask']
+                if key == "0":
+                    mask = self.ana_mask[B_name]["mask"]
                 elif self.ana_mask_comb_op[key]["op"] == "Complement (I-A)":
                     flt = xanes_analysis_gui.SET_OP_DICT[
-                        self.ana_mask_comb_op[key]["op"]]["flt"]
+                        self.ana_mask_comb_op[key]["op"]
+                    ]["flt"]
                     mask = flt(mask)
                 else:
                     flt = xanes_analysis_gui.SET_OP_DICT[
-                        self.ana_mask_comb_op[key]["op"]]["flt"]
-                    mask = flt(mask, self.ana_mask[B_name]['mask'])
+                        self.ana_mask_comb_op[key]["op"]
+                    ]["flt"]
+                    mask = flt(mask, self.ana_mask[B_name]["mask"])
             return mask.astype(np.int8)
 
     def AnaDataFn_btn_clk(self, a):
         if len(a.files[0]) != 0:
             self.ana_fn_seled = True
-            self.ana_fn = os.path.abspath(a.files[0])
+            # self.ana_fn = os.path.abspath(a.files[0])
+            self.ana_fn = str(Path(a.files[0]).absolute())
             self.ana_data_existed = False
+            # update_json_content(
+            #     self.parent_h.global_h.GUI_cfg_file,
+            #     {"cwd": os.path.dirname(os.path.abspath(a.files[0]))},
+            # )
+            # self.parent_h.global_h.cwd = os.path.dirname(os.path.abspath(a.files[0]))
             update_json_content(
                 self.parent_h.global_h.GUI_cfg_file,
-                {'cwd': os.path.dirname(os.path.abspath(a.files[0]))})
-            self.parent_h.global_h.cwd = os.path.dirname(
-                os.path.abspath(a.files[0]))
-            with h5py.File(self.ana_fn, 'r') as f:
+                {"cwd": str(Path(a.files[0]).absolute().parent)},
+            )
+            self.parent_h.global_h.cwd = str(Path(a.files[0]).absolute().parent)
+            with h5py.File(self.ana_fn, "r") as f:
                 self.ana_proc_data_list = []
                 for key in f.keys():
-                    if 'processed_XANES' in key:
-                        self.ana_proc_spec_path_in_h5 = '/' + key + '/proc_spectrum'
+                    if "processed_XANES" in key:
+                        self.ana_proc_spec_path_in_h5 = "/" + key + "/proc_spectrum"
                         self.ana_proc_data_list = list(
-                            f[self.ana_proc_spec_path_in_h5].keys())
+                            f[self.ana_proc_spec_path_in_h5].keys()
+                        )
                         self.ana_data_existed = True
             if self.ana_data_existed:
                 self.ana_spec_list = []
                 for key in self.ana_proc_data_list:
                     if key in [
-                            'wl_pos_fit', 'wl_pos_dir', 'edge50_pos_fit',
-                            'edge50_pos_dir', 'edge_pos_fit', 'edge_pos_dir'
+                        "wl_pos_fit",
+                        "wl_pos_dir",
+                        "edge50_pos_fit",
+                        "edge50_pos_dir",
+                        "edge_pos_fit",
+                        "edge_pos_dir",
                     ]:
                         self.ana_spec_list.append(key)
+                        # self.ana_spec[key] = h5_lazy_reader(
+                        #     self.ana_fn,
+                        #     os.path.join(self.ana_proc_spec_path_in_h5, key),
+                        #     np.s_[:],
+                        # )
                         self.ana_spec[key] = h5_lazy_reader(
                             self.ana_fn,
-                            os.path.join(self.ana_proc_spec_path_in_h5, key),
-                            np.s_[:])
+                            str(Path(self.ana_proc_spec_path_in_h5) / key),
+                            np.s_[:],
+                        )
                 for key in self.ana_proc_data_list:
+                    # self.ana_data[key] = h5_lazy_reader(
+                    #     self.ana_fn,
+                    #     os.path.join(self.ana_proc_spec_path_in_h5, key),
+                    #     np.s_[:],
+                    # )
                     self.ana_data[key] = h5_lazy_reader(
                         self.ana_fn,
-                        os.path.join(self.ana_proc_spec_path_in_h5, key),
-                        np.s_[:])
-                self.hs['AnaDataFn txt'].value = self.ana_fn
+                        str(Path(self.ana_proc_spec_path_in_h5) / key),
+                        np.s_[:],
+                    )
+                self.hs["AnaDataFn txt"].value = self.ana_fn
             else:
                 self.ana_proc_data_list = []
                 self.ana_spec_list = []
-            self.hs['AnaAvaiDatasets sel'].options = self.ana_proc_data_list
-            self.hs['AnaSnglMaskSpecName drpn'].options = self.ana_spec_list
-            self.hs['AnaAnaSpec drpdn'].options = self.ana_spec_list
+            self.hs["AnaAvaiDatasets sel"].options = self.ana_proc_data_list
+            self.hs["AnaSnglMaskSpecName drpn"].options = self.ana_spec_list
+            self.hs["AnaAnaSpec drpdn"].options = self.ana_spec_list
             if len(self.ana_spec_list) != 0:
-                self.hs['AnaSnglMaskSpecName drpn'].index = 0
-                self.hs['AnaAnaSpec drpdn'].index = 0
-            self.hs['AnaAnaMask drpdn'].options = ['None']
+                self.hs["AnaSnglMaskSpecName drpn"].index = 0
+                self.hs["AnaAnaSpec drpdn"].index = 0
+            self.hs["AnaAnaMask drpdn"].options = ["None"]
         else:
             self.ana_fn_seled = False
             self.ana_proc_data_list = []
-            self.hs['AnaAvaiDatasets sel'].options = self.ana_proc_data_list
-            self.hs['AnaAvaiDatasets sel'].value = self.ana_proc_data_list[0]
+            self.hs["AnaAvaiDatasets sel"].options = self.ana_proc_data_list
+            self.hs["AnaAvaiDatasets sel"].value = self.ana_proc_data_list[0]
         self.boxes_logic()
 
     def AnaAvaiDatasets_sel_chg(self, a):
-        with h5py.File(self.ana_fn, 'r') as f:
+        with h5py.File(self.ana_fn, "r") as f:
             try:
-                shape = f[self.ana_proc_spec_path_in_h5 + '/' +
-                          self.hs['AnaAvaiDatasets sel'].value].shape
+                shape = f[
+                    self.ana_proc_spec_path_in_h5
+                    + "/"
+                    + self.hs["AnaAvaiDatasets sel"].value
+                ].shape
             except:
                 shape = None
             try:
-                dmin = np.min(f[self.ana_proc_spec_path_in_h5 + '/' +
-                                self.hs['AnaAvaiDatasets sel'].value])
+                dmin = np.min(
+                    f[
+                        self.ana_proc_spec_path_in_h5
+                        + "/"
+                        + self.hs["AnaAvaiDatasets sel"].value
+                    ]
+                )
             except:
                 dmin = None
             try:
-                dmax = np.max(f[self.ana_proc_spec_path_in_h5 + '/' +
-                                self.hs['AnaAvaiDatasets sel'].value])
+                dmax = np.max(
+                    f[
+                        self.ana_proc_spec_path_in_h5
+                        + "/"
+                        + self.hs["AnaAvaiDatasets sel"].value
+                    ]
+                )
             except:
                 dmax = None
             try:
-                mean = np.mean(f[self.ana_proc_spec_path_in_h5 + '/' +
-                                 self.hs['AnaAvaiDatasets sel'].value])
+                mean = np.mean(
+                    f[
+                        self.ana_proc_spec_path_in_h5
+                        + "/"
+                        + self.hs["AnaAvaiDatasets sel"].value
+                    ]
+                )
             except:
                 mean = None
 
             try:
-                with self.hs['AnaDataHist plt']:
+                with self.hs["AnaDataHist plt"]:
                     # plot histogram of the selected dataset in this canvas with plt.hist()
                     pass
             except:
                 pass
-        self.hs['AnaDatasetInfo txt'].value = 'shape: ' + str(shape) + '\n' +\
-                                              'min: ' + str(dmin) + '\n' +\
-                                              'max: ' +str(dmax) + '\n' +\
-                                              'mean: ' +str(mean)
+        self.hs["AnaDatasetInfo txt"].value = (
+            "shape: "
+            + str(shape)
+            + "\n"
+            + "min: "
+            + str(dmin)
+            + "\n"
+            + "max: "
+            + str(dmax)
+            + "\n"
+            + "mean: "
+            + str(mean)
+        )
         self.boxes_logic()
 
     def AnaSelDatasetAdd_btn_clk(self, a):
-        seled_ds = list(self.hs['AnaSelVars sel'].options)
-        new_ds = self.hs['AnaAvaiDatasets sel'].value
+        seled_ds = list(self.hs["AnaSelVars sel"].options)
+        new_ds = self.hs["AnaAvaiDatasets sel"].value
         if new_ds not in seled_ds:
             seled_ds.append(new_ds)
-            eqn = ['=' for ii in range(len(seled_ds))]
+            eqn = ["=" for ii in range(len(seled_ds))]
 
-            self.hs['AnaVarName sel'].options = seled_ds
-            self.hs['AnaVarsEq sel'].options = eqn
-            self.hs['AnaSelVars sel'].options = seled_ds
-            self.hs['AnaSelVars sel'].value = new_ds
-            self.hs['AnaSnglMaskVarName drpn'].options = self.hs[
-                'AnaVarName sel'].options
-            self.hs['AnaSnglMaskVarName drpn'].value = self.hs[
-                'AnaVarName sel'].value
-        if len(self.hs['AnaSelVars sel'].options) != 0:
+            self.hs["AnaVarName sel"].options = seled_ds
+            self.hs["AnaVarsEq sel"].options = eqn
+            self.hs["AnaSelVars sel"].options = seled_ds
+            self.hs["AnaSelVars sel"].value = new_ds
+            self.hs["AnaSnglMaskVarName drpn"].options = self.hs[
+                "AnaVarName sel"
+            ].options
+            self.hs["AnaSnglMaskVarName drpn"].value = self.hs["AnaVarName sel"].value
+        if len(self.hs["AnaSelVars sel"].options) != 0:
             self.ana_data_cnfged = True
         else:
             self.ana_data_cnfged = False
         self.boxes_logic()
 
     def AnaSelDatasetRm_btn_clk(self, a):
-        seled_ds = list(self.hs['AnaSelVars sel'].options)
-        vars_nm = list(self.hs['AnaVarName sel'].options)
-        eqn = list(self.hs['AnaVarsEq sel'].options)
-        idx = seled_ds.index(self.hs['AnaSelVars sel'].value)
+        seled_ds = list(self.hs["AnaSelVars sel"].options)
+        vars_nm = list(self.hs["AnaVarName sel"].options)
+        eqn = list(self.hs["AnaVarsEq sel"].options)
+        idx = seled_ds.index(self.hs["AnaSelVars sel"].value)
 
         self.ana_data.pop(seled_ds[idx])
         seled_ds.pop(idx)
         vars_nm.pop(idx)
         eqn.pop(idx)
 
-        self.hs['AnaVarName sel'].options = vars_nm
-        self.hs['AnaVarsEq sel'].options = eqn
-        self.hs['AnaSelVars sel'].options = seled_ds
-        self.hs['AnaSnglMaskVarName drpn'].options = self.hs[
-            'AnaVarName sel'].options
-        self.hs['AnaSnglMaskVarName drpn'].value = self.hs[
-            'AnaVarName sel'].value
-        if len(self.hs['AnaSelVars sel'].options) != 0:
+        self.hs["AnaVarName sel"].options = vars_nm
+        self.hs["AnaVarsEq sel"].options = eqn
+        self.hs["AnaSelVars sel"].options = seled_ds
+        self.hs["AnaSnglMaskVarName drpn"].options = self.hs["AnaVarName sel"].options
+        self.hs["AnaSnglMaskVarName drpn"].value = self.hs["AnaVarName sel"].value
+        if len(self.hs["AnaSelVars sel"].options) != 0:
             self.ana_data_cnfged = True
         else:
             self.ana_data_cnfged = False
         self.boxes_logic()
 
     def AnaSelVars_sel_chg(self, a):
-        if self.hs['AnaSelVars sel'].value is not None:
-            seled_ds = list(self.hs['AnaSelVars sel'].options)
-            idx = seled_ds.index(self.hs['AnaSelVars sel'].value)
-            self.hs['AnaVarName sel'].index = idx
-            self.hs['AnaVarsEq sel'].index = idx
+        if self.hs["AnaSelVars sel"].value is not None:
+            seled_ds = list(self.hs["AnaSelVars sel"].options)
+            idx = seled_ds.index(self.hs["AnaSelVars sel"].value)
+            self.hs["AnaVarName sel"].index = idx
+            self.hs["AnaVarsEq sel"].index = idx
             self.ana_data_cnfged = True
             self.ana_mask_sngl_op_seled = False
         else:
             self.ana_data_cnfged = False
             self.ana_mask_sngl_op_seled = False
         self.boxes_logic()
 
     def AnaSelDatasetPrev_btn_clk(self, a):
-        if self.viewer_type == 'napari':
+        if self.viewer_type == "napari":
             self.viewer = napari.current_viewer()
             if self.viewer is not None:
                 self.viewer.close()
             self.viewer = napari.Viewer()
-            data = self.ana_data[self.hs['AnaSelVars sel'].value].compute()
+            data = self.ana_data[self.hs["AnaSelVars sel"].value].compute()
             self.viewer.add_image(data)
             napari.run()
         else:
-            fiji_viewer_off(self.parent_h.global_h,
-                            gui_h=self,
-                            viewer_name='xanes_pp_data_prev_viewer')
-            fiji_viewer_on(self.parent_h.global_h,
-                           gui_h=self,
-                           viewer_name='xanes_pp_data_prev_viewer')
+            fiji_viewer_off(
+                self.parent_h.global_h,
+                gui_h=self,
+                viewer_name="xanes_pp_data_prev_viewer",
+            )
+            fiji_viewer_on(
+                self.parent_h.global_h,
+                gui_h=self,
+                viewer_name="xanes_pp_data_prev_viewer",
+            )
         self.boxes_logic()
 
     def AnaSelDatasetPrevOpt_rad_chg(self, a):
-        self.viewer_type = a['owner'].value
+        self.viewer_type = a["owner"].value
 
     def AnaSnglMaskVarName_drpn_chg(self, a):
         self.ana_mask_sngl_op = {}
-        self.hs['AnaSnglMaskOpSeq sel'].options = []
-        self.hs['AnaSnglMaskOpSeqPrev btn'].disabled = True
-        self.hs['AnaSnglMaskOpSeqZSli txt'].disabled = True
-        s = self.ana_data[self.hs['AnaSnglMaskVarName drpn'].value].shape
-        self.hs['AnaSnglMaskOpSeqZSli txt'].value = 0
+        self.hs["AnaSnglMaskOpSeq sel"].options = []
+        self.hs["AnaSnglMaskOpSeqPrev btn"].disabled = True
+        self.hs["AnaSnglMaskOpSeqZSli txt"].disabled = True
+        s = self.ana_data[self.hs["AnaSnglMaskVarName drpn"].value].shape
+        self.hs["AnaSnglMaskOpSeqZSli txt"].value = 0
         if len(s) == 3:
-            self.hs['AnaSnglMaskOpSeqZSli txt'].max = s[0]
+            self.hs["AnaSnglMaskOpSeqZSli txt"].max = s[0]
         self.ana_mask_sngl_op_seled = False
         self.boxes_logic()
 
     def AnaSnglMaskSpecName_drpn_chg(self, a):
-        self.ana_spec_name = a['owner'].value
+        self.ana_spec_name = a["owner"].value
         self.boxes_logic()
 
     def AnaSnglMaskOp_drpn_chg(self, a):
         self.set_single_mask_op(reset=True)
 
     def AnaSnglMaskOpHelp_btn_clk(self, a):
-        op = self.hs['AnaSnglMaskOp drpn'].value
-        url = xanes_analysis_gui.MASK_OP_PAR_DICT[op]['url']
-        with self.hs['AnaSnglMaskOpHelp out']:
+        op = self.hs["AnaSnglMaskOp drpn"].value
+        url = xanes_analysis_gui.MASK_OP_PAR_DICT[op]["url"]
+        with self.hs["AnaSnglMaskOpHelp out"]:
             display(Javascript(f'window.open("{url}");'))
 
     def AnaSnglMaskOpAdd_btn_clk(self, a):
         idx = str(len(self.ana_mask_sngl_op.keys()))
-        op = self.hs['AnaSnglMaskOp drpn'].value
+        op = self.hs["AnaSnglMaskOp drpn"].value
         self.ana_mask_sngl_op[idx] = {}
-        self.ana_mask_sngl_op[idx]['flt_name'] = op
-        self.ana_mask_sngl_op[idx]['pars'] = {}
-        for key in xanes_analysis_gui.MASK_OP_PAR_DICT[op][
-                'default_pars'].keys():
-            self.ana_mask_sngl_op[idx]['pars'][
-                xanes_analysis_gui.MASK_OP_PAR_DICT[op]['default_pars'][key]
-                ['var']] = self.hs[key].value
-        op_list = list(self.hs['AnaSnglMaskOpSeq sel'].options)
+        self.ana_mask_sngl_op[idx]["flt_name"] = op
+        self.ana_mask_sngl_op[idx]["pars"] = {}
+        for key in xanes_analysis_gui.MASK_OP_PAR_DICT[op]["default_pars"].keys():
+            self.ana_mask_sngl_op[idx]["pars"][
+                xanes_analysis_gui.MASK_OP_PAR_DICT[op]["default_pars"][key]["var"]
+            ] = self.hs[key].value
+        op_list = list(self.hs["AnaSnglMaskOpSeq sel"].options)
         op_list.append(op)
-        self.hs['AnaSnglMaskOpSeq sel'].options = op_list
-        self.hs['AnaSnglMaskOpSeqPrev btn'].disabled = False
-        s = self.ana_data[self.hs['AnaSnglMaskVarName drpn'].value].shape
+        self.hs["AnaSnglMaskOpSeq sel"].options = op_list
+        self.hs["AnaSnglMaskOpSeqPrev btn"].disabled = False
+        s = self.ana_data[self.hs["AnaSnglMaskVarName drpn"].value].shape
         if len(s) == 2:
-            self.hs['AnaSnglMaskOpSeqZSli txt'].disabled = True
+            self.hs["AnaSnglMaskOpSeqZSli txt"].disabled = True
         else:
-            self.hs['AnaSnglMaskOpSeqZSli txt'].disabled = False
+            self.hs["AnaSnglMaskOpSeqZSli txt"].disabled = False
         self.ana_mask_sngl_op_seled = True
         self.boxes_logic()
 
     def AnaSnglMaskOpRm_btn_clk(self, a):
-        rm_op = self.hs['AnaSnglMaskOpSeq sel'].value
-        idx = self.hs['AnaSnglMaskOpSeq sel'].index
+        rm_op = self.hs["AnaSnglMaskOpSeq sel"].value
+        idx = self.hs["AnaSnglMaskOpSeq sel"].index
         if rm_op is not None:
-            op_list = list(self.hs['AnaSnglMaskOpSeq sel'].options)
+            op_list = list(self.hs["AnaSnglMaskOpSeq sel"].options)
             op_list.remove(rm_op)
-            self.hs['AnaSnglMaskOpSeq sel'].options = op_list
+            self.hs["AnaSnglMaskOpSeq sel"].options = op_list
             self.ana_mask_sngl_op.pop(str(idx))
             op = {}
             for ii, key in enumerate(sorted(self.ana_mask_sngl_op.keys())):
                 op[ii] = self.ana_mask_sngl_op[key]
             self.ana_mask_sngl_op = op
             self.ana_mask_sngl_op_seled = True
-        if len(self.hs['AnaSnglMaskOpSeq sel'].options) == 0:
-            self.hs['AnaSnglMaskOpSeqPrev btn'].disabled = True
-            self.hs['AnaSnglMaskOpSeqZSli txt'].disabled = True
+        if len(self.hs["AnaSnglMaskOpSeq sel"].options) == 0:
+            self.hs["AnaSnglMaskOpSeqPrev btn"].disabled = True
+            self.hs["AnaSnglMaskOpSeqZSli txt"].disabled = True
             self.ana_mask_sngl_op_seled = False
         self.boxes_logic()
 
     def AnaSnglMaskOpSeqZSli_txt_chg(self, a):
         pass
 
     def AnaSnglMaskOpSeqPrev_btn_clk(self, a):
-        mk_name = self.hs['AnaSnglMaskVarName drpn'].value
-        idx = self.hs['AnaSnglMaskOpSeqZSli txt']
+        mk_name = self.hs["AnaSnglMaskVarName drpn"].value
+        idx = self.hs["AnaSnglMaskOpSeqZSli txt"]
         mask, spec = self.prep_sngl_mask(mk_name, idx=idx, confirmed=False)
-        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name='all')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=mask,
-                       win_name='xanes_pp_mask')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=spec,
-                       win_name='xanes_pp_spec')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=delayed(spec * mask),
-                       win_name='masked_xanes_pp_spec')
+        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name="all")
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=mask,
+            win_name="xanes_pp_mask",
+        )
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=spec,
+            win_name="xanes_pp_spec",
+        )
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=delayed(spec * mask),
+            win_name="masked_xanes_pp_spec",
+        )
 
     def AnaSnglMaskAddName_btn_clk(self, a):
         n = len(self.ana_mask_sngl.keys())
-        var = self.hs['AnaSnglMaskVarName drpn'].value
-        mk = f'mk{str(n).zfill(2)}_' + var
+        var = self.hs["AnaSnglMaskVarName drpn"].value
+        mk = f"mk{str(n).zfill(2)}_" + var
         self.ana_mask_sngl[mk] = {}
-        self.ana_mask_sngl[mk]['var_name'] = var
-        self.ana_mask_sngl[mk]['op'] = self.ana_mask_sngl_op
+        self.ana_mask_sngl[mk]["var_name"] = var
+        self.ana_mask_sngl[mk]["op"] = self.ana_mask_sngl_op
 
-        mk_list = list(self.hs['AnaSnglMaskName sel'].options)
+        mk_list = list(self.hs["AnaSnglMaskName sel"].options)
         mk_list.append(mk)
-        self.hs['AnaSnglMaskName sel'].options = mk_list
+        self.hs["AnaSnglMaskName sel"].options = mk_list
         self.boxes_logic()
 
     def AnaSnglMaskRmName_btn_clk(self, a):
-        if ((len(self.hs['AnaCombMaskName sel'].options) == 0) and (len(self.hs['AnaCombMaskOpStps sel'].options))):
-            mk_list = list(self.hs['AnaSnglMaskName sel'].options)
-            mk = self.hs['AnaSnglMaskName sel'].value
+        if (len(self.hs["AnaCombMaskName sel"].options) == 0) and (
+            len(self.hs["AnaCombMaskOpStps sel"].options)
+        ):
+            mk_list = list(self.hs["AnaSnglMaskName sel"].options)
+            mk = self.hs["AnaSnglMaskName sel"].value
             if mk:
-                idx = int(mk.split('_')[0].strip('mk'))
+                idx = int(mk.split("_")[0].strip("mk"))
                 # if len(mk_list) != 0:
                 self.ana_mask_sngl.pop(mk)
                 mk_list.pop(idx)
                 if mk in self.ana_mask.keys():
                     self.ana_mask.pop(mk)
                 if mk_list:
                     for order, mask_name in enumerate(mk_list):
                         mk_list[order] = mask_name.replace(
-                            mask_name.split('_')[0], f'mk{str(order).zfill(2)}')
+                            mask_name.split("_")[0], f"mk{str(order).zfill(2)}"
+                        )
                         tem = self.ana_mask_sngl[mask_name]
                         self.ana_mask_sngl.pop(mask_name)
                         self.ana_mask_sngl[mk_list[order]] = tem
-                    self.hs['AnaSnglMaskName sel'].options = mk_list
+                    self.hs["AnaSnglMaskName sel"].options = mk_list
                 else:
-                    self.hs['AnaSnglMaskName sel'].options = []
+                    self.hs["AnaSnglMaskName sel"].options = []
                     self.ana_mask_sngl_cnfged = False
-                self.hs['AnaCombMaskVar drpn'].options = self.hs[
-                    'AnaSnglMaskName sel'].options
+                self.hs["AnaCombMaskVar drpn"].options = self.hs[
+                    "AnaSnglMaskName sel"
+                ].options
         self.boxes_logic()
 
     def AnaSnglMaskNameCfm_btn_clk(self, a):
         # TODO: decide if apply compute and dataset structure in h5
         """
         self.ana_mask_sngl = {key: <mask name>
                                   {key: str <var_name: variable name in string>,
                                    key: dictionary <op: operation sequence>,
                                         {key: int <operation order>
                                               {key: str <flt_name: filter's name>,
                                                key: dictionary <pars: filter function parameters>}}}}
         """
-        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name='all')
-        if len(self.hs['AnaSnglMaskName sel'].options) != 0:
-            self.hs['AnaCombMaskVar drpn'].options = self.hs[
-                'AnaSnglMaskName sel'].options
-            self.hs['AnaCombMaskVar drpn'].index = 0
-            for key in self.hs['AnaSnglMaskName sel'].options:
+        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name="all")
+        if len(self.hs["AnaSnglMaskName sel"].options) != 0:
+            self.hs["AnaCombMaskVar drpn"].options = self.hs[
+                "AnaSnglMaskName sel"
+            ].options
+            self.hs["AnaCombMaskVar drpn"].index = 0
+            for key in self.hs["AnaSnglMaskName sel"].options:
                 mask, _ = self.prep_sngl_mask(key, idx=-1, confirmed=True)
                 self.ana_mask[key] = {
-                    'mask': mask,
-                    'source': {
-                        'var_name': self.ana_mask_sngl[key]['var_name'],
-                        'op': self.ana_mask_sngl[key]['op']
-                    }
+                    "mask": mask,
+                    "source": {
+                        "var_name": self.ana_mask_sngl[key]["var_name"],
+                        "op": self.ana_mask_sngl[key]["op"],
+                    },
                 }
             self.ana_mask_sngl_cnfged = True
         else:
             self.ana_mask_sngl_cnfged = False
         if len(self.ana_mask.keys()) == 0:
-            self.hs['AnaAnaMask drpdn'].options = ['None']
+            self.hs["AnaAnaMask drpdn"].options = ["None"]
         else:
-            self.hs['AnaAnaMask drpdn'].options = list(
-                self.ana_mask.keys()) + ['None']
-            self.hs['AnaAnaMask drpdn'].value = 'None'
+            self.hs["AnaAnaMask drpdn"].options = list(self.ana_mask.keys()) + ["None"]
+            self.hs["AnaAnaMask drpdn"].value = "None"
         self.boxes_logic()
 
     def AnaCombMaskVar_drpn_chg(self, a):
-        info = ''
-        if a['owner'].value is not None:
-            op = self.ana_mask_sngl[a['owner'].value]['op']
+        info = ""
+        if a["owner"].value is not None:
+            op = self.ana_mask_sngl[a["owner"].value]["op"]
             for k0 in op.keys():
-                info = info + op[k0]['flt_name'] + ':' + str(
-                    [f'{k1}: {i1},'
-                     for k1, i1 in op[k0]['pars'].items()]) + '\n'
-        self.hs['AnaCombMaskVarInfo txt'].value = info
+                info = (
+                    info
+                    + op[k0]["flt_name"]
+                    + ":"
+                    + str([f"{k1}: {i1}," for k1, i1 in op[k0]["pars"].items()])
+                    + "\n"
+                )
+        self.hs["AnaCombMaskVarInfo txt"].value = info
 
     def AnaCombMaskPrev_btn_clk(self, a):
-        idx = self.hs['AnaCombMaskZSli txt'].value
+        idx = self.hs["AnaCombMaskZSli txt"].value
         mk_name = self.hs["AnaCombMaskVar drpn"].value
         if mk_name in self.ana_mask.keys():
-            mask = self.ana_mask[mk_name]['mask']
+            mask = self.ana_mask[mk_name]["mask"]
             if len(mask.shape) == 3:
                 mask = mask[idx]
         elif mk_name in self.ana_mask_comb.keys():
             # TODO: add newly added combined mask into the list so need to update mask generator
             # mask = self.prep_comb_mask(mk_name, idx=idx, confirmed=False)
             pass
         spec = self.ana_spec[self.ana_spec_name]
-        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name='all')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=mask,
-                       win_name='xanes_pp_mask')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=spec,
-                       win_name='xanes_pp_spec')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=delayed(spec * mask),
-                       win_name='masked_xanes_pp_spec')
+        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name="all")
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=mask,
+            win_name="xanes_pp_mask",
+        )
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=spec,
+            win_name="xanes_pp_spec",
+        )
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=delayed(spec * mask),
+            win_name="masked_xanes_pp_spec",
+        )
 
     def AnaCombMaskOp_drpn_chg(self, a):
         pass
 
     def AnaCombMaskZSli_txt_chg(self, a):
         pass
 
     def AnaCombMaskVarAdd_btn_clk(self, a):
         """
-        SET_OP_DICT = {
-        'Union (+)': {
-            'description': 'Union operation between two masks',
-            'op_symb': ' + ',
-            'flt': xpa.set_union
-        },
-        'Intersection (x)': {
-            'description': 'Intersection between two masks',
-            'op_symb': ' x ',
-            'flt': xpa.set_intersection
-        },
-        'Differnece (-)': {
-            'description': 'Difference between two masks',
-            'op_symb': ' - ',
-            'flt': xpa.set_difference
-        },
-        'Complement (I-A)': {
-            'description': 'Complement of a mask',
-            'op_symb': '1 - A',
-            'flt': xpa.set_complement
+            SET_OP_DICT = {
+            'Union (+)': {
+                'description': 'Union operation between two masks',
+                'op_symb': ' + ',
+                'flt': xpa.set_union
+            },
+            'Intersection (x)': {
+                'description': 'Intersection between two masks',
+                'op_symb': ' x ',
+                'flt': xpa.set_intersection
+            },
+            'Differnece (-)': {
+                'description': 'Difference between two masks',
+                'op_symb': ' - ',
+                'flt': xpa.set_difference
+            },
+            'Complement (I-A)': {
+                'description': 'Complement of a mask',
+                'op_symb': '1 - A',
+                'flt': xpa.set_complement
+            }
         }
-    }
         """
-        mk = self.hs['AnaCombMaskVar drpn'].value
-        mk_short = mk.split('_')[0]
-        op = self.hs['AnaCombMaskOp drpn'].value
-        op_symb = xanes_analysis_gui.SET_OP_DICT[
-            self.hs['AnaCombMaskOp drpn'].value]['op_symb']
+        mk = self.hs["AnaCombMaskVar drpn"].value
+        mk_short = mk.split("_")[0]
+        op = self.hs["AnaCombMaskOp drpn"].value
+        op_symb = xanes_analysis_gui.SET_OP_DICT[self.hs["AnaCombMaskOp drpn"].value][
+            "op_symb"
+        ]
         info = list(self.hs["AnaCombMaskOpStps sel"].options)
         idx = str(len(info))
-        if idx == '0':
-            self.hs['AnaCombMaskOp drpn'].options = [
-                'Union (+)', 'Intersection (x)', 'Differnece (-)',
-                'Complement (I-A)'
+        if idx == "0":
+            self.hs["AnaCombMaskOp drpn"].options = [
+                "Union (+)",
+                "Intersection (x)",
+                "Differnece (-)",
+                "Complement (I-A)",
             ]
 
         self.ana_mask_comb_op[idx] = {}
         # if idx == '0':
         #     self.ana_mask_comb_op[idx]["op"] = "identity"
         #     self.ana_mask_comb_op[idx]["op_symb"] = "1x"
         #     self.ana_mask_comb_op[idx]["B name"] = mk
@@ -2086,92 +1979,97 @@
         self.hs["AnaCombMaskOpStps sel"].options = info
         self.ana_mask_comb_op_seled = True
         self.boxes_logic()
 
     def AnaCombMaskVarRm_btn_clk(self, a):
         rm_op = self.hs["AnaCombMaskOpStps sel"].value
         idx = self.hs["AnaCombMaskOpStps sel"].index
-        if ((idx is not None) & (idx != 0)):
+        if (idx is not None) & (idx != 0):
             op_list = list(self.hs["AnaCombMaskOpStps sel"].options)
             op_list.remove(rm_op)
             self.hs["AnaCombMaskOpStps sel"].options = op_list
             self.ana_mask_comb_op.pop(str(idx))
             op = {}
-            for new_idx, old_idx in enumerate(
-                    sorted(self.ana_mask_comb_op.keys())):
+            for new_idx, old_idx in enumerate(sorted(self.ana_mask_comb_op.keys())):
                 op[str(new_idx)] = self.ana_mask_comb_op[old_idx]
             self.ana_mask_comb_op = op
-        elif (
-            (len(self.hs["AnaCombMaskOpStps sel"].options) != 1) & (idx == 0)):
+        elif (len(self.hs["AnaCombMaskOpStps sel"].options) != 1) & (idx == 0):
             print("Cannot remove the first mask.")
         else:
             op_list = list(self.hs["AnaCombMaskOpStps sel"].options)
             op_list.remove(rm_op)
             self.hs["AnaCombMaskOpStps sel"].options = op_list
             self.ana_mask_comb_op.pop(str(idx))
         if len(self.hs["AnaCombMaskOpStps sel"].options) == 0:
-            self.hs['AnaCombMaskOp drpn'].options = ['', 'Complement (I-A)']
-            self.hs['AnaCombMaskOp drpn'].value = ''
+            self.hs["AnaCombMaskOp drpn"].options = ["", "Complement (I-A)"]
+            self.hs["AnaCombMaskOp drpn"].value = ""
             self.ana_mask_comb_op_seled = False
         self.boxes_logic()
 
     def AnaCombMasksPrev_btn_clk(self, a):
-        idx = self.hs['AnaCombMaskZSli txt'].value
+        idx = self.hs["AnaCombMaskZSli txt"].value
         mk_name = self.hs["AnaCombMaskVar drpn"].value
         mask = self.prep_comb_mask(mk_name, idx=idx, confirmed=False)
         spec = self.ana_spec[self.ana_spec_name]
-        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name='all')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=mask,
-                       win_name='xanes_pp_mask')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=spec,
-                       win_name='xanes_pp_spec')
-        fiji_viewer_on(self.parent_h.global_h,
-                       gui_h=self,
-                       viewer_name='xanes_pp_mask_prev_viewer',
-                       data=delayed(spec * mask),
-                       win_name='masked_xanes_pp_spec')
+        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name="all")
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=mask,
+            win_name="xanes_pp_mask",
+        )
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=spec,
+            win_name="xanes_pp_spec",
+        )
+        fiji_viewer_on(
+            self.parent_h.global_h,
+            gui_h=self,
+            viewer_name="xanes_pp_mask_prev_viewer",
+            data=delayed(spec * mask),
+            win_name="masked_xanes_pp_spec",
+        )
 
     def AnaCombMaskAddName_btn_clk(self, a):
         n = len(self.ana_mask_comb.keys())
-        mk = f'comb_mk{str(n).zfill(2)}'
+        mk = f"comb_mk{str(n).zfill(2)}"
         self.ana_mask_comb[mk] = {}
-        self.ana_mask_comb[mk]['op'] = self.ana_mask_comb_op
+        self.ana_mask_comb[mk]["op"] = self.ana_mask_comb_op
 
-        mk_list = list(self.hs['AnaCombMaskName sel'].options)
+        mk_list = list(self.hs["AnaCombMaskName sel"].options)
         mk_list.append(mk)
-        self.hs['AnaCombMaskName sel'].options = mk_list
+        self.hs["AnaCombMaskName sel"].options = mk_list
         self.boxes_logic()
 
     def AnaCombMaskRmName_btn_clk(self, a):
-        mk_list = list(self.hs['AnaCombMaskName sel'].options)
-        mk = self.hs['AnaCombMaskName sel'].value
+        mk_list = list(self.hs["AnaCombMaskName sel"].options)
+        mk = self.hs["AnaCombMaskName sel"].value
         if mk:
-            idx = int(mk.strip('comb_mk'))
+            idx = int(mk.strip("comb_mk"))
             if len(mk_list) != 0:
                 self.ana_mask_comb.pop(mk)
                 mk_list.pop(idx)
                 if mk in self.ana_mask.keys():
                     self.ana_mask.pop(mk)
-            self.hs['AnaCombMaskName sel'].options = mk_list
+            self.hs["AnaCombMaskName sel"].options = mk_list
             if mk_list:
                 for order, mask_name in enumerate(mk_list):
                     mk_list[order] = mask_name.replace(
-                        mask_name.split('_')[-1], f'mk{str(order).zfill(2)}')
+                        mask_name.split("_")[-1], f"mk{str(order).zfill(2)}"
+                    )
                     tem = self.ana_mask_comb[mask_name]
                     self.ana_mask_comb.pop(mask_name)
                     self.ana_mask_comb[mk_list[order]] = tem
-                self.hs['AnaCombMaskName sel'].options = mk_list
+                self.hs["AnaCombMaskName sel"].options = mk_list
             else:
-                self.hs['AnaCombMaskName sel'].options = []
+                self.hs["AnaCombMaskName sel"].options = []
                 self.ana_mask_comb_cnfged = False
         self.boxes_logic()
 
     def AnaCombMaskName_sel_chg(self, a):
         # show combination information as tooltip
         pass
 
@@ -2182,108 +2080,108 @@
             key: str <mask name>: {
                 key: dictionary <op: operation sequence>: {
                     key: int <operation order>: {
                         key: str <op: operation name>,
                         key: str <op_symb: operation symbol>,
                         key: str <B name: name of the second argument in the binary function>,
                         key: str <B short name: short name of the second argument in the binary function>
-                    } 
+                    }
                 }
             },
         }
         """
-        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name='all')
-        if len(self.hs['AnaCombMaskOpStps sel'].options) != 0:
-            for key in self.hs['AnaCombMaskName sel'].options:
+        fiji_viewer_off(self.parent_h.global_h, gui_h=self, viewer_name="all")
+        if len(self.hs["AnaCombMaskOpStps sel"].options) != 0:
+            for key in self.hs["AnaCombMaskName sel"].options:
                 mask = self.prep_comb_mask(key, idx=-1, confirmed=True)
                 self.ana_mask[key] = {
-                    'mask': mask,
-                    'source': self.ana_mask_comb[key]['op']
+                    "mask": mask,
+                    "source": self.ana_mask_comb[key]["op"],
                 }
             self.ana_mask_comb_cnfged = True
         else:
             self.ana_mask_comb_cnfged = False
         if len(self.ana_mask.keys()) == 0:
-            self.hs['AnaAnaMask drpdn'].options = ['None']
+            self.hs["AnaAnaMask drpdn"].options = ["None"]
         else:
-            self.hs['AnaAnaMask drpdn'].options = list(
-                self.ana_mask.keys()) + ['None']
-            self.hs['AnaAnaMask drpdn'].value = 'None'
+            self.hs["AnaAnaMask drpdn"].options = list(self.ana_mask.keys()) + ["None"]
+            self.hs["AnaAnaMask drpdn"].value = "None"
         self.boxes_logic()
 
     def AnaMaskSav_btn_clk(self, a):
-        with h5py.File(self.ana_fn, 'r+') as f:
-            if self.parent_h.gui_name == 'xanes2D':
-                if 'gen_masks' in f['processed_XANES2D'].keys():
-                    del f['processed_XANES2D/gen_masks']
-                gm0 = f['processed_XANES2D'].create_group('gen_masks')
+        with h5py.File(self.ana_fn, "r+") as f:
+            if self.parent_h.gui_name == "xanes2D":
+                if "gen_masks" in f["processed_XANES2D"].keys():
+                    del f["processed_XANES2D/gen_masks"]
+                gm0 = f["processed_XANES2D"].create_group("gen_masks")
                 for mask_name in self.ana_mask.keys():
                     if mask_name in gm0.keys():
                         del gm0[mask_name]
                     gm1 = gm0.create_group(mask_name)
                     gm1.create_dataset(
                         mask_name,
-                        data=self.ana_mask[mask_name]['mask'].compute().astype(
-                            np.int8),
-                        dtype=np.int8)
+                        data=self.ana_mask[mask_name]["mask"].compute().astype(np.int8),
+                        dtype=np.int8,
+                    )
                     dicttoh5(
-                        self.ana_mask[mask_name]['source'],
+                        self.ana_mask[mask_name]["source"],
                         f,
                         overwrite_data=True,
-                        h5path=
-                        f'/processed_XANES2D/gen_masks/{mask_name}/source')
-            elif self.parent_h.gui_name == 'xanes3D':
-                if 'gen_masks' not in f['processed_XANES3D'].keys():
-                    gm0 = f['processed_XANES3D'].create_group('gen_masks')
+                        h5path=f"/processed_XANES2D/gen_masks/{mask_name}/source",
+                    )
+            elif self.parent_h.gui_name == "xanes3D":
+                if "gen_masks" not in f["processed_XANES3D"].keys():
+                    gm0 = f["processed_XANES3D"].create_group("gen_masks")
                 else:
-                    gm0 = f['processed_XANES3D/gen_masks']
+                    gm0 = f["processed_XANES3D/gen_masks"]
                 for mask_name in self.ana_mask.keys():
                     if mask_name in gm0.keys():
                         del gm0[mask_name]
                     gm1 = gm0.create_group(mask_name)
                     gm1.create_dataset(
                         mask_name,
-                        data=self.ana_mask[mask_name]['mask'].compute().astype(
-                            np.int8),
-                        dtype=np.int8)
+                        data=self.ana_mask[mask_name]["mask"].compute().astype(np.int8),
+                        dtype=np.int8,
+                    )
                     dicttoh5(
-                        self.ana_mask[mask_name]['source'],
+                        self.ana_mask[mask_name]["source"],
                         f,
                         overwrite_data=True,
-                        h5path=
-                        f'/processed_XANES3D/gen_masks/{mask_name}/source')
+                        h5path=f"/processed_XANES3D/gen_masks/{mask_name}/source",
+                    )
         self.boxes_logic()
 
     def AnaAnaSpec_drpdn_chg(self, a):
-        spec_nm = self.hs['AnaAnaSpec drpdn'].value
-        if ((spec_nm is None) or (spec_nm == 'None')):
-            self.hs['AnaAnaSpecInfo txt'].value = ''
+        spec_nm = self.hs["AnaAnaSpec drpdn"].value
+        if (spec_nm is None) or (spec_nm == "None"):
+            self.hs["AnaAnaSpecInfo txt"].value = ""
         else:
-            self.hs[
-                'AnaAnaSpecInfo txt'].value = f"Shape: {self.ana_spec[spec_nm].shape}\ndtype: {self.ana_spec[spec_nm].dtype}"
+            self.hs["AnaAnaSpecInfo txt"].value = (
+                f"Shape: {self.ana_spec[spec_nm].shape}\ndtype: {self.ana_spec[spec_nm].dtype}"
+            )
         self.ana_ana_data_cnfged = False
         self.boxes_logic()
 
     def AnaAnaMask_drpdn_chg(self, a):
-        mask_nm = self.hs['AnaAnaMask drpdn'].value
-        if ((mask_nm is None) or (mask_nm == 'None')):
-            self.hs['AnaAnaMaskInfo txt'].value = ''
+        mask_nm = self.hs["AnaAnaMask drpdn"].value
+        if (mask_nm is None) or (mask_nm == "None"):
+            self.hs["AnaAnaMaskInfo txt"].value = ""
         else:
-            self.hs[
-                'AnaAnaMaskInfo txt'].value = f"Shape: {self.ana_mask[mask_nm]['mask'].shape}\ndtype: {self.ana_mask[mask_nm]['mask'].dtype}"
+            self.hs["AnaAnaMaskInfo txt"].value = (
+                f"Shape: {self.ana_mask[mask_nm]['mask'].shape}\ndtype: {self.ana_mask[mask_nm]['mask'].dtype}"
+            )
         self.ana_ana_data_cnfged = False
         self.boxes_logic()
 
     def AnaAnaDataCfm_btn_clk(self, a):
-        self.ana_ana_spec = self.ana_spec[self.hs['AnaAnaSpec drpdn'].value]
-        if self.hs['AnaAnaMask drpdn'].value == 'None':
+        self.ana_ana_spec = self.ana_spec[self.hs["AnaAnaSpec drpdn"].value]
+        if self.hs["AnaAnaMask drpdn"].value == "None":
             self.ana_ana_mask = 1
         else:
-            self.ana_ana_mask = self.ana_mask[
-                self.hs['AnaAnaMask drpdn'].value]['mask']
+            self.ana_ana_mask = self.ana_mask[self.hs["AnaAnaMask drpdn"].value]["mask"]
         self.ana_ana_data_cnfged = True
         self.boxes_logic()
 
     def AnaType_drpdn_chg(self, a):
         pass
 
     def AnaMeth_drpdn_chg(self, a):
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/gui/xanes_fitting_gui.py` & `txm_sandbox-0.3.0/TXM_Sandbox/gui/xanes_fitting_gui.py`

 * *Files 21% similar despite different names*

```diff
@@ -3,62 +3,69 @@
 """
 Created on Mon Jun 22 11:56:17 2020
 
 @author: xiao
 """
 import os, h5py, json, numpy as np, pandas as pd
 
+from pathlib import Path
 from ipywidgets import widgets
 from copy import deepcopy
 import napari
 
-from .gui_components import (NumpyArrayEncoder, get_handles,
-                             enable_disable_boxes, gen_external_py_script,
-                             fiji_viewer_off, fiji_viewer_state,
-                             fiji_viewer_on, scale_eng_list, SelectFilesButton,
-                             update_json_content)
+from .gui_components import (
+    NumpyArrayEncoder,
+    get_handles,
+    enable_disable_boxes,
+    gen_external_py_script,
+    fiji_viewer_off,
+    fiji_viewer_state,
+    fiji_viewer_on,
+    scale_eng_list,
+    SelectFilesButton,
+    update_json_content,
+)
 from ..utils import xanes_math as xm
 from ..utils import xanes_analysis as xa
 from ..dicts import customized_struct_dict as dat_dict
 
 inf = np.inf
 
 napari.gui_qt()
 
 NUMPY_FIT_ORDER = [2, 3, 4]
 
 
-class xanes_fitting_gui():
+class xanes_fitting_gui:
 
     def __init__(self, parent_h, form_sz=[650, 740]):
         self.parent_h = parent_h
         self.global_h = parent_h.global_h
         self.hs = {}
         self.form_sz = form_sz
         self.fit_img_bin_fac = 1
         self.fit_wl_fit_use_param_bnd = False
-        self.fit_wl_optimizer = 'numpy'
+        self.fit_wl_optimizer = "numpy"
         self.fit_wl_fit_func = 2
         self.fit_edge_fit_use_param_bnd = False
-        self.fit_edge_optimizer = 'numpy'
+        self.fit_edge_optimizer = "numpy"
         self.fit_edge_fit_func = 3
         self.analysis_saving_items = set(dat_dict.XANES_FULL_SAVE_DEFAULT)
-        self.parent_h.xanes_fit_type == 'full'
+        self.parent_h.xanes_fit_type == "full"
         self.xanes_fit_eng_config = False
 
         self.fit_mask_prev = False
         self.fit_flt_prev_sli = 0
         self.fit_flt_prev_configed = False
         self.fit_flt_prev_maskit = False
         self.fit_lcf = False
         self.fit_lcf_ref_set = False
         self.fit_lcf_constr = True
         self.fit_lcf_ref_num = 2
-        self.fit_lcf_ref_spec = pd.DataFrame(
-            columns=['fpath', 'fname', 'eng', 'mu'])
+        self.fit_lcf_ref_spec = pd.DataFrame(columns=["fpath", "fname", "eng", "mu"])
 
         self.pre_es_idx = None
         self.pre_ee_idx = None
         self.post_es_idx = None
         self.post_ee_idx = None
         self.fit_flt_prev_xana = None
         self.e0_idx = None
@@ -70,4571 +77,4537 @@
         self.fit_wl_pos = True
         # self.fit_edge_pos = False
         self.fit_edge50_pos = True
         self.find_wl_pos_dir = False
         self.find_edge50_pos_dir = True
         self.fit_use_flt_spec = False
 
-        if self.parent_h.gui_name == 'xanes3D':
+        if self.parent_h.gui_name == "xanes3D":
             self.fn = self.parent_h.xanes_save_trial_reg_filename
-            self.xanes_mask_external_command_name = os.path.join(
-                self.global_h.script_dir, 'xanes3D_mask_external_command.py')
-        elif self.parent_h.gui_name == 'xanes2D':
+            # self.xanes_mask_external_command_name = os.path.join(
+            #     self.global_h.script_dir, 'xanes3D_mask_external_command.py')
+            self.xanes_mask_external_command_name = str(
+                Path(self.global_h.script_dir) / "xanes3D_mask_external_command.py"
+            )
+        elif self.parent_h.gui_name == "xanes2D":
             self.fn = self.parent_h.xanes_save_trial_reg_filename
-            self.xanes_mask_external_command_name = os.path.join(
-                self.global_h.script_dir, 'xanes2D_mask_external_command.py')
+            # self.xanes_mask_external_command_name = os.path.join(
+            #     self.global_h.script_dir, 'xanes2D_mask_external_command.py')
+            self.xanes_mask_external_command_name = str(
+                Path(self.global_h.script_dir) / "xanes2D_mask_external_command.py"
+            )
 
     def build_gui(self):
         ## ## ## bundle sub-tabs in each tab - analysis&display TAB in 3D_xanes TAB -- start
         ## ## ## ## define functional widgets each tab in each sub-tab - analysis box in analysis&display TAB -- start
-        layout = {
-            'border': '3px solid #8855AA',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['Fitting form'] = widgets.VBox()
-        self.hs['Fitting form'].layout = layout
+        layout = {"border": "3px solid #8855AA", "width": "auto", "height": "auto"}
+        self.hs["Fitting form"] = widgets.VBox()
+        self.hs["Fitting form"].layout = layout
 
         ## ## ## ## fit energy config box -- start
-        layout = {
-            'border': '3px solid #8855AA',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitEngConfig box'] = widgets.VBox()
-        self.hs['FitEngConfig box'].layout = layout
+        layout = {"border": "3px solid #8855AA", "width": "auto", "height": "auto"}
+        self.hs["FitEngConfig box"] = widgets.VBox()
+        self.hs["FitEngConfig box"].layout = layout
 
         ## ## ## ## ## label analysis box -- start
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitTitle box'] = widgets.HBox()
-        self.hs['FitTitle box'].layout = layout
-        self.hs['FitTitle label'] = widgets.HTML(
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
+        self.hs["FitTitle box"] = widgets.HBox()
+        self.hs["FitTitle box"].layout = layout
+        self.hs["FitTitle label"] = widgets.HTML(
             '<span style="color:red; font-size: 150%; font-weight: bold; background-color:rgb(135,206,250);">'
-            + 'XANES Fitting' + '</span>')
+            + "XANES Fitting"
+            + "</span>"
+        )
         layout = {
-            'background-color': 'white',
-            'color': 'cyan',
-            'left': '41%',
-            'width': 'auto'
+            "background-color": "white",
+            "color": "cyan",
+            "left": "41%",
+            "width": "auto",
         }
-        self.hs['FitTitle label'].layout = layout
-        self.hs['FitTitle box'].children = [self.hs['FitTitle label']]
+        self.hs["FitTitle label"].layout = layout
+        self.hs["FitTitle box"].children = [self.hs["FitTitle label"]]
         ## ## ## ## ## label analysis box -- end
 
         ## ## ## ## ## define type of analysis and energy range -- start
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitEngRag box'] = widgets.VBox()
-        self.hs['FitEngRag box'].layout = layout
-        layout = {'border': 'none', 'width': 'auto', 'height': 'auto'}
-        self.hs['FitEngRagRow0 box'] = widgets.HBox()
-        self.hs['FitEngRagRow0 box'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagOptn drpdn'] = widgets.Dropdown(
-            description='analysis type',
-            description_tooltip=
-            'wl: find whiteline positions without doing background removal and normalization; edge0.5: find energy point where the normalized spectrum value equal to 0.5; full: doing regular xanes preprocessing',
-            options=['wl', 'full'],
-            value='wl',
-            disabled=True)
-        self.hs['FitEngRagOptn drpdn'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagEdgeEng text'] = widgets.BoundedFloatText(
-            description='edge eng',
-            description_tooltip='edge energy (keV)',
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
+        self.hs["FitEngRag box"] = widgets.VBox()
+        self.hs["FitEngRag box"].layout = layout
+        layout = {"border": "none", "width": "auto", "height": "auto"}
+        self.hs["FitEngRagRow0 box"] = widgets.HBox()
+        self.hs["FitEngRagRow0 box"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagOptn drpdn"] = widgets.Dropdown(
+            description="analysis type",
+            description_tooltip="wl: find whiteline positions without doing background removal and normalization; edge0.5: find energy point where the normalized spectrum value equal to 0.5; full: doing regular xanes preprocessing",
+            options=["wl", "full"],
+            value="wl",
+            disabled=True,
+        )
+        self.hs["FitEngRagOptn drpdn"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagEdgeEng text"] = widgets.BoundedFloatText(
+            description="edge eng",
+            description_tooltip="edge energy (keV)",
             value=0,
             min=0,
             max=50000,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagEdgeEng text'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagPreEdgeEnd text'] = widgets.BoundedFloatText(
-            description='pre edge e',
-            description_tooltip=
-            'relative ending energy point (keV) of pre-edge from edge energy for background removal',
+            disabled=True,
+        )
+        self.hs["FitEngRagEdgeEng text"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagPreEdgeEnd text"] = widgets.BoundedFloatText(
+            description="pre edge e",
+            description_tooltip="relative ending energy point (keV) of pre-edge from edge energy for background removal",
             value=-50,
             min=-500,
             max=0,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagPreEdgeEnd text'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagPostEdgeStr text'] = widgets.BoundedFloatText(
-            description='post edge s',
-            description_tooltip=
-            'relative starting energy point (keV) of post-edge from edge energy for normalization',
+            disabled=True,
+        )
+        self.hs["FitEngRagPreEdgeEnd text"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagPostEdgeStr text"] = widgets.BoundedFloatText(
+            description="post edge s",
+            description_tooltip="relative starting energy point (keV) of post-edge from edge energy for normalization",
             value=100,
             min=0,
             max=500,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagPostEdgeStr text'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-
-        self.hs['FitEngRagOptn drpdn'].observe(self.fit_eng_rag_optn_drpdn,
-                                               names='value')
-        self.hs['FitEngRagEdgeEng text'].observe(
-            self.fit_eng_rag_edge_eng_text_chg, names='value')
-        self.hs['FitEngRagPreEdgeEnd text'].observe(
-            self.fit_eng_rag_pre_edge_end_text_chg, names='value')
-        self.hs['FitEngRagPostEdgeStr text'].observe(
-            self.fit_eng_rag_post_edge_str_text_chg, names='value')
-        self.hs['FitEngRagRow0 box'].children = [
-            self.hs['FitEngRagOptn drpdn'], self.hs['FitEngRagEdgeEng text'],
-            self.hs['FitEngRagPreEdgeEnd text'],
-            self.hs['FitEngRagPostEdgeStr text']
+            disabled=True,
+        )
+        self.hs["FitEngRagPostEdgeStr text"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+
+        self.hs["FitEngRagOptn drpdn"].observe(
+            self.fit_eng_rag_optn_drpdn, names="value"
+        )
+        self.hs["FitEngRagEdgeEng text"].observe(
+            self.fit_eng_rag_edge_eng_text_chg, names="value"
+        )
+        self.hs["FitEngRagPreEdgeEnd text"].observe(
+            self.fit_eng_rag_pre_edge_end_text_chg, names="value"
+        )
+        self.hs["FitEngRagPostEdgeStr text"].observe(
+            self.fit_eng_rag_post_edge_str_text_chg, names="value"
+        )
+        self.hs["FitEngRagRow0 box"].children = [
+            self.hs["FitEngRagOptn drpdn"],
+            self.hs["FitEngRagEdgeEng text"],
+            self.hs["FitEngRagPreEdgeEnd text"],
+            self.hs["FitEngRagPostEdgeStr text"],
         ]
 
         layout = {
-            'border': 'none',
-            'width': f'{1*self.form_sz[1]-110}px',
-            'height': f'{0.07*(self.form_sz[0]-128)}px'
+            "border": "none",
+            "width": f"{1*self.form_sz[1]-110}px",
+            "height": f"{0.07*(self.form_sz[0]-128)}px",
         }
-        self.hs['FitEngRagRow1 box'] = widgets.HBox()
-        self.hs['FitEngRagRow1 box'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagWlFitStr text'] = widgets.BoundedFloatText(
-            description='wl eng s',
-            description_tooltip=
-            'absolute energy starting point (keV) for whiteline fitting. "wl eng s" and "wl eng e" shoudl be roughly symmetric about whiteline peak.',
+        self.hs["FitEngRagRow1 box"] = widgets.HBox()
+        self.hs["FitEngRagRow1 box"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagWlFitStr text"] = widgets.BoundedFloatText(
+            description="wl eng s",
+            description_tooltip='absolute energy starting point (keV) for whiteline fitting. "wl eng s" and "wl eng e" shoudl be roughly symmetric about whiteline peak.',
             value=0,
             min=0,
             max=50000,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagWlFitStr text'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagWlFitEnd text'] = widgets.BoundedFloatText(
-            description='wl eng e',
-            description_tooltip=
-            'absolute energy ending point (keV) for whiteline fitting. "wl eng s" and "wl eng e" shoudl be roughly symmetric about whiteline peak.',
+            disabled=True,
+        )
+        self.hs["FitEngRagWlFitStr text"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagWlFitEnd text"] = widgets.BoundedFloatText(
+            description="wl eng e",
+            description_tooltip='absolute energy ending point (keV) for whiteline fitting. "wl eng s" and "wl eng e" shoudl be roughly symmetric about whiteline peak.',
             value=0,
             min=0,
             max=50030,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagWlFitEnd text'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagEdge0.5Str text'] = widgets.BoundedFloatText(
-            description='edge0.5 s',
-            description_tooltip=
-            'absolute energy starting point (keV) for edge-0.5 fitting. "edge0.5 s" and "edge0.5 e" shoudl be close to the foot and the peak locations on the ascendent edge of the spectra.',
+            disabled=True,
+        )
+        self.hs["FitEngRagWlFitEnd text"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagEdge0.5Str text"] = widgets.BoundedFloatText(
+            description="edge0.5 s",
+            description_tooltip='absolute energy starting point (keV) for edge-0.5 fitting. "edge0.5 s" and "edge0.5 e" shoudl be close to the foot and the peak locations on the ascendent edge of the spectra.',
             value=0,
             min=0,
             max=50000,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagEdge0.5Str text'].layout = layout
-        layout = {'width': '19%', 'height': '90%'}
-        self.hs['FitEngRagEdge0.5End text'] = widgets.BoundedFloatText(
-            description='edge0.5 e',
-            description_tooltip=
-            'absolute energy starting point (keV) for edge-0.5 fitting. "edge0.5 s" and "edge0.5 e" shoudl be close to the foot and the peak locations on the ascendent edge of the spectra.',
+            disabled=True,
+        )
+        self.hs["FitEngRagEdge0.5Str text"].layout = layout
+        layout = {"width": "19%", "height": "90%"}
+        self.hs["FitEngRagEdge0.5End text"] = widgets.BoundedFloatText(
+            description="edge0.5 e",
+            description_tooltip='absolute energy starting point (keV) for edge-0.5 fitting. "edge0.5 s" and "edge0.5 e" shoudl be close to the foot and the peak locations on the ascendent edge of the spectra.',
             value=0,
             min=0,
             max=50030,
             step=0.5,
-            disabled=True)
-        self.hs['FitEngRagEdge0.5End text'].layout = layout
+            disabled=True,
+        )
+        self.hs["FitEngRagEdge0.5End text"].layout = layout
 
-        layout = {'width': '15%', 'height': '70%', 'left': '7%'}
-        self.hs['FitEngCmf btn'] = widgets.Button(
-            description='Confirm',
-            disabled=True,
-            description_tooltip='Confirm energy range settings')
-        self.hs['FitEngCmf btn'].layout = layout
-        self.hs['FitEngCmf btn'].style.button_color = 'darkviolet'
-
-        self.hs['FitEngRagWlFitStr text'].observe(
-            self.fit_eng_rag_wl_fit_str_text_chg, names='value')
-        self.hs['FitEngRagWlFitEnd text'].observe(
-            self.fit_eng_rag_wl_fit_end_text_chg, names='value')
-        self.hs['FitEngRagEdge0.5Str text'].observe(
-            self.fit_eng_rag_edge50_fit_str_text_chg, names='value')
-        self.hs['FitEngRagEdge0.5End text'].observe(
-            self.fit_eng_rag_edge50_fit_end_text_chg, names='value')
-        self.hs['FitEngCmf btn'].on_click(self.fit_eng_rag_cmf_btn_clk)
-        self.hs['FitEngRagRow1 box'].children = [
-            self.hs['FitEngRagWlFitStr text'],
-            self.hs['FitEngRagWlFitEnd text'],
-            self.hs['FitEngRagEdge0.5Str text'],
-            self.hs['FitEngRagEdge0.5End text'], self.hs['FitEngCmf btn']
+        layout = {"width": "15%", "height": "70%", "left": "7%"}
+        self.hs["FitEngCmf btn"] = widgets.Button(
+            description="Confirm",
+            disabled=True,
+            description_tooltip="Confirm energy range settings",
+        )
+        self.hs["FitEngCmf btn"].layout = layout
+        self.hs["FitEngCmf btn"].style.button_color = "darkviolet"
+
+        self.hs["FitEngRagWlFitStr text"].observe(
+            self.fit_eng_rag_wl_fit_str_text_chg, names="value"
+        )
+        self.hs["FitEngRagWlFitEnd text"].observe(
+            self.fit_eng_rag_wl_fit_end_text_chg, names="value"
+        )
+        self.hs["FitEngRagEdge0.5Str text"].observe(
+            self.fit_eng_rag_edge50_fit_str_text_chg, names="value"
+        )
+        self.hs["FitEngRagEdge0.5End text"].observe(
+            self.fit_eng_rag_edge50_fit_end_text_chg, names="value"
+        )
+        self.hs["FitEngCmf btn"].on_click(self.fit_eng_rag_cmf_btn_clk)
+        self.hs["FitEngRagRow1 box"].children = [
+            self.hs["FitEngRagWlFitStr text"],
+            self.hs["FitEngRagWlFitEnd text"],
+            self.hs["FitEngRagEdge0.5Str text"],
+            self.hs["FitEngRagEdge0.5End text"],
+            self.hs["FitEngCmf btn"],
         ]
 
-        self.hs['FitEngRag box'].children = [
-            self.hs['FitEngRagRow0 box'], self.hs['FitEngRagRow1 box']
+        self.hs["FitEngRag box"].children = [
+            self.hs["FitEngRagRow0 box"],
+            self.hs["FitEngRagRow1 box"],
         ]
         ## ## ## ## ## define type of analysis and energy range -- end
 
-        self.hs['FitEngConfig box'].children = [
-            self.hs['FitTitle box'], self.hs['FitEngRag box']
+        self.hs["FitEngConfig box"].children = [
+            self.hs["FitTitle box"],
+            self.hs["FitEngRag box"],
         ]
         ## ## ## ## fit energy config box -- end
 
         ## ## ## ## ## define fitting parameters -- start
-        self.hs['FitItem tab'] = widgets.Tab()
-        self.hs['FitItem tab'].layout = {
-            'width': 'auto',
-            'height': f'{0.61*(self.form_sz[0]-128)}px'
+        self.hs["FitItem tab"] = widgets.Tab()
+        self.hs["FitItem tab"].layout = {
+            "width": "auto",
+            "height": f"{0.61*(self.form_sz[0]-128)}px",
         }
 
         ## ## ## ## ## ## define analysis options parameters -- start
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitItemConfig box'] = widgets.HBox()
-        self.hs['FitItemConfig box'].layout = layout
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
+        self.hs["FitItemConfig box"] = widgets.HBox()
+        self.hs["FitItemConfig box"].layout = layout
 
         fit_pars_GridspecLayout = widgets.GridspecLayout(
             8,
             200,
-            layout={
-                "border": "3px solid #FFCC00",
-                'width': '100%',
-                "height": '100%'
-            })
+            layout={"border": "3px solid #FFCC00", "width": "100%", "height": "100%"},
+        )
 
         fit_pars_GridspecLayout[0, :39] = widgets.Checkbox(
-            description='fit wl',
+            description="fit wl",
             description_tooltip="fit whiteline if it is checked",
             value=True,
             indent=False,
             disabled=False,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigFitWl chbx'] = fit_pars_GridspecLayout[0, :39]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigFitWl chbx"] = fit_pars_GridspecLayout[0, :39]
 
         fit_pars_GridspecLayout[0, 39:78] = widgets.Checkbox(
-            description='fit edge 50%',
-            description_tooltip=
-            'fit the position where normalized mu is 50% of maximum if it is checked',
+            description="fit edge 50%",
+            description_tooltip="fit the position where normalized mu is 50% of maximum if it is checked",
             value=True,
             indent=False,
             disabled=False,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigFitEdge50% chbx'] = fit_pars_GridspecLayout[
-            0, 39:78]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigFitEdge50% chbx"] = fit_pars_GridspecLayout[0, 39:78]
 
         fit_pars_GridspecLayout[0, 78:117] = widgets.Checkbox(
-            description='filter spec',
-            description_tooltip=
-            'filter spec before fitting edge if it is checked',
+            description="filter spec",
+            description_tooltip="filter spec before fitting edge if it is checked",
             value=False,
             indent=False,
             disabled=False,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigFitSpec chbx'] = fit_pars_GridspecLayout[0,
-                                                                       78:117]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigFitSpec chbx"] = fit_pars_GridspecLayout[0, 78:117]
 
         fit_pars_GridspecLayout[0, 117:156] = widgets.Checkbox(
-            description='wl direct',
-            description_tooltip=
-            'find white-line positions directly from measured spectra',
+            description="wl direct",
+            description_tooltip="find white-line positions directly from measured spectra",
             value=False,
             indent=False,
             disabled=False,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigCalWlDir chbx'] = fit_pars_GridspecLayout[
-            0, 117:156]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigCalWlDir chbx"] = fit_pars_GridspecLayout[0, 117:156]
 
         fit_pars_GridspecLayout[0, 156:195] = widgets.Checkbox(
-            description='edge 50% direct',
-            description_tooltip=
-            'find edge positions at which the normalized mu equal to 50% of their peak values',
+            description="edge 50% direct",
+            description_tooltip="find edge positions at which the normalized mu equal to 50% of their peak values",
             value=False,
             indent=False,
             disabled=False,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigCalEdge50%Dir chbx'] = fit_pars_GridspecLayout[
-            0, 156:195]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigCalEdge50%Dir chbx"] = fit_pars_GridspecLayout[0, 156:195]
 
         fit_pars_GridspecLayout[1, :70] = widgets.FloatSlider(
-            description='edge jump thres',
-            description_tooltip=
-            'edge jump in unit of the standard deviation of the signal in energy range pre to the edge. larger threshold enforces more restrict data quality validation on the data',
+            description="edge jump thres",
+            description_tooltip="edge jump in unit of the standard deviation of the signal in energy range pre to the edge. larger threshold enforces more restrict data quality validation on the data",
             value=1,
             min=0,
             max=50,
             step=0.1,
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigEdgeJumpThres sldr'] = fit_pars_GridspecLayout[
-            1, :70]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigEdgeJumpThres sldr"] = fit_pars_GridspecLayout[1, :70]
 
         fit_pars_GridspecLayout[1, 70:140] = widgets.FloatSlider(
-            description='offset thres',
-            description_tooltip=
-            'offset between pre-edge and post-edge in unit of the standard deviation of pre-edge. larger offser enforces more restrict data quality validation on the data',
+            description="offset thres",
+            description_tooltip="offset between pre-edge and post-edge in unit of the standard deviation of pre-edge. larger offser enforces more restrict data quality validation on the data",
             value=1,
             min=0,
             max=50,
             step=0.1,
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigEdgeOfstThres sldr'] = fit_pars_GridspecLayout[
-            1, 70:140]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigEdgeOfstThres sldr"] = fit_pars_GridspecLayout[1, 70:140]
 
         fit_pars_GridspecLayout[1, 150:200] = widgets.BoundedIntText(
-            description='binning fac',
-            description_tooltip=
-            'binning factor applied to the spec image before xanes analysis',
+            description="binning fac",
+            description_tooltip="binning factor applied to the spec image before xanes analysis",
             value=1,
             min=1,
             max=10,
             step=1,
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigBinFac text'] = fit_pars_GridspecLayout[1,
-                                                                      150:200]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigBinFac text"] = fit_pars_GridspecLayout[1, 150:200]
 
         fit_pars_GridspecLayout[2, :20] = widgets.Checkbox(
-            description='mask preview',
-            description_tooltip='preview edge jump and edge offset masks',
+            description="mask preview",
+            description_tooltip="preview edge jump and edge offset masks",
             value=0,
             indent=False,
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigFitPrvw chbx'] = fit_pars_GridspecLayout[2, :20]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigFitPrvw chbx"] = fit_pars_GridspecLayout[2, :20]
 
         fit_pars_GridspecLayout[3, :70] = widgets.IntSlider(
-            description='xy slice',
-            description_tooltip=
-            'Select a slice to generate edge_jump and edge_offset filters for preview',
+            description="xy slice",
+            description_tooltip="Select a slice to generate edge_jump and edge_offset filters for preview",
             value=0,
             min=0,
             max=10,
             disabled=True,
-            layout={'width': '95%'})
-        self.hs['FitItemConfigFitPrvwSli sldr'] = fit_pars_GridspecLayout[
-            3, :70]
+            layout={"width": "95%"},
+        )
+        self.hs["FitItemConfigFitPrvwSli sldr"] = fit_pars_GridspecLayout[3, :70]
 
         fit_pars_GridspecLayout[3, 80:100] = widgets.Button(
-            description='calc masks',
+            description="calc masks",
             disabled=True,
-            description_tooltip=
-            'Calculate and preview the edge_jump and edge_offset filters',
-            layout={
-                'width': '95%',
-                'height': '70%'
-            })
-        self.hs['FitItemConfigFitPrvwCal btn'] = fit_pars_GridspecLayout[
-            3, 80:100]
-        self.hs[
-            'FitItemConfigFitPrvwCal btn'].style.button_color = 'darkviolet'
+            description_tooltip="Calculate and preview the edge_jump and edge_offset filters",
+            layout={"width": "95%", "height": "70%"},
+        )
+        self.hs["FitItemConfigFitPrvwCal btn"] = fit_pars_GridspecLayout[3, 80:100]
+        self.hs["FitItemConfigFitPrvwCal btn"].style.button_color = "darkviolet"
 
         fit_pars_GridspecLayout[3, 110:130] = widgets.Button(
-            description='EM it',
+            description="EM it",
             disabled=True,
-            description_tooltip=
-            'Calculate and preview the edge_jump and edge_offset filters',
-            layout={
-                'width': '95%',
-                'height': '70%'
-            })
-        self.hs['FitItemConfigFitPrvwEMIt btn'] = fit_pars_GridspecLayout[
-            3, 110:130]
-        self.hs[
-            'FitItemConfigFitPrvwEMIt btn'].style.button_color = 'darkviolet'
+            description_tooltip="Calculate and preview the edge_jump and edge_offset filters",
+            layout={"width": "95%", "height": "70%"},
+        )
+        self.hs["FitItemConfigFitPrvwEMIt btn"] = fit_pars_GridspecLayout[3, 110:130]
+        self.hs["FitItemConfigFitPrvwEMIt btn"].style.button_color = "darkviolet"
 
         fit_pars_GridspecLayout[3, 140:160] = widgets.Button(
-            description='OM it',
+            description="OM it",
             disabled=True,
-            description_tooltip=
-            'Calculate and preview the edge_jump and edge_offset filters',
-            layout={
-                'width': '95%',
-                'height': '70%'
-            })
-        self.hs['FitItemConfigFitPrvwOMIt btn'] = fit_pars_GridspecLayout[
-            3, 140:160]
-        self.hs[
-            'FitItemConfigFitPrvwOMIt btn'].style.button_color = 'darkviolet'
+            description_tooltip="Calculate and preview the edge_jump and edge_offset filters",
+            layout={"width": "95%", "height": "70%"},
+        )
+        self.hs["FitItemConfigFitPrvwOMIt btn"] = fit_pars_GridspecLayout[3, 140:160]
+        self.hs["FitItemConfigFitPrvwOMIt btn"].style.button_color = "darkviolet"
 
         fit_pars_GridspecLayout[3, 170:190] = widgets.Button(
-            description='EM&OM it',
+            description="EM&OM it",
             disabled=True,
-            description_tooltip=
-            'Calculate and preview the edge_jump and edge_offset filters',
-            layout={
-                'width': '95%',
-                'height': '70%'
-            })
-        self.hs['FitItemConfigFitPrvwEMOMIt btn'] = fit_pars_GridspecLayout[
-            3, 170:190]
-        self.hs[
-            'FitItemConfigFitPrvwEMOMIt btn'].style.button_color = 'darkviolet'
+            description_tooltip="Calculate and preview the edge_jump and edge_offset filters",
+            layout={"width": "95%", "height": "70%"},
+        )
+        self.hs["FitItemConfigFitPrvwEMOMIt btn"] = fit_pars_GridspecLayout[3, 170:190]
+        self.hs["FitItemConfigFitPrvwEMOMIt btn"].style.button_color = "darkviolet"
 
         fit_pars_GridspecLayout[4, :40] = widgets.Checkbox(
-            description='LCF',
-            description_tooltip='Linear Combination Fitting',
+            description="LCF",
+            description_tooltip="Linear Combination Fitting",
             value=0,
             indent=False,
             disabled=True,
-            layout={
-                'width': '95%',
-                "height": "95%"
-            })
-        self.hs['FitItemConfigLCF chbx'] = fit_pars_GridspecLayout[4, :40]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitItemConfigLCF chbx"] = fit_pars_GridspecLayout[4, :40]
 
         fit_pars_GridspecLayout[4, 40:80] = widgets.Checkbox(
-            description='Constr',
+            description="Constr",
             value=1,
-            description_tooltip='Apply unity constraint in LCF',
+            description_tooltip="Apply unity constraint in LCF",
             indent=False,
             disabled=True,
-            layout={
-                'width': '95%',
-                "height": "95%"
-            })
-        self.hs['FitItemConfigLCFCnst chbx'] = fit_pars_GridspecLayout[4,
-                                                                       40:80]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitItemConfigLCFCnst chbx"] = fit_pars_GridspecLayout[4, 40:80]
 
         fit_pars_GridspecLayout[5, :40] = widgets.BoundedIntText(
-            description='# of spec',
+            description="# of spec",
             disabled=True,
-            description_tooltip=
-            'total # of reference spectra for Linear Combination Fitting',
+            description_tooltip="total # of reference spectra for Linear Combination Fitting",
             value=2,
             min=2,
             max=5,
             step=1,
             indent=False,
-            layout={
-                'width': '95%',
-                "height": "95%"
-            })
-        self.hs['FitItemConfigLCFNumSpec text'] = fit_pars_GridspecLayout[
-            5, :40]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitItemConfigLCFNumSpec text"] = fit_pars_GridspecLayout[5, :40]
 
         fit_pars_GridspecLayout[6, 14:40] = SelectFilesButton(
-            option='askopenfilename',
-            open_filetypes=(('text files', '*.txt'), ),
-            layout={
-                'width': '95%',
-                "height": "95%"
-            })
-        self.hs['FitItemConfigLCFSelRef btn'] = fit_pars_GridspecLayout[6,
-                                                                        14:40]
-        self.hs['FitItemConfigLCFSelRef btn'].description = "Load Ref Spec"
+            option="askopenfilename",
+            open_filetypes=(("text files", "*.txt"),),
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitItemConfigLCFSelRef btn"] = fit_pars_GridspecLayout[6, 14:40]
+        self.hs["FitItemConfigLCFSelRef btn"].description = "Load Ref Spec"
         try:
-            with open(self.global_h.GUI_cfg_file, 'r') as f:
+            with open(self.global_h.GUI_cfg_file, "r") as f:
                 cfg = json.load(f)
-                self.hs['FitItemConfigLCFSelRef btn'].initialdir = cfg[
-                    'xanes_ref_d']
+                self.hs["FitItemConfigLCFSelRef btn"].initialdir = cfg["xanes_ref_d"]
         except:
-            self.hs['FitItemConfigLCFSelRef btn'].initialdir = os.path.abspath(
-                os.path.curdir)
+            # self.hs['FitItemConfigLCFSelRef btn'].initialdir = os.path.abspath(
+            #     os.path.curdir)
+            self.hs["FitItemConfigLCFSelRef btn"].initialdir = str(
+                Path.cwd().absolute()
+            )
 
-        fit_pars_GridspecLayout[5:8, 50:150] = \
-            widgets.SelectMultiple(options=[], value=[],
-                                   layout={"width": "95%", "height": "95%"},
-                                   rows=10, description='Ref Specs', disabled=True)
-        self.hs['FitItemConfigLCFRef list'] = fit_pars_GridspecLayout[5:8,
-                                                                      50:150]
-
-        fit_pars_GridspecLayout[6,
-                                170:190] = widgets.Button(layout={
-                                    'width': "95%",
-                                    "height": "70%"
-                                },
-                                                          description='Remove',
-                                                          disabled=True)
-        self.hs['FitItemConfigLCFRmRef btn'] = fit_pars_GridspecLayout[6,
-                                                                       170:190]
-        self.hs['FitItemConfigLCFRmRef btn'].style.button_color = 'darkviolet'
-
-        self.hs['FitItemConfigFitWl chbx'].observe(
-            self.fit_config_fit_wl_chbx_chg, names='value')
-        self.hs['FitItemConfigFitEdge50% chbx'].observe(
-            self.fit_config_fit_edge50_chbx_chg, names='value')
-        self.hs['FitItemConfigFitSpec chbx'].observe(
-            self.fit_config_flt_spec_chbx_chg, names='value')
-        self.hs['FitItemConfigCalWlDir chbx'].observe(
-            self.fit_config_cal_wl_dir_chbx_chg, names='value')
-        self.hs['FitItemConfigCalEdge50%Dir chbx'].observe(
-            self.fit_config_cal_edge50_dir_chbx_chg, names='value')
-        self.hs['FitItemConfigEdgeJumpThres sldr'].observe(
-            self.fit_config_fit_edge_jump_thres_sldr_chg, names='value')
-        self.hs['FitItemConfigEdgeOfstThres sldr'].observe(
-            self.fit_config_fit_edge_ofst_thres_sldr_chg, names='value')
-        self.hs['FitItemConfigBinFac text'].observe(
-            self.fit_config_bin_fac_text_chg, names='value')
-        self.hs['FitItemConfigFitPrvw chbx'].observe(
-            self.fit_config_mask_prvw_chbx_chg, names='value')
-        self.hs['FitItemConfigFitPrvwSli sldr'].observe(
-            self.fit_config_flt_prvw_sli_sldr_chg, names='value')
-        self.hs['FitItemConfigFitPrvwCal btn'].on_click(
-            self.fit_config_flt_prvw_calc_btn_clk)
-        self.hs['FitItemConfigFitPrvwEMIt btn'].on_click(
-            self.fit_config_flt_prvw_em_it_btn_clk)
-        self.hs['FitItemConfigFitPrvwOMIt btn'].on_click(
-            self.fit_config_flt_prvw_om_it_btn_clk)
-        self.hs['FitItemConfigFitPrvwEMOMIt btn'].on_click(
-            self.fit_config_flt_prvw_emom_it_btn_clk)
-        self.hs['FitItemConfigLCF chbx'].observe(self.fit_config_lcf_chbx_chg,
-                                                 names='value')
-        self.hs['FitItemConfigLCFCnst chbx'].observe(
-            self.fit_config_lcf_cnst_chbx_chg, names='value')
-        self.hs['FitItemConfigLCFNumSpec text'].observe(
-            self.fit_config_num_spec_text_chg, names='value')
-        self.hs['FitItemConfigLCFSelRef btn'].on_click(
-            self.fit_config_sel_ref_btn_clk)
-        self.hs['FitItemConfigLCFRef list'].observe(
-            self.fit_config_ref_spec_list_chg, names='value')
-        self.hs['FitItemConfigLCFRmRef btn'].on_click(
-            self.fit_config_ref_rm_btn_clk)
-
-        self.hs['FitItemConfig box'] = fit_pars_GridspecLayout
-        self.hs['FitItemConfig box'].children = [
-            self.hs['FitItemConfigFitWl chbx'],
-            self.hs['FitItemConfigFitEdge50% chbx'],
-            self.hs['FitItemConfigFitSpec chbx'],
-            self.hs['FitItemConfigCalWlDir chbx'],
-            self.hs['FitItemConfigCalEdge50%Dir chbx'],
-            self.hs['FitItemConfigEdgeJumpThres sldr'],
-            self.hs['FitItemConfigEdgeOfstThres sldr'],
-            self.hs['FitItemConfigBinFac text'],
-            self.hs['FitItemConfigFitPrvw chbx'],
-            self.hs['FitItemConfigFitPrvwSli sldr'],
-            self.hs['FitItemConfigFitPrvwCal btn'],
-            self.hs['FitItemConfigFitPrvwEMIt btn'],
-            self.hs['FitItemConfigFitPrvwOMIt btn'],
-            self.hs['FitItemConfigFitPrvwEMOMIt btn'],
-            self.hs['FitItemConfigLCF chbx'],
-            self.hs['FitItemConfigLCFCnst chbx'],
-            self.hs['FitItemConfigLCFNumSpec text'],
-            self.hs['FitItemConfigLCFSelRef btn'],
-            self.hs['FitItemConfigLCFRef list'],
-            self.hs['FitItemConfigLCFRmRef btn']
+        fit_pars_GridspecLayout[5:8, 50:150] = widgets.SelectMultiple(
+            options=[],
+            value=[],
+            layout={"width": "95%", "height": "95%"},
+            rows=10,
+            description="Ref Specs",
+            disabled=True,
+        )
+        self.hs["FitItemConfigLCFRef list"] = fit_pars_GridspecLayout[5:8, 50:150]
+
+        fit_pars_GridspecLayout[6, 170:190] = widgets.Button(
+            layout={"width": "95%", "height": "70%"},
+            description="Remove",
+            disabled=True,
+        )
+        self.hs["FitItemConfigLCFRmRef btn"] = fit_pars_GridspecLayout[6, 170:190]
+        self.hs["FitItemConfigLCFRmRef btn"].style.button_color = "darkviolet"
+
+        self.hs["FitItemConfigFitWl chbx"].observe(
+            self.fit_config_fit_wl_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigFitEdge50% chbx"].observe(
+            self.fit_config_fit_edge50_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigFitSpec chbx"].observe(
+            self.fit_config_flt_spec_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigCalWlDir chbx"].observe(
+            self.fit_config_cal_wl_dir_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigCalEdge50%Dir chbx"].observe(
+            self.fit_config_cal_edge50_dir_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigEdgeJumpThres sldr"].observe(
+            self.fit_config_fit_edge_jump_thres_sldr_chg, names="value"
+        )
+        self.hs["FitItemConfigEdgeOfstThres sldr"].observe(
+            self.fit_config_fit_edge_ofst_thres_sldr_chg, names="value"
+        )
+        self.hs["FitItemConfigBinFac text"].observe(
+            self.fit_config_bin_fac_text_chg, names="value"
+        )
+        self.hs["FitItemConfigFitPrvw chbx"].observe(
+            self.fit_config_mask_prvw_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigFitPrvwSli sldr"].observe(
+            self.fit_config_flt_prvw_sli_sldr_chg, names="value"
+        )
+        self.hs["FitItemConfigFitPrvwCal btn"].on_click(
+            self.fit_config_flt_prvw_calc_btn_clk
+        )
+        self.hs["FitItemConfigFitPrvwEMIt btn"].on_click(
+            self.fit_config_flt_prvw_em_it_btn_clk
+        )
+        self.hs["FitItemConfigFitPrvwOMIt btn"].on_click(
+            self.fit_config_flt_prvw_om_it_btn_clk
+        )
+        self.hs["FitItemConfigFitPrvwEMOMIt btn"].on_click(
+            self.fit_config_flt_prvw_emom_it_btn_clk
+        )
+        self.hs["FitItemConfigLCF chbx"].observe(
+            self.fit_config_lcf_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigLCFCnst chbx"].observe(
+            self.fit_config_lcf_cnst_chbx_chg, names="value"
+        )
+        self.hs["FitItemConfigLCFNumSpec text"].observe(
+            self.fit_config_num_spec_text_chg, names="value"
+        )
+        self.hs["FitItemConfigLCFSelRef btn"].on_click(self.fit_config_sel_ref_btn_clk)
+        self.hs["FitItemConfigLCFRef list"].observe(
+            self.fit_config_ref_spec_list_chg, names="value"
+        )
+        self.hs["FitItemConfigLCFRmRef btn"].on_click(self.fit_config_ref_rm_btn_clk)
+
+        self.hs["FitItemConfig box"] = fit_pars_GridspecLayout
+        self.hs["FitItemConfig box"].children = [
+            self.hs["FitItemConfigFitWl chbx"],
+            self.hs["FitItemConfigFitEdge50% chbx"],
+            self.hs["FitItemConfigFitSpec chbx"],
+            self.hs["FitItemConfigCalWlDir chbx"],
+            self.hs["FitItemConfigCalEdge50%Dir chbx"],
+            self.hs["FitItemConfigEdgeJumpThres sldr"],
+            self.hs["FitItemConfigEdgeOfstThres sldr"],
+            self.hs["FitItemConfigBinFac text"],
+            self.hs["FitItemConfigFitPrvw chbx"],
+            self.hs["FitItemConfigFitPrvwSli sldr"],
+            self.hs["FitItemConfigFitPrvwCal btn"],
+            self.hs["FitItemConfigFitPrvwEMIt btn"],
+            self.hs["FitItemConfigFitPrvwOMIt btn"],
+            self.hs["FitItemConfigFitPrvwEMOMIt btn"],
+            self.hs["FitItemConfigLCF chbx"],
+            self.hs["FitItemConfigLCFCnst chbx"],
+            self.hs["FitItemConfigLCFNumSpec text"],
+            self.hs["FitItemConfigLCFSelRef btn"],
+            self.hs["FitItemConfigLCFRef list"],
+            self.hs["FitItemConfigLCFRmRef btn"],
         ]
         ## ## ## ## ## ## define analysis options parameters -- end
 
         ## ## ## ## ## ## define wl fitting parameters -- start
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitConfigWlPars box'] = widgets.HBox()
-        self.hs['FitConfigWlPars box'].layout = layout
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
+        self.hs["FitConfigWlPars box"] = widgets.HBox()
+        self.hs["FitConfigWlPars box"].layout = layout
 
         fit_wl_pars_GridspecLayout = widgets.GridspecLayout(
             8,
             200,
-            layout={
-                "border": "3px solid #FFCC00",
-                'width': '100%',
-                'height': '100%'
-            })
+            layout={"border": "3px solid #FFCC00", "width": "100%", "height": "100%"},
+        )
 
         fit_wl_pars_GridspecLayout[0, :50] = widgets.Dropdown(
-            description='optimizer',
-            value='numpy',
+            description="optimizer",
+            value="numpy",
             isabled=True,
-            description_tooltip='use scipy.optimize or numpy.polyfit',
-            options=['scipy', 'numpy'],
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigWlOptmzr drpdn'] = fit_wl_pars_GridspecLayout[0, :50]
+            description_tooltip="use scipy.optimize or numpy.polyfit",
+            options=["scipy", "numpy"],
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigWlOptmzr drpdn"] = fit_wl_pars_GridspecLayout[0, :50]
         fit_wl_pars_GridspecLayout[0, 50:100] = widgets.Dropdown(
-            description='peak func',
+            description="peak func",
             disabled=True,
-            description_tooltip='peak fitting functions',
+            description_tooltip="peak fitting functions",
             options=[2, 3, 4],
             value=2,
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigWlFunc drpdn'] = fit_wl_pars_GridspecLayout[0,
-                                                                      50:100]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigWlFunc drpdn"] = fit_wl_pars_GridspecLayout[0, 50:100]
         fit_wl_pars_GridspecLayout[0, 100:150] = widgets.Checkbox(
-            description='para bnd',
+            description="para bnd",
             value=False,
             disabled=True,
-            description_tooltip=
-            "if set boundaries to the peak fitting function's parameters",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigWlFitUseBnd chbx'] = fit_wl_pars_GridspecLayout[
-            0, 100:150]
+            description_tooltip="if set boundaries to the peak fitting function's parameters",
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigWlFitUseBnd chbx"] = fit_wl_pars_GridspecLayout[0, 100:150]
 
         fit_wl_pars_GridspecLayout[1, 0:50] = widgets.BoundedFloatText(
-            description='p0',
+            description="p0",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 0",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars0 text'] = fit_wl_pars_GridspecLayout[1,
-                                                                         0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars0 text"] = fit_wl_pars_GridspecLayout[1, 0:50]
         fit_wl_pars_GridspecLayout[1, 50:100] = widgets.BoundedFloatText(
-            description='p1',
+            description="p1",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 1",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars1 text'] = fit_wl_pars_GridspecLayout[
-            1, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars1 text"] = fit_wl_pars_GridspecLayout[1, 50:100]
         fit_wl_pars_GridspecLayout[1, 100:150] = widgets.BoundedFloatText(
-            description='p2',
+            description="p2",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 2",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars2 text'] = fit_wl_pars_GridspecLayout[
-            1, 100:150]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars2 text"] = fit_wl_pars_GridspecLayout[1, 100:150]
         fit_wl_pars_GridspecLayout[1, 150:200] = widgets.BoundedFloatText(
-            description='p3',
+            description="p3",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 3",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars3 text'] = fit_wl_pars_GridspecLayout[
-            1, 150:200]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars3 text"] = fit_wl_pars_GridspecLayout[1, 150:200]
 
         fit_wl_pars_GridspecLayout[2, 0:50] = widgets.BoundedFloatText(
-            description='p4',
+            description="p4",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 4",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars4 text'] = fit_wl_pars_GridspecLayout[2,
-                                                                         0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars4 text"] = fit_wl_pars_GridspecLayout[2, 0:50]
         fit_wl_pars_GridspecLayout[2, 50:100] = widgets.Dropdown(
-            description='p5',
-            value='linear',
-            options=['linear'],
+            description="p5",
+            value="linear",
+            options=["linear"],
             description_tooltip="fitting function variable 5",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars5 text'] = fit_wl_pars_GridspecLayout[
-            2, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars5 text"] = fit_wl_pars_GridspecLayout[2, 50:100]
 
         fit_wl_pars_GridspecLayout[3, 0:50] = widgets.Dropdown(
-            description='jac',
-            value='3-point',
+            description="jac",
+            value="3-point",
             disabled=True,
-            options=['2-point', '3-point', 'cs'],
+            options=["2-point", "3-point", "cs"],
             description_tooltip="",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigWlFitJac drpdn'] = fit_wl_pars_GridspecLayout[3,
-                                                                        0:50]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigWlFitJac drpdn"] = fit_wl_pars_GridspecLayout[3, 0:50]
         fit_wl_pars_GridspecLayout[3, 50:100] = widgets.Dropdown(
-            description='method',
-            value='trf',
+            description="method",
+            value="trf",
             disabled=True,
-            options=['trf', 'dogbox', 'lm'],
+            options=["trf", "dogbox", "lm"],
             description_tooltip="",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigWlFitMeth drpdn'] = fit_wl_pars_GridspecLayout[
-            3, 50:100]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigWlFitMeth drpdn"] = fit_wl_pars_GridspecLayout[3, 50:100]
         fit_wl_pars_GridspecLayout[3, 100:150] = widgets.BoundedFloatText(
-            description='ftol',
+            description="ftol",
             value=1e-7,
             min=0,
             max=1e-3,
-            description_tooltip=
-            "function value change tolerance for terminating the optimization process",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitFtol text'] = fit_wl_pars_GridspecLayout[
-            3, 100:150]
+            description_tooltip="function value change tolerance for terminating the optimization process",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitFtol text"] = fit_wl_pars_GridspecLayout[3, 100:150]
         fit_wl_pars_GridspecLayout[3, 150:200] = widgets.BoundedFloatText(
-            description='xtol',
+            description="xtol",
             value=1e-7,
             min=0,
             max=1e-3,
-            description_tooltip=
-            "function parameter change tolerance for terminating the optimization process",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitXtol text'] = fit_wl_pars_GridspecLayout[
-            3, 150:200]
+            description_tooltip="function parameter change tolerance for terminating the optimization process",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitXtol text"] = fit_wl_pars_GridspecLayout[3, 150:200]
         fit_wl_pars_GridspecLayout[4, 0:50] = widgets.BoundedFloatText(
-            description='gtol',
+            description="gtol",
             value=1e-7,
             min=0,
             max=1e-3,
-            description_tooltip=
-            "function gradient change tolerance for terminating the optimization process",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitGtol text'] = fit_wl_pars_GridspecLayout[4,
-                                                                        0:50]
+            description_tooltip="function gradient change tolerance for terminating the optimization process",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitGtol text"] = fit_wl_pars_GridspecLayout[4, 0:50]
         fit_wl_pars_GridspecLayout[4, 50:100] = widgets.BoundedIntText(
-            description='ufac',
+            description="ufac",
             value=50,
             min=1,
             max=100,
-            description_tooltip=
-            "upsampling factor to energy points in peak fitting",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitUfac text'] = fit_wl_pars_GridspecLayout[4,
-                                                                        50:100]
+            description_tooltip="upsampling factor to energy points in peak fitting",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitUfac text"] = fit_wl_pars_GridspecLayout[4, 50:100]
 
         fit_wl_pars_GridspecLayout[5, 0:50] = widgets.BoundedFloatText(
-            description='p0 lb',
+            description="p0 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p0 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars0Lb text'] = fit_wl_pars_GridspecLayout[
-            5, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars0Lb text"] = fit_wl_pars_GridspecLayout[5, 0:50]
         fit_wl_pars_GridspecLayout[5, 50:100] = widgets.BoundedFloatText(
-            description='p0 ub',
+            description="p0 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p0 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars0Ub text'] = fit_wl_pars_GridspecLayout[
-            5, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars0Ub text"] = fit_wl_pars_GridspecLayout[5, 50:100]
         fit_wl_pars_GridspecLayout[5, 100:150] = widgets.BoundedFloatText(
-            description='p1 lb',
+            description="p1 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p1 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars1Lb text'] = fit_wl_pars_GridspecLayout[
-            5, 100:150]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars1Lb text"] = fit_wl_pars_GridspecLayout[5, 100:150]
         fit_wl_pars_GridspecLayout[5, 150:200] = widgets.BoundedFloatText(
-            description='p1 ub',
+            description="p1 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p1 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars1Ub text'] = fit_wl_pars_GridspecLayout[
-            5, 150:200]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars1Ub text"] = fit_wl_pars_GridspecLayout[5, 150:200]
 
         fit_wl_pars_GridspecLayout[6, 0:50] = widgets.BoundedFloatText(
-            description='p2 lb',
+            description="p2 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p2 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars2Lb text'] = fit_wl_pars_GridspecLayout[
-            6, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars2Lb text"] = fit_wl_pars_GridspecLayout[6, 0:50]
         fit_wl_pars_GridspecLayout[6, 50:100] = widgets.BoundedFloatText(
-            description='p3 ub',
+            description="p3 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p3 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars2Ub text'] = fit_wl_pars_GridspecLayout[
-            6, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars2Ub text"] = fit_wl_pars_GridspecLayout[6, 50:100]
         fit_wl_pars_GridspecLayout[6, 100:150] = widgets.BoundedFloatText(
-            description='p4 lb',
+            description="p4 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p4 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars3Lb text'] = fit_wl_pars_GridspecLayout[
-            6, 100:150]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars3Lb text"] = fit_wl_pars_GridspecLayout[6, 100:150]
         fit_wl_pars_GridspecLayout[6, 150:200] = widgets.BoundedFloatText(
-            description='p4 ub',
+            description="p4 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p4 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars3Ub text'] = fit_wl_pars_GridspecLayout[
-            6, 150:200]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars3Ub text"] = fit_wl_pars_GridspecLayout[6, 150:200]
 
         fit_wl_pars_GridspecLayout[7, 0:50] = widgets.BoundedFloatText(
-            description='p5 lb',
+            description="p5 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p5 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars4Lb text'] = fit_wl_pars_GridspecLayout[
-            7, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars4Lb text"] = fit_wl_pars_GridspecLayout[7, 0:50]
         fit_wl_pars_GridspecLayout[7, 50:100] = widgets.BoundedFloatText(
-            description='p5 ub',
+            description="p5 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p5 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigWlFitPars4Ub text'] = fit_wl_pars_GridspecLayout[
-            7, 50:100]
-
-        self.hs['FitConfigWlOptmzr drpdn'].observe(
-            self.fit_config_wl_optmzr_drpdn_chg, names='value')
-        self.hs['FitConfigWlFunc drpdn'].observe(
-            self.fit_config_wl_func_drpdn_chg, names='value')
-        self.hs['FitConfigWlFitUseBnd chbx'].observe(
-            self.fit_config_wl_fit_bnd_chbx_chg, names='value')
-
-        self.hs['FitConfigWlPars box'] = fit_wl_pars_GridspecLayout
-        self.hs['FitConfigWlPars box'].children = [
-            self.hs['FitConfigWlOptmzr drpdn'],
-            self.hs['FitConfigWlFunc drpdn'],
-            self.hs['FitConfigWlFitUseBnd chbx'],
-            self.hs['FitConfigWlFitPars0 text'],
-            self.hs['FitConfigWlFitPars1 text'],
-            self.hs['FitConfigWlFitPars2 text'],
-            self.hs['FitConfigWlFitPars3 text'],
-            self.hs['FitConfigWlFitPars4 text'],
-            self.hs['FitConfigWlFitPars5 text'],
-            self.hs['FitConfigWlFitJac drpdn'],
-            self.hs['FitConfigWlFitMeth drpdn'],
-            self.hs['FitConfigWlFitFtol text'],
-            self.hs['FitConfigWlFitXtol text'],
-            self.hs['FitConfigWlFitGtol text'],
-            self.hs['FitConfigWlFitUfac text'],
-            self.hs['FitConfigWlFitPars0Lb text'],
-            self.hs['FitConfigWlFitPars0Ub text'],
-            self.hs['FitConfigWlFitPars1Lb text'],
-            self.hs['FitConfigWlFitPars1Ub text'],
-            self.hs['FitConfigWlFitPars2Lb text'],
-            self.hs['FitConfigWlFitPars2Ub text'],
-            self.hs['FitConfigWlFitPars3Lb text'],
-            self.hs['FitConfigWlFitPars3Ub text'],
-            self.hs['FitConfigWlFitPars4Lb text'],
-            self.hs['FitConfigWlFitPars4Ub text']
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigWlFitPars4Ub text"] = fit_wl_pars_GridspecLayout[7, 50:100]
+
+        self.hs["FitConfigWlOptmzr drpdn"].observe(
+            self.fit_config_wl_optmzr_drpdn_chg, names="value"
+        )
+        self.hs["FitConfigWlFunc drpdn"].observe(
+            self.fit_config_wl_func_drpdn_chg, names="value"
+        )
+        self.hs["FitConfigWlFitUseBnd chbx"].observe(
+            self.fit_config_wl_fit_bnd_chbx_chg, names="value"
+        )
+
+        self.hs["FitConfigWlPars box"] = fit_wl_pars_GridspecLayout
+        self.hs["FitConfigWlPars box"].children = [
+            self.hs["FitConfigWlOptmzr drpdn"],
+            self.hs["FitConfigWlFunc drpdn"],
+            self.hs["FitConfigWlFitUseBnd chbx"],
+            self.hs["FitConfigWlFitPars0 text"],
+            self.hs["FitConfigWlFitPars1 text"],
+            self.hs["FitConfigWlFitPars2 text"],
+            self.hs["FitConfigWlFitPars3 text"],
+            self.hs["FitConfigWlFitPars4 text"],
+            self.hs["FitConfigWlFitPars5 text"],
+            self.hs["FitConfigWlFitJac drpdn"],
+            self.hs["FitConfigWlFitMeth drpdn"],
+            self.hs["FitConfigWlFitFtol text"],
+            self.hs["FitConfigWlFitXtol text"],
+            self.hs["FitConfigWlFitGtol text"],
+            self.hs["FitConfigWlFitUfac text"],
+            self.hs["FitConfigWlFitPars0Lb text"],
+            self.hs["FitConfigWlFitPars0Ub text"],
+            self.hs["FitConfigWlFitPars1Lb text"],
+            self.hs["FitConfigWlFitPars1Ub text"],
+            self.hs["FitConfigWlFitPars2Lb text"],
+            self.hs["FitConfigWlFitPars2Ub text"],
+            self.hs["FitConfigWlFitPars3Lb text"],
+            self.hs["FitConfigWlFitPars3Ub text"],
+            self.hs["FitConfigWlFitPars4Lb text"],
+            self.hs["FitConfigWlFitPars4Ub text"],
         ]
         ## ## ## ## ## ## define wl fitting parameters -- end
 
         ## ## ## ## ## ## define edge fitting parameters -- start
         # layout = {'border':'3px solid #FFCC00', 'width':f'{0.96*self.form_sz[1]-98}px', 'height':f'{0.49*(self.form_sz[0]-128)}px'}
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitConfigEdgePars box'] = widgets.HBox()
-        self.hs['FitConfigEdgePars box'].layout = layout
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
+        self.hs["FitConfigEdgePars box"] = widgets.HBox()
+        self.hs["FitConfigEdgePars box"].layout = layout
 
         fit_edge_pars_GridspecLayout = widgets.GridspecLayout(
             8,
             200,
-            layout={
-                "border": "3px solid #FFCC00",
-                'width': '100%',
-                'height': '100%'
-            })
+            layout={"border": "3px solid #FFCC00", "width": "100%", "height": "100%"},
+        )
 
         fit_edge_pars_GridspecLayout[0, 0:50] = widgets.Dropdown(
-            description='optimizer',
-            value='numpy',
+            description="optimizer",
+            value="numpy",
             disabled=True,
-            description_tooltip='use scipy.optimize or numpy.polyfit',
-            options=['scipy', 'numpy'],
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigEdgeOptmzr drpdn'] = fit_edge_pars_GridspecLayout[
-            0, 0:50]
+            description_tooltip="use scipy.optimize or numpy.polyfit",
+            options=["scipy", "numpy"],
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigEdgeOptmzr drpdn"] = fit_edge_pars_GridspecLayout[0, 0:50]
         fit_edge_pars_GridspecLayout[0, 50:100] = widgets.Dropdown(
-            description='fit func',
+            description="fit func",
             disabled=True,
-            description_tooltip='edge fitting functions',
+            description_tooltip="edge fitting functions",
             options=[2, 3, 4],
             value=3,
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigEdgeFunc drpdn'] = fit_edge_pars_GridspecLayout[
-            0, 50:100]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigEdgeFunc drpdn"] = fit_edge_pars_GridspecLayout[0, 50:100]
         fit_edge_pars_GridspecLayout[0, 100:150] = widgets.Checkbox(
-            description='para bnd',
+            description="para bnd",
             value=False,
             disabled=True,
-            description_tooltip=
-            "if set boundaries to the peak fitting function's parameters",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigEdgeFitUseBnd chbx'] = fit_edge_pars_GridspecLayout[
-            0, 100:150]
+            description_tooltip="if set boundaries to the peak fitting function's parameters",
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigEdgeFitUseBnd chbx"] = fit_edge_pars_GridspecLayout[
+            0, 100:150
+        ]
 
         fit_edge_pars_GridspecLayout[1, 0:50] = widgets.BoundedFloatText(
-            description='p0',
+            description="p0",
             value=0,
             min=-1e5,
             ma=1e5,
             description_tooltip="fitting function variable 0",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars0 text'] = fit_edge_pars_GridspecLayout[
-            1, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars0 text"] = fit_edge_pars_GridspecLayout[1, 0:50]
         fit_edge_pars_GridspecLayout[1, 50:100] = widgets.BoundedFloatText(
-            description='p1',
+            description="p1",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 1",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars1 text'] = fit_edge_pars_GridspecLayout[
-            1, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars1 text"] = fit_edge_pars_GridspecLayout[1, 50:100]
         fit_edge_pars_GridspecLayout[1, 100:150] = widgets.BoundedFloatText(
-            description='p2',
+            description="p2",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 2",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars2 text'] = fit_edge_pars_GridspecLayout[
-            1, 100:150]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars2 text"] = fit_edge_pars_GridspecLayout[1, 100:150]
         fit_edge_pars_GridspecLayout[1, 150:200] = widgets.BoundedFloatText(
-            description='p3',
+            description="p3",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 3",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars3 text'] = fit_edge_pars_GridspecLayout[
-            1, 150:200]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars3 text"] = fit_edge_pars_GridspecLayout[1, 150:200]
 
         fit_edge_pars_GridspecLayout[2, 0:50] = widgets.BoundedFloatText(
-            description='p4',
+            description="p4",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="fitting function variable 4",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars4 text'] = fit_edge_pars_GridspecLayout[
-            2, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars4 text"] = fit_edge_pars_GridspecLayout[2, 0:50]
         fit_edge_pars_GridspecLayout[2, 50:100] = widgets.Dropdown(
-            description='p5',
-            value='linear',
-            options=['linear'],
+            description="p5",
+            value="linear",
+            options=["linear"],
             description_tooltip="fitting function variable 5",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars5 text'] = fit_edge_pars_GridspecLayout[
-            2, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars5 text"] = fit_edge_pars_GridspecLayout[2, 50:100]
 
         fit_edge_pars_GridspecLayout[3, 0:50] = widgets.Dropdown(
-            description='jac',
-            value='3-point',
-            options=['2-point', '3-point', 'cs'],
+            description="jac",
+            value="3-point",
+            options=["2-point", "3-point", "cs"],
             description_tooltip="",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitJac drpdn'] = fit_edge_pars_GridspecLayout[
-            3, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitJac drpdn"] = fit_edge_pars_GridspecLayout[3, 0:50]
         fit_edge_pars_GridspecLayout[3, 50:100] = widgets.Dropdown(
-            description='method',
-            value='trf',
+            description="method",
+            value="trf",
             disabled=True,
-            options=['trf', 'dogbox', 'lm'],
+            options=["trf", "dogbox", "lm"],
             description_tooltip="",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            })
-        self.hs['FitConfigEdgeFitMeth drpdn'] = fit_edge_pars_GridspecLayout[
-            3, 50:100]
+            layout={"width": "95%", "height": "95%"},
+        )
+        self.hs["FitConfigEdgeFitMeth drpdn"] = fit_edge_pars_GridspecLayout[3, 50:100]
         fit_edge_pars_GridspecLayout[3, 100:150] = widgets.BoundedFloatText(
-            description='ftol',
+            description="ftol",
             value=1e-7,
             min=0,
             max=1e-3,
-            description_tooltip=
-            "function value change tolerance for terminating the optimization process",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitFtol text'] = fit_edge_pars_GridspecLayout[
-            3, 100:150]
+            description_tooltip="function value change tolerance for terminating the optimization process",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitFtol text"] = fit_edge_pars_GridspecLayout[3, 100:150]
         fit_edge_pars_GridspecLayout[3, 150:200] = widgets.BoundedFloatText(
-            description='xtol',
+            description="xtol",
             value=1e-7,
             min=0,
             max=1e-3,
-            description_tooltip=
-            "function parameter change tolerance for terminating the optimization process",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitXtol text'] = fit_edge_pars_GridspecLayout[
-            3, 150:200]
+            description_tooltip="function parameter change tolerance for terminating the optimization process",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitXtol text"] = fit_edge_pars_GridspecLayout[3, 150:200]
         fit_edge_pars_GridspecLayout[4, 0:50] = widgets.BoundedFloatText(
-            description='gtol',
+            description="gtol",
             value=1e-7,
             min=0,
             max=1e-3,
-            description_tooltip=
-            "function gradient change tolerance for terminating the optimization process",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitGtol text'] = fit_edge_pars_GridspecLayout[
-            4, 0:50]
+            description_tooltip="function gradient change tolerance for terminating the optimization process",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitGtol text"] = fit_edge_pars_GridspecLayout[4, 0:50]
         fit_edge_pars_GridspecLayout[4, 50:100] = widgets.BoundedIntText(
-            description='ufac',
+            description="ufac",
             value=50,
             min=1,
             max=100,
-            description_tooltip=
-            "upsampling factor to energy points in peak fitting",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitUfac text'] = fit_edge_pars_GridspecLayout[
-            4, 50:100]
+            description_tooltip="upsampling factor to energy points in peak fitting",
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitUfac text"] = fit_edge_pars_GridspecLayout[4, 50:100]
 
         fit_edge_pars_GridspecLayout[5, 0:50] = widgets.BoundedFloatText(
-            description='p0 lb',
+            description="p0 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p0 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars0Lb text'] = fit_edge_pars_GridspecLayout[
-            5, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars0Lb text"] = fit_edge_pars_GridspecLayout[5, 0:50]
         fit_edge_pars_GridspecLayout[5, 50:100] = widgets.BoundedFloatText(
-            description='p0 ub',
+            description="p0 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p0 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars0Ub text'] = fit_edge_pars_GridspecLayout[
-            5, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars0Ub text"] = fit_edge_pars_GridspecLayout[
+            5, 50:100
+        ]
         fit_edge_pars_GridspecLayout[5, 100:150] = widgets.BoundedFloatText(
-            description='p1 lb',
+            description="p1 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p1 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars1Lb text'] = fit_edge_pars_GridspecLayout[
-            5, 100:150]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars1Lb text"] = fit_edge_pars_GridspecLayout[
+            5, 100:150
+        ]
         fit_edge_pars_GridspecLayout[5, 150:200] = widgets.BoundedFloatText(
-            description='p1 ub',
+            description="p1 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p1 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars1Ub text'] = fit_edge_pars_GridspecLayout[
-            5, 150:200]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars1Ub text"] = fit_edge_pars_GridspecLayout[
+            5, 150:200
+        ]
 
         fit_edge_pars_GridspecLayout[6, 0:50] = widgets.BoundedFloatText(
-            description='p2 lb',
+            description="p2 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p2 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars2Lb text'] = fit_edge_pars_GridspecLayout[
-            6, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars2Lb text"] = fit_edge_pars_GridspecLayout[6, 0:50]
         fit_edge_pars_GridspecLayout[6, 50:100] = widgets.BoundedFloatText(
-            description='p3 ub',
+            description="p3 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p3 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars2Ub text'] = fit_edge_pars_GridspecLayout[
-            6, 50:100]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars2Ub text"] = fit_edge_pars_GridspecLayout[
+            6, 50:100
+        ]
         fit_edge_pars_GridspecLayout[6, 100:150] = widgets.BoundedFloatText(
-            description='p4 lb',
+            description="p4 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p4 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars3Lb text'] = fit_edge_pars_GridspecLayout[
-            6, 100:150]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars3Lb text"] = fit_edge_pars_GridspecLayout[
+            6, 100:150
+        ]
         fit_edge_pars_GridspecLayout[6, 150:200] = widgets.BoundedFloatText(
-            description='p4 ub',
+            description="p4 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p4 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars3Ub text'] = fit_edge_pars_GridspecLayout[
-            6, 150:200]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars3Ub text"] = fit_edge_pars_GridspecLayout[
+            6, 150:200
+        ]
 
         fit_edge_pars_GridspecLayout[7, 0:50] = widgets.BoundedFloatText(
-            description='p5 lb',
+            description="p5 lb",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p5 lower bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars4Lb text'] = fit_edge_pars_GridspecLayout[
-            7, 0:50]
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars4Lb text"] = fit_edge_pars_GridspecLayout[7, 0:50]
         fit_edge_pars_GridspecLayout[7, 50:100] = widgets.BoundedFloatText(
-            description='p5 ub',
+            description="p5 ub",
             value=0,
             min=-1e5,
             max=1e5,
             description_tooltip="p5 upper bound",
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            disabled=True)
-        self.hs['FitConfigEdgeFitPars4Ub text'] = fit_edge_pars_GridspecLayout[
-            7, 50:100]
-
-        self.hs['FitConfigEdgeOptmzr drpdn'].observe(
-            self.fit_config_edge_optmzr_drpdn_chg, names='value')
-        self.hs['FitConfigEdgeFunc drpdn'].observe(
-            self.fit_config_edge_func_drpdn_chg, names='value')
-        self.hs['FitConfigEdgeFitUseBnd chbx'].observe(
-            self.fit_config_edge_fit_bnd_chbx_chg, names='value')
-
-        self.hs['FitConfigEdgePars box'] = fit_edge_pars_GridspecLayout
-        self.hs['FitConfigEdgePars box'].children = [
-            self.hs['FitConfigEdgeOptmzr drpdn'],
-            self.hs['FitConfigEdgeFunc drpdn'],
-            self.hs['FitConfigEdgeFitUseBnd chbx'],
-            self.hs['FitConfigEdgeFitPars0 text'],
-            self.hs['FitConfigEdgeFitPars1 text'],
-            self.hs['FitConfigEdgeFitPars2 text'],
-            self.hs['FitConfigEdgeFitPars3 text'],
-            self.hs['FitConfigEdgeFitPars4 text'],
-            self.hs['FitConfigEdgeFitPars5 text'],
-            self.hs['FitConfigEdgeFitJac drpdn'],
-            self.hs['FitConfigEdgeFitMeth drpdn'],
-            self.hs['FitConfigEdgeFitFtol text'],
-            self.hs['FitConfigEdgeFitXtol text'],
-            self.hs['FitConfigEdgeFitGtol text'],
-            self.hs['FitConfigEdgeFitUfac text'],
-            self.hs['FitConfigEdgeFitPars0Lb text'],
-            self.hs['FitConfigEdgeFitPars0Ub text'],
-            self.hs['FitConfigEdgeFitPars1Lb text'],
-            self.hs['FitConfigEdgeFitPars1Ub text'],
-            self.hs['FitConfigEdgeFitPars2Lb text'],
-            self.hs['FitConfigEdgeFitPars2Ub text'],
-            self.hs['FitConfigEdgeFitPars3Lb text'],
-            self.hs['FitConfigEdgeFitPars3Ub text'],
-            self.hs['FitConfigEdgeFitPars4Lb text'],
-            self.hs['FitConfigEdgeFitPars4Ub text']
+            layout={"width": "95%", "height": "95%"},
+            disabled=True,
+        )
+        self.hs["FitConfigEdgeFitPars4Ub text"] = fit_edge_pars_GridspecLayout[
+            7, 50:100
+        ]
+
+        self.hs["FitConfigEdgeOptmzr drpdn"].observe(
+            self.fit_config_edge_optmzr_drpdn_chg, names="value"
+        )
+        self.hs["FitConfigEdgeFunc drpdn"].observe(
+            self.fit_config_edge_func_drpdn_chg, names="value"
+        )
+        self.hs["FitConfigEdgeFitUseBnd chbx"].observe(
+            self.fit_config_edge_fit_bnd_chbx_chg, names="value"
+        )
+
+        self.hs["FitConfigEdgePars box"] = fit_edge_pars_GridspecLayout
+        self.hs["FitConfigEdgePars box"].children = [
+            self.hs["FitConfigEdgeOptmzr drpdn"],
+            self.hs["FitConfigEdgeFunc drpdn"],
+            self.hs["FitConfigEdgeFitUseBnd chbx"],
+            self.hs["FitConfigEdgeFitPars0 text"],
+            self.hs["FitConfigEdgeFitPars1 text"],
+            self.hs["FitConfigEdgeFitPars2 text"],
+            self.hs["FitConfigEdgeFitPars3 text"],
+            self.hs["FitConfigEdgeFitPars4 text"],
+            self.hs["FitConfigEdgeFitPars5 text"],
+            self.hs["FitConfigEdgeFitJac drpdn"],
+            self.hs["FitConfigEdgeFitMeth drpdn"],
+            self.hs["FitConfigEdgeFitFtol text"],
+            self.hs["FitConfigEdgeFitXtol text"],
+            self.hs["FitConfigEdgeFitGtol text"],
+            self.hs["FitConfigEdgeFitUfac text"],
+            self.hs["FitConfigEdgeFitPars0Lb text"],
+            self.hs["FitConfigEdgeFitPars0Ub text"],
+            self.hs["FitConfigEdgeFitPars1Lb text"],
+            self.hs["FitConfigEdgeFitPars1Ub text"],
+            self.hs["FitConfigEdgeFitPars2Lb text"],
+            self.hs["FitConfigEdgeFitPars2Ub text"],
+            self.hs["FitConfigEdgeFitPars3Lb text"],
+            self.hs["FitConfigEdgeFitPars3Ub text"],
+            self.hs["FitConfigEdgeFitPars4Lb text"],
+            self.hs["FitConfigEdgeFitPars4Ub text"],
         ]
         ## ## ## ## ## ## define edge fitting parameters -- end
 
         ## ## ## ## ## ## define saving setting -- start
         # layout = {'border':'3px solid #FFCC00', 'width':f'{0.96*self.form_sz[1]-98}px', 'height':f'{0.49*(self.form_sz[0]-128)}px'}
-        layout = {
-            'border': '3px solid #FFCC00',
-            'width': 'auto',
-            'height': 'auto'
-        }
-        self.hs['FitSavSetting box'] = widgets.HBox()
-        self.hs['FitSavSetting box'].layout = layout
+        layout = {"border": "3px solid #FFCC00", "width": "auto", "height": "auto"}
+        self.hs["FitSavSetting box"] = widgets.HBox()
+        self.hs["FitSavSetting box"].layout = layout
         fit_sav_setting_GridLayout = widgets.GridspecLayout(
             8,
             200,
-            layout={
-                "border": "3px solid #FFCC00",
-                'width': '100%',
-                'height': '100%'
-            })
+            layout={"border": "3px solid #FFCC00", "width": "100%", "height": "100%"},
+        )
         fit_sav_setting_GridLayout[0:6, 0:100] = widgets.SelectMultiple(
             options=dat_dict.XANES_FULL_SAVE_ITEM_OPTIONS,
-            value=['wl_fit_coef'],
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
+            value=["wl_fit_coef"],
+            layout={"width": "95%", "height": "95%"},
             rows=10,
-            description='Aval Items',
-            disabled=True)
-        self.hs['FitSavSettingOpt mulsel'] = fit_sav_setting_GridLayout[0:6,
-                                                                     0:100]
+            description="Aval Items",
+            disabled=True,
+        )
+        self.hs["FitSavSettingOpt mulsel"] = fit_sav_setting_GridLayout[0:6, 0:100]
 
         fit_sav_setting_GridLayout[0:6, 100:200] = widgets.SelectMultiple(
             options=dat_dict.XANES_FULL_SAVE_DEFAULT,
             value=[
-                '',
+                "",
             ],
-            layout={
-                'width': '95%',
-                'height': '95%'
-            },
-            description='Selected:',
-            disabled=True)
-        self.hs['FitSavSettingSel mulsel'] = fit_sav_setting_GridLayout[
-            0:6, 100:200]
+            layout={"width": "95%", "height": "95%"},
+            description="Selected:",
+            disabled=True,
+        )
+        self.hs["FitSavSettingSel mulsel"] = fit_sav_setting_GridLayout[0:6, 100:200]
 
         fit_sav_setting_GridLayout[7:8, 40:60] = widgets.Button(
-            description='==>',
-            disabled=True,
-            description_tooltip='Select saving items')
-        self.hs['FitSavSettingAdd btn'] = \
-            fit_sav_setting_GridLayout[7:8, 40:60]
-        self.hs['FitSavSettingAdd btn'].style.button_color = \
-            'darkviolet'
+            description="==>", disabled=True, description_tooltip="Select saving items"
+        )
+        self.hs["FitSavSettingAdd btn"] = fit_sav_setting_GridLayout[7:8, 40:60]
+        self.hs["FitSavSettingAdd btn"].style.button_color = "darkviolet"
         fit_sav_setting_GridLayout[7:8, 140:160] = widgets.Button(
-            description='<==',
-            disabled=True,
-            description_tooltip='Remove saving items')
-        self.hs['FitSavSettingRm btn'] = fit_sav_setting_GridLayout[7:8,
-                                                                    140:160]
-        self.hs['FitSavSettingRm btn'].style.button_color = 'darkviolet'
-        self.hs['FitSavSettingAdd btn'].on_click(
-            self.fit_sav_setting_add_btn_clk)
-        self.hs['FitSavSettingRm btn'].on_click(
-            self.fit_sav_setting_rm_btn_clk)
-
-        self.hs['FitSavSetting box'] = fit_sav_setting_GridLayout
-        self.hs['FitSavSetting box'].children = [
-            self.hs['FitSavSettingOpt mulsel'],
-            self.hs['FitSavSettingSel mulsel'],
-            self.hs['FitSavSettingAdd btn'], self.hs['FitSavSettingRm btn']
+            description="<==", disabled=True, description_tooltip="Remove saving items"
+        )
+        self.hs["FitSavSettingRm btn"] = fit_sav_setting_GridLayout[7:8, 140:160]
+        self.hs["FitSavSettingRm btn"].style.button_color = "darkviolet"
+        self.hs["FitSavSettingAdd btn"].on_click(self.fit_sav_setting_add_btn_clk)
+        self.hs["FitSavSettingRm btn"].on_click(self.fit_sav_setting_rm_btn_clk)
+
+        self.hs["FitSavSetting box"] = fit_sav_setting_GridLayout
+        self.hs["FitSavSetting box"].children = [
+            self.hs["FitSavSettingOpt mulsel"],
+            self.hs["FitSavSettingSel mulsel"],
+            self.hs["FitSavSettingAdd btn"],
+            self.hs["FitSavSettingRm btn"],
         ]
         ## ## ## ## ## ## define saving setting -- end
 
-        self.hs['FitItem tab'].children = [
-            self.hs['FitItemConfig box'], self.hs['FitConfigWlPars box'],
-            self.hs['FitConfigEdgePars box'], self.hs['FitSavSetting box']
+        self.hs["FitItem tab"].children = [
+            self.hs["FitItemConfig box"],
+            self.hs["FitConfigWlPars box"],
+            self.hs["FitConfigEdgePars box"],
+            self.hs["FitSavSetting box"],
         ]
-        self.hs['FitItem tab'].set_title(0, 'config analysis')
-        self.hs['FitItem tab'].set_title(1, 'fit whiteline params')
-        self.hs['FitItem tab'].set_title(2, 'fit edge params')
-        self.hs['FitItem tab'].set_title(3, 'saving setting')
+        self.hs["FitItem tab"].set_title(0, "config analysis")
+        self.hs["FitItem tab"].set_title(1, "fit whiteline params")
+        self.hs["FitItem tab"].set_title(2, "fit edge params")
+        self.hs["FitItem tab"].set_title(3, "saving setting")
         ## ## ## ## ## define fitting parameters -- send
 
         ## ## ## ## ## run xanes analysis -- start
         layout = {
-            'border': '3px solid #FFCC00',
-            'width': f'{1*self.form_sz[1]-98}px',
-            'height': f'{0.07*(self.form_sz[0]-128)}px'
+            "border": "3px solid #FFCC00",
+            "width": f"{1*self.form_sz[1]-98}px",
+            "height": f"{0.07*(self.form_sz[0]-128)}px",
         }
-        self.hs['FitRun box'] = widgets.HBox()
-        self.hs['FitRun box'].layout = layout
-        layout = {'width': '85%', 'height': '90%'}
-        self.hs['FitRun text'] = widgets.Text(
-            description=
-            'please check your settings before run the analysis .. ',
-            disabled=True)
-        self.hs['FitRun text'].layout = layout
-        layout = {'width': '15%', 'height': '90%'}
-        self.hs['FitRun btn'] = widgets.Button(description='run',
-                                               disabled=True)
-        self.hs['FitRun btn'].layout = layout
-        self.hs['FitRun btn'].style.button_color = 'darkviolet'
+        self.hs["FitRun box"] = widgets.HBox()
+        self.hs["FitRun box"].layout = layout
+        layout = {"width": "85%", "height": "90%"}
+        self.hs["FitRun text"] = widgets.Text(
+            description="please check your settings before run the analysis .. ",
+            disabled=True,
+        )
+        self.hs["FitRun text"].layout = layout
+        layout = {"width": "15%", "height": "90%"}
+        self.hs["FitRun btn"] = widgets.Button(description="run", disabled=True)
+        self.hs["FitRun btn"].layout = layout
+        self.hs["FitRun btn"].style.button_color = "darkviolet"
 
-        self.hs['FitRun btn'].on_click(self.fit_run_btn_clk)
+        self.hs["FitRun btn"].on_click(self.fit_run_btn_clk)
 
-        self.hs['FitRun box'].children = [
-            self.hs['FitRun text'], self.hs['FitRun btn']
-        ]
+        self.hs["FitRun box"].children = [self.hs["FitRun text"], self.hs["FitRun btn"]]
         ## ## ## ## ## run xanes analysis -- end
 
         ## ## ## ## ## run analysis progress -- start
         layout = {
-            'border': '3px solid #FFCC00',
-            'width': f'{self.form_sz[1]-98}px',
-            'height': f'{0.07*(self.form_sz[0]-128)}px'
+            "border": "3px solid #FFCC00",
+            "width": f"{self.form_sz[1]-98}px",
+            "height": f"{0.07*(self.form_sz[0]-128)}px",
         }
-        self.hs['FitPrgr box'] = widgets.HBox()
-        self.hs['FitPrgr box'].layout = layout
-        layout = {'width': '100%', 'height': '90%'}
-        self.hs['FitPrgr bar'] = widgets.IntProgress(
+        self.hs["FitPrgr box"] = widgets.HBox()
+        self.hs["FitPrgr box"].layout = layout
+        layout = {"width": "100%", "height": "90%"}
+        self.hs["FitPrgr bar"] = widgets.IntProgress(
             value=0,
             min=0,
             max=10,
             step=1,
-            description='Completing:',
-            bar_style='info',  # 'success', 'info', 'warning', 'danger' or ''
-            orientation='horizontal')
-        self.hs['FitPrgr bar'].layout = layout
-        self.hs['FitPrgr box'].children = [self.hs['FitPrgr bar']]
+            description="Completing:",
+            bar_style="info",  # 'success', 'info', 'warning', 'danger' or ''
+            orientation="horizontal",
+        )
+        self.hs["FitPrgr bar"].layout = layout
+        self.hs["FitPrgr box"].children = [self.hs["FitPrgr bar"]]
         ## ## ## ## ## run analysis progress -- end
 
-        self.hs['Fitting form'].children = [
-            self.hs['FitEngConfig box'], self.hs['FitItem tab'],
-            self.hs['FitRun box'], self.hs['FitPrgr box']
+        self.hs["Fitting form"].children = [
+            self.hs["FitEngConfig box"],
+            self.hs["FitItem tab"],
+            self.hs["FitRun box"],
+            self.hs["FitPrgr box"],
         ]
         ## ## ## ## define functional widgets each tab in each sub-tab - analysis box in analysis&display TAB -- end
         self.bundle_fit_var_handles()
         self.boxes_logic()
 
     def boxes_logic(self):
 
         def compound_logic():
             if self.fit_wl_pos:
-                if self.fit_wl_optimizer == 'scipy':
+                if self.fit_wl_optimizer == "scipy":
                     for ii in self.fit_wl_fit_func_arg_handles:
                         ii.disabled = False
                     for ii in self.fit_wl_optimizer_arg_handles:
                         ii.disabled = False
                     if self.fit_wl_fit_use_param_bnd:
                         for ii in self.fit_wl_fit_func_bnd_handles:
                             ii.disabled = False
                     else:
                         for ii in self.fit_wl_fit_func_bnd_handles:
                             ii.disabled = True
-                    self.hs['FitConfigWlFitUseBnd chbx'].disabled = False
-                    self.hs['FitConfigWlFunc drpdn'].options = dat_dict.XANES_PEAK_LINE_SHAPES
-                    self.hs['FitConfigWlFunc drpdn'].description = 'peak func'
-                    self.hs[
-                        'FitConfigWlFunc drpdn'].description_tooltip = 'peak fitting functions'
-                elif self.fit_wl_optimizer == 'numpy':
+                    self.hs["FitConfigWlFitUseBnd chbx"].disabled = False
+                    self.hs["FitConfigWlFunc drpdn"].options = (
+                        dat_dict.XANES_PEAK_LINE_SHAPES
+                    )
+                    self.hs["FitConfigWlFunc drpdn"].description = "peak func"
+                    self.hs["FitConfigWlFunc drpdn"].description_tooltip = (
+                        "peak fitting functions"
+                    )
+                elif self.fit_wl_optimizer == "numpy":
                     for ii in self.fit_wl_fit_func_arg_handles:
                         ii.disabled = True
                     for ii in self.fit_wl_optimizer_arg_handles:
                         ii.disabled = True
                     for ii in self.fit_wl_fit_func_bnd_handles:
                         ii.disabled = True
-                    self.hs['FitConfigEdgeFitUfac text'].disabled = False
-                    self.hs['FitConfigWlFitUseBnd chbx'].disabled = True
-                    self.hs['FitConfigWlFunc drpdn'].options = NUMPY_FIT_ORDER
-                    self.hs['FitConfigWlFunc drpdn'].description = 'order'
-                    self.hs[
-                        'FitConfigWlFunc drpdn'].description_tooltip = 'order of polynominal fitting function'
+                    self.hs["FitConfigEdgeFitUfac text"].disabled = False
+                    self.hs["FitConfigWlFitUseBnd chbx"].disabled = True
+                    self.hs["FitConfigWlFunc drpdn"].options = NUMPY_FIT_ORDER
+                    self.hs["FitConfigWlFunc drpdn"].description = "order"
+                    self.hs["FitConfigWlFunc drpdn"].description_tooltip = (
+                        "order of polynominal fitting function"
+                    )
 
             if self.fit_mask_prev:
-                if self.parent_h.gui_name == 'xanes3D':
-                    self.hs['FitItemConfigFitPrvwSli sldr'].disabled = False
+                if self.parent_h.gui_name == "xanes3D":
+                    self.hs["FitItemConfigFitPrvwSli sldr"].disabled = False
                 else:
-                    self.hs['FitItemConfigFitPrvwSli sldr'].disabled = True
-                self.hs['FitItemConfigFitPrvwCal btn'].disabled = False
+                    self.hs["FitItemConfigFitPrvwSli sldr"].disabled = True
+                self.hs["FitItemConfigFitPrvwCal btn"].disabled = False
                 if self.fit_flt_prev_maskit:
-                    self.hs['FitItemConfigFitPrvwEMIt btn'].disabled = False
-                    self.hs['FitItemConfigFitPrvwOMIt btn'].disabled = False
-                    self.hs['FitItemConfigFitPrvwEMOMIt btn'].disabled = False
+                    self.hs["FitItemConfigFitPrvwEMIt btn"].disabled = False
+                    self.hs["FitItemConfigFitPrvwOMIt btn"].disabled = False
+                    self.hs["FitItemConfigFitPrvwEMOMIt btn"].disabled = False
                 else:
-                    self.hs['FitItemConfigFitPrvwEMIt btn'].disabled = True
-                    self.hs['FitItemConfigFitPrvwOMIt btn'].disabled = True
-                    self.hs['FitItemConfigFitPrvwEMOMIt btn'].disabled = True
+                    self.hs["FitItemConfigFitPrvwEMIt btn"].disabled = True
+                    self.hs["FitItemConfigFitPrvwOMIt btn"].disabled = True
+                    self.hs["FitItemConfigFitPrvwEMOMIt btn"].disabled = True
             else:
-                self.hs['FitItemConfigFitPrvwSli sldr'].disabled = True
-                self.hs['FitItemConfigFitPrvwCal btn'].disabled = True
-                self.hs['FitItemConfigFitPrvwEMIt btn'].disabled = True
-                self.hs['FitItemConfigFitPrvwOMIt btn'].disabled = True
-                self.hs['FitItemConfigFitPrvwEMOMIt btn'].disabled = True
+                self.hs["FitItemConfigFitPrvwSli sldr"].disabled = True
+                self.hs["FitItemConfigFitPrvwCal btn"].disabled = True
+                self.hs["FitItemConfigFitPrvwEMIt btn"].disabled = True
+                self.hs["FitItemConfigFitPrvwOMIt btn"].disabled = True
+                self.hs["FitItemConfigFitPrvwEMOMIt btn"].disabled = True
 
             if self.fit_lcf:
                 boxes = [
-                    'FitItemConfigLCF chbx', 'FitItemConfigLCFCnst chbx',
-                    'FitItemConfigLCFNumSpec text',
-                    'FitItemConfigLCFSelRef btn', 'FitItemConfigLCFRef list',
-                    'FitItemConfigLCFRmRef btn'
+                    "FitItemConfigLCF chbx",
+                    "FitItemConfigLCFCnst chbx",
+                    "FitItemConfigLCFNumSpec text",
+                    "FitItemConfigLCFSelRef btn",
+                    "FitItemConfigLCFRef list",
+                    "FitItemConfigLCFRmRef btn",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-                if len(self.hs['FitItemConfigLCFRef list'].options
-                       ) == self.fit_lcf_ref_num:
-                    self.hs['FitItemConfigLCFSelRef btn'].disabled = True
+                if (
+                    len(self.hs["FitItemConfigLCFRef list"].options)
+                    == self.fit_lcf_ref_num
+                ):
+                    self.hs["FitItemConfigLCFSelRef btn"].disabled = True
                     self.fit_lcf_ref_set = True
                 else:
-                    self.hs['FitItemConfigLCFSelRef btn'].disabled = False
+                    self.hs["FitItemConfigLCFSelRef btn"].disabled = False
                     self.fit_lcf_ref_set = False
                 if self.fit_lcf_ref_set:
-                    self.hs['FitRun btn'].disabled = False
+                    self.hs["FitRun btn"].disabled = False
                 else:
-                    self.hs['FitRun btn'].disabled = True
+                    self.hs["FitRun btn"].disabled = True
             else:
                 boxes = [
-                    'FitItemConfigLCF chbx', 'FitItemConfigLCFCnst chbx',
-                    'FitItemConfigLCFNumSpec text',
-                    'FitItemConfigLCFSelRef btn', 'FitItemConfigLCFRef list',
-                    'FitItemConfigLCFRmRef btn'
+                    "FitItemConfigLCF chbx",
+                    "FitItemConfigLCFCnst chbx",
+                    "FitItemConfigLCFNumSpec text",
+                    "FitItemConfigLCFSelRef btn",
+                    "FitItemConfigLCFRef list",
+                    "FitItemConfigLCFRmRef btn",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-                self.hs['FitItemConfigLCF chbx'].disabled = False
-                self.hs['FitRun btn'].disabled = False
+                self.hs["FitItemConfigLCF chbx"].disabled = False
+                self.hs["FitRun btn"].disabled = False
 
             if self.fit_edge50_pos:
-                if self.fit_edge_optimizer == 'scipy':
+                if self.fit_edge_optimizer == "scipy":
                     for ii in self.fit_edge_fit_func_arg_handles:
                         ii.disabled = False
                     for ii in self.fit_edge_optimizer_arg_handles:
                         ii.disabled = False
                     if self.fit_edge_fit_use_param_bnd:
                         for ii in self.fit_edge_fit_func_bnd_handles:
                             ii.disabled = False
                     else:
                         for ii in self.fit_edge_fit_func_bnd_handles:
                             ii.disabled = True
-                    self.hs['FitConfigEdgeFitUseBnd chbx'].disabled = False
-                    self.hs[
-                        'FitConfigEdgeFunc drpdn'].options = dat_dict.XANES_EDGE_LINE_SHAPES
-                    self.hs[
-                        'FitConfigEdgeFunc drpdn'].description = 'peak func'
-                    self.hs[
-                        'FitConfigEdgeFunc drpdn'].description_tooltip = 'peak fitting functions'
-                elif self.fit_edge_optimizer == 'numpy':
+                    self.hs["FitConfigEdgeFitUseBnd chbx"].disabled = False
+                    self.hs["FitConfigEdgeFunc drpdn"].options = (
+                        dat_dict.XANES_EDGE_LINE_SHAPES
+                    )
+                    self.hs["FitConfigEdgeFunc drpdn"].description = "peak func"
+                    self.hs["FitConfigEdgeFunc drpdn"].description_tooltip = (
+                        "peak fitting functions"
+                    )
+                elif self.fit_edge_optimizer == "numpy":
                     for ii in self.fit_edge_fit_func_arg_handles:
                         ii.disabled = True
                     for ii in self.fit_edge_optimizer_arg_handles:
                         ii.disabled = True
                     for ii in self.fit_edge_fit_func_bnd_handles:
                         ii.disabled = True
-                    self.hs['FitConfigEdgeFitUfac text'].disabled = False
-                    self.hs['FitConfigEdgeFitUseBnd chbx'].disabled = True
-                    self.hs[
-                        'FitConfigEdgeFunc drpdn'].options = NUMPY_FIT_ORDER
-                    self.hs['FitConfigEdgeFunc drpdn'].description = 'order'
-                    self.hs[
-                        'FitConfigEdgeFunc drpdn'].description_tooltip = 'order of polynominal fitting function'
-
-            if (not self.hs['FitItemConfigCalWlDir chbx'].value) and (
-                    not self.hs['FitItemConfigFitWl chbx'].value):
-                self.hs['FitItemConfigFitWl chbx'].value = True
-
-        if not (self.parent_h.xanes_file_configured
-                & self.parent_h.xanes_alignment_done):
-            boxes = ['FitEngRag box']
+                    self.hs["FitConfigEdgeFitUfac text"].disabled = False
+                    self.hs["FitConfigEdgeFitUseBnd chbx"].disabled = True
+                    self.hs["FitConfigEdgeFunc drpdn"].options = NUMPY_FIT_ORDER
+                    self.hs["FitConfigEdgeFunc drpdn"].description = "order"
+                    self.hs["FitConfigEdgeFunc drpdn"].description_tooltip = (
+                        "order of polynominal fitting function"
+                    )
+
+            if (not self.hs["FitItemConfigCalWlDir chbx"].value) and (
+                not self.hs["FitItemConfigFitWl chbx"].value
+            ):
+                self.hs["FitItemConfigFitWl chbx"].value = True
+
+        if not (
+            self.parent_h.xanes_file_configured & self.parent_h.xanes_alignment_done
+        ):
+            boxes = ["FitEngRag box"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
         else:
-            if self.parent_h.xanes_fit_type == 'full':
-                boxes = ['FitEngRag box']
+            if self.parent_h.xanes_fit_type == "full":
+                boxes = ["FitEngRag box"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             else:
                 boxes = [
-                    'FitEngRagEdgeEng text', 'FitEngRagPostEdgeStr text',
-                    'FitEngRagPreEdgeEnd text', 'FitEngRagEdge0.5Str text',
-                    'FitEngRagEdge0.5End text'
+                    "FitEngRagEdgeEng text",
+                    "FitEngRagPostEdgeStr text",
+                    "FitEngRagPreEdgeEnd text",
+                    "FitEngRagEdge0.5Str text",
+                    "FitEngRagEdge0.5End text",
                 ]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
-                boxes = ['FitEngRagWlFitStr text', 'FitEngRagWlFitEnd text']
+                boxes = ["FitEngRagWlFitStr text", "FitEngRagWlFitEnd text"]
                 enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
             if self.xanes_fit_eng_config:
-                if self.parent_h.xanes_fit_type == 'wl':
-                    boxes = ['FitItem tab']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
-                    boxes = ['FitSavSetting box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                if self.parent_h.xanes_fit_type == "wl":
+                    boxes = ["FitItem tab"]
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
+                    boxes = ["FitSavSetting box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 else:
-                    boxes = ['FitItem tab']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    boxes = ["FitItem tab"]
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 if self.fit_wl_pos:
-                    boxes = ['FitConfigWlPars box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    boxes = ["FitConfigWlPars box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 else:
-                    boxes = ['FitConfigWlPars box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    boxes = ["FitConfigWlPars box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 if self.fit_edge50_pos:
-                    boxes = ['FitConfigEdgePars box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=False,
-                                         level=-1)
+                    boxes = ["FitConfigEdgePars box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
                 else:
-                    boxes = ['FitConfigEdgePars box']
-                    enable_disable_boxes(self.hs,
-                                         boxes,
-                                         disabled=True,
-                                         level=-1)
+                    boxes = ["FitConfigEdgePars box"]
+                    enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
                 compound_logic()
             else:
-                boxes = ['FitItem tab']
+                boxes = ["FitItem tab"]
                 enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
 
     def bundle_fit_var_handles(self):
         self.fit_wl_fit_func_arg_handles = [
-            self.hs['FitConfigWlFitPars0 text'],
-            self.hs['FitConfigWlFitPars1 text'],
-            self.hs['FitConfigWlFitPars2 text'],
-            self.hs['FitConfigWlFitPars3 text'],
-            self.hs['FitConfigWlFitPars4 text'],
-            self.hs['FitConfigWlFitPars5 text']
+            self.hs["FitConfigWlFitPars0 text"],
+            self.hs["FitConfigWlFitPars1 text"],
+            self.hs["FitConfigWlFitPars2 text"],
+            self.hs["FitConfigWlFitPars3 text"],
+            self.hs["FitConfigWlFitPars4 text"],
+            self.hs["FitConfigWlFitPars5 text"],
         ]
 
         self.fit_wl_optimizer_arg_handles = [
-            self.hs['FitConfigWlFitJac drpdn'],
-            self.hs['FitConfigWlFitMeth drpdn'],
-            self.hs['FitConfigWlFitFtol text'],
-            self.hs['FitConfigWlFitXtol text'],
-            self.hs['FitConfigWlFitGtol text'],
-            self.hs['FitConfigWlFitUfac text']
+            self.hs["FitConfigWlFitJac drpdn"],
+            self.hs["FitConfigWlFitMeth drpdn"],
+            self.hs["FitConfigWlFitFtol text"],
+            self.hs["FitConfigWlFitXtol text"],
+            self.hs["FitConfigWlFitGtol text"],
+            self.hs["FitConfigWlFitUfac text"],
         ]
 
         self.fit_wl_fit_func_bnd_handles = [
-            self.hs['FitConfigWlFitPars0Lb text'],
-            self.hs['FitConfigWlFitPars0Ub text'],
-            self.hs['FitConfigWlFitPars1Lb text'],
-            self.hs['FitConfigWlFitPars1Ub text'],
-            self.hs['FitConfigWlFitPars2Lb text'],
-            self.hs['FitConfigWlFitPars2Ub text'],
-            self.hs['FitConfigWlFitPars3Lb text'],
-            self.hs['FitConfigWlFitPars3Ub text'],
-            self.hs['FitConfigWlFitPars4Lb text'],
-            self.hs['FitConfigWlFitPars4Ub text']
+            self.hs["FitConfigWlFitPars0Lb text"],
+            self.hs["FitConfigWlFitPars0Ub text"],
+            self.hs["FitConfigWlFitPars1Lb text"],
+            self.hs["FitConfigWlFitPars1Ub text"],
+            self.hs["FitConfigWlFitPars2Lb text"],
+            self.hs["FitConfigWlFitPars2Ub text"],
+            self.hs["FitConfigWlFitPars3Lb text"],
+            self.hs["FitConfigWlFitPars3Ub text"],
+            self.hs["FitConfigWlFitPars4Lb text"],
+            self.hs["FitConfigWlFitPars4Ub text"],
         ]
 
         self.fit_edge_fit_func_arg_handles = [
-            self.hs['FitConfigEdgeFitPars0 text'],
-            self.hs['FitConfigEdgeFitPars1 text'],
-            self.hs['FitConfigEdgeFitPars2 text'],
-            self.hs['FitConfigEdgeFitPars3 text'],
-            self.hs['FitConfigEdgeFitPars4 text'],
-            self.hs['FitConfigEdgeFitPars5 text']
+            self.hs["FitConfigEdgeFitPars0 text"],
+            self.hs["FitConfigEdgeFitPars1 text"],
+            self.hs["FitConfigEdgeFitPars2 text"],
+            self.hs["FitConfigEdgeFitPars3 text"],
+            self.hs["FitConfigEdgeFitPars4 text"],
+            self.hs["FitConfigEdgeFitPars5 text"],
         ]
 
         self.fit_edge_optimizer_arg_handles = [
-            self.hs['FitConfigEdgeFitJac drpdn'],
-            self.hs['FitConfigEdgeFitMeth drpdn'],
-            self.hs['FitConfigEdgeFitFtol text'],
-            self.hs['FitConfigEdgeFitXtol text'],
-            self.hs['FitConfigEdgeFitGtol text'],
-            self.hs['FitConfigEdgeFitUfac text']
+            self.hs["FitConfigEdgeFitJac drpdn"],
+            self.hs["FitConfigEdgeFitMeth drpdn"],
+            self.hs["FitConfigEdgeFitFtol text"],
+            self.hs["FitConfigEdgeFitXtol text"],
+            self.hs["FitConfigEdgeFitGtol text"],
+            self.hs["FitConfigEdgeFitUfac text"],
         ]
 
         self.fit_edge_fit_func_bnd_handles = [
-            self.hs['FitConfigEdgeFitPars0Lb text'],
-            self.hs['FitConfigEdgeFitPars0Ub text'],
-            self.hs['FitConfigEdgeFitPars1Lb text'],
-            self.hs['FitConfigEdgeFitPars1Ub text'],
-            self.hs['FitConfigEdgeFitPars2Lb text'],
-            self.hs['FitConfigEdgeFitPars2Ub text'],
-            self.hs['FitConfigEdgeFitPars3Lb text'],
-            self.hs['FitConfigEdgeFitPars3Ub text'],
-            self.hs['FitConfigEdgeFitPars4Lb text'],
-            self.hs['FitConfigEdgeFitPars4Ub text']
+            self.hs["FitConfigEdgeFitPars0Lb text"],
+            self.hs["FitConfigEdgeFitPars0Ub text"],
+            self.hs["FitConfigEdgeFitPars1Lb text"],
+            self.hs["FitConfigEdgeFitPars1Ub text"],
+            self.hs["FitConfigEdgeFitPars2Lb text"],
+            self.hs["FitConfigEdgeFitPars2Ub text"],
+            self.hs["FitConfigEdgeFitPars3Lb text"],
+            self.hs["FitConfigEdgeFitPars3Ub text"],
+            self.hs["FitConfigEdgeFitPars4Lb text"],
+            self.hs["FitConfigEdgeFitPars4Ub text"],
         ]
 
-    def fit_coef_num(self, ftype='wl_fit_coef'):
-        if ftype == 'wl_fit_coef':
-            if self.fit_wl_optimizer == 'scipy':
+    def fit_coef_num(self, ftype="wl_fit_coef"):
+        if ftype == "wl_fit_coef":
+            if self.fit_wl_optimizer == "scipy":
                 return len(
-                    list(dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()))
-            elif self.fit_wl_optimizer == 'numpy':
-                return self.hs['FitConfigWlFunc drpdn'].value + 1
-        elif ftype == 'edge_fit_coef':
-            if self.fit_edge_optimizer == 'scipy':
+                    list(
+                        dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()
+                    )
+                )
+            elif self.fit_wl_optimizer == "numpy":
+                return self.hs["FitConfigWlFunc drpdn"].value + 1
+        elif ftype == "edge_fit_coef":
+            if self.fit_edge_optimizer == "scipy":
                 return len(
-                    list(dat_dict.XANES_EDGE_FIT_PARAM_DICT[self.fit_edge_fit_func].keys()))
-            elif self.fit_edge_optimizer == 'numpy':
-                return self.hs['FitConfigEdgeFunc drpdn'].value + 1
-        elif ftype == 'post_edge_fit_coef':
+                    list(
+                        dat_dict.XANES_EDGE_FIT_PARAM_DICT[
+                            self.fit_edge_fit_func
+                        ].keys()
+                    )
+                )
+            elif self.fit_edge_optimizer == "numpy":
+                return self.hs["FitConfigEdgeFunc drpdn"].value + 1
+        elif ftype == "post_edge_fit_coef":
             return 2
-        elif ftype == 'pre_edge_fit_coef':
+        elif ftype == "pre_edge_fit_coef":
             return 2
 
     def set_save_items(self):
-        if self.parent_h.xanes_fit_type == 'wl':
+        if self.parent_h.xanes_fit_type == "wl":
             tem1 = set(deepcopy(sorted(dat_dict.XANES_WL_SAVE_ITEM_OPTIONS)))
             tem2 = set(deepcopy(sorted(dat_dict.XANES_WL_SAVE_DEFAULT)))
             if not self.fit_wl_pos:
                 [
                     tem1.remove(ii)
-                    for ii in ['wl_pos_fit', 'wl_fit_coef', 'wl_fit_err']
-                    if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    for ii in ["wl_pos_fit", "wl_fit_coef", "wl_fit_err"]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
                     tem2.remove(ii)
-                    for ii in ['wl_pos_fit', 'wl_fit_coef', 'wl_fit_err']
-                    if ii in self.hs['FitSavSettingSel mulsel'].options
+                    for ii in ["wl_pos_fit", "wl_fit_coef", "wl_fit_err"]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
             if not self.find_wl_pos_dir:
                 [
-                    tem1.remove(ii) for ii in ['wl_pos_dir']
-                    if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    tem1.remove(ii)
+                    for ii in ["wl_pos_dir"]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
-                    tem2.remove(ii) for ii in ['wl_pos_dir']
-                    if ii in self.hs['FitSavSettingSel mulsel'].options
+                    tem2.remove(ii)
+                    for ii in ["wl_pos_dir"]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
-            self.hs['FitSavSettingOpt mulsel'].options = list(sorted(tem1))
-            self.hs['FitSavSettingSel mulsel'].options = list(sorted(tem2))
-            self.hs['FitSavSettingOpt mulsel'].value = ['centroid_of_eng']
-            self.hs['FitSavSettingSel mulsel'].value = ['']
-        elif self.parent_h.xanes_fit_type == 'full':
+            self.hs["FitSavSettingOpt mulsel"].options = list(sorted(tem1))
+            self.hs["FitSavSettingSel mulsel"].options = list(sorted(tem2))
+            self.hs["FitSavSettingOpt mulsel"].value = ["centroid_of_eng"]
+            self.hs["FitSavSettingSel mulsel"].value = [""]
+        elif self.parent_h.xanes_fit_type == "full":
             tem1 = set(deepcopy(sorted(dat_dict.XANES_FULL_SAVE_ITEM_OPTIONS)))
             tem2 = set(deepcopy(sorted(dat_dict.XANES_FULL_SAVE_DEFAULT)))
             if not self.fit_wl_pos:
                 [
                     tem1.remove(ii)
-                    for ii in ['wl_pos_fit', 'wl_fit_coef', 'wl_fit_err']
-                    if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    for ii in ["wl_pos_fit", "wl_fit_coef", "wl_fit_err"]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
                     tem2.remove(ii)
-                    for ii in ['wl_pos_fit', 'wl_fit_coef', 'wl_fit_err']
-                    if ii in self.hs['FitSavSettingSel mulsel'].options
+                    for ii in ["wl_pos_fit", "wl_fit_coef", "wl_fit_err"]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
             if not self.fit_edge50_pos:
                 [
-                    tem1.remove(ii) for ii in [
-                        'edge50_pos_fit', 'edge_pos_fit', 'edge_fit_coef',
-                        'edge_fit_err'
-                    ] if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    tem1.remove(ii)
+                    for ii in [
+                        "edge50_pos_fit",
+                        "edge_pos_fit",
+                        "edge_fit_coef",
+                        "edge_fit_err",
+                    ]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
-                    tem2.remove(ii) for ii in [
-                        'edge50_pos_fit', 'edge_pos_fit', 'edge_fit_coef',
-                        'edge_fit_err'
-                    ] if ii in self.hs['FitSavSettingSel mulsel'].options
+                    tem2.remove(ii)
+                    for ii in [
+                        "edge50_pos_fit",
+                        "edge_pos_fit",
+                        "edge_fit_coef",
+                        "edge_fit_err",
+                    ]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
             if not self.find_wl_pos_dir:
                 [
-                    tem1.remove(ii) for ii in ['wl_pos_dir']
-                    if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    tem1.remove(ii)
+                    for ii in ["wl_pos_dir"]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
-                    tem2.remove(ii) for ii in ['wl_pos_dir']
-                    if ii in self.hs['FitSavSettingSel mulsel'].options
+                    tem2.remove(ii)
+                    for ii in ["wl_pos_dir"]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
             if self.find_edge50_pos_dir:
                 [
-                    tem1.remove(ii) for ii in ['edge50_pos_dir']
-                    if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    tem1.remove(ii)
+                    for ii in ["edge50_pos_dir"]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
-                    tem2.remove(ii) for ii in ['edge50_pos_dir']
-                    if ii in self.hs['FitSavSettingSel mulsel'].options
+                    tem2.remove(ii)
+                    for ii in ["edge50_pos_dir"]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
             if self.fit_lcf:
                 [
-                    tem1.remove(ii) for ii in ['lcf_fit', 'lcf_fit_err']
-                    if ii in self.hs['FitSavSettingOpt mulsel'].options
+                    tem1.remove(ii)
+                    for ii in ["lcf_fit", "lcf_fit_err"]
+                    if ii in self.hs["FitSavSettingOpt mulsel"].options
                 ]
                 [
-                    tem2.remove(ii) for ii in ['lcf_fit', 'lcf_fit_err']
-                    if ii in self.hs['FitSavSettingSel mulsel'].options
+                    tem2.remove(ii)
+                    for ii in ["lcf_fit", "lcf_fit_err"]
+                    if ii in self.hs["FitSavSettingSel mulsel"].options
                 ]
-            self.hs['FitSavSettingOpt mulsel'].options = list(sorted(tem1))
-            self.hs['FitSavSettingSel mulsel'].options = list(sorted(tem2))
-            self.hs['FitSavSettingOpt mulsel'].value = ['centroid_of_eng']
-            self.hs['FitSavSettingSel mulsel'].value = ['']
+            self.hs["FitSavSettingOpt mulsel"].options = list(sorted(tem1))
+            self.hs["FitSavSettingSel mulsel"].options = list(sorted(tem2))
+            self.hs["FitSavSettingOpt mulsel"].value = ["centroid_of_eng"]
+            self.hs["FitSavSettingSel mulsel"].value = [""]
 
     def set_xanes_analysis_eng_bounds(self):
         eng_list_len = self.parent_h.xanes_fit_eng_list.shape[0]
-        if self.parent_h.xanes_fit_wl_fit_eng_e > self.parent_h.xanes_fit_eng_list.max(
+        if (
+            self.parent_h.xanes_fit_wl_fit_eng_e
+            > self.parent_h.xanes_fit_eng_list.max()
         ):
-            self.parent_h.xanes_fit_wl_fit_eng_e = self.parent_h.xanes_fit_eng_list.max(
+            self.parent_h.xanes_fit_wl_fit_eng_e = (
+                self.parent_h.xanes_fit_eng_list.max()
             )
-        elif self.parent_h.xanes_fit_wl_fit_eng_e > self.parent_h.xanes_fit_eng_list.min(
+        elif (
+            self.parent_h.xanes_fit_wl_fit_eng_e
+            > self.parent_h.xanes_fit_eng_list.min()
         ):
             self.parent_h.xanes_fit_wl_fit_eng_e = self.parent_h.xanes_fit_eng_list[
-                int(eng_list_len / 2)]
-        if self.parent_h.xanes_fit_wl_fit_eng_s < self.parent_h.xanes_fit_eng_list.min(
+                int(eng_list_len / 2)
+            ]
+        if (
+            self.parent_h.xanes_fit_wl_fit_eng_s
+            < self.parent_h.xanes_fit_eng_list.min()
         ):
-            self.parent_h.xanes_fit_wl_fit_eng_s = self.parent_h.xanes_fit_eng_list.min(
+            self.parent_h.xanes_fit_wl_fit_eng_s = (
+                self.parent_h.xanes_fit_eng_list.min()
             )
-        elif self.parent_h.xanes_fit_wl_fit_eng_s < self.parent_h.xanes_fit_eng_list.max(
+        elif (
+            self.parent_h.xanes_fit_wl_fit_eng_s
+            < self.parent_h.xanes_fit_eng_list.max()
         ):
-            self.parent_h.xanes_fit_wl_fit_eng_s = self.parent_h.xanes_fit_eng_list[
-                int(eng_list_len / 2)] - 1
-        self.hs['FitEngRagWlFitEnd text'].min = 0
-        self.hs[
-            'FitEngRagWlFitEnd text'].max = self.parent_h.xanes_fit_eng_list.max(
-            )
-        self.hs[
-            'FitEngRagWlFitEnd text'].min = self.parent_h.xanes_fit_eng_list.min(
-            )
-        self.hs['FitEngRagWlFitStr text'].min = 0
-        self.hs[
-            'FitEngRagWlFitStr text'].max = self.parent_h.xanes_fit_eng_list.max(
-            )
-        self.hs[
-            'FitEngRagWlFitStr text'].min = self.parent_h.xanes_fit_eng_list.min(
-            )
-
-        if self.hs['FitEngRagOptn drpdn'].value == 'full':
-            if ((self.parent_h.xanes_fit_edge_eng >
-                 self.parent_h.xanes_fit_eng_list.max())
-                    or (self.parent_h.xanes_fit_edge_eng <
-                        self.parent_h.xanes_fit_eng_list.min())):
+            self.parent_h.xanes_fit_wl_fit_eng_s = (
+                self.parent_h.xanes_fit_eng_list[int(eng_list_len / 2)] - 1
+            )
+        self.hs["FitEngRagWlFitEnd text"].min = 0
+        self.hs["FitEngRagWlFitEnd text"].max = self.parent_h.xanes_fit_eng_list.max()
+        self.hs["FitEngRagWlFitEnd text"].min = self.parent_h.xanes_fit_eng_list.min()
+        self.hs["FitEngRagWlFitStr text"].min = 0
+        self.hs["FitEngRagWlFitStr text"].max = self.parent_h.xanes_fit_eng_list.max()
+        self.hs["FitEngRagWlFitStr text"].min = self.parent_h.xanes_fit_eng_list.min()
+
+        if self.hs["FitEngRagOptn drpdn"].value == "full":
+            if (
+                self.parent_h.xanes_fit_edge_eng
+                > self.parent_h.xanes_fit_eng_list.max()
+            ) or (
+                self.parent_h.xanes_fit_edge_eng
+                < self.parent_h.xanes_fit_eng_list.min()
+            ):
                 self.parent_h.xanes_fit_edge_eng = self.parent_h.xanes_fit_eng_list[
-                    int(eng_list_len / 2)]
-            if self.parent_h.xanes_fit_edge_0p5_fit_e > self.parent_h.xanes_fit_eng_list.max(
+                    int(eng_list_len / 2)
+                ]
+            if (
+                self.parent_h.xanes_fit_edge_0p5_fit_e
+                > self.parent_h.xanes_fit_eng_list.max()
             ):
-                self.parent_h.xanes_fit_edge_0p5_fit_e = self.parent_h.xanes_fit_eng_list.max(
+                self.parent_h.xanes_fit_edge_0p5_fit_e = (
+                    self.parent_h.xanes_fit_eng_list.max()
                 )
-            elif self.parent_h.xanes_fit_edge_0p5_fit_e < self.parent_h.xanes_fit_eng_list.min(
-            ):
-                self.parent_h.xanes_fit_edge_0p5_fit_e = self.parent_h.xanes_fit_eng_list[
-                    int(eng_list_len / 2)]
-            if self.parent_h.xanes_fit_edge_0p5_fit_s < self.parent_h.xanes_fit_eng_list.min(
+            elif (
+                self.parent_h.xanes_fit_edge_0p5_fit_e
+                < self.parent_h.xanes_fit_eng_list.min()
             ):
-                self.parent_h.xanes_fit_edge_0p5_fit_s = self.parent_h.xanes_fit_eng_list.min(
+                self.parent_h.xanes_fit_edge_0p5_fit_e = (
+                    self.parent_h.xanes_fit_eng_list[int(eng_list_len / 2)]
                 )
-            elif self.parent_h.xanes_fit_edge_0p5_fit_s > self.parent_h.xanes_fit_eng_list.max(
+            if (
+                self.parent_h.xanes_fit_edge_0p5_fit_s
+                < self.parent_h.xanes_fit_eng_list.min()
             ):
-                self.parent_h.xanes_fit_edge_0p5_fit_s = self.parent_h.xanes_fit_eng_list[
-                    int(eng_list_len / 2)] - 1
-            self.hs['FitEngRagEdgeEng text'].min = 0
-            self.hs[
-                'FitEngRagEdgeEng text'].max = self.parent_h.xanes_fit_eng_list.max(
+                self.parent_h.xanes_fit_edge_0p5_fit_s = (
+                    self.parent_h.xanes_fit_eng_list.min()
                 )
-            self.hs[
-                'FitEngRagEdgeEng text'].min = self.parent_h.xanes_fit_eng_list.min(
+            elif (
+                self.parent_h.xanes_fit_edge_0p5_fit_s
+                > self.parent_h.xanes_fit_eng_list.max()
+            ):
+                self.parent_h.xanes_fit_edge_0p5_fit_s = (
+                    self.parent_h.xanes_fit_eng_list[int(eng_list_len / 2)] - 1
                 )
+            self.hs["FitEngRagEdgeEng text"].min = 0
+            self.hs["FitEngRagEdgeEng text"].max = (
+                self.parent_h.xanes_fit_eng_list.max()
+            )
+            self.hs["FitEngRagEdgeEng text"].min = (
+                self.parent_h.xanes_fit_eng_list.min()
+            )
 
-            self.hs['FitEngRagWlFitEnd text'].min = 0
-            self.hs[
-                'FitEngRagWlFitEnd text'].max = self.parent_h.xanes_fit_eng_list.max(
-                )
-            self.hs[
-                'FitEngRagWlFitEnd text'].min = self.parent_h.xanes_fit_eng_list.min(
-                )
+            self.hs["FitEngRagWlFitEnd text"].min = 0
+            self.hs["FitEngRagWlFitEnd text"].max = (
+                self.parent_h.xanes_fit_eng_list.max()
+            )
+            self.hs["FitEngRagWlFitEnd text"].min = (
+                self.parent_h.xanes_fit_eng_list.min()
+            )
 
-            self.hs['FitEngRagWlFitStr text'].min = 0
-            self.hs[
-                'FitEngRagWlFitStr text'].max = self.parent_h.xanes_fit_eng_list.max(
-                )
-            self.hs[
-                'FitEngRagWlFitStr text'].min = self.parent_h.xanes_fit_eng_list.min(
-                )
+            self.hs["FitEngRagWlFitStr text"].min = 0
+            self.hs["FitEngRagWlFitStr text"].max = (
+                self.parent_h.xanes_fit_eng_list.max()
+            )
+            self.hs["FitEngRagWlFitStr text"].min = (
+                self.parent_h.xanes_fit_eng_list.min()
+            )
 
-            self.hs['FitEngRagEdge0.5End text'].min = 0
-            self.hs[
-                'FitEngRagEdge0.5End text'].max = self.parent_h.xanes_fit_eng_list.max(
-                )
-            self.hs[
-                'FitEngRagEdge0.5End text'].min = self.parent_h.xanes_fit_eng_list.min(
-                )
+            self.hs["FitEngRagEdge0.5End text"].min = 0
+            self.hs["FitEngRagEdge0.5End text"].max = (
+                self.parent_h.xanes_fit_eng_list.max()
+            )
+            self.hs["FitEngRagEdge0.5End text"].min = (
+                self.parent_h.xanes_fit_eng_list.min()
+            )
 
-            self.hs['FitEngRagEdge0.5Str text'].min = 0
-            self.hs[
-                'FitEngRagEdge0.5Str text'].max = self.parent_h.xanes_fit_eng_list.max(
-                )
-            self.hs[
-                'FitEngRagEdge0.5Str text'].min = self.parent_h.xanes_fit_eng_list.min(
-                )
+            self.hs["FitEngRagEdge0.5Str text"].min = 0
+            self.hs["FitEngRagEdge0.5Str text"].max = (
+                self.parent_h.xanes_fit_eng_list.max()
+            )
+            self.hs["FitEngRagEdge0.5Str text"].min = (
+                self.parent_h.xanes_fit_eng_list.min()
+            )
 
     def update_fit_params(self):
-        self.parent_h.xanes_fit_type = self.hs['FitEngRagOptn drpdn'].value
-        if self.parent_h.xanes_fit_type == 'wl':
+        self.parent_h.xanes_fit_type = self.hs["FitEngRagOptn drpdn"].value
+        if self.parent_h.xanes_fit_type == "wl":
             self.parent_h.xanes_fit_wl_fit_eng_s = self.hs[
-                'FitEngRagWlFitStr text'].value
+                "FitEngRagWlFitStr text"
+            ].value
             self.parent_h.xanes_fit_wl_fit_eng_e = self.hs[
-                'FitEngRagWlFitEnd text'].value
+                "FitEngRagWlFitEnd text"
+            ].value
 
-            self.fit_wl_pos = self.hs['FitItemConfigFitWl chbx'].value
-            self.fit_use_flt_spec = self.hs['FitItemConfigFitSpec chbx'].value
+            self.fit_wl_pos = self.hs["FitItemConfigFitWl chbx"].value
+            self.fit_use_flt_spec = self.hs["FitItemConfigFitSpec chbx"].value
 
             if self.fit_wl_pos:
-                self.fit_wl_optimizer = self.hs[
-                    'FitConfigWlOptmzr drpdn'].value
-                self.fit_wl_fit_func = self.hs['FitConfigWlFunc drpdn'].value
+                self.fit_wl_optimizer = self.hs["FitConfigWlOptmzr drpdn"].value
+                self.fit_wl_fit_func = self.hs["FitConfigWlFunc drpdn"].value
             else:
                 self.fit_wl_optimizer = None
                 self.fit_wl_fit_func = None
 
-            self.analysis_saving_items = set(
-                self.hs['FitSavSettingSel mulsel'].options)
-            self.analysis_saving_items.remove('')
-        elif self.parent_h.xanes_fit_type == 'full':
-            self.parent_h.xanes_fit_edge_eng = self.hs[
-                'FitEngRagEdgeEng text'].value
+            self.analysis_saving_items = set(self.hs["FitSavSettingSel mulsel"].options)
+            self.analysis_saving_items.remove("")
+        elif self.parent_h.xanes_fit_type == "full":
+            self.parent_h.xanes_fit_edge_eng = self.hs["FitEngRagEdgeEng text"].value
             self.parent_h.xanes_fit_pre_edge_e = self.hs[
-                'FitEngRagPreEdgeEnd text'].value
+                "FitEngRagPreEdgeEnd text"
+            ].value
             self.parent_h.xanes_fit_post_edge_s = self.hs[
-                'FitEngRagPostEdgeStr text'].value
+                "FitEngRagPostEdgeStr text"
+            ].value
             self.parent_h.xanes_fit_wl_fit_eng_s = self.hs[
-                'FitEngRagWlFitStr text'].value
+                "FitEngRagWlFitStr text"
+            ].value
             self.parent_h.xanes_fit_wl_fit_eng_e = self.hs[
-                'FitEngRagWlFitEnd text'].value
+                "FitEngRagWlFitEnd text"
+            ].value
             self.parent_h.xanes_fit_edge_0p5_fit_s = self.hs[
-                'FitEngRagEdge0.5Str text'].value
+                "FitEngRagEdge0.5Str text"
+            ].value
             self.parent_h.xanes_fit_edge_0p5_fit_e = self.hs[
-                'FitEngRagEdge0.5End text'].value
+                "FitEngRagEdge0.5End text"
+            ].value
 
-            self.fit_wl_pos = self.hs['FitItemConfigFitWl chbx'].value
-            self.fit_edge50_pos = self.hs['FitItemConfigFitEdge50% chbx'].value
-            self.find_wl_pos_dir = self.hs['FitItemConfigCalWlDir chbx'].value
-            self.find_edge50_pos_dir = self.hs[
-                'FitItemConfigCalEdge50%Dir chbx'].value
-            self.fit_use_flt_spec = self.hs['FitItemConfigFitSpec chbx'].value
-            self.fit_mask_prev = self.hs['FitItemConfigFitPrvw chbx'].value
+            self.fit_wl_pos = self.hs["FitItemConfigFitWl chbx"].value
+            self.fit_edge50_pos = self.hs["FitItemConfigFitEdge50% chbx"].value
+            self.find_wl_pos_dir = self.hs["FitItemConfigCalWlDir chbx"].value
+            self.find_edge50_pos_dir = self.hs["FitItemConfigCalEdge50%Dir chbx"].value
+            self.fit_use_flt_spec = self.hs["FitItemConfigFitSpec chbx"].value
+            self.fit_mask_prev = self.hs["FitItemConfigFitPrvw chbx"].value
 
             if self.fit_wl_pos:
-                self.fit_wl_optimizer = self.hs[
-                    'FitConfigWlOptmzr drpdn'].value
-                self.fit_wl_fit_func = self.hs['FitConfigWlFunc drpdn'].value
+                self.fit_wl_optimizer = self.hs["FitConfigWlOptmzr drpdn"].value
+                self.fit_wl_fit_func = self.hs["FitConfigWlFunc drpdn"].value
             else:
                 self.fit_wl_optimizer = None
                 self.fit_wl_fit_func = None
             if self.fit_edge50_pos:
-                self.fit_edge_optimizer = self.hs[
-                    'FitConfigEdgeOptmzr drpdn'].value
-                self.fit_edge_fit_func = self.hs[
-                    'FitConfigEdgeFunc drpdn'].value
+                self.fit_edge_optimizer = self.hs["FitConfigEdgeOptmzr drpdn"].value
+                self.fit_edge_fit_func = self.hs["FitConfigEdgeFunc drpdn"].value
             else:
                 self.fit_edge_optimizer = None
                 self.fit_edge_fit_func = None
 
-            self.analysis_saving_items = set(
-                self.hs['FitSavSettingSel mulsel'].options)
-            self.analysis_saving_items.remove('')
+            self.analysis_saving_items = set(self.hs["FitSavSettingSel mulsel"].options)
+            self.analysis_saving_items.remove("")
         if self.parent_h.xanes_fit_spectrum is None:
             self.parent_h.xanes_fit_spectrum = np.ndarray(
-                self.parent_h.xanes_fit_data_shape[1:], dtype=np.float32)
-        if self.parent_h.gui_name == 'xanes3D':
+                self.parent_h.xanes_fit_data_shape[1:], dtype=np.float32
+            )
+        if self.parent_h.gui_name == "xanes3D":
             self.parent_h.update_xanes3D_config()
-            json.dump(self.parent_h.xanes_config,
-                      open(self.parent_h.xanes_save_trial_reg_config_filename,
-                           'w'),
-                      cls=NumpyArrayEncoder,
-                      indent=4,
-                      separators=(',', ': '))
-        elif self.parent_h.gui_name == 'xanes2D':
+            json.dump(
+                self.parent_h.xanes_config,
+                open(self.parent_h.xanes_save_trial_reg_config_filename, "w"),
+                cls=NumpyArrayEncoder,
+                indent=4,
+                separators=(",", ": "),
+            )
+        elif self.parent_h.gui_name == "xanes2D":
             self.parent_h.update_xanes2D_config()
             json.dump(
                 self.parent_h.xanes_config,
-                open(self.parent_h.xanes_file_save_trial_reg_config_filename,
-                     'w'),
+                open(self.parent_h.xanes_file_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
                 indent=4,
-                separators=(',', ': '))
+                separators=(",", ": "),
+            )
 
     def fit_eng_rag_optn_drpdn(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
-        self.parent_h.xanes_fit_type = a['owner'].value
-        self.hs[
-            'FitEngRagEdgeEng text'].value = self.parent_h.xanes_fit_edge_eng
-        self.hs[
-            'FitEngRagWlFitEnd text'].value = self.parent_h.xanes_fit_wl_fit_eng_e
-        self.hs[
-            'FitEngRagWlFitStr text'].value = self.parent_h.xanes_fit_wl_fit_eng_s
-        self.hs[
-            'FitEngRagEdge0.5End text'].value = self.parent_h.xanes_fit_edge_0p5_fit_e
-        self.hs[
-            'FitEngRagEdge0.5Str text'].value = self.parent_h.xanes_fit_edge_0p5_fit_s
-        self.hs[
-            'FitEngRagPreEdgeEnd text'].value = self.parent_h.xanes_fit_pre_edge_e
-        self.hs[
-            'FitEngRagPostEdgeStr text'].value = self.parent_h.xanes_fit_post_edge_s
+        self.parent_h.xanes_fit_type = a["owner"].value
+        self.hs["FitEngRagEdgeEng text"].value = self.parent_h.xanes_fit_edge_eng
+        self.hs["FitEngRagWlFitEnd text"].value = self.parent_h.xanes_fit_wl_fit_eng_e
+        self.hs["FitEngRagWlFitStr text"].value = self.parent_h.xanes_fit_wl_fit_eng_s
+        self.hs["FitEngRagEdge0.5End text"].value = (
+            self.parent_h.xanes_fit_edge_0p5_fit_e
+        )
+        self.hs["FitEngRagEdge0.5Str text"].value = (
+            self.parent_h.xanes_fit_edge_0p5_fit_s
+        )
+        self.hs["FitEngRagPreEdgeEnd text"].value = self.parent_h.xanes_fit_pre_edge_e
+        self.hs["FitEngRagPostEdgeStr text"].value = self.parent_h.xanes_fit_post_edge_s
         self.set_xanes_analysis_eng_bounds()
 
-        self.hs[
-            'FitRun text'].value = 'please check your settings before run the analysis ...'
+        self.hs["FitRun text"].value = (
+            "please check your settings before run the analysis ..."
+        )
         self.fit_flt_prev_configed = False
         self.boxes_logic()
 
     def fit_eng_rag_edge_eng_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
         self.fit_flt_prev_configed = False
-        self.parent_h.xanes_fit_edge_eng = self.hs[
-            'FitEngRagEdgeEng text'].value
-        self.hs[
-            'FitRun text'].description = 'please check your settings before run the analysis ...'
+        self.parent_h.xanes_fit_edge_eng = self.hs["FitEngRagEdgeEng text"].value
+        self.hs["FitRun text"].description = (
+            "please check your settings before run the analysis ..."
+        )
 
     def fit_eng_rag_pre_edge_end_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
         self.fit_flt_prev_configed = False
-        self.parent_h.xanes_fit_pre_edge_e = self.hs[
-            'FitEngRagPreEdgeEnd text'].value
-        self.hs[
-            'FitRun text'].description = 'please check your settings before run the analysis ...'
+        self.parent_h.xanes_fit_pre_edge_e = self.hs["FitEngRagPreEdgeEnd text"].value
+        self.hs["FitRun text"].description = (
+            "please check your settings before run the analysis ..."
+        )
 
     def fit_eng_rag_post_edge_str_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
         self.fit_flt_prev_configed = False
-        self.parent_h.xanes_fit_post_edge_s = self.hs[
-            'FitEngRagPostEdgeStr text'].value
-        self.hs[
-            'FitRun text'].description = 'please check your settings before run the analysis ...'
+        self.parent_h.xanes_fit_post_edge_s = self.hs["FitEngRagPostEdgeStr text"].value
+        self.hs["FitRun text"].description = (
+            "please check your settings before run the analysis ..."
+        )
 
     def fit_eng_rag_wl_fit_str_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
-        self.hs[
-            'FitRun text'].value = 'please check your settings before run the analysis ...'
-        self.parent_h.xanes_fit_wl_fit_eng_s = self.hs[
-            'FitEngRagWlFitStr text'].value
+        self.hs["FitRun text"].value = (
+            "please check your settings before run the analysis ..."
+        )
+        self.parent_h.xanes_fit_wl_fit_eng_s = self.hs["FitEngRagWlFitStr text"].value
 
     def fit_eng_rag_wl_fit_end_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
-        self.hs[
-            'FitRun text'].value = 'please check your settings before run the analysis ...'
-        self.parent_h.xanes_fit_wl_fit_eng_e = self.hs[
-            'FitEngRagWlFitEnd text'].value
+        self.hs["FitRun text"].value = (
+            "please check your settings before run the analysis ..."
+        )
+        self.parent_h.xanes_fit_wl_fit_eng_e = self.hs["FitEngRagWlFitEnd text"].value
 
     def fit_eng_rag_edge50_fit_str_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
-        self.hs[
-            'FitRun text'].value = 'please check your settings before run the analysis ...'
+        self.hs["FitRun text"].value = (
+            "please check your settings before run the analysis ..."
+        )
         self.parent_h.xanes_fit_edge_0p5_fit_s = self.hs[
-            'FitEngRagEdge0.5Str text'].value
+            "FitEngRagEdge0.5Str text"
+        ].value
 
     def fit_eng_rag_edge50_fit_end_text_chg(self, a):
         self.parent_h.xanes_fit_eng_configured = False
         self.xanes_fit_eng_config = False
-        self.hs[
-            'FitRun text'].value = 'please check your settings before run the analysis ...'
+        self.hs["FitRun text"].value = (
+            "please check your settings before run the analysis ..."
+        )
         self.parent_h.xanes_fit_edge_0p5_fit_e = self.hs[
-            'FitEngRagEdge0.5End text'].value
+            "FitEngRagEdge0.5End text"
+        ].value
 
     def fit_eng_rag_cmf_btn_clk(self, a):
         self.update_fit_params()
-        self.parent_h.xanes_fit_type = self.hs['FitEngRagOptn drpdn'].value
-        if self.parent_h.xanes_fit_type == 'wl':
+        self.parent_h.xanes_fit_type = self.hs["FitEngRagOptn drpdn"].value
+        if self.parent_h.xanes_fit_type == "wl":
             self.parent_h.xanes_fit_wl_fit_eng_s = self.hs[
-                'FitEngRagWlFitStr text'].value
+                "FitEngRagWlFitStr text"
+            ].value
             self.parent_h.xanes_fit_wl_fit_eng_e = self.hs[
-                'FitEngRagWlFitEnd text'].value
+                "FitEngRagWlFitEnd text"
+            ].value
+
+            self.hs["FitItemConfigFitWl chbx"].value = True
+            self.hs["FitItemConfigFitEdge50% chbx"].value = False
+            self.hs["FitItemConfigFitSpec chbx"].value = False
+            self.hs["FitItemConfigCalWlDir chbx"].value = False
+            self.hs["FitItemConfigCalEdge50%Dir chbx"].value = False
+            self.hs["FitItemConfigFitPrvw chbx"].value = False
 
-            self.hs['FitItemConfigFitWl chbx'].value = True
-            self.hs['FitItemConfigFitEdge50% chbx'].value = False
-            self.hs['FitItemConfigFitSpec chbx'].value = False
-            self.hs['FitItemConfigCalWlDir chbx'].value = False
-            self.hs['FitItemConfigCalEdge50%Dir chbx'].value = False
-            self.hs['FitItemConfigFitPrvw chbx'].value = False
-
-            self.hs['FitSavSettingOpt mulsel'].options = dat_dict.XANES_WL_SAVE_ITEM_OPTIONS
-            self.hs['FitSavSettingOpt mulsel'].value = ['wl_pos_fit']
-            self.hs['FitSavSettingSel mulsel'].options = dat_dict.XANES_WL_SAVE_DEFAULT
-            self.hs['FitSavSettingSel mulsel'].value = ['']
+            self.hs["FitSavSettingOpt mulsel"].options = (
+                dat_dict.XANES_WL_SAVE_ITEM_OPTIONS
+            )
+            self.hs["FitSavSettingOpt mulsel"].value = ["wl_pos_fit"]
+            self.hs["FitSavSettingSel mulsel"].options = dat_dict.XANES_WL_SAVE_DEFAULT
+            self.hs["FitSavSettingSel mulsel"].value = [""]
             self.analysis_saving_items = deepcopy(dat_dict.XANES_WL_SAVE_DEFAULT)
-            self.analysis_saving_items.remove('')
-        elif self.parent_h.xanes_fit_type == 'full':
-            self.parent_h.xanes_fit_edge_eng = self.hs[
-                'FitEngRagEdgeEng text'].value
+            self.analysis_saving_items.remove("")
+        elif self.parent_h.xanes_fit_type == "full":
+            self.parent_h.xanes_fit_edge_eng = self.hs["FitEngRagEdgeEng text"].value
             self.parent_h.xanes_fit_pre_edge_e = self.hs[
-                'FitEngRagPreEdgeEnd text'].value
+                "FitEngRagPreEdgeEnd text"
+            ].value
             self.parent_h.xanes_fit_post_edge_s = self.hs[
-                'FitEngRagPostEdgeStr text'].value
+                "FitEngRagPostEdgeStr text"
+            ].value
             self.parent_h.xanes_fit_wl_fit_eng_s = self.hs[
-                'FitEngRagWlFitStr text'].value
+                "FitEngRagWlFitStr text"
+            ].value
             self.parent_h.xanes_fit_wl_fit_eng_e = self.hs[
-                'FitEngRagWlFitEnd text'].value
+                "FitEngRagWlFitEnd text"
+            ].value
             self.parent_h.xanes_fit_edge_0p5_fit_s = self.hs[
-                'FitEngRagEdge0.5Str text'].value
+                "FitEngRagEdge0.5Str text"
+            ].value
             self.parent_h.xanes_fit_edge_0p5_fit_e = self.hs[
-                'FitEngRagEdge0.5End text'].value
-            self.hs['FitItemConfigFitWl chbx'].value = True
-            self.hs['FitItemConfigFitEdge50% chbx'].value = True
-            self.hs['FitItemConfigFitSpec chbx'].value = False
-            self.hs['FitItemConfigCalWlDir chbx'].value = False
-            self.hs['FitItemConfigCalEdge50%Dir chbx'].value = False
-            self.hs['FitItemConfigFitPrvw chbx'].value = False
-
-            self.hs['FitSavSettingOpt mulsel'].options = dat_dict.XANES_FULL_SAVE_ITEM_OPTIONS
-            self.hs['FitSavSettingOpt mulsel'].value = ['centroid_of_eng']
-            self.hs['FitSavSettingSel mulsel'].options = dat_dict.XANES_FULL_SAVE_DEFAULT
-            self.hs['FitSavSettingSel mulsel'].value = ['']
+                "FitEngRagEdge0.5End text"
+            ].value
+            self.hs["FitItemConfigFitWl chbx"].value = True
+            self.hs["FitItemConfigFitEdge50% chbx"].value = True
+            self.hs["FitItemConfigFitSpec chbx"].value = False
+            self.hs["FitItemConfigCalWlDir chbx"].value = False
+            self.hs["FitItemConfigCalEdge50%Dir chbx"].value = False
+            self.hs["FitItemConfigFitPrvw chbx"].value = False
+
+            self.hs["FitSavSettingOpt mulsel"].options = (
+                dat_dict.XANES_FULL_SAVE_ITEM_OPTIONS
+            )
+            self.hs["FitSavSettingOpt mulsel"].value = ["centroid_of_eng"]
+            self.hs["FitSavSettingSel mulsel"].options = (
+                dat_dict.XANES_FULL_SAVE_DEFAULT
+            )
+            self.hs["FitSavSettingSel mulsel"].value = [""]
             self.analysis_saving_items = deepcopy(dat_dict.XANES_FULL_SAVE_DEFAULT)
-            self.analysis_saving_items.remove('')
+            self.analysis_saving_items.remove("")
         if self.parent_h.xanes_fit_spectrum is None:
             self.parent_h.xanes_fit_spectrum = np.ndarray(
-                self.parent_h.xanes_fit_data_shape[1:], dtype=np.float32)
-        if self.parent_h.gui_name == 'xanes3D':
+                self.parent_h.xanes_fit_data_shape[1:], dtype=np.float32
+            )
+        if self.parent_h.gui_name == "xanes3D":
             self.parent_h.update_xanes3D_config()
-            json.dump(self.parent_h.xanes_config,
-                      open(self.parent_h.xanes_save_trial_reg_config_filename,
-                           'w'),
-                      cls=NumpyArrayEncoder,
-                      indent=4,
-                      separators=(',', ': '))
-        elif self.parent_h.gui_name == 'xanes2D':
+            json.dump(
+                self.parent_h.xanes_config,
+                open(self.parent_h.xanes_save_trial_reg_config_filename, "w"),
+                cls=NumpyArrayEncoder,
+                indent=4,
+                separators=(",", ": "),
+            )
+        elif self.parent_h.gui_name == "xanes2D":
             self.parent_h.update_xanes2D_config()
             json.dump(
                 self.parent_h.xanes_config,
-                open(self.parent_h.xanes_file_save_trial_reg_config_filename,
-                     'w'),
+                open(self.parent_h.xanes_file_save_trial_reg_config_filename, "w"),
                 cls=NumpyArrayEncoder,
                 indent=4,
-                separators=(',', ': '))
+                separators=(",", ": "),
+            )
 
         for ii in dat_dict.XANES_PEAK_LINE_SHAPES:
             dat_dict.XANES_PEAK_FIT_PARAM_DICT[ii][1][1] = (
-                self.parent_h.xanes_fit_wl_fit_eng_s +
-                self.parent_h.xanes_fit_wl_fit_eng_e) / 2.
-        boxes = ['FitItemConfig box', 'FitSavSetting box', 'FitRun box']
+                self.parent_h.xanes_fit_wl_fit_eng_s
+                + self.parent_h.xanes_fit_wl_fit_eng_e
+            ) / 2.0
+        boxes = ["FitItemConfig box", "FitSavSetting box", "FitRun box"]
         enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
 
         cnt = 0
         for ii in self.fit_edge_fit_func_arg_handles:
             ii.disabled = True
-            ii.description = 'p' + str(cnt)
+            ii.description = "p" + str(cnt)
             cnt += 1
-        self.hs['FitConfigWlOptmzr drpdn'].value = 'scipy'
-        self.hs['FitConfigWlOptmzr drpdn'].value = 'numpy'
-        self.hs['FitConfigWlFunc drpdn'].options = [2, 3, 4]
-        self.hs['FitConfigWlFunc drpdn'].value = 2
-        self.hs['FitConfigEdgeOptmzr drpdn'].value = 'numpy'
-        self.hs['FitConfigEdgeFunc drpdn'].options = [2, 3, 4]
-        self.hs['FitConfigEdgeFunc drpdn'].value = 3
+        self.hs["FitConfigWlOptmzr drpdn"].value = "scipy"
+        self.hs["FitConfigWlOptmzr drpdn"].value = "numpy"
+        self.hs["FitConfigWlFunc drpdn"].options = [2, 3, 4]
+        self.hs["FitConfigWlFunc drpdn"].value = 2
+        self.hs["FitConfigEdgeOptmzr drpdn"].value = "numpy"
+        self.hs["FitConfigEdgeFunc drpdn"].options = [2, 3, 4]
+        self.hs["FitConfigEdgeFunc drpdn"].value = 3
         self.parent_h.xanes_fit_eng_configured = True
         self.xanes_fit_eng_config = True
         self.boxes_logic()
         self.set_save_items()
 
     def fit_config_fit_wl_chbx_chg(self, a):
-        if a['owner'].value:
-            a['owner'].value = True
+        if a["owner"].value:
+            a["owner"].value = True
             self.fit_wl_pos = True
-            boxes = ['FitConfigWlPars box']
+            boxes = ["FitConfigWlPars box"]
             enable_disable_boxes(self.hs, boxes, disabled=False, level=-1)
-            self.hs['FitConfigWlOptmzr drpdn'].value = 'numpy'
-            self.hs['FitConfigWlFunc drpdn'].options = [2, 3, 4]
-            self.hs['FitConfigWlFunc drpdn'].value = 2
+            self.hs["FitConfigWlOptmzr drpdn"].value = "numpy"
+            self.hs["FitConfigWlFunc drpdn"].options = [2, 3, 4]
+            self.hs["FitConfigWlFunc drpdn"].value = 2
         else:
             self.fit_wl_pos = False
-            boxes = ['FitConfigWlPars box']
+            boxes = ["FitConfigWlPars box"]
             enable_disable_boxes(self.hs, boxes, disabled=True, level=-1)
         self.boxes_logic()
         self.set_save_items()
 
     def fit_config_fit_edge50_chbx_chg(self, a):
-        self.fit_edge50_pos = a['owner'].value
+        self.fit_edge50_pos = a["owner"].value
         self.boxes_logic()
         self.set_save_items()
 
     def fit_config_flt_spec_chbx_chg(self, a):
-        self.fit_use_flt_spec = a['owner'].value
+        self.fit_use_flt_spec = a["owner"].value
         self.set_save_items()
 
     def fit_config_cal_wl_dir_chbx_chg(self, a):
-        self.find_wl_pos_dir = a['owner'].value
+        self.find_wl_pos_dir = a["owner"].value
         self.set_save_items()
         self.boxes_logic()
 
     def fit_config_cal_edge50_dir_chbx_chg(self, a):
-        self.find_edge50_pos_dir = a['owner'].value
+        self.find_edge50_pos_dir = a["owner"].value
         self.set_save_items()
 
     def fit_config_fit_edge_jump_thres_sldr_chg(self, a):
         self.fit_flt_prev_maskit = False
-        self.parent_h.xanes_fit_edge_jump_thres = a['owner'].value
+        self.parent_h.xanes_fit_edge_jump_thres = a["owner"].value
         self.boxes_logic()
 
     def fit_config_fit_edge_ofst_thres_sldr_chg(self, a):
         self.fit_flt_prev_maskit = False
-        self.parent_h.xanes_fit_edge_offset_thres = a['owner'].value
+        self.parent_h.xanes_fit_edge_offset_thres = a["owner"].value
         self.boxes_logic()
 
     def fit_config_bin_fac_text_chg(self, a):
-        self.fit_img_bin_fac = a['owner'].value
+        self.fit_img_bin_fac = a["owner"].value
         self.boxes_logic()
 
     def fit_config_mask_prvw_chbx_chg(self, a):
-        if a['owner'].value:
+        if a["owner"].value:
             self.fit_mask_prev = True
-            if self.parent_h.gui_name == 'xanes3D':
-                self.hs[
-                    'FitItemConfigFitPrvwSli sldr'].max = self.parent_h.xanes_fit_data_shape[
-                        2] - 1
-                self.hs['FitItemConfigFitPrvwSli sldr'].disabled = False
-                with h5py.File(self.parent_h.xanes_save_trial_reg_filename,
-                               'r') as f:
+            if self.parent_h.gui_name == "xanes3D":
+                self.hs["FitItemConfigFitPrvwSli sldr"].max = (
+                    self.parent_h.xanes_fit_data_shape[2] - 1
+                )
+                self.hs["FitItemConfigFitPrvwSli sldr"].disabled = False
+                with h5py.File(self.parent_h.xanes_save_trial_reg_filename, "r") as f:
                     self.spec = f[
-                        '/registration_results/reg_results/registered_xanes3D'][:, :,
-                                                                                self
-                                                                                .
-                                                                                fit_flt_prev_sli, :]
+                        "/registration_results/reg_results/registered_xanes3D"
+                    ][:, :, self.fit_flt_prev_sli, :]
             else:
-                self.hs['FitItemConfigFitPrvwSli sldr'].disabled = True
-                with h5py.File(self.parent_h.xanes_save_trial_reg_filename,
-                               'r') as f:
+                self.hs["FitItemConfigFitPrvwSli sldr"].disabled = True
+                with h5py.File(self.parent_h.xanes_save_trial_reg_filename, "r") as f:
                     self.spec = f[
-                        '/registration_results/reg_results/registered_xanes2D'][:]
+                        "/registration_results/reg_results/registered_xanes2D"
+                    ][:]
         else:
             self.fit_mask_prev = False
-            self.hs['FitItemConfigFitPrvwSli sldr'].disabled = True
+            self.hs["FitItemConfigFitPrvwSli sldr"].disabled = True
         self.boxes_logic()
 
     def fit_config_flt_prvw_sli_sldr_chg(self, a):
-        self.fit_flt_prev_sli = a['owner'].value
-        if self.parent_h.gui_name == 'xanes3D':
-            with h5py.File(self.parent_h.xanes_save_trial_reg_filename,
-                           'r') as f:
-                self.spec = f[
-                    '/registration_results/reg_results/registered_xanes3D'][:, :,
-                                                                            self.fit_flt_prev_sli, :]
+        self.fit_flt_prev_sli = a["owner"].value
+        if self.parent_h.gui_name == "xanes3D":
+            with h5py.File(self.parent_h.xanes_save_trial_reg_filename, "r") as f:
+                self.spec = f["/registration_results/reg_results/registered_xanes3D"][
+                    :, :, self.fit_flt_prev_sli, :
+                ]
             self.fit_flt_prev_configed = False
 
     def fit_config_flt_prvw_calc_btn_clk(self, a):
-        tmp_file = os.path.join(self.global_h.tmp_dir, 'xanes2D_tmp.h5')
+        # tmp_file = os.path.join(self.global_h.tmp_dir, 'xanes2D_tmp.h5')
+        tmp_file = str(Path(self.global_h.tmp_dir) / "xanes2D_tmp.h5")
         if self.fit_flt_prev_configed:
-            with h5py.File(tmp_file, 'r') as f:
-                self.e0_idx = f['/fitting/e0_idx'][:]
-                self.pre = f['/fitting/pre'][:]
-                self.post = f['/fitting/post'][:]
+            with h5py.File(tmp_file, "r") as f:
+                self.e0_idx = f["/fitting/e0_idx"][:]
+                self.pre = f["/fitting/pre"][:]
+                self.post = f["/fitting/post"][:]
             self.edge_jump_mask = np.squeeze(
-                (self.post[self.e0_idx] - self.pre[self.e0_idx]
-                 ) > self.parent_h.xanes_fit_edge_jump_thres *
-                self.fit_flt_prev_xana.pre_edge_sd_map).astype(np.int8)
+                (self.post[self.e0_idx] - self.pre[self.e0_idx])
+                > self.parent_h.xanes_fit_edge_jump_thres
+                * self.fit_flt_prev_xana.pre_edge_sd_map
+            ).astype(np.int8)
             self.fitted_edge_mask = np.any(
-                (self.post - self.pre) >
-                self.parent_h.xanes_fit_edge_offset_thres *
-                self.fit_flt_prev_xana.pre_edge_sd_map,
-                axis=0).astype(np.int8)
+                (self.post - self.pre)
+                > self.parent_h.xanes_fit_edge_offset_thres
+                * self.fit_flt_prev_xana.pre_edge_sd_map,
+                axis=0,
+            ).astype(np.int8)
         else:
-            self.pre_es_idx = xm.index_of(self.parent_h.xanes_fit_eng_list,
-                                          self.parent_h.xanes_fit_eng_list[0])
-            self.pre_ee_idx = xm.index_of(self.parent_h.xanes_fit_eng_list,
-                                          self.parent_h.xanes_fit_pre_edge_e)
-            self.post_es_idx = xm.index_of(self.parent_h.xanes_fit_eng_list,
-                                           self.parent_h.xanes_fit_post_edge_s)
+            self.pre_es_idx = xm.index_of(
+                self.parent_h.xanes_fit_eng_list, self.parent_h.xanes_fit_eng_list[0]
+            )
+            self.pre_ee_idx = xm.index_of(
+                self.parent_h.xanes_fit_eng_list, self.parent_h.xanes_fit_pre_edge_e
+            )
+            self.post_es_idx = xm.index_of(
+                self.parent_h.xanes_fit_eng_list, self.parent_h.xanes_fit_post_edge_s
+            )
             self.post_ee_idx = xm.index_of(
-                self.parent_h.xanes_fit_eng_list,
-                self.parent_h.xanes_fit_eng_list[-1])
+                self.parent_h.xanes_fit_eng_list, self.parent_h.xanes_fit_eng_list[-1]
+            )
 
             ln = 0
             code = {}
-            code[
-                ln] = f"import TXM_Sandbox.utils.xanes_analysis as xa"
+            code[ln] = f"import TXM_Sandbox.utils.xanes_analysis as xa"
             ln += 1
-            code[
-                ln] = f"import TXM_Sandbox.utils.xanes_math as xm"
+            code[ln] = f"import TXM_Sandbox.utils.xanes_math as xm"
             ln += 1
-            code[
-                ln] = f"import numpy as np"
+            code[ln] = f"import numpy as np"
             ln += 1
-            code[
-                ln] = f"import h5py"
+            code[ln] = f"import h5py"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"with h5py.File('{self.parent_h.xanes_save_trial_reg_filename}', 'r') as f:"
+            code[ln] = (
+                f"with h5py.File('{self.parent_h.xanes_save_trial_reg_filename}', 'r') as f:"
+            )
             ln += 1
-            code[
-                ln] = f"    if '{self.parent_h.gui_name}' == 'xanes3D':"
+            code[ln] = f"    if '{self.parent_h.gui_name}' == 'xanes3D':"
             ln += 1
-            code[
-                ln] = f"        spec = f['/registration_results/reg_results/registered_xanes3D'][:, :, {self.fit_flt_prev_sli}, :]"
+            code[ln] = (
+                f"        spec = f['/registration_results/reg_results/registered_xanes3D'][:, :, {self.fit_flt_prev_sli}, :]"
+            )
             ln += 1
-            code[
-                ln] = f"    else:"
+            code[ln] = f"    else:"
             ln += 1
-            code[
-                ln] = f"        spec = f['/registration_results/reg_results/registered_xanes2D'][:]"
+            code[ln] = (
+                f"        spec = f['/registration_results/reg_results/registered_xanes2D'][:]"
+            )
             ln += 1
-            code[
-                ln] = f"    eng_list = f['/registration_results/reg_results/eng_list'][:]"
+            code[ln] = (
+                f"    eng_list = f['/registration_results/reg_results/eng_list'][:]"
+            )
             ln += 1
-            code[
-                ln] = f"fit_flt_prev_xana = xa.xanes_analysis(spec, eng_list,\
+            code[ln] = (
+                f"fit_flt_prev_xana = xa.xanes_analysis(spec, eng_list,\
                                                                 {self.parent_h.xanes_fit_edge_eng},\
                                                                 pre_ee={self.parent_h.xanes_fit_pre_edge_e},\
                                                                 post_es={self.parent_h.xanes_fit_post_edge_s},\
                                                                 edge_jump_threshold={self.parent_h.xanes_fit_edge_jump_thres},\
                                                                 pre_edge_threshold={self.parent_h.xanes_fit_edge_offset_thres})"
+            )
 
             ln += 1
-            code[
-                ln] = f"fit_flt_prev_xana.cal_pre_edge_sd()"
+            code[ln] = f"fit_flt_prev_xana.cal_pre_edge_sd()"
             ln += 1
-            code[
-                ln] = f"fit_flt_prev_xana.cal_post_edge_sd()"
+            code[ln] = f"fit_flt_prev_xana.cal_post_edge_sd()"
             ln += 1
-            code[
-                ln] = f"fit_flt_prev_xana.cal_pre_edge_mean()"
+            code[ln] = f"fit_flt_prev_xana.cal_pre_edge_mean()"
             ln += 1
-            code[
-                ln] = f"fit_flt_prev_xana.cal_post_edge_mean()"
+            code[ln] = f"fit_flt_prev_xana.cal_post_edge_mean()"
             ln += 1
-            code[
-                ln] = f"e0_idx = xm.index_of(fit_flt_prev_xana.eng, fit_flt_prev_xana.preset_edge_eng)"
+            code[ln] = (
+                f"e0_idx = xm.index_of(fit_flt_prev_xana.eng, fit_flt_prev_xana.preset_edge_eng)"
+            )
             ln += 1
-            code[
-                ln] = f"pre = fit_flt_prev_xana.cal_pre_edge_fit()"
+            code[ln] = f"pre = fit_flt_prev_xana.cal_pre_edge_fit()"
             ln += 1
-            code[
-                ln] = f"post = fit_flt_prev_xana.cal_post_edge_fit()"
+            code[ln] = f"post = fit_flt_prev_xana.cal_post_edge_fit()"
             ln += 1
-            code[
-                ln] = f"edge_jump_mask = np.squeeze((post[e0_idx] - pre[e0_idx]) > \
+            code[ln] = (
+                f"edge_jump_mask = np.squeeze((post[e0_idx] - pre[e0_idx]) > \
                                                      fit_flt_prev_xana.edge_jump_thres * \
                                                      fit_flt_prev_xana.pre_edge_sd_map).astype(np.int8)"
+            )
 
             ln += 1
-            code[
-                ln] = f"fitted_edge_mask = np.any((post - pre) >\
+            code[ln] = (
+                f"fitted_edge_mask = np.any((post - pre) >\
                                                     fit_flt_prev_xana.fitted_edge_thres * \
                                                     fit_flt_prev_xana.pre_edge_sd_map, axis=0).astype(np.int8)"
+            )
 
             ln += 1
-            code[
-                ln] = f"with h5py.File('{tmp_file}', 'a') as f:"
+            code[ln] = f"with h5py.File('{tmp_file}', 'a') as f:"
             ln += 1
-            code[
-                ln] = f"    if '/fitting' not in f:"
+            code[ln] = f"    if '/fitting' not in f:"
             ln += 1
-            code[
-                ln] = f"        g0 = f.create_group('fitting')"
+            code[ln] = f"        g0 = f.create_group('fitting')"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('e0_idx', data=e0_idx)"
+            code[ln] = f"        g0.create_dataset('e0_idx', data=e0_idx)"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('pre', data=pre)"
+            code[ln] = f"        g0.create_dataset('pre', data=pre)"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('post', data=post)"
+            code[ln] = f"        g0.create_dataset('post', data=post)"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('edge_jump_mask', data=edge_jump_mask)"
+            code[ln] = (
+                f"        g0.create_dataset('edge_jump_mask', data=edge_jump_mask)"
+            )
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('fitted_edge_mask', data=fitted_edge_mask)"
+            code[ln] = (
+                f"        g0.create_dataset('fitted_edge_mask', data=fitted_edge_mask)"
+            )
             ln += 1
-            code[
-                ln] = f"    else:"
+            code[ln] = f"    else:"
             ln += 1
-            code[
-                ln] = f"        del f['/fitting']"
+            code[ln] = f"        del f['/fitting']"
             ln += 1
-            code[
-                ln] = f"        g0 = f.create_group('fitting')"
+            code[ln] = f"        g0 = f.create_group('fitting')"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('e0_idx', data=e0_idx)"
+            code[ln] = f"        g0.create_dataset('e0_idx', data=e0_idx)"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('pre', data=pre)"
+            code[ln] = f"        g0.create_dataset('pre', data=pre)"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('post', data=post)"
+            code[ln] = f"        g0.create_dataset('post', data=post)"
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('edge_jump_mask', data=edge_jump_mask)"
+            code[ln] = (
+                f"        g0.create_dataset('edge_jump_mask', data=edge_jump_mask)"
+            )
             ln += 1
-            code[
-                ln] = f"        g0.create_dataset('fitted_edge_mask', data=fitted_edge_mask)"
+            code[ln] = (
+                f"        g0.create_dataset('fitted_edge_mask', data=fitted_edge_mask)"
+            )
             ln += 1
 
             gen_external_py_script(self.xanes_mask_external_command_name, code)
-            sig = os.system(
-                f"python '{self.xanes_mask_external_command_name}'")
+            sig = os.system(f"python '{self.xanes_mask_external_command_name}'")
             if sig == 0:
-                print('XANES2D mask is generated.')
-                with h5py.File(tmp_file, 'r') as f:
-                    self.e0_idx = f['/fitting/e0_idx'][()]
-                    self.pre = f['/fitting/pre'][:]
-                    self.post = f['/fitting/post'][:]
+                print("XANES2D mask is generated.")
+                with h5py.File(tmp_file, "r") as f:
+                    self.e0_idx = f["/fitting/e0_idx"][()]
+                    self.pre = f["/fitting/pre"][:]
+                    self.post = f["/fitting/post"][:]
 
-                    self.edge_jump_mask = f['/fitting/edge_jump_mask'][:]
-                    self.fitted_edge_mask = f['/fitting/fitted_edge_mask'][:]
+                    self.edge_jump_mask = f["/fitting/edge_jump_mask"][:]
+                    self.fitted_edge_mask = f["/fitting/fitted_edge_mask"][:]
                 self.fit_flt_prev_configed = True
-                if self.parent_h.gui_name == 'xanes3D':
+                if self.parent_h.gui_name == "xanes3D":
                     data_state, viewer_state = fiji_viewer_state(
-                        self.global_h,
-                        self,
-                        viewer_name='xanes3D_fit_jump_flt_viewer')
+                        self.global_h, self, viewer_name="xanes3D_fit_jump_flt_viewer"
+                    )
                     if not viewer_state:
                         fiji_viewer_on(
                             self.global_h,
                             self,
-                            viewer_name='xanes3D_fit_jump_flt_viewer')
-                    self.global_h.xanes2D_fiji_windows[
-                        'xanes3D_fit_jump_flt_viewer']['ip'].setImage(
-                            self.global_h.ij.convert().convert(
-                                self.global_h.ij.dataset().create(
-                                    self.global_h.ij.py.to_java(
-                                        self.edge_jump_mask)),
-                                self.global_h.ImagePlusClass))
+                            viewer_name="xanes3D_fit_jump_flt_viewer",
+                        )
+                    self.global_h.xanes2D_fiji_windows["xanes3D_fit_jump_flt_viewer"][
+                        "ip"
+                    ].setImage(
+                        self.global_h.ij.convert().convert(
+                            self.global_h.ij.dataset().create(
+                                self.global_h.ij.py.to_java(self.edge_jump_mask)
+                            ),
+                            self.global_h.ImagePlusClass,
+                        )
+                    )
                     self.global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
 
                     data_state, viewer_state = fiji_viewer_state(
-                        self.global_h,
-                        self,
-                        viewer_name='xanes3D_fit_thres_flt_viewer')
+                        self.global_h, self, viewer_name="xanes3D_fit_thres_flt_viewer"
+                    )
                     if not viewer_state:
                         fiji_viewer_on(
                             self.global_h,
                             self,
-                            viewer_name='xanes3D_fit_thres_flt_viewer')
-                    self.global_h.xanes2D_fiji_windows[
-                        'xanes3D_fit_thres_flt_viewer']['ip'].setImage(
-                            self.global_h.ij.convert().convert(
-                                self.global_h.ij.dataset().create(
-                                    self.global_h.ij.py.to_java(
-                                        self.fitted_edge_mask)),
-                                self.global_h.ImagePlusClass))
+                            viewer_name="xanes3D_fit_thres_flt_viewer",
+                        )
+                    self.global_h.xanes2D_fiji_windows["xanes3D_fit_thres_flt_viewer"][
+                        "ip"
+                    ].setImage(
+                        self.global_h.ij.convert().convert(
+                            self.global_h.ij.dataset().create(
+                                self.global_h.ij.py.to_java(self.fitted_edge_mask)
+                            ),
+                            self.global_h.ImagePlusClass,
+                        )
+                    )
                     self.global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
                 else:
                     data_state, viewer_state = fiji_viewer_state(
-                        self.global_h,
-                        self,
-                        viewer_name='xanes2D_fit_jump_flt_viewer')
+                        self.global_h, self, viewer_name="xanes2D_fit_jump_flt_viewer"
+                    )
                     if not viewer_state:
                         fiji_viewer_on(
                             self.global_h,
                             self,
-                            viewer_name='xanes2D_fit_jump_flt_viewer')
-                    self.global_h.xanes2D_fiji_windows[
-                        'xanes2D_fit_jump_flt_viewer']['ip'].setImage(
-                            self.global_h.ij.convert().convert(
-                                self.global_h.ij.dataset().create(
-                                    self.global_h.ij.py.to_java(
-                                        self.edge_jump_mask)),
-                                self.global_h.ImagePlusClass))
+                            viewer_name="xanes2D_fit_jump_flt_viewer",
+                        )
+                    self.global_h.xanes2D_fiji_windows["xanes2D_fit_jump_flt_viewer"][
+                        "ip"
+                    ].setImage(
+                        self.global_h.ij.convert().convert(
+                            self.global_h.ij.dataset().create(
+                                self.global_h.ij.py.to_java(self.edge_jump_mask)
+                            ),
+                            self.global_h.ImagePlusClass,
+                        )
+                    )
                     self.global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
 
                     data_state, viewer_state = fiji_viewer_state(
-                        self.global_h,
-                        self,
-                        viewer_name='xanes2D_fit_thres_flt_viewer')
+                        self.global_h, self, viewer_name="xanes2D_fit_thres_flt_viewer"
+                    )
                     if not viewer_state:
                         fiji_viewer_on(
                             self.global_h,
                             self,
-                            viewer_name='xanes2D_fit_thres_flt_viewer')
-                    self.global_h.xanes2D_fiji_windows[
-                        'xanes2D_fit_thres_flt_viewer']['ip'].setImage(
-                            self.global_h.ij.convert().convert(
-                                self.global_h.ij.dataset().create(
-                                    self.global_h.ij.py.to_java(
-                                        self.fitted_edge_mask)),
-                                self.global_h.ImagePlusClass))
+                            viewer_name="xanes2D_fit_thres_flt_viewer",
+                        )
+                    self.global_h.xanes2D_fiji_windows["xanes2D_fit_thres_flt_viewer"][
+                        "ip"
+                    ].setImage(
+                        self.global_h.ij.convert().convert(
+                            self.global_h.ij.dataset().create(
+                                self.global_h.ij.py.to_java(self.fitted_edge_mask)
+                            ),
+                            self.global_h.ImagePlusClass,
+                        )
+                    )
                     self.global_h.ij.py.run_macro("""setMinAndMax(0, 1)""")
                 self.fit_flt_prev_maskit = True
             else:
-                print('Something wrong when generating XANES2D masks ...')
+                print("Something wrong when generating XANES2D masks ...")
                 self.fit_flt_prev_configed = False
                 self.fit_flt_prev_maskit = False
         self.boxes_logic()
 
     def fit_config_flt_prvw_em_it_btn_clk(self, a):
-        if self.parent_h.gui_name == 'xanes3D':
+        if self.parent_h.gui_name == "xanes3D":
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name='xanes3D_fit_maskit_viewer')
+                self.global_h, self, viewer_name="xanes3D_fit_maskit_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name='xanes3D_fit_maskit_viewer')
-            self.global_h.xanes2D_fiji_windows['xanes3D_fit_maskit_viewer'][
-                'ip'].setImage(self.global_h.ij.convert().convert(
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes3D_fit_maskit_viewer"
+                )
+            self.global_h.xanes2D_fiji_windows["xanes3D_fit_maskit_viewer"][
+                "ip"
+            ].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.edge_jump_mask *
-                            self.spec[int(self.spec.shape[0] / 2)])),
-                    self.global_h.ImagePlusClass))
+                            self.edge_jump_mask * self.spec[int(self.spec.shape[0] / 2)]
+                        )
+                    ),
+                    self.global_h.ImagePlusClass,
+                )
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name='xanes2D_fit_maskit_viewer')
+                self.global_h, self, viewer_name="xanes2D_fit_maskit_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name='xanes2D_fit_maskit_viewer')
-            self.global_h.xanes2D_fiji_windows['xanes2D_fit_maskit_viewer'][
-                'ip'].setImage(self.global_h.ij.convert().convert(
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes2D_fit_maskit_viewer"
+                )
+            self.global_h.xanes2D_fiji_windows["xanes2D_fit_maskit_viewer"][
+                "ip"
+            ].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.edge_jump_mask *
-                            self.spec[int(self.spec.shape[0] / 2)])),
-                    self.global_h.ImagePlusClass))
+                            self.edge_jump_mask * self.spec[int(self.spec.shape[0] / 2)]
+                        )
+                    ),
+                    self.global_h.ImagePlusClass,
+                )
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
 
     def fit_config_flt_prvw_om_it_btn_clk(self, a):
-        if self.parent_h.gui_name == 'xanes3D':
+        if self.parent_h.gui_name == "xanes3D":
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name='xanes3D_fit_maskit_viewer')
+                self.global_h, self, viewer_name="xanes3D_fit_maskit_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name='xanes3D_fit_maskit_viewer')
-            self.global_h.xanes2D_fiji_windows['xanes3D_fit_maskit_viewer'][
-                'ip'].setImage(self.global_h.ij.convert().convert(
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes3D_fit_maskit_viewer"
+                )
+            self.global_h.xanes2D_fiji_windows["xanes3D_fit_maskit_viewer"][
+                "ip"
+            ].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.fitted_edge_mask *
-                            self.spec[int(self.spec.shape[0] / 2)])),
-                    self.global_h.ImagePlusClass))
+                            self.fitted_edge_mask
+                            * self.spec[int(self.spec.shape[0] / 2)]
+                        )
+                    ),
+                    self.global_h.ImagePlusClass,
+                )
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name='xanes2D_fit_maskit_viewer')
+                self.global_h, self, viewer_name="xanes2D_fit_maskit_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name='xanes2D_fit_maskit_viewer')
-            self.global_h.xanes2D_fiji_windows['xanes2D_fit_maskit_viewer'][
-                'ip'].setImage(self.global_h.ij.convert().convert(
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes2D_fit_maskit_viewer"
+                )
+            self.global_h.xanes2D_fiji_windows["xanes2D_fit_maskit_viewer"][
+                "ip"
+            ].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.fitted_edge_mask *
-                            self.spec[int(self.spec.shape[0] / 2)])),
-                    self.global_h.ImagePlusClass))
+                            self.fitted_edge_mask
+                            * self.spec[int(self.spec.shape[0] / 2)]
+                        )
+                    ),
+                    self.global_h.ImagePlusClass,
+                )
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
 
     def fit_config_flt_prvw_emom_it_btn_clk(self, a):
-        if self.parent_h.gui_name == 'xanes3D':
+        if self.parent_h.gui_name == "xanes3D":
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name='xanes3D_fit_maskit_viewer')
+                self.global_h, self, viewer_name="xanes3D_fit_maskit_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name='xanes3D_fit_maskit_viewer')
-            self.global_h.xanes2D_fiji_windows['xanes3D_fit_maskit_viewer'][
-                'ip'].setImage(self.global_h.ij.convert().convert(
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes3D_fit_maskit_viewer"
+                )
+            self.global_h.xanes2D_fiji_windows["xanes3D_fit_maskit_viewer"][
+                "ip"
+            ].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.edge_jump_mask * self.fitted_edge_mask *
-                            self.spec[int(self.spec.shape[0] / 2)])),
-                    self.global_h.ImagePlusClass))
+                            self.edge_jump_mask
+                            * self.fitted_edge_mask
+                            * self.spec[int(self.spec.shape[0] / 2)]
+                        )
+                    ),
+                    self.global_h.ImagePlusClass,
+                )
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
         else:
             data_state, viewer_state = fiji_viewer_state(
-                self.global_h, self, viewer_name='xanes2D_fit_maskit_viewer')
+                self.global_h, self, viewer_name="xanes2D_fit_maskit_viewer"
+            )
             if not viewer_state:
-                fiji_viewer_on(self.global_h,
-                               self,
-                               viewer_name='xanes2D_fit_maskit_viewer')
-            self.global_h.xanes2D_fiji_windows['xanes2D_fit_maskit_viewer'][
-                'ip'].setImage(self.global_h.ij.convert().convert(
+                fiji_viewer_on(
+                    self.global_h, self, viewer_name="xanes2D_fit_maskit_viewer"
+                )
+            self.global_h.xanes2D_fiji_windows["xanes2D_fit_maskit_viewer"][
+                "ip"
+            ].setImage(
+                self.global_h.ij.convert().convert(
                     self.global_h.ij.dataset().create(
                         self.global_h.ij.py.to_java(
-                            self.edge_jump_mask * self.fitted_edge_mask *
-                            self.spec[int(self.spec.shape[0] / 2)])),
-                    self.global_h.ImagePlusClass))
+                            self.edge_jump_mask
+                            * self.fitted_edge_mask
+                            * self.spec[int(self.spec.shape[0] / 2)]
+                        )
+                    ),
+                    self.global_h.ImagePlusClass,
+                )
+            )
             self.global_h.ij.py.run_macro(
-                """run("Enhance Contrast", "saturated=0.35")""")
+                """run("Enhance Contrast", "saturated=0.35")"""
+            )
 
     def fit_config_lcf_chbx_chg(self, a):
-        if a['owner'].value:
+        if a["owner"].value:
             self.fit_lcf = True
             if not self.fit_lcf_ref_set:
-                self.hs['FitRun btn'].disabled = True
+                self.hs["FitRun btn"].disabled = True
         else:
             self.fit_lcf = False
-            self.hs['FitRun btn'].disabled = False
+            self.hs["FitRun btn"].disabled = False
         self.set_save_items()
         self.boxes_logic()
 
     def fit_config_lcf_cnst_chbx_chg(self, a):
-        self.fit_lcf_constr = a['owner'].value
+        self.fit_lcf_constr = a["owner"].value
 
     def fit_config_num_spec_text_chg(self, a):
-        self.fit_lcf_ref_num = a['owner'].value
-        self.fit_lcf_ref_spec = pd.DataFrame(
-            columns=['fpath', 'fname', 'eng', 'mu'])
-        self.hs['FitItemConfigLCFRef list'].options = []
-        self.hs['FitItemConfigLCFSelRef btn'].disabled = False
+        self.fit_lcf_ref_num = a["owner"].value
+        self.fit_lcf_ref_spec = pd.DataFrame(columns=["fpath", "fname", "eng", "mu"])
+        self.hs["FitItemConfigLCFRef list"].options = []
+        self.hs["FitItemConfigLCFSelRef btn"].disabled = False
         self.boxes_logic()
 
     def fit_config_sel_ref_btn_clk(self, a):
-        if len(self.hs['FitItemConfigLCFRef list'].options
-               ) < self.fit_lcf_ref_num:
+        if len(self.hs["FitItemConfigLCFRef list"].options) < self.fit_lcf_ref_num:
             if len(a.files[0]) != 0:
                 spec = np.loadtxt(a.files[0])
                 if spec[:, 0].max() < 50:
                     spec[:, 0] *= 1000
-                df = pd.DataFrame([[
-                    os.path.dirname(a.files[0]),
-                    os.path.basename(a.files[0]), spec[:, 0], spec[:, 1]
-                ]],
-                                  columns=['fpath', 'fname', 'eng', 'mu'])
+                # df = pd.DataFrame([[
+                #     os.path.dirname(a.files[0]),
+                #     os.path.basename(a.files[0]), spec[:, 0], spec[:, 1]
+                # ]],
+                #                   columns=['fpath', 'fname', 'eng', 'mu'])
+                df = pd.DataFrame(
+                    [
+                        [
+                            Path(a.files[0]).parent,
+                            Path(a.files[0]).name,
+                            spec[:, 0],
+                            spec[:, 1],
+                        ]
+                    ],
+                    columns=["fpath", "fname", "eng", "mu"],
+                )
                 self.fit_lcf_ref_spec = self.fit_lcf_ref_spec.append(
-                    df, ignore_index=True)
-                self.hs[
-                    'FitItemConfigLCFRef list'].options = self.fit_lcf_ref_spec[
-                        'fname']
-                update_json_content(self.global_h.GUI_cfg_file, {
-                    'xanes_ref_d':
-                    os.path.dirname(os.path.abspath(a.files[0]))
-                })
-                self.hs[
-                    'FitItemConfigLCFSelRef btn'].initialdir = os.path.dirname(
-                        os.path.abspath(a.files[0]))
+                    df, ignore_index=True
+                )
+                self.hs["FitItemConfigLCFRef list"].options = self.fit_lcf_ref_spec[
+                    "fname"
+                ]
+                # update_json_content(self.global_h.GUI_cfg_file, {
+                #     'xanes_ref_d':
+                #     os.path.dirname(os.path.abspath(a.files[0]))
+                # })
+                # self.hs[
+                #     'FitItemConfigLCFSelRef btn'].initialdir = os.path.dirname(
+                #         os.path.abspath(a.files[0]))
+                update_json_content(
+                    self.global_h.GUI_cfg_file,
+                    {"xanes_ref_d": str(Path(a.files[0]).absolute().parent)},
+                )
+                self.hs["FitItemConfigLCFSelRef btn"].initialdir = str(
+                    Path(a.files[0]).absolute().parent
+                )
         self.boxes_logic()
 
     def fit_config_ref_spec_list_chg(self, a):
-        if len(self.hs['FitItemConfigLCFRef list'].options
-               ) < self.fit_lcf_ref_num:
-            self.hs['FitItemConfigLCFSelRef btn'].disabled = False
+        if len(self.hs["FitItemConfigLCFRef list"].options) < self.fit_lcf_ref_num:
+            self.hs["FitItemConfigLCFSelRef btn"].disabled = False
         self.boxes_logic()
 
     def fit_config_ref_rm_btn_clk(self, a):
-        self.fit_lcf_ref_spec = \
-            self.fit_lcf_ref_spec.drop(list(self.hs['FitItemConfigLCFRef list'].index)).reset_index(drop=True)
-        tem = list(self.hs['FitItemConfigLCFRef list'].options)
-        for ii in self.hs['FitItemConfigLCFRef list'].index:
+        self.fit_lcf_ref_spec = self.fit_lcf_ref_spec.drop(
+            list(self.hs["FitItemConfigLCFRef list"].index)
+        ).reset_index(drop=True)
+        tem = list(self.hs["FitItemConfigLCFRef list"].options)
+        for ii in self.hs["FitItemConfigLCFRef list"].index:
             del tem[ii]
-        self.hs['FitItemConfigLCFRef list'].options = tem
+        self.hs["FitItemConfigLCFRef list"].options = tem
         self.boxes_logic()
 
     def fit_config_wl_optmzr_drpdn_chg(self, a):
-        self.fit_wl_optimizer = a['owner'].value
+        self.fit_wl_optimizer = a["owner"].value
         self.boxes_logic()
 
     def fit_config_wl_func_drpdn_chg(self, a):
-        self.fit_wl_fit_func = a['owner'].value
+        self.fit_wl_fit_func = a["owner"].value
         cnt = 0
         for ii in self.fit_wl_fit_func_arg_handles:
             ii.disabled = True
-            ii.description = 'p' + str(cnt)
+            ii.description = "p" + str(cnt)
             cnt += 1
-        if self.fit_wl_optimizer == 'scipy':
-            for ii in sorted(dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()):
+        if self.fit_wl_optimizer == "scipy":
+            for ii in sorted(
+                dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()
+            ):
                 self.fit_wl_fit_func_arg_handles[ii].disabled = False
-                self.fit_wl_fit_func_arg_handles[
-                    ii].description = dat_dict.XANES_PEAK_FIT_PARAM_DICT[
-                        self.fit_wl_fit_func][ii][0]
-                self.fit_wl_fit_func_arg_handles[
-                    ii].value = dat_dict.XANES_PEAK_FIT_PARAM_DICT[
-                        self.fit_wl_fit_func][ii][1]
-                self.fit_wl_fit_func_arg_handles[
-                    ii].description_tooltip = dat_dict.XANES_PEAK_FIT_PARAM_DICT[
-                        self.fit_wl_fit_func][ii][2]
+                self.fit_wl_fit_func_arg_handles[ii].description = (
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func][ii][0]
+                )
+                self.fit_wl_fit_func_arg_handles[ii].value = (
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func][ii][1]
+                )
+                self.fit_wl_fit_func_arg_handles[ii].description_tooltip = (
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func][ii][2]
+                )
         if self.fit_wl_fit_func == "rectangle":
             self.fit_wl_fit_func_arg_handles[5].options = [
-                'linear', 'atan', 'erf', 'logisitic'
+                "linear",
+                "atan",
+                "erf",
+                "logisitic",
             ]
         if self.fit_wl_fit_func == "step":
             self.fit_wl_fit_func_arg_handles[5].options = [
-                'linear', 'atan', 'erf', 'logisitic'
+                "linear",
+                "atan",
+                "erf",
+                "logisitic",
             ]
 
     def fit_config_wl_fit_bnd_chbx_chg(self, a):
-        self.fit_wl_fit_use_param_bnd = a['owner'].value
+        self.fit_wl_fit_use_param_bnd = a["owner"].value
         if self.fit_wl_fit_use_param_bnd:
             for ii in self.fit_wl_fit_func_bnd_handles:
                 ii.disabled = False
             for ii in [
-                    "gaussian", "lorentzian", "damped_oscillator", "lognormal",
-                    "students_t", "voigt", "split_lorentzian", "pvoigt",
-                    "moffat", "pearson7", "breit_wigner", "dho", "expgaussian",
-                    "donaich", "skewed_gaussian", "step", "skewed_voigt"
+                "gaussian",
+                "lorentzian",
+                "damped_oscillator",
+                "lognormal",
+                "students_t",
+                "voigt",
+                "split_lorentzian",
+                "pvoigt",
+                "moffat",
+                "pearson7",
+                "breit_wigner",
+                "dho",
+                "expgaussian",
+                "donaich",
+                "skewed_gaussian",
+                "step",
+                "skewed_voigt",
             ]:
                 dat_dict.XANES_PEAK_FIT_PARAM_BND_DICT[ii][1][1] = (
-                    self.parent_h.xanes_fit_wl_fit_eng_s +
-                    self.parent_h.xanes_fit_wl_fit_eng_e) / 2.
+                    self.parent_h.xanes_fit_wl_fit_eng_s
+                    + self.parent_h.xanes_fit_wl_fit_eng_e
+                ) / 2.0
         else:
             for ii in self.fit_wl_fit_func_bnd_handles:
                 ii.disabled = True
 
     def fit_config_edge_optmzr_drpdn_chg(self, a):
-        self.fit_edge_optimizer = a['owner'].value
+        self.fit_edge_optimizer = a["owner"].value
         self.boxes_logic()
 
     def fit_config_edge_func_drpdn_chg(self, a):
-        self.fit_edge_fit_func = a['owner'].value
+        self.fit_edge_fit_func = a["owner"].value
         cnt = 0
         for ii in self.fit_edge_fit_func_arg_handles:
             ii.disabled = True
-            ii.description = 'p' + str(cnt)
+            ii.description = "p" + str(cnt)
             cnt += 1
-        if self.fit_edge_optimizer == 'scipy':
+        if self.fit_edge_optimizer == "scipy":
             for ii in sorted(
-                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_edge_fit_func].keys()):
+                dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_edge_fit_func].keys()
+            ):
                 self.fit_edge_fit_func_arg_handles[ii].disabled = False
-                self.fit_edge_fit_func_arg_handles[
-                    ii].description = dat_dict.XANES_PEAK_FIT_PARAM_DICT[
-                        self.fit_edge_fit_func][ii][0]
-                self.fit_edge_fit_func_arg_handles[
-                    ii].value = dat_dict.XANES_PEAK_FIT_PARAM_DICT[
-                        self.fit_edge_fit_func][ii][1]
-                self.fit_edge_fit_func_arg_handles[
-                    ii].description_tooltip = dat_dict.XANES_PEAK_FIT_PARAM_DICT[
-                        self.fit_edge_fit_func][ii][2]
+                self.fit_edge_fit_func_arg_handles[ii].description = (
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_edge_fit_func][ii][0]
+                )
+                self.fit_edge_fit_func_arg_handles[ii].value = (
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_edge_fit_func][ii][1]
+                )
+                self.fit_edge_fit_func_arg_handles[ii].description_tooltip = (
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_edge_fit_func][ii][2]
+                )
         if self.fit_edge_fit_func == "rectangle":
             self.fit_edge_fit_func_arg_handles[5].options = [
-                'linear', 'atan', 'erf', 'logisitic'
+                "linear",
+                "atan",
+                "erf",
+                "logisitic",
             ]
         if self.fit_edge_fit_func == "step":
             self.fit_edge_fit_func_arg_handles[5].options = [
-                'linear', 'atan', 'erf', 'logisitic'
+                "linear",
+                "atan",
+                "erf",
+                "logisitic",
             ]
 
     def fit_config_edge_fit_bnd_chbx_chg(self, a):
-        self.fit_edge_fit_use_param_bnd = a['owner'].value
+        self.fit_edge_fit_use_param_bnd = a["owner"].value
         if self.fit_edge_fit_use_param_bnd:
             for ii in self.fit_edge_fit_func_bnd_handles:
                 ii.disabled = False
             for ii in [
-                    "gaussian", "lorentzian", "voigt", "split_lorentzian",
-                    "pvoigt", "expgaussian", "skewed_gaussian", "skewed_voigt"
+                "gaussian",
+                "lorentzian",
+                "voigt",
+                "split_lorentzian",
+                "pvoigt",
+                "expgaussian",
+                "skewed_gaussian",
+                "skewed_voigt",
             ]:
                 dat_dict.XANES_PEAK_FIT_PARAM_BND_DICT[ii][1][1] = (
-                    self.parent_h.xanes_fit_wl_fit_eng_s +
-                    self.parent_h.xanes_fit_wl_fit_eng_e) / 2.
+                    self.parent_h.xanes_fit_wl_fit_eng_s
+                    + self.parent_h.xanes_fit_wl_fit_eng_e
+                ) / 2.0
         else:
             for ii in self.fit_edge_fit_func_bnd_handles:
                 ii.disabled = True
 
     def fit_sav_setting_add_btn_clk(self, a):
-        tem = set(self.hs['FitSavSettingSel mulsel'].options)
-        [tem.add(ii) for ii in self.hs['FitSavSettingOpt mulsel'].value]
-        tem.add('')
-        self.hs['FitSavSettingSel mulsel'].options = list(sorted(tem))
-        self.hs['FitSavSettingSel mulsel'].value = ['']
+        tem = set(self.hs["FitSavSettingSel mulsel"].options)
+        [tem.add(ii) for ii in self.hs["FitSavSettingOpt mulsel"].value]
+        tem.add("")
+        self.hs["FitSavSettingSel mulsel"].options = list(sorted(tem))
+        self.hs["FitSavSettingSel mulsel"].value = [""]
         self.analysis_saving_items = list(tem)
 
     def fit_sav_setting_rm_btn_clk(self, a):
-        tem = set(self.hs['FitSavSettingSel mulsel'].options)
-        [
-            tem.remove(ii) for ii in self.hs['FitSavSettingSel mulsel'].value
-            if ii != ''
-        ]
-        tem.add('')
-        self.hs['FitSavSettingSel mulsel'].options = list(sorted(tem))
-        self.hs['FitSavSettingSel mulsel'].value = ['']
+        tem = set(self.hs["FitSavSettingSel mulsel"].options)
+        [tem.remove(ii) for ii in self.hs["FitSavSettingSel mulsel"].value if ii != ""]
+        tem.add("")
+        self.hs["FitSavSettingSel mulsel"].options = list(sorted(tem))
+        self.hs["FitSavSettingSel mulsel"].value = [""]
         self.analysis_saving_items = list(tem)
 
     def fit_run_btn_clk(self, a):
         try:
-            fiji_viewer_off(self.parent_h.global_h, viewer_name='all')
+            fiji_viewer_off(self.parent_h.global_h, viewer_name="all")
         except:
             pass
         self.analysis_saving_items = set()
-        for ii in self.hs['FitSavSettingSel mulsel'].options:
-            if ii != '':
+        for ii in self.hs["FitSavSettingSel mulsel"].options:
+            if ii != "":
                 self.analysis_saving_items.add(ii)
         self.update_fit_params()
 
         if self.fit_wl_pos:
             wl_fvars = []
             wl_bnds = []
             wl_params = {}
-            wl_params['optimizer'] = self.fit_wl_optimizer
-            wl_params['ftype'] = 'wl'
-            if self.parent_h.xanes_fit_type == 'full':
-                wl_params['on'] = 'norm'
+            wl_params["optimizer"] = self.fit_wl_optimizer
+            wl_params["ftype"] = "wl"
+            if self.parent_h.xanes_fit_type == "full":
+                wl_params["on"] = "norm"
             else:
-                wl_params['on'] = 'raw'
-            if self.fit_wl_optimizer == 'scipy':
+                wl_params["on"] = "raw"
+            if self.fit_wl_optimizer == "scipy":
                 for ii in sorted(
-                        dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()):
+                    dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()
+                ):
                     wl_fvars.append(self.fit_wl_fit_func_arg_handles[ii].value)
                 if self.fit_wl_fit_func in ["sine", "expsine"]:
                     wl_fvars[2] = 0
                 elif self.fit_wl_fit_func == "rectangle":
                     wl_fvars[1] = wl_fvars[3] = 0
                 else:
                     wl_fvars[1] = 0
                 if self.fit_wl_fit_use_param_bnd:
                     for ii in sorted(
-                            dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()):
+                        dat_dict.XANES_PEAK_FIT_PARAM_DICT[self.fit_wl_fit_func].keys()
+                    ):
                         wl_bnds.append(
-                            (self.fit_wl_fit_func_bnd_handles[2 * ii].value,
-                             self.fit_wl_fit_func_bnd_handles[2 * ii +
-                                                              1].value))
+                            (
+                                self.fit_wl_fit_func_bnd_handles[2 * ii].value,
+                                self.fit_wl_fit_func_bnd_handles[2 * ii + 1].value,
+                            )
+                        )
                 else:
                     wl_bnds = [-inf, inf]
-                wl_params['eoff'] = self.hs['FitConfigWlFitPars1 text'].value
-                wl_params['model'] = self.fit_wl_fit_func
-                wl_params['fvars'] = wl_fvars
-                wl_params['bnds'] = wl_bnds
-                wl_params['jac'] = self.fit_wl_optimizer_arg_handles[0].value
-                wl_params['method'] = self.fit_wl_optimizer_arg_handles[
-                    1].value
-                wl_params['ftol'] = self.fit_wl_optimizer_arg_handles[2].value
-                wl_params['xtol'] = self.fit_wl_optimizer_arg_handles[3].value
-                wl_params['gtol'] = self.fit_wl_optimizer_arg_handles[4].value
-            elif self.fit_wl_optimizer == 'numpy':
-                wl_params['eoff'] = (self.parent_h.xanes_fit_wl_fit_eng_s +
-                                     self.parent_h.xanes_fit_wl_fit_eng_e) / 2.
-                wl_params['model'] = 'polynd'
-                wl_order = self.hs['FitConfigWlFunc drpdn'].value
-                wl_params['order'] = wl_order
-                wl_params['flt_spec'] = self.fit_use_flt_spec
+                wl_params["eoff"] = self.hs["FitConfigWlFitPars1 text"].value
+                wl_params["model"] = self.fit_wl_fit_func
+                wl_params["fvars"] = wl_fvars
+                wl_params["bnds"] = wl_bnds
+                wl_params["jac"] = self.fit_wl_optimizer_arg_handles[0].value
+                wl_params["method"] = self.fit_wl_optimizer_arg_handles[1].value
+                wl_params["ftol"] = self.fit_wl_optimizer_arg_handles[2].value
+                wl_params["xtol"] = self.fit_wl_optimizer_arg_handles[3].value
+                wl_params["gtol"] = self.fit_wl_optimizer_arg_handles[4].value
+            elif self.fit_wl_optimizer == "numpy":
+                wl_params["eoff"] = (
+                    self.parent_h.xanes_fit_wl_fit_eng_s
+                    + self.parent_h.xanes_fit_wl_fit_eng_e
+                ) / 2.0
+                wl_params["model"] = "polynd"
+                wl_order = self.hs["FitConfigWlFunc drpdn"].value
+                wl_params["order"] = wl_order
+                wl_params["flt_spec"] = self.fit_use_flt_spec
             wl_ufac = self.fit_wl_optimizer_arg_handles[5].value
         else:
             wl_params = {}
             wl_ufac = 20
 
         if self.fit_edge50_pos:
             edge_fvars = []
             edge_bnds = []
             edge_params = {}
-            edge_params['eoff'] = self.parent_h.xanes_fit_edge_eng
-            edge_params['optimizer'] = self.fit_edge_optimizer
-            edge_params['ftype'] = 'edge'
-            if self.parent_h.xanes_fit_type == 'full':
-                edge_params['on'] = 'norm'
+            edge_params["eoff"] = self.parent_h.xanes_fit_edge_eng
+            edge_params["optimizer"] = self.fit_edge_optimizer
+            edge_params["ftype"] = "edge"
+            if self.parent_h.xanes_fit_type == "full":
+                edge_params["on"] = "norm"
             else:
-                edge_params['on'] = 'raw'
-            if self.fit_edge_optimizer == 'scipy':
+                edge_params["on"] = "raw"
+            if self.fit_edge_optimizer == "scipy":
                 for ii in sorted(
-                        dat_dict.XANES_EDGE_FIT_PARAM_DICT[self.fit_edge_fit_func].keys()):
-                    edge_fvars.append(
-                        self.fit_edge_fit_func_arg_handles[ii].value)
+                    dat_dict.XANES_EDGE_FIT_PARAM_DICT[self.fit_edge_fit_func].keys()
+                ):
+                    edge_fvars.append(self.fit_edge_fit_func_arg_handles[ii].value)
 
                 if self.fit_edge_fit_func in ["sine", "expsine"]:
                     edge_fvars[2] = 0
                 elif self.fit_edge_fit_func == "rectangle":
                     edge_fvars[1] = edge_fvars[3] = 0
                 else:
                     edge_fvars[1] = 0
 
                 if self.fit_wl_fit_use_param_bnd:
-                    for ii in sorted(dat_dict.XANES_EDGE_FIT_PARAM_DICT[
-                            self.fit_wdge_fit_func].keys()):
+                    for ii in sorted(
+                        dat_dict.XANES_EDGE_FIT_PARAM_DICT[
+                            self.fit_wdge_fit_func
+                        ].keys()
+                    ):
                         edge_bnds.append(
-                            (self.fit_edge_fit_func_bnd_handles[2 * ii].value,
-                             self.fit_edge_fit_func_bnd_handles[2 * ii +
-                                                                1].value))
+                            (
+                                self.fit_edge_fit_func_bnd_handles[2 * ii].value,
+                                self.fit_edge_fit_func_bnd_handles[2 * ii + 1].value,
+                            )
+                        )
                 else:
                     edge_bnds = [-inf, inf]
 
-                edge_params['model'] = self.fit_edge_fit_func
-                edge_params['fvars'] = edge_fvars
-                edge_params['bnds'] = edge_bnds
-                edge_params['jac'] = self.fit_edge_optimizer_arg_handles[
-                    0].value
-                edge_params['method'] = self.fit_edge_optimizer_arg_handles[
-                    1].value
-                edge_params['ftol'] = self.fit_edge_optimizer_arg_handles[
-                    2].value
-                edge_params['xtol'] = self.fit_edge_optimizer_arg_handles[
-                    3].value
-                edge_params['gtol'] = self.fit_edge_optimizer_arg_handles[
-                    4].value
-            elif self.fit_edge_optimizer == 'numpy':
-                edge_params['model'] = 'polynd'
-                edge_order = self.hs['FitConfigEdgeFunc drpdn'].value
-                edge_params['order'] = edge_order
-                edge_params['flt_spec'] = self.fit_use_flt_spec
+                edge_params["model"] = self.fit_edge_fit_func
+                edge_params["fvars"] = edge_fvars
+                edge_params["bnds"] = edge_bnds
+                edge_params["jac"] = self.fit_edge_optimizer_arg_handles[0].value
+                edge_params["method"] = self.fit_edge_optimizer_arg_handles[1].value
+                edge_params["ftol"] = self.fit_edge_optimizer_arg_handles[2].value
+                edge_params["xtol"] = self.fit_edge_optimizer_arg_handles[3].value
+                edge_params["gtol"] = self.fit_edge_optimizer_arg_handles[4].value
+            elif self.fit_edge_optimizer == "numpy":
+                edge_params["model"] = "polynd"
+                edge_order = self.hs["FitConfigEdgeFunc drpdn"].value
+                edge_params["order"] = edge_order
+                edge_params["flt_spec"] = self.fit_use_flt_spec
             edge_ufac = self.fit_edge_optimizer_arg_handles[5].value
         else:
             edge_params = {}
             edge_ufac = 20
 
-        edge50_optimizer = ''
+        edge50_optimizer = ""
         if self.fit_edge50_pos and self.fit_wl_pos:
-            edge50_optimizer = 'both'
+            edge50_optimizer = "both"
         elif self.fit_edge50_pos and (not self.fit_wl_pos):
-            edge50_optimizer = 'edge'
+            edge50_optimizer = "edge"
 
-        edge_fit_item = ['edge50_pos_fit']
-        wl_fit_item = ['wl_pos_fit']
+        edge_fit_item = ["edge50_pos_fit"]
+        wl_fit_item = ["wl_pos_fit"]
 
-        if self.parent_h.gui_name == 'xanes3D':
-            with h5py.File(self.parent_h.xanes_save_trial_reg_filename,
-                           'r+') as f:
-                if 'processed_XANES3D' not in f:
-                    g1 = f.create_group('processed_XANES3D')
+        if self.parent_h.gui_name == "xanes3D":
+            with h5py.File(self.parent_h.xanes_save_trial_reg_filename, "r+") as f:
+                if "processed_XANES3D" not in f:
+                    g1 = f.create_group("processed_XANES3D")
                 else:
-                    del f['processed_XANES3D']
-                    g1 = f.create_group('processed_XANES3D')
-                g11 = g1.create_group('proc_parameters')
+                    del f["processed_XANES3D"]
+                    g1 = f.create_group("processed_XANES3D")
+                g11 = g1.create_group("proc_parameters")
 
-                g11.create_dataset('element',
-                                   data=str(self.parent_h.xanes_element))
+                g11.create_dataset("element", data=str(self.parent_h.xanes_element))
                 g11.create_dataset(
-                    'eng_list',
-                    data=scale_eng_list(
-                        self.parent_h.xanes_fit_eng_list).astype(np.float32))
-                g11.create_dataset('edge_eng',
-                                   data=self.parent_h.xanes_fit_edge_eng)
-                g11.create_dataset('pre_edge_e',
-                                   data=self.parent_h.xanes_fit_pre_edge_e)
-                g11.create_dataset('post_edge_s',
-                                   data=self.parent_h.xanes_fit_post_edge_s)
+                    "eng_list",
+                    data=scale_eng_list(self.parent_h.xanes_fit_eng_list).astype(
+                        np.float32
+                    ),
+                )
+                g11.create_dataset("edge_eng", data=self.parent_h.xanes_fit_edge_eng)
                 g11.create_dataset(
-                    'edge_jump_threshold',
-                    data=self.parent_h.xanes_fit_edge_jump_thres)
+                    "pre_edge_e", data=self.parent_h.xanes_fit_pre_edge_e
+                )
                 g11.create_dataset(
-                    'edge_offset_threshold',
-                    data=self.parent_h.xanes_fit_edge_offset_thres)
-                g11.create_dataset('use_mask',
-                                   data=str(self.parent_h.xanes_fit_use_mask))
-                g11.create_dataset('analysis_type',
-                                   data=self.parent_h.xanes_fit_type)
-                g11.create_dataset('data_shape',
-                                   data=self.parent_h.xanes_fit_data_shape)
-                g11.create_dataset('edge50_fit_s',
-                                   data=self.parent_h.xanes_fit_edge_0p5_fit_s)
-                g11.create_dataset('edge50_fit_e',
-                                   data=self.parent_h.xanes_fit_edge_0p5_fit_e)
-                g11.create_dataset('wl_fit_eng_s',
-                                   data=self.parent_h.xanes_fit_wl_fit_eng_s)
-                g11.create_dataset('wl_fit_eng_e',
-                                   data=self.parent_h.xanes_fit_wl_fit_eng_e)
-                g11.create_dataset('pre_post_edge_norm_fit_order', data=1)
-                g11.create_dataset('flt_spec', data=str(self.fit_use_flt_spec))
-                g11.create_dataset('bin_fact', data=int(self.fit_img_bin_fac))
+                    "post_edge_s", data=self.parent_h.xanes_fit_post_edge_s
+                )
+                g11.create_dataset(
+                    "edge_jump_threshold", data=self.parent_h.xanes_fit_edge_jump_thres
+                )
+                g11.create_dataset(
+                    "edge_offset_threshold",
+                    data=self.parent_h.xanes_fit_edge_offset_thres,
+                )
+                g11.create_dataset(
+                    "use_mask", data=str(self.parent_h.xanes_fit_use_mask)
+                )
+                g11.create_dataset("analysis_type", data=self.parent_h.xanes_fit_type)
+                g11.create_dataset(
+                    "data_shape", data=self.parent_h.xanes_fit_data_shape
+                )
+                g11.create_dataset(
+                    "edge50_fit_s", data=self.parent_h.xanes_fit_edge_0p5_fit_s
+                )
+                g11.create_dataset(
+                    "edge50_fit_e", data=self.parent_h.xanes_fit_edge_0p5_fit_e
+                )
+                g11.create_dataset(
+                    "wl_fit_eng_s", data=self.parent_h.xanes_fit_wl_fit_eng_s
+                )
+                g11.create_dataset(
+                    "wl_fit_eng_e", data=self.parent_h.xanes_fit_wl_fit_eng_e
+                )
+                g11.create_dataset("pre_post_edge_norm_fit_order", data=1)
+                g11.create_dataset("flt_spec", data=str(self.fit_use_flt_spec))
+                g11.create_dataset("bin_fact", data=int(self.fit_img_bin_fac))
 
-                g111 = g11.create_group('wl_fit method')
+                g111 = g11.create_group("wl_fit method")
                 if self.fit_wl_pos:
-                    g111.create_dataset('optimizer',
-                                        data=str(wl_params['optimizer']))
-                    if wl_params['optimizer'] == 'scipy':
-                        g111.create_dataset('method',
-                                            data=str(wl_params['model']))
-                        g1111 = g111.create_group('params')
-                        g1111.create_dataset('eng_offset',
-                                             data=wl_params['eoff'])
-                        g1111.create_dataset('spec', data=str(wl_params['on']))
-                        g1111.create_dataset('jac', data=str(wl_params['jac']))
-                        g1111.create_dataset('method',
-                                             data=str(wl_params['method']))
-                        g1111.create_dataset('ftol', data=wl_params['ftol'])
-                        g1111.create_dataset('xtol', data=wl_params['xtol'])
-                        g1111.create_dataset('gtol', data=wl_params['gtol'])
-                        g1111.create_dataset('fvars_init', data=wl_fvars)
+                    g111.create_dataset("optimizer", data=str(wl_params["optimizer"]))
+                    if wl_params["optimizer"] == "scipy":
+                        g111.create_dataset("method", data=str(wl_params["model"]))
+                        g1111 = g111.create_group("params")
+                        g1111.create_dataset("eng_offset", data=wl_params["eoff"])
+                        g1111.create_dataset("spec", data=str(wl_params["on"]))
+                        g1111.create_dataset("jac", data=str(wl_params["jac"]))
+                        g1111.create_dataset("method", data=str(wl_params["method"]))
+                        g1111.create_dataset("ftol", data=wl_params["ftol"])
+                        g1111.create_dataset("xtol", data=wl_params["xtol"])
+                        g1111.create_dataset("gtol", data=wl_params["gtol"])
+                        g1111.create_dataset("fvars_init", data=wl_fvars)
                         if wl_bnds[0] is -inf:
-                            g1111.create_dataset('bnds', data=str('None'))
+                            g1111.create_dataset("bnds", data=str("None"))
                         else:
-                            g1111.create_dataset('bnds', data=wl_bnds)
+                            g1111.create_dataset("bnds", data=wl_bnds)
                     else:
-                        g111.create_dataset('method', data=str('polynd'))
-                        g1111 = g111.create_group('params')
-                        g1111.create_dataset('order', data=wl_params['order'])
-                        g1111.create_dataset('median_flt',
-                                             data=str(wl_params['flt_spec']))
-                        g1111.create_dataset('eng_offset',
-                                             data=wl_params['eoff'])
-                        g1111.create_dataset('spec', data=str(wl_params['on']))
+                        g111.create_dataset("method", data=str("polynd"))
+                        g1111 = g111.create_group("params")
+                        g1111.create_dataset("order", data=wl_params["order"])
+                        g1111.create_dataset(
+                            "median_flt", data=str(wl_params["flt_spec"])
+                        )
+                        g1111.create_dataset("eng_offset", data=wl_params["eoff"])
+                        g1111.create_dataset("spec", data=str(wl_params["on"]))
 
-                g112 = g11.create_group('edge_fit method')
+                g112 = g11.create_group("edge_fit method")
                 if self.fit_edge50_pos:
-                    g112.create_dataset('optimizer',
-                                        data=str(edge_params['optimizer']))
-                    if edge_params['optimizer'] == 'scipy':
-                        g112.create_dataset('method',
-                                            data=str(edge_params['model']))
-                        g1121 = g112.create_group('params')
-                        g1121.create_dataset('eng_offset',
-                                             data=edge_params['eoff'])
-                        g1121.create_dataset('spec',
-                                             data=str(edge_params['on']))
-                        g1121.create_dataset('jac',
-                                             data=str(edge_params['jac']))
-                        g1121.create_dataset('method',
-                                             data=str(edge_params['method']))
-                        g1121.create_dataset('ftol', data=edge_params['ftol'])
-                        g1121.create_dataset('xtol', data=edge_params['xtol'])
-                        g1121.create_dataset('gtol', data=edge_params['gtol'])
-                        g1121.create_dataset('fvars_init', data=edge_fvars)
+                    g112.create_dataset("optimizer", data=str(edge_params["optimizer"]))
+                    if edge_params["optimizer"] == "scipy":
+                        g112.create_dataset("method", data=str(edge_params["model"]))
+                        g1121 = g112.create_group("params")
+                        g1121.create_dataset("eng_offset", data=edge_params["eoff"])
+                        g1121.create_dataset("spec", data=str(edge_params["on"]))
+                        g1121.create_dataset("jac", data=str(edge_params["jac"]))
+                        g1121.create_dataset("method", data=str(edge_params["method"]))
+                        g1121.create_dataset("ftol", data=edge_params["ftol"])
+                        g1121.create_dataset("xtol", data=edge_params["xtol"])
+                        g1121.create_dataset("gtol", data=edge_params["gtol"])
+                        g1121.create_dataset("fvars_init", data=edge_fvars)
                         if edge_bnds[0] is -inf:
-                            g1121.create_dataset('bnds', data=str('None'))
+                            g1121.create_dataset("bnds", data=str("None"))
                         else:
-                            g1121.create_dataset('bnds', data=edge_bnds)
+                            g1121.create_dataset("bnds", data=edge_bnds)
                     else:
-                        g112.create_dataset('method', data=str('polynd'))
-                        g1121 = g112.create_group('params')
-                        g1121.create_dataset('order', data=edge_order)
-                        g1121.create_dataset('median_flt',
-                                             data=str(edge_params['flt_spec']))
-                        g1121.create_dataset('eng_offset',
-                                             data=edge_params['eoff'])
-                        g1121.create_dataset('spec',
-                                             data=str(edge_params['on']))
-                g113 = g11.create_group('LCF')
-                g113.create_dataset('use_lcf', data=str(self.fit_lcf))
-                g113.create_dataset('use_constr',
-                                    data=str(self.fit_lcf_constr))
+                        g112.create_dataset("method", data=str("polynd"))
+                        g1121 = g112.create_group("params")
+                        g1121.create_dataset("order", data=edge_order)
+                        g1121.create_dataset(
+                            "median_flt", data=str(edge_params["flt_spec"])
+                        )
+                        g1121.create_dataset("eng_offset", data=edge_params["eoff"])
+                        g1121.create_dataset("spec", data=str(edge_params["on"]))
+                g113 = g11.create_group("LCF")
+                g113.create_dataset("use_lcf", data=str(self.fit_lcf))
+                g113.create_dataset("use_constr", data=str(self.fit_lcf_constr))
             self.fit_lcf_ref_spec.to_hdf(
                 self.parent_h.xanes_save_trial_reg_filename,
-                '/processed_XANES3D/proc_parameters/LCF/ref',
-                mode='a')
+                "/processed_XANES3D/proc_parameters/LCF/ref",
+                mode="a",
+            )
 
             code = {}
             ln = 0
-            code[
-                ln] = f"import os, h5py"
+            code[ln] = f"import os, h5py"
             ln += 1
-            code[
-                ln] = f"import numpy as np"
+            code[ln] = f"import numpy as np"
             ln += 1
-            code[
-                ln] = f"import pandas as pd"
+            code[ln] = f"import pandas as pd"
             ln += 1
-            code[
-                ln] = f"from scipy.ndimage import zoom"
+            code[ln] = f"from scipy.ndimage import zoom"
             ln += 1
-            code[
-                ln] = f"import TXM_Sandbox.utils.xanes_math as xm"
+            code[ln] = f"import TXM_Sandbox.utils.xanes_math as xm"
             ln += 1
-            code[
-                ln] = f"import TXM_Sandbox.utils.xanes_analysis as xa"
+            code[ln] = f"import TXM_Sandbox.utils.xanes_analysis as xa"
             ln += 1
-            code[
-                ln] = f"from TXM_Sandbox.utils.misc import str2bool"
+            code[ln] = f"from TXM_Sandbox.utils.misc import str2bool"
             ln += 1
-            code[
-                ln] = f"from copy import deepcopy"
+            code[ln] = f"from copy import deepcopy"
             ln += 1
-            code[
-                ln] = f"inf = np.inf"
+            code[ln] = f"inf = np.inf"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"with h5py.File('{self.parent_h.xanes_save_trial_reg_filename}', 'r+') as f:"
+            code[ln] = (
+                f"with h5py.File('{self.parent_h.xanes_save_trial_reg_filename}', 'r+') as f:"
+            )
             ln += 1
-            code[
-                ln] = f"    if {self.fit_img_bin_fac} == 1:"
+            code[ln] = f"    if {self.fit_img_bin_fac} == 1:"
             ln += 1
-            code[
-                ln] = f"        imgs = f['/registration_results/reg_results/registered_xanes3D'][:, 0, :, :]"
+            code[ln] = (
+                f"        imgs = f['/registration_results/reg_results/registered_xanes3D'][:, 0, :, :]"
+            )
             ln += 1
-            code[
-                ln] = f"    else:"
+            code[ln] = f"    else:"
             ln += 1
-            code[
-                ln] = f"        imgs = zoom(f['/registration_results/reg_results/registered_xanes3D'][:, 0:{self.fit_img_bin_fac}, :, :], (1, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}))"
+            code[ln] = (
+                f"        imgs = zoom(f['/registration_results/reg_results/registered_xanes3D'][:, 0:{self.fit_img_bin_fac}, :, :], (1, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}))"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_eng_list = f['/processed_XANES3D/proc_parameters/eng_list'][:]"
+            code[ln] = (
+                f"    xanes3D_analysis_eng_list = f['/processed_XANES3D/proc_parameters/eng_list'][:]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_edge_eng = f['/processed_XANES3D/proc_parameters/edge_eng'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_edge_eng = f['/processed_XANES3D/proc_parameters/edge_eng'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_pre_edge_e = f['/processed_XANES3D/proc_parameters/pre_edge_e'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_pre_edge_e = f['/processed_XANES3D/proc_parameters/pre_edge_e'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_post_edge_s = f['/processed_XANES3D/proc_parameters/post_edge_s'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_post_edge_s = f['/processed_XANES3D/proc_parameters/post_edge_s'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_edge_jump_thres = f['/processed_XANES3D/proc_parameters/edge_jump_threshold'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_edge_jump_thres = f['/processed_XANES3D/proc_parameters/edge_jump_threshold'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_edge_offset_thres = f['/processed_XANES3D/proc_parameters/edge_offset_threshold'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_edge_offset_thres = f['/processed_XANES3D/proc_parameters/edge_offset_threshold'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_use_mask = f['/processed_XANES3D/proc_parameters/use_mask'][()].decode('utf-8')"
+            code[ln] = (
+                f"    xanes3D_analysis_use_mask = f['/processed_XANES3D/proc_parameters/use_mask'][()].decode('utf-8')"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_type = f['/processed_XANES3D/proc_parameters/analysis_type'][()].decode('utf-8')"
+            code[ln] = (
+                f"    xanes3D_analysis_type = f['/processed_XANES3D/proc_parameters/analysis_type'][()].decode('utf-8')"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_data_shape = np.int32(np.round(f['/processed_XANES3D/proc_parameters/data_shape'][:]/{self.fit_img_bin_fac}))"
+            code[ln] = (
+                f"    xanes3D_analysis_data_shape = np.int32(np.round(f['/processed_XANES3D/proc_parameters/data_shape'][:]/{self.fit_img_bin_fac}))"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_edge50_fit_s = f['/processed_XANES3D/proc_parameters/edge50_fit_s'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_edge50_fit_s = f['/processed_XANES3D/proc_parameters/edge50_fit_s'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_edge50_fit_e = f['/processed_XANES3D/proc_parameters/edge50_fit_e'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_edge50_fit_e = f['/processed_XANES3D/proc_parameters/edge50_fit_e'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_wl_fit_eng_s = f['/processed_XANES3D/proc_parameters/wl_fit_eng_s'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_wl_fit_eng_s = f['/processed_XANES3D/proc_parameters/wl_fit_eng_s'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_wl_fit_eng_e = f['/processed_XANES3D/proc_parameters/wl_fit_eng_e'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_wl_fit_eng_e = f['/processed_XANES3D/proc_parameters/wl_fit_eng_e'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_edge_fit_order = f['/processed_XANES3D/proc_parameters/pre_post_edge_norm_fit_order'][()]"
+            code[ln] = (
+                f"    xanes3D_analysis_edge_fit_order = f['/processed_XANES3D/proc_parameters/pre_post_edge_norm_fit_order'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_use_flt_spec = f['/processed_XANES3D/proc_parameters/flt_spec'][()].decode('utf-8')"
+            code[ln] = (
+                f"    xanes3D_analysis_use_flt_spec = f['/processed_XANES3D/proc_parameters/flt_spec'][()].decode('utf-8')"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_lcf_use = str2bool(f['/processed_XANES3D/proc_parameters/LCF/use_lcf'][()])"
+            code[ln] = (
+                f"    xanes3D_analysis_lcf_use = str2bool(f['/processed_XANES3D/proc_parameters/LCF/use_lcf'][()])"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_lcf_constr = str2bool(f['/processed_XANES3D/proc_parameters/LCF/use_constr'][()])"
+            code[ln] = (
+                f"    xanes3D_analysis_lcf_constr = str2bool(f['/processed_XANES3D/proc_parameters/LCF/use_constr'][()])"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes3D_analysis_lcf_ref = pd.read_hdf('{self.parent_h.xanes_save_trial_reg_filename}', '/processed_XANES3D/proc_parameters/LCF/ref')"
+            code[ln] = (
+                f"    xanes3D_analysis_lcf_ref = pd.read_hdf('{self.parent_h.xanes_save_trial_reg_filename}', '/processed_XANES3D/proc_parameters/LCF/ref')"
+            )
             ln += 1
-            code[
-                ln] = f"    xana = xa.xanes_analysis(imgs, xanes3D_analysis_eng_list, xanes3D_analysis_edge_eng, pre_ee=xanes3D_analysis_pre_edge_e, post_es=xanes3D_analysis_post_edge_s, edge_jump_threshold=xanes3D_analysis_edge_jump_thres, pre_edge_threshold=xanes3D_analysis_edge_offset_thres)"
+            code[ln] = (
+                f"    xana = xa.xanes_analysis(imgs, xanes3D_analysis_eng_list, xanes3D_analysis_edge_eng, pre_ee=xanes3D_analysis_pre_edge_e, post_es=xanes3D_analysis_post_edge_s, edge_jump_threshold=xanes3D_analysis_edge_jump_thres, pre_edge_threshold=xanes3D_analysis_edge_offset_thres)"
+            )
             ln += 1
-            code[
-                ln] = f"    xana.lcf_use = xanes3D_analysis_lcf_use"
+            code[ln] = f"    xana.lcf_use = xanes3D_analysis_lcf_use"
             ln += 1
-            code[
-                ln] = f"    xana.lcf_constr_use = xanes3D_analysis_lcf_constr"
+            code[ln] = f"    xana.lcf_constr_use = xanes3D_analysis_lcf_constr"
             ln += 1
-            code[
-                ln] = f"    xana.lcf_ref = xanes3D_analysis_lcf_ref"
+            code[ln] = f"    xana.lcf_ref = xanes3D_analysis_lcf_ref"
             ln += 1
-            code[
-                ln] = f"    if '/processed_XANES3D/proc_spectrum' in f:"
+            code[ln] = f"    if '/processed_XANES3D/proc_spectrum' in f:"
             ln += 1
-            code[
-                ln] = f"        del f['/processed_XANES3D/proc_spectrum']"
+            code[ln] = f"        del f['/processed_XANES3D/proc_spectrum']"
             ln += 1
-            code[
-                ln] = f"        g12 = f.create_group('/processed_XANES3D/proc_spectrum')"
+            code[ln] = (
+                f"        g12 = f.create_group('/processed_XANES3D/proc_spectrum')"
+            )
             ln += 1
-            code[
-                ln] = f"    else:"
+            code[ln] = f"    else:"
             ln += 1
-            code[
-                ln] = f"        g12 = f.create_group('/processed_XANES3D/proc_spectrum')"
+            code[ln] = (
+                f"        g12 = f.create_group('/processed_XANES3D/proc_spectrum')"
+            )
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"    if xanes3D_analysis_type == 'wl':"
+            code[ln] = f"    if xanes3D_analysis_type == 'wl':"
             ln += 1
-            code[
-                ln] = "        _g12 = {}"
+            code[ln] = "        _g12 = {}"
             ln += 1
-            code[
-                ln] = f"        for jj in {self.analysis_saving_items}:"
+            code[ln] = f"        for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_coef':"
+            code[ln] = f"            if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'edge_fit_coef':"
+            code[ln] = f"            elif jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj in ['pre_edge_fit_coef', 'post_edge_fit_coef']:"
+            code[ln] = (
+                f"            elif jj in ['pre_edge_fit_coef', 'post_edge_fit_coef']:"
+            )
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='pre_edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='pre_edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            else:"
+            code[ln] = f"            else:"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"        if {self.fit_img_bin_fac} == 1:"
+            code[ln] = f"        if {self.fit_img_bin_fac} == 1:"
             ln += 1
-            code[
-                ln] = f"            for ii in range(xanes3D_analysis_data_shape[1]):"
+            code[ln] = f"            for ii in range(xanes3D_analysis_data_shape[1]):"
             ln += 1
-            code[
-                ln] = f"                xana.spec[:] = f['/registration_results/reg_results/registered_xanes3D'][:, ii, :, :]"
+            code[ln] = (
+                f"                xana.spec[:] = f['/registration_results/reg_results/registered_xanes3D'][:, ii, :, :]"
+            )
             ln += 1
-            code[
-                ln] = f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            code[ln] = (
+                f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            code[ln] = (
+                f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            code[ln] = (
+                f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.cal_wgt_eng(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e)"
+            code[ln] = (
+                f"                    xana.cal_wgt_eng(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e)"
+            )
             ln += 1
-            code[
-                ln] = f"                for jj in {self.analysis_saving_items}:"
+            code[ln] = f"                for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_fit':"
+            code[ln] = f"                    if jj == 'wl_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_dir':"
+            code[ln] = f"                    if jj == 'wl_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_coef':"
+            code[ln] = f"                    if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_err':"
+            code[ln] = f"                    if jj == 'wl_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng':"
+            code[ln] = f"                    if jj == 'centroid_of_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
+            code[ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_attenuation':"
+            code[ln] = f"                    if jj == 'weighted_attenuation':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_eng':"
+            code[ln] = f"                    if jj == 'weighted_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                print(ii)"
+            code[ln] = f"                print(ii)"
             ln += 1
-            code[
-                ln] = f"        else:"
+            code[ln] = f"        else:"
             ln += 1
-            code[
-                ln] = f"            for ii in range(0, xanes3D_analysis_data_shape[1], {self.fit_img_bin_fac}):"
+            code[ln] = (
+                f"            for ii in range(0, xanes3D_analysis_data_shape[1], {self.fit_img_bin_fac}):"
+            )
             ln += 1
-            code[
-                ln] = f"                xana.spec[:] = zoom(f['/registration_results/reg_results/registered_xanes3D'][:, ii:ii+{self.fit_img_bin_fac}, :, :], (1, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}))"
+            code[ln] = (
+                f"                xana.spec[:] = zoom(f['/registration_results/reg_results/registered_xanes3D'][:, ii:ii+{self.fit_img_bin_fac}, :, :], (1, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}))"
+            )
             ln += 1
-            code[
-                ln] = f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            code[ln] = (
+                f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            code[ln] = (
+                f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            code[ln] = (
+                f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.cal_wgt_eng(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e)"
+            code[ln] = (
+                f"                    xana.cal_wgt_eng(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e)"
+            )
             ln += 1
-            code[
-                ln] = f"                for jj in {self.analysis_saving_items}:"
+            code[ln] = f"                for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_fit':"
+            code[ln] = f"                    if jj == 'wl_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_dir':"
+            code[ln] = f"                    if jj == 'wl_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_coef':"
+            code[ln] = f"                    if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_err':"
+            code[ln] = f"                    if jj == 'wl_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng':"
+            code[ln] = f"                    if jj == 'centroid_of_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
+            code[ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_attenuation':"
+            code[ln] = f"                    if jj == 'weighted_attenuation':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_eng':"
+            code[ln] = f"                    if jj == 'weighted_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                print(ii)"
+            code[ln] = f"                print(ii)"
             ln += 1
-            code[
-                ln] = f"    elif xanes3D_analysis_type == 'full':"
+            code[ln] = f"    elif xanes3D_analysis_type == 'full':"
             ln += 1
-            code[
-                ln] = "        _g12 = {}"
+            code[ln] = "        _g12 = {}"
             ln += 1
-            code[
-                ln] = f"        for jj in {self.analysis_saving_items}:"
+            code[ln] = f"        for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_coef':"
+            code[ln] = f"            if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'edge_fit_coef':"
+            code[ln] = f"            elif jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj in ['pre_edge_fit_coef', 'post_edge_fit_coef']:"
+            code[ln] = (
+                f"            elif jj in ['pre_edge_fit_coef', 'post_edge_fit_coef']:"
+            )
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='pre_edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='pre_edge_fit_coef')}, *xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'norm_spec':"
+            code[ln] = f"            elif jj == 'norm_spec':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes3D_analysis_data_shape), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes3D_analysis_data_shape), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'lcf_fit':"
+            code[ln] = f"            elif jj == 'lcf_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=([xana.lcf_ref.index.size, *xanes3D_analysis_data_shape[1:]]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=([xana.lcf_ref.index.size, *xanes3D_analysis_data_shape[1:]]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            else:"
+            code[ln] = f"            else:"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes3D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"        if {self.fit_img_bin_fac} == 1:"
+            code[ln] = f"        if {self.fit_img_bin_fac} == 1:"
             ln += 1
-            code[
-                ln] = f"            for ii in range(xanes3D_analysis_data_shape[1]):"
+            code[ln] = f"            for ii in range(xanes3D_analysis_data_shape[1]):"
             ln += 1
-            code[
-                ln] = f"                xana.spec[:] = f['/registration_results/reg_results/registered_xanes3D'][:, ii, :, :]"
+            code[ln] = (
+                f"                xana.spec[:] = f['/registration_results/reg_results/registered_xanes3D'][:, ii, :, :]"
+            )
             ln += 1
-            code[
-                ln] = f"                xana.cal_pre_edge_sd()"
+            code[ln] = f"                xana.cal_pre_edge_sd()"
             ln += 1
-            code[
-                ln] = f"                xana.cal_post_edge_sd()"
+            code[ln] = f"                xana.cal_post_edge_sd()"
             ln += 1
-            code[
-                ln] = f"                xana.cal_pre_edge_mean()"
+            code[ln] = f"                xana.cal_pre_edge_mean()"
             ln += 1
-            code[
-                ln] = f"                xana.cal_post_edge_mean()"
+            code[ln] = f"                xana.cal_post_edge_mean()"
             ln += 1
-            code[
-                ln] = f"                xana.full_spec_preprocess(xanes3D_analysis_edge_eng, order=xanes3D_analysis_edge_fit_order, save_pre_post=True)"
+            code[ln] = (
+                f"                xana.full_spec_preprocess(xanes3D_analysis_edge_eng, order=xanes3D_analysis_edge_fit_order, save_pre_post=True)"
+            )
             ln += 1
-            code[
-                ln] = f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {edge_fit_item}])):"
+            code[ln] = (
+                f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {edge_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.fit_edge(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, **{edge_params})"
+            code[ln] = (
+                f"                    xana.fit_edge(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, **{edge_params})"
+            )
             ln += 1
-            code[
-                ln] = f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            code[ln] = (
+                f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            code[ln] = (
+                f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            )
             ln += 1
-            code[
-                ln] = f"                if ('edge50_pos_fit' in {self.analysis_saving_items}):"
+            code[ln] = (
+                f"                if ('edge50_pos_fit' in {self.analysis_saving_items}):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='{edge50_optimizer}', ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='{edge50_optimizer}', ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'edge50_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'edge50_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='none', ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='none', ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if ('edge_pos_fit' in {self.analysis_saving_items}):"
+            code[ln] = (
+                f"                if ('edge_pos_fit' in {self.analysis_saving_items}):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='model',ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='model',ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'edge_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'edge_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='direct',ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='direct',ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            code[ln] = (
+                f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.cal_wgt_eng(xanes3D_analysis_pre_edge_e + xanes3D_analysis_edge_eng, xanes3D_analysis_wl_fit_eng_e)"
+            code[ln] = (
+                f"                    xana.cal_wgt_eng(xanes3D_analysis_pre_edge_e + xanes3D_analysis_edge_eng, xanes3D_analysis_wl_fit_eng_e)"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'lcf_fit' in {self.analysis_saving_items}:"
+            code[ln] = f"                if 'lcf_fit' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"                    xana.interp_ref_spec()"
+            code[ln] = f"                    xana.interp_ref_spec()"
             ln += 1
-            code[
-                ln] = f"                    xana.lcf()"
+            code[ln] = f"                    xana.lcf()"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"                for jj in {self.analysis_saving_items}:"
+            code[ln] = f"                for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_fit':"
+            code[ln] = f"                    if jj == 'wl_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_dir':"
+            code[ln] = f"                    if jj == 'wl_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_peak_height_dir':"
+            code[ln] = f"                    if jj == 'wl_peak_height_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.direct_wl_ph)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.direct_wl_ph)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng':"
+            code[ln] = f"                    if jj == 'centroid_of_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
+            code[ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_attenuation':"
+            code[ln] = f"                    if jj == 'weighted_attenuation':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_eng':"
+            code[ln] = f"                    if jj == 'weighted_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge50_pos_fit':"
+            code[ln] = f"                    if jj == 'edge50_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge50_pos_dir':"
+            code[ln] = f"                    if jj == 'edge50_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit_none)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit_none)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if (jj == 'edge_pos_fit'):"
+            code[ln] = f"                    if (jj == 'edge_pos_fit'):"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_pos_dir':"
+            code[ln] = f"                    if jj == 'edge_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge_pos_dir)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge_pos_dir)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_jump_filter':"
+            code[ln] = f"                    if jj == 'edge_jump_filter':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge_jump_mask)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge_jump_mask)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_offset_filter':"
+            code[ln] = f"                    if jj == 'edge_offset_filter':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.fitted_edge_mask)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.fitted_edge_mask)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'pre_edge_sd':"
+            code[ln] = f"                    if jj == 'pre_edge_sd':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.pre_edge_sd_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.pre_edge_sd_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'post_edge_sd':"
+            code[ln] = f"                    if jj == 'post_edge_sd':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.post_edge_sd_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.post_edge_sd_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'pre_edge_mean':"
+            code[ln] = f"                    if jj == 'pre_edge_mean':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.pre_edge_mean_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.pre_edge_mean_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'post_edge_mean':"
+            code[ln] = f"                    if jj == 'post_edge_mean':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.post_edge_mean_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.post_edge_mean_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj  == 'pre_edge_fit_coef':"
+            code[ln] = f"                    if jj  == 'pre_edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.pre_edge_fit_rlt[0].reshape(xana.pre_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.pre_edge_fit_rlt[0].reshape(xana.pre_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'post_edge_fit_coef':"
+            code[ln] = f"                    if jj == 'post_edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.post_edge_fit_rlt[0].reshape(xana.post_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.post_edge_fit_rlt[0].reshape(xana.post_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_fit_coef':"
+            code[ln] = f"                    if jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][0].reshape(xana.model['edge']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][0].reshape(xana.model['edge']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_fit_err':"
+            code[ln] = f"                    if jj == 'edge_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_coef':"
+            code[ln] = f"                    if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_err':"
+            code[ln] = f"                    if jj == 'wl_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'norm_spec':"
+            code[ln] = f"                    if jj == 'norm_spec':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:, ii, :, :] = np.float32(xana.norm_spec)[:]"
+            code[ln] = (
+                f"                        _g12[jj][:, ii, :, :] = np.float32(xana.norm_spec)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'lcf_fit':"
+            code[ln] = f"                    if jj == 'lcf_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.lcf_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.lcf_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'lcf_fit_err':"
+            code[ln] = f"                    if jj == 'lcf_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.lcf_fit_err)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.lcf_fit_err)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                print(ii)"
+            code[ln] = f"                print(ii)"
             ln += 1
-            code[
-                ln] = f"        else:"
+            code[ln] = f"        else:"
             ln += 1
-            code[
-                ln] = f"            for ii in range(0, xanes3D_analysis_data_shape[1], {self.fit_img_bin_fac}):"
+            code[ln] = (
+                f"            for ii in range(0, xanes3D_analysis_data_shape[1], {self.fit_img_bin_fac}):"
+            )
             ln += 1
-            code[
-                ln] = f"                xana.spec[:] = zoom(f['/registration_results/reg_results/registered_xanes3D'][:, ii:ii+{self.fit_img_bin_fac}, :, :], (1, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}))"
+            code[ln] = (
+                f"                xana.spec[:] = zoom(f['/registration_results/reg_results/registered_xanes3D'][:, ii:ii+{self.fit_img_bin_fac}, :, :], (1, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}, 1/{self.fit_img_bin_fac}))"
+            )
             ln += 1
-            code[
-                ln] = f"                xana.cal_pre_edge_sd()"
+            code[ln] = f"                xana.cal_pre_edge_sd()"
             ln += 1
-            code[
-                ln] = f"                xana.cal_post_edge_sd()"
+            code[ln] = f"                xana.cal_post_edge_sd()"
             ln += 1
-            code[
-                ln] = f"                xana.cal_pre_edge_mean()"
+            code[ln] = f"                xana.cal_pre_edge_mean()"
             ln += 1
-            code[
-                ln] = f"                xana.cal_post_edge_mean()"
+            code[ln] = f"                xana.cal_post_edge_mean()"
             ln += 1
-            code[
-                ln] = f"                xana.full_spec_preprocess(xanes3D_analysis_edge_eng, order=xanes3D_analysis_edge_fit_order, save_pre_post=True)"
+            code[ln] = (
+                f"                xana.full_spec_preprocess(xanes3D_analysis_edge_eng, order=xanes3D_analysis_edge_fit_order, save_pre_post=True)"
+            )
             ln += 1
-            code[
-                ln] = f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {edge_fit_item}])):"
+            code[ln] = (
+                f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {edge_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.fit_edge(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, **{edge_params})"
+            code[ln] = (
+                f"                    xana.fit_edge(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, **{edge_params})"
+            )
             ln += 1
-            code[
-                ln] = f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            code[ln] = (
+                f"                if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            code[ln] = (
+                f"                    xana.fit_edge(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, **{wl_params})"
+            )
             ln += 1
-            code[
-                ln] = f"                if ('edge50_pos_fit' in {self.analysis_saving_items}):"
+            code[ln] = (
+                f"                if ('edge50_pos_fit' in {self.analysis_saving_items}):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='{edge50_optimizer}', ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='{edge50_optimizer}', ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if ('edge50_pos_dir' in {self.analysis_saving_items}):"
+            code[ln] = (
+                f"                if ('edge50_pos_dir' in {self.analysis_saving_items}):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='none', ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_50(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='none', ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if ('edge_pos_fit' in {self.analysis_saving_items}):"
+            code[ln] = (
+                f"                if ('edge_pos_fit' in {self.analysis_saving_items}):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='model',ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='model',ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'edge_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'edge_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='direct',ufac={edge_ufac})"
+            code[ln] = (
+                f"                    xana.find_edge_deriv(xanes3D_analysis_edge50_fit_s, xanes3D_analysis_edge50_fit_e, optimizer='direct',ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = (
+                f"                if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            code[ln] = (
+                f"                    xana.find_wl(xanes3D_analysis_wl_fit_eng_s, xanes3D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            code[ln] = (
+                f"                if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            )
             ln += 1
-            code[
-                ln] = f"                    xana.cal_wgt_eng(xanes3D_analysis_pre_edge_e + xanes3D_analysis_edge_eng, xanes3D_analysis_wl_fit_eng_e)"
+            code[ln] = (
+                f"                    xana.cal_wgt_eng(xanes3D_analysis_pre_edge_e + xanes3D_analysis_edge_eng, xanes3D_analysis_wl_fit_eng_e)"
+            )
             ln += 1
-            code[
-                ln] = f"                if 'lcf_fit' in {self.analysis_saving_items}:"
+            code[ln] = f"                if 'lcf_fit' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"                    xana.interp_ref_spec()"
+            code[ln] = f"                    xana.interp_ref_spec()"
             ln += 1
-            code[
-                ln] = f"                    xana.lcf()"
+            code[ln] = f"                    xana.lcf()"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"                for jj in {self.analysis_saving_items}:"
+            code[ln] = f"                for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_fit':"
+            code[ln] = f"                    if jj == 'wl_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_pos_dir':"
+            code[ln] = f"                    if jj == 'wl_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.wl_pos_dir)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_peak_height_dir':"
+            code[ln] = f"                    if jj == 'wl_peak_height_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.direct_wl_ph)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.direct_wl_ph)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng':"
+            code[ln] = f"                    if jj == 'centroid_of_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
+            code[ln] = f"                    if jj == 'centroid_of_eng_relative_to_wl':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_attenuation':"
+            code[ln] = f"                    if jj == 'weighted_attenuation':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_atten)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'weighted_eng':"
+            code[ln] = f"                    if jj == 'weighted_eng':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.weighted_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge50_pos_fit':"
+            code[ln] = f"                    if jj == 'edge50_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge50_pos_dir':"
+            code[ln] = f"                    if jj == 'edge50_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit_none)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge50_pos_fit_none)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if (jj == 'edge_pos_fit'):"
+            code[ln] = f"                    if (jj == 'edge_pos_fit'):"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge_pos_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_pos_dir':"
+            code[ln] = f"                    if jj == 'edge_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge_pos_dir)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge_pos_dir)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_jump_filter':"
+            code[ln] = f"                    if jj == 'edge_jump_filter':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.edge_jump_mask)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.edge_jump_mask)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_offset_filter':"
+            code[ln] = f"                    if jj == 'edge_offset_filter':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.fitted_edge_mask)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.fitted_edge_mask)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'pre_edge_sd':"
+            code[ln] = f"                    if jj == 'pre_edge_sd':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.pre_edge_sd_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.pre_edge_sd_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'post_edge_sd':"
+            code[ln] = f"                    if jj == 'post_edge_sd':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.post_edge_sd_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.post_edge_sd_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'pre_edge_mean':"
+            code[ln] = f"                    if jj == 'pre_edge_mean':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.pre_edge_mean_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.pre_edge_mean_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'post_edge_mean':"
+            code[ln] = f"                    if jj == 'post_edge_mean':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.post_edge_mean_map)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.post_edge_mean_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj  == 'pre_edge_fit_coef':"
+            code[ln] = f"                    if jj  == 'pre_edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.pre_edge_fit_rlt[0].reshape(xana.pre_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.pre_edge_fit_rlt[0].reshape(xana.pre_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'post_edge_fit_coef':"
+            code[ln] = f"                    if jj == 'post_edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.post_edge_fit_rlt[0].reshape(xana.post_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.post_edge_fit_rlt[0].reshape(xana.post_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_fit_coef':"
+            code[ln] = f"                    if jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][0].reshape(xana.model['edge']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][0].reshape(xana.model['edge']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'edge_fit_err':"
+            code[ln] = f"                    if jj == 'edge_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_coef':"
+            code[ln] = f"                    if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'wl_fit_err':"
+            code[ln] = f"                    if jj == 'wl_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                        _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'norm_spec':"
+            code[ln] = f"                    if jj == 'norm_spec':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][:, ii, :, :] = np.float32(xana.norm_spec)[:]"
+            code[ln] = (
+                f"                        _g12[jj][:, ii, :, :] = np.float32(xana.norm_spec)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'lcf_fit':"
+            code[ln] = f"                    if jj == 'lcf_fit':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.lcf_fit)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.lcf_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                    if jj == 'lcf_fit_err':"
+            code[ln] = f"                    if jj == 'lcf_fit_err':"
             ln += 1
-            code[
-                ln] = f"                        _g12[jj][ii] = np.float32(xana.lcf_fit_err)[:]"
+            code[ln] = (
+                f"                        _g12[jj][ii] = np.float32(xana.lcf_fit_err)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"                print(ii)"
+            code[ln] = f"                print(ii)"
             ln += 1
-            code[
-                ln] = f"print('xanes3D analysis is done!')"
+            code[ln] = f"print('xanes3D analysis is done!')"
             ln += 1
 
-            gen_external_py_script(
-                self.parent_h.xanes_fit_external_command_name, code)
-            sig = os.system(
-                f'python {self.parent_h.xanes_fit_external_command_name}')
+            gen_external_py_script(self.parent_h.xanes_fit_external_command_name, code)
+            sig = os.system(f"python {self.parent_h.xanes_fit_external_command_name}")
             if sig == 0:
-                self.hs['FitRun text'].value = 'XANES3D analysis is done ...'
+                self.hs["FitRun text"].value = "XANES3D analysis is done ..."
             else:
-                self.hs[
-                    'FitRun text'].value = 'something wrong in analysis ...'
+                self.hs["FitRun text"].value = "something wrong in analysis ..."
             self.parent_h.update_xanes3D_config()
-        elif self.parent_h.gui_name == 'xanes2D':
-            with h5py.File(self.parent_h.xanes_save_trial_reg_filename,
-                           'r+') as f:
-                if 'processed_XANES2D' not in f:
-                    g1 = f.create_group('processed_XANES2D')
+        elif self.parent_h.gui_name == "xanes2D":
+            with h5py.File(self.parent_h.xanes_save_trial_reg_filename, "r+") as f:
+                if "processed_XANES2D" not in f:
+                    g1 = f.create_group("processed_XANES2D")
                 else:
-                    del f['processed_XANES2D']
-                    g1 = f.create_group('processed_XANES2D')
-                g11 = g1.create_group('proc_parameters')
-                g11.create_dataset('eng_list',
-                                   data=self.parent_h.xanes_fit_eng_list)
-                g11.create_dataset('edge_eng',
-                                   data=self.parent_h.xanes_fit_edge_eng)
-                g11.create_dataset('pre_edge_e',
-                                   data=self.parent_h.xanes_fit_pre_edge_e)
-                g11.create_dataset('post_edge_s',
-                                   data=self.parent_h.xanes_fit_post_edge_s)
+                    del f["processed_XANES2D"]
+                    g1 = f.create_group("processed_XANES2D")
+                g11 = g1.create_group("proc_parameters")
+                g11.create_dataset("eng_list", data=self.parent_h.xanes_fit_eng_list)
+                g11.create_dataset("edge_eng", data=self.parent_h.xanes_fit_edge_eng)
                 g11.create_dataset(
-                    'edge_jump_threshold',
-                    data=self.parent_h.xanes_fit_edge_jump_thres)
+                    "pre_edge_e", data=self.parent_h.xanes_fit_pre_edge_e
+                )
                 g11.create_dataset(
-                    'edge_offset_threshold',
-                    data=self.parent_h.xanes_fit_edge_offset_thres)
-                g11.create_dataset('use_mask',
-                                   data=str(self.parent_h.xanes_fit_use_mask))
-                g11.create_dataset('analysis_type',
-                                   data=self.parent_h.xanes_fit_type)
-                g11.create_dataset('data_shape',
-                                   data=self.parent_h.xanes_fit_data_shape)
-                g11.create_dataset('edge50_fit_s',
-                                   data=self.parent_h.xanes_fit_edge_0p5_fit_s)
-                g11.create_dataset('edge50_fit_e',
-                                   data=self.parent_h.xanes_fit_edge_0p5_fit_e)
-                g11.create_dataset('wl_fit_eng_s',
-                                   data=self.parent_h.xanes_fit_wl_fit_eng_s)
-                g11.create_dataset('wl_fit_eng_e',
-                                   data=self.parent_h.xanes_fit_wl_fit_eng_e)
-                g11.create_dataset('pre_post_edge_norm_fit_order', data=1)
-                g11.create_dataset('flt_spec', data=str(self.fit_use_flt_spec))
-                g11.create_dataset('bin_fact', data=int(self.fit_img_bin_fac))
+                    "post_edge_s", data=self.parent_h.xanes_fit_post_edge_s
+                )
+                g11.create_dataset(
+                    "edge_jump_threshold", data=self.parent_h.xanes_fit_edge_jump_thres
+                )
+                g11.create_dataset(
+                    "edge_offset_threshold",
+                    data=self.parent_h.xanes_fit_edge_offset_thres,
+                )
+                g11.create_dataset(
+                    "use_mask", data=str(self.parent_h.xanes_fit_use_mask)
+                )
+                g11.create_dataset("analysis_type", data=self.parent_h.xanes_fit_type)
+                g11.create_dataset(
+                    "data_shape", data=self.parent_h.xanes_fit_data_shape
+                )
+                g11.create_dataset(
+                    "edge50_fit_s", data=self.parent_h.xanes_fit_edge_0p5_fit_s
+                )
+                g11.create_dataset(
+                    "edge50_fit_e", data=self.parent_h.xanes_fit_edge_0p5_fit_e
+                )
+                g11.create_dataset(
+                    "wl_fit_eng_s", data=self.parent_h.xanes_fit_wl_fit_eng_s
+                )
+                g11.create_dataset(
+                    "wl_fit_eng_e", data=self.parent_h.xanes_fit_wl_fit_eng_e
+                )
+                g11.create_dataset("pre_post_edge_norm_fit_order", data=1)
+                g11.create_dataset("flt_spec", data=str(self.fit_use_flt_spec))
+                g11.create_dataset("bin_fact", data=int(self.fit_img_bin_fac))
 
-                g111 = g11.create_group('wl_fit method')
+                g111 = g11.create_group("wl_fit method")
                 if self.fit_wl_pos:
-                    g111.create_dataset('optimizer',
-                                        data=str(self.fit_wl_optimizer))
-                    if self.fit_wl_optimizer == 'scipy':
-                        g111.create_dataset('method',
-                                            data=str(self.fit_wl_fit_func))
-                        g1111 = g111.create_group('params')
-                        g1111.create_dataset('jac', data=str(wl_params['jac']))
-                        g1111.create_dataset('method',
-                                             data=str(wl_params['method']))
-                        g1111.create_dataset('ftol', data=wl_params['ftol'])
-                        g1111.create_dataset('xtol', data=wl_params['xtol'])
-                        g1111.create_dataset('gtol', data=wl_params['gtol'])
-                        g1111.create_dataset('fvars_init', data=wl_fvars)
+                    g111.create_dataset("optimizer", data=str(self.fit_wl_optimizer))
+                    if self.fit_wl_optimizer == "scipy":
+                        g111.create_dataset("method", data=str(self.fit_wl_fit_func))
+                        g1111 = g111.create_group("params")
+                        g1111.create_dataset("jac", data=str(wl_params["jac"]))
+                        g1111.create_dataset("method", data=str(wl_params["method"]))
+                        g1111.create_dataset("ftol", data=wl_params["ftol"])
+                        g1111.create_dataset("xtol", data=wl_params["xtol"])
+                        g1111.create_dataset("gtol", data=wl_params["gtol"])
+                        g1111.create_dataset("fvars_init", data=wl_fvars)
                         if wl_bnds[0] is -inf:
-                            g1111.create_dataset('bnds', data=str('None'))
+                            g1111.create_dataset("bnds", data=str("None"))
                         else:
-                            g1111.create_dataset('bnds', data=wl_bnds)
+                            g1111.create_dataset("bnds", data=wl_bnds)
                     else:
-                        g111.create_dataset('method', data=str('polynimial'))
-                        g1111 = g111.create_group('params')
-                        g1111.create_dataset('order', data=wl_order)
+                        g111.create_dataset("method", data=str("polynimial"))
+                        g1111 = g111.create_group("params")
+                        g1111.create_dataset("order", data=wl_order)
 
-                g112 = g11.create_group('edge_fit method')
+                g112 = g11.create_group("edge_fit method")
                 if self.fit_edge50_pos:
-                    g112.create_dataset('optimizer',
-                                        data=str(self.fit_edge_optimizer))
-                    if self.fit_edge_optimizer == 'scipy':
-                        g112.create_dataset('method',
-                                            data=str(self.fit_edge_fit_func))
-                        g1121 = g112.create_group('params')
-                        g1121.create_dataset('jac',
-                                             data=str(edge_params['jac']))
-                        g1121.create_dataset('method',
-                                             data=str(edge_params['method']))
-                        g1121.create_dataset('ftol', data=edge_params['ftol'])
-                        g1121.create_dataset('xtol', data=edge_params['xtol'])
-                        g1121.create_dataset('gtol', data=edge_params['gtol'])
-                        g1121.create_dataset('fvars_init', data=edge_fvars)
+                    g112.create_dataset("optimizer", data=str(self.fit_edge_optimizer))
+                    if self.fit_edge_optimizer == "scipy":
+                        g112.create_dataset("method", data=str(self.fit_edge_fit_func))
+                        g1121 = g112.create_group("params")
+                        g1121.create_dataset("jac", data=str(edge_params["jac"]))
+                        g1121.create_dataset("method", data=str(edge_params["method"]))
+                        g1121.create_dataset("ftol", data=edge_params["ftol"])
+                        g1121.create_dataset("xtol", data=edge_params["xtol"])
+                        g1121.create_dataset("gtol", data=edge_params["gtol"])
+                        g1121.create_dataset("fvars_init", data=edge_fvars)
                         if edge_bnds[0] is -inf:
-                            g1121.create_dataset('bnds', data=str('None'))
+                            g1121.create_dataset("bnds", data=str("None"))
                         else:
-                            g1121.create_dataset('bnds', data=edge_bnds)
+                            g1121.create_dataset("bnds", data=edge_bnds)
                     else:
-                        g112.create_dataset('method', data=str('polynimial'))
-                        g1121 = g112.create_group('params')
-                        g1121.create_dataset('order', data=edge_order)
-                g113 = g11.create_group('LCF')
-                g113.create_dataset('use_lcf', data=str(self.fit_lcf))
-                g113.create_dataset('use_constr',
-                                    data=str(self.fit_lcf_constr))
+                        g112.create_dataset("method", data=str("polynimial"))
+                        g1121 = g112.create_group("params")
+                        g1121.create_dataset("order", data=edge_order)
+                g113 = g11.create_group("LCF")
+                g113.create_dataset("use_lcf", data=str(self.fit_lcf))
+                g113.create_dataset("use_constr", data=str(self.fit_lcf_constr))
             self.fit_lcf_ref_spec.to_hdf(
                 self.parent_h.xanes_save_trial_reg_filename,
-                '/processed_XANES2D/proc_parameters/LCF/ref',
-                mode='a')
+                "/processed_XANES2D/proc_parameters/LCF/ref",
+                mode="a",
+            )
             code = {}
             ln = 0
-            code[
-                ln] = f"import os, h5py"
+            code[ln] = f"import os, h5py"
             ln += 1
-            code[
-                ln] = f"import numpy as np"
+            code[ln] = f"import numpy as np"
             ln += 1
-            code[
-                ln] = f"import pandas as pd"
+            code[ln] = f"import pandas as pd"
             ln += 1
-            code[
-                ln] = f"from scipy.ndimage import zoom"
+            code[ln] = f"from scipy.ndimage import zoom"
             ln += 1
-            code[
-                ln] = f"import TXM_Sandbox.utils.xanes_math as xm"
+            code[ln] = f"import TXM_Sandbox.utils.xanes_math as xm"
             ln += 1
-            code[
-                ln] = f"import TXM_Sandbox.utils.xanes_analysis as xa"
+            code[ln] = f"import TXM_Sandbox.utils.xanes_analysis as xa"
             ln += 1
-            code[
-                ln] = f"from TXM_Sandbox.utils.misc import str2bool"
+            code[ln] = f"from TXM_Sandbox.utils.misc import str2bool"
             ln += 1
-            code[
-                ln] = f"from copy import deepcopy"
+            code[ln] = f"from copy import deepcopy"
             ln += 1
-            code[
-                ln] = f"inf = np.inf"
+            code[ln] = f"inf = np.inf"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"with h5py.File('{self.parent_h.xanes_save_trial_reg_filename}', 'r+') as f:"
+            code[ln] = (
+                f"with h5py.File('{self.parent_h.xanes_save_trial_reg_filename}', 'r+') as f:"
+            )
             ln += 1
-            code[
-                ln] = f"    if {self.fit_img_bin_fac} == 1:"
+            code[ln] = f"    if {self.fit_img_bin_fac} == 1:"
             ln += 1
-            code[
-                ln] = f"        imgs = f['/registration_results/reg_results/registered_xanes2D'][:]"
+            code[ln] = (
+                f"        imgs = f['/registration_results/reg_results/registered_xanes2D'][:]"
+            )
             ln += 1
-            code[
-                ln] = f"    else:"
+            code[ln] = f"    else:"
             ln += 1
-            code[
-                ln] = f"        imgs = zoom(f['/registration_results/reg_results/registered_xanes2D'][:], (1, {1/self.fit_img_bin_fac}, {1/self.fit_img_bin_fac}))"
+            code[ln] = (
+                f"        imgs = zoom(f['/registration_results/reg_results/registered_xanes2D'][:], (1, {1/self.fit_img_bin_fac}, {1/self.fit_img_bin_fac}))"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_eng_list = f['/processed_XANES2D/proc_parameters/eng_list'][:]"
+            code[ln] = (
+                f"    xanes2D_analysis_eng_list = f['/processed_XANES2D/proc_parameters/eng_list'][:]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_edge_eng = f['/processed_XANES2D/proc_parameters/edge_eng'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_edge_eng = f['/processed_XANES2D/proc_parameters/edge_eng'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_pre_edge_e = f['/processed_XANES2D/proc_parameters/pre_edge_e'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_pre_edge_e = f['/processed_XANES2D/proc_parameters/pre_edge_e'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_post_edge_s = f['/processed_XANES2D/proc_parameters/post_edge_s'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_post_edge_s = f['/processed_XANES2D/proc_parameters/post_edge_s'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_edge_jump_thres = f['/processed_XANES2D/proc_parameters/edge_jump_threshold'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_edge_jump_thres = f['/processed_XANES2D/proc_parameters/edge_jump_threshold'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_edge_offset_thres = f['/processed_XANES2D/proc_parameters/edge_offset_threshold'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_edge_offset_thres = f['/processed_XANES2D/proc_parameters/edge_offset_threshold'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_use_mask = f['/processed_XANES2D/proc_parameters/use_mask'][()].decode('utf-8')"
+            code[ln] = (
+                f"    xanes2D_analysis_use_mask = f['/processed_XANES2D/proc_parameters/use_mask'][()].decode('utf-8')"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_type = f['/processed_XANES2D/proc_parameters/analysis_type'][()].decode('utf-8')"
+            code[ln] = (
+                f"    xanes2D_analysis_type = f['/processed_XANES2D/proc_parameters/analysis_type'][()].decode('utf-8')"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_data_shape = imgs.shape"
+            code[ln] = f"    xanes2D_analysis_data_shape = imgs.shape"
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_edge50_fit_s = f['/processed_XANES2D/proc_parameters/edge50_fit_s'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_edge50_fit_s = f['/processed_XANES2D/proc_parameters/edge50_fit_s'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_edge50_fit_e = f['/processed_XANES2D/proc_parameters/edge50_fit_e'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_edge50_fit_e = f['/processed_XANES2D/proc_parameters/edge50_fit_e'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_wl_fit_eng_s = f['/processed_XANES2D/proc_parameters/wl_fit_eng_s'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_wl_fit_eng_s = f['/processed_XANES2D/proc_parameters/wl_fit_eng_s'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_wl_fit_eng_e = f['/processed_XANES2D/proc_parameters/wl_fit_eng_e'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_wl_fit_eng_e = f['/processed_XANES2D/proc_parameters/wl_fit_eng_e'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_use_flt_spec = f['/processed_XANES2D/proc_parameters/flt_spec'][()].decode('utf-8')"
+            code[ln] = (
+                f"    xanes2D_analysis_use_flt_spec = f['/processed_XANES2D/proc_parameters/flt_spec'][()].decode('utf-8')"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_edge_fit_order = f['/processed_XANES2D/proc_parameters/pre_post_edge_norm_fit_order'][()]"
+            code[ln] = (
+                f"    xanes2D_analysis_edge_fit_order = f['/processed_XANES2D/proc_parameters/pre_post_edge_norm_fit_order'][()]"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_lcf_use = str2bool(f['/processed_XANES2D/proc_parameters/LCF/use_lcf'][()])"
+            code[ln] = (
+                f"    xanes2D_analysis_lcf_use = str2bool(f['/processed_XANES2D/proc_parameters/LCF/use_lcf'][()])"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_lcf_constr = str2bool(f['/processed_XANES2D/proc_parameters/LCF/use_constr'][()])"
+            code[ln] = (
+                f"    xanes2D_analysis_lcf_constr = str2bool(f['/processed_XANES2D/proc_parameters/LCF/use_constr'][()])"
+            )
             ln += 1
-            code[
-                ln] = f"    xanes2D_analysis_lcf_ref = pd.read_hdf('{self.parent_h.xanes_save_trial_reg_filename}', '/processed_XANES2D/proc_parameters/LCF/ref')"
+            code[ln] = (
+                f"    xanes2D_analysis_lcf_ref = pd.read_hdf('{self.parent_h.xanes_save_trial_reg_filename}', '/processed_XANES2D/proc_parameters/LCF/ref')"
+            )
             ln += 1
-            code[
-                ln] = f"    xana = xa.xanes_analysis(imgs, xanes2D_analysis_eng_list, xanes2D_analysis_edge_eng, pre_ee=xanes2D_analysis_pre_edge_e, post_es=xanes2D_analysis_post_edge_s, edge_jump_threshold=xanes2D_analysis_edge_jump_thres, pre_edge_threshold=xanes2D_analysis_edge_offset_thres)"
+            code[ln] = (
+                f"    xana = xa.xanes_analysis(imgs, xanes2D_analysis_eng_list, xanes2D_analysis_edge_eng, pre_ee=xanes2D_analysis_pre_edge_e, post_es=xanes2D_analysis_post_edge_s, edge_jump_threshold=xanes2D_analysis_edge_jump_thres, pre_edge_threshold=xanes2D_analysis_edge_offset_thres)"
+            )
             ln += 1
-            code[
-                ln] = f"    xana.lcf_use = xanes2D_analysis_lcf_use"
+            code[ln] = f"    xana.lcf_use = xanes2D_analysis_lcf_use"
             ln += 1
-            code[
-                ln] = f"    xana.lcf_constr_use = xanes2D_analysis_lcf_constr"
+            code[ln] = f"    xana.lcf_constr_use = xanes2D_analysis_lcf_constr"
             ln += 1
-            code[
-                ln] = f"    xana.lcf_ref = xanes2D_analysis_lcf_ref"
+            code[ln] = f"    xana.lcf_ref = xanes2D_analysis_lcf_ref"
             ln += 1
-            code[
-                ln] = f"    if '/processed_XANES2D/proc_spectrum' in f:"
+            code[ln] = f"    if '/processed_XANES2D/proc_spectrum' in f:"
             ln += 1
-            code[
-                ln] = f"        del f['/processed_XANES2D/proc_spectrum']"
+            code[ln] = f"        del f['/processed_XANES2D/proc_spectrum']"
             ln += 1
-            code[
-                ln] = f"        g12 = f.create_group('/processed_XANES2D/proc_spectrum')"
+            code[ln] = (
+                f"        g12 = f.create_group('/processed_XANES2D/proc_spectrum')"
+            )
             ln += 1
-            code[
-                ln] = f"    else:"
+            code[ln] = f"    else:"
             ln += 1
-            code[
-                ln] = f"        g12 = f.create_group('/processed_XANES2D/proc_spectrum')"
+            code[ln] = (
+                f"        g12 = f.create_group('/processed_XANES2D/proc_spectrum')"
+            )
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"    if xanes2D_analysis_type == 'wl':"
+            code[ln] = f"    if xanes2D_analysis_type == 'wl':"
             ln += 1
-            code[
-                ln] = "        _g12 = {}"
+            code[ln] = "        _g12 = {}"
             ln += 1
-            code[
-                ln] = f"        for jj in {self.analysis_saving_items}:"
+            code[ln] = f"        for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_coef':"
+            code[ln] = f"            if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'edge_fit_coef':"
+            code[ln] = f"            elif jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            else:"
+            code[ln] = f"            else:"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"        if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            code[ln] = (
+                f"        if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"            xana.fit_edge(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, **{wl_params})"
+            code[ln] = (
+                f"            xana.fit_edge(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, **{wl_params})"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'wl_pos_fit' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            code[ln] = (
+                f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'wl_pos_dir' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            code[ln] = (
+                f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            code[ln] = (
+                f"        if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            )
             ln += 1
-            code[
-                ln] = f"            xana.cal_wgt_eng(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e)"
+            code[ln] = (
+                f"            xana.cal_wgt_eng(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e)"
+            )
             ln += 1
-            code[
-                ln] = f"        for jj in {self.analysis_saving_items}:"
+            code[ln] = f"        for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_pos_fit':"
+            code[ln] = f"            if jj == 'wl_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_fit)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_fit)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_pos_dir':"
+            code[ln] = f"            if jj == 'wl_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_dir)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_dir)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_coef':"
+            code[ln] = f"            if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_err':"
+            code[ln] = f"            if jj == 'wl_fit_err':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'centroid_of_eng':"
+            code[ln] = f"            if jj == 'centroid_of_eng':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.centroid_of_eng)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.centroid_of_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'centroid_of_eng_relative_to_wl':"
+            code[ln] = f"            if jj == 'centroid_of_eng_relative_to_wl':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'weighted_attenuation':"
+            code[ln] = f"            if jj == 'weighted_attenuation':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.weighted_atten)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.weighted_atten)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'weighted_eng':"
+            code[ln] = f"            if jj == 'weighted_eng':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.weighted_eng)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.weighted_eng)[:]"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"    elif xanes2D_analysis_type == 'full':"
+            code[ln] = f"    elif xanes2D_analysis_type == 'full':"
             ln += 1
-            code[
-                ln] = "        _g12 = {}"
+            code[ln] = "        _g12 = {}"
             ln += 1
-            code[
-                ln] = f"        for jj in {self.analysis_saving_items}:"
+            code[ln] = f"        for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_coef':"
+            code[ln] = f"            if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='wl_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'edge_fit_coef':"
+            code[ln] = f"            elif jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='edge_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj in ['pre_edge_fit_coef', 'post_edge_fit_coef']:"
+            code[ln] = (
+                f"            elif jj in ['pre_edge_fit_coef', 'post_edge_fit_coef']:"
+            )
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='pre_edge_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=({self.fit_coef_num(ftype='pre_edge_fit_coef')}, *xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'norm_spec':"
+            code[ln] = f"            elif jj == 'norm_spec':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes2D_analysis_data_shape), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes2D_analysis_data_shape), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            elif jj == 'lcf_fit':"
+            code[ln] = f"            elif jj == 'lcf_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=([xana.lcf_ref.index.size, *xanes2D_analysis_data_shape[1:]]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=([xana.lcf_ref.index.size, *xanes2D_analysis_data_shape[1:]]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"            else:"
+            code[ln] = f"            else:"
             ln += 1
-            code[
-                ln] = f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            code[ln] = (
+                f"                _g12[jj] = g12.create_dataset(jj, shape=(xanes2D_analysis_data_shape[1:]), dtype=np.float32)"
+            )
             ln += 1
-            code[
-                ln] = f"        xana.cal_pre_edge_sd()"
+            code[ln] = f"        xana.cal_pre_edge_sd()"
             ln += 1
-            code[
-                ln] = f"        xana.cal_post_edge_sd()"
+            code[ln] = f"        xana.cal_post_edge_sd()"
             ln += 1
-            code[
-                ln] = f"        xana.cal_pre_edge_mean()"
+            code[ln] = f"        xana.cal_pre_edge_mean()"
             ln += 1
-            code[
-                ln] = f"        xana.cal_post_edge_mean()"
+            code[ln] = f"        xana.cal_post_edge_mean()"
             ln += 1
-            code[
-                ln] = f"        xana.full_spec_preprocess(xanes2D_analysis_edge_eng, order=xanes2D_analysis_edge_fit_order, save_pre_post=True)"
+            code[ln] = (
+                f"        xana.full_spec_preprocess(xanes2D_analysis_edge_eng, order=xanes2D_analysis_edge_fit_order, save_pre_post=True)"
+            )
             ln += 1
-            code[
-                ln] = f"        if np.any(np.array([ii in {self.analysis_saving_items} for ii in {edge_fit_item}])):"
+            code[ln] = (
+                f"        if np.any(np.array([ii in {self.analysis_saving_items} for ii in {edge_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"            xana.fit_edge(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, **{edge_params})"
+            code[ln] = (
+                f"            xana.fit_edge(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, **{edge_params})"
+            )
             ln += 1
-            code[
-                ln] = f"        if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            code[ln] = (
+                f"        if np.any(np.array([ii in {self.analysis_saving_items} for ii in {wl_fit_item}])):"
+            )
             ln += 1
-            code[
-                ln] = f"            xana.fit_edge(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, **{wl_params})"
+            code[ln] = (
+                f"            xana.fit_edge(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, **{wl_params})"
+            )
             ln += 1
-            code[
-                ln] = f"        if ('edge50_pos_fit' in {self.analysis_saving_items}):"
+            code[ln] = f"        if ('edge50_pos_fit' in {self.analysis_saving_items}):"
             ln += 1
-            code[
-                ln] = f"            xana.find_edge_50(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='{edge50_optimizer}', ufac={edge_ufac})"
+            code[ln] = (
+                f"            xana.find_edge_50(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='{edge50_optimizer}', ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'edge50_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'edge50_pos_dir' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.find_edge_50(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='none', ufac={edge_ufac})"
+            code[ln] = (
+                f"            xana.find_edge_50(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='none', ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if ('edge_pos_fit' in {self.analysis_saving_items}):"
+            code[ln] = f"        if ('edge_pos_fit' in {self.analysis_saving_items}):"
             ln += 1
-            code[
-                ln] = f"            xana.find_edge_deriv(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, optimizer='model',ufac={edge_ufac})"
+            code[ln] = (
+                f"            xana.find_edge_deriv(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, optimizer='model',ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'edge_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'edge_pos_dir' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.find_edge_deriv(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, optimizer='direct',ufac={edge_ufac})"
+            code[ln] = (
+                f"            xana.find_edge_deriv(xanes2D_analysis_edge50_fit_s, xanes2D_analysis_edge50_fit_e, optimizer='direct',ufac={edge_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'wl_pos_fit' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'wl_pos_fit' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            code[ln] = (
+                f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='model',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'wl_pos_dir' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'wl_pos_dir' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            code[ln] = (
+                f"            xana.find_wl(xanes2D_analysis_wl_fit_eng_s, xanes2D_analysis_wl_fit_eng_e, optimizer='direct',ufac={wl_ufac})"
+            )
             ln += 1
-            code[
-                ln] = f"        if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            code[ln] = (
+                f"        if any([ii in {self.analysis_saving_items} for ii in ['centroid_of_eng', 'centroid_of_eng_relative_to_wl', 'weighted_attenuation', 'weighted_eng']]):"
+            )
             ln += 1
-            code[
-                ln] = f"            xana.cal_wgt_eng(xanes2D_analysis_pre_edge_e + xanes2D_analysis_edge_eng, xanes2D_analysis_wl_fit_eng_e)"
+            code[ln] = (
+                f"            xana.cal_wgt_eng(xanes2D_analysis_pre_edge_e + xanes2D_analysis_edge_eng, xanes2D_analysis_wl_fit_eng_e)"
+            )
             ln += 1
-            code[
-                ln] = f"        if 'lcf_fit' in {self.analysis_saving_items}:"
+            code[ln] = f"        if 'lcf_fit' in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            xana.interp_ref_spec()"
+            code[ln] = f"            xana.interp_ref_spec()"
             ln += 1
-            code[
-                ln] = f"            xana.lcf()"
+            code[ln] = f"            xana.lcf()"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
-            code[
-                ln] = f"        for jj in {self.analysis_saving_items}:"
+            code[ln] = f"        for jj in {self.analysis_saving_items}:"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_pos_fit':"
+            code[ln] = f"            if jj == 'wl_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_fit)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_fit)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_pos_dir':"
+            code[ln] = f"            if jj == 'wl_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_dir)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.wl_pos_dir)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_peak_height_dir':"
+            code[ln] = f"            if jj == 'wl_peak_height_dir':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.direct_wl_ph)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.direct_wl_ph)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'centroid_of_eng':"
+            code[ln] = f"            if jj == 'centroid_of_eng':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.centroid_of_eng)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.centroid_of_eng)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'centroid_of_eng_relative_to_wl':"
+            code[ln] = f"            if jj == 'centroid_of_eng_relative_to_wl':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.centroid_of_eng_rel_wl)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'weighted_attenuation':"
+            code[ln] = f"            if jj == 'weighted_attenuation':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.weighted_atten)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.weighted_atten)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'weighted_eng':"
+            code[ln] = f"            if jj == 'weighted_eng':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.weighted_eng)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.weighted_eng)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge50_pos_fit':"
+            code[ln] = f"            if jj == 'edge50_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.edge50_pos_fit)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.edge50_pos_fit)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge50_pos_dir':"
+            code[ln] = f"            if jj == 'edge50_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.edge50_pos_fit_none)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.edge50_pos_fit_none)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge_pos_fit':"
+            code[ln] = f"            if jj == 'edge_pos_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.edge_pos_fit)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.edge_pos_fit)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge_pos_dir':"
+            code[ln] = f"            if jj == 'edge_pos_dir':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.edge_pos_dir)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.edge_pos_dir)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge_jump_filter':"
+            code[ln] = f"            if jj == 'edge_jump_filter':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.edge_jump_mask)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.edge_jump_mask)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge_offset_filter':"
+            code[ln] = f"            if jj == 'edge_offset_filter':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.fitted_edge_mask)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.fitted_edge_mask)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'pre_edge_sd':"
+            code[ln] = f"            if jj == 'pre_edge_sd':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.pre_edge_sd_map)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.pre_edge_sd_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'post_edge_sd':"
+            code[ln] = f"            if jj == 'post_edge_sd':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.post_edge_sd_map)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.post_edge_sd_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'pre_edge_mean':"
+            code[ln] = f"            if jj == 'pre_edge_mean':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.pre_edge_mean_map)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.pre_edge_mean_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'post_edge_mean':"
+            code[ln] = f"            if jj == 'post_edge_mean':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.post_edge_mean_map)[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.post_edge_mean_map)[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj  == 'pre_edge_fit_coef':"
+            code[ln] = f"            if jj  == 'pre_edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.pre_edge_fit_rlt[0].reshape(xana.pre_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.pre_edge_fit_rlt[0].reshape(xana.pre_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'post_edge_fit_coef':"
+            code[ln] = f"            if jj == 'post_edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.post_edge_fit_rlt[0].reshape(xana.post_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.post_edge_fit_rlt[0].reshape(xana.post_edge_fit_rlt[0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge_fit_coef':"
+            code[ln] = f"            if jj == 'edge_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][0].reshape(xana.model['edge']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][0].reshape(xana.model['edge']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'edge_fit_err':"
+            code[ln] = f"            if jj == 'edge_fit_err':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.model['edge']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_coef':"
+            code[ln] = f"            if jj == 'wl_fit_coef':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][0].reshape(xana.model['wl']['fit_rlt'][0].shape[0], *xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'wl_fit_err':"
+            code[ln] = f"            if jj == 'wl_fit_err':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            code[ln] = (
+                f"                _g12[jj][:] = np.float32(xana.model['wl']['fit_rlt'][1].reshape(*xana.spec.shape[1:]))[:]"
+            )
             ln += 1
-            code[
-                ln] = f"            if jj == 'norm_spec':"
+            code[ln] = f"            if jj == 'norm_spec':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.norm_spec)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.norm_spec)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'lcf_fit':"
+            code[ln] = f"            if jj == 'lcf_fit':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.lcf_fit)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.lcf_fit)[:]"
             ln += 1
-            code[
-                ln] = f"            if jj == 'lcf_fit_err':"
+            code[ln] = f"            if jj == 'lcf_fit_err':"
             ln += 1
-            code[
-                ln] = f"                _g12[jj][:] = np.float32(xana.lcf_fit_err)[:]"
+            code[ln] = f"                _g12[jj][:] = np.float32(xana.lcf_fit_err)[:]"
             ln += 1
-            code[
-                ln] = f"print('xanes2D analysis is done!')"
+            code[ln] = f"print('xanes2D analysis is done!')"
             ln += 1
-            code[
-                ln] = f""
+            code[ln] = f""
             ln += 1
 
-            gen_external_py_script(
-                self.parent_h.xanes_fit_external_command_name, code)
-            sig = os.system(
-                f'python {self.parent_h.xanes_fit_external_command_name}')
+            gen_external_py_script(self.parent_h.xanes_fit_external_command_name, code)
+            sig = os.system(f"python {self.parent_h.xanes_fit_external_command_name}")
             if sig == 0:
-                self.hs['FitRun text'].value = 'XANES2D analysis is done ...'
+                self.hs["FitRun text"].value = "XANES2D analysis is done ..."
             else:
-                self.hs['FitRun text'].value = 'somthing wrong in analysis ...'
+                self.hs["FitRun text"].value = "somthing wrong in analysis ..."
             self.parent_h.update_xanes2D_config()
         self.parent_h.boxes_logic()
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/io.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/io.py`

 * *Files 20% similar despite different names*

```diff
@@ -2,38 +2,54 @@
 # -*- coding: utf-8 -*-
 """
 Created on Mon Aug 24 08:56:30 2020
 
 @author: xiao
 """
 
-import os, functools, inspect
-from numbers import Number
+import os
+import functools
+import inspect
+import psutil
 
-from pathlib import Path
 import glob
 import h5py
 import tifffile
 from PIL import Image
 import numpy as np
 from dask import delayed
 import dask.array as da
 
-from ..dicts.config_dict import (IO_TOMO_CFG_DEFAULT, IO_XANES2D_CFG_DEFAULT,
-                                 IO_XANES3D_CFG_DEFAULT)
-
-CHUNK_SIZE = 640E6
+from ..dicts.config_dict import (
+    IO_TOMO_CFG_DEFAULT,
+    IO_XANES2D_CFG_DEFAULT,
+    IO_XANES3D_CFG_DEFAULT,
+)
+
+CHUNK_SIZE = 640e6
+
+N_CPU = os.cpu_count()
+if N_CPU > 1:
+    N_CPU -= 1
+
+
+def cal_mem_lim(img_sz, mem_lim=None):
+    if mem_lim is None:
+        mem = psutil.virtual_memory()
+        mem_lim = mem.available / N_CPU
+    mem_lim = (mem_lim // img_sz) * img_sz
+    return mem_lim
 
 
 def shape_from_slice(sli, shp):
-    """ Calculate shape based on np.s_ 
+    """Calculate shape based on np.s_
     Parameters:
-        sli: np.s_ 
+        sli: np.s_
         shape: tuple; having same dimensions as sli
-    
+
     Return:
         tuple; shape based on sli and shape
     """
     s = []
     if sli == slice(None, None, None):
         s = shp
         return s
@@ -48,64 +64,67 @@
             sli.append(slice(None, None, None))
         for ii in range(len(sli)):
             if isinstance(sli[ii], int) and (sli[ii] < shp[ii]):
                 s.append(1)
             elif isinstance(sli[ii], slice):
                 if sli[ii].start is None:
                     d0 = 0
-                elif isinstance(sli[ii].start, int) and (
-                        sli[ii].start >= 0) and (sli[ii].start <= shp[ii] - 1):
+                elif (
+                    isinstance(sli[ii].start, int)
+                    and (sli[ii].start >= 0)
+                    and (sli[ii].start <= shp[ii] - 1)
+                ):
                     d0 = sli[ii].start
                 else:
                     raise (
                         TypeError,
-                        'Slicing index has to be either None or positive integers smaller than shape.'
+                        "Slicing index has to be either None or positive integers smaller than shape.",
                     )
                 if sli[ii].stop is None:
                     d1 = shp[ii]
-                elif isinstance(sli[ii].stop, int) and (
-                        sli[ii].stop >= 0) and (sli[ii].stop <= shp[ii]):
+                elif (
+                    isinstance(sli[ii].stop, int)
+                    and (sli[ii].stop >= 0)
+                    and (sli[ii].stop <= shp[ii])
+                ):
                     d1 = sli[ii].stop
                 else:
                     raise (
                         TypeError,
-                        'Slicing index has to be either None or positive integers smaller than shape.'
+                        "Slicing index has to be either None or positive integers smaller than shape.",
                     )
                 if sli[ii].step is None:
                     dt = 1
                 elif isinstance(sli[ii].step, int) and (sli[ii].step >= 0):
                     dt = sli[ii].step
                 else:
                     raise (
                         TypeError,
-                        'Slicing index has to be either None or positive integer.'
+                        "Slicing index has to be either None or positive integer.",
                     )
                 s.append(int(d1 - d0) / dt)
             else:
                 raise (
                     TypeError,
-                    'Slicing index has to be either None or positive integers smaller than shape.'
+                    "Slicing index has to be either None or positive integers smaller than shape.",
                 )
         return s
 
 
 def sli_interpreter(sli_tuple):
     sli = []
     for s in sli_tuple:
         if isinstance(s, list):
             sli.append(slice(s[0], s[1]))
         else:
             sli.append(slice(s))
     return tuple(sli)
 
 
-def tomo_h5_reader(fn,
-                   dtype='data',
-                   sli=[[None, None]],
-                   cfg=IO_TOMO_CFG_DEFAULT):
+def tomo_h5_reader(fn, dtype="data", sli=[[None, None]], cfg=IO_TOMO_CFG_DEFAULT):
     """
     Inputs:
         fnt: string
              file name template to raw h5 data files
         cfg: dictionary; optional
              dictionary with 4 items 'data_path', 'flat_path', 'dark_path', and
              'eng_path' under item 'io_data_structure'; paths point to the
@@ -118,90 +137,97 @@
              are [eng, angle, y, x] for dtype='data', or three dimensions of
              [eng, y, x] for dtype='flat' and 'dark', or one dimension of [eng]
              for dtype='eng'
     Returns:
         ndarray
     """
     sli = sli_interpreter(sli)
-    with h5py.File(fn, 'r') as f:
-        if dtype == 'data':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['data_path']])[sli]
-        elif dtype == 'flat':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['flat_path']])[sli]
-        elif dtype == 'dark':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['dark_path']])[sli]
-        elif dtype == 'theta':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['theta_path']])[sli[0]]
+    with h5py.File(fn, "r") as f:
+        if dtype == "data":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["data_path"]]
+            )[sli]
+        elif dtype == "flat":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["flat_path"]]
+            )[sli]
+        elif dtype == "dark":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["dark_path"]]
+            )[sli]
+        elif dtype == "theta":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["theta_path"]]
+            )[sli[0]]
 
 
-def tomo_h5_info(fn, dtype='data', cfg=IO_XANES2D_CFG_DEFAULT):
+def tomo_h5_info(fn, dtype="data", cfg=IO_XANES2D_CFG_DEFAULT):
     with h5py.File(fn, "r") as f:
-        if dtype == 'data':
+        if dtype == "data":
             try:
-                arr = np.squeeze(f[cfg['structured_h5_reader']
-                                   ['io_data_structure']['data_path']])
+                arr = np.squeeze(
+                    f[cfg["structured_h5_reader"]["io_data_structure"]["data_path"]]
+                )
                 dim = arr.shape
                 return dim
             except:
                 return 0
-        elif dtype == 'flat':
+        elif dtype == "flat":
             try:
-                arr = np.squeeze(f[cfg['structured_h5_reader']
-                                   ['io_data_structure']['flat_path']])
+                arr = np.squeeze(
+                    f[cfg["structured_h5_reader"]["io_data_structure"]["flat_path"]]
+                )
                 dim = arr.shape
                 return dim
             except:
                 return 0
-        elif dtype == 'dark':
+        elif dtype == "dark":
             try:
-                arr = np.squeeze(f[cfg['structured_h5_reader']
-                                   ['io_data_structure']['dark_path']])
+                arr = np.squeeze(
+                    f[cfg["structured_h5_reader"]["io_data_structure"]["dark_path"]]
+                )
                 dim = arr.shape
                 return dim
             except:
                 return 0
-        elif dtype == 'theta':
+        elif dtype == "theta":
             try:
-                arr = np.squeeze(f[cfg['structured_h5_reader']
-                                   ['io_data_structure']['theta_path']])
+                arr = np.squeeze(
+                    f[cfg["structured_h5_reader"]["io_data_structure"]["theta_path"]]
+                )
                 dim = arr.shape
                 return dim
             except:
                 return 0
 
 
-def xanes2D_h5_reader(fn,
-                      dtype='data',
-                      sli=[[None, None]],
-                      cfg=IO_XANES2D_CFG_DEFAULT):
+def xanes2D_h5_reader(fn, dtype="data", sli=[[None, None]], cfg=IO_XANES2D_CFG_DEFAULT):
     sli = sli_interpreter(sli)
-    with h5py.File(fn, 'r') as f:
-        if dtype == 'data':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['data_path']])[sli]
-        elif dtype == 'flat':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['flat_path']])[sli]
-        elif dtype == 'dark':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['dark_path']])[sli]
-        elif dtype == 'eng':
-            return np.squeeze(f[cfg['structured_h5_reader']
-                                ['io_data_structure']['eng_path']])[sli]
-
-
-def xanes3D_h5_reader(fn,
-                      ids,
-                      dtype='data',
-                      sli=[[None, None]],
-                      cfg=IO_XANES3D_CFG_DEFAULT):
+    with h5py.File(fn, "r") as f:
+        if dtype == "data":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["data_path"]]
+            )[sli]
+        elif dtype == "flat":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["flat_path"]]
+            )[sli]
+        elif dtype == "dark":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["dark_path"]]
+            )[sli]
+        elif dtype == "eng":
+            return np.squeeze(
+                f[cfg["structured_h5_reader"]["io_data_structure"]["eng_path"]]
+            )[sli]
+
+
+def xanes3D_h5_reader(
+    fn, ids, dtype="data", sli=[[None, None]], cfg=IO_XANES3D_CFG_DEFAULT
+):
     """
     Inputs:
         fn:  string
              file name template to raw h5 data files
         cfg: dictionary; optional
              dictionary with 4 items 'data_path', 'flat_path', 'dark_path', and
              'eng_path' under item 'io_data_structure'; paths point to the
@@ -214,49 +240,57 @@
              are [eng, angle, y, x] for dtype='data', or three dimensions of
              [eng, y, x] for dtype='flat' and 'dark', or one dimension of [eng]
              for dtype='eng'
     Returns:
         ndarray
     """
     sli = sli_interpreter(sli)
-    if dtype == 'data':
+    if dtype == "data":
         data = []
         for ii in ids:
             fn0 = fn.format(ii)
-            with h5py.File(fn0, 'r') as f:
+            with h5py.File(fn0, "r") as f:
                 data.append(
-                    np.squeeze(f[cfg['structured_h5_reader']
-                                 ['io_data_structure']['data_path']])[sli])
+                    np.squeeze(
+                        f[cfg["structured_h5_reader"]["io_data_structure"]["data_path"]]
+                    )[sli]
+                )
         return np.array(data)
-    elif dtype == 'flat':
+    elif dtype == "flat":
         data = []
         for ii in ids:
             fn0 = fn.format(ii)
-            with h5py.File(fn0, 'r') as f:
+            with h5py.File(fn0, "r") as f:
                 data.append(
-                    np.squeeze(f[cfg['structured_h5_reader']
-                                 ['io_data_structure']['flat_path']])[sli])
+                    np.squeeze(
+                        f[cfg["structured_h5_reader"]["io_data_structure"]["flat_path"]]
+                    )[sli]
+                )
         return np.array(data)
-    elif dtype == 'dark':
+    elif dtype == "dark":
         data = []
         for ii in ids:
             fn0 = fn.format(ii)
-            with h5py.File(fn0, 'r') as f:
+            with h5py.File(fn0, "r") as f:
                 data.append(
-                    np.squeeze(f[cfg['structured_h5_reader']
-                                 ['io_data_structure']['dark_path']])[sli])
+                    np.squeeze(
+                        f[cfg["structured_h5_reader"]["io_data_structure"]["dark_path"]]
+                    )[sli]
+                )
         return np.array(data)
-    elif dtype == 'eng':
+    elif dtype == "eng":
         eng = []
         for ii in ids:
             fn0 = fn.format(ii)
-            with h5py.File(fn0, 'r') as f:
+            with h5py.File(fn0, "r") as f:
                 eng.append(
-                    np.squeeze(f[cfg['structured_h5_reader']
-                                 ['io_data_structure']['eng_path']])[()])
+                    np.squeeze(
+                        f[cfg["structured_h5_reader"]["io_data_structure"]["eng_path"]]
+                    )[()]
+                )
         return np.array(eng)
 
 
 def data_reader(func):
 
     @functools.wraps(func)
     def wrapper_data_reader(fn, *args, **kwargs):
@@ -264,56 +298,56 @@
 
     return wrapper_data_reader
 
 
 def data_info(func):
 
     @functools.wraps(func)
-    def wrapper_data_info(fn, dtype='data', *args, **kwargs):
-        if not (set(
-            ('fn', 'dtype')) <= set(inspect.getfullargspec(func).args)):
+    def wrapper_data_info(fn, dtype="data", *args, **kwargs):
+        if not (set(("fn", "dtype")) <= set(inspect.getfullargspec(func).args)):
             raise TypeError(
                 f'{func.__name__} missing one or more arguments in ("fn", "dtype")'
             )
             return None
         return func(fn, dtype=dtype, *args, **kwargs)
 
     return wrapper_data_info
 
 
 def read_xanes2D_wl_fit(fn):
-    with h5py.File(fn, 'r') as f:
-        return f['/processed_XANES2D/proc_spectrum/whiteline_pos_fit'][:]
+    with h5py.File(fn, "r") as f:
+        return f["/processed_XANES2D/proc_spectrum/whiteline_pos_fit"][:]
 
 
 def tiff_vol_reader(fn_temp, scan_id, roi):
     vol = []
     for ii in range(roi[0], roi[1]):
         vol.append(
-            tifffile.imread(fn_temp.format(scan_id,
-                                           str(ii).zfill(5)))[roi[2]:roi[3],
-                                                              roi[4]:roi[5]])
+            tifffile.imread(fn_temp.format(scan_id, str(ii).zfill(5)))[
+                roi[2] : roi[3], roi[4] : roi[5]
+            ]
+        )
     return np.array(vol)
 
 
 def h5_lazy_reader(fn, path, sli):
 
     @delayed
     def dlyd_rdr(fn, path, sli):
         try:
-            with h5py.File(fn, 'r') as f:
+            with h5py.File(fn, "r") as f:
                 return f[path][sli]
         except:
             print(
                 "Cannot read data with the given filename, dataset path, and slice range."
             )
             return None
 
     try:
-        with h5py.File(fn, 'r') as f:
+        with h5py.File(fn, "r") as f:
             dtp = f[path].dtype
             shp = f[path].shape
     except:
         print(
             "Cannot read data with the given filename, dataset path, and slice range."
         )
         shp, dtp = None, None
@@ -329,16 +363,15 @@
         return None
     else:
         if len(shp) == 3:
             s0 = int(CHUNK_SIZE / (s[1] * s[2]) / 4)
             if s0 > s[0]:
                 s0 = s[0]
             chunk = {0: s0, 1: -1, 2: -1}
-            return da.from_delayed(delayed_arr, shape=s,
-                                   dtype=dtp).rechunk(chunk)
+            return da.from_delayed(delayed_arr, shape=s, dtype=dtp).rechunk(chunk)
         else:
             return da.from_delayed(delayed_arr, shape=s, dtype=dtp)
 
 
 def tif_lazy_reader(fnt, ids=None, ide=None, digit=5):
 
     @delayed
@@ -346,92 +379,84 @@
         try:
             imgs = [
                 tifffile.imread(fns.format(str(ii).zfill(digit))).astype(dtype)
                 for ii in range(ids, ide)
             ]
             return np.array(imgs)
         except:
-            print(
-                "Cannot read data with the given filename and the index range."
-            )
+            print("Cannot read data with the given filename and the index range.")
             return None
 
     @delayed
     def dlyd_sgl_rdr(fn, dtype=np.float32):
         pass
 
     if ids is None:
         im = Image.open(fnt)
         s = im.size
-        if im.mode == 'F':
+        if im.mode == "F":
             dtp = np.float32
-        elif im.mode == 'I':
+        elif im.mode == "I":
             dtp = np.int32
-        elif im.mode in ['1', 'L', 'P']:
+        elif im.mode in ["1", "L", "P"]:
             dtp = np.int8
         im.close()
 
         delayed_arr = dlyd_sgl_rdr(fnt, dtype=dtp)
         if delayed_arr is None:
             print("Cannot read the dataset.")
             return None
         else:
             if len(s) == 3:
                 s0 = int(CHUNK_SIZE / (s[1] * s[2]) / 4)
                 if s0 > s[0]:
                     s0 = s[0]
                 chunk = {0: s0, 1: -1, 2: -1}
-                return da.from_delayed(delayed_arr, shape=s,
-                                       dtype=dtp).rechunk(chunk)
+                return da.from_delayed(delayed_arr, shape=s, dtype=dtp).rechunk(chunk)
             else:
                 return da.from_delayed(delayed_arr, shape=s, dtype=dtp)
     else:
         im = Image.open(fnt.format(str(ids).zfill(digit)))
         s = im.size
-        if im.mode == 'F':
+        if im.mode == "F":
             dtp = np.float32
-        elif im.mode == 'I':
+        elif im.mode == "I":
             dtp = np.int32
-        elif im.mode in ['1', 'L', 'P']:
+        elif im.mode in ["1", "L", "P"]:
             dtp = np.int8
         im.close()
 
-        fns = sorted(glob.glob(fnt.format('*')))
-        id_min = int(os.path.basename(fns[0]).split('_')[-1])
-        id_max = int(os.path.basename(fns[-1]).split('_')[-1])
+        fns = sorted(glob.glob(fnt.format("*")))
+        id_min = int(os.path.basename(fns[0]).split("_")[-1])
+        id_max = int(os.path.basename(fns[-1]).split("_")[-1])
         if ide == -1:
             ide = id_max
         if ids > ide:
             ids = ide
         if ids > id_max:
             ids = id_max
         if ide > id_max:
             ide = id_max
         if ids < id_min:
             ids = id_min
         if ide < id_min:
             ide = id_min
         s.insert(0, ide - ids + 1)
 
-        delayed_arr = dlyd_seq_rdr(fnt,
-                                   ids=ids,
-                                   ide=ide,
-                                   digit=digit,
-                                   dtype=dtp)
+        delayed_arr = dlyd_seq_rdr(fnt, ids=ids, ide=ide, digit=digit, dtype=dtp)
         if delayed_arr is None:
             print("Cannot read the dataset.")
             return None
         else:
             if len(s) == 3:
                 s0 = int(CHUNK_SIZE / (s[1] * s[2]) / 4)
                 if s0 > s[0]:
                     s0 = s[0]
                 chunk = {0: s0, 1: -1, 2: -1}
-                return da.from_delayed(delayed_arr, shape=s,
-                                       dtype=dtp).rechunk(chunk)
+                return da.from_delayed(delayed_arr, shape=s, dtype=dtp).rechunk(chunk)
             else:
                 return da.from_delayed(delayed_arr, shape=s, dtype=dtp)
 
 
 def tif_reader(fn):
     pass
 
@@ -444,56 +469,64 @@
     pass
 
 
 def tif_writer(fn, img):
     tifffile.imsave(fn, img)
 
 
-def tif_seq_writer(fnt, img, ids=0, digit=5):
+def tif_seq_writer(fnt, img, axis=0, ids=0, digit=5, overwrite=True):
     if len(img.shape) < 3:
         raise (TypeError, "Cannot save the image as an image sequence")
     else:
-        for ii in range(ids, ids + img.shape[0]):
-            fn = fnt.format(str(ii).zfill(digit))
-            tifffile.imsave(fn, img[ii - ids])
+        if axis == 0:
+            for ii in range(ids, ids + img.shape[0]):
+                fn = fnt.format(str(ii).zfill(digit))
+                tifffile.imsave(fn, img[ii - ids].astype(np.float32))
+        elif axis == 1:
+            for ii in range(ids, ids + img.shape[1]):
+                fn = fnt.format(str(ii).zfill(digit))
+                tifffile.imsave(fn, img[:, ii - ids, :].astype(np.float32))
+        elif axis == 2:
+            for ii in range(ids, ids + img.shape[1]):
+                fn = fnt.format(str(ii).zfill(digit))
+                tifffile.imsave(fn, img[:, :, ii - ids].astype(np.float32))
 
 
 def raw_writer(fn, img):
-    with open(fn, 'wb') as f:
+    with open(fn, "wb") as f:
         np.save(f, img, allow_pickle=False, fix_imports=False)
 
 
 def raw_seq_writer(fnt, img, ids=0, digit=5):
     if len(img.shape) < 3:
         raise (TypeError, "Cannot save the image as an image sequence")
     else:
         for ii in range(ids, ids + img.shape[0]):
             fn = fnt.format(str(ii).zfill(digit))
-            with open(fn, 'wb') as f:
-                np.save(f,
-                        img[ii - ids],
-                        allow_pickle=False,
-                        fix_imports=False)
+            with open(fn, "wb") as f:
+                np.save(f, img[ii - ids], allow_pickle=False, fix_imports=False)
 
 
 def asc_writer(fn, img):
-    np.savetxt(fn,
-                  img,
-                  fmt='%10.5f',
-                  delimiter='\t',
-                  newline='\n',
-                  header='X-ray energy in eV',
-                  footer='',
-                  comments='# ',
-                  encoding=None)
+    np.savetxt(
+        fn,
+        img,
+        fmt="%10.5f",
+        delimiter="\t",
+        newline="\n",
+        header="X-ray energy in eV",
+        footer="",
+        comments="# ",
+        encoding=None,
+    )
 
 
 def h5_writer(fn, ds_path, img):
     try:
-        with h5py.File(fn, 'a') as f:
+        with h5py.File(fn, "a") as f:
             if ds_path in f:
                 del f[ds_path]
                 f.create_dataset(ds_path, data=img, dtype=img.dtype)
             else:
                 f.create_dataset(ds_path, data=img, dtype=img.dtype)
     except Exception as e:
         raise (e)
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/lineshapes.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/lineshapes.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/plotlib.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/plotlib.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_analysis.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_analysis.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_image_utils.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_image_utils.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_math.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_math.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_post_analysis.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_post_analysis.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_regtools.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_regtools.py`

 * *Files 20% similar despite different names*

```diff
@@ -2,533 +2,191 @@
 # -*- coding: utf-8 -*-
 """
 Created on Wed Aug 21 16:09:13 2019
 
 @author: xiao
 """
 
-#import faulthandler; faulthandler.enable()
 import os, gc, psutil
 import multiprocess as mp
 from functools import partial
+from pathlib import Path
 
 from pystackreg import StackReg
 import tifffile, h5py
 from skimage.registration import phase_cross_correlation
 from scipy.ndimage import fourier_shift
 import numpy as np
 from silx.io.dictdump import dicttoh5, h5todict
 
-from .reg_algs import mrtv_mpc_combo_reg, mrtv_reg, mrtv_ls_combo_reg, shift_img
-from .io import tiff_vol_reader
-
-N_CPU = os.cpu_count()-1
-__all__ = ['regtools']
-
-
-class regtools():
-    def __init__(self, dtype='2D_XANES', **kwargs):
-        if dtype not in ['2D_XANES', '3D_XANES']:
-            print("Wrong input data_type ...")
-
-        self.si = None
-        self.mse = None
-        self.nrmse = None
-        self.error = None
-        self.shift = None
-        self.fit_curve = None
-        self.fit_curve_diff = None
-        self.possible_match = None
-
-        self.data_type = dtype.upper()
-        self.fixed = None
-        self.img = None
-        self.eng_list = None
+from .reg_algs import (
+    mrtv_mpc_combo_reg,
+    mrtv_reg,
+    mrtv_ls_combo_reg,
+    shift_img,
+    mrtv_rigid_reg,
+    cal_rig_mrtv_ang,
+)
+from .io import tiff_vol_reader, cal_mem_lim
+from .misc import parallelizing
+
+N_CPU = os.cpu_count()
+if N_CPU > 1:
+    N_CPU -= 1
+
+__all__ = ["regtools"]
+
+
+class regtools:
+
+    def __init__(self, reg_cfg):
+        self.data_type = reg_cfg["data_type"].upper()
+        self.reg_alg = reg_cfg["reg"]["alg"].upper()
+        if self.reg_alg == "MPC":
+            self.mpc_ovlp_r = reg_cfg["reg"]["alg_pars"]["MPC"]["ovlp_r"]
+        else:
+            self.mpc_ovlp_r = None
+        if self.reg_alg == "SR":
+            self.sr_mode = reg_cfg["reg"]["alg_pars"]["SR"]["mode"]
+        else:
+            self.sr_mode = None
+        if self.reg_alg in ["MRTV", "RIG-MRTV"]:
+            self.mrtv_lvl = reg_cfg["reg"]["alg_pars"][self.reg_alg]["lvl"]
+            self.mrtv_wz = reg_cfg["reg"]["alg_pars"][self.reg_alg]["wz"]
+            self.mrtv_sp_wz = reg_cfg["reg"]["alg_pars"][self.reg_alg]["sp_wz"]
+            self.mrtv_smth_knl = reg_cfg["reg"]["alg_pars"][self.reg_alg]["smth_knl"]
+        else:
+            self.mrtv_lvl = None
+            self.mrtv_wz = None
+            self.mrtv_sp_wz = None
+            self.mrtv_smth_knl = None
+
+        self.ref_mode = reg_cfg["reg"]["ref_mode"]
+        self.use_chunk = reg_cfg["reg"]["use_chnk"]
+        self.chunk_sz = reg_cfg["reg"]["chnk_sz"]
+        self.xanes3D_sli_srch_half_range = reg_cfg["reg"]["XANES3D_sli_srch_half_range"]
+        self.xanes3D_fixed_ref_sli = reg_cfg["reg"]["XANES3D_fixed_ref_sli"]
+
+        self.im_id_s = reg_cfg["data"]["im_id_s"]
+        self.im_id_e = reg_cfg["data"]["im_id_e"]
+        print(f"{self.im_id_e=}")
+        self.im_id_fxd = reg_cfg["data"]["im_id_fixed"]
+        self.xanes3D_scn_ids = list(reg_cfg["data"]["XANES3D_scn_ids"])
+        self.im_roi = reg_cfg["data"]["roi"]
+
+        self.xanes3D_rec_path_tplt = reg_cfg["file"]["XANES3D_rec_path_tplt"]
+        self.xanes3D_raw_h5_top_dir = reg_cfg["file"]["XANES3D_raw_h5_top_dir"]
+        self.xanes2D_raw_fn = reg_cfg["file"]["XANES2D_raw_fn"]
+        self.xanes_tmp_fn = reg_cfg["file"]["XANES_tmp_fn"]
+        self.sav_fn = reg_cfg["file"]["sav_fn"]
+
+        self.use_mask = reg_cfg["preproc"]["use_mask"]
+        self.mask_thres = reg_cfg["preproc"]["mask_thres"]
+        self.use_smth_im = reg_cfg["preproc"]["use_smth_im"]
+        self.smth_im_sig = reg_cfg["preproc"]["smth_im_sig"]
+        if self.reg_alg == "RIG-MRTV":
+            if "ang_rgn" in reg_cfg["reg"]["alg_pars"]["RIG-MRTV"].keys():
+                self.rig_mrtv_ang_rgn = reg_cfg["reg"]["alg_pars"]["RIG-MRTV"][
+                    "ang_rgn"
+                ]
+            else:
+                self.rig_mrtv_ang_rgn = 3
+            if "pre_offset" in reg_cfg["reg"]["alg_pars"]["RIG-MRTV"].keys():
+                self.rig_mrtv_pre_ofst = reg_cfg["reg"]["alg_pars"]["RIG-MRTV"][
+                    "pre_offset"
+                ]
+            else:
+                self.rig_mrtv_pre_ofst = None
+            if "gm" in reg_cfg["reg"]["alg_pars"]["RIG-MRTV"].keys():
+                self.rig_mrtv_gm = reg_cfg["reg"]["alg_pars"]["RIG-MRTV"]["gm"]
+            else:
+                self.rig_mrtv_gm = 1
+            if "use_flt" in reg_cfg["reg"]["alg_pars"]["RIG-MRTV"].keys():
+                self.rig_mrtv_use_flt = reg_cfg["reg"]["alg_pars"]["RIG-MRTV"][
+                    "use_flt"
+                ]
+            else:
+                self.rig_mrtv_use_flt = True
+            if "use_norm" in reg_cfg["reg"]["alg_pars"]["RIG-MRTV"].keys():
+                self.rig_mrtv_use_norm = reg_cfg["reg"]["alg_pars"]["RIG-MRTV"][
+                    "use_flt"
+                ]
+            else:
+                self.rig_mrtv_use_norm = False
+        else:
+            self.rig_mrtv_ang_rgn = None
+            self.rig_mrtv_pre_ofst = None
+            self.rig_mrtv_gm = None
+            self.rig_mrtv_use_flt = None
+            self.rig_mrtv_use_norm = None
+
+        self.eng_list = reg_cfg["meta"]["eng_list"]
+
+        if self.data_type == "3D_XANES":
+            self.anchor_loc = self.xanes3D_scn_ids.index(self.im_id_fxd)
+            self.data_pnts = len(self.xanes3D_scn_ids)
+        else:
+            self.anchor_loc = self.im_id_fxd - self.im_id_s
+            self.data_pnts = self.im_id_e - self.im_id_s
+        self.sav_dir = str(Path(self.sav_fn).parent)
+        self.ref_im = None
+        self.im = None
+        self.msk = None
         self.eng_dict = {}
-        self.img_ids = None
-        self.img_ids_dict = {}
-        self.mask = None
-        self.use_mask = False
-        self.overlap_ratio = 0.3
-        self.save_path = os.curdir
-        self.savefn = os.path.join(self.save_path, 'regisstration_results.h5')
-        self.xanes3D_trial_reg_fn = os.path.join(self.save_path, 'xanes3D_trial_reg_results.h5')
-        self.raw_data_info = {}
-        self.data_pnts = None
-        self.roi = None
+        self.im_ids_dict = {}
 
-        self.chunk_sz = 7
-        self.anchor = 0
         self.chunks = {}
         self.num_chunk = None
-        self.alignment_pair_list = []
-        self.anchor_chunk = None
-        self.use_chunk = False
-        self.alg_mrtv_level = 5
-        self.alg_mrtv_width  = 10
-        self.alg_mrtv_sp_kernel = 3
-        self.alg_mrtv_sp_wz = 8
-
-        self.xanes3D_recon_path_template = None
-        self.xanes3D_recon_fixed_sli = None
-        self.xanes3D_sli_search_half_range = None
-        self.xanes3D_recon_file_id_s = None
-        self.xanes3D_recon_file_id_e = None
-        self.xanes3D_raw_h5_top_dir = None
-
-        self.xanes2D_raw_filename = None
-        self.xanes2D_eng_start = None
-        self.xanes2D_eng_end = None
-
-        if 'method' in kwargs:
-            self.method = kwargs['method']
-        else:
-            self.method = 'MPC'
-            self.overlap_ratio = 0.3
-            print('Registration method is set to default phase-correlation \
-                  method.')
-
-        if self.method.upper() == 'SR':
-            if 'mode' in kwargs:
-                self.mode = kwargs['mode'].upper()
-            else:
-                self.mode = 'TRANSLATION'
-                print('"mode" for stackreg method is set to default \
-                      "TRANSLATION".')
-        else:
-            self.mode = ''
-        self.ref_mode = 'neighbor'
-
-    def set_analysis_type(self, dtype='3D_XANES'):
-        """
-        Parameters
-        ----------
-        dtype : string, optional
-            type of analysis in ['2D_XANES', '3D_XANES']. The default is '3D_XANES'.
-
-        Returns
-        -------
-        None.
-        """
-        self.data_type = dtype.upper()
-
-    def set_chunk_sz(self, chunk_sz):
-        self.chunk_sz = chunk_sz
-
-    def set_roi(self, roi):
-        self.roi = roi
-
-    def set_eng_list(self, eng_list):
-        self.eng_list = eng_list
+        self.algn_pair_lst = []
+        self.anchor_chunk_loc = None
 
-    def set_xanes3D_raw_h5_top_dir(self, raw_h5_top_dir):
-        self.xanes3D_raw_h5_top_dir = raw_h5_top_dir
-
-    def set_raw_data_info(self, **kwargs):
-        self.raw_data_info = kwargs
-
-    def set_xanes3D_recon_path_template(self, path_template):
-        self.xanes3D_recon_path_template = path_template
-
-    def set_xanes2D_raw_filename(self, filename):
-        self.xanes2D_raw_filename = filename
-
-    def set_xanes2D_tmp_filename(self, filename):
-        self.xanes2D_tmp_filename = filename
-
-    def set_xanes3D_tmp_filename(self, filename):
-        self.xanes3D_tmp_filename = filename
-
-    def set_xanes3D_scan_ids(self, avail_recon_ids):
-        self.img_ids = avail_recon_ids[self.img_id_s:self.img_id_e+1]
+        self.raw_data_info = {}
+        self.sav_dir = os.curdir
 
-    def set_indices(self, img_id_s, img_id_e, fixed_img_id):
-        self.img_id_s = img_id_s
-        self.img_id_e = img_id_e
-        self.fixed_img_id = fixed_img_id
+        self.error = None
+        self.shift = None
 
-    def set_reg_options(self, use_mask=True, mask_thres=0,
-                        use_chunk=True, chunk_sz=7,
-                        use_smooth_img=False, smooth_sigma=0,
-                        mrtv_level=5, mrtv_width=10,
-                        mrtv_sp_wz=8, mrtv_sp_kernel=3):
-        """
-        the current use_anchor setting is not contraversial. all the registrations
-        use some anchors. It is not anchor but chunk setting making differences.
-        The code shoudl be modified to have use_chunk and remove use_anchor
-
-        Parameters
-        ----------
-        use_mask : TYPE, optional
-            DESCRIPTION. The default is True.
-        mask_thres : TYPE, optional
-            DESCRIPTION. The default is 0.
-        use_chunk : TYPE, optional
-            DESCRIPTION. The default is True.
-        anchor_id : TYPE, optional
-            DESCRIPTION. The default is 0.
-        use_smooth_img : TYPE, optional
-            DESCRIPTION. The default is False.
-        smooth_sigma : TYPE, optional
-            DESCRIPTION. The default is 0.
-
-        Returns
-        -------
-        None.
+        self.reg_cfged = False
 
-        """
-        self.use_mask = use_mask
-        self.mask_thres = mask_thres
-        self.use_chunk = use_chunk
-        self.chunk_sz = chunk_sz
-        self.use_smooth_img = use_smooth_img
-        self.img_smooth_sigma = smooth_sigma
-        self.alg_mrtv_level = mrtv_level
-        self.alg_mrtv_width  = mrtv_width
-        self.alg_mrtv_sp_wz = mrtv_sp_wz
-        self.alg_mrtv_sp_kernel = mrtv_sp_kernel
-
-    def set_method(self, method):
-        self.method = method.upper()
-
-    def set_ref_mode(self, ref_mode):
-        self.ref_mode = ref_mode.upper()
-
-    def set_img_data(self, moving):
-        self.img = moving
-
-    def set_mask(self, mask):
-        self.mask = mask
-
-    def set_saving(self, save_path, fn=None):
-        if save_path is not None:
-            self.save_path = save_path
-        if fn is None:
-            fn = 'regisstration_results.h5'
-        self.savefn = os.path.join(self.save_path, fn)
-        print('1. The registration results will be saved in {:s}'
-              .format(self.savefn))
-
-    def read_xanes2D_tmp_file(self, mode='reg'):
-        with h5py.File(self.xanes2D_tmp_filename, 'r') as f:
-            if mode == 'reg':
-                self.img = f['xanes2D_img'][self.img_id_s:self.img_id_e, self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
-            elif mode == 'align':
-                self.img = f['xanes2D_img'][self.img_id_s:self.img_id_e, :]
-            self.mask = f['xanes2D_reg_mask'][:]
-            if len(self.mask.shape) == 1:
-                self.mask = None
-            self.eng_list = f['analysis_eng_list'][:]
+    def read_xanes2D_tmp_file(self, mode="reg"):
+        with h5py.File(self.xanes_tmp_fn, "r") as f:
+            if mode == "reg":
+                self.im = f["xanes2D_img"][
+                    self.im_id_s : self.im_id_e,
+                    self.im_roi[0] : self.im_roi[1],
+                    self.im_roi[2] : self.im_roi[3],
+                ]
+            elif mode == "align":
+                self.im = f["xanes2D_img"][self.im_id_s : self.im_id_e, :]
+            self.msk = f["xanes2D_reg_mask"][:]
+            if len(self.msk.shape) == 1:
+                self.msk = None
+            self.eng_list = f["analysis_eng_list"][:]
 
     def read_xanes3D_tmp_file(self):
-        with h5py.File(self.xanes3D_tmp_filename, 'r') as f:
-            self.mask = f['xanes3D_reg_mask'][:]
-            if len(self.mask.shape) == 1:
-                self.mask = None
-            self.eng_list = f['analysis_eng_list'][:]
+        with h5py.File(self.xanes_tmp_fn, "r") as f:
+            self.msk = f["xanes3D_reg_mask"][:]
+            if len(self.msk.shape) == 1:
+                self.msk = None
+            self.eng_list = f["analysis_eng_list"][:]
 
     def compose_dicts(self):
-        if self.data_type == '3D_XANES':
-            if self.fixed_img_id in range(self.img_id_s, self.img_id_e):
-                self.anchor = self.fixed_img_id-self.img_id_s
-                self.data_pnts = self.img_id_e - self.img_id_s
-                print(self.img_id_s, self.img_id_e)
-                print(len(self.img_ids))
-                print(self.img_ids)
-                print(self.fixed_img_id-self.img_id_s)
-                self.anchor_id = self.img_ids[self.fixed_img_id-self.img_id_s]
-                cnt = 0
-                for ii in self.img_ids:
-                    self.eng_dict[str(cnt).zfill(3)] = self.eng_list[cnt]
-                    self.img_ids_dict[str(cnt).zfill(3)] = ii
-                    cnt += 1
-            else:
-                print('fixed_img_id is outside of [img_id_s, img_id_e].')
-        elif self.data_type == '2D_XANES':
-            if self.fixed_img_id in range(self.img_id_s, self.img_id_e):
-                self.anchor = self.fixed_img_id - self.img_id_s
-                self.data_pnts = self.img_id_e - self.img_id_s
-                self.img_ids = np.arange(self.img_id_s, self.img_id_e)
-                self.anchor_id = self.fixed_img_id
-                cnt = 0
-                for ii in range(self.img_id_s, self.img_id_e):
-                    self.eng_dict[str(cnt).zfill(3)] = self.eng_list[cnt]
-                    self.img_ids_dict[str(cnt).zfill(3)] = ii
-                    cnt += 1
-            else:
-                print('fixed_img_id is outside of [img_id_s, img_id_e].')
-
-    def _set_chunks(self):
-        """
-        self.data_pnts: relative number defined as self.img_id_e - self.img_id_s + 1
-        self.anchor: relative number defined as self.fixed_img_id - self.img_id_s
-
-        self.chunks: generated variable; starting and ending idx of each chunk.
-                     the idx are relative idx from self.img_id_s
-        Returns
-        -------
-        None.
-
-        """
-        if self.use_chunk:
-            right_num_chunk = int(np.ceil((self.data_pnts -
-                                           self.anchor) / self.chunk_sz))
-            left_num_chunk = int(np.ceil(self.anchor / self.chunk_sz))
-            num_chunk = left_num_chunk + right_num_chunk
-            self.num_chunk = num_chunk
-            self.left_num_chunk = left_num_chunk - 1
-            self.anchor_chunk = left_num_chunk - 1
-            for ii in range(left_num_chunk-1):
-                self.chunks[left_num_chunk-1-ii] = {'chunk_s':\
-                    self.anchor - self.chunk_sz * (ii + 1) + 1}
-                self.chunks[left_num_chunk-1-ii]['chunk_e'] =\
-                    self.anchor - self.chunk_sz * ii
-
-            if (self.anchor % self.chunk_sz) != 0:
-                self.chunks[0] = {'chunk_s': 0}
-                self.chunks[0]['chunk_e'] = int(self.anchor %
-                                                self.chunk_sz)
-            else:
-                self.chunks[0] = {'chunk_s': 0}
-                self.chunks[0]['chunk_e'] = self.chunk_sz
-
-            for ii in range(left_num_chunk, num_chunk-1):
-                self.chunks[ii] = {'chunk_s': self.anchor +\
-                    self.chunk_sz * (ii - left_num_chunk) + 1}
-                self.chunks[ii]['chunk_e'] = self.anchor +\
-                    self.chunk_sz * (ii - left_num_chunk + 1)
-
-            if ((self.data_pnts - self.anchor) % self.chunk_sz) != 1:
-                self.chunks[num_chunk-1] = {'chunk_s':\
-                    self.chunks[num_chunk-2]['chunk_e'] + 1}
-                self.chunks[num_chunk-1]['chunk_e'] =\
-                    self.data_pnts - 1
-            else:
-                self.chunks[num_chunk-1] = {'chunk_s':\
-                    self.data_pnts - 1}
-                self.chunks[num_chunk-1]['chunk_e'] =\
-                    self.data_pnts - 1
-        else:
-            self.chunks[0] = {'chunk_s': 0}
-            self.chunks[0]['chunk_e'] = self.data_pnts - 1
-
-    def _alignment_scheduler(self, dtype='2D_XANES'):
-        """
-        2D XANES: [chunk_sz, img_s,     img_e,     ref_mode, fixed_img]
-        3D XANES: [chunk_sz, scan_id_s, scan_id_e, ref_mode, fixed_scan_id]
-
-        According to chunk_sz and ref_mode, we should make a list of pairs for
-        comparison. imgs/scan_id_s and img_e/scan_id_e are used to determine
-        the bounds to the numbers in the pairs. fixed_img/fixed_scan_id are the
-        image/scan used as the anchor in the aligned image/recon sequence.
-        These two numbers also affect the list fabrication.
-
-        ref_mode: 'single', 'neighbor', 'average'
-            'single': the last images in two consecutive chunks will be
-                      compared and aligned. The fixed_img/fixed_scan_id are
-                      anchored as the last image in its chunk. The chunks are
-                      propagated to the right and left. So, the list of pairs
-                      should look like
-                      [[fixed_img, left_neighbor_chunk_last_img],
-                       [left_neighbor_chunk_last_img, its_left_neighbor],
-                       ...,
-                       [fixed_img, right_neighbor_chunk_last_img],
-                       [right_neighbor_chunk_last_img, its_right_neighbor],
-                       ...,
-                       [each_pair_in_each_chunk_with_last_img]
-                      ]
-            'neighbor': the neighbor images in two consecutive chunks will be
-                      compared and aligned. The fixed_img/fixed_scan_id are
-                      anchored as the last image in its chunk. The chunks are
-                      propagated to the right and left. So, the list of pairs
-                      should look like
-                      [[fixed_img, first_img_in_same_chunk],
-                       [first_img_in_same_chunk, its_left_neighbor],
-                       ...,
-                       [fixed_img, first_img_in_right_neighbor],
-                       [first_img_in_right_neighbor, last_img_in_its_chunk],
-                       ...,
-                       [each_pair_in_each_chunk_with_last_img]
-                      ]
-        self.alignment_pair_list: generated variable with this function. It defines
-                                  pairs of imgs for shift calculation. the idx of
-                                  each pair are relative to self.img_id_s
-        """
-        self._set_chunks()
-        self.alignment_pair_list = []
-
-        if self.use_chunk:
-            if self.ref_mode.upper() == 'SINGLE':
-                # inter-chunk alignment pair
-                for ii in range(self.left_num_chunk):
-                    self.alignment_pair_list.append([self.chunks[self.left_num_chunk-ii]['chunk_e'],
-                                                self.chunks[self.left_num_chunk-ii-1]['chunk_e']])
-                self.alignment_pair_list.append([self.anchor_chunk,
-                                            self.anchor_chunk])
-                print(self.left_num_chunk, self.num_chunk)
-                for ii in range(self.left_num_chunk+1, self.num_chunk):
-                    self.alignment_pair_list.append([self.chunks[ii-1]['chunk_e'],
-                                                self.chunks[ii]['chunk_e']])
-                # intra-chunk alignment pair
-                for ii in range(self.num_chunk):
-                    for jj in range(self.chunks[ii]['chunk_s'],
-                                    self.chunks[ii]['chunk_e']+1):
-                        self.alignment_pair_list.append([self.chunks[ii]['chunk_e'], jj])
-
-                tem = []
-                for ii in self.alignment_pair_list:
-                    if ii[0] == ii[1]:
-                        tem.append(ii)
-                for ii in tem:
-                    self.alignment_pair_list.remove(ii)
-                self.alignment_pair_list.append([self.anchor, self.anchor])
-            elif self.ref_mode.upper() == 'NEIGHBOR':
-                # inter-chunk alignment pair
-                for ii in range(self.left_num_chunk):
-                    self.alignment_pair_list.append([self.chunks[self.left_num_chunk-ii]['chunk_e'],
-                                                self.chunks[self.left_num_chunk-ii]['chunk_s']])
-                    self.alignment_pair_list.append([self.chunks[self.left_num_chunk-ii]['chunk_s'],
-                                                self.chunks[self.left_num_chunk-ii-1]['chunk_e']])
-                self.alignment_pair_list.append([self.chunks[self.anchor_chunk]['chunk_e'],
-                                            self.chunks[self.anchor_chunk]['chunk_e']+1])
-                for ii in range(self.left_num_chunk+1, self.num_chunk-1):
-                    self.alignment_pair_list.append([self.chunks[ii]['chunk_s'],
-                                                self.chunks[ii]['chunk_e']])
-                    self.alignment_pair_list.append([self.chunks[ii]['chunk_e'],
-                                                self.chunks[ii+1]['chunk_s']])
-                self.alignment_pair_list.append([self.chunks[self.num_chunk-1]['chunk_s'],
-                                            self.chunks[self.num_chunk-1]['chunk_e']])
-                # inter-chunk alignment pair
-                for ii in range(self.num_chunk):
-                    for jj in range(self.chunks[ii]['chunk_s'],
-                                    self.chunks[ii]['chunk_e']+1):
-                        self.alignment_pair_list.append([self.chunks[ii]['chunk_e'], jj])
-
-                tem = []
-                for ii in self.alignment_pair_list:
-                    if ii[0] == ii[1]:
-                        tem.append(ii)
-                for ii in tem:
-                    self.alignment_pair_list.remove(ii)
-                self.alignment_pair_list.append([self.anchor, self.anchor])
-        else:
-            for ii in range(self.data_pnts-1):
-                self.alignment_pair_list.append([ii, ii+1])
-            self.alignment_pair_list.append([self.anchor, self.anchor])
-
-    def _sort_absolute_shift(self, trialfn, shift_dict=None, optional_shift_dict=None):
-        """
-        self.shift_chain_dict: generated variables with this function. the idx
-                               each img is associated with a chain of other img
-                               idx with which the img shift is uniquely defined
-                               relative to the anchor img. all idx are relative
-                               to self.img_id_s
-
-        Parameters
-        ----------
-        trialfn : TYPE
-            DESCRIPTION.
-        shift_dict : TYPE, optional
-            DESCRIPTION. The default is None.
-        optional_shift_dict : TYPE, optional
-            DESCRIPTION. The default is None.
-
-        Returns
-        -------
-        None.
-
-        """
-        if self.data_type.upper() == "3D_XANES":
-            f = h5py.File(trialfn, 'r')
-            method = f['/trial_registration/trial_reg_parameters/reg_method'][()]
-
-            self.shift_chain_dict = {}
-            for ii in range(len(self.alignment_pair_list)-1, -1, -1):
-                self.shift_chain_dict[self.alignment_pair_list[ii][1]] = [self.alignment_pair_list[ii][0]]
-                jj = ii - 1
-                while jj>=0:
-                    if self.shift_chain_dict[self.alignment_pair_list[ii][1]][-1] == self.alignment_pair_list[jj][1]:
-                        self.shift_chain_dict[self.alignment_pair_list[ii][1]].append(self.alignment_pair_list[jj][0])
-                    jj -= 1
-            abs_shift_dict = {}
-            if method.upper() == "SR":
-                for key, item in self.shift_chain_dict.items():
-                    item.insert(0, key)
-                    shift = np.identity(3)
-                    slioff = 0
-                    for ii in range(len(item)-1):
-                        idx = self.alignment_pair_list.index([item[ii+1], item[ii]])
-                        shift = np.matmul(shift, np.array(shift_dict[str(idx)][1]))
-                        slioff += int(optional_shift_dict[str(idx)][0])
-                    abs_shift_dict[str(key).zfill(3)] = {'in_sli_shift':shift, 'out_sli_shift':slioff}
-            else:
-                for key, item in self.shift_chain_dict.items():
-                    item.insert(0, key)
-                    shift = 0.
-                    slioff = 0
-                    for ii in range(len(item)-1):
-                        idx = self.alignment_pair_list.index([item[ii+1], item[ii]])
-                        shift += np.array(shift_dict[str(idx)][1:])
-                        slioff += int(shift_dict[str(idx)][0])
-                    abs_shift_dict[str(key).zfill(3)] = {'in_sli_shift':shift, 'out_sli_shift':slioff}
-            f.close()
-        elif self.data_type.upper() == "2D_XANES":
-            f = h5py.File(trialfn, 'r')
-            method = f['/trial_registration/trial_reg_parameters/reg_method'][()]
-            self.shift_chain_dict = {}
-            for ii in range(len(self.alignment_pair_list)-1, -1, -1):
-                self.shift_chain_dict[self.alignment_pair_list[ii][1]] = [self.alignment_pair_list[ii][0]]
-                jj = ii - 1
-                while jj>=0:
-                    if self.shift_chain_dict[self.alignment_pair_list[ii][1]][-1] == self.alignment_pair_list[jj][1]:
-                        self.shift_chain_dict[self.alignment_pair_list[ii][1]].append(self.alignment_pair_list[jj][0])
-                    jj -= 1
-            abs_shift_dict = {}
-            if method.upper() == "SR":
-                for key, item in self.shift_chain_dict.items():
-                    item.insert(0, key)
-                    shift = np.identity(3)
-                    for ii in range(len(item)-1):
-                        idx = self.alignment_pair_list.index([item[ii+1], item[ii]])
-                        shift = np.matmul(shift, np.array(shift_dict[str(idx)]))
-                    abs_shift_dict[str(key).zfill(3)] = {'in_sli_shift':shift}
-            else:
-                for key, item in self.shift_chain_dict.items():
-                    item.insert(0, key)
-                    print(key, item)
-                    shift = 0.
-                    for ii in range(len(item)-1):
-                        idx = self.alignment_pair_list.index([item[ii+1], item[ii]])
-                        shift += np.array(shift_dict[str(idx)])
-                    abs_shift_dict[str(key).zfill(3)] = {'in_sli_shift':shift}
-            f.close()
-        self.abs_shift_dict = abs_shift_dict
-
-    def _chunking(self, dim, mem_lim=None):
-        img_sz = (dim[1]*dim[2]*4)
-        if mem_lim is None:
-            mem = psutil.virtual_memory()
-            mem_lim = mem.available/3.
-        mem_lim = (mem_lim//img_sz)*img_sz
-        while (dim[0]*img_sz%mem_lim)*mem_lim/img_sz < N_CPU:
-            mem_lim += N_CPU*img_sz
-        num_img_in_batch = np.round(mem_lim/img_sz/N_CPU)*N_CPU
-        num_batch = int(np.ceil(dim[0]/num_img_in_batch))
-        bdi = []
-        chunk = int(np.round(num_img_in_batch/N_CPU))
-        for ii in range(num_batch):
-            if ii < num_batch-1:
-                for jj in range(N_CPU):
-                    bdi.append(int(ii*num_img_in_batch + jj*chunk))
-            else:
-                chunk = int(np.ceil((dim[0] - ii*num_img_in_batch)/N_CPU))
-                for jj in range(N_CPU+1):
-                    bdi.append(int(ii*num_img_in_batch + jj*chunk))
-                bdi[-1] = min(dim[0], bdi[-1])
-        return bdi, num_batch
+        if self.data_type == "3D_XANES":
+            self.anchor_id = self.xanes3D_scn_ids[self.anchor_loc]
+            cnt = 0
+            for ii in self.xanes3D_scn_ids:
+                self.eng_dict[str(cnt).zfill(3)] = self.eng_list[cnt]
+                self.im_ids_dict[str(cnt).zfill(3)] = ii
+                cnt += 1
+        elif self.data_type == "2D_XANES":
+            cnt = 0
+            for ii in range(self.im_id_s, self.im_id_e):
+                self.eng_dict[str(cnt).zfill(3)] = self.eng_list[cnt]
+                self.im_ids_dict[str(cnt).zfill(3)] = ii
+                cnt += 1
 
     def reg_xanes2D_chunk(self, overlap_ratio=0.3):
         """
         chunk_sz: int, number of image in one chunk for alignment; each chunk
                   use the last image in that chunk as reference
         method:   str
                   'PC':   skimage.feature.register_translation
@@ -537,642 +195,1016 @@
         overlap_ratio: float, overlap_ratio for method == 'MPC'
         ref_mode: str, control how inter-chunk alignment is done
                   'average': the average of each chunk after intra-chunk
                              re-alignment is used for inter-chunk alignment
                   'single':  the last image in each chunk is used in
                              inter-chunk alignment
 
-        imgs in self.img are registered relative to anchor img. self.img
-        is the sub stack with self.img_id_s as its first image, and self.img_id_e
+        imgs in self.im are registered relative to anchor img. self.im
+        is the sub stack with self.im_id_s as its first image, and self.im_id_e
         as the last.
         """
-        self.overlap_ratio = overlap_ratio
-        self._alignment_scheduler(dtype='2D_XANES')
+        self.mpc_ovlp_r = overlap_ratio
 
-        if not os.path.exists(self.save_path):
-            os.makedirs(self.save_path, mode=777)
-            print(f'2. The registration results will be saved in {self.savefn}')
-
-        f = h5py.File(self.savefn, 'a')
-        if 'trial_registration' not in f:
-            g0 = f.create_group('trial_registration')
+        self.algn_pair_lst = regtools.alignment_scheduler(
+            self.data_pnts,
+            self.anchor_loc,
+            self.chunk_sz,
+            use_chnk=self.use_chunk,
+            ref_mode=self.ref_mode,
+        )
+
+        if not os.path.exists(self.sav_dir):
+            os.makedirs(self.sav_dir, mode=777)
+            print(f"2. The registration results will be saved in {self.sav_fn}")
+
+        f = h5py.File(self.sav_fn, "a")
+        if "trial_registration" not in f:
+            g0 = f.create_group("trial_registration")
         else:
-            del f['trial_registration']
-            g0 = f.create_group('trial_registration')
+            del f["trial_registration"]
+            g0 = f.create_group("trial_registration")
 
-        g1 = g0.create_group('trial_reg_results')
-        g2 = g0.create_group('trial_reg_parameters')
+        g1 = g0.create_group("trial_reg_results")
+        g2 = g0.create_group("trial_reg_parameters")
 
-        g2.create_dataset('reg_method', data=str(self.method.upper()))
-        g2.create_dataset('reg_ref_mode', data=str(self.ref_mode.upper()))
-        g2.create_dataset('use_smooth_img', data=str(self.use_smooth_img))
-        g2.create_dataset('img_smooth_sigma', data=self.img_smooth_sigma)
-
-        g2.create_dataset('alignment_pairs', data=self.alignment_pair_list)
-        g2.create_dataset('scan_ids', data=self.img_ids)
-        g2.create_dataset('use_chunk', data=str(self.use_chunk))
-        g2.create_dataset('chunk_sz', data=self.chunk_sz)
-        g2.create_dataset('fixed_scan_id', data=self.anchor_id)
-        g2.create_dataset('slice_roi', data=self.roi)
-        g2.create_dataset('eng_list', data=self.eng_list)
-        dicttoh5(self.eng_dict, self.savefn, mode='a',
-                 overwrite_data=True,
-                 h5path='/trial_registration/trial_reg_parameters/eng_dict')
-        dicttoh5(self.img_ids_dict, self.savefn, mode='a',
-                 overwrite_data=True,
-                 h5path='/trial_registration/trial_reg_parameters/scan_ids_dict')
-        g2.create_dataset('use_mask', data=str(self.use_mask))
-        g2.create_dataset('mask_thres', data=self.mask_thres)
+        g2.create_dataset("reg_method", data=str(self.reg_alg.upper()))
+        g2.create_dataset("reg_ref_mode", data=str(self.ref_mode.upper()))
+        g2.create_dataset("use_smooth_img", data=str(self.use_smth_im))
+        g2.create_dataset("img_smooth_sigma", data=self.smth_im_sig)
+
+        g2.create_dataset("alignment_pairs", data=self.algn_pair_lst)
+        g2.create_dataset("scan_ids", data=self.xanes3D_scn_ids)
+        g2.create_dataset("use_chunk", data=str(self.use_chunk))
+        g2.create_dataset("chunk_sz", data=self.chunk_sz)
+        g2.create_dataset("fixed_scan_id", data=self.anchor_loc)
+        g2.create_dataset("slice_roi", data=self.im_roi)
+        g2.create_dataset("eng_list", data=self.eng_list)
+        dicttoh5(
+            self.eng_dict,
+            self.sav_fn,
+            mode="a",
+            update_mode="replace",
+            h5path="/trial_registration/trial_reg_parameters/eng_dict",
+        )
+        dicttoh5(
+            self.im_ids_dict,
+            self.sav_fn,
+            mode="a",
+            update_mode="replace",
+            h5path="/trial_registration/trial_reg_parameters/scan_ids_dict",
+        )
+        g2.create_dataset("use_mask", data=str(self.use_mask))
+        g2.create_dataset("mask_thres", data=self.mask_thres)
         if self.use_mask:
-            g2.create_dataset('mask', data=self.mask)
+            g2.create_dataset("mask", data=self.msk)
 
-        g3 = g0.create_group('data_directory_info')
+        g3 = g0.create_group("data_directory_info")
         for key, val in self.raw_data_info.items():
             g3.create_dataset(key, data=val)
 
-        shifted_image = np.ndarray(self.img.shape)
+        shifted_image = np.ndarray(self.im.shape)
 
-        if self.img.ndim != 3:
-                print('XANES2D image stack is required. Please set XANES2D \
-                      image stack first.')
+        if self.im.ndim != 3:
+            print(
+                "XANES2D image stack is required. Please set XANES2D \
+                      image stack first."
+            )
         else:
-            if self.method.upper() in {'PC', 'MPC', 'MRTV', 'LS+MRTV', 'MPC+MRTV'}:
-                self.shift = np.ndarray([len(self.alignment_pair_list), 2])
+            if self.reg_alg.upper() in {"PC", "MPC", "MRTV", "LS+MRTV", "MPC+MRTV"}:
+                self.shift = np.ndarray([len(self.algn_pair_lst), 2])
             else:
-                self.shift = np.ndarray([len(self.alignment_pair_list), 3, 3])
-
-            self.error = np.ndarray(len(self.alignment_pair_list))
-            self.si = np.ndarray(len(self.alignment_pair_list))
-            self.mse = np.ndarray(len(self.alignment_pair_list))
-            self.nrmse = np.ndarray(len(self.alignment_pair_list))
+                self.shift = np.ndarray([len(self.algn_pair_lst), 3, 3])
 
-            if self.method.upper() == 'PC':
+            self.error = np.ndarray(len(self.algn_pair_lst))
+            if self.reg_alg.upper() == "PC":
                 print('We are using "phase correlation" method for registration.')
-                for ii in range(len(self.alignment_pair_list)):
+                for ii in range(len(self.algn_pair_lst)):
                     self.shift[ii], self.error[ii], _ = phase_cross_correlation(
-                            self.img[self.alignment_pair_list[ii][0]],
-                            self.img[self.alignment_pair_list[ii][1]], upsample_factor=100)
-                    shifted_image[ii] = np.real(np.fft.ifftn(fourier_shift(
-                            np.fft.fftn(self.img[self.alignment_pair_list[ii][1]]), self.shift[ii])))[:]
+                        self.im[self.algn_pair_lst[ii][0]],
+                        self.im[self.algn_pair_lst[ii][1]],
+                        upsample_factor=100,
+                    )
+                    shifted_image[ii] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(self.im[self.algn_pair_lst[ii][1]]),
+                                self.shift[ii],
+                            )
+                        )
+                    )[:]
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                       data=self.shift[ii])
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                       data=shifted_image[ii])
-                    g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                       data=self.img[self.alignment_pair_list[ii][0]])
-            elif self.method.upper() == 'MPC':
-                print('We are using "masked phase correlation" method for registration.')
-                for ii in range(len(self.alignment_pair_list)):
-                    self.shift[ii] = phase_cross_correlation(self.img[self.alignment_pair_list[ii][0]],
-                                                             self.img[self.alignment_pair_list[ii][1]],
-                                                             reference_mask=self.mask,
-                                                             overlap_ratio=self.overlap_ratio)
-                    shifted_image[ii] = np.real(np.fft.ifftn(fourier_shift(
-                            np.fft.fftn(self.img[self.alignment_pair_list[ii][1]]), self.shift[ii])))[:]
+                    g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                    g11.create_dataset(
+                        "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                    )
+                    g11.create_dataset(
+                        "trial_reg_fixed" + str(ii).zfill(3),
+                        data=self.im[self.algn_pair_lst[ii][0]],
+                    )
+            elif self.reg_alg.upper() == "MPC":
+                print(
+                    'We are using "masked phase correlation" method for registration.'
+                )
+                for ii in range(len(self.algn_pair_lst)):
+                    self.shift[ii] = phase_cross_correlation(
+                        self.im[self.algn_pair_lst[ii][0]],
+                        self.im[self.algn_pair_lst[ii][1]],
+                        reference_mask=self.msk,
+                        overlap_ratio=self.mpc_ovlp_r,
+                    )
+                    shifted_image[ii] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(self.im[self.algn_pair_lst[ii][1]]),
+                                self.shift[ii],
+                            )
+                        )
+                    )[:]
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                       data=self.shift[ii])
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                       data=shifted_image[ii])
-                    g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                       data=self.img[self.alignment_pair_list[ii][0]])
-            elif self.method.upper() == 'SR':
+                    g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                    g11.create_dataset(
+                        "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                    )
+                    g11.create_dataset(
+                        "trial_reg_fixed" + str(ii).zfill(3),
+                        data=self.im[self.algn_pair_lst[ii][0]],
+                    )
+            elif self.reg_alg.upper() == "SR":
                 print('We are using "stack registration" method for registration.')
-                if self.mode.upper() == 'TRANSLATION':
+                if self.sr_mode.upper() == "TRANSLATION":
                     sr = StackReg(StackReg.TRANSLATION)
-                elif  self.mode.upper() == 'RIGID_BODY':
+                elif self.sr_mode.upper() == "RIGID_BODY":
                     sr = StackReg(StackReg.RIGID_BODY)
-                elif  self.mode.upper() == 'SCALED_ROTATION':
+                elif self.sr_mode.upper() == "SCALED_ROTATION":
                     sr = StackReg(StackReg.SCALED_ROTATION)
-                elif  self.mode.upper() == 'AFFINE':
+                elif self.sr_mode.upper() == "AFFINE":
                     sr = StackReg(StackReg.AFFINE)
-                elif  self.mode.upper() == 'BILINEAR':
+                elif self.sr_mode.upper() == "BILINEAR":
                     sr = StackReg(StackReg.BILINEAR)
 
-                if self.mask is not None:
-                    for ii in range(len(self.alignment_pair_list)):
-                        self.shift[ii] = sr.register(self.img[self.alignment_pair_list[ii][0]]*self.mask,
-                                                     self.img[self.alignment_pair_list[ii][1]]*self.mask)
-                        shifted_image[ii] = sr.transform(self.img[self.alignment_pair_list[ii][1]],
-                                                                               tmat=self.shift[ii])[:]
+                if self.msk is not None:
+                    for ii in range(len(self.algn_pair_lst)):
+                        self.shift[ii] = sr.register(
+                            self.im[self.algn_pair_lst[ii][0]] * self.msk,
+                            self.im[self.algn_pair_lst[ii][1]] * self.msk,
+                        )
+                        shifted_image[ii] = sr.transform(
+                            self.im[self.algn_pair_lst[ii][1]], tmat=self.shift[ii]
+                        )[:]
                         g11 = g1.create_group(str(ii).zfill(3))
-                        g11.create_dataset('shift'+str(ii).zfill(3),
-                                           data=self.shift[ii])
-                        g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                           data=shifted_image[ii])
-                        g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                           data=self.img[self.alignment_pair_list[ii][0]])
+                        g11.create_dataset(
+                            "shift" + str(ii).zfill(3), data=self.shift[ii]
+                        )
+                        g11.create_dataset(
+                            "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                        )
+                        g11.create_dataset(
+                            "trial_reg_fixed" + str(ii).zfill(3),
+                            data=self.im[self.algn_pair_lst[ii][0]],
+                        )
                 else:
-                    for ii in range(len(self.alignment_pair_list)):
-                        self.shift[ii] = sr.register(self.img[self.alignment_pair_list[ii][0]],
-                                                     self.img[self.alignment_pair_list[ii][1]])
-                        shifted_image[ii] = sr.transform(self.img[self.alignment_pair_list[ii][1]],
-                                                                               tmat=self.shift[ii])[:]
+                    for ii in range(len(self.algn_pair_lst)):
+                        self.shift[ii] = sr.register(
+                            self.im[self.algn_pair_lst[ii][0]],
+                            self.im[self.algn_pair_lst[ii][1]],
+                        )
+                        shifted_image[ii] = sr.transform(
+                            self.im[self.algn_pair_lst[ii][1]], tmat=self.shift[ii]
+                        )[:]
                         g11 = g1.create_group(str(ii).zfill(3))
-                        g11.create_dataset('shift'+str(ii).zfill(3),
-                                           data=self.shift[ii])
-                        g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                           data=shifted_image[ii])
-                        g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                           data=self.img[self.alignment_pair_list[ii][0]])
-            elif self.method.upper() == 'MRTV':
-                print('We are using "multi-resolution total variation" method for registration.')
-                print(self.alg_mrtv_sp_wz, self.alg_mrtv_sp_kernel)
-                pxl_conf = {'type': 'area',
-                            'levs': self.alg_mrtv_level,
-                            'wz': self.alg_mrtv_width,
-                            'lsw': 10}
-                sub_conf = {'use': True,
-                            'type': 'ana',
-                            'sp_wz': self.alg_mrtv_sp_wz,
-                            'sp_us': 10}
-                with mp.get_context('spawn').Pool(N_CPU) as pool:
-                    rlt = pool.map(partial(mrtv_reg, pxl_conf, sub_conf, None, self.alg_mrtv_sp_kernel),
-                                   [[self.img[self.alignment_pair_list[ii][0]],
-                                    self.img[self.alignment_pair_list[ii][1]]]
-                                   for ii in range(len(self.alignment_pair_list))])
+                        g11.create_dataset(
+                            "shift" + str(ii).zfill(3), data=self.shift[ii]
+                        )
+                        g11.create_dataset(
+                            "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                        )
+                        g11.create_dataset(
+                            "trial_reg_fixed" + str(ii).zfill(3),
+                            data=self.im[self.algn_pair_lst[ii][0]],
+                        )
+            elif self.reg_alg.upper() == "MRTV":
+                print(
+                    'We are using "multi-resolution total variation" method for registration.'
+                )
+                print(f"{self.mrtv_sp_wz=}\n{self.mrtv_smth_knl=}")
+                print(f"{len(self.algn_pair_lst)=}")
+
+                cfg = {"mrtv": {}}
+                cfg["mrtv"]["pxl_conf"] = {
+                    "type": "area",
+                    "levs": self.mrtv_lvl,
+                    "wz": self.mrtv_wz,
+                    "lsw": 10,
+                }
+                cfg["mrtv"]["sub_conf"] = {
+                    "use": True,
+                    "type": "ana",
+                    "sp_wz": self.mrtv_sp_wz,
+                    "sp_us": 10,
+                }
+                cfg["mrtv"]["smth_krnl"] = self.mrtv_smth_knl
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        partial(mrtv_reg, cfg["mrtv"], None),
+                        [
+                            [
+                                self.im[self.algn_pair_lst[ii][0]],
+                                self.im[self.algn_pair_lst[ii][1]],
+                            ]
+                            for ii in range(len(self.algn_pair_lst))
+                        ],
+                    )
                 pool.close()
                 pool.join()
 
                 for ii in range(len(rlt)):
                     self.shift[ii] = rlt[ii][3]
-                del(rlt)
+                del rlt
                 gc.collect()
 
-                for ii in range(len(self.alignment_pair_list)):
-                    shifted_image[ii] = np.real(np.fft.ifftn(fourier_shift(
-                            np.fft.fftn(self.img[self.alignment_pair_list[ii][1]]), self.shift[ii])))[:]
+                for ii in range(len(self.algn_pair_lst)):
+                    shifted_image[ii] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(self.im[self.algn_pair_lst[ii][1]]),
+                                self.shift[ii],
+                            )
+                        )
+                    )[:]
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                        data=self.shift[ii])
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                        data=shifted_image[ii])
-                    g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                        data=self.img[self.alignment_pair_list[ii][0]])
-            elif self.method.upper() == 'LS+MRTV':
-                print('We are using "line search and multi-resolution total variation" method for registration.')
-                with mp.get_context('spawn').Pool(N_CPU) as pool:
-                    rlt = pool.map(partial(mrtv_ls_combo_reg, self.alg_mrtv_width, 2, 10,
-                                           self.alg_mrtv_sp_wz, self.alg_mrtv_sp_wz),
-                                   [[self.img[self.alignment_pair_list[ii][0]],
-                                     self.img[self.alignment_pair_list[ii][1]]]
-                                    for ii in range(len(self.alignment_pair_list))])
+                    g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                    g11.create_dataset(
+                        "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                    )
+                    g11.create_dataset(
+                        "trial_reg_fixed" + str(ii).zfill(3),
+                        data=self.im[self.algn_pair_lst[ii][0]],
+                    )
+            elif self.reg_alg.upper() == "LS+MRTV":
+                print(
+                    'We are using "line search and multi-resolution total variation" method for registration.'
+                )
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        partial(
+                            mrtv_ls_combo_reg,
+                            self.mrtv_wz,
+                            2,
+                            10,
+                            self.mrtv_sp_wz,
+                            self.mrtv_sp_wz,
+                        ),
+                        [
+                            [
+                                self.im[self.algn_pair_lst[ii][0]],
+                                self.im[self.algn_pair_lst[ii][1]],
+                            ]
+                            for ii in range(len(self.algn_pair_lst))
+                        ],
+                    )
                 pool.close()
                 pool.join()
 
                 for ii in range(len(rlt)):
                     self.shift[ii] = rlt[ii][3]
-                del(rlt)
+                del rlt
                 gc.collect()
 
-                for ii in range(len(self.alignment_pair_list)):
-                    shifted_image[ii] = np.real(np.fft.ifftn(fourier_shift(
-                            np.fft.fftn(self.img[self.alignment_pair_list[ii][1]]), self.shift[ii])))[:]
+                for ii in range(len(self.algn_pair_lst)):
+                    shifted_image[ii] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(self.im[self.algn_pair_lst[ii][1]]),
+                                self.shift[ii],
+                            )
+                        )
+                    )[:]
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                        data=self.shift[ii])
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                        data=shifted_image[ii])
-                    g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                        data=self.img[self.alignment_pair_list[ii][0]])
-            elif self.method.upper() == 'MPC+MRTV':
-                print('We are using combo of "masked phase correlation" and "multi-resolution total variation" method for registration.')
-                for ii in range(len(self.alignment_pair_list)):
-                    _, _, _, self.shift[ii] = mrtv_mpc_combo_reg(self.img[self.alignment_pair_list[ii][0]],
-                                                                 self.img[self.alignment_pair_list[ii][1]],
-                                                                 reference_mask=self.mask,
-                                                                 overlap_ratio=self.overlap_ratio,
-                                                                 levs=self.alg_mrtv_level,
-                                                                 wz=self.alg_mrtv_width,
-                                                                 sp_wz=self.alg_mrtv_sp_wz,
-                                                                 sp_step=self.alg_mrtv_sp_wz)
-                    shifted_image[ii] = np.real(np.fft.ifftn(fourier_shift(
-                            np.fft.fftn(self.img[self.alignment_pair_list[ii][1]]), self.shift[ii])))[:]
+                    g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                    g11.create_dataset(
+                        "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                    )
+                    g11.create_dataset(
+                        "trial_reg_fixed" + str(ii).zfill(3),
+                        data=self.im[self.algn_pair_lst[ii][0]],
+                    )
+            elif self.reg_alg.upper() == "MPC+MRTV":
+                print(
+                    'We are using combo of "masked phase correlation" and "multi-resolution total variation" method for registration.'
+                )
+                for ii in range(len(self.algn_pair_lst)):
+                    _, _, _, self.shift[ii] = mrtv_mpc_combo_reg(
+                        self.im[self.algn_pair_lst[ii][0]],
+                        self.im[self.algn_pair_lst[ii][1]],
+                        reference_mask=self.msk,
+                        overlap_ratio=self.mpc_ovlp_r,
+                        levs=self.mrtv_lvl,
+                        wz=self.mrtv_wz,
+                        sp_wz=self.mrtv_sp_wz,
+                        sp_step=self.mrtv_sp_wz,
+                    )
+                    shifted_image[ii] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(self.im[self.algn_pair_lst[ii][1]]),
+                                self.shift[ii],
+                            )
+                        )
+                    )[:]
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                        data=self.shift[ii])
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                        data=shifted_image[ii])
-                    g11.create_dataset('trial_reg_fixed'+str(ii).zfill(3),
-                                        data=self.img[self.alignment_pair_list[ii][0]])
+                    g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                    g11.create_dataset(
+                        "trial_reg_img" + str(ii).zfill(3), data=shifted_image[ii]
+                    )
+                    g11.create_dataset(
+                        "trial_reg_fixed" + str(ii).zfill(3),
+                        data=self.im[self.algn_pair_lst[ii][0]],
+                    )
         f.close()
-        print('Done!')
+        print("Done!")
 
-    def apply_xanes2D_chunk_shift(self, optional_shift_dict, trialfn=None, savefn=None):
+    def apply_xanes2D_chunk_shift(self, shift_dict):
         """
         trialfn:    string; optional
                     trial registration filename
         savefn:     string; optional
                     filename to the file in which the shifted volume to be saved
         optional_shift_dict: dict; optional
                     user input shifts for specified scan ids. This is useful to
                     correct individual pairs that cannot be aligned with others
                     with the same registration method
         """
-        if savefn is None:
-            savefn = self.savefn
-        if trialfn is None:
-            trialfn = self.savefn
-
-        if savefn == trialfn:
-            with h5py.File(savefn, 'a') as f:
-                if 'registration_results' not in f:
-                    g0 = f.create_group('registration_results')
-                else:
-                    del f['registration_results']
-                    g0 = f.create_group('registration_results')
-
-                g1 = g0.create_group('reg_parameters')
-                self.alignment_pair_list = f['/trial_registration/trial_reg_parameters/alignment_pairs'][:].tolist()
-                g1.create_dataset('alignment_pairs', data=self.alignment_pair_list)
-                self.img_ids = f['/trial_registration/trial_reg_parameters/scan_ids'][:]
-                g1.create_dataset('scan_ids', data=self.img_ids)
-                g1.create_dataset('slice_roi', data=self.roi)
-                self.anchor_id = f['/trial_registration/trial_reg_parameters/fixed_scan_id'][()]
-                g1.create_dataset('fixed_scan_id', data=self.anchor_id)
-                self.chunk_sz = f['/trial_registration/trial_reg_parameters/chunk_sz'][()]
-                g1.create_dataset('chunk_sz', data=self.chunk_sz)
-                self.method = f['/trial_registration/trial_reg_parameters/reg_method'][()].decode('ascii')
-                g1.create_dataset('reg_method', data=self.method)
-                self.ref_mode = f['/trial_registration/trial_reg_parameters/reg_ref_mode'][()].decode('ascii')
-                g1.create_dataset('reg_ref_mode', data=str(self.ref_mode.upper()))
-                self.img_ids_dict = h5todict(savefn, path='/trial_registration/trial_reg_parameters/scan_ids_dict')
-                self.eng_dict = h5todict(savefn, path='/trial_registration/trial_reg_parameters/eng_dict')
-                dicttoh5(self.eng_dict, savefn, mode='a',
-                     overwrite_data=True,
-                     h5path='/registration_results/reg_parameters/eng_dict')
-                dicttoh5(self.img_ids_dict, savefn, mode='a',
-                     overwrite_data=True,
-                     h5path='/registration_results/reg_parameters/scan_ids_dict')
-
-                dicttoh5(optional_shift_dict, savefn, mode='a', overwrite_data=True,
-                         h5path='/registration_results/reg_parameters/user_determined_shift/relative_shift')
-
-                self._sort_absolute_shift(trialfn, shift_dict=optional_shift_dict)
-
-                shift = {}
-                for key, item in self.abs_shift_dict.items():
-                    shift[key] = item['in_sli_shift']
-
-                dicttoh5(shift, savefn, mode='a',
-                         overwrite_data=True,
-                         h5path='/registration_results/reg_parameters/user_determined_shift/absolute_shift')
-
-                g2 = g0.create_group('reg_results')
-                g21 = g2.create_dataset('registered_xanes2D',
-                                        shape=(len(self.img_ids_dict),
-                                               self.roi[1]-self.roi[0],
-                                               self.roi[3]-self.roi[2]))
-                g22 = g2.create_dataset('eng_list', shape=(len(self.img_ids_dict),))
-
-                cnt1 = 0
-                for key in sorted(self.abs_shift_dict.keys()):
-                    shift = self.abs_shift_dict[key]['in_sli_shift']
-                    self._translate_single_img(self.img[int(key)], shift, self.method)
-                    g21[cnt1] = self.img[int(key)][self.roi[0]:self.roi[1],
-                                                   self.roi[2]:self.roi[3]]
-                    g22[cnt1] = self.eng_dict[key]
-                    cnt1 += 1
+        with h5py.File(self.sav_fn, "a") as f:
+            if "registration_results" not in f:
+                g0 = f.create_group("registration_results")
+            else:
+                del f["registration_results"]
+                g0 = f.create_group("registration_results")
+
+            g1 = g0.create_group("reg_parameters")
+            self.algn_pair_lst = f[
+                "/trial_registration/trial_reg_parameters/alignment_pairs"
+            ][:].tolist()
+            g1.create_dataset("alignment_pairs", data=self.algn_pair_lst)
+            self.xanes3D_scn_ids = f[
+                "/trial_registration/trial_reg_parameters/scan_ids"
+            ][:]
+            g1.create_dataset("scan_ids", data=self.xanes3D_scn_ids)
+            g1.create_dataset("slice_roi", data=self.im_roi)
+            self.anchor_loc = f[
+                "/trial_registration/trial_reg_parameters/fixed_scan_id"
+            ][()]
+            g1.create_dataset("fixed_scan_id", data=self.anchor_loc)
+            self.chunk_sz = f["/trial_registration/trial_reg_parameters/chunk_sz"][()]
+            g1.create_dataset("chunk_sz", data=self.chunk_sz)
+            self.reg_alg = f["/trial_registration/trial_reg_parameters/reg_method"][
+                ()
+            ].decode("utf-8")
+            g1.create_dataset("reg_method", data=self.reg_alg)
+            self.ref_mode = f["/trial_registration/trial_reg_parameters/reg_ref_mode"][
+                ()
+            ].decode("utf-8")
+            g1.create_dataset("reg_ref_mode", data=str(self.ref_mode.upper()))
+            self.im_ids_dict = h5todict(
+                self.sav_fn,
+                path="/trial_registration/trial_reg_parameters/scan_ids_dict",
+            )
+            self.eng_dict = h5todict(
+                self.sav_fn, path="/trial_registration/trial_reg_parameters/eng_dict"
+            )
+            dicttoh5(
+                self.eng_dict,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/eng_dict",
+            )
+            dicttoh5(
+                self.im_ids_dict,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/scan_ids_dict",
+            )
+
+            dicttoh5(
+                shift_dict,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/user_determined_shift/relative_shift",
+            )
+
+            (self.abs_shift_dict, self.shift_chain_dict) = regtools.sort_absolute_shift(
+                self.algn_pair_lst,
+                shft_dict=shift_dict,
+                data_type="2D_XANES",
+                reg_alg=self.reg_alg,
+            )
+
+            shift = {}
+            for key, item in self.abs_shift_dict.items():
+                shift[key] = item["in_sli_shift"]
+
+            dicttoh5(
+                shift,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/user_determined_shift/absolute_shift",
+            )
+
+            g2 = g0.create_group("reg_results")
+            g21 = g2.create_dataset(
+                "registered_xanes2D",
+                shape=(
+                    len(self.im_ids_dict),
+                    self.im_roi[1] - self.im_roi[0],
+                    self.im_roi[3] - self.im_roi[2],
+                ),
+            )
+            g22 = g2.create_dataset("eng_list", shape=(len(self.im_ids_dict),))
+
+            cnt1 = 0
+            for key in sorted(self.abs_shift_dict.keys()):
+                shift = self.abs_shift_dict[key]["in_sli_shift"]
+                regtools.translate_single_img(
+                    shift, self.reg_alg, self.sr_mode, self.im[int(key)]
+                )
+                g21[cnt1] = self.im[int(key)][
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
+                g22[cnt1] = self.eng_dict[key]
+                cnt1 += 1
 
     def reg_xanes3D_chunk(self):
         """
         This function will align 3D XANES reconstructions chunk by chunk. Each
         3D dataset in each chunk will be aligned to the last dataset in the
         same chunk. Different chunks will be aligned in three different
         manners: 'single', 'neighbor', and 'average'.
         One way to do it is to make a checking order list according to the
         user input. The list is composed of a sequence of pairs. The alignment
         will be applied on each pair. A scheduler is therefore needed for this
         purpose.
 
         """
-        fn = self.xanes3D_recon_path_template.format(self.img_ids[self.anchor],
-                                                      str(self.xanes3D_recon_fixed_sli).zfill(5))
-        self.fixed = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
-        img = np.ndarray([2*self.xanes3D_sli_search_half_range,
-                          self.roi[1]-self.roi[0],
-                          self.roi[3]-self.roi[2]])
-        self._alignment_scheduler(dtype='3D_XANES')
-
-        sli_s = self.xanes3D_recon_fixed_sli-self.xanes3D_sli_search_half_range
-        sli_e = self.xanes3D_recon_fixed_sli+self.xanes3D_sli_search_half_range
-
-        f = h5py.File(self.savefn, 'a')
-        if 'trial_registration' not in f:
-            g0 = f.create_group('trial_registration')
+        fn = self.xanes3D_rec_path_tplt.format(
+            self.xanes3D_scn_ids[self.anchor_loc],
+            str(self.xanes3D_fixed_ref_sli).zfill(5),
+        )
+        self.ref_im = tifffile.imread(fn)[
+            self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+        ]
+        img = np.ndarray(
+            [
+                2 * self.xanes3D_sli_srch_half_range,
+                self.im_roi[1] - self.im_roi[0],
+                self.im_roi[3] - self.im_roi[2],
+            ]
+        )
+
+        self.algn_pair_lst = regtools.alignment_scheduler(
+            self.data_pnts,
+            self.anchor_loc,
+            self.chunk_sz,
+            use_chnk=self.use_chunk,
+            ref_mode=self.ref_mode,
+        )
+
+        sli_s = self.xanes3D_fixed_ref_sli - self.xanes3D_sli_srch_half_range
+        sli_e = self.xanes3D_fixed_ref_sli + self.xanes3D_sli_srch_half_range
+
+        f = h5py.File(self.sav_fn, "a")
+        if "trial_registration" not in f:
+            g0 = f.create_group("trial_registration")
         else:
-            del f['trial_registration']
-            g0 = f.create_group('trial_registration')
-
+            del f["trial_registration"]
+            g0 = f.create_group("trial_registration")
 
-        g1 = g0.create_group('trial_reg_results')
+        g1 = g0.create_group("trial_reg_results")
 
-        g2 = g0.create_group('trial_reg_parameters')
-        g2.create_dataset('reg_method', data=str(self.method.upper()))
-        g2.create_dataset('reg_ref_mode', data=str(self.ref_mode.upper()))
-        g2.create_dataset('use_smooth_img', data=str(self.use_smooth_img))
-        g2.create_dataset('img_smooth_sigma', data=self.img_smooth_sigma)
-
-        g2.create_dataset('alignment_pairs', data=self.alignment_pair_list)
-        g2.create_dataset('scan_ids', data=self.img_ids)
-        g2.create_dataset('use_chunk', data=str(self.use_chunk))
-        g2.create_dataset('chunk_sz', data=self.chunk_sz)
-        g2.create_dataset('fixed_scan_id', data=self.anchor_id)
-        g2.create_dataset('slice_roi', data=self.roi)
-        g2.create_dataset('fixed_slice', data=self.xanes3D_recon_fixed_sli)
-        g2.create_dataset('sli_search_half_range',
-                          data=self.xanes3D_sli_search_half_range)
-        g2.create_dataset('eng_list', data=self.eng_list)
-        g2.create_dataset('use_mask', data=self.use_mask)
+        g2 = g0.create_group("trial_reg_parameters")
+        g2.create_dataset("reg_method", data=str(self.reg_alg.upper()))
+        g2.create_dataset("reg_ref_mode", data=str(self.ref_mode.upper()))
+        g2.create_dataset("use_smooth_img", data=str(self.use_smth_im))
+        g2.create_dataset("img_smooth_sigma", data=self.smth_im_sig)
+
+        g2.create_dataset("alignment_pairs", data=self.algn_pair_lst)
+        g2.create_dataset("scan_ids", data=self.xanes3D_scn_ids)
+        g2.create_dataset("use_chunk", data=str(self.use_chunk))
+        g2.create_dataset("chunk_sz", data=self.chunk_sz)
+        g2.create_dataset("fixed_scan_id", data=self.anchor_id)
+        g2.create_dataset("slice_roi", data=self.im_roi)
+        g2.create_dataset("fixed_slice", data=self.xanes3D_fixed_ref_sli)
+        g2.create_dataset(
+            "sli_search_half_range", data=self.xanes3D_sli_srch_half_range
+        )
+        g2.create_dataset("eng_list", data=self.eng_list)
+        g2.create_dataset("use_mask", data=self.use_mask)
         if self.use_mask:
-            g2.create_dataset('mask', data=self.mask)
-            g2.create_dataset('mask_thres', data=self.mask_thres)
+            g2.create_dataset("mask", data=self.msk)
+            g2.create_dataset("mask_thres", data=self.mask_thres)
         else:
-            g2.create_dataset('mask', data=str(self.mask))
-            g2.create_dataset('mask_thres', data=self.mask_thres)
+            g2.create_dataset("mask", data=str(self.msk))
+            g2.create_dataset("mask_thres", data=self.mask_thres)
 
-        dicttoh5(self.eng_dict, self.savefn, mode='a',
-                 overwrite_data=True,
-                 h5path='/trial_registration/trial_reg_parameters/eng_dict')
-        dicttoh5(self.img_ids_dict, self.savefn, mode='a',
-                 overwrite_data=True,
-                 h5path='/trial_registration/trial_reg_parameters/scan_ids_dict')
-
-        g3 = g0.create_group('data_directory_info')
-        tem = ''
-        for ii in self.xanes3D_recon_path_template.split('/')[:-2]:
+        dicttoh5(
+            self.eng_dict,
+            self.sav_fn,
+            mode="a",
+            update_mode="replace",
+            h5path="/trial_registration/trial_reg_parameters/eng_dict",
+        )
+        dicttoh5(
+            self.im_ids_dict,
+            self.sav_fn,
+            mode="a",
+            update_mode="replace",
+            h5path="/trial_registration/trial_reg_parameters/scan_ids_dict",
+        )
+
+        g3 = g0.create_group("data_directory_info")
+        tem = ""
+        for ii in self.xanes3D_rec_path_tplt.split("/")[:-2]:
             tem = os.path.join(tem, ii)
-        g3.create_dataset('raw_h5_top_dir', data=self.xanes3D_raw_h5_top_dir)
-        g3.create_dataset('recon_top_dir', data=tem)
-        g3.create_dataset('recon_path_template', data=self.xanes3D_recon_path_template)
+        g3.create_dataset("raw_h5_top_dir", data=self.xanes3D_raw_h5_top_dir)
+        g3.create_dataset("recon_top_dir", data=tem)
+        g3.create_dataset("recon_path_template", data=self.xanes3D_rec_path_tplt)
         for key, val in self.raw_data_info.items():
             try:
                 g3.create_dataset(key, data=val)
             except:
                 pass
 
-        if self.method.upper() in {'PC', 'MPC', 'MRTV', 'LS+MRTV', 'MPC+MRTV'}:
-            self.shift = np.ndarray([len(self.alignment_pair_list),
-                                     2*self.xanes3D_sli_search_half_range,
-                                     2])
+        if self.reg_alg.upper() in {
+            "PC",
+            "MPC",
+            "MRTV",
+            "RIG-MRTV",
+            "LS+MRTV",
+            "MPC+MRTV",
+        }:
+            self.shift = np.ndarray(
+                [len(self.algn_pair_lst), 2 * self.xanes3D_sli_srch_half_range, 2]
+            )
         else:
-            self.shift = np.ndarray([len(self.alignment_pair_list),
-                                     2*self.xanes3D_sli_search_half_range,
-                                     3,
-                                     3])
-        self.error = np.ndarray([len(self.alignment_pair_list),
-                                    2*self.xanes3D_sli_search_half_range])
-        self.si = np.ndarray(len(self.alignment_pair_list))
-        self.mse = np.ndarray(len(self.alignment_pair_list))
-        self.nrmse = np.ndarray(len(self.alignment_pair_list))
+            self.shift = np.ndarray(
+                [len(self.algn_pair_lst), 2 * self.xanes3D_sli_srch_half_range, 3, 3]
+            )
+        self.error = np.ndarray(
+            [len(self.algn_pair_lst), 2 * self.xanes3D_sli_srch_half_range]
+        )
 
-        if self.method.upper() == 'PC':
+        if self.reg_alg.upper() == "PC":
             print('We are using "phase correlation" method for registration.')
-            for ii in range(len(self.alignment_pair_list)):
-                fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                             str(self.xanes3D_recon_fixed_sli).zfill(5))
-                self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+            for ii in range(len(self.algn_pair_lst)):
+                fn = self.xanes3D_rec_path_tplt.format(
+                    self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                    str(self.xanes3D_fixed_ref_sli).zfill(5),
+                )
+                self.ref_im[:] = tifffile.imread(fn)[
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
                 jj_id = 0
                 for jj in range(sli_s, sli_e):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                    img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
-
-                    self.shift[ii, jj_id], self.error[ii, jj_id], _ = phase_cross_correlation(self.fixed,
-                                                                                           img[jj_id], upsample_factor=100)
-                    img[jj_id] = np.real(np.fft.ifftn(fourier_shift(np.fft.fftn(img[jj_id]),
-                                                                    self.shift[ii, jj_id])))[:]
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                        str(jj).zfill(5),
+                    )
+                    img[jj_id] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
+
+                    self.shift[ii, jj_id], self.error[ii, jj_id], _ = (
+                        phase_cross_correlation(
+                            self.ref_im, img[jj_id], upsample_factor=100
+                        )
+                    )
+                    img[jj_id] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(img[jj_id]), self.shift[ii, jj_id]
+                            )
+                        )
+                    )[:]
 
                     jj_id += 1
                 g11 = g1.create_group(str(ii).zfill(3))
-                g11.create_dataset('shift'+str(ii).zfill(3),
-                                   data=self.shift[ii])
-                g11.create_dataset('error'+str(ii).zfill(3),
-                                   data=self.error[ii])
-                g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                   data=img)
-                g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                   data=self.fixed)
-        elif self.method.upper() == 'MPC':
+                g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                g11.create_dataset("error" + str(ii).zfill(3), data=self.error[ii])
+                g11.create_dataset("trial_reg_img" + str(ii).zfill(3), data=img)
+                g11.create_dataset(
+                    "trial_fixed_img" + str(ii).zfill(3), data=self.ref_im
+                )
+        elif self.reg_alg.upper() == "MPC":
             print('We are using "masked phase correlation" method for registration.')
-            for ii in range(len(self.alignment_pair_list)):
-                fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                             str(self.xanes3D_recon_fixed_sli).zfill(5))
-                self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+            for ii in range(len(self.algn_pair_lst)):
+                fn = self.xanes3D_rec_path_tplt.format(
+                    self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                    str(self.xanes3D_fixed_ref_sli).zfill(5),
+                )
+                self.ref_im[:] = tifffile.imread(fn)[
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
                 jj_id = 0
                 for jj in range(sli_s, sli_e):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                    img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
-
-                    self.shift[ii, jj_id] = phase_cross_correlation(self.fixed, img[jj_id],
-                                                                    reference_mask=self.mask, overlap_ratio=self.overlap_ratio)
-                    img[jj_id] = np.real(np.fft.ifftn(fourier_shift(np.fft.fftn(img[jj_id]),
-                                                                    self.shift[ii, jj_id])))[:]
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                        str(jj).zfill(5),
+                    )
+                    img[jj_id] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
+
+                    self.shift[ii, jj_id] = phase_cross_correlation(
+                        self.ref_im,
+                        img[jj_id],
+                        reference_mask=self.msk,
+                        overlap_ratio=self.mpc_ovlp_r,
+                    )
+                    img[jj_id] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(img[jj_id]), self.shift[ii, jj_id]
+                            )
+                        )
+                    )[:]
 
                     jj_id += 1
                 g11 = g1.create_group(str(ii).zfill(3))
-                g11.create_dataset('shift'+str(ii).zfill(3),
-                                   data=self.shift[ii])
-                g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                   data=img)
-                g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                   data=self.fixed)
-        elif self.method.upper() == 'SR':
+                g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                g11.create_dataset("trial_reg_img" + str(ii).zfill(3), data=img)
+                g11.create_dataset(
+                    "trial_fixed_img" + str(ii).zfill(3), data=self.ref_im
+                )
+        elif self.reg_alg.upper() == "SR":
             print('We are using "stack registration" method for registration.')
-            if self.mode.upper() == 'TRANSLATION':
+            if self.sr_mode.upper() == "TRANSLATION":
                 sr = StackReg(StackReg.TRANSLATION)
-            elif  self.mode.upper() == 'RIGID_BODY':
+            elif self.sr_mode.upper() == "RIGID_BODY":
                 sr = StackReg(StackReg.RIGID_BODY)
-            elif  self.mode.upper() == 'SCALED_ROTATION':
+            elif self.sr_mode.upper() == "SCALED_ROTATION":
                 sr = StackReg(StackReg.SCALED_ROTATION)
-            elif  self.mode.upper() == 'AFFINE':
+            elif self.sr_mode.upper() == "AFFINE":
                 sr = StackReg(StackReg.AFFINE)
-            elif  self.mode.upper() == 'BILINEAR':
+            elif self.sr_mode.upper() == "BILINEAR":
                 sr = StackReg(StackReg.BILINEAR)
 
-            if self.mask is not None:
-                for ii in range(len(self.alignment_pair_list)):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                                 str(self.xanes3D_recon_fixed_sli).zfill(5))
-                    self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+            if self.msk is not None:
+                for ii in range(len(self.algn_pair_lst)):
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                        str(self.xanes3D_fixed_ref_sli).zfill(5),
+                    )
+                    self.ref_im[:] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
                     jj_id = 0
                     for jj in range(sli_s, sli_e):
-                        fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                        img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
-
-                        self.shift[ii, jj_id] = sr.register(self.fixed*self.mask, img[jj_id]*self.mask)
+                        fn = self.xanes3D_rec_path_tplt.format(
+                            self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                            str(jj).zfill(5),
+                        )
+                        img[jj_id] = tifffile.imread(fn)[
+                            self.im_roi[0] : self.im_roi[1],
+                            self.im_roi[2] : self.im_roi[3],
+                        ]
+
+                        self.shift[ii, jj_id] = sr.register(
+                            self.ref_im * self.msk, img[jj_id] * self.msk
+                        )
                         img[jj_id] = sr.transform(img[jj_id], self.shift[ii, jj_id])[:]
 
                         jj_id += 1
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                       data=self.shift[ii, :].astype(np.float32))
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                       data=img)
-                    g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                       data=self.fixed)
-            else:
-                for ii in range(len(self.alignment_pair_list)):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                                 str(self.xanes3D_recon_fixed_sli).zfill(5))
-                    self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                    g11.create_dataset(
+                        "shift" + str(ii).zfill(3),
+                        data=self.shift[ii, :].astype(np.float32),
+                    )
+                    g11.create_dataset("trial_reg_img" + str(ii).zfill(3), data=img)
+                    g11.create_dataset(
+                        "trial_fixed_img" + str(ii).zfill(3), data=self.ref_im
+                    )
+            else:
+                for ii in range(len(self.algn_pair_lst)):
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                        str(self.xanes3D_fixed_ref_sli).zfill(5),
+                    )
+                    self.ref_im[:] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
                     jj_id = 0
                     for jj in range(sli_s, sli_e):
-                        fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                        img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                        fn = self.xanes3D_rec_path_tplt.format(
+                            self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                            str(jj).zfill(5),
+                        )
+                        img[jj_id] = tifffile.imread(fn)[
+                            self.im_roi[0] : self.im_roi[1],
+                            self.im_roi[2] : self.im_roi[3],
+                        ]
 
-                        self.shift[ii, jj_id] = sr.register(self.fixed, img[jj_id])
+                        self.shift[ii, jj_id] = sr.register(self.ref_im, img[jj_id])
                         img[jj_id] = sr.transform(img[jj_id], self.shift[ii, jj_id])[:]
 
                         jj_id += 1
                     g11 = g1.create_group(str(ii).zfill(3))
-                    g11.create_dataset('shift'+str(ii).zfill(3),
-                                       data=self.shift[ii, :].astype(np.float32))
-                    g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                       data=img)
-                    g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                       data=self.fixed)
-        elif self.method.upper() == 'MRTV':
-            print('We are using "multi-resolution total variation" method for registration.')
-            sli_s = self.xanes3D_recon_fixed_sli-self.xanes3D_sli_search_half_range
-            sli_e = self.xanes3D_recon_fixed_sli+self.xanes3D_sli_search_half_range
-            pxl_conf = dict(type='area', levs=self.alg_mrtv_level, wz=self.alg_mrtv_width, lsw=10)
-            sub_conf = dict(use=True, type='ana', sp_wz=self.alg_mrtv_sp_wz, sp_us=10)
-            for ii in range(len(self.alignment_pair_list)):
-                fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                             str(self.xanes3D_recon_fixed_sli).zfill(5))
-                self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                    g11.create_dataset(
+                        "shift" + str(ii).zfill(3),
+                        data=self.shift[ii, :].astype(np.float32),
+                    )
+                    g11.create_dataset("trial_reg_img" + str(ii).zfill(3), data=img)
+                    g11.create_dataset(
+                        "trial_fixed_img" + str(ii).zfill(3), data=self.ref_im
+                    )
+        elif self.reg_alg.upper() == "MRTV":
+            print(
+                'We are using "multi-resolution total variation" method for registration.'
+            )
+            sli_s = self.xanes3D_fixed_ref_sli - self.xanes3D_sli_srch_half_range
+            sli_e = self.xanes3D_fixed_ref_sli + self.xanes3D_sli_srch_half_range
+            cfg = {"mrtv": {}}
+            cfg["mrtv"]["pxl_conf"] = dict(
+                type="area", levs=self.mrtv_lvl, wz=self.mrtv_wz, lsw=10
+            )
+            cfg["mrtv"]["sub_conf"] = dict(
+                use=True, type="ana", sp_wz=self.mrtv_sp_wz, sp_us=10
+            )
+            cfg["mrtv"]["smth_krnl"] = self.mrtv_smth_knl
+            for ii in range(len(self.algn_pair_lst)):
+                fn = self.xanes3D_rec_path_tplt.format(
+                    self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                    str(self.xanes3D_fixed_ref_sli).zfill(5),
+                )
+                self.ref_im[:] = tifffile.imread(fn)[
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
 
                 jj_id = 0
                 for jj in range(sli_s, sli_e):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                    img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                        str(jj).zfill(5),
+                    )
+                    img[jj_id] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
                     jj_id += 1
 
-                with mp.get_context('spawn').Pool(N_CPU) as pool:
-                    rlt = pool.map(partial(mrtv_reg, pxl_conf, sub_conf, None, self.alg_mrtv_sp_kernel),
-                                   [[self.fixed, img[jj]] for jj in range(sli_e-sli_s)])
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        partial(mrtv_reg, cfg["mrtv"], None),
+                        [[self.ref_im, img[jj]] for jj in range(sli_e - sli_s)],
+                    )
                 pool.close()
                 pool.join()
 
                 tvl = []
                 for jj in range(len(rlt)):
                     self.shift[ii, jj] = rlt[jj][3]
-                    tvl.append(rlt[jj][0][self.alg_mrtv_level-1].flatten()[rlt[jj][1][-1]])
-                tv = np.array(tvl).argmin()
-                del(rlt)
+                    tvl.append(rlt[jj][0][self.mrtv_lvl - 1].flatten()[rlt[jj][1][-1]])
+                min_tv_id = np.array(tvl).argmin()
+                del rlt
                 gc.collect()
 
-                with mp.get_context('spawn').Pool(N_CPU) as pool:
-                    rlt = pool.map(shift_img,
-                                   [[img[jj], self.shift[ii, jj]] for jj in range(sli_e-sli_s)])
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        shift_img,
+                        [[img[jj], self.shift[ii, jj]] for jj in range(sli_e - sli_s)],
+                    )
                 pool.close()
                 pool.join()
 
                 for jj in range(len(rlt)):
                     img[jj] = rlt[jj]
-                del(rlt)
+                del rlt
+                gc.collect()
+
+                g11 = g1.create_group(str(ii).zfill(3))
+                g11.create_dataset("mrtv_best_shift_id", data=min_tv_id)
+                g11.create_dataset("tv", data=tvl)
+                g11.create_dataset("shift", data=self.shift[ii])
+                g11.create_dataset("trial_reg_img", data=img)
+                g11.create_dataset("trial_fixed_img", data=self.ref_im)
+        elif self.reg_alg.upper() == "RIG-MRTV":
+            print(
+                'We are using "multi-resolution total variation" method for registration.'
+            )
+            sli_s = self.xanes3D_fixed_ref_sli - self.xanes3D_sli_srch_half_range
+            sli_e = self.xanes3D_fixed_ref_sli + self.xanes3D_sli_srch_half_range
+            cfg = {"mrtv": {}}
+            cfg["mrtv"]["pxl_conf"] = dict(
+                type="area", levs=self.mrtv_lvl, wz=self.mrtv_wz, lsw=10
+            )
+            cfg["mrtv"]["sub_conf"] = dict(
+                use=True, type="ana", sp_wz=self.mrtv_sp_wz, sp_us=10
+            )
+            cfg["mrtv"]["smth_krnl"] = self.mrtv_smth_knl
+
+            rig_mrtv_cfg = {}
+            rig_mrtv_cfg["pxl_conf"] = dict(type="area", levs=1, wz=4)
+            rig_mrtv_cfg["sub_conf"] = dict(use=True, type="ana", sp_wz=3, sp_us=10)
+            rig_mrtv_cfg["smth_krnl"] = self.mrtv_smth_knl
+            rig_mrtv_cfg["ang_rgn"] = [-self.rig_mrtv_ang_rgn, self.rig_mrtv_ang_rgn]
+            rig_mrtv_cfg["pre_offset"] = self.rig_mrtv_pre_ofst
+            rig_mrtv_cfg["gm"] = self.rig_mrtv_gm
+            rig_mrtv_cfg["use_flt"] = self.rig_mrtv_use_flt
+            rig_mrtv_cfg["use_norm"] = self.rig_mrtv_use_norm
+            for ii in range(len(self.algn_pair_lst)):
+                fn = self.xanes3D_rec_path_tplt.format(
+                    self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                    str(self.xanes3D_fixed_ref_sli).zfill(5),
+                )
+                self.ref_im[:] = tifffile.imread(fn)[
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
+
+                jj_id = 0
+                for jj in range(sli_s, sli_e):
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                        str(jj).zfill(5),
+                    )
+                    img[jj_id] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
+                    jj_id += 1
+
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        partial(mrtv_reg, cfg["mrtv"], None),
+                        [[self.ref_im, img[jj]] for jj in range(sli_e - sli_s)],
+                    )
+                pool.close()
+                pool.join()
+
+                tvl = []
+                for jj in range(len(rlt)):
+                    self.shift[ii, jj] = rlt[jj][3]
+                    tvl.append(rlt[jj][0][self.mrtv_lvl - 1].flatten()[rlt[jj][1][-1]])
+                min_tv_id = np.array(tvl).argmin()
+                del rlt
                 gc.collect()
 
+                regtools.translate_single_img(
+                    self.shift[ii, min_tv_id], "MRTV", None, img[min_tv_id]
+                )
+
+                mrtv_shift, out_src = mrtv_rigid_reg(
+                    self.ref_im,
+                    img[min_tv_id],
+                    rig_mrtv_cfg,
+                    itr=2,
+                    mask=1,
+                    roi=None,
+                    popsize=100,
+                    order="L1",
+                    filt=True,
+                    norm=True,
+                )
+
                 g11 = g1.create_group(str(ii).zfill(3))
-                g11.create_dataset('mrtv_best_shift_id'+str(ii).zfill(3),
-                                   data=tv)
-                g11.create_dataset('tv'+str(ii).zfill(3),
-                                   data=tvl)
-                g11.create_dataset('shift'+str(ii).zfill(3),
-                                   data=self.shift[ii])
-                g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                   data=img)
-                g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                   data=self.fixed)
-        elif self.method.upper() == 'LS+MRTV':
-            print('We are using "multi-resolution total variation" method for registration.')
-            sli_s = self.xanes3D_recon_fixed_sli-self.xanes3D_sli_search_half_range
-            sli_e = self.xanes3D_recon_fixed_sli+self.xanes3D_sli_search_half_range
-            for ii in range(len(self.alignment_pair_list)):
-                fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                             str(self.xanes3D_recon_fixed_sli).zfill(5))
-                self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                g11.create_dataset("mrtv_best_shift_id", data=min_tv_id)
+                g11.create_dataset("tv", data=tvl)
+                g11.create_dataset("shift", data=self.shift[ii])
+                g11.create_dataset("rigid_reg_mat", data=mrtv_shift)
+                g11.create_dataset(
+                    "ang_correction", data=cal_rig_mrtv_ang(mrtv_shift, degree=True)
+                )
+                g11.create_dataset(
+                    "combined_shift", data=self.shift[ii] + np.array(mrtv_shift[:2, 2])
+                )
+                g11.create_dataset("rigid_reg_img", data=out_src)
+                g11.create_dataset("trial_fixed_img", data=self.ref_im)
+        elif self.reg_alg.upper() == "LS+MRTV":
+            print(
+                'We are using "multi-resolution total variation" method for registration.'
+            )
+            sli_s = self.xanes3D_fixed_ref_sli - self.xanes3D_sli_srch_half_range
+            sli_e = self.xanes3D_fixed_ref_sli + self.xanes3D_sli_srch_half_range
+            for ii in range(len(self.algn_pair_lst)):
+                fn = self.xanes3D_rec_path_tplt.format(
+                    self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                    str(self.xanes3D_fixed_ref_sli).zfill(5),
+                )
+                self.ref_im[:] = tifffile.imread(fn)[
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
 
                 jj_id = 0
                 for jj in range(sli_s, sli_e):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                    img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                        str(jj).zfill(5),
+                    )
+                    img[jj_id] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
                     jj_id += 1
 
-                with mp.get_context('spawn').Pool(N_CPU) as pool:
-                    rlt = pool.map(partial(mrtv_ls_combo_reg, self.alg_mrtv_width, 2, 10,
-                                           self.alg_mrtv_sp_wz, self.alg_mrtv_sp_wz),
-                                   [[self.fixed, img[jj]] for jj in range(sli_e-sli_s)])
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        partial(
+                            mrtv_ls_combo_reg,
+                            self.mrtv_wz,
+                            2,
+                            10,
+                            self.mrtv_sp_wz,
+                            self.mrtv_sp_wz,
+                        ),
+                        [[self.ref_im, img[jj]] for jj in range(sli_e - sli_s)],
+                    )
                 pool.close()
                 pool.join()
 
                 tvl = []
                 for jj in range(len(rlt)):
                     self.shift[ii, jj] = rlt[jj][3]
-                    tvl.append(rlt[jj][0][self.alg_mrtv_level-1].flatten()[rlt[jj][1][-1]])
-                tv = np.array(tvl).argmin()
-                del(rlt)
+                    tvl.append(rlt[jj][0][self.mrtv_lvl - 1].flatten()[rlt[jj][1][-1]])
+                min_tv_id = np.array(tvl).argmin()
+                del rlt
                 gc.collect()
 
-                with mp.get_context('spawn').Pool(N_CPU) as pool:
-                    rlt = pool.map(shift_img,
-                                   [[img[jj], self.shift[ii, jj]] for jj in range(sli_e-sli_s)])
+                with mp.Pool(N_CPU) as pool:
+                    rlt = pool.map(
+                        shift_img,
+                        [[img[jj], self.shift[ii, jj]] for jj in range(sli_e - sli_s)],
+                    )
                 pool.close()
                 pool.join()
 
                 for jj in range(len(rlt)):
                     img[jj] = rlt[jj]
-                del(rlt)
+                del rlt
                 gc.collect()
 
                 g11 = g1.create_group(str(ii).zfill(3))
-                g11.create_dataset('mrtv_best_shift_id'+str(ii).zfill(3),
-                                   data=tv)
-                g11.create_dataset('tv'+str(ii).zfill(3),
-                                   data=tvl)
-                g11.create_dataset('shift'+str(ii).zfill(3),
-                                   data=self.shift[ii])
-                g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                   data=img)
-                g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                   data=self.fixed)
-        elif self.method.upper() == 'MPC+MRTV':
-            print('We are using combo of "masked phase correlation" and "masked phase correlation" method for registration.')
-            for ii in range(len(self.alignment_pair_list)):
-                fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][0]).zfill(3)],
-                                                             str(self.xanes3D_recon_fixed_sli).zfill(5))
-                self.fixed[:] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
+                g11.create_dataset(
+                    "mrtv_best_shift_id" + str(ii).zfill(3), data=min_tv_id
+                )
+                g11.create_dataset("tv" + str(ii).zfill(3), data=tvl)
+                g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                g11.create_dataset("trial_reg_img" + str(ii).zfill(3), data=img)
+                g11.create_dataset(
+                    "trial_fixed_img" + str(ii).zfill(3), data=self.ref_im
+                )
+        elif self.reg_alg.upper() == "MPC+MRTV":
+            print(
+                'We are using combo of "masked phase correlation" and "masked phase correlation" method for registration.'
+            )
+            for ii in range(len(self.algn_pair_lst)):
+                fn = self.xanes3D_rec_path_tplt.format(
+                    self.im_ids_dict[str(self.algn_pair_lst[ii][0]).zfill(3)],
+                    str(self.xanes3D_fixed_ref_sli).zfill(5),
+                )
+                self.ref_im[:] = tifffile.imread(fn)[
+                    self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                ]
                 jj_id = 0
                 for jj in range(sli_s, sli_e):
-                    fn = self.xanes3D_recon_path_template.format(self.img_ids_dict[str(self.alignment_pair_list[ii][1]).zfill(3)], str(jj).zfill(5))
-                    img[jj_id] = tifffile.imread(fn)[self.roi[0]:self.roi[1], self.roi[2]:self.roi[3]]
-                    _, _, _, self.shift[ii, jj_id] = mrtv_mpc_combo_reg(self.fixed, img[jj_id],
-                                                                        reference_mask=self.mask,
-                                                                        overlap_ratio=self.overlap_ratio,
-                                                                        levs=self.alg_mrtv_level,
-                                                                        wz=self.alg_mrtv_width,
-                                                                        sp_wz=self.alg_mrtv_sp_wz,
-                                                                        sp_step=self.alg_mrtv_sp_wz)
-                    img[jj_id] = np.real(np.fft.ifftn(fourier_shift(np.fft.fftn(img[jj_id]),
-                                                                    self.shift[ii, jj_id])))[:]
+                    fn = self.xanes3D_rec_path_tplt.format(
+                        self.im_ids_dict[str(self.algn_pair_lst[ii][1]).zfill(3)],
+                        str(jj).zfill(5),
+                    )
+                    img[jj_id] = tifffile.imread(fn)[
+                        self.im_roi[0] : self.im_roi[1], self.im_roi[2] : self.im_roi[3]
+                    ]
+                    _, _, _, self.shift[ii, jj_id] = mrtv_mpc_combo_reg(
+                        self.ref_im,
+                        img[jj_id],
+                        reference_mask=self.msk,
+                        overlap_ratio=self.mpc_ovlp_r,
+                        levs=self.mrtv_lvl,
+                        wz=self.mrtv_wz,
+                        sp_wz=self.mrtv_sp_wz,
+                        sp_step=self.mrtv_sp_wz,
+                    )
+                    img[jj_id] = np.real(
+                        np.fft.ifftn(
+                            fourier_shift(
+                                np.fft.fftn(img[jj_id]), self.shift[ii, jj_id]
+                            )
+                        )
+                    )[:]
 
                     jj_id += 1
                 g11 = g1.create_group(str(ii).zfill(3))
-                g11.create_dataset('shift'+str(ii).zfill(3),
-                                   data=self.shift[ii])
-                g11.create_dataset('trial_reg_img'+str(ii).zfill(3),
-                                   data=img)
-                g11.create_dataset('trial_fixed_img'+str(ii).zfill(3),
-                                   data=self.fixed)
+                g11.create_dataset("shift" + str(ii).zfill(3), data=self.shift[ii])
+                g11.create_dataset("trial_reg_img" + str(ii).zfill(3), data=img)
+                g11.create_dataset(
+                    "trial_fixed_img" + str(ii).zfill(3), data=self.ref_im
+                )
         f.close()
 
-    def apply_xanes3D_chunk_shift(self, shift_dict, sli_s, sli_e,
-                                  trialfn=None, savefn=None,
-                                  optional_shift_dict=None, mem_lim=None):
+    def apply_xanes3D_chunk_shift(
+        self, shift_dict, sli_s=None, sli_e=None, mem_lim=None
+    ):
         """
         shift_dict: disctionary;
                     user-defined shift list based on visual inspections of
                     trial registration results; it is configured as
             {'id1':    shift_id1,
              ...
              'idn':    shift_idn}
@@ -1188,321 +1220,785 @@
         savefn:     string; optional
                     filename to the file in which the shifted volume to be saved
         optional_shift_dict: dict; optional
                     user input shifts for specified scan ids. This is useful to
                     correct individual pairs that cannot be aligned with others
                     with the same registration method
         """
-        if savefn is None:
-            savefn = self.savefn
-        if trialfn is None:
-            trialfn = self.savefn
-
-        if savefn == trialfn:
-            with h5py.File(savefn, 'a') as f:
-                if 'registration_results' not in f:
-                    g0 = f.create_group('registration_results')
-                else:
-                    del f['registration_results']
-                    g0 = f.create_group('registration_results')
+        if sli_s is None:
+            sli_s = self.im_roi[4]
+        if sli_e is None:
+            sli_e = self.im_roi[5]
+
+        with h5py.File(self.sav_fn, "a") as f:
+            if "registration_results" not in f:
+                g0 = f.create_group("registration_results")
+            else:
+                del f["registration_results"]
+                g0 = f.create_group("registration_results")
+
+            g1 = g0.create_group("reg_parameters")
+            self.algn_pair_lst = f[
+                "/trial_registration/trial_reg_parameters/alignment_pairs"
+            ][:].tolist()
+            g1.create_dataset("alignment_pairs", data=self.algn_pair_lst)
+            self.xanes3D_scn_ids = f[
+                "/trial_registration/trial_reg_parameters/scan_ids"
+            ][:]
+            g1.create_dataset("scan_ids", data=self.xanes3D_scn_ids)
+            g1.create_dataset("slice_roi", data=self.im_roi)
+            self.anchor_id = f[
+                "/trial_registration/trial_reg_parameters/fixed_scan_id"
+            ][()]
+            g1.create_dataset("fixed_scan_id", data=self.anchor_id)
+            self.chunk_sz = f["/trial_registration/trial_reg_parameters/chunk_sz"][()]
+            g1.create_dataset("chunk_sz", data=self.chunk_sz)
+            self.reg_alg = f["/trial_registration/trial_reg_parameters/reg_method"][
+                ()
+            ].decode("utf-8")
+            g1.create_dataset("reg_method", data=self.reg_alg)
+            self.ref_mode = f["/trial_registration/trial_reg_parameters/reg_ref_mode"][
+                ()
+            ].decode("utf-8")
+            g1.create_dataset("reg_ref_mode", data=str(self.ref_mode.upper()))
+            self.xanes3D_sli_srch_half_range = f[
+                "/trial_registration/trial_reg_parameters/sli_search_half_range"
+            ][()]
+            self.im_ids_dict = h5todict(
+                self.sav_fn,
+                path="/trial_registration/trial_reg_parameters/scan_ids_dict",
+            )
+            self.eng_dict = h5todict(
+                self.sav_fn, path="/trial_registration/trial_reg_parameters/eng_dict"
+            )
+            dicttoh5(
+                self.eng_dict,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/eng_dict",
+            )
+            dicttoh5(
+                self.im_ids_dict,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/scan_ids_dict",
+            )
+
+            (self.abs_shift_dict, self.shift_chain_dict) = regtools.sort_absolute_shift(
+                self.algn_pair_lst,
+                shft_dict=shift_dict,
+                data_type="3D_XANES",
+                reg_alg=self.reg_alg,
+            )
+
+            dicttoh5(
+                self.abs_shift_dict,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/user_determined_shift/user_input_shift_lookup",
+            )
+
+            shift = {}
+            slioff = {}
+            for key in sorted(self.abs_shift_dict.keys()):
+                shift[str(key).zfill(3)] = self.abs_shift_dict[key]["in_sli_shift"]
+                slioff[str(key).zfill(3)] = self.abs_shift_dict[key]["out_sli_shift"]
+
+            dicttoh5(
+                shift,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/user_determined_shift/absolute_in_slice_shift",
+            )
+            dicttoh5(
+                slioff,
+                self.sav_fn,
+                mode="a",
+                update_mode="replace",
+                h5path="/registration_results/reg_parameters/user_determined_shift/absolute_out_slice_shift",
+            )
+
+            g2 = g0.create_group("reg_results")
+            g21 = g2.create_dataset(
+                "registered_xanes3D",
+                shape=(
+                    len(self.im_ids_dict),
+                    sli_e - sli_s + 1,
+                    self.im_roi[1] - self.im_roi[0],
+                    self.im_roi[3] - self.im_roi[2],
+                ),
+            )
+            g22 = g2.create_dataset("eng_list", shape=(len(self.im_ids_dict),))
+
+            img = np.ndarray(
+                [self.im_roi[1] - self.im_roi[0], self.im_roi[3] - self.im_roi[2]]
+            )
+            cnt1 = 0
+            for key in sorted(self.abs_shift_dict.keys()):
+                shift = self.abs_shift_dict[key]["in_sli_shift"]
+                slioff = self.abs_shift_dict[key]["out_sli_shift"]
+                scan_id = self.im_ids_dict[key]
+
+                if self.reg_alg == "SR":
+                    yshift_int = int(shift[0, 2])
+                    xshift_int = int(shift[1, 2])
+                    shift[0, 2] -= yshift_int
+                    shift[1, 2] -= xshift_int
+                elif self.reg_alg in ["PC", "MPC", "MRTV", "RIG-MRTV", "MPC+MRTV"]:
+                    yshift_int = int(shift[0])
+                    xshift_int = int(shift[1])
+                    shift[0] -= yshift_int
+                    shift[1] -= xshift_int
+
+                bdi, num_batch = regtools.chunking(
+                    [
+                        sli_e - sli_s + 1,
+                        self.im_roi[1] - self.im_roi[0],
+                        self.im_roi[3] - self.im_roi[2],
+                    ],
+                    mem_lim=mem_lim,
+                )
+                for i in range(num_batch):
+                    img = tiff_vol_reader(
+                        self.xanes3D_rec_path_tplt,
+                        scan_id,
+                        [
+                            sli_s + slioff + bdi[i * N_CPU],
+                            sli_s + slioff + bdi[(i + 1) * N_CPU],
+                            self.im_roi[0] - yshift_int,
+                            self.im_roi[1] - yshift_int,
+                            self.im_roi[2] - xshift_int,
+                            self.im_roi[3] - xshift_int,
+                        ],
+                    )
+
+                    rlt = regtools.translate_vol_img(
+                        shift, self.reg_alg, self.sr_mode, img
+                    )
+                    g21[cnt1, bdi[i * N_CPU] : bdi[(i + 1) * N_CPU], ...] = img[:]
+                g22[cnt1] = self.eng_dict[key]
+                cnt1 += 1
+
+    def save_reg_result(self, dtype="2D_XANES", data=None):
+        if dtype.upper() == "2D_XANES":
+            if not os.path.exists(self.sav_dir):
+                os.makedirs(self.sav_dir, mode=777)
+            print(f"3. The registration results will be saved in {self.sav_fn}")
+
+            f = h5py.File(self.sav_fn, "a")
+            if "trial_registration" not in f:
+                g1 = f.create_group("trial_registration")
+            else:
+                g1 = f["trial_registration"]
+
+            if "method" not in g1:
+                dset = g1.create_dataset("method", data=str(self.reg_alg))
+                dset.attrs["method"] = str(self.reg_alg)
+            else:
+                del g1["method"]
+                dset = g1.create_dataset("method", data=str(self.reg_alg))
+                dset.attrs["method"] = str(self.reg_alg)
+
+            if "mode" not in g1:
+                dset = g1.create_dataset("mode", data=str(self.sr_mode))
+                dset.attrs["mode"] = str(self.sr_mode)
+            else:
+                del g1["mode"]
+                dset = g1.create_dataset("mode", data=str(self.sr_mode))
+                dset.attrs["mode"] = str(self.sr_mode)
+
+            if "ref_mode" not in g1:
+                dset = g1.create_dataset("ref_mode", data=str(self.ref_mode))
+                dset.attrs["ref_mode"] = str(self.ref_mode)
+            else:
+                del g1["ref_mode"]
+                dset = g1.create_dataset("ref_mode", data=str(self.ref_mode))
+                dset.attrs["ref_mode"] = str(self.ref_mode)
 
-                g1 = g0.create_group('reg_parameters')
-                self.alignment_pair_list = f['/trial_registration/trial_reg_parameters/alignment_pairs'][:].tolist()
-                g1.create_dataset('alignment_pairs', data=self.alignment_pair_list)
-                self.img_ids = f['/trial_registration/trial_reg_parameters/scan_ids'][:]
-                g1.create_dataset('scan_ids', data=self.img_ids)
-                g1.create_dataset('slice_roi', data=self.roi)
-                self.anchor_id = f['/trial_registration/trial_reg_parameters/fixed_scan_id'][()]
-                g1.create_dataset('fixed_scan_id', data=self.anchor_id)
-                self.chunk_sz = f['/trial_registration/trial_reg_parameters/chunk_sz'][()]
-                g1.create_dataset('chunk_sz', data=self.chunk_sz)
-                self.method = f['/trial_registration/trial_reg_parameters/reg_method'][()].decode("utf-8")
-                g1.create_dataset('reg_method', data=self.method)
-                self.ref_mode = f['/trial_registration/trial_reg_parameters/reg_ref_mode'][()].decode("utf-8")
-                g1.create_dataset('reg_ref_mode', data=str(self.ref_mode.upper()))
-                self.xanes3D_sli_search_half_range = f['/trial_registration/trial_reg_parameters/sli_search_half_range'][()]
-                self.img_ids_dict = h5todict(savefn, path='/trial_registration/trial_reg_parameters/scan_ids_dict')
-                self.eng_dict = h5todict(savefn, path='/trial_registration/trial_reg_parameters/eng_dict')
-                dicttoh5(self.eng_dict, savefn, mode='a',
-                     overwrite_data=True,
-                     h5path='/registration_results/reg_parameters/eng_dict')
-                dicttoh5(self.img_ids_dict, savefn, mode='a',
-                     overwrite_data=True,
-                     h5path='/registration_results/reg_parameters/scan_ids_dict')
-
-                self._sort_absolute_shift(trialfn, shift_dict=shift_dict, optional_shift_dict=optional_shift_dict)
-                dicttoh5(self.abs_shift_dict, savefn, mode='a',
-                         overwrite_data=True,
-                         h5path='/registration_results/reg_parameters/user_determined_shift/user_input_shift_lookup')
-
-                shift = {}
-                slioff = {}
-                for key in sorted(self.abs_shift_dict.keys()):
-                    shift[str(key).zfill(3)] = self.abs_shift_dict[key]['in_sli_shift']
-                    slioff[str(key).zfill(3)] = self.abs_shift_dict[key]['out_sli_shift']
-
-                dicttoh5(shift, savefn, mode='a',
-                         overwrite_data=True,
-                         h5path='/registration_results/reg_parameters/user_determined_shift/absolute_in_slice_shift')
-                dicttoh5(slioff, savefn, mode='a',
-                         overwrite_data=True,
-                         h5path='/registration_results/reg_parameters/user_determined_shift/absolute_out_slice_shift')
-
-                g2 = g0.create_group('reg_results')
-                g21 = g2.create_dataset('registered_xanes3D',
-                                        shape=(len(self.img_ids_dict),
-                                               sli_e-sli_s+1,
-                                               self.roi[1]-self.roi[0],
-                                               self.roi[3]-self.roi[2]))
-                g22 = g2.create_dataset('eng_list', shape=(len(self.img_ids_dict),))
-
-                img = np.ndarray([self.roi[1]-self.roi[0], self.roi[3]-self.roi[2]])
-                cnt1 = 0
-                for key in sorted(self.abs_shift_dict.keys()):
-                    shift = self.abs_shift_dict[key]['in_sli_shift']
-                    slioff = self.abs_shift_dict[key]['out_sli_shift']
-                    scan_id = self.img_ids_dict[key]
-                    cnt2 = 0
-                    print(self.method)
-                    if self.method == 'SR':
-                        yshift_int = int(shift[0, 2])
-                        xshift_int = int(shift[1, 2])
-                        shift[0, 2] -= yshift_int
-                        shift[1, 2] -= xshift_int
-                    elif self.method in ['PC', 'MPC', 'MRTV', 'MPC+MRTV']:
-                        yshift_int = int(shift[0])
-                        xshift_int = int(shift[1])
-                        shift[0] -= yshift_int
-                        shift[1] -= xshift_int
-
-                    # for ii in range(int(sli_s+slioff), int(sli_e+slioff)):
-                    #     # print(4)
-                    #     fn = self.xanes3D_recon_path_template.format(scan_id,
-                    #                                                  str(ii).zfill(5))
-                    #     img[:] = tifffile.imread(fn)[self.roi[0]-yshift_int:self.roi[1]-yshift_int,
-                    #                                  self.roi[2]-xshift_int:self.roi[3]-xshift_int]
-                    #
-                    #     self._translate_single_img(img, shift, self.method)
-                    #     g21[cnt1, cnt2] = img[:]
-                    #     cnt2 += 1
-                    # g22[cnt1] = self.eng_dict[key]
-                    # cnt1 += 1
-                    bdi, num_batch = self._chunking([sli_e-sli_s+1, self.roi[1]-self.roi[0], self.roi[3]-self.roi[2]],
-                                                    mem_lim=mem_lim)
-                    for i in range(num_batch):
-                        img = tiff_vol_reader(self.xanes3D_recon_path_template, scan_id,
-                                              [sli_s+slioff+bdi[i*N_CPU], sli_s+slioff+bdi[(i+1)*N_CPU],
-                                               self.roi[0]-yshift_int, self.roi[1]-yshift_int,
-                                               self.roi[2]-xshift_int, self.roi[3]-xshift_int])
-                        print(f"{img.shape=}")
-                        with mp.Pool(N_CPU) as pool:
-                            rlt = pool.map(partial(self._translate_vol_img, shift, self.method), [
-                                           img[bdi[i*N_CPU+ii-1]:bdi[i*N_CPU+ii], ...] for ii in range(N_CPU)])
-                        pool.close()
-                        pool.join()
-                        rlt = np.array(rlt, dtype=object)
-                        print(f"{g21[cnt1, bdi[i*N_CPU]:bdi[(i+1)*N_CPU], ...].shape=}, {img.shape=}")
-                        g21[cnt1, bdi[i*N_CPU]:bdi[(i+1)*N_CPU], ...] = img[:]
-                    g22[cnt1] = self.eng_dict[key]
-                    cnt1 += 1
-
-    def save_reg_result(self, dtype='2D_XANES', data=None):
-        if dtype.upper() == '2D_XANES':
-            if not os.path.exists(self.save_path):
-                os.makedirs(self.save_path, mode=777)
-            print(f'3. The registration results will be saved in {self.savefn}')
-
-            f = h5py.File(self.savefn, 'a')
-            if 'trial_registration' not in f:
-                g1 = f.create_group('trial_registration')
-            else:
-                g1 = f['trial_registration']
-
-            if 'method' not in g1:
-                dset = g1.create_dataset('method', data=str(self.method))
-                dset.attrs['method'] = str(self.method)
-            else:
-                del g1['method']
-                dset = g1.create_dataset('method', data=str(self.method))
-                dset.attrs['method'] = str(self.method)
-
-            if 'mode' not in g1:
-                dset = g1.create_dataset('mode', data=str(self.mode))
-                dset.attrs['mode'] = str(self.mode)
-            else:
-                del g1['mode']
-                dset = g1.create_dataset('mode', data=str(self.mode))
-                dset.attrs['mode'] = str(self.mode)
-
-            if 'ref_mode' not in g1:
-                dset = g1.create_dataset('ref_mode', data=str(self.ref_mode))
-                dset.attrs['ref_mode'] = str(self.ref_mode)
-            else:
-                del g1['ref_mode']
-                dset = g1.create_dataset('ref_mode', data=str(self.ref_mode))
-                dset.attrs['ref_mode'] = str(self.ref_mode)
-
-            if 'registered_image' not in g1:
+            if "registered_image" not in g1:
                 if data is None:
-                    g1.create_dataset('registered_image', data=self.img)
+                    g1.create_dataset("registered_image", data=self.im)
                 else:
-                    g1.create_dataset('registered_image', data=data)
+                    g1.create_dataset("registered_image", data=data)
             else:
-                del g1['registered_image']
+                del g1["registered_image"]
                 if data is None:
-                    g1.create_dataset('registered_image', data=self.img)
+                    g1.create_dataset("registered_image", data=self.im)
                 else:
-                    g1.create_dataset('registered_image', data=data)
-
-            if 'shift' not in g1:
-                g1.create_dataset('shift', data=self.shift)
-            else:
-                del g1['shift']
-                g1.create_dataset('shift', data=self.shift)
-
-            if 'ssim' not in g1:
-                g1.create_dataset('ssim', data=self.si)
-            else:
-                del g1['ssim']
-                g1.create_dataset('ssim', data=self.si)
+                    g1.create_dataset("registered_image", data=data)
 
-            if 'mse' not in g1:
-                g1.create_dataset('mse', data=self.mse)
+            if "shift" not in g1:
+                g1.create_dataset("shift", data=self.shift)
             else:
-                del g1['mse']
-                g1.create_dataset('mse', data=self.mse)
+                del g1["shift"]
+                g1.create_dataset("shift", data=self.shift)
 
-            if 'nrmse' not in g1:
-                g1.create_dataset('nrmse', data=self.nrmse)
+            if "raw_data_info" not in f:
+                g2 = f.create_group("raw_data_info")
             else:
-                del g1['nrmse']
-                g1.create_dataset('nrmse', data=self.nrmse)
-
-            if 'raw_data_info' not in f:
-                g2 = f.create_group('raw_data_info')
-            else:
-                g2 = f['raw_data_info']
+                g2 = f["raw_data_info"]
 
             for key, val in self.raw_data_info.items():
                 if key not in g2:
                     g2.create_dataset(key, data=val)
                 else:
                     del g2[key]
                     g2.create_dataset(key, data=val)
             f.close()
-        elif dtype.upper() == '3D_XANES':
-            if not os.path.exists(self.save_path):
-                os.makedirs(self.save_path, mode=777)
-            print(f'4. The registration results will be saved in {self.savefn}')
-
-            f = h5py.File(self.savefn, 'a')
-            if 'registration' not in f:
-                g1 = f.create_group('registration')
-            else:
-                g1 = f['registration']
-
-            if 'method' not in g1:
-                dset = g1.create_dataset('method', data=str(self.method))
-                dset.attrs['method'] = str(self.method)
-            else:
-                del g1['method']
-                dset = g1.create_dataset('method', data=str(self.method))
-                dset.attrs['method'] = str(self.method)
+        elif dtype.upper() == "3D_XANES":
+            if not os.path.exists(self.sav_dir):
+                os.makedirs(self.sav_dir, mode=777)
+            print(f"4. The registration results will be saved in {self.sav_fn}")
+
+            f = h5py.File(self.sav_fn, "a")
+            if "registration" not in f:
+                g1 = f.create_group("registration")
+            else:
+                g1 = f["registration"]
+
+            if "method" not in g1:
+                dset = g1.create_dataset("method", data=str(self.reg_alg))
+                dset.attrs["method"] = str(self.reg_alg)
+            else:
+                del g1["method"]
+                dset = g1.create_dataset("method", data=str(self.reg_alg))
+                dset.attrs["method"] = str(self.reg_alg)
 
-            if 'registered_image' not in g1:
+            if "registered_image" not in g1:
                 if data is None:
-                    g1.create_dataset('registered_image', data=self.img)
+                    g1.create_dataset("registered_image", data=self.im)
                 else:
-                    g1.create_dataset('registered_image', data=data)
+                    g1.create_dataset("registered_image", data=data)
             else:
-                del g1['registered_image']
+                del g1["registered_image"]
                 if data is None:
-                    g1.create_dataset('registered_image', data=self.img)
+                    g1.create_dataset("registered_image", data=self.im)
                 else:
-                    g1.create_dataset('registered_image', data=data)
+                    g1.create_dataset("registered_image", data=data)
 
-            if 'residual_image' not in g1:
+            if "residual_image" not in g1:
                 if data is None:
-                    g1.create_dataset('residual_image',
-                                      data=np.float32(self.fixed)-self.img)
+                    g1.create_dataset(
+                        "residual_image", data=np.float32(self.ref_im) - self.im
+                    )
                 else:
-                    g1.create_dataset('residual_image',
-                                      data=np.float32(self.fixed)-data)
+                    g1.create_dataset(
+                        "residual_image", data=np.float32(self.ref_im) - data
+                    )
             else:
-                del g1['residual_image']
+                del g1["residual_image"]
                 if data is None:
-                    g1.create_dataset('residual_image',
-                                      data=np.float32(self.fixed)-self.img)
+                    g1.create_dataset(
+                        "residual_image", data=np.float32(self.ref_im) - self.im
+                    )
                 else:
-                    g1.create_dataset('residual_image',
-                                      data=np.float32(self.fixed)-data)
-
-            if 'shift' not in g1:
-                g1.create_dataset('shift', data=self.shift)
-            else:
-                del g1['shift']
-                g1.create_dataset('shift', data=self.shift)
-
-            if 'error' not in g1:
-                g1.create_dataset('error', data=self.error)
-            else:
-                del g1['error']
-                g1.create_dataset('error', data=self.error)
+                    g1.create_dataset(
+                        "residual_image", data=np.float32(self.ref_im) - data
+                    )
 
-            if 'ssim' not in g1:
-                g1.create_dataset('ssim', data=self.si)
+            if "shift" not in g1:
+                g1.create_dataset("shift", data=self.shift)
             else:
-                del g1['ssim']
-                g1.create_dataset('ssim', data=self.si)
+                del g1["shift"]
+                g1.create_dataset("shift", data=self.shift)
 
-            if 'mse' not in g1:
-                g1.create_dataset('mse', data=self.mse)
+            if "error" not in g1:
+                g1.create_dataset("error", data=self.error)
             else:
-                del g1['mse']
-                g1.create_dataset('mse', data=self.mse)
+                del g1["error"]
+                g1.create_dataset("error", data=self.error)
 
-            if 'nrmse' not in g1:
-                g1.create_dataset('nrmse', data=self.nrmse)
+            if "raw_data_info" not in f:
+                g2 = f.create_group("raw_data_info")
             else:
-                del g1['nrmse']
-                g1.create_dataset('nrmse', data=self.nrmse)
-
-            if 'raw_data_info' not in f:
-                g2 = f.create_group('raw_data_info')
-            else:
-                g2 = f['raw_data_info']
+                g2 = f["raw_data_info"]
 
             for key, val in self.raw_data_info.items():
                 if key not in g2:
                     g2.create_dataset(key, data=val)
                 else:
                     del g2[key]
                     g2.create_dataset(key, data=val)
             f.close()
         else:
             print("'dtype' can only be '2D_XANES' or '3D_XANES'. Quit!")
 
-    def _translate_single_img(self, img, shift, method):
-        if method.upper() in ['PC', 'MPC', 'MRTV', 'MPC+MRTV']:
+    @staticmethod
+    def shift_registered_3D_chunk(im_fn_tplt, cfg):
+        """
+        shift_dict: disctionary;
+                    user-defined shift list based on visual inspections of
+                    trial registration results; it is configured as
+            {'id1':    shift_id1,
+             ...
+             'idn':    shift_idn}
+                  idn: xanes3D_trial_reg_results.h5['reg_results/xxx']
+            shift_idn: used specified id in
+                       xanes3D_trial_reg_results.h5['reg_results/shiftxxx']
+        sli_s:      int
+                    starting slice id of the volume to be shifted
+        sli_e:      int
+                    ending slice id of the volume to be shifted
+        trialfn:    string; optional
+                    trial registration filename
+        savefn:     string; optional
+                    filename to the file in which the shifted volume to be saved
+        optional_shift_dict: dict; optional
+                    user input shifts for specified scan ids. This is useful to
+                    correct individual pairs that cannot be aligned with others
+                    with the same registration method
+        """
+        if cfg["sli_s"] is None:
+            cfg["sli_s"] = cfg["im_roi"][4]
+        if cfg["sli_e"] is None:
+            cfg["sli_e"] = cfg["im_roi"][5]
+
+        cfg["shift_dict"]
+        cfg["algn_pair_lst"]
+        cfg["xanes3D_scn_ids"]
+        cfg["anchor_id"]
+        cfg["chunk_sz"]
+        cfg["reg_alg"]
+        cfg["ref_mode"]
+        cfg["xanes3D_sli_srch_half_range"]
+        cfg["im_ids_dict"]
+        cfg["eng_dict"]
+        cfg["eng_dict"]
+
+        (abs_shift_dict, shift_chain_dict) = regtools.sort_absolute_shift(
+            cfg["algn_pair_lst"],
+            shft_dict=cfg["shift_dict"],
+            data_type="3D_XANES",
+            reg_alg=cfg["reg_alg"],
+        )
+
+        shift = {}
+        slioff = {}
+        for key in sorted(abs_shift_dict.keys()):
+            shift[str(key).zfill(3)] = abs_shift_dict[key]["in_sli_shift"]
+            slioff[str(key).zfill(3)] = abs_shift_dict[key]["out_sli_shift"]
+
+        for key in sorted(abs_shift_dict.keys()):
+            shift = abs_shift_dict[key]["in_sli_shift"]
+            slioff = abs_shift_dict[key]["out_sli_shift"]
+            scan_id = cfg["im_ids_dict"][key]
+
+            if cfg["reg_alg"] == "SR":
+                yshift_int = int(shift[0, 2])
+                xshift_int = int(shift[1, 2])
+                shift[0, 2] -= yshift_int
+                shift[1, 2] -= xshift_int
+            elif cfg["reg_alg"] in ["PC", "MPC", "MRTV", "MPC+MRTV"]:
+                yshift_int = int(shift[0])
+                xshift_int = int(shift[1])
+                shift[0] -= yshift_int
+                shift[1] -= xshift_int
+
+            bdi, num_batch = regtools.chunking(
+                [
+                    cfg["sli_e"] - cfg["sli_s"] + 1,
+                    cfg["im_roi"][1] - cfg["im_roi"][0],
+                    cfg["im_roi"][3] - cfg["im_roi"][2],
+                ],
+                mem_lim=cfg["mem_lim"],
+            )
+
+            for i in range(num_batch):
+                img = tiff_vol_reader(
+                    im_fn_tplt,
+                    scan_id,
+                    [
+                        cfg["sli_s"] + slioff + bdi[i * N_CPU],
+                        cfg["sli_s"] + slioff + bdi[(i + 1) * N_CPU],
+                        cfg["im_roi"][0] - yshift_int,
+                        cfg["im_roi"][1] - yshift_int,
+                        cfg["im_roi"][2] - xshift_int,
+                        cfg["im_roi"][3] - xshift_int,
+                    ],
+                )
+
+            regtools.translate_vol_img(shift, cfg["reg_alg"], cfg["sr_mode"], img)
+
+    @staticmethod
+    def chunking(dim, mem_lim=None):
+        img_sz = dim[1] * dim[2] * 4
+        mem_lim = cal_mem_lim(img_sz, mem_lim=mem_lim)
+        while (dim[0] * img_sz % mem_lim) * mem_lim / img_sz < N_CPU:
+            mem_lim += N_CPU * img_sz
+        num_img_in_batch = np.round(mem_lim / img_sz / N_CPU) * N_CPU
+        num_batch = int(np.ceil(dim[0] / num_img_in_batch))
+        bdi = []
+        chunk = int(np.round(num_img_in_batch / N_CPU))
+        for ii in range(num_batch):
+            if ii < num_batch - 1:
+                for jj in range(N_CPU):
+                    bdi.append(int(ii * num_img_in_batch + jj * chunk))
+            else:
+                chunk = int(np.ceil((dim[0] - ii * num_img_in_batch) / N_CPU))
+                for jj in range(N_CPU + 1):
+                    bdi.append(int(ii * num_img_in_batch + jj * chunk))
+                bdi[-1] = min(dim[0], bdi[-1])
+        return bdi, num_batch
+
+    @staticmethod
+    def default_3DXANES_best_shift(xns_trl_reg_fn):
+        shft_dict = {"shft_by_pair_id": {}, "algn_pair_lst": []}
+        with h5py.File(xns_trl_reg_fn, "r") as f:
+            keys = f["/trial_registration/trial_reg_results"].keys()
+            alg = (
+                f["/trial_registration/trial_reg_parameters/reg_method"][()]
+                .decode("utf-8")
+                .upper()
+            )
+            for key in sorted(keys):
+                if alg == "MRTV":
+                    best_id = f[
+                        f"/trial_registration/trial_reg_results/{key}/mrtv_best_shift_id"
+                    ][()]
+                    sli_shft = (
+                        best_id
+                        - f[
+                            "/trial_registration/trial_reg_parameters/sli_search_half_range"
+                        ]
+                    )
+                    tra_shft = f[f"/trial_registration/trial_reg_results/{key}/shift"][
+                        best_id
+                    ]
+                    rot_shft = 0
+                elif alg == "RIG-MRTV":
+                    best_id = f[
+                        f"/trial_registration/trial_reg_results/{key}/mrtv_best_shift_id"
+                    ][()]
+                    sli_shft = (
+                        best_id
+                        - f[
+                            "/trial_registration/trial_reg_parameters/sli_search_half_range"
+                        ]
+                    )
+                    tra_shft = f[
+                        f"/trial_registration/trial_reg_results/{key}/combined_shift"
+                    ][best_id]
+                    rot_shft = f[
+                        f"/trial_registration/trial_reg_results/{key}/ang_correction"
+                    ][()]
+                else:
+                    sli_shft = 0
+                    tra_shft = f[f"/trial_registration/trial_reg_results/{key}/shift"][
+                        best_id
+                    ]
+                    rot_shft = 0
+
+                shft_dict["shft_by_pair_id"][str(int(key))] = [
+                    sli_shft,
+                    *tra_shft,
+                    rot_shft,
+                ]
+            shft_dict["algn_pair_lst"] = f[
+                "/trial_registration/trial_reg_parameters/alignment_pairs"
+            ][:]
+        return shft_dict
+
+    @staticmethod
+    def default_2DXANES_best_shift(xns_trl_reg_fn):
+        shft_dict = {"shft_by_pair_id": {}, "algn_pair_lst": []}
+        with h5py.File(xns_trl_reg_fn, "r") as f:
+            keys = f["/trial_registration/trial_reg_results"].keys()
+            alg = (
+                f["/trial_registration/trial_reg_parameters/reg_method"][()]
+                .decode("utf-8")
+                .upper()
+            )
+            for key in sorted(keys):
+                shft_dict["shft_by_pair_id"][str(int(key))] = f[
+                    f"/trial_registration/trial_reg_results/{key}/shift{key}"
+                ][:]
+
+            shft_dict["algn_pair_lst"] = [
+                list(ii)
+                for ii in f["/trial_registration/trial_reg_parameters/alignment_pairs"][
+                    :
+                ]
+            ]
+        return shft_dict
+
+    @staticmethod
+    def translate_single_img(shift, method, mode, img):
+        if method.upper() in ["PC", "MPC", "MRTV", "RIG-MRTV", "MPC+MRTV"]:
             img[:] = np.real(np.fft.ifftn(fourier_shift(np.fft.fftn(img), shift)))[:]
-        elif method == 'SR':
-            if self.mode.upper() == 'TRANSLATION':
+        elif method == "SR":
+            if mode is None:
+                sr = StackReg(StackReg.TRANSLATION)
+            elif mode.upper() == "TRANSLATION":
                 sr = StackReg(StackReg.TRANSLATION)
-            elif  self.mode.upper() == 'RIGID_BODY':
+            elif mode.upper() == "RIGID_BODY":
                 sr = StackReg(StackReg.RIGID_BODY)
-            elif  self.mode.upper() == 'SCALED_ROTATION':
+            elif mode.upper() == "SCALED_ROTATION":
                 sr = StackReg(StackReg.SCALED_ROTATION)
-            elif  self.mode.upper() == 'AFFINE':
+            elif mode.upper() == "AFFINE":
                 sr = StackReg(StackReg.AFFINE)
-            elif  self.mode.upper() == 'BILINEAR':
+            elif mode.upper() == "BILINEAR":
                 sr = StackReg(StackReg.BILINEAR)
-            img[:] = sr.transform(img, tmat = shift)[:]
+            img[:] = sr.transform(img, tmat=shift)[:]
         else:
-            print('Nonrecognized method. Quit!')
-            # exit()
+            print("Nonrecognized method. Quit!")
 
-    def _translate_vol_img(self, shift, method, img):
-        for ii in range(img.shape[0]):
-            self._translate_single_img(img[ii], shift, method)
+    @staticmethod
+    @parallelizing(chunk_dim=0)
+    def translate_vol_img(shift, method, mode, data):
+        for ii in range(data.shape[0]):
+            regtools.translate_single_img(shift, method, mode, data[ii])
+
+    @staticmethod
+    def reg_tomo_pair_auto(im_pair, meth="MRTV", cfg={}, sli_num=10, cen_num=20):
+        """compare to a ref image to find center for the second tomo dataset
+
+        Args:
+            im_pair (list): im_pair[0] is a 2D ref image reconstructed from
+                            one tomo dataset with the correct rotation center;
+                            im_pair[1] is a 4D array with its 1st dim corresponding
+                            to slice, 2nd dim to different center positions, and last
+                            two dimensions the reconstructed images of different slices
+                            at different center positions
+            meth (str, optional): option for registration method. Defaults to "MRTV".
+            cfg (dict, optional): configuration for the chosen registration method. Defaults to {}.
+            sli_num (int, optional): number of slices that are compared to the reference slice (im_pair[0])
+            cen_num (int, optional): number of trial centers for each slice
+        """
+        print("start mrtv")
+        if not cfg:
+            cfg["mrtv"] = {}
+            cfg["mrtv"]["pxl_conf"] = {"type": "area", "wz": 10, "levs": 3}
+            cfg["mrtv"]["sub_conf"] = {
+                "use": True,
+                "type": "ana",
+                "sp_us": 10,
+                "sp_wz": 3,
+            }
+            cfg["mrtv"]["smth_krnl"] = 2
+        if meth.upper() == "MRTV":
+            print(
+                'We are using "multi-resolution total variation" method for registration.'
+            )
+            pxl_conf = cfg["mrtv"]["pxl_conf"]
+            sub_conf = cfg["mrtv"]["sub_conf"]
+            krnl = cfg["mrtv"]["smth_krnl"]
+            ref = im_pair[0].squeeze()
+            im2 = im_pair[1]
+
+            with mp.Pool(N_CPU) as pool:
+                rlt = pool.map(
+                    partial(mrtv_reg, cfg["mrtv"], None),
+                    [[ref, im2[jj]] for jj in range(im2.shape[0])],
+                )
+            pool.close()
+            pool.join()
+
+            shift = np.ndarray([len(rlt), 2])
+            tvl = []
+            for jj in range(len(rlt)):
+                shift[jj] = rlt[jj][3]
+                tvl.append(rlt[jj][0][pxl_conf["levs"] - 1].flatten()[rlt[jj][1][-1]])
+            id = np.array(tvl).argmin()
+            if sli_num % 2 == 0:
+                sli_oft = sli_num // 2
+            else:
+                sli_oft = sli_num // 2 + 1
+
+            if cen_num % 2 == 0:
+                cen_oft = cen_num // 2
+            else:
+                cen_oft = cen_num // 2 + 1
+
+            sli = id // cen_num - sli_oft
+            cen = (id % cen_num - cen_oft) * 0.5
+            del rlt
+            gc.collect()
+            return shift, sli, cen, id
+
+    @staticmethod
+    def set_chunks(n_pnts, anchor_loc, chnk_sz, use_chnk=True):
+        if use_chnk:
+            lst = []
+            s = anchor_loc - 1
+            left_num_chnk = 0
+            for ii in range(int(np.ceil(anchor_loc / chnk_sz))):
+                lst.append([max(s - chnk_sz + 1, 0), s])
+                s -= chnk_sz
+                left_num_chnk += 1
+
+            s = anchor_loc
+            right_num_chnk = 0
+            for ii in range((n_pnts - anchor_loc) // chnk_sz):
+                lst.append([s, s + chnk_sz - 1])
+                s += chnk_sz
+                right_num_chnk += 1
+
+            lst.append([s if s <= n_pnts - 1 else n_pnts - 1, n_pnts - 1])
+            right_num_chnk += 1
+
+            num_chnk = left_num_chnk + right_num_chnk
+            anchor_chnk = left_num_chnk
+            lst = np.array(lst)
+            lst = lst[lst[:, 0].argsort()]
+
+            chnks = {
+                ii: {"chunk_s": lst[ii, 0], "chunk_e": lst[ii, 1]}
+                for ii in range(lst.shape[0])
+            }
+            return chnks, anchor_chnk, left_num_chnk, num_chnk
+        else:
+            chnks[0] = {"chunk_s": 0, "chunk_e": n_pnts - 1}
+            return chnks, 0, 0, 1
 
-    def xanes3D_shell_slicing(self, fn):
-        pass
+    @staticmethod
+    def alignment_scheduler(
+        n_pnts, anchor_loc, chnk_sz, use_chnk=True, ref_mode="single"
+    ):
+        (chnks, anchor_chnk, left_num_chnk, num_chnk) = regtools.set_chunks(
+            n_pnts, anchor_loc, chnk_sz
+        )
+        algn_pair_lst = []
+
+        # print(f'{chnks=}\n{anchor_chnk=}\n{left_num_chnk=}\n{num_chnk=}')
+        if use_chnk:
+            if ref_mode.upper() == "SINGLE":
+                # inter-chunk alignment pair
+                for ii in range(left_num_chnk):
+                    algn_pair_lst.append(
+                        [
+                            chnks[left_num_chnk - ii]["chunk_s"],
+                            chnks[left_num_chnk - ii - 1]["chunk_s"],
+                        ]
+                    )
+                algn_pair_lst.append([anchor_chnk, anchor_chnk])
+                for ii in range(left_num_chnk, num_chnk - 1):
+                    algn_pair_lst.append(
+                        [chnks[ii]["chunk_s"], chnks[ii + 1]["chunk_s"]]
+                    )
+                # intra-chunk alignment pair
+                for ii in range(num_chnk):
+                    for jj in range(chnks[ii]["chunk_s"], chnks[ii]["chunk_e"] + 1):
+                        algn_pair_lst.append([chnks[ii]["chunk_s"], jj])
+
+                tem = []
+                for ii in algn_pair_lst:
+                    if ii[0] == ii[1]:
+                        tem.append(ii)
+                for ii in tem:
+                    algn_pair_lst.remove(ii)
+                algn_pair_lst.append([anchor_loc, anchor_loc])
+            elif ref_mode.upper() == "NEIGHBOR":
+                # inter-chunk alignment pair
+                for ii in range(left_num_chnk):
+                    algn_pair_lst.append(
+                        [
+                            chnks[left_num_chnk - ii]["chunk_s"],
+                            chnks[left_num_chnk - ii]["chunk_e"],
+                        ]
+                    )
+                    algn_pair_lst.append(
+                        [
+                            chnks[left_num_chnk - ii]["chunk_e"],
+                            chnks[left_num_chnk - ii - 1]["chunk_s"],
+                        ]
+                    )
+                algn_pair_lst.append(
+                    [chnks[anchor_chnk]["chunk_e"], chnks[anchor_chnk]["chunk_e"] + 1]
+                )
+                for ii in range(left_num_chnk + 1, num_chnk - 1):
+                    algn_pair_lst.append([chnks[ii]["chunk_e"], chnks[ii]["chunk_s"]])
+                    algn_pair_lst.append(
+                        [chnks[ii]["chunk_s"], chnks[ii + 1]["chunk_e"]]
+                    )
+                algn_pair_lst.append(
+                    [chnks[num_chnk - 1]["chunk_s"], chnks[num_chnk - 1]["chunk_e"]]
+                )
+                # inter-chunk alignment pair
+                for ii in range(num_chnk):
+                    for jj in range(chnks[ii]["chunk_s"], chnks[ii]["chunk_e"] + 1):
+                        algn_pair_lst.append([chnks[ii]["chunk_e"], jj])
+
+                tem = []
+                for ii in algn_pair_lst:
+                    if ii[0] == ii[1]:
+                        tem.append(ii)
+                for ii in tem:
+                    algn_pair_lst.remove(ii)
+                algn_pair_lst.append([anchor_loc, anchor_loc])
+        else:
+            for ii in range(n_pnts - 1):
+                algn_pair_lst.append([ii, ii + 1])
+            algn_pair_lst.append([anchor_loc, anchor_loc])
+        print(f"{algn_pair_lst=}\n")
+        return algn_pair_lst
+
+    @staticmethod
+    def sort_absolute_shift(
+        algn_pair_lst, shft_dict=None, data_type="3D_XANES", reg_alg="MRTV"
+    ):
+        shft_chn_dict = {}
+        for ii in range(len(algn_pair_lst) - 1, -1, -1):
+            shft_chn_dict[algn_pair_lst[ii][1]] = [algn_pair_lst[ii][0]]
+            jj = ii - 1
+            while jj >= 0:
+                if shft_chn_dict[algn_pair_lst[ii][1]][-1] == algn_pair_lst[jj][1]:
+                    shft_chn_dict[algn_pair_lst[ii][1]].append(algn_pair_lst[jj][0])
+                jj -= 1
+
+        abs_shft_dict = {}
+
+        if data_type == "3D_XANES":
+            if reg_alg == "SR":
+                for key, item in shft_chn_dict.items():
+                    item.insert(0, key)
+                    tra_shft = np.identity(3)
+                    sli_shft = 0
+                    ang_shft = 0.0
+                    for ii in range(len(item) - 1):
+                        idx = algn_pair_lst.index([item[ii + 1], item[ii]])
+                        tra_shft = np.matmul(tra_shft, np.array(shft_dict[str(idx)][1]))
+                        sli_shft += int(shft_dict[str(idx)][0])
+                        ang_shft += shft_dict[str(idx)][-1]
+                    abs_shft_dict[str(key).zfill(3)] = {
+                        "in_sli_shift": tra_shft,
+                        "out_sli_shift": sli_shft,
+                        "in_sli_rot": ang_shft,
+                    }
+            else:
+                for key, item in shft_chn_dict.items():
+                    item.insert(0, key)
+                    tra_shft = 0.0
+                    sli_shft = 0
+                    ang_shft = 0.0
+                    for ii in range(len(item) - 1):
+                        idx = algn_pair_lst.index([item[ii + 1], item[ii]])
+                        tra_shft += np.array(shft_dict[str(idx)][1:-1])
+                        sli_shft += int(shft_dict[str(idx)][0])
+                        ang_shft += shft_dict[str(idx)][-1]
+                    abs_shft_dict[str(key).zfill(3)] = {
+                        "in_sli_shift": tra_shft,
+                        "out_sli_shift": sli_shft,
+                        "in_sli_rot": ang_shft,
+                    }
+        if data_type == "2D_XANES":
+            if reg_alg == "SR":
+                for key, item in shft_chn_dict.items():
+                    item.insert(0, key)
+                    shft = np.identity(3)
+                    for ii in range(len(item) - 1):
+                        idx = algn_pair_lst.index([item[ii + 1], item[ii]])
+                        shft = np.matmul(shft, np.array(shft_dict[str(idx)]))
+                    abs_shft_dict[str(key).zfill(3)] = {"in_sli_shift": shft}
+            else:
+                for key, item in shft_chn_dict.items():
+                    item.insert(0, key)
+                    print(key, item)
+                    shft = 0.0
+                    for ii in range(len(item) - 1):
+                        idx = algn_pair_lst.index([item[ii + 1], item[ii]])
+                        shft += np.array(shft_dict[str(idx)])
+                    abs_shft_dict[str(key).zfill(3)] = {"in_sli_shift": shft}
+        return abs_shft_dict, shft_chn_dict
```

### Comparing `TXM_Sandbox-0.2.5/TXM_Sandbox/utils/xanes_spectra_filters.py` & `txm_sandbox-0.3.0/TXM_Sandbox/utils/xanes_spectra_filters.py`

 * *Files identical despite different names*

### Comparing `TXM_Sandbox-0.2.5/setup.py` & `txm_sandbox-0.3.0/setup.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,34 +1,33 @@
 #!/usr/bin/env python3
 # -*- coding: utf-8 -*-
 """
 Created on Thu Jul 16 22:20:14 2020
 
-@author: Xianghui Xiao
+@author: xiao
 """
 
 from setuptools import setup, find_packages
 
 setup(name='TXM_Sandbox',
-      version='0.2.5',
+      version='0.3.0',
       description='Integrated Spectro-Imaging Analysis Toolbox',
       url='https://github.com/xianghuix/TXM_Sandbox',
       author='Xianghui Xiao',
       author_email='xianghuix@gmail.com',
       license='MIT',
       packages=find_packages(),
       install_requires=[
-            'python>=3.8',
+            'python>=3.11',
             'pyimagej',
             'nodejs',
             'xarray',
             'tomopy',
             'h5py',
             'tifffile',
-            'imutils',
             'opencv',
             'openpyxl',
             'pytables',
             'pandas',
             'jupyter',
             'jupyterlab',
             'multiprocess',
@@ -37,8 +36,8 @@
             'pystackreg',
             'silx',
             'napari'
       ],
       zip_safe=False,
       include_package_data=True,
       package_data={
-          "":["LICENSE", "README.md", "TXM_Sandbox/tmp/readme.txt", "TXM_Sandbox/config/*.json", "TXM_GUI2.ipynb"]})
+          "":['LICENSE', 'README.md', 'TXM_Sandbox/tmp/readme.txt', 'TXM_Sandbox/config/*.json', 'TXM_GUI3.ipynb', 'txm_gui.py']})
```

